improve readability a bit (IMO)

- expand/convert nested functional constructs to use intermediate variables etc
- prefer classic for over forEach with "it"
- add some comments
- add TODO comments at places where explanation is missing