Surface overlay (#4642)

* remove dead code

* some new tests

* discover specific issue

* document confusion

* document some ideas

* more automated testing

* lift return as lint wants

* follow lint

* more ktlint

* stop passing not needed parameter

* remove dead code for displaying surface labels

* try more clear name

'current' could refer to current as in currently tagged (and refers to that)
'current' could refer to current as currently being selected in the interface (and does not refer to that)

this change attempts to reduce this confusion

* reviewed

* allow surface:note editing

also surface:note without surface just makes way uneditable (the same for cycleway: footway: prefixed) - only few ( https://overpass-turbo.eu/s/1nNg ), necessary cases are even more rare and supporting this would be nightmarishly complex

* redesign handling aliases and bad surface values

* surface=trail handling process

* clarify TODO

* clean imports

* fix misplaced tests

* add bunch of tests to new facet

* done or kept on external TODO list

* will be verified by testing PathSurfaceOverlay

and this gets anyway removed before PR

* verifieed support

* one more test

* clarify test purpose

* show notes not only for paved/unpaved

* clarify

* fix targeting containers

* add extra test while debugging related issues

* weak handling of surface:note on cycleway/footway separated path

* fix bug in comparing surfaces

* allow surface:note without surface where surface will be autogenerated

* for now it is mostly fine, also moved to PR questions

* moved to PR questions for now

* remove dead code

* apply ktlint changes

* got special styling and ever test for that

* seems fine as is

* get rid of universal surface overlay

* skipped for now, will get extra documentation of someone will be curious

* stop handling rare single-user surface specially

maybe in case of clear deprecation consensus it will become listed here again

* support additional surfaces

see https://github.com/streetcomplete/StreetComplete/issues/4378#issuecomment-1320917317

* explain listing

* this does not really worked and was rejected anyway

* minor line merge

* fix test style

* fix bug in listing allowed keys

* handle cases where surface was switched to segregated footway/cycleway

* do not show aliased values for selection

* avoid creation of new separate property

just use what regular surface forms are using
should play nicer with future changes

* fix test

* move transforming paved/unpaved into missing data into another part of code

handles question about discarding data

* apply missing surface transform to main surface

* add bunch of tests

* restore quest on ways where surface was detected to be invalid

* add bunch of tests, inluding failing ones

* enable editing of sidewalk tagged as property, with surface notes

* centralize bad surface definition, special handling for sidewalks with note tag

* properly handle state on different transitions

* add segregated=yes if missing

happens in case of being tagged as single surface or not having surface and without segregated tag

* more clear note

* protect against partial edits

* allow to easily see jumbonotes

* always hide main surface selection button

* describe design considerations for surface colours

* dejavify style

* mention segregated=yes in tests

* document that sidewalk tagged paths are intentionally excluded

* fix typo

* actually exclude paths with sidewalks

* aligning when query

* extract SurfaceUtils.kt

* ktlint

* move item code to item

* privatise some functions

* TODO done

* merge clauses

Co-authored-by: Tobias Zwick <newton@westnordost.de>

* fix typo

* make GRAY and DARK_GRAY generally defined

* do not use weird constructs

* avoid duplication

* move around file contents as requested

* ktlint formatting

* extract from Answer file as instructed

https://github.com/streetcomplete/StreetComplete/pull/4642/files/d0ddc67d6b7ec76e70e28116249b9c43c65732e3#r1031516100

* add two additional tests for so far untested things

* use assertEquals correctly

* move tests to SurfaceAnswerKtTest, remove duplicate tests

* correct wording

* make all elements of layout visible in IDE

* typo

* use plural

* format

* reduce duplications in layout code

* remove duplicate code (introduced through merge?)

* move val to correct file

* move tests into correct file

* fix SidewalkSurfaceOverlayForm:

- hasChanges didn't work correctly because SidewalkSurface was compared to a completely disjunct data type (Sidewalk)
- untangle the sidewalk SurfaceAnswer mess
- reuse the surface tagging logic

* better function name

* consistency: the cell icon for photos should generally be text on photo (not below)

* fix typo, add an explanation

* provide more documentation for design decisions

* rearrange colours, drop dark gray

* just some reformatting

* use sidewalk surface parser

* format code

* fix sidewalk:both=yes was not recognized as sidewalk

* parsing sidewalk surface performance improvement

* drop dead code mentioning playgrounds

* fix sidewalk display on private roads

* remove exlusion of ways with unknown surface-referring tags

ideally StreetComple would handle all surface-referring tags, but this is a quite ctime-consuming and quixotic
iD is anyway not doing this
popular tags are actually handled
Tobias wnated this filter to be removed, see https://github.com/streetcomplete/StreetComplete/pull/4642#discussion_r1057231242

* remove missing no longer needed funtion

* split styling into two more separate parts

as suggested in https://github.com/streetcomplete/StreetComplete/pull/4642#discussion_r1057245664

* work toward less ugly image display

* more proper styling for road surface picker

* fix invisible/gone that is obvious in retrospect

* reuse iD interface translations

* fix segregated=yes not being applied in some cases

now it will be listed as added also when it was present already - survivable, I guess

* drop not needed request for three lines

* record OK button size in one place

* note fields should not conflict and be blocked by other elements

* more equal screen sharing

* simplify code

* document consequences of spamming segregated=yes

* remove trace of supporting surface on playgrounds

* run ktlint

* use common function to parse surface sides

* better separate quest data structures from general osm data structures

* change signature of getFeatureName so that parameters do not need to be shoehorned

* fix commment location

* get rid of one class

removes not really needed (I think) caching and simplify code

* add chipseal as a synonym of surface=asphalt

* show unindentified values

* remove not needed text

* alias surface=metal_grid to surface=metal

in an ideal world it would surface=metal metal=grid_with_empty_spaces or something similar, but...

* add tests as planned

* allow both UNPAVED_ROAD and UNPAVED_AREA as a return value

* check is surface=cement treated as invalid

* reask surface=cement paths

* fix test about weird surface values

* support again invalid surfaces in surface overlay

surface=cement / surface=cobblestone

were shown as potentially valid 'other kind of surface'

* fix remaining tests documenting that unlisted values are unsupported

* note open questions

* fix remaining TODO

* remove magic fake value in Surface entry

* fix colour selection

* fix English

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* code refactoring from review by FloEdelmann

I am neutral on them and like both versions equally or have slight preference to previous, FloEdelmann likes this more so lets go with this

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* fix English

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* Unnest ifs

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* fix simulator link

* remove behavior mismatching by cycleway/footway quests

I actually disagree with footway/cycleway quests asking for specific surface when say surface=paving_stones is presented
but lets keep it working in the same way (this would make impossible to explicitly specify footway/cycleway surface)

* hide also other matching quests

* remove no longer true comment

* remove duplication from SOFT_SURFACES

* follow noteText changes

* test drudgery - follow refactorings

* apply ktlint

* more ktlint

* apply refactoring by FloEdelmann

personally I have no preference either way

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* add tests for surface parsing including a failing one

* follow noteText changes in path surface overlay form

* use shorter names, move fields/methods, shorter code, remove unnecessary sealed class

* move ParsedSurface color mapping into extension function

(getColor is no intrinsic property of ParsedSurface but belongs to the overlays)

* no need to check for null here

* reuse layout, make layout appear centered and in proper width

* fix identation

* remove dead code

* use more standard bracketing style

still dislike it

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* remove more dead code

* properly check is missing data worth marking

* be more strict in what is considered as valid surface tag

* support display of weird surfaces in sidewalk display

* remove no longer needed filter part

* remove part of hackish WithFakeNullPossibility

* try to stuff UnknownSurface into Surface enum

this comes at cost of two new !! null exception generators

also not happy about this

* Revert "try to stuff UnknownSurface into Surface enum"

This reverts commit 0917df07229636c05510a9ae695ce77103c66e46.

* another rewrite attempt

now sidewalk overlay form is basing itself on ParsedSurface

and we have asSurfaceStreetSideItem in turn
and different overlays with another class as a base type

* remove unused function

* Revert "another rewrite attempt"

This reverts commit 82d71b012735851c007b4751399507acbb19e522.

* Revert "Revert "try to stuff UnknownSurface into Surface enum""

This reverts commit 2347eb939194e0ef4793824fcdf5c4595aef71b7.

* switch !! to an IllegalArgumentException

* lint

* more resistant test

* fix typo

* fix typo in a constant name

* ktlint

* try to better distinguish between this two classes

one has Surface, one has Surface? member

* find better names for some classes

* add persistent mud as surface value

* clarify extra values

* remove apparently invalid comments

see https://osmus.slack.com/archives/C01BU04GW7L/p1677008862953609

* clarify

* support chipseal in one more place

* support soil in one more place

* be fully accurate

* try just to enlarge invisible

* replace transparent SVG drawable by PNG one

SVG was having some weird scaling behaviour, hopefully PNG will behave like all other png ones

* surface=ground is generic but not underspicified

* add test to detect just fixed regression

* this test outcome change is intended

* use actually transparent images

* Revert "use actually transparent images"

This reverts commit b0c4670434855475a3e44b3b07c0f4816846be68.

* Revert "replace transparent SVG drawable by PNG one"

This reverts commit c25bacb0114746d7346b416af8808018d0bdd05d.

* remove empty path and other silliness

* checking one more aspect of editing

* document how cobblestone is handled

* fix typo

* fix typos

* UNKNOWN_SURFACE is also enum value

so should be handled by surfaceTextValueToSurfaceEnum
added tests

* put INVALID_SURFACES check deeper

* add changelog. Feel free to mention anything else relevant for the average user to mention (keep it short)

* Fix HTML

* move applyTo into Surface itself

* do not try to pack collected data into dedicated class

that just left me confused and bouncing between dubious architectures

* class renames/use changes as requested

* easy to remove remaining one

* restore original names before I started meddling with them

* remove not needed remains of a hackish solution

* eliminate traces of Answer from overlays

* fix regressions caught by tests

* review changes

* view controller

* Fixes

* remove not needed conversion

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* him -> them

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* Apply suggestions from code review

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* Update app/src/main/java/de/westnordost/streetcomplete/overlays/surface/RoadSurfaceOverlay.kt

Co-authored-by: Flo Edelmann <git@flo-edelmann.de>

* remove capability to specify sidewalk surfaces - unify the two overlays into one, remove all those tests that test functionality that is irrelevant now

* fix Discard input is being asked also when no changes were made

* fix surface note did not show for surfaces that do not NEED a note

* update changelog

* remove unused string

---------

Co-authored-by: Tobias Zwick <newton@westnordost.de>
Co-authored-by: Flo Edelmann <git@flo-edelmann.de>
Co-authored-by: Tobias Zwick <osm@westnordost.de>