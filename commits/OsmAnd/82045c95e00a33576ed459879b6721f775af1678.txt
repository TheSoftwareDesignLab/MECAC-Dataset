Fix several bugs and improve ui