diff --git a/budget/lib/database/tables.dart b/budget/lib/database/tables.dart
index fd2f495fc..a03008106 100644
--- a/budget/lib/database/tables.dart
+++ b/budget/lib/database/tables.dart
@@ -521,12 +521,27 @@ class CategoryWithTotal {
   final CategoryBudgetLimit? categoryBudgetLimit;
   final double total;
   final int transactionCount;
+
   CategoryWithTotal({
     required this.category,
     required this.total,
     this.transactionCount = 0,
     this.categoryBudgetLimit,
   });
+
+  CategoryWithTotal copyWith({
+    TransactionCategory? category,
+    CategoryBudgetLimit? categoryBudgetLimit,
+    double? total,
+    int? transactionCount,
+  }) {
+    return CategoryWithTotal(
+      category: category ?? this.category,
+      categoryBudgetLimit: categoryBudgetLimit ?? this.categoryBudgetLimit,
+      total: total ?? this.total,
+      transactionCount: transactionCount ?? this.transactionCount,
+    );
+  }
 }
 
 // bool canAddToBudget(bool? income, TransactionSpecialType? transactionType) {
@@ -1012,8 +1027,9 @@ class FinanceDatabase extends _$FinanceDatabase {
                     budgetTransactionFilters: budgetTransactionFilters,
                     memberTransactionFilters: memberTransactionFilters) &
                 isOnDay(dateCreated, date) &
-                onlyShowBasedOnCategoryFks(
-                    tbl, categoryFks, categoryFksExclude) &
+                (onlyShowBasedOnCategoryFks(
+                        tbl, categoryFks, categoryFksExclude) |
+                    onlyShowBasedOnSubcategoryFks(transactions, categoryFks)) &
                 onlyShowBasedOnWalletFks(tbl, walletFks) &
                 onlyShowBasedOnIncome(tbl, income) &
                 onlyShowIfMember(tbl, member) &
@@ -1106,8 +1122,9 @@ class FinanceDatabase extends _$FinanceDatabase {
                 budgetTransactionFilters: budgetTransactionFilters,
                 memberTransactionFilters: memberTransactionFilters) &
             onlyShowBasedOnTimeRange(transactions, startDate, endDate, budget) &
-            onlyShowBasedOnCategoryFks(
-                transactions, categoryFks, categoryFksExclude) &
+            (onlyShowBasedOnCategoryFks(
+                    transactions, categoryFks, categoryFksExclude) |
+                onlyShowBasedOnSubcategoryFks(transactions, categoryFks)) &
             onlyShowBasedOnWalletFks(transactions, walletFks) &
             onlyShowBasedOnIncome(transactions, income) &
             onlyShowIfMember(transactions, member) &
@@ -4569,7 +4586,7 @@ class FinanceDatabase extends _$FinanceDatabase {
     String? mainCategoryPkIfSubCategories,
     bool includeAllSubCategories = false,
     // if a transaction does not have a subcategory assigned, does it show up in the total?
-    bool countUnassignedTransactons = false,
+    bool countUnassignedTransactions = false,
   }) {
     DateTime startDate = DateTime(start.year, start.month, start.day);
     DateTime endDate = DateTime(end.year, end.month, end.day);
@@ -4611,7 +4628,7 @@ class FinanceDatabase extends _$FinanceDatabase {
                 ? ((categories.categoryPk
                             .equalsExp(transactions.subCategoryFk) &
                         transactions.subCategoryFk.isNotNull()) |
-                    (countUnassignedTransactons == true
+                    (countUnassignedTransactions == true
                         ? categories.categoryPk
                             .equalsExp(transactions.categoryFk)
                         : (categories.categoryPk
diff --git a/budget/lib/pages/budgetPage.dart b/budget/lib/pages/budgetPage.dart
index 14c714fc5..41aee0488 100644
--- a/budget/lib/pages/budgetPage.dart
+++ b/budget/lib/pages/budgetPage.dart
@@ -106,215 +106,15 @@ class _BudgetPageContentState extends State<_BudgetPageContent> {
     super.initState();
   }
 
-  Widget subCategorySpendingSummary({
-    required bool showIncomeExpenseIcons,
-    required DateTimeRange budgetRange,
-    required double todayPercent,
-    required ColorScheme budgetColorScheme,
-    required String mainCategoryPkIfSubCategories,
-    required int? index,
-    required bool allSelected,
-    required bool selected,
-    bool onlyShowMainCategory = false,
-    bool hideIfNoSubcategoryEntries = false,
-  }) {
-    return StreamBuilder<List<CategoryWithTotal>>(
-      stream: database.watchTotalSpentInEachCategoryInTimeRangeFromCategories(
-        allWallets: Provider.of<AllWallets>(context),
-        start: budgetRange.start,
-        end: budgetRange.end,
-        categoryFks: widget.budget.categoryFks,
-        categoryFksExclude: widget.budget.categoryFksExclude,
-        budgetTransactionFilters: widget.budget.budgetTransactionFilters,
-        memberTransactionFilters: widget.budget.memberTransactionFilters,
-        member: selectedMember,
-        onlyShowTransactionsBelongingToBudgetPk:
-            widget.budget.sharedKey != null ||
-                    widget.budget.addedTransactionsOnly == true
-                ? widget.budget.budgetPk
-                : null,
-        budget: widget.budget,
-        mainCategoryPkIfSubCategories: mainCategoryPkIfSubCategories,
-        countUnassignedTransactons: true,
-        includeAllSubCategories: showAllSubcategories,
-      ),
-      builder: (context, snapshot) {
-        if (snapshot.hasData) {
-          double totalSpent = 0;
-          double totalSpentAbsolute = 0;
-          CategoryWithTotal? mainCategory;
-          snapshot.data!.forEach((CategoryWithTotal category) {
-            totalSpent = totalSpent + category.total;
-            totalSpentAbsolute = totalSpentAbsolute + category.total.abs();
-            if (category.category.categoryPk == mainCategoryPkIfSubCategories)
-              mainCategory = category;
-          });
-          totalSpent = totalSpent * -1;
-
-          bool showMainCategoryOnly = ((snapshot.data ?? []).length <= 1 &&
-                  hideIfNoSubcategoryEntries == false) ||
-              onlyShowMainCategory;
-
-          Widget mainCategoryEntry = mainCategory == null
-              ? SizedBox.shrink()
-              : CategoryEntry(
-                  highlightIfSelected: onlyShowMainCategory,
-                  todayPercent: todayPercent,
-                  overSpentColor: showIncomeExpenseIcons
-                      ? mainCategory!.total > 0
-                          ? getColor(context, "incomeAmount")
-                          : getColor(context, "expenseAmount")
-                      : null,
-                  showIncomeExpenseIcons: showIncomeExpenseIcons,
-                  onLongPress: () {
-                    enterCategoryLimitPopup(
-                      context,
-                      mainCategory!.category,
-                      mainCategory!.categoryBudgetLimit,
-                      widget.budget.budgetPk,
-                      (p0) => null,
-                      widget.budget.isAbsoluteSpendingLimit,
-                    );
-                  },
-                  isAbsoluteSpendingLimit:
-                      widget.budget.isAbsoluteSpendingLimit,
-                  budgetLimit: widget.budget.amount,
-                  categoryBudgetLimit: mainCategory!.categoryBudgetLimit,
-                  budgetColorScheme: budgetColorScheme,
-                  category: mainCategory!.category,
-                  totalSpent: totalSpentAbsolute,
-                  transactionCount: mainCategory!.transactionCount,
-                  categorySpent: showIncomeExpenseIcons == true
-                      ? mainCategory!.total
-                      : mainCategory!.total.abs(),
-                  onTap: () {
-                    if (selectedCategory?.categoryPk ==
-                            mainCategory!.category.categoryPk ||
-                        index == null) {
-                      setState(() {
-                        selectedCategory = null;
-                      });
-                      _pieChartDisplayStateKey.currentState!
-                          .setTouchedIndex(-1);
-                    } else {
-                      setState(() {
-                        selectedCategory = mainCategory!.category;
-                      });
-                      _pieChartDisplayStateKey.currentState!
-                          .setTouchedIndex(index);
-                    }
-                  },
-                  selected: selected,
-                  allSelected: allSelected,
-                );
-
-          // If only the main category is here - no subcategories
-          if ((snapshot.data ?? []).length <= 1 &&
-              hideIfNoSubcategoryEntries == true) return SizedBox.shrink();
-
-          VoidCallback onTap = () {
-            if (selectedCategory?.categoryPk ==
-                    mainCategory!.category.categoryPk ||
-                index == null) {
-              setState(() {
-                selectedCategory = null;
-              });
-              _pieChartDisplayStateKey.currentState!.setTouchedIndex(-1);
-            } else {
-              setState(() {
-                selectedCategory = mainCategory!.category;
-              });
-              _pieChartDisplayStateKey.currentState!.setTouchedIndex(index);
-            }
-          };
-
-          return AnimatedSizeSwitcher(
-            child: showMainCategoryOnly
-                ? mainCategoryEntry
-                : AnimatedExpanded(
-                    key: ValueKey(1),
-                    expand: selected == true || allSelected,
-                    child: SubCategoriesContainer(
-                      onTap: onTap,
-                      key: ValueKey(mainCategoryPkIfSubCategories),
-                      mainCategory: mainCategoryEntry,
-                      colorScheme: budgetColorScheme,
-                      subCategoryEntries: Padding(
-                        padding: const EdgeInsets.only(top: 5),
-                        child: Column(
-                          children: [
-                            for (CategoryWithTotal category in snapshot.data!)
-                              category.category.categoryPk ==
-                                      mainCategoryPkIfSubCategories
-                                  ? SizedBox.shrink()
-                                  : CategoryEntry(
-                                      onTap: onTap,
-                                      highlightIfSelected: onlyShowMainCategory,
-                                      todayPercent: todayPercent,
-                                      overSpentColor: showIncomeExpenseIcons
-                                          ? category.total > 0
-                                              ? getColor(
-                                                  context, "incomeAmount")
-                                              : getColor(
-                                                  context, "expenseAmount")
-                                          : null,
-                                      showIncomeExpenseIcons:
-                                          showIncomeExpenseIcons,
-                                      onLongPress: () {
-                                        enterCategoryLimitPopup(
-                                          context,
-                                          category.category,
-                                          category.categoryBudgetLimit,
-                                          widget.budget.budgetPk,
-                                          (p0) => null,
-                                          widget.budget.isAbsoluteSpendingLimit,
-                                        );
-                                      },
-                                      isAbsoluteSpendingLimit:
-                                          widget.budget.isAbsoluteSpendingLimit,
-                                      budgetLimit:
-                                          widget.budget.isAbsoluteSpendingLimit
-                                              ? (mainCategory
-                                                      ?.categoryBudgetLimit
-                                                      ?.amount ??
-                                                  1)
-                                              : (mainCategory
-                                                          ?.categoryBudgetLimit
-                                                          ?.amount ??
-                                                      1) /
-                                                  100 *
-                                                  widget.budget.amount,
-                                      categoryBudgetLimit:
-                                          category.categoryBudgetLimit,
-                                      budgetColorScheme: budgetColorScheme,
-                                      category: category.category,
-                                      totalSpent: totalSpentAbsolute,
-                                      transactionCount:
-                                          category.transactionCount,
-                                      categorySpent:
-                                          showIncomeExpenseIcons == true
-                                              ? category.total
-                                              : category.total.abs(),
-                                      selected: selected,
-                                      allSelected: allSelected,
-                                    ),
-                          ],
-                        ),
-                      ),
-                    ),
-                  ),
-          );
-        } else {
-          return SizedBox.shrink();
-        }
-      },
-    );
-  }
-
   void toggleAllSubcategories() {
     setState(() {
       showAllSubcategories = !showAllSubcategories;
     });
+    Future.delayed(Duration(milliseconds: 10), () {
+      _pieChartDisplayStateKey.currentState!
+          .setTouchedCategoryPk(selectedCategory?.categoryPk);
+    });
+
     updateSettings("showAllSubcategories", showAllSubcategories,
         updateGlobalState: false);
   }
@@ -325,177 +125,132 @@ class _BudgetPageContentState extends State<_BudgetPageContent> {
     required DateTimeRange budgetRange,
     required bool showAllSubcategories,
     required VoidCallback toggleAllSubCategories,
-    required List<CategoryWithTotal> dataPassed,
+    required List<CategoryWithTotal> data,
+    required List<CategoryWithTotal> dataWithoutSubcategories,
+    required bool hasSubCategories,
   }) {
-    return StreamBuilder<List<CategoryWithTotal>>(
-      stream: database.watchTotalSpentInEachCategoryInTimeRangeFromCategories(
-        allWallets: Provider.of<AllWallets>(context),
-        start: budgetRange.start,
-        end: budgetRange.end,
-        categoryFks: widget.budget.categoryFks,
-        categoryFksExclude: widget.budget.categoryFksExclude,
-        budgetTransactionFilters: widget.budget.budgetTransactionFilters,
-        memberTransactionFilters: widget.budget.memberTransactionFilters,
-        member: selectedMember,
-        onlyShowTransactionsBelongingToBudgetPk:
-            widget.budget.sharedKey != null ||
-                    widget.budget.addedTransactionsOnly == true
-                ? widget.budget.budgetPk
+    return Column(
+      children: [
+        Container(
+          decoration: BoxDecoration(
+              boxShadow: boxShadowCheck(
+                boxShadowGeneral(context),
+              ),
+              borderRadius: BorderRadius.circular(200)),
+          child: PieChartWrapper(
+            pieChartDisplayStateKey: _pieChartDisplayStateKey,
+            data: showAllSubcategories ? data : dataWithoutSubcategories,
+            totalSpent: totalSpentAbsolute,
+            setSelectedCategory: (categoryPk, category) async {
+              if (category?.mainCategoryPk != null) {
+                TransactionCategory mainCategory = await database
+                    .getCategoryInstance(category!.mainCategoryPk!);
+                setState(() {
+                  selectedCategory = mainCategory;
+                });
+              } else {
+                setState(() {
+                  selectedCategory = category;
+                });
+              }
+            },
+            isPastBudget: widget.isPastBudget ?? false,
+            middleColor: appStateSettings["materialYou"]
+                ? dynamicPastel(context, budgetColorScheme.primary,
+                    amount: 0.92)
                 : null,
-        budget: widget.budget,
-        // Set to countUnassignedTransactons: false for the pie chart
-        //  includeAllSubCategories: showAllSubcategories,
-        // If implementing pie chart summary for subcategories, also need to implement ability to tap a subcategory from the pie chart
-        countUnassignedTransactons: false,
-        includeAllSubCategories: true,
-      ),
-      builder: (context, snapshot) {
-        if (snapshot.hasData) {
-          bool hasSubCategories = false;
-          double totalSpent = 0;
-          double totalSpentAbsolute = 0;
-          snapshot.data!.forEach((category) {
-            totalSpent = totalSpent + category.total;
-            totalSpentAbsolute = totalSpentAbsolute + category.total.abs();
-            if (category.category.mainCategoryPk != null &&
-                hasSubCategories == false) hasSubCategories = true;
-          });
-          totalSpent = totalSpent * -1;
-
-          // Take outside data
-          // the difference is includeAllSubCategories: false when the data is passed
-          // We can use this data when showAllSubcategories is false
-          List<CategoryWithTotal> data = dataPassed;
-          if (showAllSubcategories) data = snapshot.data ?? [];
-
-          return Column(
-            children: [
-              Container(
-                decoration: BoxDecoration(
-                    boxShadow: boxShadowCheck(
-                      boxShadowGeneral(context),
+          ),
+        ),
+        Transform.translate(
+          offset: Offset(-9 - getHorizontalPaddingConstrained(context), 5),
+          child: Align(
+            alignment: Alignment.bottomRight,
+            child: Builder(builder: (context) {
+              bool showClearButton = selectedCategory != null;
+              return Row(
+                mainAxisAlignment: MainAxisAlignment.spaceBetween,
+                mainAxisSize: MainAxisSize.max,
+                children: [
+                  Transform.translate(
+                    offset: Offset(11, 0),
+                    child: AnimatedExpanded(
+                      expand: showClearButton,
+                      child: Tooltip(
+                        message: "clear-selection".tr(),
+                        child: IconButton(
+                          padding: EdgeInsets.all(15),
+                          onPressed: () {
+                            setState(() {
+                              selectedCategory = null;
+                            });
+                            _pieChartDisplayStateKey.currentState!
+                                .setTouchedIndex(-1);
+                          },
+                          icon: Icon(
+                            appStateSettings["outlinedIcons"]
+                                ? Icons.clear_outlined
+                                : Icons.clear_rounded,
+                            color: budgetColorScheme.secondary,
+                          ),
+                        ),
+                      ),
                     ),
-                    borderRadius: BorderRadius.circular(200)),
-                child: PieChartWrapper(
-                  pieChartDisplayStateKey: _pieChartDisplayStateKey,
-                  data: data,
-                  totalSpent: totalSpentAbsolute,
-                  setSelectedCategory: (categoryPk, category) async {
-                    if (category?.mainCategoryPk != null) {
-                      TransactionCategory mainCategory = await database
-                          .getCategoryInstance(category!.mainCategoryPk!);
-                      setState(() {
-                        selectedCategory = mainCategory;
-                      });
-                    } else {
-                      setState(() {
-                        selectedCategory = category;
-                      });
-                    }
-                  },
-                  isPastBudget: widget.isPastBudget ?? false,
-                  middleColor: appStateSettings["materialYou"]
-                      ? dynamicPastel(context, budgetColorScheme.primary,
-                          amount: 0.92)
-                      : null,
-                ),
-              ),
-              Transform.translate(
-                offset:
-                    Offset(-9 - getHorizontalPaddingConstrained(context), 10),
-                child: Align(
-                  alignment: Alignment.bottomRight,
-                  child: Builder(builder: (context) {
-                    bool showClearButton = selectedCategory != null;
-                    return Row(
-                      mainAxisAlignment: MainAxisAlignment.end,
-                      mainAxisSize: MainAxisSize.max,
-                      children: [
-                        Row(
-                          children: [
-                            if (hasSubCategories)
-                              Transform.translate(
-                                key: ValueKey(showClearButton),
-                                offset: Offset(10, 0),
-                                child: Tooltip(
-                                  message: "view-subcategories".tr(),
-                                  child: IconButton(
-                                    padding: EdgeInsets.all(15),
-                                    onPressed: toggleAllSubCategories,
-                                    icon: ScaledAnimatedSwitcher(
-                                      keyToWatch:
-                                          showAllSubcategories.toString(),
-                                      child: Icon(
-                                        showAllSubcategories
-                                            ? (appStateSettings["outlinedIcons"]
-                                                ? Icons.unfold_less_outlined
-                                                : Icons.unfold_less_rounded)
-                                            : (appStateSettings["outlinedIcons"]
-                                                ? Icons.unfold_more_outlined
-                                                : Icons.unfold_more_rounded),
-                                        color: budgetColorScheme.secondary,
-                                      ),
-                                    ),
-                                  ),
-                                ),
-                              ),
-                            Tooltip(
-                              message: "edit-spending-goals".tr(),
-                              child: IconButton(
-                                padding: EdgeInsets.all(15),
-                                onPressed: () {
-                                  pushRoute(
-                                    context,
-                                    EditBudgetLimitsPage(
-                                      budget: widget.budget,
-                                    ),
-                                  );
-                                },
-                                icon: Icon(
-                                  appStateSettings["outlinedIcons"]
-                                      ? Icons.fact_check_outlined
-                                      : Icons.fact_check_rounded,
+                  ),
+                  Row(
+                    children: [
+                      if (hasSubCategories)
+                        Transform.translate(
+                          key: ValueKey(showClearButton),
+                          offset: Offset(10, 0),
+                          child: Tooltip(
+                            message: "view-subcategories".tr(),
+                            child: IconButton(
+                              padding: EdgeInsets.all(15),
+                              onPressed: toggleAllSubCategories,
+                              icon: ScaledAnimatedSwitcher(
+                                keyToWatch: showAllSubcategories.toString(),
+                                child: Icon(
+                                  showAllSubcategories
+                                      ? (appStateSettings["outlinedIcons"]
+                                          ? Icons.unfold_less_outlined
+                                          : Icons.unfold_less_rounded)
+                                      : (appStateSettings["outlinedIcons"]
+                                          ? Icons.unfold_more_outlined
+                                          : Icons.unfold_more_rounded),
                                   color: budgetColorScheme.secondary,
                                 ),
                               ),
                             ),
-                          ],
+                          ),
                         ),
-                        AnimatedSizeSwitcher(
-                          child: showClearButton == false
-                              ? Container(
-                                  key: ValueKey(1),
-                                )
-                              : Tooltip(
-                                  message: "clear-selection".tr(),
-                                  child: IconButton(
-                                    padding: EdgeInsets.all(15),
-                                    onPressed: () {
-                                      setState(() {
-                                        selectedCategory = null;
-                                      });
-                                      _pieChartDisplayStateKey.currentState!
-                                          .setTouchedIndex(-1);
-                                    },
-                                    icon: Icon(
-                                      appStateSettings["outlinedIcons"]
-                                          ? Icons.clear_outlined
-                                          : Icons.clear_rounded,
-                                      color: budgetColorScheme.secondary,
-                                    ),
-                                  ),
-                                ),
+                      Tooltip(
+                        message: "edit-spending-goals".tr(),
+                        child: IconButton(
+                          padding: EdgeInsets.all(15),
+                          onPressed: () {
+                            pushRoute(
+                              context,
+                              EditBudgetLimitsPage(
+                                budget: widget.budget,
+                              ),
+                            );
+                          },
+                          icon: Icon(
+                            appStateSettings["outlinedIcons"]
+                                ? Icons.fact_check_outlined
+                                : Icons.fact_check_rounded,
+                            color: budgetColorScheme.secondary,
+                          ),
                         ),
-                      ],
-                    );
-                  }),
-                ),
-              ),
-            ],
-          );
-        }
-        return SizedBox.shrink();
-      },
+                      ),
+                    ],
+                  ),
+                ],
+              );
+            }),
+          ),
+        ),
+      ],
     );
   }
 
@@ -542,53 +297,44 @@ class _BudgetPageContentState extends State<_BudgetPageContent> {
         children: [
           PageFramework(
             belowAppBarPaddingWhenCenteredTitleSmall: 0,
-            subtitle: StreamBuilder<double?>(
-              stream: database.watchTotalSpentByCurrentUserOnly(
-                  Provider.of<AllWallets>(context),
-                  budgetRange.start,
-                  budgetRange.end,
-                  widget.budget.budgetPk),
-              builder: (context, snapshotTotalSpentByCurrentUserOnly) {
-                return StreamBuilder<List<CategoryWithTotal>>(
-                  stream: database
-                      .watchTotalSpentInEachCategoryInTimeRangeFromCategories(
-                    allWallets: Provider.of<AllWallets>(context),
-                    start: budgetRange.start,
-                    end: budgetRange.end,
-                    categoryFks: widget.budget.categoryFks,
-                    categoryFksExclude: widget.budget.categoryFksExclude,
-                    budgetTransactionFilters:
-                        widget.budget.budgetTransactionFilters,
-                    memberTransactionFilters:
-                        widget.budget.memberTransactionFilters,
-                    member: selectedMember,
-                    onlyShowTransactionsBelongingToBudgetPk:
-                        widget.budget.sharedKey != null ||
-                                widget.budget.addedTransactionsOnly == true
-                            ? widget.budget.budgetPk
-                            : null,
-                    budget: widget.budget,
-                  ),
-                  builder: (context, snapshot) {
-                    double totalSpent = 0;
-                    if (snapshot.hasData) {
-                      snapshot.data!.forEach((category) {
-                        totalSpent = totalSpent + category.total;
-                      });
-                      totalSpent = totalSpent * -1;
-                    }
+            subtitle: StreamBuilder<List<CategoryWithTotal>>(
+              stream: database
+                  .watchTotalSpentInEachCategoryInTimeRangeFromCategories(
+                allWallets: Provider.of<AllWallets>(context),
+                start: budgetRange.start,
+                end: budgetRange.end,
+                categoryFks: widget.budget.categoryFks,
+                categoryFksExclude: widget.budget.categoryFksExclude,
+                budgetTransactionFilters:
+                    widget.budget.budgetTransactionFilters,
+                memberTransactionFilters:
+                    widget.budget.memberTransactionFilters,
+                member: selectedMember,
+                onlyShowTransactionsBelongingToBudgetPk:
+                    widget.budget.sharedKey != null ||
+                            widget.budget.addedTransactionsOnly == true
+                        ? widget.budget.budgetPk
+                        : null,
+                budget: widget.budget,
+              ),
+              builder: (context, snapshot) {
+                double totalSpent = 0;
+                if (snapshot.hasData) {
+                  snapshot.data!.forEach((category) {
+                    totalSpent = totalSpent + category.total;
+                  });
+                  totalSpent = totalSpent * -1;
+                }
 
-                    if (snapshot.hasData) {
-                      return TotalSpent(
-                        budget: widget.budget,
-                        budgetColorScheme: budgetColorScheme,
-                        totalSpent: totalSpent,
-                      );
-                    } else {
-                      return SizedBox.shrink();
-                    }
-                  },
-                );
+                if (snapshot.hasData) {
+                  return TotalSpent(
+                    budget: widget.budget,
+                    budgetColorScheme: budgetColorScheme,
+                    totalSpent: totalSpent,
+                  );
+                } else {
+                  return SizedBox.shrink();
+                }
               },
             ),
             subtitleAlignment: Alignment.bottomLeft,
@@ -675,270 +421,285 @@ class _BudgetPageContentState extends State<_BudgetPageContent> {
             textColor: getColor(context, "black"),
             dragDownToDismiss: true,
             slivers: [
-              StreamBuilder<double?>(
-                stream: database.watchTotalSpentByCurrentUserOnly(
-                  Provider.of<AllWallets>(context),
-                  budgetRange.start,
-                  budgetRange.end,
-                  widget.budget.budgetPk,
+              StreamBuilder<List<CategoryWithTotal>>(
+                stream: database
+                    .watchTotalSpentInEachCategoryInTimeRangeFromCategories(
+                  allWallets: Provider.of<AllWallets>(context),
+                  start: budgetRange.start,
+                  end: budgetRange.end,
+                  categoryFks: widget.budget.categoryFks,
+                  categoryFksExclude: widget.budget.categoryFksExclude,
+                  budgetTransactionFilters:
+                      widget.budget.budgetTransactionFilters,
+                  memberTransactionFilters:
+                      widget.budget.memberTransactionFilters,
+                  member: selectedMember,
+                  onlyShowTransactionsBelongingToBudgetPk:
+                      widget.budget.sharedKey != null ||
+                              widget.budget.addedTransactionsOnly == true
+                          ? widget.budget.budgetPk
+                          : null,
+                  budget: widget.budget,
+                  // Set to countUnassignedTransactons: false for the pie chart
+                  //  includeAllSubCategories: showAllSubcategories,
+                  // If implementing pie chart summary for subcategories, also need to implement ability to tap a subcategory from the pie chart
+                  countUnassignedTransactions: false,
+                  includeAllSubCategories: true,
                 ),
-                builder: (context, snapshotTotalSpentByCurrentUserOnly) {
-                  return StreamBuilder<List<CategoryWithTotal>>(
-                    stream: database
-                        .watchTotalSpentInEachCategoryInTimeRangeFromCategories(
-                      allWallets: Provider.of<AllWallets>(context),
-                      start: budgetRange.start,
-                      end: budgetRange.end,
-                      categoryFks: widget.budget.categoryFks,
-                      categoryFksExclude: widget.budget.categoryFksExclude,
-                      budgetTransactionFilters:
-                          widget.budget.budgetTransactionFilters,
-                      memberTransactionFilters:
-                          widget.budget.memberTransactionFilters,
-                      member: selectedMember,
-                      onlyShowTransactionsBelongingToBudgetPk:
-                          widget.budget.sharedKey != null ||
-                                  widget.budget.addedTransactionsOnly == true
-                              ? widget.budget.budgetPk
-                              : null,
-                      budget: widget.budget,
-                      // Set to countUnassignedTransactons: false for the pie chart
-                      //  includeAllSubCategories: showAllSubcategories,
-                      // If implementing pie chart summary for subcategories, also need to implement ability to tap a subcategory from the pie chart
-                      countUnassignedTransactons: true,
-                      includeAllSubCategories: false,
-                    ),
-                    builder: (context, snapshot) {
-                      if (snapshot.hasData) {
-                        double totalSpent = 0;
-                        double totalSpentAbsolute = 0;
-                        List<Widget> categoryEntries = [];
-                        snapshot.data!.forEach((category) {
-                          totalSpent = totalSpent + category.total;
-                          totalSpentAbsolute =
-                              totalSpentAbsolute + category.total.abs();
-                        });
-                        totalSpent = totalSpent * -1;
-                        snapshot.data!.asMap().forEach(
-                          (index, category) {
-                            if (category.category.mainCategoryPk == null)
-                              categoryEntries.add(
-                                StreamBuilder<List<TransactionCategory>>(
-                                    stream: database
-                                        .watchAllSubCategoriesOfMainCategory(
-                                            category.category.categoryPk),
-                                    builder: (context, snapshot) {
-                                      if (snapshot.hasData == false)
-                                        return SizedBox.shrink();
-                                      if (snapshot.hasData &&
-                                          (snapshot.data ?? []).length > 0) {
-                                        return subCategorySpendingSummary(
-                                            showIncomeExpenseIcons:
-                                                showIncomeExpenseIcons,
-                                            budgetRange: budgetRange,
-                                            todayPercent: todayPercent,
-                                            budgetColorScheme:
-                                                budgetColorScheme,
-                                            mainCategoryPkIfSubCategories:
-                                                category.category.categoryPk,
-                                            index: index,
-                                            selected: selectedCategory
-                                                    ?.categoryPk ==
-                                                category.category.categoryPk,
-                                            allSelected:
-                                                selectedCategory == null,
-                                            onlyShowMainCategory:
-                                                showAllSubcategories == false &&
-                                                    selectedCategory
-                                                            ?.categoryPk !=
-                                                        category.category
-                                                            .categoryPk);
-                                      }
-                                      return CategoryEntry(
-                                        todayPercent: todayPercent,
-                                        overSpentColor: showIncomeExpenseIcons
-                                            ? category.total > 0
-                                                ? getColor(
-                                                    context, "incomeAmount")
-                                                : getColor(
-                                                    context, "expenseAmount")
-                                            : null,
-                                        showIncomeExpenseIcons:
-                                            showIncomeExpenseIcons,
-                                        onLongPress: () {
-                                          enterCategoryLimitPopup(
-                                            context,
-                                            category.category,
-                                            category.categoryBudgetLimit,
-                                            widget.budget.budgetPk,
-                                            (p0) => null,
-                                            widget
-                                                .budget.isAbsoluteSpendingLimit,
-                                          );
-                                        },
-                                        isAbsoluteSpendingLimit: widget
-                                            .budget.isAbsoluteSpendingLimit,
-                                        budgetLimit: widget.budget.amount,
-                                        categoryBudgetLimit:
-                                            category.categoryBudgetLimit,
-                                        budgetColorScheme: budgetColorScheme,
-                                        category: category.category,
-                                        totalSpent: totalSpentAbsolute,
-                                        transactionCount:
-                                            category.transactionCount,
-                                        categorySpent:
-                                            showIncomeExpenseIcons == true
-                                                ? category.total
-                                                : category.total.abs(),
-                                        onTap: () {
-                                          if (selectedCategory?.categoryPk ==
-                                              category.category.categoryPk) {
-                                            setState(() {
-                                              selectedCategory = null;
-                                            });
-                                            _pieChartDisplayStateKey
-                                                .currentState!
-                                                .setTouchedIndex(-1);
-                                          } else {
-                                            setState(() {
-                                              selectedCategory =
-                                                  category.category;
-                                            });
-                                            _pieChartDisplayStateKey
-                                                .currentState!
-                                                .setTouchedIndex(index);
-                                          }
-                                        },
-                                        selected:
-                                            selectedCategory?.categoryPk ==
-                                                category.category.categoryPk,
-                                        allSelected: selectedCategory == null,
-                                      );
-                                    }),
+                builder: (context, snapshot) {
+                  if (snapshot.hasData) {
+                    double totalSpent = 0;
+                    double totalSpentAbsolute = 0;
+                    List<Widget> categoryEntries = [];
+
+                    Map<String, List<CategoryWithTotal>>
+                        subCategorySpendingIndexedByMainCategoryPk = {};
+                    Map<String, double> totalSpentOfMainCategories = {};
+
+                    snapshot.data!.forEach(
+                      (CategoryWithTotal categoryWithTotal) {
+                        totalSpent = totalSpent + categoryWithTotal.total;
+                        totalSpentAbsolute =
+                            totalSpentAbsolute + categoryWithTotal.total.abs();
+
+                        if (categoryWithTotal.category.mainCategoryPk != null) {
+                          if (subCategorySpendingIndexedByMainCategoryPk[
+                                  categoryWithTotal.category.mainCategoryPk!] ==
+                              null) {
+                            subCategorySpendingIndexedByMainCategoryPk[
+                                categoryWithTotal
+                                    .category.mainCategoryPk!] = [];
+                          }
+                          subCategorySpendingIndexedByMainCategoryPk[
+                                  categoryWithTotal.category.mainCategoryPk!]!
+                              .add(categoryWithTotal);
+                        }
+
+                        // if countUnassignedTransactions: false then we need to get the total of the main category
+                        if (categoryWithTotal.category.mainCategoryPk == null) {
+                          totalSpentOfMainCategories[categoryWithTotal.category
+                              .categoryPk] = (totalSpentOfMainCategories[
+                                      categoryWithTotal.category.categoryPk] ??
+                                  0) +
+                              categoryWithTotal.total;
+                        } else {
+                          totalSpentOfMainCategories[
+                                  categoryWithTotal.category.mainCategoryPk!] =
+                              (totalSpentOfMainCategories[categoryWithTotal
+                                          .category.mainCategoryPk!] ??
+                                      0) +
+                                  categoryWithTotal.total;
+                        }
+
+                        // if countUnassignedTransactions: false then we need to get the total of the main category
+                      },
+                    );
+
+                    List<CategoryWithTotal> dataWithoutSubcategories = [];
+
+                    if (showAllSubcategories == false) {
+                      (snapshot.data ?? [])
+                          .forEach((CategoryWithTotal categoryWithTotal) {
+                        if (categoryWithTotal.category.mainCategoryPk == null) {
+                          dataWithoutSubcategories.add(
+                            categoryWithTotal.copyWith(
+                                total: totalSpentOfMainCategories[
+                                        categoryWithTotal
+                                            .category.categoryPk] ??
+                                    0),
+                          );
+                        }
+                      });
+                    }
+
+                    bool hasSubCategories =
+                        subCategorySpendingIndexedByMainCategoryPk.isNotEmpty;
+
+                    totalSpent = totalSpent * -1;
+
+                    print(totalSpent);
+
+                    snapshot.data!.asMap().forEach(
+                      (index, category) {
+                        double totalSpentForCategory =
+                            category.category.mainCategoryPk == null
+                                ? (totalSpentOfMainCategories[
+                                        category.category.categoryPk] ??
+                                    0)
+                                : category.total;
+                        categoryEntries.add(
+                          CategoryEntry(
+                            selectedSubCategoryPk: selectedCategory?.categoryPk,
+                            expandSubcategories: showAllSubcategories ||
+                                category.category.categoryPk ==
+                                    selectedCategory?.categoryPk ||
+                                category.category.categoryPk ==
+                                    selectedCategory?.mainCategoryPk,
+                            subcategoriesWithTotalMap:
+                                subCategorySpendingIndexedByMainCategoryPk,
+                            todayPercent: todayPercent,
+                            overSpentColor: showIncomeExpenseIcons
+                                ? totalSpentForCategory > 0
+                                    ? getColor(context, "incomeAmount")
+                                    : getColor(context, "expenseAmount")
+                                : null,
+                            showIncomeExpenseIcons: showIncomeExpenseIcons,
+                            onLongPress: (TransactionCategory category,
+                                CategoryBudgetLimit? categoryBudgetLimit) {
+                              enterCategoryLimitPopup(
+                                context,
+                                category,
+                                categoryBudgetLimit,
+                                widget.budget.budgetPk,
+                                (p0) => null,
+                                widget.budget.isAbsoluteSpendingLimit,
                               );
-                          },
+                            },
+                            isAbsoluteSpendingLimit:
+                                widget.budget.isAbsoluteSpendingLimit,
+                            budgetLimit: widget.budget.amount,
+                            categoryBudgetLimit: category.categoryBudgetLimit,
+                            budgetColorScheme: budgetColorScheme,
+                            category: category.category,
+                            totalSpent: totalSpentAbsolute,
+                            transactionCount: category.transactionCount,
+                            categorySpent: showIncomeExpenseIcons == true
+                                ? totalSpentForCategory
+                                : totalSpentForCategory.abs(),
+                            onTap: (TransactionCategory tappedCategory, _) {
+                              if (selectedCategory?.categoryPk ==
+                                  tappedCategory.categoryPk) {
+                                setState(() {
+                                  selectedCategory = null;
+                                });
+                                _pieChartDisplayStateKey.currentState!
+                                    .setTouchedIndex(-1);
+                              } else {
+                                setState(() {
+                                  selectedCategory = tappedCategory;
+                                });
+                                _pieChartDisplayStateKey.currentState!
+                                    .setTouchedCategoryPk(
+                                        tappedCategory.categoryPk);
+                              }
+                            },
+                            selected: category.category.categoryPk ==
+                                    selectedCategory?.mainCategoryPk ||
+                                selectedCategory?.categoryPk ==
+                                    category.category.categoryPk,
+                            allSelected: selectedCategory == null,
+                          ),
                         );
-                        return SliverToBoxAdapter(
-                          child: Column(
-                            children: [
-                              Transform.translate(
-                                offset: Offset(0, -10),
-                                child: WidgetSize(
-                                  onChange: (Size size) {
-                                    budgetHeaderHeight = size.height - 20;
-                                  },
-                                  child: Container(
-                                    padding: EdgeInsets.only(
-                                      top: 10,
-                                      bottom: 22,
-                                      left: 22,
-                                      right: 22,
+                      },
+                    );
+                    return SliverToBoxAdapter(
+                      child: Column(
+                        children: [
+                          Transform.translate(
+                            offset: Offset(0, -10),
+                            child: WidgetSize(
+                              onChange: (Size size) {
+                                budgetHeaderHeight = size.height - 20;
+                              },
+                              child: Container(
+                                padding: EdgeInsets.only(
+                                  top: 10,
+                                  bottom: 22,
+                                  left: 22,
+                                  right: 22,
+                                ),
+                                decoration: BoxDecoration(
+                                  // borderRadius: BorderRadius.vertical(
+                                  //     bottom: Radius.circular(10)),
+                                  color: budgetColorScheme.secondaryContainer,
+                                ),
+                                child: Column(
+                                  children: [
+                                    Transform.scale(
+                                      alignment: Alignment.bottomCenter,
+                                      scale: 1500,
+                                      child: Container(
+                                        height: 10,
+                                        width: 100,
+                                        color: budgetColorScheme
+                                            .secondaryContainer,
+                                      ),
                                     ),
-                                    decoration: BoxDecoration(
-                                      // borderRadius: BorderRadius.vertical(
-                                      //     bottom: Radius.circular(10)),
-                                      color:
-                                          budgetColorScheme.secondaryContainer,
+                                    Padding(
+                                      padding: EdgeInsets.symmetric(
+                                        horizontal:
+                                            getHorizontalPaddingConstrained(
+                                                context),
+                                      ),
+                                      child: BudgetTimeline(
+                                        dateForRange: dateForRange,
+                                        budget: widget.budget,
+                                        large: true,
+                                        percent: widget.budget.amount == 0
+                                            ? 0
+                                            : totalSpent /
+                                                widget.budget.amount *
+                                                100,
+                                        yourPercent: 0,
+                                        todayPercent:
+                                            widget.isPastBudget == true
+                                                ? -1
+                                                : todayPercent,
+                                      ),
                                     ),
-                                    child: Column(
-                                      children: [
-                                        Transform.scale(
-                                          alignment: Alignment.bottomCenter,
-                                          scale: 1500,
-                                          child: Container(
-                                            height: 10,
-                                            width: 100,
-                                            color: budgetColorScheme
-                                                .secondaryContainer,
-                                          ),
-                                        ),
-                                        Padding(
-                                          padding: EdgeInsets.symmetric(
-                                            horizontal:
-                                                getHorizontalPaddingConstrained(
-                                                    context),
-                                          ),
-                                          child: BudgetTimeline(
-                                            dateForRange: dateForRange,
+                                    widget.isPastBudget == true
+                                        ? SizedBox.shrink()
+                                        : DaySpending(
                                             budget: widget.budget,
+                                            totalAmount: totalSpent,
                                             large: true,
-                                            percent: widget.budget.amount == 0
-                                                ? 0
-                                                : totalSpent /
-                                                    widget.budget.amount *
-                                                    100,
-                                            yourPercent: totalSpent == 0
-                                                ? 0
-                                                : snapshotTotalSpentByCurrentUserOnly
-                                                            .data! ==
-                                                        null
-                                                    ? 0
-                                                    : (snapshotTotalSpentByCurrentUserOnly
-                                                                .data! /
-                                                            totalSpent *
-                                                            100)
-                                                        .abs(),
-                                            todayPercent:
-                                                widget.isPastBudget == true
-                                                    ? -1
-                                                    : todayPercent,
+                                            budgetRange: budgetRange,
+                                            padding: const EdgeInsets.only(
+                                                top: 15, bottom: 0),
                                           ),
-                                        ),
-                                        widget.isPastBudget == true
-                                            ? SizedBox.shrink()
-                                            : DaySpending(
-                                                budget: widget.budget,
-                                                totalAmount: totalSpent,
-                                                large: true,
-                                                budgetRange: budgetRange,
-                                                padding: const EdgeInsets.only(
-                                                    top: 15, bottom: 0),
-                                              ),
-                                      ],
-                                    ),
-                                  ),
+                                  ],
                                 ),
                               ),
-                              appStateSettings["sharedBudgets"]
-                                  ? BudgetSpenderSummary(
-                                      budget: widget.budget,
-                                      budgetRange: budgetRange,
-                                      budgetColorScheme: budgetColorScheme,
-                                      setSelectedMember: (member) {
-                                        setState(() {
-                                          selectedMember = member;
-                                          selectedCategory = null;
-                                        });
-                                        _pieChartDisplayStateKey.currentState!
-                                            .setTouchedIndex(-1);
-                                      },
-                                    )
-                                  : SizedBox.shrink(),
-                              if (snapshot.data!.length > 0)
-                                SizedBox(height: 30),
-
-                              if (snapshot.data!.length > 0)
-                                pieChart(
+                            ),
+                          ),
+                          appStateSettings["sharedBudgets"]
+                              ? BudgetSpenderSummary(
+                                  budget: widget.budget,
                                   budgetRange: budgetRange,
-                                  totalSpentAbsolute: totalSpentAbsolute,
                                   budgetColorScheme: budgetColorScheme,
-                                  showAllSubcategories: showAllSubcategories,
-                                  toggleAllSubCategories:
-                                      toggleAllSubcategories,
-                                  dataPassed: snapshot.data ?? [],
-                                ),
-                              // if (snapshot.data!.length > 0)
-                              //   SizedBox(height: 35),
-                              ...categoryEntries,
-                              if (snapshot.data!.length > 0)
-                                SizedBox(height: 15),
-                            ],
-                          ),
-                        );
-                      }
-                      return SliverToBoxAdapter(child: Container());
-                    },
-                  );
+                                  setSelectedMember: (member) {
+                                    setState(() {
+                                      selectedMember = member;
+                                      selectedCategory = null;
+                                    });
+                                    _pieChartDisplayStateKey.currentState!
+                                        .setTouchedIndex(-1);
+                                  },
+                                )
+                              : SizedBox.shrink(),
+                          if (snapshot.data!.length > 0) SizedBox(height: 30),
+
+                          if (snapshot.data!.length > 0)
+                            pieChart(
+                              budgetRange: budgetRange,
+                              totalSpentAbsolute: totalSpentAbsolute,
+                              budgetColorScheme: budgetColorScheme,
+                              showAllSubcategories: showAllSubcategories,
+                              toggleAllSubCategories: toggleAllSubcategories,
+                              data: (snapshot.data ?? []),
+                              dataWithoutSubcategories:
+                                  dataWithoutSubcategories,
+                              hasSubCategories: hasSubCategories,
+                            ),
+                          // if (snapshot.data!.length > 0)
+                          //   SizedBox(height: 35),
+                          ...categoryEntries,
+                          if (snapshot.data!.length > 0) SizedBox(height: 15),
+                        ],
+                      ),
+                    );
+                  }
+                  return SliverToBoxAdapter(child: Container());
                 },
               ),
               SliverToBoxAdapter(
@@ -1089,71 +850,60 @@ class _BudgetPageContentState extends State<_BudgetPageContent> {
                     : SizedBox.shrink(),
               ),
               SliverToBoxAdapter(
-                child: StreamBuilder<double?>(
-                  stream: database.watchTotalSpentByCurrentUserOnly(
-                    Provider.of<AllWallets>(context),
-                    budgetRange.start,
-                    budgetRange.end,
-                    widget.budget.budgetPk,
+                child: StreamBuilder<List<CategoryWithTotal>>(
+                  stream: database
+                      .watchTotalSpentInEachCategoryInTimeRangeFromCategories(
+                    allWallets: Provider.of<AllWallets>(context),
+                    start: budgetRange.start,
+                    end: budgetRange.end,
+                    categoryFks: widget.budget.categoryFks,
+                    categoryFksExclude: widget.budget.categoryFksExclude,
+                    budgetTransactionFilters:
+                        widget.budget.budgetTransactionFilters,
+                    memberTransactionFilters:
+                        widget.budget.memberTransactionFilters,
+                    member: selectedMember,
+                    onlyShowTransactionsBelongingToBudgetPk:
+                        widget.budget.sharedKey != null ||
+                                widget.budget.addedTransactionsOnly == true
+                            ? widget.budget.budgetPk
+                            : null,
+                    budget: widget.budget,
                   ),
-                  builder: (context, snapshotTotalSpentByCurrentUserOnly) {
-                    return StreamBuilder<List<CategoryWithTotal>>(
-                      stream: database
-                          .watchTotalSpentInEachCategoryInTimeRangeFromCategories(
-                        allWallets: Provider.of<AllWallets>(context),
-                        start: budgetRange.start,
-                        end: budgetRange.end,
-                        categoryFks: widget.budget.categoryFks,
-                        categoryFksExclude: widget.budget.categoryFksExclude,
-                        budgetTransactionFilters:
-                            widget.budget.budgetTransactionFilters,
-                        memberTransactionFilters:
-                            widget.budget.memberTransactionFilters,
-                        member: selectedMember,
-                        onlyShowTransactionsBelongingToBudgetPk:
-                            widget.budget.sharedKey != null ||
-                                    widget.budget.addedTransactionsOnly == true
-                                ? widget.budget.budgetPk
-                                : null,
-                        budget: widget.budget,
-                      ),
-                      builder: (context, snapshot) {
-                        if (snapshot.hasData) {
-                          double totalSpent = 0;
-                          int totalTransactions = 0;
-                          snapshot.data!.forEach((category) {
-                            totalSpent = totalSpent + category.total;
-                            totalTransactions =
-                                totalTransactions + category.transactionCount;
-                          });
-                          totalSpent = totalSpent * -1;
-                          if (totalSpent == 0 && totalTransactions == 0)
-                            return SizedBox.shrink();
-                          return Padding(
-                            padding: const EdgeInsets.only(
-                              left: 10,
-                              right: 10,
-                              top: 10,
-                              bottom: 8,
-                            ),
-                            child: TextFont(
-                              text: "total-cash-flow".tr() +
-                                  ": " +
-                                  convertToMoney(
-                                      Provider.of<AllWallets>(context),
-                                      totalSpent) +
-                                  "\n" +
-                                  totalTransactions.toString() +
-                                  " transactions",
-                              fontSize: 13,
-                              textAlign: TextAlign.center,
-                              textColor: getColor(context, "textLight"),
-                            ),
-                          );
-                        }
+                  builder: (context, snapshot) {
+                    if (snapshot.hasData) {
+                      double totalSpent = 0;
+                      int totalTransactions = 0;
+                      snapshot.data!.forEach((category) {
+                        totalSpent = totalSpent + category.total;
+                        totalTransactions =
+                            totalTransactions + category.transactionCount;
+                      });
+                      totalSpent = totalSpent * -1;
+                      if (totalSpent == 0 && totalTransactions == 0)
                         return SizedBox.shrink();
-                      },
-                    );
+                      return Padding(
+                        padding: const EdgeInsets.only(
+                          left: 10,
+                          right: 10,
+                          top: 10,
+                          bottom: 8,
+                        ),
+                        child: TextFont(
+                          text: "total-cash-flow".tr() +
+                              ": " +
+                              convertToMoney(Provider.of<AllWallets>(context),
+                                  totalSpent) +
+                              "\n" +
+                              totalTransactions.toString() +
+                              " transactions",
+                          fontSize: 13,
+                          textAlign: TextAlign.center,
+                          textColor: getColor(context, "textLight"),
+                        ),
+                      );
+                    }
+                    return SizedBox.shrink();
                   },
                 ),
               ),
@@ -1395,6 +1145,8 @@ class _BudgetLineGraphState extends State<BudgetLineGraph> {
               for (Transaction transaction in snapshot.data![snapshotIndex]) {
                 if (widget.selectedCategory == null ||
                     transaction.categoryFk ==
+                        widget.selectedCategory?.categoryPk ||
+                    transaction.subCategoryFk ==
                         widget.selectedCategory?.categoryPk) if (indexDay
                             .year ==
                         transaction.dateCreated.year &&
diff --git a/budget/lib/pages/walletDetailsPage.dart b/budget/lib/pages/walletDetailsPage.dart
index d15fb109d..013cef2e6 100644
--- a/budget/lib/pages/walletDetailsPage.dart
+++ b/budget/lib/pages/walletDetailsPage.dart
@@ -499,7 +499,7 @@ class _WalletCategoryPieChartState extends State<WalletCategoryPieChart> {
                     totalSpent: total,
                     transactionCount: category.transactionCount,
                     categorySpent: category.total,
-                    onTap: () {
+                    onTap: (_, __) {
                       if (selectedCategoryPk == category.category.categoryPk) {
                         setState(() {
                           selectedCategoryPk = "-1";
diff --git a/budget/lib/widgets/categoryEntry.dart b/budget/lib/widgets/categoryEntry.dart
index 34fc23602..a2fb3ae96 100644
--- a/budget/lib/widgets/categoryEntry.dart
+++ b/budget/lib/widgets/categoryEntry.dart
@@ -6,6 +6,7 @@ import 'package:budget/pages/addCategoryPage.dart';
 import 'package:budget/struct/settings.dart';
 import 'package:budget/widgets/animatedExpanded.dart';
 import 'package:budget/widgets/categoryIcon.dart';
+import 'package:budget/widgets/categoryLimits.dart';
 import 'package:budget/widgets/openBottomSheet.dart';
 import 'package:budget/widgets/openPopup.dart';
 import 'package:budget/widgets/tappable.dart';
@@ -25,7 +26,6 @@ class CategoryEntry extends StatelessWidget {
     required this.totalSpent,
     required this.onTap,
     required this.selected,
-    this.highlightIfSelected = true,
     required this.allSelected,
     required this.budgetColorScheme,
     this.categoryBudgetLimit,
@@ -37,30 +37,49 @@ class CategoryEntry extends StatelessWidget {
     this.budgetLimit = 0,
     this.overSpentColor,
     this.todayPercent,
+    this.subcategoriesWithTotalMap,
+    this.expandSubcategories = true,
+    this.selectedSubCategoryPk,
+    this.alwaysShow = false,
   }) : super(key: key);
 
   final TransactionCategory category;
   final int transactionCount;
   final double totalSpent;
   final double categorySpent;
-  final VoidCallback onTap;
+  final Function(TransactionCategory category,
+      CategoryBudgetLimit? categoryBudgetLimit) onTap;
   final bool selected;
-  final bool highlightIfSelected;
   final bool allSelected;
   final ColorScheme budgetColorScheme;
   final bool isTiled;
   final CategoryBudgetLimit? categoryBudgetLimit;
-  final Function? onLongPress;
+  final Function(TransactionCategory category,
+      CategoryBudgetLimit? categoryBudgetLimit)? onLongPress;
   final String? extraText;
   final bool showIncomeExpenseIcons;
   final bool isAbsoluteSpendingLimit;
   final double budgetLimit;
   final Color? overSpentColor;
   final double? todayPercent;
+  final Map<String, List<CategoryWithTotal>>? subcategoriesWithTotalMap;
+  final bool expandSubcategories;
+  final String? selectedSubCategoryPk;
+  final bool alwaysShow;
 
   @override
   Widget build(BuildContext context) {
     Widget component;
+
+    List<CategoryWithTotal> subCategoriesWithTotal =
+        subcategoriesWithTotalMap?[category.categoryPk] ?? [];
+
+    if (category.mainCategoryPk != null && subcategoriesWithTotalMap != null)
+      return SizedBox.shrink();
+
+    bool hasSubCategories =
+        subCategoriesWithTotal.length > 0 && expandSubcategories != false;
+
     if (isTiled) {
       component = Container(
         width: 70,
@@ -120,196 +139,281 @@ class CategoryEntry extends StatelessWidget {
         padding: EdgeInsets.symmetric(
           horizontal: getHorizontalPaddingConstrained(context),
         ),
-        child: Row(
-          children: [
-            // CategoryIcon(
-            //   category: category,
-            //   size: 30,
-            //   margin: EdgeInsets.zero,
-            // ),
-            CategoryIconPercent(
-              category: category,
-              percent: percentSpent * 100,
-              progressBackgroundColor: appStateSettings["materialYou"]
-                  ? budgetColorScheme.secondaryContainer
-                  : selected
-                      ? getColor(context, "white")
-                      : getColor(context, "lightDarkAccentHeavy"),
-              size: 28,
-              insetPadding: 18,
-            ),
-            Container(
-              width: 15,
-            ),
-            Expanded(
-              child: Container(
-                child: Column(
-                  crossAxisAlignment: CrossAxisAlignment.start,
-                  mainAxisAlignment: MainAxisAlignment.end,
-                  children: [
-                    Row(
-                      children: [
-                        Expanded(
-                          child: TextFont(
-                            text: category.name,
-                            fontSize: 17,
-                            maxLines: 1,
-                          ),
-                        ),
-                        SizedBox(width: 10),
-                        categorySpent == 0 || showIncomeExpenseIcons == false
-                            ? SizedBox.shrink()
-                            : Transform.translate(
-                                offset: Offset(3, 0),
-                                child: Transform.rotate(
-                                  angle: categorySpent >= 0 ? pi : 0,
-                                  child: Icon(
-                                    appStateSettings["outlinedIcons"]
-                                        ? Icons.arrow_drop_down_outlined
-                                        : Icons.arrow_drop_down_rounded,
-                                    color: showIncomeExpenseIcons
-                                        ? categorySpent > 0
-                                            ? getColor(context, "incomeAmount")
-                                            : getColor(context, "expenseAmount")
-                                        : getColor(context, "black"),
-                                  ),
+        child: Builder(
+          builder: (context) {
+            Widget mainCategoryWidget = Padding(
+              padding: hasSubCategories
+                  ? EdgeInsets.zero
+                  : EdgeInsets.only(left: 20, right: 25, top: 8, bottom: 8),
+              child: Row(
+                children: [
+                  CategoryIconPercent(
+                    category: category,
+                    percent: percentSpent * 100,
+                    progressBackgroundColor: appStateSettings["materialYou"]
+                        ? budgetColorScheme.secondaryContainer
+                        : selected
+                            ? getColor(context, "white")
+                            : getColor(context, "lightDarkAccentHeavy"),
+                    size: 28,
+                    insetPadding: 18,
+                  ),
+                  Container(
+                    width: 15,
+                  ),
+                  Expanded(
+                    child: Container(
+                      child: Column(
+                        crossAxisAlignment: CrossAxisAlignment.start,
+                        mainAxisAlignment: MainAxisAlignment.end,
+                        children: [
+                          Row(
+                            children: [
+                              Expanded(
+                                child: TextFont(
+                                  text: category.name,
+                                  fontSize: 17,
+                                  maxLines: 1,
                                 ),
                               ),
-                        Row(
-                          crossAxisAlignment: CrossAxisAlignment.end,
-                          children: [
-                            TextFont(
-                              fontWeight: FontWeight.bold,
-                              text: convertToMoney(
-                                  Provider.of<AllWallets>(context),
-                                  amountSpent),
-                              fontSize: 20,
-                              textColor: isOverspent
-                                  ? overSpentColor ??
-                                      getColor(context, "expenseAmount")
-                                  : showIncomeExpenseIcons && categorySpent != 0
-                                      ? categorySpent > 0
-                                          ? getColor(context, "incomeAmount")
-                                          : getColor(context, "expenseAmount")
-                                      : getColor(context, "black"),
-                            ),
-                            categoryBudgetLimit == null
-                                ? SizedBox.shrink()
-                                : Padding(
-                                    padding: const EdgeInsets.only(bottom: 1),
-                                    child: TextFont(
-                                      text: " / " +
-                                          convertToMoney(
-                                              Provider.of<AllWallets>(context),
-                                              spendingLimit),
-                                      fontSize: 14,
-                                      textColor: isOverspent
-                                          ? overSpentColor ??
-                                              getColor(context, "expenseAmount")
-                                          : getColor(context, "black")
-                                              .withOpacity(0.3),
-                                    ),
-                                  ),
-                          ],
-                        ),
-                      ],
-                    ),
-                    SizedBox(
-                      height: 1,
-                    ),
-                    Row(
-                      children: [
-                        Expanded(
-                          child: categoryBudgetLimit != null
-                              ? Padding(
-                                  padding: const EdgeInsets.only(
-                                    top: 3,
-                                    right: 13,
-                                    bottom: 3,
-                                  ),
-                                  child: ThinProgress(
-                                    backgroundColor:
-                                        appStateSettings["materialYou"]
-                                            ? budgetColorScheme
-                                                .secondaryContainer
-                                            : selected
-                                                ? getColor(context, "white")
-                                                : getColor(context,
-                                                    "lightDarkAccentHeavy"),
-                                    color: dynamicPastel(
-                                      context,
-                                      HexColor(
-                                        category.colour,
-                                        defaultColor: Theme.of(context)
-                                            .colorScheme
-                                            .primary,
+                              SizedBox(width: 10),
+                              categorySpent == 0 ||
+                                      showIncomeExpenseIcons == false
+                                  ? SizedBox.shrink()
+                                  : Transform.translate(
+                                      offset: Offset(3, 0),
+                                      child: Transform.rotate(
+                                        angle: categorySpent >= 0 ? pi : 0,
+                                        child: Icon(
+                                          appStateSettings["outlinedIcons"]
+                                              ? Icons.arrow_drop_down_outlined
+                                              : Icons.arrow_drop_down_rounded,
+                                          color: showIncomeExpenseIcons
+                                              ? categorySpent > 0
+                                                  ? getColor(
+                                                      context, "incomeAmount")
+                                                  : getColor(
+                                                      context, "expenseAmount")
+                                              : getColor(context, "black"),
+                                        ),
                                       ),
-                                      inverse: true,
-                                      amountLight: 0.1,
-                                      amountDark: 0.1,
                                     ),
-                                    progress: percentSpent,
-                                    dotProgress: todayPercent == null
-                                        ? null
-                                        : (todayPercent ?? 0) / 100,
+                              Row(
+                                crossAxisAlignment: CrossAxisAlignment.end,
+                                children: [
+                                  TextFont(
+                                    fontWeight: FontWeight.bold,
+                                    text: convertToMoney(
+                                        Provider.of<AllWallets>(context),
+                                        amountSpent),
+                                    fontSize: 20,
+                                    textColor: isOverspent
+                                        ? overSpentColor ??
+                                            getColor(context, "expenseAmount")
+                                        : showIncomeExpenseIcons &&
+                                                categorySpent != 0
+                                            ? categorySpent > 0
+                                                ? getColor(
+                                                    context, "incomeAmount")
+                                                : getColor(
+                                                    context, "expenseAmount")
+                                            : getColor(context, "black"),
                                   ),
-                                )
-                              : TextFont(
-                                  text: (totalSpent == 0
-                                          ? "0"
-                                          : (categorySpent / totalSpent * 100)
-                                              .abs()
-                                              .toStringAsFixed(0)) +
-                                      "% " +
-                                      (extraText ?? "of-spending")
-                                          .toString()
-                                          .tr(),
-                                  fontSize: 14,
-                                  textColor: selected
-                                      ? getColor(context, "black")
-                                          .withOpacity(0.4)
-                                      : getColor(context, "textLight"),
-                                ),
-                        ),
-                        TextFont(
-                          text: transactionCount.toString() +
-                              " " +
-                              (transactionCount == 1
-                                  ? "transaction".tr().toLowerCase()
-                                  : "transactions".tr().toLowerCase()),
-                          fontSize: 14,
-                          textColor: selected
-                              ? getColor(context, "black").withOpacity(0.4)
-                              : getColor(context, "textLight"),
-                        ),
-                      ],
+                                  categoryBudgetLimit == null
+                                      ? SizedBox.shrink()
+                                      : Padding(
+                                          padding:
+                                              const EdgeInsets.only(bottom: 1),
+                                          child: TextFont(
+                                            text: " / " +
+                                                convertToMoney(
+                                                    Provider.of<AllWallets>(
+                                                        context),
+                                                    spendingLimit),
+                                            fontSize: 14,
+                                            textColor: isOverspent
+                                                ? overSpentColor ??
+                                                    getColor(context,
+                                                        "expenseAmount")
+                                                : getColor(context, "black")
+                                                    .withOpacity(0.3),
+                                          ),
+                                        ),
+                                ],
+                              ),
+                            ],
+                          ),
+                          SizedBox(
+                            height: 1,
+                          ),
+                          Row(
+                            children: [
+                              Expanded(
+                                child: categoryBudgetLimit != null
+                                    ? Padding(
+                                        padding: const EdgeInsets.only(
+                                          top: 3,
+                                          right: 13,
+                                          bottom: 3,
+                                        ),
+                                        child: ThinProgress(
+                                          backgroundColor: appStateSettings[
+                                                  "materialYou"]
+                                              ? budgetColorScheme
+                                                  .secondaryContainer
+                                              : selected
+                                                  ? getColor(context, "white")
+                                                  : getColor(context,
+                                                      "lightDarkAccentHeavy"),
+                                          color: dynamicPastel(
+                                            context,
+                                            HexColor(
+                                              category.colour,
+                                              defaultColor: Theme.of(context)
+                                                  .colorScheme
+                                                  .primary,
+                                            ),
+                                            inverse: true,
+                                            amountLight: 0.1,
+                                            amountDark: 0.1,
+                                          ),
+                                          progress: percentSpent,
+                                          dotProgress: todayPercent == null
+                                              ? null
+                                              : (todayPercent ?? 0) / 100,
+                                        ),
+                                      )
+                                    : TextFont(
+                                        text: (totalSpent == 0
+                                                ? "0"
+                                                : (categorySpent /
+                                                        totalSpent *
+                                                        100)
+                                                    .abs()
+                                                    .toStringAsFixed(0)) +
+                                            "% " +
+                                            (extraText ?? "of-spending")
+                                                .toString()
+                                                .tr(),
+                                        fontSize: 14,
+                                        textColor: selected
+                                            ? getColor(context, "black")
+                                                .withOpacity(0.4)
+                                            : getColor(context, "textLight"),
+                                      ),
+                              ),
+                              TextFont(
+                                text: transactionCount.toString() +
+                                    " " +
+                                    (transactionCount == 1
+                                        ? "transaction".tr().toLowerCase()
+                                        : "transactions".tr().toLowerCase()),
+                                fontSize: 14,
+                                textColor: selected
+                                    ? getColor(context, "black")
+                                        .withOpacity(0.4)
+                                    : getColor(context, "textLight"),
+                              ),
+                            ],
+                          ),
+                        ],
+                      ),
                     ),
-                  ],
+                  ),
+                ],
+              ),
+            );
+
+            if (subCategoriesWithTotal.length <= 0) return mainCategoryWidget;
+
+            Widget subCategoriesSummaryWidget = AnimatedExpanded(
+              key: ValueKey(1),
+              expand: selected == true || allSelected,
+              child: SubCategoriesContainer(
+                onTap: () {
+                  onTap(category, categoryBudgetLimit);
+                },
+                key: ValueKey(category.categoryPk),
+                mainCategory: Padding(
+                  padding: const EdgeInsets.only(
+                      left: 20, right: 25, top: 8, bottom: 8),
+                  child: mainCategoryWidget,
+                ),
+                colorScheme: budgetColorScheme,
+                subCategoryEntries: Padding(
+                  padding: const EdgeInsets.only(top: 5),
+                  child: Column(
+                    children: [
+                      for (CategoryWithTotal subcategoryWithTotal
+                          in subCategoriesWithTotal)
+                        CategoryEntry(
+                          onTap: onTap,
+                          todayPercent: todayPercent,
+                          overSpentColor: showIncomeExpenseIcons
+                              ? subcategoryWithTotal.total > 0
+                                  ? getColor(context, "incomeAmount")
+                                  : getColor(context, "expenseAmount")
+                              : null,
+                          showIncomeExpenseIcons: showIncomeExpenseIcons,
+                          onLongPress: onLongPress,
+                          isAbsoluteSpendingLimit: isAbsoluteSpendingLimit,
+                          budgetLimit: categoryBudgetLimit == null
+                              ? budgetLimit
+                              : isAbsoluteSpendingLimit
+                                  ? (categoryBudgetLimit?.amount ?? 1)
+                                  : (categoryBudgetLimit?.amount ?? 1) *
+                                      budgetLimit /
+                                      100,
+                          categoryBudgetLimit:
+                              subcategoryWithTotal.categoryBudgetLimit,
+                          budgetColorScheme: budgetColorScheme,
+                          category: subcategoryWithTotal.category,
+                          totalSpent: totalSpent,
+                          transactionCount:
+                              subcategoryWithTotal.transactionCount,
+                          categorySpent: showIncomeExpenseIcons == true
+                              ? subcategoryWithTotal.total
+                              : subcategoryWithTotal.total.abs(),
+                          selected: selectedSubCategoryPk ==
+                              subcategoryWithTotal.category.categoryPk,
+                          allSelected: allSelected,
+                          alwaysShow: selected,
+                        ),
+                    ],
+                  ),
                 ),
               ),
-            ),
-          ],
+            );
+
+            return AnimatedSizeSwitcher(
+              child: expandSubcategories == true
+                  ? subCategoriesSummaryWidget
+                  : mainCategoryWidget,
+            );
+          },
         ),
       );
     }
     return WillPopScope(
       onWillPop: () async {
         if (allSelected == false && selected) {
-          onTap();
+          onTap(category, categoryBudgetLimit);
           return false;
         }
         return true;
       },
       child: AnimatedExpanded(
-        expand: !(!selected && !allSelected && isTiled == false),
+        expand: !(!selected && !allSelected && isTiled == false) || alwaysShow,
         duration: Duration(milliseconds: 650),
         sizeCurve: Curves.easeInOutCubic,
         child: Tappable(
           borderRadius: isTiled ? 15 : 0,
           key: ValueKey(isTiled),
-          onTap: onTap,
+          onTap: () {
+            onTap(category, categoryBudgetLimit);
+          },
           onLongPress: onLongPress != null
-              ? () => onLongPress!()
+              ? () => onLongPress!(category, categoryBudgetLimit)
               : () => pushRoute(
                     context,
                     AddCategoryPage(
@@ -320,7 +424,7 @@ class CategoryEntry extends StatelessWidget {
           color: Colors.transparent,
           child: AnimatedOpacity(
             duration: Duration(milliseconds: 300),
-            opacity: allSelected
+            opacity: allSelected || alwaysShow
                 ? 1
                 : selected
                     ? 1
@@ -328,7 +432,7 @@ class CategoryEntry extends StatelessWidget {
             child: AnimatedContainer(
               decoration: BoxDecoration(
                 borderRadius: BorderRadius.circular(isTiled ? 15 : 0),
-                color: highlightIfSelected && selected
+                color: selected && hasSubCategories == false
                     ? dynamicPastel(context, budgetColorScheme.primary,
                             amount: 0.3)
                         .withAlpha(80)
@@ -336,9 +440,6 @@ class CategoryEntry extends StatelessWidget {
               ),
               curve: Curves.easeInOut,
               duration: Duration(milliseconds: 500),
-              padding: isTiled
-                  ? null
-                  : EdgeInsets.only(left: 20, right: 25, top: 8, bottom: 8),
               child: component,
             ),
           ),
diff --git a/budget/lib/widgets/categoryLimits.dart b/budget/lib/widgets/categoryLimits.dart
index c51563a93..9487e68a9 100644
--- a/budget/lib/widgets/categoryLimits.dart
+++ b/budget/lib/widgets/categoryLimits.dart
@@ -197,7 +197,7 @@ class _CategoryLimitEntryState extends State<CategoryLimitEntry> {
   Widget build(BuildContext context) {
     return StreamBuilder<List<TransactionCategory>>(
       stream: database
-          .watchAllSubCategoriesOfMainCategory(widget.category!.categoryPk),
+          .watchAllSubCategoriesOfMainCategory(widget.category.categoryPk),
       builder: (context, snapshot) {
         List<TransactionCategory> subCategories = snapshot.data ?? [];
         bool hasSubCategories = subCategories.length > 0;
@@ -430,6 +430,43 @@ class SubCategoriesContainer extends StatelessWidget {
 
   @override
   Widget build(BuildContext context) {
+    Widget content = Column(
+      children: [
+        Container(
+          decoration: BoxDecoration(
+            color: (colorScheme ?? Theme.of(context).colorScheme)
+                .secondaryContainer
+                .withOpacity(0.5),
+            borderRadius: BorderRadius.vertical(
+              top: Radius.circular(
+                getPlatform() == PlatformOS.isIOS ? 0 : 14,
+              ),
+            ),
+          ),
+          padding: EdgeInsets.symmetric(
+              vertical: getPlatform() == PlatformOS.isIOS ? 2 : 7),
+          child: mainCategory,
+        ),
+        separatorBanner ?? SizedBox.shrink(),
+        subCategoryEntries,
+        SizedBox(height: 5),
+        extraButtonEnd ?? SizedBox.shrink(),
+      ],
+    );
+    if (getPlatform() == PlatformOS.isIOS)
+      return Column(
+        children: [
+          HorizontalBreak(padding: EdgeInsets.zero),
+          Container(
+            child: content,
+            color: (colorScheme ?? Theme.of(context).colorScheme)
+                .secondaryContainer
+                .withOpacity(0.2),
+          ),
+          HorizontalBreak(padding: EdgeInsets.zero),
+          SizedBox(height: 6),
+        ],
+      );
     return Padding(
       padding: EdgeInsets.symmetric(horizontal: 10, vertical: 3),
       child: ClipRRect(
@@ -449,25 +486,7 @@ class SubCategoriesContainer extends StatelessWidget {
               ),
               borderRadius: BorderRadius.circular(15),
             ),
-            child: Column(
-              children: [
-                Container(
-                  decoration: BoxDecoration(
-                    color: (colorScheme ?? Theme.of(context).colorScheme)
-                        .secondaryContainer
-                        .withOpacity(0.5),
-                    borderRadius:
-                        BorderRadius.vertical(top: Radius.circular(14)),
-                  ),
-                  padding: EdgeInsets.symmetric(vertical: 7),
-                  child: mainCategory,
-                ),
-                separatorBanner ?? SizedBox.shrink(),
-                subCategoryEntries,
-                SizedBox(height: 5),
-                extraButtonEnd ?? SizedBox.shrink(),
-              ],
-            ),
+            child: content,
           ),
         ),
       ),
diff --git a/budget/lib/widgets/pieChart.dart b/budget/lib/widgets/pieChart.dart
index 519b89298..8eb2a8e17 100644
--- a/budget/lib/widgets/pieChart.dart
+++ b/budget/lib/widgets/pieChart.dart
@@ -164,6 +164,23 @@ class PieChartDisplayState extends State<PieChartDisplay> {
     });
   }
 
+  void setTouchedCategoryPk(String? categoryPk) {
+    if (categoryPk == null) return;
+    int index = 0;
+    bool found = false;
+    for (CategoryWithTotal category in widget.data) {
+      if (category.category.categoryPk == categoryPk) {
+        found = true;
+        break;
+      }
+      index++;
+    }
+    if (found == false)
+      setTouchedIndex(-1);
+    else
+      setTouchedIndex(index);
+  }
+
   @override
   Widget build(BuildContext context) {
     if (widget.data.length <= 0) return SizedBox.shrink();
diff --git a/budget/lib/widgets/showChangelog.dart b/budget/lib/widgets/showChangelog.dart
index 24ec00b02..8619d3683 100644
--- a/budget/lib/widgets/showChangelog.dart
+++ b/budget/lib/widgets/showChangelog.dart
@@ -22,6 +22,10 @@ import 'listItem.dart';
 
 String getChangelogString() {
   return """
+    < 4.6.1
+    Support for subcategory selection on budget page
+    Rewrote pie chart and spending summary for budget details page to better support subcategories
+    iOS layout for subcategories
     < 4.6.0
     Make subcategory into main category
     Merge subcategories support
diff --git a/budget/pubspec.yaml b/budget/pubspec.yaml
index b350600e7..6dd2367da 100644
--- a/budget/pubspec.yaml
+++ b/budget/pubspec.yaml
@@ -15,7 +15,7 @@ publish_to: "none" # Remove this line if you wish to publish to pub.dev
 # In iOS, build-name is used as CFBundleShortVersionString while build-number used as CFBundleVersion.
 # Read more about iOS versioning at
 # https://developer.apple.com/library/archive/documentation/General/Reference/InfoPlistKeyReference/Articles/CoreFoundationKeys.html
-version: 4.6.0+220
+version: 4.6.1+220
 
 environment:
   sdk: ">= 3.0.0"
