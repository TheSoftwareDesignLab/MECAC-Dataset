diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/MainFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/MainFragment.kt
index 0e73271a783..b4feccf0609 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/MainFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/MainFragment.kt
@@ -511,7 +511,7 @@ class MainFragment :
 
     /* ------------------------------- ShowsPointMarkers -------------------------------- */
 
-    override fun putMarkerForCurrentHighlighting(
+    @UiThread override fun putMarkerForCurrentHighlighting(
         geometry: ElementGeometry,
         @DrawableRes drawableResId: Int?,
         title: String?
@@ -519,11 +519,11 @@ class MainFragment :
         mapFragment?.putMarkerForCurrentHighlighting(geometry, drawableResId, title)
     }
 
-    override fun deleteMarkerForCurrentHighlighting(geometry: ElementGeometry) {
+    @UiThread override fun deleteMarkerForCurrentHighlighting(geometry: ElementGeometry) {
         mapFragment?.deleteMarkerForCurrentHighlighting(geometry)
     }
 
-    override fun clearMarkersForCurrentHighlighting() {
+    @UiThread override fun clearMarkersForCurrentHighlighting() {
         mapFragment?.clearMarkersForCurrentHighlighting()
     }
 
@@ -1108,7 +1108,7 @@ class MainFragment :
                 val geometry = mapData?.getGeometry(e.type, e.id) ?: continue
                 val icon = getPinIcon(featureDictionaryFuture.get(), e.tags)
                 val title = getTitle(e.tags)
-                putMarkerForCurrentHighlighting(geometry, icon, title)
+                withContext(Dispatchers.Main) { putMarkerForCurrentHighlighting(geometry, icon, title) }
             }
         }
     }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/DownloadedAreaManager.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/DownloadedAreaManager.kt
index f8b5a6c89d9..fc2a2f19f5c 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/DownloadedAreaManager.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/DownloadedAreaManager.kt
@@ -5,21 +5,20 @@ import androidx.lifecycle.LifecycleOwner
 import de.westnordost.streetcomplete.ApplicationConstants
 import de.westnordost.streetcomplete.data.download.tiles.DownloadedTilesSource
 import de.westnordost.streetcomplete.screens.main.map.components.DownloadedAreaMapComponent
-import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
 import kotlinx.coroutines.CoroutineScope
+import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.SupervisorJob
 import kotlinx.coroutines.cancel
 import kotlinx.coroutines.cancelChildren
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 
 class DownloadedAreaManager(
-    private val ctrl: KtMapController,
     private val mapComponent: DownloadedAreaMapComponent,
     private val downloadedTilesSource: DownloadedTilesSource
 ) : DefaultLifecycleObserver {
 
     private val viewLifecycleScope: CoroutineScope = CoroutineScope(SupervisorJob())
-    private var hasUpdated: Boolean = false
 
     private val downloadedTilesListener = object : DownloadedTilesSource.Listener {
         override fun onUpdated() {
@@ -45,18 +44,12 @@ class DownloadedAreaManager(
 
     private fun update() {
         viewLifecycleScope.launch {
-            if (ctrl.cameraPosition.zoom <= 8) {
-                hasUpdated = false
-            } else {
-                mapComponent.set(downloadedTilesSource.getAll(ApplicationConstants.DELETE_OLD_DATA_AFTER))
-                hasUpdated = true
-            }
+            val tiles = withContext(Dispatchers.IO) { downloadedTilesSource.getAll(ApplicationConstants.DELETE_OLD_DATA_AFTER) }
+            withContext(Dispatchers.Main) { mapComponent.set(tiles) }
         }
     }
 
     fun onNewScreenPosition() {
-        // workaround for tangram bug that if the polygon is set while the zoom is ~ below zoom 6
-        // no holes (= the downloaded areas) will be shown
-        if (!hasUpdated) update()
+        update()
     }
 }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/EditHistoryPinsManager.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/EditHistoryPinsManager.kt
index 1d7ab2c2cdc..7e35ef02fd8 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/EditHistoryPinsManager.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/EditHistoryPinsManager.kt
@@ -78,7 +78,7 @@ class EditHistoryPinsManager(
 
     private fun hide() {
         viewLifecycleScope.coroutineContext.cancelChildren()
-        viewLifecycleScope.launch { pinsMapComponent.clear() }
+        viewLifecycleScope.launch(Dispatchers.Main) { pinsMapComponent.clear() }
         editHistorySource.removeListener(editHistoryListener)
     }
 
@@ -90,7 +90,7 @@ class EditHistoryPinsManager(
             if (this@EditHistoryPinsManager.isVisible) {
                 val edits = withContext(Dispatchers.IO) { editHistorySource.getAll() }
                 val pins = createEditPins(edits)
-                pinsMapComponent.set(pins)
+                withContext(Dispatchers.Main) { pinsMapComponent.set(pins) }
             }
         }
     }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/LocationAwareMapFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/LocationAwareMapFragment.kt
index 3cfdd1e9f39..e00ff8f414e 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/LocationAwareMapFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/LocationAwareMapFragment.kt
@@ -24,8 +24,10 @@ import de.westnordost.streetcomplete.util.location.FineLocationManager
 import de.westnordost.streetcomplete.util.location.LocationAvailabilityReceiver
 import de.westnordost.streetcomplete.util.math.translate
 import de.westnordost.streetcomplete.util.prefs.Preferences
+import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.delay
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import kotlinx.serialization.encodeToString
 import kotlinx.serialization.json.Json
 import org.koin.android.ext.android.inject
@@ -180,7 +182,6 @@ open class LocationAwareMapFragment : MapFragment() {
         tracksMapComponent?.clear()
     }
 
-    @SuppressLint("MissingPermission")
     fun startPositionTrackRecording() {
         isRecordingTracks = true
         _recordedTracks.clear()
@@ -241,16 +242,18 @@ open class LocationAwareMapFragment : MapFragment() {
     }
 
     private fun onLocationChanged(location: Location) {
-        displayedLocation = location
-        recentLocationStore.add(location)
-        locationMapComponent?.location = location
-        addTrackLocation(location)
-//        compass.setLocation(location)
-        centerCurrentPositionIfFollowing()
-        listener?.onDisplayedLocationDidChange()
+        viewLifecycleScope.launch {
+            displayedLocation = location
+            recentLocationStore.add(location)
+            locationMapComponent?.location = location
+            addTrackLocation(location)
+//          compass.setLocation(location)
+            centerCurrentPositionIfFollowing()
+            listener?.onDisplayedLocationDidChange()
+        }
     }
 
-    private fun addTrackLocation(location: Location) {
+    private suspend fun addTrackLocation(location: Location) {
         // ignore if too imprecise
         if (location.accuracy > MIN_TRACK_ACCURACY) return
         val lastLocation = tracks.last().lastOrNull()
@@ -259,20 +262,18 @@ open class LocationAwareMapFragment : MapFragment() {
         if (lastLocation != null && !isRecordingTracks) {
             if ((displayedLocation?.time ?: 0) - lastLocation.time > MAX_TIME_BETWEEN_LOCATIONS) {
                 tracks.add(ArrayList())
-                tracksMapComponent?.startNewTrack(false)
+                withContext(Dispatchers.Main) { tracksMapComponent?.startNewTrack(false) }
             }
         }
         val trackpoint = Trackpoint(location.toLatLon(), location.time, location.accuracy, location.altitude.toFloat())
 
         tracks.last().add(trackpoint)
-        // delay update by 600 ms because the animation to the new location takes that long
         // in rare cases, onLocationChanged may already be called before the view has been created
         // so we need to check that first
         if (view != null) {
-            viewLifecycleScope.launch {
-                delay(600)
-                tracksMapComponent?.addToCurrentTrack(trackpoint.position)
-            }
+            // delay update by 600 ms because the animation to the new location takes that long
+            delay(600)
+            withContext(Dispatchers.Main) { tracksMapComponent?.addToCurrentTrack(trackpoint.position) }
         }
     }
 
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/MainMapFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/MainMapFragment.kt
index b741446817e..66779be0058 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/MainMapFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/MainMapFragment.kt
@@ -5,6 +5,7 @@ import android.graphics.PointF
 import android.graphics.RectF
 import android.graphics.drawable.LayerDrawable
 import androidx.annotation.DrawableRes
+import androidx.annotation.UiThread
 import androidx.core.content.ContextCompat
 import de.westnordost.streetcomplete.data.download.tiles.DownloadedTilesSource
 import com.mapbox.geojson.FeatureCollection
@@ -20,7 +21,6 @@ import com.mapbox.mapboxsdk.style.layers.Property
 import com.mapbox.mapboxsdk.style.layers.PropertyFactory
 import com.mapbox.mapboxsdk.style.layers.SymbolLayer
 import com.mapbox.mapboxsdk.style.layers.TransitionOptions
-import com.mapbox.mapboxsdk.style.sources.GeoJsonOptions
 import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.R
 import de.westnordost.streetcomplete.data.edithistory.EditHistorySource
@@ -147,7 +147,7 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         viewLifecycleOwner.lifecycle.addObserver(styleableOverlayManager!!)
 
         downloadedAreaMapComponent = DownloadedAreaMapComponent(ctrl)
-        downloadedAreaManager = DownloadedAreaManager(ctrl, downloadedAreaMapComponent!!, downloadedTilesSource)
+        downloadedAreaManager = DownloadedAreaManager(downloadedAreaMapComponent!!, downloadedTilesSource)
         viewLifecycleOwner.lifecycle.addObserver(downloadedAreaManager!!)
 
         selectedOverlaySource.addListener(overlayListener)
@@ -286,10 +286,6 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         //   if we use 2 sources, this could be done (but the featureCollection is copied in setGeoJson(featureCollection)...)
         //   images (quest pins) could be used for clusters: https://github.com/mapbox/mapbox-gl-native/issues/16060
 
-        // use a GeoJsonSource for quests, and one layer for pins and one for circles
-        pinsSource = GeoJsonSource("pins-source", GeoJsonOptions().withBuffer(32)) // is the buffer relevant? default value is 128, so this should load less data fromm adjacent tiles
-        style.addSource(pinsSource!!)
-
         // discarded attempt for CustomGeometrySource
 /*
         val options = CustomGeometrySourceOptions()
@@ -390,13 +386,9 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         }
 
         // set map stuff available everywhere in the app (for simplified testing)
-        MainMapFragment.mapView = mapView
         MainMapFragment.mapboxMap = mapboxMap
         MainMapFragment.style = style
 
-        overlaySource = GeoJsonSource("overlay-source")
-        style.addSource(overlaySource!!)
-
         // need more information on how to work with expressions...
         // or better use them in style json instead of here? probably easier
         overlayDashedLineLayer = LineLayer("overlay-dashed-lines", "overlay-source")
@@ -457,10 +449,6 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
             .withFilter(Expression.gte(Expression.zoom(), 16f))
         style.addLayerBelow(overlaySymbolLayer!!, "pins-layer")
 
-        // for nearby element geometry
-        geometrySource = GeoJsonSource("geometry-source")
-        style.addSource(geometrySource!!)
-
         val geometryLineLayer = LineLayer("geo-lines", "geometry-source")
             .withProperties(PropertyFactory.lineWidth(10f))
             .withProperties(PropertyFactory.lineColor("#D140D0"))
@@ -497,10 +485,6 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
             )
         style.addLayerBelow(geometrySymbolLayer, "pins-layer")
 
-        // for focused element geometry
-        focusedGeometrySource = GeoJsonSource("focus-geometry-source")
-        style.addSource(focusedGeometrySource!!)
-
         val focusGeometryLineLayer = LineLayer("focus-geo-lines", "focus-geometry-source")
             .withProperties(PropertyFactory.lineWidth(10f))
             .withProperties(PropertyFactory.lineColor("#D14000"))
@@ -521,16 +505,12 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         style.addLayerBelow(focusGeometryCircleLayer, "pins-layer")
 
         // something is not working here
-        trackSource = GeoJsonSource("track-source")
-        style.addSource(trackSource!!)
         val trackLayer = LineLayer("track", "track-source")
             .withProperties(PropertyFactory.lineWidth(10f))
             .withProperties(PropertyFactory.lineColor("#536dfe"))
             .withProperties(PropertyFactory.lineOpacity(0.3f))
             .withProperties(PropertyFactory.lineCap(Property.LINE_CAP_ROUND))
         style.addLayerBelow(trackLayer, "pins-layer")
-        oldTrackSource = GeoJsonSource("old-track-source")
-        style.addSource(oldTrackSource!!)
         val oldTrackLayer = LineLayer("old-track", "old-track-source")
             .withProperties(PropertyFactory.lineWidth(10f))
             .withProperties(PropertyFactory.lineColor("#536dfe"))
@@ -538,9 +518,6 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
             .withProperties(PropertyFactory.lineCap(Property.LINE_CAP_ROUND))
         style.addLayerBelow(oldTrackLayer, "pins-layer")
 
-        // something is not working here
-        downloadedAreaSource = GeoJsonSource("downloaded-area-source")
-        style.addSource(downloadedAreaSource!!)
         val downloadedAreaLayer = FillLayer("downloaded-area", "downloaded-area-source")
             .withProperties(PropertyFactory.fillColor(Color.RED))
         style.addLayerBelow(downloadedAreaLayer, "pins-layer")
@@ -557,7 +534,6 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         super.onDestroyView()
         selectedOverlaySource.removeListener(overlayListener)
         mapboxMap = null
-        mapView = null
         style = null
     }
 
@@ -683,10 +659,6 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
 //        selectedPinsMapComponent?.clear()
         geometryMapComponent?.clearGeometry()
         geometryMarkersMapComponent?.clear()
-//        val thisIsNoFeature: Feature? = null
-//        geometrySource?.setGeoJson(thisIsNoFeature) // nullable, but crashes maplibre (native) if null. great.
-        geometrySource?.setGeoJson(FeatureCollection.fromFeatures(emptyList()))
-        focusedGeometrySource?.setGeoJson(FeatureCollection.fromFeatures(emptyList()))
         pinsLayer?.setFilter(Expression.gte(Expression.zoom(), 14f))
         pinsDotLayer?.setFilter(Expression.gte(Expression.zoom(), 14f))
     }
@@ -697,7 +669,7 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
 
     /* ----------------------------  Markers for current highlighting --------------------------- */
 
-    override fun putMarkerForCurrentHighlighting(
+    @UiThread override fun putMarkerForCurrentHighlighting(
         geometry: ElementGeometry,
         @DrawableRes drawableResId: Int?,
         title: String?
@@ -705,11 +677,11 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         geometryMarkersMapComponent?.put(geometry, drawableResId, title)
     }
 
-    override fun deleteMarkerForCurrentHighlighting(geometry: ElementGeometry) {
+    @UiThread override fun deleteMarkerForCurrentHighlighting(geometry: ElementGeometry) {
         geometryMarkersMapComponent?.delete(geometry)
     }
 
-    override fun clearMarkersForCurrentHighlighting() {
+    @UiThread override fun clearMarkersForCurrentHighlighting() {
         geometryMarkersMapComponent?.clear()
     }
 
@@ -746,14 +718,9 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         private const val CLICK_AREA_SIZE_IN_DP = 48
 
         // todo: this is bad, but very convenient for testing if we have access to everything from everywhere
-        var mapView: MapView? = null
         var mapboxMap: MapboxMap? = null
-        var overlaySource: GeoJsonSource? = null
 
         var style: Style? = null
-        var pinsSource: GeoJsonSource? = null
-        var geometrySource: GeoJsonSource? = null
-        var focusedGeometrySource: GeoJsonSource? = null
         var pinsLayer: SymbolLayer? = null
         var pinsDotLayer: CircleLayer? = null
 
@@ -761,11 +728,6 @@ class MainMapFragment : LocationAwareMapFragment(), ShowsGeometryMarkers {
         var overlayLineLayer: LineLayer? = null
         var overlayFillLayer: FillExtrusionLayer? = null
         var overlaySymbolLayer: SymbolLayer? = null
-
-        var trackSource: GeoJsonSource? = null
-        var oldTrackSource: GeoJsonSource? = null
-
-        var downloadedAreaSource: GeoJsonSource? = null
     }
 }
 
@@ -811,7 +773,5 @@ fun changeDistanceWithZoom(lineWidthProperty: String): Expression =
         Expression.stop(25, Expression.division(Expression.get(lineWidthProperty), Expression.literal(1 / (BASE*BASE*BASE*BASE*BASE*BASE*BASE*BASE * FACTOR)))) // width / base^-8
     )
 
-fun GeoJsonSource.clear() = setGeoJson(FeatureCollection.fromFeatures(emptyList()))
-
 private const val BASE = 2f // used to be 1.5 with old style json
 private const val FACTOR = 2f // to get width / distance similar to tangram
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/QuestPinsManager.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/QuestPinsManager.kt
index 9a6a129ba42..bcb94edd3c0 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/QuestPinsManager.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/QuestPinsManager.kt
@@ -29,6 +29,8 @@ import kotlinx.coroutines.cancel
 import kotlinx.coroutines.cancelChildren
 import kotlinx.coroutines.isActive
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.sync.Mutex
+import kotlinx.coroutines.sync.withLock
 import kotlinx.coroutines.withContext
 import kotlin.coroutines.coroutineContext
 
@@ -50,6 +52,7 @@ class QuestPinsManager(
     private var lastDisplayedRect: TilesRect? = null
     // quests in current view: key -> [pin, ...]
     private val questsInView: MutableMap<QuestKey, List<Pin>> = mutableMapOf()
+    private val questsInViewMutex = Mutex()
 
     private val viewLifecycleScope: CoroutineScope = CoroutineScope(SupervisorJob())
 
@@ -126,9 +129,13 @@ class QuestPinsManager(
     }
 
     private fun clear() {
-        synchronized(questsInView) { questsInView.clear() }
-        lastDisplayedRect = null
-        viewLifecycleScope.launch { pinsMapComponent.clear() }
+        viewLifecycleScope.launch {
+            questsInViewMutex.withLock {
+                questsInView.clear()
+                lastDisplayedRect = null
+                withContext(Dispatchers.Main) { pinsMapComponent.clear() }
+            }
+        }
     }
 
     fun getQuestKey(properties: Map<String, String>): QuestKey? =
@@ -169,33 +176,26 @@ class QuestPinsManager(
     }
 
     private suspend fun setQuestPins(quests: List<Quest>) {
-        val pins = synchronized(questsInView) {
+        questsInViewMutex.withLock {
             questsInView.clear()
             quests.forEach { questsInView[it.key] = createQuestPins(it) }
-            questsInView.values.flatten()
-        }
-        synchronized(pinsMapComponent) {
             if (coroutineContext.isActive) {
-                pinsMapComponent.set(pins)
+                withContext(Dispatchers.Main) { pinsMapComponent.set(questsInView.values.flatten()) }
             }
         }
     }
 
     private suspend fun updateQuestPins(added: Collection<Quest>, removed: Collection<QuestKey>) {
-        // maplibre: geoJsonSource actually can't update/add/remove single pins,
-        //  but maybe customGeometrySource can invalidate the region so it's requested again
         val displayedBBox = lastDisplayedRect?.asBoundingBox(TILES_ZOOM)
         val addedInView = added.filter { displayedBBox?.contains(it.position) != false }
         var deletedAny = false
-        val pins = synchronized(questsInView) {
+        questsInViewMutex.withLock {
             addedInView.forEach { questsInView[it.key] = createQuestPins(it) }
             removed.forEach { if (questsInView.remove(it) != null) deletedAny = true }
-            questsInView.values.flatten()
-        }
-        if (deletedAny || addedInView.isNotEmpty()) {
-            synchronized(pinsMapComponent) {
+
+            if (deletedAny || addedInView.isNotEmpty()) {
                 if (coroutineContext.isActive) {
-                    pinsMapComponent.set(pins)
+                    withContext(Dispatchers.Main) { pinsMapComponent.set(questsInView.values.flatten()) }
                 }
             }
         }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/ShowsGeometryMarkers.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/ShowsGeometryMarkers.kt
index 1b583f1eacf..8cbba25e5e7 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/ShowsGeometryMarkers.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/ShowsGeometryMarkers.kt
@@ -1,15 +1,16 @@
 package de.westnordost.streetcomplete.screens.main.map
 
 import androidx.annotation.DrawableRes
+import androidx.annotation.UiThread
 import de.westnordost.streetcomplete.data.osm.geometry.ElementGeometry
 
 interface ShowsGeometryMarkers {
-    fun putMarkerForCurrentHighlighting(
+    @UiThread fun putMarkerForCurrentHighlighting(
         geometry: ElementGeometry,
         @DrawableRes drawableResId: Int?,
         title: String?
     )
-    fun deleteMarkerForCurrentHighlighting(geometry: ElementGeometry)
+    @UiThread fun deleteMarkerForCurrentHighlighting(geometry: ElementGeometry)
 
-    fun clearMarkersForCurrentHighlighting()
+    @UiThread fun clearMarkersForCurrentHighlighting()
 }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableOverlayManager.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableOverlayManager.kt
index b1759a24366..0069e18fd55 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableOverlayManager.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableOverlayManager.kt
@@ -25,6 +25,8 @@ import kotlinx.coroutines.cancel
 import kotlinx.coroutines.cancelChildren
 import kotlinx.coroutines.isActive
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.sync.Mutex
+import kotlinx.coroutines.sync.withLock
 import kotlinx.coroutines.withContext
 import kotlin.coroutines.coroutineContext
 
@@ -42,6 +44,7 @@ class StyleableOverlayManager(
     private var lastDisplayedRect: TilesRect? = null
     // map data in current view: key -> [pin, ...]
     private val mapDataInView: MutableMap<ElementKey, StyledElement> = mutableMapOf()
+    private val mapDataInViewMutex = Mutex()
 
     private val viewLifecycleScope: CoroutineScope = CoroutineScope(SupervisorJob())
 
@@ -152,20 +155,24 @@ class StyleableOverlayManager(
     }
 
     private fun clear() {
-        synchronized(mapDataInView) { mapDataInView.clear() }
-        lastDisplayedRect = null
-        viewLifecycleScope.launch { mapComponent.clear() }
+        viewLifecycleScope.launch {
+            mapDataInViewMutex.withLock {
+                mapDataInView.clear()
+                lastDisplayedRect = null
+                withContext(Dispatchers.Main) { mapComponent.clear() }
+            }
+        }
     }
 
     private suspend fun setStyledElements(mapData: MapDataWithGeometry) {
-        val layer = overlay ?: return
-        synchronized(mapDataInView) {
+        val overlay = overlay ?: return
+        mapDataInViewMutex.withLock {
             mapDataInView.clear()
-            createStyledElementsByKey(layer, mapData).forEach { (key, styledElement) ->
+            createStyledElementsByKey(overlay, mapData).forEach { (key, styledElement) ->
                 mapDataInView[key] = styledElement
             }
             if (coroutineContext.isActive) {
-                mapComponent.set(mapDataInView.values)
+                withContext(Dispatchers.Main) { mapComponent.set(mapDataInView.values) }
             }
         }
     }
@@ -174,7 +181,7 @@ class StyleableOverlayManager(
         val overlay = overlay ?: return
         val displayedBBox = lastDisplayedRect?.asBoundingBox(TILES_ZOOM)
         var changedAnything = false
-        synchronized(mapDataInView) {
+        mapDataInViewMutex.withLock {
             deleted.forEach {
                 if (mapDataInView.remove(it) != null) {
                     changedAnything = true
@@ -196,8 +203,7 @@ class StyleableOverlayManager(
             }
 
             if (changedAnything && coroutineContext.isActive) {
-                mapComponent.set(mapDataInView.values)
-//                ctrl.requestRender()
+                withContext(Dispatchers.Main) { mapComponent.set(mapDataInView.values) }
             }
         }
     }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/CurrentLocationMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/CurrentLocationMapComponent.kt
index d41ad21e926..086d254a1fa 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/CurrentLocationMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/CurrentLocationMapComponent.kt
@@ -23,7 +23,7 @@ import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.R
 import de.westnordost.streetcomplete.screens.MainActivity
 import de.westnordost.streetcomplete.screens.main.map.MainMapFragment
-import de.westnordost.streetcomplete.screens.main.map.clear
+import de.westnordost.streetcomplete.screens.main.map.maplibre.clear
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toPoint
 import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
 import de.westnordost.streetcomplete.util.ktx.getBitmapDrawable
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/DownloadedAreaMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/DownloadedAreaMapComponent.kt
index ca8df9fdc29..0d5cbbdfa85 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/DownloadedAreaMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/DownloadedAreaMapComponent.kt
@@ -1,18 +1,24 @@
 package de.westnordost.streetcomplete.screens.main.map.components
 
+import androidx.annotation.UiThread
 import com.mapbox.geojson.Polygon
+import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.ApplicationConstants
 import de.westnordost.streetcomplete.data.download.tiles.TilePos
 import de.westnordost.streetcomplete.data.osm.mapdata.LatLon
 import de.westnordost.streetcomplete.data.osm.mapdata.toPolygon
-import de.westnordost.streetcomplete.screens.MainActivity
-import de.westnordost.streetcomplete.screens.main.map.MainMapFragment
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toPoint
 import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
 
 class DownloadedAreaMapComponent(private val ctrl: KtMapController) {
 
-    fun set(tiles: Collection<TilePos>) = synchronized(this) {
+    private val downloadedAreaSource = GeoJsonSource("downloaded-area-source")
+
+    init {
+        ctrl.addSource(downloadedAreaSource)
+    }
+
+    @UiThread fun set(tiles: Collection<TilePos>) {
         val zoom = ApplicationConstants.DOWNLOAD_TILE_ZOOM
         val world = listOf(
             LatLon(+90.0, -180.0),
@@ -25,6 +31,6 @@ class DownloadedAreaMapComponent(private val ctrl: KtMapController) {
         val polygons = listOf(world) + holes
 
         val feature = Polygon.fromLngLats(polygons.map { polygon -> polygon.map { it.toPoint() } })
-        MainActivity.activity?.runOnUiThread { MainMapFragment.downloadedAreaSource?.setGeoJson(feature) }
+        downloadedAreaSource.setGeoJson(feature)
     }
 }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/FocusGeometryMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/FocusGeometryMapComponent.kt
index 40d87f5c019..e304ccf09c6 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/FocusGeometryMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/FocusGeometryMapComponent.kt
@@ -1,12 +1,12 @@
 package de.westnordost.streetcomplete.screens.main.map.components
 
 import android.graphics.RectF
-import com.mapbox.geojson.FeatureCollection
-import com.mapbox.mapboxsdk.maps.MapboxMap
+import androidx.annotation.UiThread
+import com.mapbox.geojson.Geometry
+import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.data.osm.geometry.ElementGeometry
-import de.westnordost.streetcomplete.screens.main.map.MainMapFragment
+import de.westnordost.streetcomplete.screens.main.map.maplibre.clear
 import de.westnordost.streetcomplete.screens.main.map.maplibre.CameraPosition
-import de.westnordost.streetcomplete.screens.main.map.maplibre.toLatLon
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toMapLibreGeometry
 import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
 import kotlin.math.abs
@@ -19,24 +19,29 @@ import kotlin.math.roundToInt
  *  contained in the screen area */
 class FocusGeometryMapComponent(private val ctrl: KtMapController) {
 
+    private val focusedGeometrySource = GeoJsonSource("focus-geometry-source")
+
     private var previousCameraPosition: CameraPosition? = null
 
     /** Returns whether beginFocusGeometry() was called earlier but not endFocusGeometry() yet */
     val isZoomedToContainGeometry: Boolean get() =
         previousCameraPosition != null
 
+    init {
+        ctrl.addSource(focusedGeometrySource)
+    }
+
     /** Show the given geometry. Previously shown geometry is replaced. */
-    fun showGeometry(geometry: ElementGeometry) {
-        MainMapFragment.focusedGeometrySource?.setGeoJson(geometry.toMapLibreGeometry())
+    @UiThread fun showGeometry(geometry: ElementGeometry) {
+        focusedGeometrySource.setGeoJson(geometry.toMapLibreGeometry())
     }
 
     /** Hide all shown geometry */
-    fun clearGeometry() {
-        val fc: FeatureCollection? = null
-        MainMapFragment.focusedGeometrySource?.setGeoJson(fc)
+    @UiThread fun clearGeometry() {
+        focusedGeometrySource.clear()
     }
 
-    @Synchronized fun beginFocusGeometry(g: ElementGeometry, offset: RectF) {
+    @UiThread fun beginFocusGeometry(g: ElementGeometry, offset: RectF) {
         val targetPos = ctrl.getEnclosingCameraPosition(g, offset) ?: return
 
         val currentPos = ctrl.cameraPosition
@@ -56,11 +61,11 @@ class FocusGeometryMapComponent(private val ctrl: KtMapController) {
         if (previousCameraPosition == null) previousCameraPosition = currentPos
     }
 
-    @Synchronized fun clearFocusGeometry() {
+    @UiThread fun clearFocusGeometry() {
         previousCameraPosition = null
     }
 
-    @Synchronized fun endFocusGeometry() {
+    @UiThread fun endFocusGeometry() {
         val pos = previousCameraPosition
         if (pos != null) {
             val currentPos = ctrl.cameraPosition
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/GeometryMarkersMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/GeometryMarkersMapComponent.kt
index f58685c5013..26ec26df975 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/GeometryMarkersMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/GeometryMarkersMapComponent.kt
@@ -2,18 +2,17 @@ package de.westnordost.streetcomplete.screens.main.map.components
 
 import android.content.res.Resources
 import androidx.annotation.DrawableRes
+import androidx.annotation.UiThread
 import com.google.gson.JsonObject
 import com.mapbox.geojson.Feature
 import com.mapbox.geojson.FeatureCollection
-import com.mapbox.geojson.Point
-import com.mapbox.geojson.Polygon
+import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.data.osm.geometry.ElementGeometry
 import de.westnordost.streetcomplete.data.osm.geometry.ElementPointGeometry
 import de.westnordost.streetcomplete.data.osm.geometry.ElementPolygonsGeometry
 import de.westnordost.streetcomplete.data.osm.geometry.ElementPolylinesGeometry
 import de.westnordost.streetcomplete.data.osm.mapdata.LatLon
-import de.westnordost.streetcomplete.screens.MainActivity
-import de.westnordost.streetcomplete.screens.main.map.MainMapFragment
+import de.westnordost.streetcomplete.screens.main.map.maplibre.clear
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toMapLibreGeometry
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toPoint
 import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
@@ -23,9 +22,15 @@ import de.westnordost.streetcomplete.util.math.centerPointOfPolyline
  *  show the geometry of elements surrounding the selected quest */
 class GeometryMarkersMapComponent(private val resources: Resources, private val ctrl: KtMapController) {
 
+    private val geometrySource = GeoJsonSource("geometry-source")
+
     private val featuresByPosition: MutableMap<LatLon, List<Feature>> = HashMap()
 
-    @Synchronized fun put(
+    init {
+        ctrl.addSource(geometrySource)
+    }
+
+    @UiThread fun put(
         geometry: ElementGeometry,
         @DrawableRes drawableResId: Int? = null,
         title: String? = null
@@ -88,18 +93,18 @@ class GeometryMarkersMapComponent(private val resources: Resources, private val
         featuresByPosition[center] = features
         // todo: this is resetting the whole source for every single marker, adding single markers is not possible
         //  annotation managers work the same way (internally)
-        MainActivity.activity?.runOnUiThread { MainMapFragment.geometrySource?.setGeoJson(FeatureCollection.fromFeatures(featuresByPosition.values.flatten())) }
+
+        geometrySource.setGeoJson(FeatureCollection.fromFeatures(featuresByPosition.values.flatten()))
     }
 
-    @Synchronized fun delete(geometry: ElementGeometry) {
+    @UiThread fun delete(geometry: ElementGeometry) {
         val pos = geometry.center
         featuresByPosition.remove(pos)
-        MainActivity.activity?.runOnUiThread { MainMapFragment.geometrySource?.setGeoJson(FeatureCollection.fromFeatures(featuresByPosition.values.flatten())) }
+        geometrySource.setGeoJson(FeatureCollection.fromFeatures(featuresByPosition.values.flatten()))
     }
 
-    @Synchronized fun clear() {
-        val fc: FeatureCollection? = null
-        MainActivity.activity?.runOnUiThread { MainMapFragment.geometrySource?.setGeoJson(fc) }
+    @UiThread fun clear() {
+        geometrySource.clear()
         featuresByPosition.clear()
     }
 
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/PinsMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/PinsMapComponent.kt
index d595a72dcdb..80c681d46cf 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/PinsMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/PinsMapComponent.kt
@@ -1,33 +1,43 @@
 package de.westnordost.streetcomplete.screens.main.map.components
 
+import androidx.annotation.UiThread
 import com.google.gson.JsonObject
 import com.mapbox.geojson.Feature
 import com.mapbox.geojson.FeatureCollection
-import com.mapbox.mapboxsdk.style.expressions.Expression
+import com.mapbox.mapboxsdk.style.sources.GeoJsonOptions
+import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.data.osm.mapdata.LatLon
-import de.westnordost.streetcomplete.screens.MainActivity
-import de.westnordost.streetcomplete.screens.main.map.MainMapFragment
+import de.westnordost.streetcomplete.screens.main.map.maplibre.clear
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toPoint
 import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
 
 /** Takes care of displaying pins on the map, e.g. quest pins or pins for recent edits */
 class PinsMapComponent(private val ctrl: KtMapController) {
 
+    private val pinsSource = GeoJsonSource(
+        "pins-source",
+        GeoJsonOptions().withBuffer(32)  // is the buffer relevant? default value is 128, so this should load less data fromm adjacent tiles
+    )
+
     /** Shows/hides the pins */
     var isVisible: Boolean
         // add / remove source
-        get() = MainMapFragment.mapboxMap?.style?.sources?.any { it.id == "pins-source" } == true
-        set(value) {
+        @UiThread get() = ctrl.sources?.find { it.id == "pins-source" } != null
+        @UiThread set(value) {
             if (isVisible == value) return
             if (value) {
-                MainActivity.activity?.runOnUiThread { MainMapFragment.mapboxMap?.style?.addSource(MainMapFragment.pinsSource!!) }
+                ctrl.addSource(pinsSource)
             } else {
-                MainActivity.activity?.runOnUiThread { MainMapFragment.mapboxMap?.style?.removeSource(MainMapFragment.pinsSource!!) }
+                ctrl.removeSource(pinsSource)
             }
         }
 
+    init {
+        ctrl.addSource(pinsSource)
+    }
+
     /** Show given pins. Previously shown pins are replaced with these.  */
-    fun set(pins: Collection<Pin>) {
+    @UiThread fun set(pins: Collection<Pin>) {
         // do sorting here, because we can set the symbolZOrder to SYMBOL_Z_ORDER_SOURCE, which
         // is the order in which the source has the features
         val mapLibreFeatures = pins.sortedBy { -it.importance }.map { pin ->
@@ -37,19 +47,12 @@ class PinsMapComponent(private val ctrl: KtMapController) {
             pin.properties.forEach { p.addProperty(it.first, it.second) }
             Feature.fromGeometry(pin.position.toPoint(), p)
         }
-        // todo: for testing the runOnUiThread is ok, but actually it should be handled differently...
-        MainActivity.activity?.runOnUiThread { MainMapFragment.pinsSource?.setGeoJson(FeatureCollection.fromFeatures(mapLibreFeatures)) }
+        pinsSource.setGeoJson(FeatureCollection.fromFeatures(mapLibreFeatures))
     }
 
     /** Clear pins */
-    fun clear() {
-        val fc: FeatureCollection? = null // does it work?
-        MainActivity.activity?.runOnUiThread { MainMapFragment.pinsSource?.setGeoJson(fc) }
-    }
-
-    companion object {
-        // see streetcomplete.yaml for the definitions of the below layers
-        private const val PINS_LAYER = "streetcomplete_pins"
+    @UiThread fun clear() {
+        pinsSource.clear()
     }
 }
 
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/SelectedPinsMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/SelectedPinsMapComponent.kt
index 2d9f9c04491..c8b0ab24795 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/SelectedPinsMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/SelectedPinsMapComponent.kt
@@ -14,7 +14,7 @@ class SelectedPinsMapComponent(private val ctx: Context, private val ctrl: KtMap
     /** Show selected pins with the given icon at the given positions. "Selected pins" are not
      *  related to pins, they are just visuals that are displayed on top of the normal pins and look
      *  highlighted/selected. */
-    fun set(@DrawableRes iconResId: Int, pinPositions: Collection<LatLon>) {
+    @UiThread fun set(@DrawableRes iconResId: Int, pinPositions: Collection<LatLon>) {
         val points = pinPositions.map { position ->
             Point(position.toLngLat(), mapOf(
                 "type" to "point",
@@ -25,7 +25,7 @@ class SelectedPinsMapComponent(private val ctx: Context, private val ctrl: KtMap
     }
 
     /** Clear the display of any selected pins */
-    fun clear() {
+    @UiThread fun clear() {
         selectedPinsLayer.clear()
     }
 
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/StyleableOverlayMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/StyleableOverlayMapComponent.kt
index ae1698a7542..bc8138364a2 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/StyleableOverlayMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/StyleableOverlayMapComponent.kt
@@ -2,19 +2,13 @@ package de.westnordost.streetcomplete.screens.main.map.components
 
 import android.content.res.Resources
 import android.graphics.Color
+import androidx.annotation.UiThread
 import com.google.gson.JsonElement
 import com.google.gson.JsonObject
 import com.mapbox.geojson.Feature
 import com.mapbox.geojson.FeatureCollection
-import com.mapbox.geojson.MultiLineString
-import com.mapbox.geojson.Point
-import com.mapbox.geojson.Polygon
-import com.mapbox.mapboxsdk.style.expressions.Expression
-import de.westnordost.streetcomplete.R
+import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.data.osm.geometry.ElementGeometry
-import de.westnordost.streetcomplete.data.osm.geometry.ElementPointGeometry
-import de.westnordost.streetcomplete.data.osm.geometry.ElementPolygonsGeometry
-import de.westnordost.streetcomplete.data.osm.geometry.ElementPolylinesGeometry
 import de.westnordost.streetcomplete.data.osm.mapdata.Element
 import de.westnordost.streetcomplete.data.osm.mapdata.ElementKey
 import de.westnordost.streetcomplete.data.osm.mapdata.ElementType
@@ -23,8 +17,7 @@ import de.westnordost.streetcomplete.overlays.PointStyle
 import de.westnordost.streetcomplete.overlays.PolygonStyle
 import de.westnordost.streetcomplete.overlays.PolylineStyle
 import de.westnordost.streetcomplete.overlays.Style
-import de.westnordost.streetcomplete.screens.MainActivity
-import de.westnordost.streetcomplete.screens.main.map.MainMapFragment
+import de.westnordost.streetcomplete.screens.main.map.maplibre.clear
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toMapLibreGeometry
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toPoint
 import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
@@ -33,8 +26,9 @@ import de.westnordost.streetcomplete.util.ktx.darken
 import de.westnordost.streetcomplete.util.ktx.toARGBString
 
 /** Takes care of displaying styled map data */
-class StyleableOverlayMapComponent(private val resources: Resources, ctrl: KtMapController) {
-//    private val layer: MapData = ctrl.addDataLayer(MAP_DATA_LAYER)
+class StyleableOverlayMapComponent(private val resources: Resources, private val ctrl: KtMapController) {
+
+    private val overlaySource = GeoJsonSource("overlay-source")
 
     private val darkenedColors = HashMap<String, String>()
     private val transparentColors = HashMap<String, String>()
@@ -42,18 +36,22 @@ class StyleableOverlayMapComponent(private val resources: Resources, ctrl: KtMap
     /** Shows/hides the map data */
     var isVisible: Boolean
         // add / remove source
-        get() = MainMapFragment.mapboxMap?.style?.sources?.any { it.id == "overlay-source" } == true
-        set(value) {
+        @UiThread get() = ctrl.sources?.find { it.id == "overlay-source" } != null
+        @UiThread set(value) {
             if (isVisible == value) return
             if (value) {
-                MainActivity.activity?.runOnUiThread { MainMapFragment.mapboxMap?.style?.addSource(MainMapFragment.overlaySource!!) }
+                ctrl.addSource(overlaySource)
             } else {
-                MainActivity.activity?.runOnUiThread { MainMapFragment.mapboxMap?.style?.removeSource(MainMapFragment.overlaySource!!) }
+                ctrl.removeSource(overlaySource)
             }
         }
 
+    init {
+        ctrl.addSource(overlaySource)
+    }
+
     /** Show given map data with each the given style */
-    fun set(features: Collection<StyledElement>) {
+    @UiThread fun set(features: Collection<StyledElement>) {
         // todo: color.invisible should reproduce original style?
         //  then do after actual style is decided
         val mapLibreFeatures = features.flatMap { (element, geometry, style) ->
@@ -130,7 +128,7 @@ class StyleableOverlayMapComponent(private val resources: Resources, ctrl: KtMap
                 }
             }
         }
-        MainActivity.activity?.runOnUiThread { MainMapFragment.overlaySource?.setGeoJson(FeatureCollection.fromFeatures(mapLibreFeatures)) }
+        overlaySource.setGeoJson(FeatureCollection.fromFeatures(mapLibreFeatures))
     }
 
     /** mimics width of line as seen in StreetComplete map style (or otherwise 3m) */
@@ -163,11 +161,8 @@ class StyleableOverlayMapComponent(private val resources: Resources, ctrl: KtMap
         transparentColors.getOrPut(color) { toARGBString(addTransparency(Color.parseColor(color), 0.6f)) }
 
     /** Clear map data */
-    fun clear() {
-        MainActivity.activity?.runOnUiThread {
-            val fc: FeatureCollection? = null
-            MainMapFragment.overlaySource!!.setGeoJson(fc)
-        }
+    @UiThread fun clear() {
+        overlaySource.clear()
     }
 
     fun getElementKey(properties: Map<String, String>): ElementKey? {
@@ -175,10 +170,6 @@ class StyleableOverlayMapComponent(private val resources: Resources, ctrl: KtMap
         val id = properties[ELEMENT_ID]?.toLong() ?: return null
         return ElementKey(type, id)
     }
-
-    companion object {
-        private const val MAP_DATA_LAYER = "streetcomplete_map_data"
-    }
 }
 
 private const val ELEMENT_TYPE = "element_type"
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/TracksMapComponent.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/TracksMapComponent.kt
index 1518aad0cad..1623cafcfa4 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/TracksMapComponent.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/components/TracksMapComponent.kt
@@ -1,34 +1,42 @@
 package de.westnordost.streetcomplete.screens.main.map.components
 
+import androidx.annotation.UiThread
 import com.google.gson.JsonObject
 import com.mapbox.geojson.Feature
 import com.mapbox.geojson.FeatureCollection
 import com.mapbox.geojson.LineString
 import com.mapbox.geojson.Point
 import com.mapbox.mapboxsdk.geometry.LatLng
+import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.data.maptiles.toLatLng
 import de.westnordost.streetcomplete.data.osm.mapdata.LatLon
-import de.westnordost.streetcomplete.screens.main.map.MainMapFragment
-import de.westnordost.streetcomplete.screens.main.map.clear
+import de.westnordost.streetcomplete.screens.main.map.maplibre.clear
 import de.westnordost.streetcomplete.screens.main.map.tangram.KtMapController
 import kotlin.math.max
 
 /** Takes care of showing the path(s) walked on the map */
-class TracksMapComponent(ctrl: KtMapController) {
-    /* There are two layers simply as a performance optimization: If there are thousands of
+class TracksMapComponent(private val ctrl: KtMapController) {
+    /* There are two sources simply as a performance optimization: If there are thousands of
        trackpoints, we don't want to update (=copy) the thousands of points each time a new
        trackpoint is added. Instead, we only update a list of 100 trackpoints each time a new
        trackpoint is added and every 100th time, we update the other layer.
 
        So, the list of points updated ~per second doesn't grow too long.
      */
+    private val trackSource = GeoJsonSource("track-source")
+    private val oldTrackSource = GeoJsonSource("old-track-source")
 
     private var index = 0
     private data class Track(val trackpoints: MutableList<LatLng>, val isRecording: Boolean)
     private var tracks: MutableList<Track> = arrayListOf(Track(ArrayList(), false))
 
+    init {
+        ctrl.addSource(trackSource)
+        ctrl.addSource(oldTrackSource)
+    }
+
     /** Add a point to the current track */
-    fun addToCurrentTrack(pos: LatLon) {
+    @UiThread fun addToCurrentTrack(pos: LatLon) {
         val track = tracks.last()
         track.trackpoints.add(pos.toLatLng())
         val trackpoints = track.trackpoints
@@ -37,18 +45,18 @@ class TracksMapComponent(ctrl: KtMapController) {
         if (trackpoints.size - index > 100) {
             putAllTracksInOldLayer()
         } else {
-            MainMapFragment.trackSource?.setGeoJson(trackpoints.toLineFeature(track.isRecording))
+            trackSource.setGeoJson(trackpoints.toLineFeature(track.isRecording))
         }
     }
 
     /** Start a new track. I.e. the points in that track will be drawn as an own polyline */
-    fun startNewTrack(record: Boolean) {
+    @UiThread fun startNewTrack(record: Boolean) {
         tracks.add(Track(ArrayList(), record))
         putAllTracksInOldLayer()
     }
 
     /** Set all the tracks (when re-initializing), if recording the last track is the only recording */
-    fun setTracks(pointsList: List<List<LatLon>>, isRecording: Boolean) {
+    @UiThread fun setTracks(pointsList: List<List<LatLon>>, isRecording: Boolean) {
         require(pointsList.isNotEmpty())
         tracks = pointsList.mapIndexed { index, track ->
             var recording = false
@@ -62,12 +70,12 @@ class TracksMapComponent(ctrl: KtMapController) {
 
     private fun putAllTracksInOldLayer() {
         index = max(0, tracks.last().trackpoints.lastIndex)
-        MainMapFragment.trackSource?.clear()
+        trackSource.clear()
         val features = tracks.map { it.trackpoints.toLineFeature(it.isRecording) }
-        MainMapFragment.oldTrackSource?.setGeoJson(FeatureCollection.fromFeatures(features))
+        oldTrackSource.setGeoJson(FeatureCollection.fromFeatures(features))
     }
 
-    fun clear() {
+    @UiThread fun clear() {
         tracks = ArrayList()
         startNewTrack(false)
     }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/maplibre/MapLibreExtensions.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/maplibre/MapLibreExtensions.kt
index ddab0fa3623..d4e9f06138b 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/maplibre/MapLibreExtensions.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/maplibre/MapLibreExtensions.kt
@@ -1,5 +1,6 @@
 package de.westnordost.streetcomplete.screens.main.map.maplibre
 
+import com.mapbox.geojson.FeatureCollection
 import com.mapbox.geojson.Geometry
 import com.mapbox.geojson.LineString
 import com.mapbox.geojson.MultiLineString
@@ -7,6 +8,7 @@ import com.mapbox.geojson.MultiPolygon
 import com.mapbox.geojson.Point
 import com.mapbox.geojson.Polygon
 import com.mapbox.mapboxsdk.geometry.LatLng
+import com.mapbox.mapboxsdk.style.sources.GeoJsonSource
 import de.westnordost.streetcomplete.data.osm.geometry.ElementGeometry
 import de.westnordost.streetcomplete.data.osm.geometry.ElementPointGeometry
 import de.westnordost.streetcomplete.data.osm.geometry.ElementPolygonsGeometry
@@ -73,3 +75,5 @@ fun ElementPolygonsGeometry.toMapLibreGeometry(): Geometry {
 }
 
 fun LatLon.toPoint(): Point = Point.fromLngLat(longitude, latitude)
+
+fun GeoJsonSource.clear() = setGeoJson(FeatureCollection.fromFeatures(emptyList()))
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/tangram/KtMapController.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/tangram/KtMapController.kt
index 1493dce754d..49a36238dc4 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/tangram/KtMapController.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/tangram/KtMapController.kt
@@ -6,13 +6,11 @@ import android.graphics.RectF
 import android.provider.Settings
 import androidx.lifecycle.DefaultLifecycleObserver
 import androidx.lifecycle.LifecycleOwner
-import com.mapbox.mapboxsdk.geometry.LatLng
 import com.mapbox.mapboxsdk.maps.MapView
 import com.mapbox.mapboxsdk.maps.MapboxMap
+import com.mapbox.mapboxsdk.style.sources.Source
 import de.westnordost.streetcomplete.data.maptiles.toLatLng
 import de.westnordost.streetcomplete.data.osm.geometry.ElementGeometry
-import de.westnordost.streetcomplete.data.osm.geometry.ElementPolygonsGeometry
-import de.westnordost.streetcomplete.data.osm.geometry.ElementPolylinesGeometry
 import de.westnordost.streetcomplete.data.osm.mapdata.BoundingBox
 import de.westnordost.streetcomplete.data.osm.mapdata.LatLon
 import de.westnordost.streetcomplete.screens.main.map.maplibre.CameraPosition
@@ -20,14 +18,11 @@ import de.westnordost.streetcomplete.screens.main.map.maplibre.CameraUpdate
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toCameraPosition
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toLatLon
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toMapLibreCameraPosition
-import de.westnordost.streetcomplete.screens.main.map.maplibre.toMapLibreCameraPosition
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toMapLibreCameraUpdate
 import de.westnordost.streetcomplete.screens.main.map.maplibre.toMapLibreGeometry
-import de.westnordost.streetcomplete.util.math.centerPointOfPolyline
 import de.westnordost.streetcomplete.util.math.distanceTo
 import de.westnordost.streetcomplete.util.math.enclosingBoundingBox
 import de.westnordost.streetcomplete.util.math.initialBearingTo
-import de.westnordost.streetcomplete.util.math.normalizeLongitude
 import de.westnordost.streetcomplete.util.math.translate
 import kotlinx.coroutines.CoroutineScope
 import kotlinx.coroutines.Dispatchers
@@ -35,9 +30,6 @@ import kotlinx.coroutines.SupervisorJob
 import kotlinx.coroutines.cancel
 import kotlinx.coroutines.suspendCancellableCoroutine
 import kotlin.coroutines.resume
-import kotlin.math.log10
-import kotlin.math.max
-import kotlin.math.min
 import kotlin.math.pow
 
 /** Wrapper around the Tangram MapController. Features over the Tangram MapController (0.12.0):
@@ -199,6 +191,16 @@ class KtMapController(
 
     /* -------------------------------------- Data Layers --------------------------------------- */
 
+    fun addSource(source: Source) {
+        mapboxMap.style?.addSource(source)
+    }
+
+    fun removeSource(source: Source) {
+        mapboxMap.style?.removeSource(source)
+    }
+
+    val sources: List<Source>? get() = mapboxMap.style?.sources
+
 //    fun addDataLayer(name: String, generateCentroid: Boolean = false): MapData =
 //        c.addDataLayer(name, generateCentroid)
 
@@ -240,6 +242,7 @@ class KtMapController(
             override fun onShove(distance: Float): Boolean {
                 if (cameraPosition.tilt >= maximumTilt && distance < 0) return true
                 return responder?.onShove(distance) ?: false
+
             }
         })
     }
