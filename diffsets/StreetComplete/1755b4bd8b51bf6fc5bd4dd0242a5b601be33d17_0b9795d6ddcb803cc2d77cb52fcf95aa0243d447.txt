diff --git a/app/src/main/java/de/westnordost/streetcomplete/layers/Layer.kt b/app/src/main/java/de/westnordost/streetcomplete/layers/Layer.kt
index 7213bab5aba..a92dda36db2 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/layers/Layer.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/layers/Layer.kt
@@ -1,13 +1,10 @@
 package de.westnordost.streetcomplete.layers
 
 import de.westnordost.streetcomplete.data.osm.mapdata.Element
+import de.westnordost.streetcomplete.data.osm.mapdata.MapDataWithGeometry
 
 interface Layer {
-    /** returns whether the given [element] should be displayed in this layer */
-    fun isDisplayed(element: Element): Boolean
-
-    /** returns how to display the given element. Assumes it has been checked first if the element
-     *  may be displayed at all. */
-    fun getStyle(element: Element): Style
+    /** return pairs of element to style for all elements in the map data that should be displayed */
+    fun getStyledElements(mapData: MapDataWithGeometry): Sequence<Pair<Element, Style>>
 }
 
diff --git a/app/src/main/java/de/westnordost/streetcomplete/layers/sidewalk/SidewalkLayer.kt b/app/src/main/java/de/westnordost/streetcomplete/layers/sidewalk/SidewalkLayer.kt
index effd6c3bdbd..71b30d59708 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/layers/sidewalk/SidewalkLayer.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/layers/sidewalk/SidewalkLayer.kt
@@ -1,7 +1,8 @@
 package de.westnordost.streetcomplete.layers.sidewalk
 
-import de.westnordost.streetcomplete.data.elementfilter.toElementFilterExpression
 import de.westnordost.streetcomplete.data.osm.mapdata.Element
+import de.westnordost.streetcomplete.data.osm.mapdata.MapDataWithGeometry
+import de.westnordost.streetcomplete.data.osm.mapdata.filter
 import de.westnordost.streetcomplete.layers.Color
 import de.westnordost.streetcomplete.layers.Layer
 import de.westnordost.streetcomplete.layers.PolylineStyle
@@ -10,13 +11,20 @@ import de.westnordost.streetcomplete.osm.sidewalk.createSidewalkSides
 
 class SidewalkLayer : Layer {
 
-    private val filter by lazy {
-        "ways with highway ~ trunk|trunk_link|primary|primary_link|secondary|secondary_link|tertiary|tertiary_link|unclassified|residential|living_street|pedestrian".toElementFilterExpression()
-    }
-
-    override fun isDisplayed(element: Element) = filter.matches(element)
-
-    override fun getStyle(element: Element): PolylineStyle {
+    override fun getStyledElements(mapData: MapDataWithGeometry) =
+        mapData.filter("""
+            ways with
+            highway ~ trunk|trunk_link|primary|primary_link|secondary|secondary_link|tertiary|tertiary_link|unclassified|residential|living_street|pedestrian
+            and area != yes
+        """).map { it to getSidewalkStyle(it) } +
+        mapData.filter("""
+            ways with (
+              highway ~ footway|steps
+              or highway ~ path|bridleway|cycleway and foot ~ yes|designated
+            ) and area != yes
+        """).map { it to PolylineStyle("#33cc00") }
+
+    private fun getSidewalkStyle(element: Element): PolylineStyle {
         val sidewalkSides = createSidewalkSides(element.tags)
         if (sidewalkSides == null && sidewalkTaggingNotExpected(element.tags)) {
             return PolylineStyle(null)
@@ -36,6 +44,6 @@ private fun sidewalkTaggingNotExpected(tags: Map<String, String>): Boolean =
 private val Sidewalk?.color get() = when (this) {
     Sidewalk.YES           -> "#33cc00" // same color as the arrow in the illustrations
     Sidewalk.NO            -> "#555555"
-    Sidewalk.SEPARATE      -> "#00aaff" // TODO LAYERS for some reason with transparency will not render. This is an issue because separately mapped sidewalk may be behind it
+    Sidewalk.SEPARATE      -> Color.INVISIBLE
     Sidewalk.INVALID, null -> Color.UNSPECIFIED
 }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/layers/way_lit/WayLitLayer.kt b/app/src/main/java/de/westnordost/streetcomplete/layers/way_lit/WayLitLayer.kt
index b1facc81005..ad8fc71fc2b 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/layers/way_lit/WayLitLayer.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/layers/way_lit/WayLitLayer.kt
@@ -1,7 +1,7 @@
 package de.westnordost.streetcomplete.layers.way_lit
 
-import de.westnordost.streetcomplete.data.elementfilter.toElementFilterExpression
-import de.westnordost.streetcomplete.data.osm.mapdata.Element
+import de.westnordost.streetcomplete.data.osm.mapdata.MapDataWithGeometry
+import de.westnordost.streetcomplete.data.osm.mapdata.filter
 import de.westnordost.streetcomplete.layers.Color
 import de.westnordost.streetcomplete.layers.Layer
 import de.westnordost.streetcomplete.layers.PolylineStyle
@@ -10,14 +10,10 @@ import de.westnordost.streetcomplete.osm.ALL_ROADS
 
 class WayLitLayer : Layer {
 
-    private val filter by lazy {
-        "ways with highway ~ ${(ALL_ROADS + ALL_PATHS).joinToString("|")}".toElementFilterExpression()
-    }
-
-    override fun isDisplayed(element: Element) = filter.matches(element)
-
-    override fun getStyle(element: Element) =
-        PolylineStyle(createLitStatus(element).color)
+    override fun getStyledElements(mapData: MapDataWithGeometry) =
+        mapData
+            .filter("ways with highway ~ ${(ALL_ROADS + ALL_PATHS).joinToString("|")}")
+            .map { it to PolylineStyle(createLitStatus(it).color) }
 }
 
 private val LitStatus?.color: String get() = when (this) {
diff --git a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableLayerManager.kt b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableLayerManager.kt
index efa0abae3b2..8f6a25891c3 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableLayerManager.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/screens/main/map/StyleableLayerManager.kt
@@ -121,10 +121,8 @@ class StyleableLayerManager(
         val layer = layer ?: return
         synchronized(mapDataInView) {
             mapDataInView.clear()
-            mapData.forEach { element ->
-                val styledElement = createStyledElement(layer, mapData, element)
+            createStyledElementsByKey(layer, mapData).forEach { (key, styledElement) ->
                 if (styledElement != null) {
-                    val key = ElementKey(element.type, element.id)
                     mapDataInView[key] = styledElement
                 }
             }
@@ -135,26 +133,21 @@ class StyleableLayerManager(
     private fun updateStyledElements(updated: MapDataWithGeometry, deleted: Collection<ElementKey>) {
         val layer = layer ?: return
         synchronized(mapDataInView) {
-            updated.forEach { element ->
-                val styledElement = createStyledElement(layer, updated, element)
-                val key = ElementKey(element.type, element.id)
-                if (styledElement != null) {
-                    mapDataInView[key] = styledElement
-                } else {
-                    mapDataInView.remove(key)
-                }
+            createStyledElementsByKey(layer, updated).forEach { (key, styledElement) ->
+                if (styledElement != null) mapDataInView[key] = styledElement
+                else                       mapDataInView.remove(key)
             }
             deleted.forEach { mapDataInView.remove(it) }
             mapComponent.set(mapDataInView.values)
         }
     }
 
-    private fun createStyledElement(layer: Layer, mapData: MapDataWithGeometry, element: Element): StyledElement? {
-        if (!layer.isDisplayed(element)) return null
-        val geometry = mapData.getGeometry(element.type, element.id) ?: return null
-        val style = overrideStyle(layer.getStyle(element), element)
-        return StyledElement(element, geometry, style)
-    }
+    private fun createStyledElementsByKey(layer: Layer, mapData: MapDataWithGeometry): Sequence<Pair<ElementKey, StyledElement?>> =
+        layer.getStyledElements(mapData).map { (element, style) ->
+            val key = ElementKey(element.type, element.id)
+            val geometry = mapData.getGeometry(element.type, element.id)
+            key to geometry?.let { StyledElement(element, geometry, overrideStyle(style, element)) }
+        }
 
     // TODO LAYERS "show last checked older X as not set" slider? -> controller simply modifies colors -> needs standard colors
 
