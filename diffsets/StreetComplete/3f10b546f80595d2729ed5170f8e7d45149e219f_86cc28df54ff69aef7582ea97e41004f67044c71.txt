diff --git a/app/src/main/java/de/westnordost/streetcomplete/MainActivity.kt b/app/src/main/java/de/westnordost/streetcomplete/MainActivity.kt
index 1ebb27281ed..299cc7d111f 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/MainActivity.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/MainActivity.kt
@@ -18,6 +18,7 @@ import androidx.appcompat.app.AlertDialog
 import androidx.appcompat.app.AppCompatActivity
 import androidx.core.content.edit
 import androidx.core.content.getSystemService
+import androidx.lifecycle.lifecycleScope
 import androidx.localbroadcastmanager.content.LocalBroadcastManager
 import androidx.preference.PreferenceManager
 import de.westnordost.osmapi.common.errors.OsmApiException
@@ -47,6 +48,7 @@ import de.westnordost.streetcomplete.tutorial.TutorialFragment
 import de.westnordost.streetcomplete.util.CrashReportExceptionHandler
 import de.westnordost.streetcomplete.util.parseGeoUri
 import de.westnordost.streetcomplete.view.dialogs.RequestLoginDialog
+import kotlinx.coroutines.launch
 import javax.inject.Inject
 
 class MainActivity : AppCompatActivity(),
@@ -195,16 +197,15 @@ class MainActivity : AppCompatActivity(),
             .commit()
     }
 
-    private fun ensureLoggedIn() {
-        if (questAutoSyncer.isAllowedByPreference) {
-            if (!userController.isLoggedIn) {
-                // new users should not be immediately pestered to login after each change (#1446)
-                if (unsyncedChangesCountSource.count >= 3 && !dontShowRequestAuthorizationAgain) {
-                    RequestLoginDialog(this).show()
-                    dontShowRequestAuthorizationAgain = true
-                }
-            }
-        }
+    private suspend fun ensureLoggedIn() {
+        if (!questAutoSyncer.isAllowedByPreference) return
+        if (userController.isLoggedIn) return
+
+        // new users should not be immediately pestered to login after each change (#1446)
+        if (unsyncedChangesCountSource.getCount() < 3 || dontShowRequestAuthorizationAgain) return
+
+        RequestLoginDialog(this).show()
+        dontShowRequestAuthorizationAgain = true
     }
 
     private val isConnected: Boolean
@@ -281,11 +282,11 @@ class MainActivity : AppCompatActivity(),
     /* --------------------------------- MainFragment.Listener ---------------------------------- */
 
     override fun onQuestSolved(quest: Quest, source: String?) {
-        ensureLoggedIn()
+        lifecycleScope.launch { ensureLoggedIn() }
     }
 
     override fun onCreatedNote(screenPosition: Point) {
-        ensureLoggedIn()
+        lifecycleScope.launch { ensureLoggedIn() }
     }
 
     /* ------------------------------- TutorialFragment.Listener -------------------------------- */
diff --git a/app/src/main/java/de/westnordost/streetcomplete/controls/AnswersCounterFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/controls/AnswersCounterFragment.kt
index baf89c2ccfe..5bbc7cf9a1b 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/controls/AnswersCounterFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/controls/AnswersCounterFragment.kt
@@ -51,7 +51,7 @@ class AnswersCounterFragment : Fragment(R.layout.fragment_answers_counter) {
          *  upload button, and shows the uploaded + uploadable amount of quests.
          */
         updateProgress(uploadProgressSource.isUploadInProgress)
-        updateCount(false)
+        lifecycleScope.launch { updateCount(false) }
         if (isAutosync) {
             uploadProgressSource.addUploadProgressListener(uploadProgressListener)
             unsyncedChangesCountSource.addListener(unsyncedChangesCountListener)
@@ -73,10 +73,10 @@ class AnswersCounterFragment : Fragment(R.layout.fragment_answers_counter) {
         answersCounterView.showProgress = isUploadInProgress && isAutosync
     }
 
-    private fun updateCount(animated: Boolean) {
+    private suspend fun updateCount(animated: Boolean) {
         /* if autosync is on, show the uploaded count + the to-be-uploaded count (but only those
            uploadables that will be part of the statistics, so no note stuff) */
-        val amount = questStatisticsDao.getTotalAmount() + if (isAutosync) unsyncedChangesCountSource.solvedCount else 0
+        val amount = questStatisticsDao.getTotalAmount() + if (isAutosync) unsyncedChangesCountSource.getSolvedCount() else 0
         answersCounterView.setUploadedCount(amount, animated)
     }
 
diff --git a/app/src/main/java/de/westnordost/streetcomplete/controls/NotificationButtonFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/controls/NotificationButtonFragment.kt
index 2b0519d7362..ae9efedcac5 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/controls/NotificationButtonFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/controls/NotificationButtonFragment.kt
@@ -11,7 +11,9 @@ import de.westnordost.streetcomplete.R
 import de.westnordost.streetcomplete.data.notifications.*
 import de.westnordost.streetcomplete.ktx.popIn
 import de.westnordost.streetcomplete.ktx.popOut
+import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import javax.inject.Inject
 
 /** Handles showing a button with a little counter that shows how many unread notifications there are */
@@ -55,10 +57,12 @@ class NotificationButtonFragment : Fragment(R.layout.fragment_notification_butto
 
     override fun onStart() {
         super.onStart()
-        val numberOfNotifications = notificationsSource.getNumberOfNotifications()
-        notificationButton.notificationsCount = numberOfNotifications
-        notificationButton.isGone = numberOfNotifications <= 0
         notificationsSource.addListener(notificationsSourceUpdateListener)
+        lifecycleScope.launch {
+            val numberOfNotifications = withContext(Dispatchers.IO) { notificationsSource.getNumberOfNotifications() }
+            notificationButton.notificationsCount = numberOfNotifications
+            notificationButton.isGone = numberOfNotifications <= 0
+        }
     }
 
     override fun onStop() {
diff --git a/app/src/main/java/de/westnordost/streetcomplete/controls/UndoButtonFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/controls/UndoButtonFragment.kt
index bef5b05f6d8..f14a4820b5e 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/controls/UndoButtonFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/controls/UndoButtonFragment.kt
@@ -23,7 +23,9 @@ import de.westnordost.streetcomplete.data.upload.UploadProgressSource
 import de.westnordost.streetcomplete.ktx.popIn
 import de.westnordost.streetcomplete.ktx.popOut
 import de.westnordost.streetcomplete.quests.getHtmlQuestTitle
+import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import java.util.concurrent.FutureTask
 import javax.inject.Inject
 
@@ -62,14 +64,18 @@ class UndoButtonFragment : Fragment(R.layout.fragment_undo_button) {
 
         undoButton.setOnClickListener {
             undoButton.isEnabled = false
-            val change = elementEditsController.getMostRecentUndoableEdit()
-            if (change != null) confirmUndo(change)
+            lifecycleScope.launch {
+                val change = getMostRecentUndoableEdit()
+                if (change != null) confirmUndo(change)
+            }
         }
     }
 
     override fun onStart() {
         super.onStart()
-        updateUndoButtonVisibility()
+        lifecycleScope.launch {
+            updateUndoButtonVisibility()
+        }
         updateUndoButtonEnablement(true)
         elementEditsController.addListener(osmElementChangesListener)
         uploadProgressSource.addUploadProgressListener(uploadProgressListener)
@@ -97,7 +103,7 @@ class UndoButtonFragment : Fragment(R.layout.fragment_undo_button) {
             .setTitle(R.string.undo_confirm_title)
             .setView(inner)
             .setPositiveButton(R.string.undo_confirm_positive) { _, _ ->
-                elementEditsController.undo(edit.id)
+                lifecycleScope.launch { withContext(Dispatchers.IO) { elementEditsController.undo(edit.id) } }
                 updateUndoButtonEnablement(true)
             }
             .setNegativeButton(R.string.undo_confirm_negative) { _, _ -> updateUndoButtonEnablement(true) }
@@ -105,23 +111,27 @@ class UndoButtonFragment : Fragment(R.layout.fragment_undo_button) {
             .show()
     }
 
-    private fun updateUndoButtonVisibility() {
-        view?.isGone = elementEditsController.getMostRecentUndoableEdit() == null
+    private suspend fun updateUndoButtonVisibility() {
+        view?.isGone = getMostRecentUndoableEdit() == null
     }
 
     private fun updateUndoButtonEnablement(enable: Boolean) {
         undoButton.isEnabled = enable && !uploadProgressSource.isUploadInProgress
     }
 
-    private fun animateInIfAnythingToUndo() {
-        if (!undoButton.isVisible && elementEditsController.getMostRecentUndoableEdit() != null) {
+    private suspend fun animateInIfAnythingToUndo() {
+        if (!undoButton.isVisible && getMostRecentUndoableEdit() != null) {
             undoButton.popIn()
         }
     }
 
-    private fun animateOutIfNothingLeftToUndo() {
-        if (undoButton.isVisible && elementEditsController.getMostRecentUndoableEdit() == null) {
+    private suspend fun animateOutIfNothingLeftToUndo() {
+        if (undoButton.isVisible && getMostRecentUndoableEdit() == null) {
             undoButton.popOut().withEndAction { undoButton.visibility = View.INVISIBLE }
         }
     }
+
+    private suspend fun getMostRecentUndoableEdit() = withContext(Dispatchers.IO) {
+        elementEditsController.getMostRecentUndoableEdit()
+    }
 }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/controls/UploadButtonFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/controls/UploadButtonFragment.kt
index c06eb2dd660..65ce6c546b0 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/controls/UploadButtonFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/controls/UploadButtonFragment.kt
@@ -17,7 +17,9 @@ import de.westnordost.streetcomplete.data.upload.UploadProgressListener
 import de.westnordost.streetcomplete.data.user.UserController
 import de.westnordost.streetcomplete.ktx.toast
 import de.westnordost.streetcomplete.view.dialogs.RequestLoginDialog
+import kotlinx.coroutines.Dispatchers
 import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import javax.inject.Inject
 
 /** Fragment that shows the upload button, including upload progress etc. */
@@ -63,10 +65,12 @@ class UploadButtonFragment : Fragment(R.layout.fragment_upload_button) {
         /* Only show the button if autosync is off */
         uploadButton.isGone = isAutosync
         if (!isAutosync) {
-            updateCount()
+            lifecycleScope.launch {
+                updateCount()
+                unsyncedChangesCountSource.addListener(unsyncedChangesCountListener)
+            }
             updateProgress(uploadController.isUploadInProgress)
             uploadController.addUploadProgressListener(uploadProgressListener)
-            unsyncedChangesCountSource.addListener(unsyncedChangesCountListener)
         }
     }
 
@@ -81,8 +85,8 @@ class UploadButtonFragment : Fragment(R.layout.fragment_upload_button) {
     private val isAutosync: Boolean get() =
         Prefs.Autosync.valueOf(prefs.getString(Prefs.AUTOSYNC, "ON")!!) == Prefs.Autosync.ON
 
-    private fun updateCount() {
-        uploadButton.uploadableCount = unsyncedChangesCountSource.count
+    private suspend fun updateCount() {
+        uploadButton.uploadableCount = unsyncedChangesCountSource.getCount()
     }
 
     private fun updateProgress(isUploadInProgress: Boolean) {
diff --git a/app/src/main/java/de/westnordost/streetcomplete/data/UnsyncedChangesCountSource.kt b/app/src/main/java/de/westnordost/streetcomplete/data/UnsyncedChangesCountSource.kt
index 518c743fad5..3530f43f003 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/data/UnsyncedChangesCountSource.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/data/UnsyncedChangesCountSource.kt
@@ -2,9 +2,10 @@ package de.westnordost.streetcomplete.data
 
 import de.westnordost.streetcomplete.data.osm.edits.ElementEdit
 import de.westnordost.streetcomplete.data.osm.edits.ElementEditsSource
-import de.westnordost.streetcomplete.data.osm.edits.IsRevertAction
 import de.westnordost.streetcomplete.data.osmnotes.edits.NoteEdit
 import de.westnordost.streetcomplete.data.osmnotes.edits.NoteEditsSource
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.withContext
 import java.util.concurrent.CopyOnWriteArrayList
 import javax.inject.Inject
 import javax.inject.Singleton
@@ -18,60 +19,29 @@ import javax.inject.Singleton
         fun onIncreased()
         fun onDecreased()
     }
-    private val listeners: MutableList<Listener> = CopyOnWriteArrayList()
 
-    val count: Int get() = unsyncedNotesCount + unsyncedElementsCount
+    private val listeners = CopyOnWriteArrayList<Listener>()
+
+    suspend fun getCount(): Int = withContext(Dispatchers.IO) {
+        elementEditsSource.getUnsyncedCount() + noteEditsSource.getUnsyncedCount()
+    }
 
     /** count of unsynced changes that count towards the statistics. That is, unsynced note stuff
      *  doesn't count and reverts of changes count negative */
-    var solvedCount: Int = elementEditsSource.getPositiveUnsyncedCount()
-    private set
-
-
-    private var unsyncedNotesCount: Int = noteEditsSource.getUnsyncedCount()
-    set(value) {
-        val diff = value - field
-        field = value
-        onUpdate(diff)
-    }
-    private var unsyncedElementsCount: Int = elementEditsSource.getUnsyncedCount()
-    set(value) {
-        val diff = value - field
-        field = value
-        onUpdate(diff)
+    suspend fun getSolvedCount(): Int = withContext(Dispatchers.IO) {
+        elementEditsSource.getPositiveUnsyncedCount()
     }
 
     private val noteEditsListener = object : NoteEditsSource.Listener {
-        override fun onAddedEdit(edit: NoteEdit) {
-            if (edit.isSynced) return
-            ++unsyncedNotesCount
-        }
-
-        override fun onSyncedEdit(edit: NoteEdit) {
-            --unsyncedNotesCount
-        }
-
-        override fun onDeletedEdit(edit: NoteEdit) {
-            if (edit.isSynced) return
-            --unsyncedNotesCount
-        }
+        override fun onAddedEdit(edit: NoteEdit) { if (!edit.isSynced) onUpdate(+1) }
+        override fun onSyncedEdit(edit: NoteEdit) { onUpdate(-1) }
+        override fun onDeletedEdit(edit: NoteEdit) { if (!edit.isSynced) onUpdate(-1) }
     }
 
     private val elementEditsListener = object : ElementEditsSource.Listener {
-        override fun onAddedEdit(edit: ElementEdit) {
-            if (edit.isSynced) return
-            ++unsyncedElementsCount
-            if (edit.action is IsRevertAction) --solvedCount else ++solvedCount
-        }
-        override fun onSyncedEdit(edit: ElementEdit) {
-            --unsyncedElementsCount
-            if (edit.action is IsRevertAction) ++solvedCount else --solvedCount
-        }
-        override fun onDeletedEdit(edit: ElementEdit) {
-            if (edit.isSynced) return
-            --unsyncedElementsCount
-            if (edit.action is IsRevertAction) ++solvedCount else --solvedCount
-        }
+        override fun onAddedEdit(edit: ElementEdit) { if (!edit.isSynced) onUpdate(+1) }
+        override fun onSyncedEdit(edit: ElementEdit) { onUpdate(-1) }
+        override fun onDeletedEdit(edit: ElementEdit) { if (!edit.isSynced) onUpdate(-1) }
     }
 
     init {
diff --git a/app/src/main/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsController.kt b/app/src/main/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsController.kt
index 7d00a5b597b..27c96f0eea0 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsController.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsController.kt
@@ -23,7 +23,6 @@ import javax.inject.Singleton
         text: String? = null,
         imagePaths: List<String> = emptyList()
     ) {
-
         val edit = NoteEdit(
             0,
             noteId,
diff --git a/app/src/main/java/de/westnordost/streetcomplete/quests/oneway_suspects/AddSuspectedOnewayForm.kt b/app/src/main/java/de/westnordost/streetcomplete/quests/oneway_suspects/AddSuspectedOnewayForm.kt
index 5e582463e1b..c8468a67fec 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/quests/oneway_suspects/AddSuspectedOnewayForm.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/quests/oneway_suspects/AddSuspectedOnewayForm.kt
@@ -3,6 +3,7 @@ package de.westnordost.streetcomplete.quests.oneway_suspects
 import android.os.Bundle
 import androidx.annotation.AnyThread
 import android.view.View
+import androidx.lifecycle.lifecycleScope
 
 import javax.inject.Inject
 
@@ -15,6 +16,9 @@ import de.westnordost.streetcomplete.quests.oneway_suspects.data.WayTrafficFlowD
 import de.westnordost.streetcomplete.view.ResImage
 import kotlinx.android.synthetic.main.quest_street_side_puzzle.*
 import kotlinx.android.synthetic.main.view_little_compass.*
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 
 class AddSuspectedOnewayForm : AYesNoQuestAnswerFragment<SuspectedOnewayAnswer>() {
 
@@ -34,10 +38,14 @@ class AddSuspectedOnewayForm : AYesNoQuestAnswerFragment<SuspectedOnewayAnswer>(
 
         puzzleView.showOnlyRightSide()
 
-        puzzleView.setRightSideImage(ResImage(
-            if (db.isForward(osmElement!!.id)!!) R.drawable.ic_oneway_lane
-            else R.drawable.ic_oneway_lane_reverse
-        ))
+        lifecycleScope.launch {
+            val isForward = withContext(Dispatchers.IO) { db.isForward(osmElement!!.id)!! }
+
+            puzzleView.setRightSideImage(ResImage(
+                if (isForward) R.drawable.ic_oneway_lane
+                else R.drawable.ic_oneway_lane_reverse
+            ))
+        }
 
         streetSideRotater = StreetSideRotater(puzzleView, compassNeedleView, elementGeometry as ElementPolylinesGeometry)
     }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/user/LoginFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/user/LoginFragment.kt
index b0e4f79e991..cdd91707839 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/user/LoginFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/user/LoginFragment.kt
@@ -59,9 +59,11 @@ class LoginFragment : Fragment(R.layout.fragment_login),
     override fun onStart() {
         super.onStart()
 
-        val unsyncedChanges = unsyncedChangesCountSource.count
-        unpublishedQuestsText.text = getString(R.string.unsynced_quests_not_logged_in_description, unsyncedChanges)
-        unpublishedQuestsText.isGone = unsyncedChanges <= 0
+        lifecycleScope.launch {
+            val unsyncedChanges = unsyncedChangesCountSource.getCount()
+            unpublishedQuestsText.text = getString(R.string.unsynced_quests_not_logged_in_description, unsyncedChanges)
+            unpublishedQuestsText.isGone = unsyncedChanges <= 0
+        }
     }
 
     override fun onBackPressed(): Boolean {
diff --git a/app/src/main/java/de/westnordost/streetcomplete/user/ProfileFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/user/ProfileFragment.kt
index 34232c2b0cf..cd381332b1b 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/user/ProfileFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/user/ProfileFragment.kt
@@ -116,7 +116,7 @@ class ProfileFragment : Fragment(R.layout.fragment_profile) {
     }
 
     private suspend fun updateUnpublishedQuestsText() {
-        val unsyncedChanges = withContext(Dispatchers.IO) { unsyncedChangesCountSource.count }
+        val unsyncedChanges = unsyncedChangesCountSource.getCount()
         unpublishedQuestsText.text = getString(R.string.unsynced_quests_description, unsyncedChanges)
         unpublishedQuestsText.isGone = unsyncedChanges <= 0
     }
diff --git a/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByCountryFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByCountryFragment.kt
index 0c85d9ca1bc..5a2933b0c3c 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByCountryFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByCountryFragment.kt
@@ -5,11 +5,15 @@ import android.os.Bundle
 import android.view.View
 import android.view.ViewGroup
 import androidx.fragment.app.Fragment
+import androidx.lifecycle.lifecycleScope
 import de.westnordost.streetcomplete.Injector
 import de.westnordost.streetcomplete.R
 import de.westnordost.streetcomplete.data.user.CountryStatisticsDao
 import de.westnordost.streetcomplete.ktx.toPx
 import kotlinx.android.synthetic.main.fragment_quest_statistics_ball_pit.*
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import javax.inject.Inject
 
 /** Shows the user's solved quests of each type in some kind of ball pit.  */
@@ -31,11 +35,13 @@ class QuestStatisticsByCountryFragment : Fragment(R.layout.fragment_quest_statis
 
         lifecycle.addObserver(ballPitView)
 
-        val countriesStatistics = countryStatisticsDao.getAll()
+        lifecycleScope.launch {
+            val countriesStatistics = withContext(Dispatchers.IO) { countryStatisticsDao.getAll() }
 
-        ballPitView.setViews(countriesStatistics.map {
-            createCountryBubbleView(it.countryCode, it.solvedCount, it.rank) to it.solvedCount
-        })
+            ballPitView.setViews(countriesStatistics.map {
+                createCountryBubbleView(it.countryCode, it.solvedCount, it.rank) to it.solvedCount
+            })
+        }
     }
 
     private fun createCountryBubbleView(countryCode: String, solvedCount: Int, rank: Int?): View {
diff --git a/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByQuestTypeFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByQuestTypeFragment.kt
index d9e7136e322..5c22f6b5733 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByQuestTypeFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsByQuestTypeFragment.kt
@@ -9,6 +9,7 @@ import android.view.ViewGroup.LayoutParams.MATCH_PARENT
 import android.widget.FrameLayout
 import android.widget.ImageView
 import androidx.fragment.app.Fragment
+import androidx.lifecycle.lifecycleScope
 import de.westnordost.streetcomplete.Injector
 import de.westnordost.streetcomplete.R
 import de.westnordost.streetcomplete.data.quest.QuestType
@@ -17,6 +18,9 @@ import de.westnordost.streetcomplete.data.user.QuestStatisticsDao
 import de.westnordost.streetcomplete.ktx.toPx
 import de.westnordost.streetcomplete.view.CircularOutlineProvider
 import kotlinx.android.synthetic.main.fragment_quest_statistics_ball_pit.*
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import javax.inject.Inject
 
 /** Shows the user's solved quests of each type in some kind of ball pit. Clicking on each opens
@@ -42,13 +46,12 @@ class QuestStatisticsByQuestTypeFragment : Fragment(R.layout.fragment_quest_stat
 
         lifecycle.addObserver(ballPitView)
 
-        val solvedQuestsByQuestType = questStatisticsDao.getAll()
-                    .filterKeys { questTypeRegistry.getByName(it) != null }
-                    .mapKeys { questTypeRegistry.getByName(it.key)!! }
-
-        ballPitView.setViews(solvedQuestsByQuestType.map { (questType, amount) ->
-            createQuestTypeBubbleView(questType, amount) to amount
-        })
+        lifecycleScope.launch {
+            val solvedQuestsByQuestType = getSolvedQuestsByQuestType()
+            ballPitView.setViews(solvedQuestsByQuestType.map { (questType, amount) ->
+                createQuestTypeBubbleView(questType, amount) to amount
+            })
+        }
     }
 
     private fun createQuestTypeBubbleView(questType: QuestType<*>, solvedCount: Int): View {
@@ -74,5 +77,11 @@ class QuestStatisticsByQuestTypeFragment : Fragment(R.layout.fragment_quest_stat
 
         return clickableContainer
     }
+
+    private suspend fun getSolvedQuestsByQuestType() = withContext(Dispatchers.IO) {
+        questStatisticsDao.getAll()
+            .filterKeys { questTypeRegistry.getByName(it) != null }
+            .mapKeys { questTypeRegistry.getByName(it.key)!! }
+    }
 }
 
diff --git a/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsFragment.kt b/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsFragment.kt
index d33c7f4d70c..2f088702009 100644
--- a/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsFragment.kt
+++ b/app/src/main/java/de/westnordost/streetcomplete/user/QuestStatisticsFragment.kt
@@ -6,19 +6,22 @@ import androidx.core.view.isGone
 import androidx.fragment.app.Fragment
 import androidx.fragment.app.FragmentTransaction.TRANSIT_FRAGMENT_FADE
 import androidx.fragment.app.commit
+import androidx.lifecycle.lifecycleScope
 import de.westnordost.streetcomplete.Injector
 import de.westnordost.streetcomplete.R
 import de.westnordost.streetcomplete.data.quest.QuestType
 import de.westnordost.streetcomplete.data.user.QuestStatisticsDao
 import de.westnordost.streetcomplete.data.user.UserStore
 import kotlinx.android.synthetic.main.fragment_quest_statistics.*
+import kotlinx.coroutines.Dispatchers
+import kotlinx.coroutines.launch
+import kotlinx.coroutines.withContext
 import javax.inject.Inject
 
 /** Shows the user's solved quests of each type in some kind of ball pit. Clicking on each opens
  *  a QuestTypeInfoFragment that shows the quest's details. */
 class QuestStatisticsFragment : Fragment(R.layout.fragment_quest_statistics),
     QuestStatisticsByQuestTypeFragment.Listener,  QuestStatisticsByCountryFragment.Listener
-
 {
     @Inject internal lateinit var questStatisticsDao: QuestStatisticsDao
     @Inject internal lateinit var userStore: UserStore
@@ -35,7 +38,10 @@ class QuestStatisticsFragment : Fragment(R.layout.fragment_quest_statistics),
 
     override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
         super.onViewCreated(view, savedInstanceState)
-        emptyText.isGone = questStatisticsDao.getTotalAmount() != 0
+
+        lifecycleScope.launch {
+            emptyText.isGone = withContext(Dispatchers.IO) { questStatisticsDao.getTotalAmount() != 0 }
+        }
 
         byQuestTypeButton.setOnClickListener { v -> selectorButton.check(v.id) }
         byCountryButton.setOnClickListener { v -> selectorButton.check(v.id) }
diff --git a/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsControllerTest.kt b/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsControllerTest.kt
index a6f6029c997..a37dcd9f182 100644
--- a/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsControllerTest.kt
+++ b/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsControllerTest.kt
@@ -31,31 +31,31 @@ class NoteEditsControllerTest {
     }
 
     @Test fun syncFailed() {
-        val edit = NoteEdit(0L, 1L, p(1.0,1.0), NoteEditAction.COMMENT, null, emptyList(), 0L, false, false)
+        val edit = noteEdit(noteId = 1)
         ctrl.syncFailed(edit)
 
-        verify(db).delete(anyLong())
+        verify(db).delete(1)
         verify(listener).onDeletedEdit(edit)
     }
 
     @Test fun synced() {
-        val edit = NoteEdit(0L, 1L, p(1.0,1.0), NoteEditAction.COMMENT, null, emptyList(), 0L, false, false)
+        val edit = noteEdit(id = 3, noteId = 1)
         val note = note(1)
 
         ctrl.synced(edit, note)
 
-        verify(db).markSynced(anyLong())
+        verify(db).markSynced(3)
         verify(db, never()).updateNoteId(anyLong(), anyLong())
         verify(listener).onSyncedEdit(edit)
     }
 
     @Test fun `synced with new id`() {
-        val edit = NoteEdit(0L, -100L, p(1.0,1.0), NoteEditAction.COMMENT, null, emptyList(), 0L, false, false)
+        val edit = noteEdit(id = 3, noteId = -100)
         val note = note(123)
 
         ctrl.synced(edit, note)
 
-        verify(db).markSynced(anyLong())
+        verify(db).markSynced(3)
         verify(db).updateNoteId(-100L, 123L)
         verify(listener).onSyncedEdit(edit)
     }
diff --git a/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsUploaderTest.kt b/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsUploaderTest.kt
index 10cb5a45e82..abd7863c488 100644
--- a/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsUploaderTest.kt
+++ b/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NoteEditsUploaderTest.kt
@@ -2,7 +2,6 @@ package de.westnordost.streetcomplete.data.osmnotes.edits
 
 import de.westnordost.osmapi.common.errors.OsmConflictException
 import de.westnordost.osmapi.common.errors.OsmNotFoundException
-import de.westnordost.osmapi.map.data.LatLon
 import de.westnordost.streetcomplete.data.NotesApi
 import de.westnordost.streetcomplete.data.osmnotes.NoteController
 import de.westnordost.streetcomplete.data.osmnotes.StreetCompleteImageUploader
@@ -53,7 +52,7 @@ class NoteEditsUploaderTest {
 
     @Test fun `upload note comment`() {
         val pos = p(1.0, 13.0)
-        val edit = edit(noteId = 1L, action = NoteEditAction.COMMENT, text = "abc", pos = pos)
+        val edit = noteEdit(noteId = 1L, action = NoteEditAction.COMMENT, text = "abc", pos = pos)
         val note = note(id = 1L)
 
         on(noteEditsController.getOldestUnsynced()).thenReturn(edit).thenReturn(null)
@@ -70,7 +69,7 @@ class NoteEditsUploaderTest {
 
     @Test fun `upload create note`() {
         val pos = p(1.0, 13.0)
-        val edit = edit(noteId = -5L, action = NoteEditAction.CREATE, text = "abc", pos = pos)
+        val edit = noteEdit(noteId = -5L, action = NoteEditAction.CREATE, text = "abc", pos = pos)
         val note = note(123)
 
         on(noteEditsController.getOldestUnsynced()).thenReturn(edit).thenReturn(null)
@@ -87,7 +86,7 @@ class NoteEditsUploaderTest {
 
     @Test fun `fail uploading note comment because of a conflict`() {
         val pos = p(1.0, 13.0)
-        val edit = edit(noteId = 1L, action = NoteEditAction.COMMENT, text = "abc", pos = pos)
+        val edit = noteEdit(noteId = 1L, action = NoteEditAction.COMMENT, text = "abc", pos = pos)
         val note = note(1)
 
         on(noteEditsController.getOldestUnsynced()).thenReturn(edit).thenReturn(null)
@@ -105,7 +104,7 @@ class NoteEditsUploaderTest {
 
     @Test fun `fail uploading note comment because note was deleted`() {
         val pos = p(1.0, 13.0)
-        val edit = edit(noteId = 1L, action = NoteEditAction.COMMENT, text = "abc", pos = pos)
+        val edit = noteEdit(noteId = 1L, action = NoteEditAction.COMMENT, text = "abc", pos = pos)
         val note = note(1)
 
         on(noteEditsController.getOldestUnsynced()).thenReturn(edit).thenReturn(null)
@@ -122,7 +121,7 @@ class NoteEditsUploaderTest {
     }
 
     @Test fun `upload several note edits`() {
-        on(noteEditsController.getOldestUnsynced()).thenReturn(edit()).thenReturn(edit()).thenReturn(null)
+        on(noteEditsController.getOldestUnsynced()).thenReturn(noteEdit()).thenReturn(noteEdit()).thenReturn(null)
         on(notesApi.comment(anyLong(), any())).thenReturn(note())
 
         upload()
@@ -135,7 +134,7 @@ class NoteEditsUploaderTest {
 
     @Test fun `upload note comment with attached images`() {
         val pos = p(1.0, 13.0)
-        val edit = edit(
+        val edit = noteEdit(
             noteId = 1L,
             action = NoteEditAction.COMMENT,
             text = "test",
@@ -161,7 +160,7 @@ class NoteEditsUploaderTest {
 
     @Test fun `upload create note with attached images`() {
         val pos = p(1.0, 13.0)
-        val edit = edit(
+        val edit = noteEdit(
             noteId = 1L,
             action = NoteEditAction.CREATE,
             text = "test",
@@ -186,7 +185,7 @@ class NoteEditsUploaderTest {
     }
 
     @Test fun `upload missed image activations`() {
-        val edit = edit(noteId = 3)
+        val edit = noteEdit(noteId = 3)
 
         on(noteEditsController.getOldestNeedingImagesActivation()).thenReturn(edit).thenReturn(null)
 
@@ -200,21 +199,3 @@ class NoteEditsUploaderTest {
         uploader.upload()
     }
 }
-
-private fun edit(
-    noteId: Long = 1,
-    action: NoteEditAction = NoteEditAction.COMMENT,
-    text: String = "test123",
-    imagePaths: List<String> = emptyList(),
-    pos: LatLon = p(1.0, 1.0)
-) = NoteEdit(
-        1L,
-        noteId,
-        pos,
-        action,
-        text,
-        imagePaths,
-        123L,
-        false,
-        imagePaths.isNotEmpty()
-)
diff --git a/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NotesWithEditsSourceTest.kt b/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NotesWithEditsSourceTest.kt
index 2a4fe29f7db..898551b9f56 100644
--- a/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NotesWithEditsSourceTest.kt
+++ b/app/src/test/java/de/westnordost/streetcomplete/data/osmnotes/edits/NotesWithEditsSourceTest.kt
@@ -1,7 +1,6 @@
 package de.westnordost.streetcomplete.data.osmnotes.edits
 
 import de.westnordost.osmapi.map.data.BoundingBox
-import de.westnordost.osmapi.map.data.LatLon
 import de.westnordost.osmapi.notes.Note
 import de.westnordost.osmapi.notes.NoteComment
 import de.westnordost.streetcomplete.data.osmnotes.NoteController
@@ -65,7 +64,7 @@ class NotesWithEditsSourceTest {
 
         val note = note(id = 1, comments = arrayListOf(comment))
         val edits = listOf(
-            edit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500)
+            noteEdit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500)
         )
 
         on(userStore.userId).thenReturn(-1)
@@ -85,7 +84,7 @@ class NotesWithEditsSourceTest {
         )
 
         val note = note(id = 1, comments = arrayListOf(comment))
-        val edits = listOf(edit(
+        val edits = listOf(noteEdit(
             noteId = 1,
             action = NoteEditAction.COMMENT,
             text = "test2",
@@ -107,7 +106,7 @@ class NotesWithEditsSourceTest {
 
         val note = note(id = 1, comments = arrayListOf(comment1))
         val edits = listOf(
-            edit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500)
+            noteEdit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500)
         )
 
         on(userStore.userId).thenReturn(23)
@@ -126,8 +125,8 @@ class NotesWithEditsSourceTest {
 
         val note = note(id = 1, comments = arrayListOf(comment1))
         val edits = listOf(
-            edit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500),
-            edit(noteId = 1, action = NoteEditAction.COMMENT, text = "test3", timestamp = 800),
+            noteEdit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500),
+            noteEdit(noteId = 1, action = NoteEditAction.COMMENT, text = "test3", timestamp = 800),
         )
 
         on(userStore.userId).thenReturn(-1)
@@ -147,7 +146,7 @@ class NotesWithEditsSourceTest {
             timestamp = 123)
 
         val edits = listOf(
-            edit(noteId = -12, pos = p, action = NoteEditAction.CREATE, text = "test12", timestamp = 123)
+            noteEdit(noteId = -12, pos = p, action = NoteEditAction.CREATE, text = "test12", timestamp = 123)
         )
 
         on(userStore.userId).thenReturn(-1)
@@ -170,8 +169,8 @@ class NotesWithEditsSourceTest {
             timestamp = 123)
 
         val edits = listOf(
-            edit(noteId = -12, pos = p, action = NoteEditAction.CREATE, text = "test12", timestamp = 123),
-            edit(noteId = -12, pos = p, action = NoteEditAction.COMMENT, text = "test34", timestamp = 234),
+            noteEdit(noteId = -12, pos = p, action = NoteEditAction.CREATE, text = "test12", timestamp = 123),
+            noteEdit(noteId = -12, pos = p, action = NoteEditAction.COMMENT, text = "test34", timestamp = 234),
         )
 
         on(userStore.userId).thenReturn(-1)
@@ -238,7 +237,7 @@ class NotesWithEditsSourceTest {
         src.addListener(listener)
 
         val note = note(1)
-        val edit = edit(noteId = 1)
+        val edit = noteEdit(noteId = 1)
 
         on(noteController.get(1)).thenReturn(note)
 
@@ -251,7 +250,7 @@ class NotesWithEditsSourceTest {
         val listener = mock<NotesWithEditsSource.Listener>()
         src.addListener(listener)
 
-        val edit = edit(noteId = 1)
+        val edit = noteEdit(noteId = 1)
 
         on(noteController.get(1)).thenReturn(null)
 
@@ -265,7 +264,7 @@ class NotesWithEditsSourceTest {
         src.addListener(listener)
 
         val note = note(id = 1)
-        val edit = edit(noteId = 1)
+        val edit = noteEdit(noteId = 1)
 
         on(noteController.get(1)).thenReturn(note)
 
@@ -282,7 +281,7 @@ class NotesWithEditsSourceTest {
         val expectedNote = note(id = 1, position = p, timestamp = 123L, comments = arrayListOf(
             comment("abc", NoteComment.Action.OPENED, 123L)
         ))
-        val edit = edit(noteId = 1, id = -1, action = NoteEditAction.CREATE, text = "abc", timestamp = 123L, pos = p)
+        val edit = noteEdit(noteId = 1, id = -1, action = NoteEditAction.CREATE, text = "abc", timestamp = 123L, pos = p)
 
         on(noteController.get(1)).thenReturn(null)
         on(noteEditsController.getAllUnsyncedForNote(1)).thenReturn(listOf(edit))
@@ -358,29 +357,9 @@ val expectedNotes1 = listOf(
 )
 
 val edits1 = listOf(
-    edit(noteId = 2, action = NoteEditAction.CREATE, text = "xyz", timestamp = 300, pos = p(12.0,1.0)),
-    edit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500),
-    edit(noteId = 2, action = NoteEditAction.COMMENT, text = "abc", timestamp = 900),
-)
-
-private fun edit(
-    id: Long = 1,
-    noteId: Long = 5,
-    action: NoteEditAction = NoteEditAction.COMMENT,
-    text: String = "test123",
-    timestamp: Long = 123L,
-    imagePaths: List<String> = emptyList(),
-    pos: LatLon = p(1.0, 1.0)
-) = NoteEdit(
-    id,
-    noteId,
-    pos,
-    action,
-    text,
-    imagePaths,
-    timestamp,
-    false,
-    imagePaths.isNotEmpty()
+    noteEdit(noteId = 2, action = NoteEditAction.CREATE, text = "xyz", timestamp = 300, pos = p(12.0,1.0)),
+    noteEdit(noteId = 1, action = NoteEditAction.COMMENT, text = "test2", timestamp = 500),
+    noteEdit(noteId = 2, action = NoteEditAction.COMMENT, text = "abc", timestamp = 900),
 )
 
 private fun checkListenerCalledWith(
diff --git a/app/src/test/java/de/westnordost/streetcomplete/data/quest/UnsyncedChangesCountSourceTest.kt b/app/src/test/java/de/westnordost/streetcomplete/data/quest/UnsyncedChangesCountSourceTest.kt
index 4d30bc66f4a..c5c20896e19 100644
--- a/app/src/test/java/de/westnordost/streetcomplete/data/quest/UnsyncedChangesCountSourceTest.kt
+++ b/app/src/test/java/de/westnordost/streetcomplete/data/quest/UnsyncedChangesCountSourceTest.kt
@@ -8,7 +8,9 @@ import de.westnordost.streetcomplete.data.osm.osmquests.OsmQuestSource
 import de.westnordost.streetcomplete.data.osmnotes.edits.NoteEditsSource
 import de.westnordost.streetcomplete.data.osmnotes.notequests.OsmNoteQuestSource
 import de.westnordost.streetcomplete.testutils.mock
+import de.westnordost.streetcomplete.testutils.noteEdit
 import de.westnordost.streetcomplete.testutils.on
+import kotlinx.coroutines.runBlocking
 import org.junit.Assert.*
 import org.junit.Before
 import org.junit.Test
@@ -67,22 +69,22 @@ class UnsyncedChangesCountSourceTest {
         source.addListener(listener)
     }
 
-    @Test fun count() {
-        assertEquals(baseCount, source.count)
+    @Test fun count() = runBlocking {
+        assertEquals(baseCount, source.getCount())
     }
 
     @Test fun `add unsynced element change triggers listener`() {
         val change = mock<ElementEdit>()
         on(change.isSynced).thenReturn(false)
         elementEditsListener.onAddedEdit(change)
-        verifyIncreased()
+        verify(listener).onIncreased()
     }
 
     @Test fun `remove unsynced element change triggers listener`() {
         val change = mock<ElementEdit>()
         on(change.isSynced).thenReturn(false)
         elementEditsListener.onDeletedEdit(change)
-        verifyDecreased()
+        verify(listener).onDecreased()
     }
 
     @Test fun `add synced element change does not trigger listener`() {
@@ -100,27 +102,17 @@ class UnsyncedChangesCountSourceTest {
     }
 
     @Test fun `add note edit triggers listener`() {
-        noteEditsListener.onAddedEdit(mock())
-        verifyIncreased()
+        noteEditsListener.onAddedEdit(noteEdit())
+        verify(listener).onIncreased()
     }
 
     @Test fun `remove note edit triggers listener`() {
-        noteEditsListener.onDeletedEdit(mock())
-        verifyDecreased()
-    }
-
-    @Test fun `markd note edit synced triggers listener`() {
-        noteEditsListener.onSyncedEdit(mock())
-        verifyDecreased()
-    }
-
-    private fun verifyDecreased() {
+        noteEditsListener.onDeletedEdit(noteEdit())
         verify(listener).onDecreased()
-        assertEquals(baseCount - 1, source.count)
     }
 
-    private fun verifyIncreased() {
-        verify(listener).onIncreased()
-        assertEquals(baseCount + 1, source.count)
+    @Test fun `marked note edit synced triggers listener`() {
+        noteEditsListener.onSyncedEdit(noteEdit())
+        verify(listener).onDecreased()
     }
 }
diff --git a/app/src/test/java/de/westnordost/streetcomplete/testutils/TestDataShortcuts.kt b/app/src/test/java/de/westnordost/streetcomplete/testutils/TestDataShortcuts.kt
index 8ae1c47849f..963edbbf3b2 100644
--- a/app/src/test/java/de/westnordost/streetcomplete/testutils/TestDataShortcuts.kt
+++ b/app/src/test/java/de/westnordost/streetcomplete/testutils/TestDataShortcuts.kt
@@ -5,6 +5,8 @@ import de.westnordost.osmapi.notes.Note
 import de.westnordost.osmapi.notes.NoteComment
 import de.westnordost.osmapi.user.User
 import de.westnordost.streetcomplete.data.osm.geometry.ElementPointGeometry
+import de.westnordost.streetcomplete.data.osmnotes.edits.NoteEdit
+import de.westnordost.streetcomplete.data.osmnotes.edits.NoteEditAction
 import java.util.*
 
 fun p(lat: Double = 0.0, lon: Double = 0.0) = OsmLatLon(lat, lon)
@@ -72,3 +74,23 @@ fun comment(
     it.user = userId?.let { User(userId, userName) }
     it.date = Date(timestamp)
 }
+
+fun noteEdit(
+    id: Long = 1,
+    noteId: Long = 5,
+    action: NoteEditAction = NoteEditAction.COMMENT,
+    text: String = "test123",
+    timestamp: Long = 123L,
+    imagePaths: List<String> = emptyList(),
+    pos: LatLon = p(1.0, 1.0)
+) = NoteEdit(
+    id,
+    noteId,
+    pos,
+    action,
+    text,
+    imagePaths,
+    timestamp,
+    false,
+    imagePaths.isNotEmpty()
+)
