diff --git a/build.gradle b/build.gradle
index 10996f398..dcf83b1ec 100644
--- a/build.gradle
+++ b/build.gradle
@@ -19,7 +19,7 @@ buildscript {
         compileSdkVersion = 29
         targetSdkVersion = 29
 
-        activityVersion = '1.2.0-alpha05'
+        activityVersion = '1.2.0-alpha06'
         appCompatVersion = '1.3.0-alpha01'
         archCoreVersion = '2.1.0'
         browserVersion = '1.2.0'
@@ -33,13 +33,13 @@ buildscript {
         firebaseAnalyticsVersion = '17.4.3'
         firebaseCrashlyticsVersion = '17.0.1'
         firebasePerfVersion = '19.0.7'
-        fragmentVersion = '1.3.0-alpha05'
+        fragmentVersion = '1.3.0-alpha06'
         kotlinVersion = '1.3.72'
-        lifecycleVersion = '2.3.0-alpha03'
+        lifecycleVersion = '2.3.0-alpha04'
         localeVersion = '1.0.4'
         materialVersion = '1.1.0'
         multidexVersion = '2.0.1'
-        navigationVersion = '2.3.0-beta01'
+        navigationVersion = '2.3.0-rc01'
         okhttpVersion = '3.12.12'
         pagingVersion = '2.1.2'
         playServicesWearableVersion = '17.0.0'
diff --git a/example-unsplash/src/main/java/com/example/muzei/unsplash/UnsplashRedirectActivity.kt b/example-unsplash/src/main/java/com/example/muzei/unsplash/UnsplashRedirectActivity.kt
index a697e16cc..e2dd5b5e6 100644
--- a/example-unsplash/src/main/java/com/example/muzei/unsplash/UnsplashRedirectActivity.kt
+++ b/example-unsplash/src/main/java/com/example/muzei/unsplash/UnsplashRedirectActivity.kt
@@ -22,7 +22,7 @@ import android.os.Bundle
 import android.util.Log
 import android.widget.Toast
 import androidx.activity.ComponentActivity
-import androidx.activity.result.contract.ActivityResultContracts
+import androidx.activity.result.contract.ActivityResultContracts.StartActivityForResult
 import com.google.android.apps.muzei.api.MuzeiContract
 
 /**
@@ -40,8 +40,7 @@ class UnsplashRedirectActivity : ComponentActivity() {
         private const val PLAY_STORE_LINK = "https://play.google.com/store/apps/details?id=$MUZEI_PACKAGE_NAME"
     }
 
-    private val requestLauncher = registerForActivityResult(
-            ActivityResultContracts.StartActivityForResult()) {
+    private val requestLauncher = registerForActivityResult(StartActivityForResult()) {
         // It doesn't matter what the result is, the important part is that the
         // user hit the back button to return to this activity. Since this activity
         // has no UI of its own, we can simply finish the activity.
diff --git a/legacy-standalone/src/main/java/com/google/android/apps/muzei/legacy/SourceSetupActivity.kt b/legacy-standalone/src/main/java/com/google/android/apps/muzei/legacy/SourceSetupActivity.kt
index 04c45af8f..f7602b646 100644
--- a/legacy-standalone/src/main/java/com/google/android/apps/muzei/legacy/SourceSetupActivity.kt
+++ b/legacy-standalone/src/main/java/com/google/android/apps/muzei/legacy/SourceSetupActivity.kt
@@ -24,10 +24,15 @@ import android.content.DialogInterface
 import android.content.Intent
 import android.net.Uri
 import android.os.Bundle
+import androidx.activity.result.component1
+import androidx.activity.result.component2
 import androidx.activity.result.contract.ActivityResultContracts.StartActivityForResult
 import androidx.appcompat.app.AppCompatActivity
 import androidx.fragment.app.DialogFragment
 import androidx.fragment.app.Fragment
+import androidx.fragment.app.FragmentFactory
+import androidx.fragment.app.add
+import androidx.fragment.app.commit
 import androidx.lifecycle.lifecycleScope
 import com.google.android.apps.muzei.api.provider.MuzeiArtProvider
 import com.google.android.material.dialog.MaterialAlertDialogBuilder
@@ -37,56 +42,64 @@ import net.nurik.roman.muzei.legacy.R
 class SourceSetupActivity : AppCompatActivity() {
 
     override fun onCreate(savedInstanceState: Bundle?) {
+        supportFragmentManager.fragmentFactory = object : FragmentFactory() {
+            override fun instantiate(classLoader: ClassLoader, className: String): Fragment {
+                return when (loadFragmentClass(classLoader, className)) {
+                    SourceWarningDialogFragment::class.java -> createSourceWarningDialog()
+                    else -> super.instantiate(classLoader, className)
+                }
+            }
+        }
         super.onCreate(savedInstanceState)
         if (savedInstanceState == null) {
-            SourceWarningDialogFragment().show(supportFragmentManager, "warning")
+            supportFragmentManager.commit {
+                add<SourceWarningDialogFragment>("warning")
+            }
         }
     }
 
-    override fun onAttachFragment(fragment: Fragment) {
-        if (fragment is SourceWarningDialogFragment) {
-            fragment.positiveListener = {
-                val database = LegacyDatabase.getInstance(this)
-                lifecycleScope.launch {
-                    val source = database.sourceDao().getCurrentSource()
-                    if (source != null) {
-                        setResult(Activity.RESULT_OK)
-                        finish()
-                    } else {
-                        // Push the user to the SourceSettingsActivity to select a source
-                        val intent = Intent(this@SourceSetupActivity,
-                                SourceSettingsActivity::class.java)
+    private fun createSourceWarningDialog() = SourceWarningDialogFragment(
+        positiveListener = {
+            val database = LegacyDatabase.getInstance(this)
+            lifecycleScope.launch {
+                val source = database.sourceDao().getCurrentSource()
+                if (source != null) {
+                    setResult(Activity.RESULT_OK)
+                    finish()
+                } else {
+                    // Push the user to the SourceSettingsActivity to select a source
+                    val intent = Intent(this@SourceSetupActivity,
+                            SourceSettingsActivity::class.java)
 
-                        if (getIntent().getBooleanExtra(
-                                        MuzeiArtProvider.EXTRA_FROM_MUZEI, false)) {
-                            intent.putExtra(MuzeiArtProvider.EXTRA_FROM_MUZEI, true)
-                        }
-                        startSettings.launch(intent)
+                    if (getIntent().getBooleanExtra(
+                                    MuzeiArtProvider.EXTRA_FROM_MUZEI, false)) {
+                        intent.putExtra(MuzeiArtProvider.EXTRA_FROM_MUZEI, true)
                     }
+                    startSettings.launch(intent)
                 }
             }
-            fragment.neutralListener = {
-                startActivity(Intent(Intent.ACTION_VIEW, Uri.parse(
-                        "https://medium.com/@ianhlake/muzei-3-0-and-legacy-sources-8261979e2264"))
-                        .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK))
-            }
-            fragment.negativeListener = {
-                finish()
-            }
-        }
-    }
+        },
+        neutralListener = {
+            startActivity(Intent(Intent.ACTION_VIEW, Uri.parse(
+                    "https://medium.com/@ianhlake/muzei-3-0-and-legacy-sources-8261979e2264"))
+                    .addFlags(Intent.FLAG_ACTIVITY_NEW_TASK))
+        },
+        negativeListener = {
+            finish()
+        })
 
-    private val startSettings = registerForActivityResult(StartActivityForResult()) { result ->
+    private val startSettings = registerForActivityResult(StartActivityForResult()) { (resultCode, _) ->
         // Pass on the resultCode from the SourceSettingsActivity onto Muzei
-        setResult(result.resultCode)
+        setResult(resultCode)
         finish()
     }
 }
 
-class SourceWarningDialogFragment : DialogFragment() {
-    var positiveListener : () -> Unit = {}
-    var neutralListener : () -> Unit = {}
-    var negativeListener : () -> Unit = {}
+class SourceWarningDialogFragment(
+        val positiveListener: () -> Unit = {},
+        val neutralListener: () -> Unit = {},
+        val negativeListener: () -> Unit = {}
+) : DialogFragment() {
 
     override fun onCreateDialog(savedInstanceState: Bundle?): Dialog {
         return MaterialAlertDialogBuilder(requireContext(), R.style.Theme_Legacy_Dialog)
diff --git a/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySettingsActivity.kt b/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySettingsActivity.kt
index 069ac4eb5..2b885c61e 100644
--- a/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySettingsActivity.kt
+++ b/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySettingsActivity.kt
@@ -100,8 +100,8 @@ private class ChoosePhotos : ActivityResultContract<Unit, List<Uri>>() {
                     .addCategory(Intent.CATEGORY_OPENABLE)
                     .putExtra(DocumentsContract.EXTRA_EXCLUDE_SELF, true)
 
-    override fun parseResult(resultCode: Int, intent: Intent?) =
-            openMultipleDocuments.parseResult(resultCode, intent) ?: emptyList()
+    override fun parseResult(resultCode: Int, intent: Intent?): List<Uri> =
+            openMultipleDocuments.parseResult(resultCode, intent)
 }
 
 private class ChooseFolder : ActivityResultContract<Unit, Uri?>() {
diff --git a/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySetupActivity.kt b/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySetupActivity.kt
index 5b349e299..e3a633eeb 100644
--- a/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySetupActivity.kt
+++ b/source-gallery/src/main/java/com/google/android/apps/muzei/gallery/GallerySetupActivity.kt
@@ -22,6 +22,8 @@ import android.content.Intent
 import android.content.pm.PackageManager
 import android.os.Build
 import android.os.Bundle
+import androidx.activity.result.component1
+import androidx.activity.result.component2
 import androidx.activity.result.contract.ActivityResultContract
 import androidx.activity.result.contract.ActivityResultContracts.RequestMultiplePermissions
 import androidx.activity.result.contract.ActivityResultContracts.StartActivityForResult
@@ -95,9 +97,9 @@ class GallerySetupActivity : FragmentActivity() {
         }
     }
 
-    private val startSettings = registerForActivityResult(StartActivityForResult()) { result ->
+    private val startSettings = registerForActivityResult(StartActivityForResult()) { (resultCode, _) ->
         // Pass on the resultCode from the GallerySettingsActivity onto Muzei
-        setResult(result.resultCode)
+        setResult(resultCode)
         finish()
     }
 }
diff --git a/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSettingsActivity.kt b/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSettingsActivity.kt
index d40fea4c5..1ab5e3b1c 100644
--- a/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSettingsActivity.kt
+++ b/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSettingsActivity.kt
@@ -16,35 +16,22 @@
 
 package com.google.android.apps.muzei.single
 
-import android.content.Context
-import android.content.Intent
-import android.net.Uri
 import android.os.Bundle
 import androidx.activity.ComponentActivity
-import androidx.activity.result.contract.ActivityResultContract
-import androidx.activity.result.contract.ActivityResultContracts
+import androidx.activity.result.contract.ActivityResultContracts.GetContent
 import androidx.activity.result.launch
+import androidx.activity.result.registerForActivityResult
 import androidx.lifecycle.lifecycleScope
 import com.google.android.apps.muzei.util.toast
 import kotlinx.coroutines.NonCancellable
 import kotlinx.coroutines.launch
 
-private class GetImage : ActivityResultContract<Unit, Uri?>() {
-    private val getContent = ActivityResultContracts.GetContent()
-
-    override fun createIntent(context: Context, input: Unit?) =
-            getContent.createIntent(context, "image/*")
-
-    override fun parseResult(resultCode: Int, intent: Intent?) =
-            getContent.parseResult(resultCode, intent)
-}
-
 /**
  * Settings Activity which allows users to select a new photo
  */
 class SingleSettingsActivity : ComponentActivity() {
 
-    private val getImage = registerForActivityResult(GetImage()) { uri ->
+    private val getImage = registerForActivityResult(GetContent(), "image/*") { uri ->
         if (uri != null) {
             lifecycleScope.launch(NonCancellable) {
                 val success = SingleArtProvider.setArtwork(
diff --git a/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSetupActivity.kt b/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSetupActivity.kt
index e4baf7ee0..c51cb9dec 100644
--- a/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSetupActivity.kt
+++ b/source-single/src/main/java/com/google/android/apps/muzei/single/SingleSetupActivity.kt
@@ -19,6 +19,8 @@ package com.google.android.apps.muzei.single
 import android.content.Intent
 import android.os.Bundle
 import androidx.activity.ComponentActivity
+import androidx.activity.result.component1
+import androidx.activity.result.component2
 import androidx.activity.result.contract.ActivityResultContracts.StartActivityForResult
 
 /**
@@ -26,9 +28,9 @@ import androidx.activity.result.contract.ActivityResultContracts.StartActivityFo
  */
 class SingleSetupActivity : ComponentActivity() {
 
-    private val selectImage = registerForActivityResult(StartActivityForResult()) { result ->
+    private val selectImage = registerForActivityResult(StartActivityForResult()) { (resultCode, _) ->
         // Pass on the resultCode from the SingleSettingsActivity onto Muzei
-        setResult(result.resultCode)
+        setResult(resultCode)
         finish()
     }
 
