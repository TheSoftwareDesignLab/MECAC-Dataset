diff --git a/focus-android/app/build.gradle b/focus-android/app/build.gradle
index cde8368e78d4..bd9225738638 100644
--- a/focus-android/app/build.gradle
+++ b/focus-android/app/build.gradle
@@ -18,6 +18,7 @@ android {
                        // override this with a generated versionCode at build time.
         versionName "8.13.1"
         testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
+        testInstrumentationRunnerArguments clearPackageData: 'true'
 
         multiDexEnabled true
     }
@@ -182,6 +183,7 @@ dependencies {
     androidTestImplementation "androidx.test.espresso:espresso-web:$espresso_version", {
         exclude group: 'com.android.support', module: 'support-annotations'
     }
+    androidTestImplementation "androidx.test.espresso:espresso-intents:$espresso_version"
 
     androidTestImplementation 'com.squareup.okhttp3:mockwebserver:3.11.0'
     testImplementation 'com.squareup.okhttp3:mockwebserver:3.11.0'
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/DownloadFileTest.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/DownloadFileTest.kt
index c6a0f86a1001..506e13eecb85 100644
--- a/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/DownloadFileTest.kt
+++ b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/DownloadFileTest.kt
@@ -1,49 +1,47 @@
-/* -*- Mode: Java; c-basic-offset: 4; tab-width: 4; indent-tabs-mode: nil; -*-
- * This Source Code Form is subject to the terms of the Mozilla Public
+/* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 package org.mozilla.focus.activity
 
-import android.os.Build
-import android.os.Build.VERSION
 import androidx.test.internal.runner.junit4.AndroidJUnit4ClassRunner
-import androidx.test.uiautomator.UiObject
-import androidx.test.uiautomator.UiObjectNotFoundException
-import androidx.test.uiautomator.UiSelector
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.rule.GrantPermissionRule
 import okhttp3.mockwebserver.MockResponse
 import okhttp3.mockwebserver.MockWebServer
 import org.junit.After
-import org.junit.Assert
-import org.junit.Assume
 import org.junit.Before
-import org.junit.Ignore
 import org.junit.Rule
 import org.junit.Test
 import org.junit.runner.RunWith
-import org.mozilla.focus.helpers.MainActivityFirstrunTestRule
+import org.mozilla.focus.activity.robots.downloadRobot
+import org.mozilla.focus.activity.robots.searchScreen
+import org.mozilla.focus.helpers.DeleteFilesHelper.deleteFileUsingDisplayName
+import org.mozilla.focus.helpers.MainActivityIntentsTestRule
 import org.mozilla.focus.helpers.TestHelper
-import org.mozilla.focus.helpers.TestHelper.pressBackKey
-import org.mozilla.focus.helpers.TestHelper.pressEnterKey
+import org.mozilla.focus.helpers.TestHelper.mDevice
 import org.mozilla.focus.helpers.TestHelper.readTestAsset
-import org.mozilla.focus.helpers.TestHelper.waitForWebContent
+import org.mozilla.focus.helpers.TestHelper.verifySnackBarText
 import org.mozilla.focus.helpers.TestHelper.waitingTime
 import java.io.IOException
 
-@Ignore("Flaky test, will be refactored")
 @RunWith(AndroidJUnit4ClassRunner::class)
-// @Ignore("This test was written specifically for WebView and needs to be adapted for GeckoView") // https://testrail.stage.mozaws.net/index.php?/cases/view/53141
 class DownloadFileTest {
-    private var webServer: MockWebServer? = null
+    private lateinit var webServer: MockWebServer
 
-    @get: Rule
-    var mActivityTestRule = MainActivityFirstrunTestRule(showFirstRun = false)
+    @get:Rule
+    var mActivityTestRule = MainActivityIntentsTestRule(showFirstRun = false)
+
+    @get:Rule
+    var mGrantPermissions = GrantPermissionRule.grant(
+        android.Manifest.permission.WRITE_EXTERNAL_STORAGE,
+        android.Manifest.permission.READ_EXTERNAL_STORAGE
+    )
 
     @Before
     fun setUp() {
-        Assume.assumeTrue(VERSION.SDK_INT >= Build.VERSION_CODES.N)
         webServer = MockWebServer()
         try {
-            webServer!!.enqueue(
+            webServer.enqueue(
                 MockResponse()
                     .setBody(readTestAsset("image_test.html"))
                     .addHeader(
@@ -51,23 +49,19 @@ class DownloadFileTest {
                         "sphere=battery; Expires=Wed, 21 Oct 2035 07:28:00 GMT;"
                     )
             )
-            webServer!!.enqueue(
-                MockResponse()
-                    .setBody(readTestAsset("rabbit.jpg"))
-            )
-            webServer!!.enqueue(
+            webServer.enqueue(
                 MockResponse()
                     .setBody(readTestAsset("download.jpg"))
             )
-            webServer!!.enqueue(
+            webServer.enqueue(
                 MockResponse()
                     .setBody(readTestAsset("download.jpg"))
             )
-            webServer!!.enqueue(
+            webServer.enqueue(
                 MockResponse()
                     .setBody(readTestAsset("download.jpg"))
             )
-            webServer!!.start()
+            webServer.start()
         } catch (e: IOException) {
             throw AssertionError("Could not start web server", e)
         }
@@ -75,62 +69,77 @@ class DownloadFileTest {
 
     @After
     fun tearDown() {
-        // If notification is still up, this will take it off screen
-        pressBackKey()
-        mActivityTestRule.activity.finishAndRemoveTask()
         try {
-            webServer!!.close()
-            webServer!!.shutdown()
+            webServer.close()
+            webServer.shutdown()
         } catch (e: IOException) {
             throw AssertionError("Could not stop web server", e)
         }
+        val context = InstrumentationRegistry.getInstrumentation().targetContext.applicationContext
+        deleteFileUsingDisplayName(context, "download.jpg")
     }
 
-    @Suppress("LongMethod")
     @Test
-    @Throws(UiObjectNotFoundException::class)
-    fun DownloadTest() {
-        val downloadIcon: UiObject
-        downloadIcon = TestHelper.mDevice.findObject(
-            UiSelector()
-                .resourceId("download")
-                .enabled(true)
-        )
+    fun downloadNotificationTest() {
+        val downloadPageUrl = webServer.url("").toString()
+        val downloadFileName = "download.jpg"
 
         // Load website with service worker
-        TestHelper.inlineAutocompleteEditText.waitForExists(waitingTime)
-        TestHelper.inlineAutocompleteEditText.clearTextField()
-        TestHelper.inlineAutocompleteEditText.text = webServer!!.url(TEST_PATH).toString()
-        TestHelper.hint.waitForExists(waitingTime)
-        pressEnterKey()
-        waitForWebContent()
-        TestHelper.progressBar.waitUntilGone(waitingTime)
-        downloadIcon.click()
+        searchScreen {
+        }.loadPage(downloadPageUrl) { }
+
+        downloadRobot {
+            clickDownloadIconAsset()
+            // If permission dialog appears, grant it
+            if (TestHelper.permAllowBtn.waitForExists(waitingTime)) {
+                TestHelper.permAllowBtn.click()
+            }
+            verifyDownloadDialog(downloadFileName)
+            clickDownloadButton()
+            verifySnackBarText("finished")
+            mDevice.openNotification()
+            verifyDownloadNotification()
+        }
+    }
+
+    @Test
+    fun cancelDownloadTest() {
+        val downloadPageUrl = webServer.url("").toString()
+
+        searchScreen {
+        }.loadPage(downloadPageUrl) { }
 
-        // If permission dialog appears, grant it
-        if (TestHelper.permAllowBtn.waitForExists(waitingTime)) {
-            TestHelper.permAllowBtn.click()
+        downloadRobot {
+            clickDownloadIconAsset()
+            // If permission dialog appears, grant it
+            if (TestHelper.permAllowBtn.waitForExists(waitingTime)) {
+                TestHelper.permAllowBtn.click()
+            }
+            clickCancelDownloadButton()
+            verifyDownloadDialogGone()
         }
-        TestHelper.downloadTitle.waitForExists(waitingTime)
-        Assert.assertTrue(TestHelper.downloadTitle.isEnabled)
-        Assert.assertTrue(TestHelper.downloadCancelBtn.isEnabled)
-        Assert.assertTrue(TestHelper.downloadBtn.isEnabled)
-        Assert.assertEquals(TestHelper.downloadFileName.text, "download.jpg")
-        Assert.assertEquals(
-            TestHelper.downloadWarning.text,
-            "Downloaded files will not be deleted when you erase Firefox Focus history."
-        )
-        TestHelper.downloadBtn.click()
-        TestHelper.completedMsg.waitForExists(waitingTime)
-        Assert.assertTrue(TestHelper.completedMsg.isEnabled)
-        Assert.assertTrue(TestHelper.completedMsg.text.contains("finished"))
-        TestHelper.mDevice.openNotification()
-        TestHelper.mDevice.waitForIdle()
-        TestHelper.savedNotification.waitForExists(waitingTime)
-        TestHelper.savedNotification.swipeRight(50)
     }
 
-    companion object {
-        private const val TEST_PATH = "/"
+    @Test
+    fun openDownloadFileTest() {
+        val downloadPageUrl = webServer.url("").toString()
+        val downloadFileName = "download.jpg"
+
+        // Load website with service worker
+        searchScreen {
+        }.loadPage(downloadPageUrl) { }
+
+        downloadRobot {
+            clickDownloadIconAsset()
+            // If permission dialog appears, grant it
+            if (TestHelper.permAllowBtn.waitForExists(waitingTime)) {
+                TestHelper.permAllowBtn.click()
+            }
+            verifyDownloadDialog(downloadFileName)
+            clickDownloadButton()
+            verifySnackBarText("finished")
+            openDownloadedFile()
+            verifyPhotosOpens()
+        }
     }
 }
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/DownloadRobot.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/DownloadRobot.kt
new file mode 100644
index 000000000000..2f05409f9ff3
--- /dev/null
+++ b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/DownloadRobot.kt
@@ -0,0 +1,103 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+package org.mozilla.focus.activity.robots
+
+import androidx.test.espresso.intent.Intents
+import androidx.test.espresso.intent.matcher.IntentMatchers
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.uiautomator.UiDevice
+import androidx.test.uiautomator.UiObject
+import androidx.test.uiautomator.UiSelector
+import org.junit.Assert.assertTrue
+import org.mozilla.focus.R
+import org.mozilla.focus.helpers.SessionLoadedIdlingResource
+import org.mozilla.focus.helpers.TestHelper.appName
+import org.mozilla.focus.helpers.TestHelper.getStringResource
+import org.mozilla.focus.helpers.TestHelper.isPackageInstalled
+import org.mozilla.focus.helpers.TestHelper.mDevice
+import org.mozilla.focus.helpers.TestHelper.waitingTime
+import org.mozilla.focus.helpers.TestHelper.webPageLoadwaitingTime
+
+class DownloadRobot {
+    fun verifyDownloadDialog(fileName: String) {
+        assertTrue(downloadDialogTitle.waitForExists(waitingTime))
+        assertTrue(downloadCancelBtn.exists())
+        assertTrue(downloadBtn.exists())
+        assertTrue(downloadFileName.text.contains(fileName))
+    }
+
+    fun verifyDownloadDialogGone() = assertTrue(downloadDialogTitle.waitUntilGone(waitingTime))
+
+    fun verifyDownloadNotification() = NotificationRobot().verifySystemNotificationExists(downloadNotificationText)
+
+    fun verifyPhotosOpens() = assertPhotosOpens()
+
+    fun clickDownloadIconAsset() {
+        val sessionLoadedIdlingResource = SessionLoadedIdlingResource()
+        runWithIdleRes(sessionLoadedIdlingResource) {
+            downloadIconAsset.waitForExists(webPageLoadwaitingTime)
+            downloadIconAsset.click()
+        }
+    }
+
+    fun clickDownloadButton() {
+        downloadBtn.waitForExists(waitingTime)
+        downloadBtn.click()
+    }
+
+    fun clickCancelDownloadButton() {
+        downloadCancelBtn.waitForExists(waitingTime)
+        downloadCancelBtn.click()
+    }
+
+    fun openDownloadedFile() {
+        val snackBarButton = mDevice.findObject(UiSelector().resourceId("$appName:id/snackbar_action"))
+        snackBarButton.waitForExists(waitingTime)
+        snackBarButton.clickAndWaitForNewWindow(webPageLoadwaitingTime)
+    }
+
+    class Transition
+}
+
+fun downloadRobot(interact: DownloadRobot.() -> Unit): DownloadRobot.Transition {
+    DownloadRobot().interact()
+    return DownloadRobot.Transition()
+}
+
+val downloadIconAsset: UiObject = mDevice.findObject(
+    UiSelector()
+        .resourceId("download")
+)
+
+private val downloadDialogTitle = mDevice.findObject(
+    UiSelector()
+        .resourceId("$appName:id/title")
+)
+
+private val downloadFileName = mDevice.findObject(
+    UiSelector()
+        .resourceId("$appName:id/filename")
+)
+
+private val downloadCancelBtn = mDevice.findObject(
+    UiSelector()
+        .resourceId("$appName:id/close_button")
+)
+
+private val downloadBtn = mDevice.findObject(
+    UiSelector()
+        .resourceId("$appName:id/download_button")
+)
+
+private val downloadNotificationText = getStringResource(R.string.mozac_feature_downloads_completed_notification_text2)
+
+private fun assertPhotosOpens() {
+    val googleAppsPhotos = "com.google.android.apps.photos"
+    if (isPackageInstalled(googleAppsPhotos)) {
+        Intents.intended(IntentMatchers.toPackage(googleAppsPhotos))
+    } else {
+        val mDevice = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
+        mDevice.findObject(UiSelector().textContains("No app found")).waitForExists(waitingTime)
+    }
+}
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/NotificationRobot.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/NotificationRobot.kt
new file mode 100644
index 000000000000..0fba8eb27054
--- /dev/null
+++ b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/NotificationRobot.kt
@@ -0,0 +1,48 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+package org.mozilla.focus.activity.robots
+
+import android.util.Log
+import androidx.test.uiautomator.UiObjectNotFoundException
+import androidx.test.uiautomator.UiScrollable
+import androidx.test.uiautomator.UiSelector
+import org.junit.Assert.assertTrue
+import org.mozilla.focus.helpers.TestHelper
+import org.mozilla.focus.helpers.TestHelper.mDevice
+
+class NotificationRobot {
+    fun verifySystemNotificationExists(notificationMessage: String) {
+        var notificationTray =
+            mDevice.findObject(
+                UiSelector().resourceId("com.android.systemui:id/notification_stack_scroller")
+            )
+
+        if (notificationTray.isScrollable) {
+            notificationTray = UiScrollable(
+                UiSelector().resourceId("com.android.systemui:id/notification_stack_scroller")
+            )
+
+            var notificationFound = false
+
+            do {
+                try {
+                    notificationFound = notificationTray.getChildByText(
+                        UiSelector().text(notificationMessage), notificationMessage, true
+                    ).waitForExists(TestHelper.waitingTime)
+                    assertTrue(notificationFound)
+                } catch (e: UiObjectNotFoundException) {
+                    Log.d("TestLog", e.message.toString())
+                    // scrolls down the notifications until it reaches the end, then it will close
+                    notificationTray.scrollForward()
+                    mDevice.waitForIdle()
+                }
+            } while (!notificationFound)
+        } else {
+            val notificationFound =
+                notificationTray.getChild(UiSelector().textContains(notificationMessage)).exists()
+            assertTrue(notificationFound)
+        }
+    }
+}
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/SearchRobot.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/SearchRobot.kt
index b57cab70af32..bd50bd3550f0 100644
--- a/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/SearchRobot.kt
+++ b/focus-android/app/src/androidTest/java/org/mozilla/focus/activity/robots/SearchRobot.kt
@@ -12,9 +12,12 @@ import androidx.test.uiautomator.UiSelector
 import org.junit.Assert.assertFalse
 import org.junit.Assert.assertTrue
 import org.mozilla.focus.R
+import org.mozilla.focus.helpers.SessionLoadedIdlingResource
 import org.mozilla.focus.helpers.TestHelper.appName
 import org.mozilla.focus.helpers.TestHelper.mDevice
+import org.mozilla.focus.helpers.TestHelper.pressEnterKey
 import org.mozilla.focus.helpers.TestHelper.waitingTime
+import org.mozilla.focus.helpers.TestHelper.webPageLoadwaitingTime
 
 class SearchRobot {
 
@@ -29,7 +32,7 @@ class SearchRobot {
     // Would you like to turn on search suggestions? Yes No
     // fresh install only
     fun allowEnableSearchSuggestions() {
-        if (searchSuggestionsTitle.exists()) {
+        if (searchSuggestionsTitle.waitForExists(waitingTime)) {
             searchSuggestionsButtonYes.waitForExists(waitingTime)
             searchSuggestionsButtonYes.click()
         }
@@ -56,7 +59,27 @@ class SearchRobot {
 
     fun clearSearchBar() = clearSearchButton.perform(click())
 
-    class Transition
+    class Transition {
+        fun loadPage(url: String, interact: BrowserRobot.() -> Unit): BrowserRobot.Transition {
+            val sessionLoadedIdlingResource = SessionLoadedIdlingResource()
+
+            searchScreen { typeInSearchBar(url) }
+            pressEnterKey()
+
+            runWithIdleRes(sessionLoadedIdlingResource) {
+                assertTrue(
+                    BrowserRobot().progressBar.waitUntilGone(webPageLoadwaitingTime)
+                )
+                assertTrue(
+                    mDevice.findObject(UiSelector().resourceId("$appName:id/webview"))
+                        .waitForExists(webPageLoadwaitingTime)
+                )
+            }
+
+            BrowserRobot().interact()
+            return BrowserRobot.Transition()
+        }
+    }
 }
 
 fun searchScreen(interact: SearchRobot.() -> Unit): SearchRobot.Transition {
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/DeleteFilesHelper.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/DeleteFilesHelper.kt
new file mode 100644
index 000000000000..400e3d3d0f28
--- /dev/null
+++ b/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/DeleteFilesHelper.kt
@@ -0,0 +1,48 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+package org.mozilla.focus.helpers
+
+import android.content.Context
+import android.database.Cursor
+import android.net.Uri
+import android.provider.MediaStore
+import android.util.Log
+
+object DeleteFilesHelper {
+    fun deleteFileUsingDisplayName(context: Context, displayName: String): Boolean {
+        val uri = getUriFromDisplayName(context, displayName)
+        if (uri != null) {
+            val resolver = context.contentResolver
+            val selectionArgs = arrayOf(displayName)
+            resolver.delete(
+                uri,
+                MediaStore.Files.FileColumns.DISPLAY_NAME + "=?",
+                selectionArgs
+            )
+            Log.d("TestLog", "Download file deleted")
+            return true
+        }
+        Log.d("TestLog", "Download file could not be found")
+        return false
+    }
+
+    private fun getUriFromDisplayName(context: Context, displayName: String): Uri? {
+        val projection = arrayOf(MediaStore.Files.FileColumns._ID)
+        val extUri: Uri = MediaStore.Files.getContentUri("external")
+        val cursor: Cursor = context.contentResolver.query(
+            extUri, projection,
+            MediaStore.Files.FileColumns.DISPLAY_NAME + " LIKE ?", arrayOf(displayName), null
+        )!!
+        cursor.moveToFirst()
+        return if (cursor.count > 0) {
+            val columnIndex: Int = cursor.getColumnIndex(projection[0])
+            val fileId: Long = cursor.getLong(columnIndex)
+            cursor.close()
+            Uri.parse("$extUri/$fileId")
+        } else {
+            null
+        }
+    }
+}
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/MainActivityFirstrunTestRule.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/MainActivityFirstrunTestRule.kt
deleted file mode 100644
index 28ff3bac6611..000000000000
--- a/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/MainActivityFirstrunTestRule.kt
+++ /dev/null
@@ -1,46 +0,0 @@
-/* This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
-
-package org.mozilla.focus.helpers
-
-import androidx.annotation.CallSuper
-import androidx.preference.PreferenceManager
-import androidx.test.platform.app.InstrumentationRegistry
-import androidx.test.rule.ActivityTestRule
-import mozilla.components.support.utils.ThreadUtils
-import org.mozilla.focus.activity.MainActivity
-import org.mozilla.focus.ext.components
-import org.mozilla.focus.fragment.FirstrunFragment.Companion.FIRSTRUN_PREF
-
-open class MainActivityFirstrunTestRule(launchActivity: Boolean = true, private val showFirstRun: Boolean) :
-    ActivityTestRule<MainActivity>(MainActivity::class.java, launchActivity) {
-
-    @CallSuper
-    override fun beforeActivityLaunched() {
-        super.beforeActivityLaunched()
-
-        val appContext = InstrumentationRegistry.getInstrumentation()
-            .targetContext
-            .applicationContext
-
-        PreferenceManager.getDefaultSharedPreferences(appContext)
-            .edit()
-            .putBoolean(FIRSTRUN_PREF, !showFirstRun)
-            .apply()
-    }
-
-    override fun afterActivityFinished() {
-        super.afterActivityFinished()
-
-        ThreadUtils.postToMainThread {
-            InstrumentationRegistry
-                .getInstrumentation()
-                .targetContext
-                .applicationContext
-                .components
-                .tabsUseCases
-                .removeAllTabs()
-        }
-    }
-}
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/MainActivityTestRule.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/MainActivityTestRule.kt
new file mode 100644
index 000000000000..fa85f43ec85c
--- /dev/null
+++ b/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/MainActivityTestRule.kt
@@ -0,0 +1,99 @@
+/* This Source Code Form is subject to the terms of the Mozilla Public
+ * License, v. 2.0. If a copy of the MPL was not distributed with this
+ * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
+
+package org.mozilla.focus.helpers
+
+import androidx.annotation.CallSuper
+import androidx.preference.PreferenceManager
+import androidx.test.espresso.intent.rule.IntentsTestRule
+import androidx.test.platform.app.InstrumentationRegistry
+import androidx.test.rule.ActivityTestRule
+import androidx.test.uiautomator.UiDevice
+import androidx.test.uiautomator.UiSelector
+import mozilla.components.support.utils.ThreadUtils
+import org.mozilla.focus.activity.MainActivity
+import org.mozilla.focus.ext.components
+import org.mozilla.focus.fragment.FirstrunFragment.Companion.FIRSTRUN_PREF
+import org.mozilla.focus.helpers.TestHelper.pressBackKey
+
+// Basic Test rule with pref to skip the onboarding screen
+open class MainActivityFirstrunTestRule(launchActivity: Boolean = true, private val showFirstRun: Boolean) :
+    ActivityTestRule<MainActivity>(MainActivity::class.java, launchActivity) {
+
+    @CallSuper
+    override fun beforeActivityLaunched() {
+        super.beforeActivityLaunched()
+
+        val appContext = InstrumentationRegistry.getInstrumentation()
+            .targetContext
+            .applicationContext
+
+        PreferenceManager.getDefaultSharedPreferences(appContext)
+            .edit()
+            .putBoolean(FIRSTRUN_PREF, !showFirstRun)
+            .apply()
+    }
+
+    override fun afterActivityFinished() {
+        super.afterActivityFinished()
+
+        ThreadUtils.postToMainThread {
+            InstrumentationRegistry
+                .getInstrumentation()
+                .targetContext
+                .applicationContext
+                .components
+                .tabsUseCases
+                .removeAllTabs()
+        }
+
+        closeNotificationShade()
+    }
+}
+
+// Test rule that allows usage of Espresso Intents
+open class MainActivityIntentsTestRule(launchActivity: Boolean = true, private val showFirstRun: Boolean) :
+    IntentsTestRule<MainActivity>(MainActivity::class.java, launchActivity) {
+
+    @CallSuper
+    override fun beforeActivityLaunched() {
+        super.beforeActivityLaunched()
+
+        val appContext = InstrumentationRegistry.getInstrumentation()
+            .targetContext
+            .applicationContext
+
+        PreferenceManager.getDefaultSharedPreferences(appContext)
+            .edit()
+            .putBoolean(FIRSTRUN_PREF, !showFirstRun)
+            .apply()
+    }
+
+    override fun afterActivityFinished() {
+        super.afterActivityFinished()
+
+        ThreadUtils.postToMainThread {
+            InstrumentationRegistry
+                .getInstrumentation()
+                .targetContext
+                .applicationContext
+                .components
+                .tabsUseCases
+                .removeAllTabs()
+        }
+
+        closeNotificationShade()
+    }
+}
+
+// Some tests will leave the notification shade open if they fail, needs to be closed before the next tests
+private fun closeNotificationShade() {
+    val mDevice = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
+    if (mDevice.findObject(
+            UiSelector().resourceId("com.android.systemui:id/notification_stack_scroller")
+        ).exists()
+    ) {
+        pressBackKey()
+    }
+}
diff --git a/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/TestHelper.kt b/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/TestHelper.kt
index c63793594692..98a64eb27e1e 100644
--- a/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/TestHelper.kt
+++ b/focus-android/app/src/androidTest/java/org/mozilla/focus/helpers/TestHelper.kt
@@ -1,13 +1,14 @@
-/* -*- Mode: Java; c-basic-offset: 4; tab-width: 20; indent-tabs-mode: nil; -*-
- * This Source Code Form is subject to the terms of the Mozilla Public
+/* This Source Code Form is subject to the terms of the Mozilla Public
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 package org.mozilla.focus.helpers
 
 import android.content.Context
+import android.content.pm.PackageManager
 import android.content.res.Resources
 import android.text.format.DateUtils
 import android.util.DisplayMetrics
+import android.util.Log
 import android.view.KeyEvent
 import androidx.test.espresso.Espresso
 import androidx.test.espresso.matcher.ViewMatchers
@@ -22,6 +23,7 @@ import okio.Buffer
 import okio.Okio
 import org.hamcrest.Matchers
 import org.junit.Assert
+import org.junit.Assert.assertTrue
 import org.mozilla.focus.R
 import org.mozilla.focus.utils.AppConstants.isKlarBuild
 import java.io.BufferedReader
@@ -33,7 +35,6 @@ import java.io.InputStreamReader
 import java.nio.charset.StandardCharsets
 
 @Suppress("TooManyFunctions")
-// This test visits each page and checks whether some essential elements are being displayed
 object TestHelper {
     @JvmField
     var mDevice = UiDevice.getInstance(InstrumentationRegistry.getInstrumentation())
@@ -45,6 +46,29 @@ object TestHelper {
         get() = InstrumentationRegistry.getInstrumentation()
             .targetContext.packageName
 
+    @JvmStatic
+    val appContext = InstrumentationRegistry.getInstrumentation().targetContext.applicationContext
+
+    fun getStringResource(id: Int) = appContext.getString(id)
+
+    fun verifySnackBarText(text: String) {
+        val snackbarText = mDevice.findObject(
+            UiSelector().resourceId("$appName:id/snackbar_text")
+        )
+        snackbarText.waitForExists(waitingTime)
+        assertTrue(snackbarText.text.contains(text))
+    }
+
+    fun isPackageInstalled(packageName: String): Boolean {
+        return try {
+            val packageManager = InstrumentationRegistry.getInstrumentation().context.packageManager
+            packageManager.getApplicationInfo(packageName, 0).enabled
+        } catch (exception: PackageManager.NameNotFoundException) {
+            Log.d("TestLog", exception.message.toString())
+            false
+        }
+    }
+
     // wait for web area to be visible
     @JvmStatic
     fun waitForWebContent() {
@@ -121,7 +145,7 @@ object TestHelper {
     @JvmField
     var permAllowBtn = mDevice.findObject(
         UiSelector()
-            .resourceId("com.android.packageinstaller:id/permission_allow_button")
+            .textContains("Allow")
             .clickable(true)
     )
 
@@ -320,27 +344,6 @@ object TestHelper {
             .enabled(true)
     )
 
-    @JvmField
-    var downloadFileName = mDevice.findObject(
-        UiSelector()
-            .resourceId(appName + ":id/download_dialog_file_name")
-            .enabled(true)
-    )
-
-    @JvmField
-    var downloadWarning = mDevice.findObject(
-        UiSelector()
-            .resourceId(appName + ":id/download_dialog_warning")
-            .enabled(true)
-    )
-
-    @JvmField
-    var downloadCancelBtn = mDevice.findObject(
-        UiSelector()
-            .resourceId(appName + ":id/download_dialog_cancel")
-            .enabled(true)
-    )
-
     @JvmField
     var downloadBtn = mDevice.findObject(
         UiSelector()
@@ -348,13 +351,6 @@ object TestHelper {
             .enabled(true)
     )
 
-    @JvmField
-    var completedMsg = mDevice.findObject(
-        UiSelector()
-            .resourceId(appName + ":id/snackbar_text")
-            .enabled(true)
-    )
-
     /********* Main View Menu Item Locators  */
     var whatsNewItem = mDevice.findObject(
         UiSelector()
