diff --git a/focus-android/app/build.gradle b/focus-android/app/build.gradle
index 3c9f220c0b0d..651399a6cd0d 100644
--- a/focus-android/app/build.gradle
+++ b/focus-android/app/build.gradle
@@ -19,7 +19,7 @@ android {
         targetSdkVersion 28
         versionCode 11 // This versionCode is "frozen" for local builds. For "release" builds we
                        // override this with a generated versionCode at build time.
-        versionName "8.0.16"
+        versionName "8.0.17"
         testInstrumentationRunner "androidx.test.runner.AndroidJUnitRunner"
 
         multiDexEnabled true
@@ -60,7 +60,7 @@ android {
         }
     }
 
-    flavorDimensions "product", "abi"
+    flavorDimensions "product"
 
     productFlavors {
         // In most countries we are Firefox Focus - but in some we need to be Firefox Klar
@@ -74,24 +74,15 @@ android {
 
             applicationIdSuffix ".klar"
         }
+    }
 
-        arm {
-            dimension "abi"
-            ndk {
-                abiFilter "armeabi-v7a"
-            }
-        }
-        aarch64 {
-            dimension "abi"
-            ndk {
-                abiFilter "arm64-v8a"
-            }
-        }
-        x86 {
-            dimension "abi"
-            ndk {
-                abiFilter "x86"
-            }
+    splits {
+        abi {
+            enable true
+
+            reset()
+
+            include "x86", "armeabi-v7a", "arm64-v8a"
         }
     }
 
@@ -106,35 +97,21 @@ android {
         }
 
         // Release
-        focusX86Release.root = 'src/focusRelease'
-        focusArmRelease.root = 'src/focusRelease'
-        focusAarch64Release.root = 'src/focusRelease'
-
-        klarX86Release.root = 'src/klarRelease'
-        klarArmRelease.root = 'src/klarRelease'
-        klarAarch64Release.root = 'src/klarRelease'
+        focusRelease.root = 'src/focusRelease'
+        klarRelease.root = 'src/klarRelease'
 
         // Debug
-        focusX86Debug.root = 'src/focusDebug'
-        focusArmDebug.root = 'src/focusDebug'
-        focusAarch64Debug.root = 'src/focusDebug'
-
-        klarX86Debug.root = 'src/klarDebug'
-        klarArmDebug.root = 'src/klarDebug'
-        klarAarch64Debug.root = 'src/klarDebug'
+        focusDebug.root = 'src/focusDebug'
+        klarDebug.root = 'src/klarDebug'
 
         // Nightly
-        focusX86Nightly.root = 'src/focusNightly'
-        focusArmNightly.root = 'src/focusNightly'
-        focusAarch64Nightly.root = 'src/focusNightly'
-
-        klarX86Nightly.root = 'src/klarNightly'
-        klarArmNightly.root = 'src/klarNightly'
-        klarAarch64Nightly.root = 'src/klarNightly'
+        focusNightly.root = 'src/focusNightly'
+        klarNightly.root = 'src/klarNightly'
     }
 
     packagingOptions {
         exclude 'META-INF/atomicfu.kotlin_module'
+        exclude 'META-INF/proguard/coroutines.pro'
     }
 }
 
@@ -153,7 +130,7 @@ dependencies {
     implementation "androidx.recyclerview:recyclerview:$support_libraries_version"
     implementation "androidx.legacy:legacy-support-v4:$support_libraries_version"
     implementation "androidx.preference:preference:$support_libraries_version"
-    implementation 'io.sentry:sentry-android:1.7.9'
+    implementation 'io.sentry:sentry-android:1.7.10'
 
     implementation "androidx.lifecycle:lifecycle-extensions:$architecture_components_version"
 
@@ -161,24 +138,25 @@ dependencies {
     compileOnly "com.github.spotbugs:spotbugs-annotations:$spotbugs_version"
     implementation("com.google.code.findbugs:jsr305:3.0.2")
 
-    implementation "org.mozilla.components:browser-session:$mozilla_components_version"
     implementation "org.mozilla.components:browser-domains:$mozilla_components_version"
+    implementation "org.mozilla.components:browser-errorpages:$mozilla_components_version"
     implementation "org.mozilla.components:browser-search:$mozilla_components_version"
-    implementation "org.mozilla.components:feature-customtabs:$mozilla_components_version"
+    implementation "org.mozilla.components:browser-session:$mozilla_components_version"
+    implementation "org.mozilla.components:browser-state:$mozilla_components_version"
     implementation "org.mozilla.components:concept-engine:$mozilla_components_version"
-    implementation "org.mozilla.components:ui-autocomplete:$mozilla_components_version"
-    implementation "org.mozilla.components:ui-colors:$mozilla_components_version"
+    implementation "org.mozilla.components:feature-customtabs:$mozilla_components_version"
+    implementation "org.mozilla.components:lib-crash:$mozilla_components_version"
+    implementation "org.mozilla.components:lib-fetch-httpurlconnection:$mozilla_components_version"
     implementation "org.mozilla.components:service-telemetry:$mozilla_components_version"
-    implementation "org.mozilla.components:browser-errorpages:$mozilla_components_version"
     implementation "org.mozilla.components:service-fretboard:$mozilla_components_version", {
         exclude group: 'android.arch.work', module: 'work-runtime'
     }
     implementation "org.mozilla.components:support-ktx:$mozilla_components_version"
     implementation "org.mozilla.components:support-utils:$mozilla_components_version"
-    implementation "org.mozilla.components:lib-crash:$mozilla_components_version"
-    implementation "org.mozilla.components:lib-fetch-httpurlconnection:$mozilla_components_version"
+    implementation "org.mozilla.components:ui-autocomplete:$mozilla_components_version"
+    implementation "org.mozilla.components:ui-colors:$mozilla_components_version"
 
-    implementation 'com.squareup.okhttp3:okhttp:3.11.0'
+    implementation 'com.squareup.okhttp3:okhttp:3.14.1'
 
     implementation "org.jetbrains.kotlin:kotlin-stdlib-jdk7:$kotlin_version"
     implementation "org.jetbrains.kotlinx:kotlinx-coroutines-core:$coroutines_version"
@@ -187,7 +165,8 @@ dependencies {
     focusImplementation 'com.adjust.sdk:adjust-android:4.11.4'
     focusImplementation 'com.android.installreferrer:installreferrer:1.0' // Required by Adjust
 
-    implementation "org.mozilla.components:browser-engine-gecko-beta:$mozilla_components_version"
+    implementation "org.mozilla.components:browser-engine-gecko-nightly:$mozilla_components_version"
+    implementation "org.mozilla.geckoview:geckoview-nightly:$gecko_nightly_version"
     implementation "androidx.palette:palette:$support_libraries_version"
 
     testImplementation "org.junit.jupiter:junit-jupiter-api:5.3.1"
@@ -219,12 +198,12 @@ dependencies {
         exclude group: 'com.android.support', module: 'design'
         exclude group: 'com.android.support', module: 'recyclerview-v7'
     }
-    implementation 'androidx.test:runner:1.1.0-alpha4'
-    testImplementation 'androidx.test:rules:1.1.0-alpha4'
+    implementation 'androidx.test:runner:1.2.0'
+    testImplementation 'androidx.test:rules:1.2.0'
 
     implementation 'androidx.constraintlayout:constraintlayout:1.1.3'
     implementation 'com.jakewharton:process-phoenix:2.0.0'
-    debugImplementation 'com.facebook.stetho:stetho:1.5.0'
+    debugImplementation 'com.facebook.stetho:stetho:1.5.1'
 }
 // -------------------------------------------------------------------------------------------------
 //  Dynamically set versionCode (See tools/build/versionCode.gradle
diff --git a/focus-android/app/src/main/AndroidManifest.xml b/focus-android/app/src/main/AndroidManifest.xml
index 8ca0f0245cca..2bb9233d060e 100644
--- a/focus-android/app/src/main/AndroidManifest.xml
+++ b/focus-android/app/src/main/AndroidManifest.xml
@@ -29,16 +29,6 @@
         android:name=".FocusApplication"
         android:usesCleartextTraffic="true">
 
-        <provider
-            android:name="androidx.core.content.FileProvider"
-            android:authorities="${applicationId}.fileprovider"
-            android:exported="false"
-            android:grantUriPermissions="true">
-            <meta-data
-                android:name="android.support.FILE_PROVIDER_PATHS"
-                android:resource="@xml/provider_paths"/>
-        </provider>
-
         <activity android:name=".activity.IntentReceiverActivity">
             <intent-filter>
                 <action android:name="android.intent.action.VIEW" />
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/fragment/BrowserFragment.kt b/focus-android/app/src/main/java/org/mozilla/focus/fragment/BrowserFragment.kt
index c915a8ea4801..7c4ad92305b2 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/fragment/BrowserFragment.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/fragment/BrowserFragment.kt
@@ -420,7 +420,7 @@ class BrowserFragment : WebFragment(), LifecycleObserver, View.OnClickListener,
             closeButton.setImageDrawable(closeIcon)
         }
 
-        if (customTabConfig.disableUrlbarHiding) {
+        if (!customTabConfig.enableUrlbarHiding) {
             val params = urlBar!!.layoutParams as AppBarLayout.LayoutParams
             params.scrollFlags = 0
         }
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/fragment/UrlInputFragment.kt b/focus-android/app/src/main/java/org/mozilla/focus/fragment/UrlInputFragment.kt
index a08fdbcfe0ad..e0c7bf8aa3bf 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/fragment/UrlInputFragment.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/fragment/UrlInputFragment.kt
@@ -251,7 +251,7 @@ class UrlInputFragment :
         homeViewTipsLabel.setText(tipText, TextView.BufferType.SPANNABLE)
 
         val deepLinkAction = object : ClickableSpan() {
-            override fun onClick(widget: View?) {
+            override fun onClick(p0: View) {
                 tip.deepLink.invoke()
             }
         }
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/gecko/GeckoViewPrompt.java b/focus-android/app/src/main/java/org/mozilla/focus/gecko/GeckoViewPrompt.java
deleted file mode 100644
index 10e20d4a176c..000000000000
--- a/focus-android/app/src/main/java/org/mozilla/focus/gecko/GeckoViewPrompt.java
+++ /dev/null
@@ -1,914 +0,0 @@
-/* This Source Code Form is subject to the terms of the Mozilla Public
- * License, v. 2.0. If a copy of the MPL was not distributed with this
- * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
-
-package org.mozilla.focus.gecko;
-
-import android.app.Activity;
-import android.app.AlertDialog;
-import android.content.ActivityNotFoundException;
-import android.content.ClipData;
-import android.content.Context;
-import android.content.DialogInterface;
-import android.content.Intent;
-import android.content.res.TypedArray;
-import android.graphics.Color;
-import android.graphics.PorterDuff;
-import android.net.Uri;
-import android.os.Build;
-import android.text.InputType;
-import android.text.format.DateFormat;
-import android.util.Log;
-import android.view.InflateException;
-import android.view.LayoutInflater;
-import android.view.View;
-import android.view.ViewGroup;
-import android.widget.AdapterView;
-import android.widget.ArrayAdapter;
-import android.widget.CheckBox;
-import android.widget.CheckedTextView;
-import android.widget.CompoundButton;
-import android.widget.DatePicker;
-import android.widget.EditText;
-import android.widget.FrameLayout;
-import android.widget.ImageView;
-import android.widget.LinearLayout;
-import android.widget.ListView;
-import android.widget.ScrollView;
-import android.widget.Spinner;
-import android.widget.TextView;
-import android.widget.TimePicker;
-
-import org.mozilla.focus.R;
-import org.mozilla.geckoview.GeckoResult;
-import org.mozilla.geckoview.GeckoSession;
-import org.mozilla.geckoview.AllowOrDeny;
-import org.mozilla.geckoview.GeckoSession.PermissionDelegate.MediaSource;
-
-import java.text.ParseException;
-import java.text.SimpleDateFormat;
-import java.util.ArrayList;
-import java.util.Calendar;
-import java.util.Date;
-import java.util.Locale;
-
-public final class GeckoViewPrompt implements GeckoSession.PromptDelegate {
-    protected static final String LOGTAG = "GeckoViewPrompt";
-
-    private final Activity mActivity;
-    public int filePickerRequestCode = 1;
-    private int mFileType;
-    private FileCallback mFileCallback;
-
-    private static class ModifiableChoice {
-        public boolean modifiableSelected;
-        public String modifiableLabel;
-        public final Choice choice;
-
-        public ModifiableChoice(Choice c) {
-            choice = c;
-            modifiableSelected = choice.selected;
-            modifiableLabel = choice.label;
-        }
-    }
-
-    public GeckoViewPrompt(final Activity activity) {
-        mActivity = activity;
-    }
-
-    private AlertDialog.Builder addCheckbox(final AlertDialog.Builder builder,
-                                            ViewGroup parent,
-                                            final AlertCallback callback) {
-        if (!callback.hasCheckbox()) {
-            return builder;
-        }
-        final CheckBox checkbox = new CheckBox(builder.getContext());
-        if (callback.getCheckboxMessage() != null) {
-            checkbox.setText(callback.getCheckboxMessage());
-        }
-        checkbox.setChecked(callback.getCheckboxValue());
-        checkbox.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
-            @Override
-            public void onCheckedChanged(final CompoundButton button,
-                                         final boolean checked) {
-                callback.setCheckboxValue(checked);
-            }
-        });
-        if (parent == null) {
-            final int padding = getViewPadding(builder);
-            parent = new FrameLayout(builder.getContext());
-            parent.setPadding(/* left */ padding, /* top */ 0,
-                              /* right */ padding, /* bottom */ 0);
-            builder.setView(parent);
-        }
-        parent.addView(checkbox);
-        return builder;
-    }
-
-    @Override
-    public void onAlert(final GeckoSession session, final String title, final String msg,
-                        final AlertCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.dismiss();
-            return;
-        }
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle)
-                .setTitle(title)
-                .setMessage(msg)
-                .setPositiveButton(android.R.string.ok, /* onClickListener */ null);
-        createStandardDialog(addCheckbox(builder, /* parent */ null, callback),
-                callback).show();
-    }
-
-    @Override
-    public void onButtonPrompt(final GeckoSession session, final String title,
-                                final String msg, final String[] btnMsg,
-                                final ButtonCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.dismiss();
-            return;
-        }
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle)
-                .setTitle(title)
-                .setMessage(msg);
-        final DialogInterface.OnClickListener listener =
-                new DialogInterface.OnClickListener() {
-                    @Override
-                    public void onClick(final DialogInterface dialog, final int which) {
-                        if (which == DialogInterface.BUTTON_POSITIVE) {
-                            callback.confirm(BUTTON_TYPE_POSITIVE);
-                        } else if (which == DialogInterface.BUTTON_NEUTRAL) {
-                            callback.confirm(BUTTON_TYPE_NEUTRAL);
-                        } else if (which == DialogInterface.BUTTON_NEGATIVE) {
-                            callback.confirm(BUTTON_TYPE_NEGATIVE);
-                        } else {
-                            callback.dismiss();
-                        }
-                    }
-                };
-        if (btnMsg[BUTTON_TYPE_POSITIVE] != null) {
-            builder.setPositiveButton(btnMsg[BUTTON_TYPE_POSITIVE], listener);
-        }
-        if (btnMsg[BUTTON_TYPE_NEUTRAL] != null) {
-            builder.setNeutralButton(btnMsg[BUTTON_TYPE_NEUTRAL], listener);
-        }
-        if (btnMsg[BUTTON_TYPE_NEGATIVE] != null) {
-            builder.setNegativeButton(btnMsg[BUTTON_TYPE_NEGATIVE], listener);
-        }
-        createStandardDialog(addCheckbox(builder, /* parent */ null, callback),
-                callback).show();
-    }
-
-    private int getViewPadding(final AlertDialog.Builder builder) {
-        final TypedArray attr = builder.getContext().obtainStyledAttributes(
-                new int[]{android.R.attr.listPreferredItemPaddingLeft});
-        final int padding = attr.getDimensionPixelSize(0, 1);
-        attr.recycle();
-        return padding;
-    }
-
-    private LinearLayout addStandardLayout(final AlertDialog.Builder builder,
-                                           final String title, final String msg) {
-        final ScrollView scrollView = new ScrollView(builder.getContext());
-        final LinearLayout container = new LinearLayout(builder.getContext());
-        final int horizontalPadding = getViewPadding(builder);
-        final int verticalPadding = (msg == null || msg.isEmpty()) ? horizontalPadding : 0;
-        container.setOrientation(LinearLayout.VERTICAL);
-        container.setPadding(/* left */ horizontalPadding, /* top */ verticalPadding,
-                             /* right */ horizontalPadding, /* bottom */ verticalPadding);
-        scrollView.addView(container);
-        builder.setTitle(title)
-                .setMessage(msg)
-                .setView(scrollView);
-        return container;
-    }
-
-    private AlertDialog createStandardDialog(final AlertDialog.Builder builder,
-                                             final AlertCallback callback) {
-        final AlertDialog dialog = builder.create();
-        dialog.setOnDismissListener(new DialogInterface.OnDismissListener() {
-            @Override
-            public void onDismiss(final DialogInterface dialog) {
-                callback.dismiss();
-            }
-        });
-        return dialog;
-    }
-
-    @Override
-    public void onTextPrompt(final GeckoSession session, final String title,
-                              final String msg, final String value,
-                              final TextCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.dismiss();
-            return;
-        }
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle);
-        final LinearLayout container = addStandardLayout(builder, title, msg);
-        final EditText editText = new EditText(builder.getContext());
-        editText.setText(value);
-        container.addView(editText);
-
-        builder.setNegativeButton(android.R.string.cancel, /* listener */ null)
-                .setPositiveButton(android.R.string.ok,
-                        new DialogInterface.OnClickListener() {
-                            @Override
-                            public void onClick(final DialogInterface dialog, final int which) {
-                                callback.confirm(editText.getText().toString());
-                            }
-                        });
-
-        createStandardDialog(addCheckbox(builder, container, callback), callback).show();
-    }
-
-    @Override
-    public void onAuthPrompt(GeckoSession geckoSession, String s, String s1, AuthOptions authOptions, final AuthCallback authCallback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            authCallback.dismiss();
-            return;
-        }
-
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle);
-        final LinearLayout container = addStandardLayout(builder, s, s1);
-
-        final int flags = authOptions.flags;
-        final int level = authOptions.level;
-        final EditText username;
-        if ((flags & AuthOptions.AUTH_FLAG_ONLY_PASSWORD) == 0) {
-            username = new EditText(builder.getContext());
-            username.setHint(R.string.gv_prompt_username_hint);
-            username.setText(authOptions.username);
-            container.addView(username);
-        } else {
-            username = null;
-        }
-
-        final EditText password = new EditText(builder.getContext());
-        password.setHint(R.string.gv_prompt_password_hint);
-        password.setText(authOptions.password);
-        password.setInputType(InputType.TYPE_CLASS_TEXT |
-                InputType.TYPE_TEXT_VARIATION_PASSWORD);
-        container.addView(password);
-
-        if (level != AuthOptions.AUTH_LEVEL_NONE) {
-            final ImageView secure = new ImageView(builder.getContext());
-            secure.setImageResource(android.R.drawable.ic_lock_lock);
-            container.addView(secure);
-        }
-
-        builder.setNegativeButton(android.R.string.cancel, /* listener */ null)
-                .setPositiveButton(android.R.string.ok,
-                        new DialogInterface.OnClickListener() {
-                            @Override
-                            public void onClick(final DialogInterface dialog, final int which) {
-                                if ((flags & AuthOptions.AUTH_FLAG_ONLY_PASSWORD) == 0) {
-                                    authCallback.confirm(username.getText().toString(),
-                                            password.getText().toString());
-                                } else {
-                                    authCallback.confirm(password.getText().toString());
-                                }
-                            }
-                        });
-        createStandardDialog(addCheckbox(builder, container, authCallback), authCallback).show();
-    }
-
-    private void addChoiceItems(final int type, final ArrayAdapter<ModifiableChoice> list,
-                                final Choice[] items, final String indent) {
-        if (type == Choice.CHOICE_TYPE_MENU) {
-            for (final Choice item : items) {
-                list.add(new ModifiableChoice(item));
-            }
-            return;
-        }
-
-        for (final Choice item : items) {
-            final ModifiableChoice modItem = new ModifiableChoice(item);
-
-            final Choice[] children = item.items;
-            if (indent != null && children == null) {
-                modItem.modifiableLabel = indent + modItem.modifiableLabel;
-            }
-            list.add(modItem);
-
-            if (children != null) {
-                final String newIndent;
-                if (type == Choice.CHOICE_TYPE_SINGLE || type == Choice.CHOICE_TYPE_MULTIPLE) {
-                    newIndent = (indent != null) ? indent + '\t' : "\t";
-                } else {
-                    newIndent = null;
-                }
-                addChoiceItems(type, list, children, newIndent);
-            }
-        }
-    }
-
-    @Override
-    public void onChoicePrompt(final GeckoSession session, final String title,
-                                final String msg, final int type,
-                                final Choice[] choices, final ChoiceCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.dismiss();
-            return;
-        }
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle);
-        addStandardLayout(builder, title, msg);
-
-        final ListView list = new ListView(builder.getContext());
-        if (type == Choice.CHOICE_TYPE_MULTIPLE) {
-            list.setChoiceMode(ListView.CHOICE_MODE_MULTIPLE);
-        }
-
-        final ArrayAdapter<ModifiableChoice> adapter = new ArrayAdapter<ModifiableChoice>(
-                builder.getContext(), android.R.layout.simple_list_item_1) {
-            private static final int TYPE_MENU_ITEM = 0;
-            private static final int TYPE_MENU_CHECK = 1;
-            private static final int TYPE_SEPARATOR = 2;
-            private static final int TYPE_GROUP = 3;
-            private static final int TYPE_SINGLE = 4;
-            private static final int TYPE_MULTIPLE = 5;
-            private static final int TYPE_COUNT = 6;
-
-            private LayoutInflater mInflater;
-            private View mSeparator;
-
-            @Override
-            public int getViewTypeCount() {
-                return TYPE_COUNT;
-            }
-
-            @Override
-            public int getItemViewType(final int position) {
-                final ModifiableChoice item = getItem(position);
-                if (item.choice.separator) {
-                    return TYPE_SEPARATOR;
-                } else if (type == Choice.CHOICE_TYPE_MENU) {
-                    return item.modifiableSelected ? TYPE_MENU_CHECK : TYPE_MENU_ITEM;
-                } else if (item.choice.items != null) {
-                    return TYPE_GROUP;
-                } else if (type == Choice.CHOICE_TYPE_SINGLE) {
-                    return TYPE_SINGLE;
-                } else if (type == Choice.CHOICE_TYPE_MULTIPLE) {
-                    return TYPE_MULTIPLE;
-                } else {
-                    throw new UnsupportedOperationException();
-                }
-            }
-
-            @Override
-            public boolean isEnabled(final int position) {
-                final ModifiableChoice item = getItem(position);
-                return !item.choice.separator && !item.choice.disabled &&
-                        ((type != Choice.CHOICE_TYPE_SINGLE && type != Choice.CHOICE_TYPE_MULTIPLE)
-                                || item.choice.items == null);
-            }
-
-            @Override
-            public View getView(final int position, View view,
-                                final ViewGroup parent) {
-                final int itemType = getItemViewType(position);
-                final int layoutId;
-                if (itemType == TYPE_SEPARATOR) {
-                    if (mSeparator == null) {
-                        mSeparator = new View(getContext());
-                        mSeparator.setLayoutParams(new ListView.LayoutParams(
-                                ViewGroup.LayoutParams.MATCH_PARENT, 2, itemType));
-                        final TypedArray attr = getContext().obtainStyledAttributes(
-                                new int[]{android.R.attr.listDivider});
-                        mSeparator.setBackgroundResource(attr.getResourceId(0, 0));
-                        attr.recycle();
-                    }
-                    return mSeparator;
-                } else if (itemType == TYPE_MENU_ITEM) {
-                    layoutId = android.R.layout.simple_list_item_1;
-                } else if (itemType == TYPE_MENU_CHECK) {
-                    layoutId = android.R.layout.simple_list_item_checked;
-                } else if (itemType == TYPE_GROUP) {
-                    layoutId = android.R.layout.preference_category;
-                } else if (itemType == TYPE_SINGLE) {
-                    layoutId = android.R.layout.simple_list_item_single_choice;
-                } else if (itemType == TYPE_MULTIPLE) {
-                    layoutId = android.R.layout.simple_list_item_multiple_choice;
-                } else {
-                    throw new UnsupportedOperationException();
-                }
-
-                if (view == null) {
-                    if (mInflater == null) {
-                        mInflater = LayoutInflater.from(builder.getContext());
-                    }
-                    view = mInflater.inflate(layoutId, parent, false);
-                }
-
-                final ModifiableChoice item = getItem(position);
-                final TextView text = (TextView) view;
-                text.setEnabled(!item.choice.disabled);
-                text.setText(item.modifiableLabel);
-                if (view instanceof CheckedTextView) {
-                    final boolean selected = item.modifiableSelected;
-                    if (itemType == TYPE_MULTIPLE) {
-                        list.setItemChecked(position, selected);
-                    } else {
-                        ((CheckedTextView) view).setChecked(selected);
-                    }
-                }
-                return view;
-            }
-        };
-        addChoiceItems(type, adapter, choices, /* indent */ null);
-
-        list.setAdapter(adapter);
-        builder.setView(list);
-
-        final AlertDialog dialog;
-        if (type == Choice.CHOICE_TYPE_SINGLE || type == Choice.CHOICE_TYPE_MENU) {
-            dialog = createStandardDialog(builder, callback);
-            list.setOnItemClickListener(new AdapterView.OnItemClickListener() {
-                @Override
-                public void onItemClick(final AdapterView<?> parent, final View v,
-                                        final int position, final long id) {
-                    final ModifiableChoice item = adapter.getItem(position);
-                    if (type == Choice.CHOICE_TYPE_MENU) {
-                        final Choice[] children = item.choice.items;
-                        if (children != null) {
-                            // Show sub-menu.
-                            dialog.setOnDismissListener(null);
-                            dialog.dismiss();
-                            onChoicePrompt(session, item.modifiableLabel, /* msg */ null,
-                                    type, children, callback);
-                            return;
-                        }
-                    }
-                    callback.confirm(item.choice);
-                    dialog.dismiss();
-                }
-            });
-        } else if (type == Choice.CHOICE_TYPE_MULTIPLE) {
-            list.setOnItemClickListener(new AdapterView.OnItemClickListener() {
-                @Override
-                public void onItemClick(final AdapterView<?> parent, final View v,
-                                        final int position, final long id) {
-                    final ModifiableChoice item = adapter.getItem(position);
-                    item.modifiableSelected = ((CheckedTextView) v).isChecked();
-                }
-            });
-            builder.setNegativeButton(android.R.string.cancel, /* listener */ null)
-                    .setPositiveButton(android.R.string.ok,
-                            new DialogInterface.OnClickListener() {
-                                @Override
-                                public void onClick(final DialogInterface dialog,
-                                                    final int which) {
-                                    final int len = adapter.getCount();
-                                    ArrayList<String> items = new ArrayList<>(len);
-                                    for (int i = 0; i < len; i++) {
-                                        final ModifiableChoice item = adapter.getItem(i);
-                                        if (item.modifiableSelected) {
-                                            items.add(item.choice.id);
-                                        }
-                                    }
-                                    callback.confirm(items.toArray(new String[items.size()]));
-                                }
-                            });
-            dialog = createStandardDialog(builder, callback);
-        } else {
-            throw new UnsupportedOperationException();
-        }
-        dialog.show();
-    }
-
-    private static int parseColor(final String value, final int def) {
-        try {
-            return Color.parseColor(value);
-        } catch (final IllegalArgumentException e) {
-            return def;
-        }
-    }
-
-    @Override
-    public void onColorPrompt(final GeckoSession session, final String title,
-                               final String value, final TextCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.dismiss();
-            return;
-        }
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle);
-        addStandardLayout(builder, title, /* msg */ null);
-
-        final int initial = parseColor(value, /* def */ 0);
-        final ArrayAdapter<Integer> adapter = new ArrayAdapter<Integer>(
-                builder.getContext(), android.R.layout.simple_list_item_1) {
-            private LayoutInflater mInflater;
-
-            @Override
-            public int getViewTypeCount() {
-                return 2;
-            }
-
-            @Override
-            public int getItemViewType(final int position) {
-                return (getItem(position) == initial) ? 1 : 0;
-            }
-
-            @Override
-            public View getView(final int position, View view,
-                                final ViewGroup parent) {
-                if (mInflater == null) {
-                    mInflater = LayoutInflater.from(builder.getContext());
-                }
-                final int color = getItem(position);
-                if (view == null) {
-                    view = mInflater.inflate((color == initial) ?
-                            android.R.layout.simple_list_item_checked :
-                            android.R.layout.simple_list_item_1, parent, false);
-                }
-                view.setBackgroundResource(android.R.drawable.editbox_background);
-                view.getBackground().setColorFilter(color, PorterDuff.Mode.MULTIPLY);
-                return view;
-            }
-        };
-
-        adapter.addAll(0xffff4444 /* holo_red_light */,
-                0xffcc0000 /* holo_red_dark */,
-                0xffffbb33 /* holo_orange_light */,
-                0xffff8800 /* holo_orange_dark */,
-                0xff99cc00 /* holo_green_light */,
-                0xff669900 /* holo_green_dark */,
-                0xff33b5e5 /* holo_blue_light */,
-                0xff0099cc /* holo_blue_dark */,
-                0xffaa66cc /* holo_purple */,
-                0xffffffff /* white */,
-                0xffaaaaaa /* lighter_gray */,
-                0xff555555 /* darker_gray */,
-                0xff000000 /* black */);
-
-        final ListView list = new ListView(builder.getContext());
-        list.setAdapter(adapter);
-        builder.setView(list);
-
-        final AlertDialog dialog = createStandardDialog(builder, callback);
-        list.setOnItemClickListener(new AdapterView.OnItemClickListener() {
-            @Override
-            public void onItemClick(final AdapterView<?> parent, final View v,
-                                    final int position, final long id) {
-                callback.confirm(String.format("#%06x", 0xffffff & adapter.getItem(position)));
-                dialog.dismiss();
-            }
-        });
-        dialog.show();
-    }
-
-    private static Date parseDate(final SimpleDateFormat formatter,
-                                  final String value,
-                                  final boolean defaultToNow) {
-        try {
-            if (value != null && !value.isEmpty()) {
-                return formatter.parse(value);
-            }
-        } catch (final ParseException ignored) {
-        }
-        return defaultToNow ? new Date() : null;
-    }
-
-    @SuppressWarnings("deprecation")
-    private static void setTimePickerTime(final TimePicker picker, final Calendar cal) {
-        if (Build.VERSION.SDK_INT >= 23) {
-            picker.setHour(cal.get(Calendar.HOUR_OF_DAY));
-            picker.setMinute(cal.get(Calendar.MINUTE));
-        } else {
-            picker.setCurrentHour(cal.get(Calendar.HOUR_OF_DAY));
-            picker.setCurrentMinute(cal.get(Calendar.MINUTE));
-        }
-    }
-
-    @SuppressWarnings("deprecation")
-    private static void setCalendarTime(final Calendar cal, final TimePicker picker) {
-        if (Build.VERSION.SDK_INT >= 23) {
-            cal.set(Calendar.HOUR_OF_DAY, picker.getHour());
-            cal.set(Calendar.MINUTE, picker.getMinute());
-        } else {
-            cal.set(Calendar.HOUR_OF_DAY, picker.getCurrentHour());
-            cal.set(Calendar.MINUTE, picker.getCurrentMinute());
-        }
-    }
-
-    @Override
-    public void onDateTimePrompt(final GeckoSession session, final String title,
-                                  final int type, final String value, final String min,
-                                  final String max, final TextCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.dismiss();
-            return;
-        }
-        final String format;
-        if (type == DATETIME_TYPE_DATE) {
-            format = "yyyy-MM-dd";
-        } else if (type == DATETIME_TYPE_MONTH) {
-            format = "yyyy-MM";
-        } else if (type == DATETIME_TYPE_WEEK) {
-            format = "yyyy-'W'ww";
-        } else if (type == DATETIME_TYPE_TIME) {
-            format = "HH:mm";
-        } else if (type == DATETIME_TYPE_DATETIME_LOCAL) {
-            format = "yyyy-MM-dd'T'HH:mm";
-        } else {
-            throw new UnsupportedOperationException();
-        }
-
-        final SimpleDateFormat formatter = new SimpleDateFormat(format, Locale.ROOT);
-        final Date minDate = parseDate(formatter, min, /* defaultToNow */ false);
-        final Date maxDate = parseDate(formatter, max, /* defaultToNow */ false);
-        final Date date = parseDate(formatter, value, /* defaultToNow */ true);
-        final Calendar cal = formatter.getCalendar();
-        cal.setTime(date);
-
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle);
-        final LayoutInflater inflater = LayoutInflater.from(builder.getContext());
-        final DatePicker datePicker;
-        if (type == DATETIME_TYPE_DATE || type == DATETIME_TYPE_MONTH ||
-                type == DATETIME_TYPE_WEEK || type == DATETIME_TYPE_DATETIME_LOCAL) {
-            final int resId = builder.getContext().getResources().getIdentifier(
-                    "date_picker_dialog", "layout", "android");
-            DatePicker picker = null;
-            if (resId != 0) {
-                try {
-                    picker = (DatePicker) inflater.inflate(resId, /* root */ null);
-                } catch (final ClassCastException | InflateException ignored) {
-                }
-            }
-            if (picker == null) {
-                picker = new DatePicker(builder.getContext());
-            }
-            picker.init(cal.get(Calendar.YEAR), cal.get(Calendar.MONTH),
-                    cal.get(Calendar.DAY_OF_MONTH), /* listener */ null);
-            if (minDate != null) {
-                picker.setMinDate(minDate.getTime());
-            }
-            if (maxDate != null) {
-                picker.setMaxDate(maxDate.getTime());
-            }
-            datePicker = picker;
-        } else {
-            datePicker = null;
-        }
-
-        final TimePicker timePicker;
-        if (type == DATETIME_TYPE_TIME || type == DATETIME_TYPE_DATETIME_LOCAL) {
-            final int resId = builder.getContext().getResources().getIdentifier(
-                    "time_picker_dialog", "layout", "android");
-            TimePicker picker = null;
-            if (resId != 0) {
-                try {
-                    picker = (TimePicker) inflater.inflate(resId, /* root */ null);
-                } catch (final ClassCastException | InflateException ignored) {
-                }
-            }
-            if (picker == null) {
-                picker = new TimePicker(builder.getContext());
-            }
-            setTimePickerTime(picker, cal);
-            picker.setIs24HourView(DateFormat.is24HourFormat(builder.getContext()));
-            timePicker = picker;
-        } else {
-            timePicker = null;
-        }
-
-        final LinearLayout container = addStandardLayout(builder, title, /* msg */ null);
-        container.setPadding(/* left */ 0, /* top */ 0, /* right */ 0, /* bottom */ 0);
-        if (datePicker != null) {
-            container.addView(datePicker);
-        }
-        if (timePicker != null) {
-            container.addView(timePicker);
-        }
-
-        final DialogInterface.OnClickListener listener =
-                new DialogInterface.OnClickListener() {
-                    @Override
-                    public void onClick(final DialogInterface dialog, final int which) {
-                        if (which == DialogInterface.BUTTON_NEUTRAL) {
-                            // Clear
-                            callback.confirm("");
-                            return;
-                        }
-                        if (datePicker != null) {
-                            cal.set(datePicker.getYear(), datePicker.getMonth(),
-                                    datePicker.getDayOfMonth());
-                        }
-                        if (timePicker != null) {
-                            setCalendarTime(cal, timePicker);
-                        }
-                        callback.confirm(formatter.format(cal.getTime()));
-                    }
-                };
-        builder.setNegativeButton(android.R.string.cancel, /* listener */ null)
-                .setNeutralButton(R.string.gv_prompt_clear, listener)
-                .setPositiveButton(android.R.string.ok, listener);
-        createStandardDialog(builder, callback).show();
-    }
-
-
-    @Override
-    public void onFilePrompt(GeckoSession session, String title, int type, String[] mimeTypes, FileCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.dismiss();
-            return;
-        }
-
-        // Merge all given MIME types into one, using wildcard if needed.
-        String mimeType = null;
-        String mimeSubtype = null;
-        for (final String rawType : mimeTypes) {
-            final String normalizedType = rawType.trim().toLowerCase(Locale.ROOT);
-            final int len = normalizedType.length();
-            int slash = normalizedType.indexOf('/');
-            if (slash < 0) {
-                slash = len;
-            }
-            final String newType = normalizedType.substring(0, slash);
-            final String newSubtype = normalizedType.substring(Math.min(slash + 1, len));
-            if (mimeType == null) {
-                mimeType = newType;
-            } else if (!mimeType.equals(newType)) {
-                mimeType = "*";
-            }
-            if (mimeSubtype == null) {
-                mimeSubtype = newSubtype;
-            } else if (!mimeSubtype.equals(newSubtype)) {
-                mimeSubtype = "*";
-            }
-        }
-
-        final Intent intent = new Intent(Intent.ACTION_GET_CONTENT);
-        intent.setType((mimeType != null ? mimeType : "*") + '/' +
-                (mimeSubtype != null ? mimeSubtype : "*"));
-        intent.addCategory(Intent.CATEGORY_OPENABLE);
-        intent.putExtra(Intent.EXTRA_LOCAL_ONLY, true);
-        intent.putExtra(Intent.EXTRA_ALLOW_MULTIPLE, true);
-        intent.putExtra(Intent.EXTRA_MIME_TYPES, mimeTypes);
-
-        try {
-            mFileType = type;
-            mFileCallback = callback;
-            activity.startActivityForResult(intent, filePickerRequestCode);
-        } catch (final ActivityNotFoundException e) {
-            Log.e(LOGTAG, "Cannot launch activity", e);
-            callback.dismiss();
-        }
-    }
-
-    @Override
-    public GeckoResult<AllowOrDeny> onPopupRequest(GeckoSession session, String targetUri) {
-        return GeckoResult.fromValue(AllowOrDeny.DENY);
-    }
-
-    public void onFileCallbackResult(final int resultCode, final Intent data) {
-        if (mFileCallback == null) {
-            return;
-        }
-
-        final FileCallback callback = mFileCallback;
-        mFileCallback = null;
-
-        if (resultCode != Activity.RESULT_OK || data == null) {
-            callback.dismiss();
-            return;
-        }
-
-        final Uri uri = data.getData();
-        final ClipData clip = data.getClipData();
-
-        if (mFileType == FILE_TYPE_SINGLE ||
-                (mFileType == FILE_TYPE_MULTIPLE && clip == null)) {
-            callback.confirm(mActivity, uri);
-
-        } else if (mFileType == FILE_TYPE_MULTIPLE) {
-            if (clip == null) {
-                Log.w(LOGTAG, "No selected file");
-                callback.dismiss();
-                return;
-            }
-            final int count = clip.getItemCount();
-            final ArrayList<Uri> uris = new ArrayList<>(count);
-            for (int i = 0; i < count; i++) {
-                uris.add(clip.getItemAt(i).getUri());
-            }
-            callback.confirm(mActivity, uris.toArray(new Uri[uris.size()]));
-        }
-    }
-
-    public void promptForPermission(final GeckoSession session, final String title,
-                                    final GeckoSession.PermissionDelegate.Callback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing()) {
-            callback.reject();
-            return;
-        }
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle);
-        builder.setTitle(title)
-                .setNegativeButton(android.R.string.cancel, /* onClickListener */ null)
-                .setPositiveButton(android.R.string.ok, new DialogInterface.OnClickListener() {
-                    @Override
-                    public void onClick(final DialogInterface dialog, final int which) {
-                        callback.grant();
-                    }
-                });
-
-        final AlertDialog dialog = builder.create();
-        dialog.setOnDismissListener(new DialogInterface.OnDismissListener() {
-            @Override
-            public void onDismiss(final DialogInterface dialog) {
-                callback.reject();
-            }
-        });
-        dialog.show();
-    }
-
-    private Spinner addMediaSpinner(final Context context, final ViewGroup container,
-                                    final MediaSource[] sources) {
-        final ArrayAdapter<MediaSource> adapter = new ArrayAdapter<MediaSource>(
-                context, android.R.layout.simple_spinner_item) {
-            private View convertView(final int position, final View view) {
-                if (view != null) {
-                    final MediaSource item = getItem(position);
-                    ((TextView) view).setText(item.name);
-                }
-                return view;
-            }
-
-            @Override
-            public View getView(final int position, View view,
-                                final ViewGroup parent) {
-                return convertView(position, super.getView(position, view, parent));
-            }
-
-            @Override
-            public View getDropDownView(final int position, final View view,
-                                        final ViewGroup parent) {
-                return convertView(position, super.getDropDownView(position, view, parent));
-            }
-        };
-        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
-        adapter.addAll(sources);
-
-        final Spinner spinner = new Spinner(context);
-        spinner.setAdapter(adapter);
-        spinner.setSelection(0);
-        container.addView(spinner);
-        return spinner;
-    }
-
-    public void promptForMedia(final GeckoSession session, final String title,
-                               final MediaSource[] video, final MediaSource[] audio,
-                               final GeckoSession.PermissionDelegate.MediaCallback callback) {
-        final Activity activity = mActivity;
-        if (activity == null || activity.isFinishing() || (video == null && audio == null)) {
-            callback.reject();
-            return;
-        }
-        final AlertDialog.Builder builder = new AlertDialog.Builder(activity, R.style.DialogStyle);
-        final LinearLayout container = addStandardLayout(builder, title, /* msg */ null);
-
-        final Spinner videoSpinner;
-        if (video != null) {
-            videoSpinner = addMediaSpinner(builder.getContext(), container, video);
-        } else {
-            videoSpinner = null;
-        }
-
-        final Spinner audioSpinner;
-        if (audio != null) {
-            audioSpinner = addMediaSpinner(builder.getContext(), container, audio);
-        } else {
-            audioSpinner = null;
-        }
-
-        builder.setNegativeButton(android.R.string.cancel, /* listener */ null)
-                .setPositiveButton(android.R.string.ok,
-                        new DialogInterface.OnClickListener() {
-                            @Override
-                            public void onClick(final DialogInterface dialog, final int which) {
-                                final MediaSource video = (videoSpinner != null)
-                                        ? (MediaSource) videoSpinner.getSelectedItem() : null;
-                                final MediaSource audio = (audioSpinner != null)
-                                        ? (MediaSource) audioSpinner.getSelectedItem() : null;
-                                callback.grant(video, audio);
-                            }
-                        });
-
-        final AlertDialog dialog = builder.create();
-        dialog.setOnDismissListener(new DialogInterface.OnDismissListener() {
-            @Override
-            public void onDismiss(final DialogInterface dialog) {
-                callback.reject();
-            }
-        });
-        dialog.show();
-    }
-}
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenu.java b/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenu.java
index 500c4c661682..77708650fe5b 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenu.java
+++ b/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenu.java
@@ -18,11 +18,12 @@
 import android.widget.PopupWindow;
 import android.widget.TextView;
 
-import mozilla.components.browser.session.tab.CustomTabConfig;
 import org.mozilla.focus.R;
 import org.mozilla.focus.fragment.BrowserFragment;
 import org.mozilla.focus.utils.ViewUtils;
 
+import mozilla.components.browser.state.state.CustomTabConfig;
+
 /**
  * The overflow menu shown in the BrowserFragment containing page actions like "Refresh", "Share" etc.
  */
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenuAdapter.kt b/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenuAdapter.kt
index cf925257cc9f..68b00b883264 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenuAdapter.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/menu/browser/BrowserMenuAdapter.kt
@@ -10,7 +10,7 @@ import android.content.Context
 import androidx.recyclerview.widget.RecyclerView
 import android.view.LayoutInflater
 import android.view.ViewGroup
-import mozilla.components.browser.session.tab.CustomTabConfig
+import mozilla.components.browser.state.state.CustomTabConfig
 
 import org.mozilla.focus.R
 import org.mozilla.focus.fragment.BrowserFragment
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/searchsuggestions/ui/SearchSuggestionsFragment.kt b/focus-android/app/src/main/java/org/mozilla/focus/searchsuggestions/ui/SearchSuggestionsFragment.kt
index 43e85e373c0c..3c8a1f5d0399 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/searchsuggestions/ui/SearchSuggestionsFragment.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/searchsuggestions/ui/SearchSuggestionsFragment.kt
@@ -163,8 +163,8 @@ class SearchSuggestionsFragment : Fragment(), CoroutineScope {
                 context.components.sessionManager.add(session, selected = true)
             }
 
-            override fun updateDrawState(ds: TextPaint?) {
-                ds?.isUnderlineText = false
+            override fun updateDrawState(ds: TextPaint) {
+                ds.isUnderlineText = false
             }
         }
 
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySessionObserver.kt b/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySessionObserver.kt
index 18e224cbf5fe..2e0a680dc231 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySessionObserver.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySessionObserver.kt
@@ -6,6 +6,7 @@ package org.mozilla.focus.telemetry
 
 import mozilla.components.browser.session.Session
 import mozilla.components.browser.session.SessionManager
+import mozilla.components.browser.state.state.CustomTabConfig
 
 class TelemetrySessionObserver : SessionManager.Observer {
     override fun onSessionAdded(session: Session) {
@@ -14,10 +15,45 @@ class TelemetrySessionObserver : SessionManager.Observer {
             Session.Source.ACTION_SEND -> TelemetryWrapper.shareIntentEvent(session.searchTerms.isNotEmpty())
             Session.Source.TEXT_SELECTION -> TelemetryWrapper.textSelectionIntentEvent()
             Session.Source.HOME_SCREEN -> TelemetryWrapper.openHomescreenShortcutEvent()
-            Session.Source.CUSTOM_TAB -> TelemetryWrapper.customTabsIntentEvent(session.customTabConfig!!.options)
+            Session.Source.CUSTOM_TAB -> TelemetryWrapper.customTabsIntentEvent(generateOptions(session.customTabConfig!!))
             else -> {
                 // For other session types we create events at the place where we create the sessions.
             }
         }
     }
+
+    /**
+     * This method creates a list of options used to share with Telemetry and was migrated from A-C.
+     *
+     * @param customTabConfig The customTabConfig to use
+     * @return A list of strings representing the customTabConfig
+     */
+    @Suppress("ComplexMethod")
+    private fun generateOptions(customTabConfig: CustomTabConfig): List<String> {
+        val options = mutableListOf<String>()
+
+        if (customTabConfig.toolbarColor != null) options.add(TOOLBAR_COLOR_OPTION)
+        if (customTabConfig.closeButtonIcon != null) options.add(CLOSE_BUTTON_OPTION)
+        if (customTabConfig.enableUrlbarHiding) options.add(DISABLE_URLBAR_HIDING_OPTION)
+        if (customTabConfig.actionButtonConfig != null) options.add(ACTION_BUTTON_OPTION)
+        if (customTabConfig.showShareMenuItem) options.add(SHARE_MENU_ITEM_OPTION)
+        if (customTabConfig.menuItems.isNotEmpty()) options.add(CUSTOMIZED_MENU_OPTION)
+        if (customTabConfig.actionButtonConfig?.tint == true) options.add(ACTION_BUTTON_TINT_OPTION)
+        if (customTabConfig.exitAnimations != null) options.add(EXIT_ANIMATION_OPTION)
+        if (customTabConfig.titleVisible) options.add(PAGE_TITLE_OPTION)
+
+        return options
+    }
+
+    companion object {
+        internal const val TOOLBAR_COLOR_OPTION = "hasToolbarColor"
+        internal const val CLOSE_BUTTON_OPTION = "hasCloseButton"
+        internal const val DISABLE_URLBAR_HIDING_OPTION = "disablesUrlbarHiding"
+        internal const val ACTION_BUTTON_OPTION = "hasActionButton"
+        internal const val SHARE_MENU_ITEM_OPTION = "hasShareItem"
+        internal const val CUSTOMIZED_MENU_OPTION = "hasCustomizedMenu"
+        internal const val ACTION_BUTTON_TINT_OPTION = "hasActionButtonTint"
+        internal const val EXIT_ANIMATION_OPTION = "hasExitAnimation"
+        internal const val PAGE_TITLE_OPTION = "hasPageTitle"
+    }
 }
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySettingsProvider.kt b/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySettingsProvider.kt
index cd9ebc8d6845..bcaa54bed220 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySettingsProvider.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/telemetry/TelemetrySettingsProvider.kt
@@ -2,6 +2,8 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
+@file:Suppress("DEPRECATION")
+
 package org.mozilla.focus.telemetry
 
 import android.content.Context
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/utils/AppConstants.kt b/focus-android/app/src/main/java/org/mozilla/focus/utils/AppConstants.kt
index dbae5df2acce..85ee8d4be21f 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/utils/AppConstants.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/utils/AppConstants.kt
@@ -16,7 +16,7 @@ object AppConstants {
     private const val PRODUCT_FLAVOR_KLAR = "klar"
 
     val isKlarBuild: Boolean
-        get() = PRODUCT_FLAVOR_KLAR == BuildConfig.FLAVOR_product
+        get() = PRODUCT_FLAVOR_KLAR == BuildConfig.FLAVOR
 
     val isReleaseBuild: Boolean
         get() = BUILD_TYPE_RELEASE == BuildConfig.BUILD_TYPE
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/web/GeckoWebViewProvider.kt b/focus-android/app/src/main/java/org/mozilla/focus/web/GeckoWebViewProvider.kt
index 4a8f0c22bfef..bcf918d37d3f 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/web/GeckoWebViewProvider.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/web/GeckoWebViewProvider.kt
@@ -32,7 +32,6 @@ import org.json.JSONException
 import org.mozilla.focus.R
 import org.mozilla.focus.browser.LocalizedContent
 import org.mozilla.focus.ext.savedWebViewState
-import org.mozilla.focus.gecko.GeckoViewPrompt
 import org.mozilla.focus.gecko.NestedGeckoView
 import org.mozilla.focus.telemetry.TelemetryWrapper
 import org.mozilla.focus.utils.AppConstants
@@ -90,13 +89,11 @@ class GeckoWebViewProvider : IWebViewProvider {
             val runtimeSettingsBuilder = GeckoRuntimeSettings.Builder()
             runtimeSettingsBuilder.useContentProcessHint(true)
             runtimeSettingsBuilder.contentBlocking(ContentBlocking.Settings.Builder()
-                    .categories(ContentBlocking.SB_MALWARE)
-                    .categories(ContentBlocking.SB_PHISHING)
+                    .safeBrowsing(ContentBlocking.SafeBrowsing.MALWARE or ContentBlocking.SafeBrowsing.PHISHING)
                     .build())
             val contentBlockingBuilder = ContentBlocking.Settings.Builder()
             if (Settings.getInstance(context).shouldUseSafeBrowsing()) {
-                contentBlockingBuilder.categories(ContentBlocking.SB_MALWARE)
-                        .categories(ContentBlocking.SB_PHISHING)
+                contentBlockingBuilder.safeBrowsing(ContentBlocking.SafeBrowsing.MALWARE or ContentBlocking.SafeBrowsing.PHISHING)
             }
             runtimeSettingsBuilder.contentBlocking(contentBlockingBuilder.build())
             runtimeSettingsBuilder.crashHandler(CrashHandlerService::class.java)
@@ -152,7 +149,7 @@ class GeckoWebViewProvider : IWebViewProvider {
                 .registerOnSharedPreferenceChangeListener(this)
             geckoSession = createGeckoSession()
             applySettingsAndSetDelegates()
-            setSession(geckoSession, geckoRuntime)
+            setSession(geckoSession)
         }
 
         private fun applySettingsAndSetDelegates() {
@@ -163,7 +160,6 @@ class GeckoWebViewProvider : IWebViewProvider {
             geckoSession.progressDelegate = createProgressDelegate()
             geckoSession.navigationDelegate = createNavigationDelegate()
             geckoSession.contentBlockingDelegate = createTrackingProtectionDelegate()
-            geckoSession.promptDelegate = createPromptDelegate()
             finder = geckoSession.finder
             finder.displayFlags = GeckoSession.FINDER_DISPLAY_HIGHLIGHT_ALL
         }
@@ -235,7 +231,7 @@ class GeckoWebViewProvider : IWebViewProvider {
             } else {
                 geckoRuntime!!.settings.javaScriptEnabled = true
                 geckoRuntime!!.settings.webFontsEnabled = true
-                geckoRuntime!!.settings.contentBlocking.cookieBehavior = ContentBlocking.COOKIE_ACCEPT_ALL
+                geckoRuntime!!.settings.contentBlocking.cookieBehavior = ContentBlocking.CookieBehavior.ACCEPT_ALL
             }
             callback?.onBlockingStateChanged(enabled)
         }
@@ -272,13 +268,13 @@ class GeckoWebViewProvider : IWebViewProvider {
                 context.getString(R.string.pref_key_safe_browsing) -> {
                     val shouldUseSafeBrowsing =
                         Settings.getInstance(context).shouldUseSafeBrowsing()
-                    var cats = geckoRuntime!!.settings.contentBlocking.categories
+                    var cats = geckoRuntime!!.settings.contentBlocking.safeBrowsingCategories
                     if (shouldUseSafeBrowsing) {
-                        cats = cats or ContentBlocking.SB_MALWARE or ContentBlocking.SB_PHISHING
+                        cats = cats or ContentBlocking.SafeBrowsing.MALWARE or ContentBlocking.SafeBrowsing.PHISHING
                     } else {
-                        cats = cats and ContentBlocking.SB_MALWARE.inv() and ContentBlocking.SB_PHISHING.inv()
+                        cats = cats and ContentBlocking.SafeBrowsing.MALWARE.inv() and ContentBlocking.SafeBrowsing.PHISHING.inv()
                     }
-                    geckoRuntime!!.settings.contentBlocking.categories = cats
+                    geckoRuntime!!.settings.contentBlocking.setSafeBrowsing(cats)
                 }
                 else -> return
             }
@@ -300,45 +296,45 @@ class GeckoWebViewProvider : IWebViewProvider {
                         context.getString(
                             R.string.preference_privacy_should_block_cookies_yes_option
                         ) ->
-                            ContentBlocking.COOKIE_ACCEPT_NONE
+                            ContentBlocking.CookieBehavior.ACCEPT_NONE
                         context.getString(
                             R.string.preference_privacy_should_block_cookies_third_party_tracker_cookies_option
                         ) ->
-                            ContentBlocking.COOKIE_ACCEPT_NON_TRACKERS
+                            ContentBlocking.CookieBehavior.ACCEPT_NON_TRACKERS
                         context.getString(
                             R.string.preference_privacy_should_block_cookies_third_party_only_option
                         ) ->
-                            ContentBlocking.COOKIE_ACCEPT_FIRST_PARTY
-                        else -> ContentBlocking.COOKIE_ACCEPT_ALL
+                            ContentBlocking.CookieBehavior.ACCEPT_FIRST_PARTY
+                        else -> ContentBlocking.CookieBehavior.ACCEPT_ALL
                     }
         }
 
         private fun updateBlocking() {
             val settings = Settings.getInstance(context)
 
-            var categories = geckoRuntime!!.settings.contentBlocking.categories
+            var categories = geckoRuntime!!.settings.contentBlocking.antiTrackingCategories
             if (settings.shouldBlockSocialTrackers()) {
-                categories = categories or ContentBlocking.AT_SOCIAL
+                categories = categories or ContentBlocking.AntiTracking.SOCIAL
             } else {
-                categories = categories and ContentBlocking.AT_SOCIAL.inv()
+                categories = categories and ContentBlocking.AntiTracking.SOCIAL.inv()
             }
             if (settings.shouldBlockAdTrackers()) {
-                categories = categories or ContentBlocking.AT_AD
+                categories = categories or ContentBlocking.AntiTracking.AD
             } else {
-                categories = categories and ContentBlocking.AT_AD.inv()
+                categories = categories and ContentBlocking.AntiTracking.AD.inv()
             }
             if (settings.shouldBlockAnalyticTrackers()) {
-                categories = categories or ContentBlocking.AT_ANALYTIC
+                categories = categories or ContentBlocking.AntiTracking.ANALYTIC
             } else {
-                categories = categories and ContentBlocking.AT_ANALYTIC.inv()
+                categories = categories and ContentBlocking.AntiTracking.ANALYTIC.inv()
             }
             if (settings.shouldBlockOtherTrackers()) {
-                categories = categories or ContentBlocking.AT_CONTENT
+                categories = categories or ContentBlocking.AntiTracking.CONTENT
             } else {
-                categories = categories and ContentBlocking.AT_CONTENT.inv()
+                categories = categories and ContentBlocking.AntiTracking.CONTENT.inv()
             }
 
-            geckoRuntime!!.settings.contentBlocking.categories = categories
+            geckoRuntime!!.settings.contentBlocking.setAntiTracking(categories)
         }
 
         @Suppress("ComplexMethod", "ReturnCount")
@@ -577,10 +573,6 @@ class GeckoWebViewProvider : IWebViewProvider {
             }
         }
 
-        private fun createPromptDelegate(): GeckoSession.PromptDelegate {
-            return GeckoViewPrompt(context as Activity)
-        }
-
         override fun canGoForward(): Boolean {
             return canGoForward
         }
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/webview/TelemetryAutofillCallback.kt b/focus-android/app/src/main/java/org/mozilla/focus/webview/TelemetryAutofillCallback.kt
index 5c63cb9748cd..6b5cff871883 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/webview/TelemetryAutofillCallback.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/webview/TelemetryAutofillCallback.kt
@@ -26,8 +26,8 @@ object TelemetryAutofillCallback : AutofillManager.AutofillCallback() {
                 .unregisterCallback(TelemetryAutofillCallback)
     }
 
-    override fun onAutofillEvent(view: View?, virtualId: Int, event: Int) {
-        super.onAutofillEvent(view!!, virtualId, event)
+    override fun onAutofillEvent(view: View, virtualId: Int, event: Int) {
+        super.onAutofillEvent(view, virtualId, event)
 
         if (event == EVENT_INPUT_SHOWN) {
             TelemetryWrapper.autofillShownEvent()
diff --git a/focus-android/app/src/main/java/org/mozilla/focus/widget/TelemetrySwitchPreference.kt b/focus-android/app/src/main/java/org/mozilla/focus/widget/TelemetrySwitchPreference.kt
index 780955bedc12..d69df49da02c 100644
--- a/focus-android/app/src/main/java/org/mozilla/focus/widget/TelemetrySwitchPreference.kt
+++ b/focus-android/app/src/main/java/org/mozilla/focus/widget/TelemetrySwitchPreference.kt
@@ -2,6 +2,8 @@
  * License, v. 2.0. If a copy of the MPL was not distributed with this
  * file, You can obtain one at http://mozilla.org/MPL/2.0/. */
 
+@file:Suppress("DEPRECATION")
+
 package org.mozilla.focus.widget
 
 import android.content.Context
diff --git a/focus-android/build.gradle b/focus-android/build.gradle
index 352e4df9493b..a4c0f3059adf 100644
--- a/focus-android/build.gradle
+++ b/focus-android/build.gradle
@@ -1,13 +1,14 @@
 // Top-level build file where you can add configuration options common to all sub-projects/modules.
 
 buildscript {
-    ext.architecture_components_version = '2.0.0-beta01'
-    ext.support_libraries_version = '1.0.0-beta01'
+    ext.architecture_components_version = '2.1.0'
+    ext.support_libraries_version = '1.0.0'
     ext.espresso_version = '3.1.0-alpha4'
-    ext.kotlin_version = '1.3.0'
+    ext.kotlin_version = '1.3.50'
     ext.coroutines_version = '1.0.1'
     ext.spotbugs_version = '3.1.4'
-    ext.mozilla_components_version = '8.0.0'
+    ext.mozilla_components_version = '12.0.0'
+    ext.gecko_nightly_version = '71.0.20190913092859'
 
     repositories {
         google()
