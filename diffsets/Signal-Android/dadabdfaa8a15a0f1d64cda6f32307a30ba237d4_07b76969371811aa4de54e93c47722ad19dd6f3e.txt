diff --git a/src/org/thoughtcrime/securesms/crypto/KeyExchangeProcessor.java b/src/org/thoughtcrime/securesms/crypto/KeyExchangeProcessor.java
index 78de44d75a3..30595bf3c49 100644
--- a/src/org/thoughtcrime/securesms/crypto/KeyExchangeProcessor.java
+++ b/src/org/thoughtcrime/securesms/crypto/KeyExchangeProcessor.java
@@ -146,7 +146,7 @@ public void processKeyExchangeMessage(PreKeyBundleMessage message)
                    .saveIdentity(masterSecret, recipient, remoteIdentity);
   }
 
-  public void processKeyExchangeMessage(PreKeyEntity message) {
+  public void processKeyExchangeMessage(PreKeyEntity message, long threadId) {
     PublicKey remoteKey = new PublicKey(message.getKeyId(), message.getPublicKey());
     remoteKeyRecord.setCurrentRemoteKey(remoteKey);
     remoteKeyRecord.setLastRemoteKey(remoteKey);
@@ -166,6 +166,8 @@ public void processKeyExchangeMessage(PreKeyEntity message) {
 
     DatabaseFactory.getIdentityDatabase(context)
                    .saveIdentity(masterSecret, recipient, message.getIdentityKey());
+
+    broadcastSecurityUpdateEvent(context, threadId);
   }
 
   public void processKeyExchangeMessage(KeyExchangeMessage message, long threadId) {
@@ -202,6 +204,10 @@ public void processKeyExchangeMessage(KeyExchangeMessage message, long threadId)
 
     DecryptingQueue.scheduleRogueMessages(context, masterSecret, recipient);
 
+    broadcastSecurityUpdateEvent(context, threadId);
+  }
+
+  private static void broadcastSecurityUpdateEvent(Context context, long threadId) {
     Intent intent = new Intent(SECURITY_UPDATE_EVENT);
     intent.putExtra("thread_id", threadId);
     intent.setPackage(context.getPackageName());
diff --git a/src/org/thoughtcrime/securesms/database/SmsDatabase.java b/src/org/thoughtcrime/securesms/database/SmsDatabase.java
index 06800a3d207..100eb27a0ed 100644
--- a/src/org/thoughtcrime/securesms/database/SmsDatabase.java
+++ b/src/org/thoughtcrime/securesms/database/SmsDatabase.java
@@ -166,6 +166,10 @@ public void markAsCorruptKeyExchange(long id) {
     updateTypeBitmask(id, 0, Types.KEY_EXCHANGE_CORRUPTED_BIT);
   }
 
+  public void markAsSecure(long id) {
+    updateTypeBitmask(id, 0, Types.SECURE_MESSAGE_BIT);
+  }
+
   public void markAsDecryptFailed(long id) {
     updateTypeBitmask(id, Types.ENCRYPTION_MASK, Types.ENCRYPTION_REMOTE_FAILED_BIT);
   }
diff --git a/src/org/thoughtcrime/securesms/service/MmsSender.java b/src/org/thoughtcrime/securesms/service/MmsSender.java
index e63c576dfc1..a38d8130d4a 100644
--- a/src/org/thoughtcrime/securesms/service/MmsSender.java
+++ b/src/org/thoughtcrime/securesms/service/MmsSender.java
@@ -21,7 +21,6 @@
 import android.util.Log;
 import android.util.Pair;
 
-import org.whispersystems.textsecure.crypto.MasterSecret;
 import org.thoughtcrime.securesms.database.DatabaseFactory;
 import org.thoughtcrime.securesms.database.MmsDatabase;
 import org.thoughtcrime.securesms.database.ThreadDatabase;
@@ -30,23 +29,22 @@
 import org.thoughtcrime.securesms.service.SendReceiveService.ToastHandler;
 import org.thoughtcrime.securesms.transport.UndeliverableMessageException;
 import org.thoughtcrime.securesms.transport.UniversalTransport;
+import org.whispersystems.textsecure.crypto.MasterSecret;
 
 import ws.com.google.android.mms.MmsException;
 import ws.com.google.android.mms.pdu.SendReq;
 
 public class MmsSender {
 
-  private final Context      context;
-  private final ToastHandler toastHandler;
+  private final Context context;
 
   public MmsSender(Context context, ToastHandler toastHandler) {
-    this.context      = context;
-    this.toastHandler = toastHandler;
+    this.context = context;
   }
 
   public void process(MasterSecret masterSecret, Intent intent) {
     Log.w("MmsSender", "Got intent action: " + intent.getAction());
-    if (intent.getAction().equals(SendReceiveService.SEND_MMS_ACTION)) {
+    if (SendReceiveService.SEND_MMS_ACTION.equals(intent.getAction())) {
       handleSendMms(masterSecret, intent);
     }
   }
@@ -61,15 +59,16 @@ private void handleSendMms(MasterSecret masterSecret, Intent intent) {
       SendReq[] messages = database.getOutgoingMessages(masterSecret, messageId);
 
       for (SendReq message : messages) {
+        long threadId = database.getThreadIdForMessage(message.getDatabaseMessageId());
+
         try {
           Log.w("MmsSender", "Passing to MMS transport: " + message.getDatabaseMessageId());
           database.markAsSending(message.getDatabaseMessageId());
-          Pair<byte[], Integer> result = transport.deliver(message);
+          Pair<byte[], Integer> result = transport.deliver(message, threadId);
           database.markAsSent(message.getDatabaseMessageId(), result.first, result.second);
         } catch (UndeliverableMessageException e) {
           Log.w("MmsSender", e);
           database.markAsSentFailed(message.getDatabaseMessageId());
-          long threadId         = database.getThreadIdForMessage(messageId);
           Recipients recipients = threads.getRecipientsForThreadId(threadId);
           MessageNotifier.notifyMessageDeliveryFailed(context, recipients, threadId);
         }
diff --git a/src/org/thoughtcrime/securesms/service/SmsSender.java b/src/org/thoughtcrime/securesms/service/SmsSender.java
index a982bda6734..175f87ef545 100644
--- a/src/org/thoughtcrime/securesms/service/SmsSender.java
+++ b/src/org/thoughtcrime/securesms/service/SmsSender.java
@@ -83,14 +83,20 @@ private void handleSendMessage(MasterSecret masterSecret, Intent intent) {
   }
 
   private void handleSentMessage(Intent intent) {
-    long messageId = intent.getLongExtra("message_id", -1);
-    int result     = intent.getIntExtra("ResultCode", -31337);
+    long    messageId = intent.getLongExtra("message_id", -1);
+    int     result    = intent.getIntExtra("ResultCode", -31337);
+    boolean upgraded  = intent.getBooleanExtra("upgraded", false);
 
     Log.w("SMSReceiverService", "Intent resultcode: " + result);
     Log.w("SMSReceiverService", "Running sent callback: " + messageId);
 
     if (result == Activity.RESULT_OK) {
       DatabaseFactory.getSmsDatabase(context).markAsSent(messageId);
+
+      if (upgraded) {
+        DatabaseFactory.getSmsDatabase(context).markAsSecure(messageId);
+      }
+
       unregisterForRadioChanges();
     } else if (result == SmsManager.RESULT_ERROR_NO_SERVICE || result == SmsManager.RESULT_ERROR_RADIO_OFF) {
       DatabaseFactory.getSmsDatabase(context).markAsOutbox(messageId);
diff --git a/src/org/thoughtcrime/securesms/sms/MessageSender.java b/src/org/thoughtcrime/securesms/sms/MessageSender.java
index 8ef6347a185..b3aed40846a 100644
--- a/src/org/thoughtcrime/securesms/sms/MessageSender.java
+++ b/src/org/thoughtcrime/securesms/sms/MessageSender.java
@@ -133,6 +133,7 @@ private static void sendMms(Context context, Recipients recipients, MasterSecret
     Intent intent  = new Intent(SendReceiveService.SEND_MMS_ACTION, null,
                                 context, SendReceiveService.class);
     intent.putExtra("message_id", messageId);
+    intent.putExtra("thread_id", threadId);
 
     context.startService(intent);
   }
diff --git a/src/org/thoughtcrime/securesms/transport/BaseTransport.java b/src/org/thoughtcrime/securesms/transport/BaseTransport.java
index 9dc469ae084..bd357dc9f67 100644
--- a/src/org/thoughtcrime/securesms/transport/BaseTransport.java
+++ b/src/org/thoughtcrime/securesms/transport/BaseTransport.java
@@ -9,13 +9,14 @@
 
 public abstract class BaseTransport {
 
-  protected Intent constructSentIntent(Context context, long messageId, long type) {
+  protected Intent constructSentIntent(Context context, long messageId, long type, boolean upgraded) {
     Intent pending = new Intent(SendReceiveService.SENT_SMS_ACTION,
                                 Uri.parse("custom://" + messageId + System.currentTimeMillis()),
                                 context, SmsListener.class);
 
     pending.putExtra("type", type);
     pending.putExtra("message_id", messageId);
+    pending.putExtra("upgraded", upgraded);
 
     return pending;
   }
diff --git a/src/org/thoughtcrime/securesms/transport/PushTransport.java b/src/org/thoughtcrime/securesms/transport/PushTransport.java
index 8b4e897b03e..121dc3c4596 100644
--- a/src/org/thoughtcrime/securesms/transport/PushTransport.java
+++ b/src/org/thoughtcrime/securesms/transport/PushTransport.java
@@ -73,24 +73,27 @@ public void deliver(SmsMessageRecord message) throws IOException {
     try {
       TextSecurePushCredentials credentials = TextSecurePushCredentials.getInstance();
       Recipient                 recipient   = message.getIndividualRecipient();
+      long                      threadId    = message.getThreadId();
       PushServiceSocket         socket      = new PushServiceSocket(context, credentials);
       PushDestination           destination = PushDestination.create(context, credentials,
                                                                      recipient.getNumber());
 
       String   plaintextBody = message.getBody().getBody();
       byte[]   plaintext     = PushMessageContent.newBuilder().setBody(plaintextBody).build().toByteArray();
-      PushBody pushBody      = getEncryptedMessage(socket, recipient, destination, plaintext);
+      PushBody pushBody      = getEncryptedMessage(socket, threadId, recipient, destination, plaintext);
 
       socket.sendMessage(destination, pushBody);
 
-      context.sendBroadcast(constructSentIntent(context, message.getId(), message.getType()));
+      context.sendBroadcast(constructSentIntent(context, message.getId(), message.getType(), true));
     } catch (RateLimitException e) {
       Log.w("PushTransport", e);
       throw new IOException("Rate limit exceeded.");
     }
   }
 
-  public void deliver(SendReq message, List<PushDestination> destinations) throws IOException {
+  public void deliver(SendReq message, List<PushDestination> destinations, long threadId)
+      throws IOException
+  {
     try {
       TextSecurePushCredentials credentials = TextSecurePushCredentials.getInstance();
       PushServiceSocket         socket      = new PushServiceSocket(context, credentials);
@@ -118,7 +121,7 @@ public void deliver(SendReq message, List<PushDestination> destinations) throws
         }
 
         byte[]   plaintext = builder.build().toByteArray();
-        PushBody pushBody  = getEncryptedMessage(socket, recipients.getPrimaryRecipient(), destination, plaintext);
+        PushBody pushBody  = getEncryptedMessage(socket, threadId, recipients.getPrimaryRecipient(), destination, plaintext);
 
         pushBodies.add(pushBody);
       }
@@ -158,7 +161,7 @@ private List<PushAttachmentPointer> getPushAttachmentPointers(PushServiceSocket
     return attachments;
   }
 
-  private PushBody getEncryptedMessage(PushServiceSocket socket, Recipient recipient,
+  private PushBody getEncryptedMessage(PushServiceSocket socket, long threadId, Recipient recipient,
                                        PushDestination pushDestination, byte[] plaintext)
       throws IOException
   {
@@ -172,7 +175,7 @@ private PushBody getEncryptedMessage(PushServiceSocket socket, Recipient recipie
       return new PushBody(OutgoingPushMessage.TYPE_MESSAGE_PREKEY_BUNDLE, ciphertext);
     } else {
       Log.w("PushTransport", "Sending prekeybundle ciphertext message for new session...");
-      byte[] ciphertext = getEncryptedPrekeyBundleMessageForNewSession(socket, recipient, pushDestination, plaintext);
+      byte[] ciphertext = getEncryptedPrekeyBundleMessageForNewSession(socket, threadId, recipient, pushDestination, plaintext);
       return new PushBody(OutgoingPushMessage.TYPE_MESSAGE_PREKEY_BUNDLE, ciphertext);
     }
   }
@@ -190,6 +193,7 @@ private byte[] getEncryptedPrekeyBundleMessageForExistingSession(Recipient recip
   }
 
   private byte[] getEncryptedPrekeyBundleMessageForNewSession(PushServiceSocket socket,
+                                                              long threadId,
                                                               Recipient recipient,
                                                               PushDestination pushDestination,
                                                               byte[] plaintext)
@@ -200,7 +204,7 @@ private byte[] getEncryptedPrekeyBundleMessageForNewSession(PushServiceSocket so
     PreKeyEntity         preKey          = socket.getPreKey(pushDestination);
     KeyExchangeProcessor processor       = new KeyExchangeProcessor(context, masterSecret, recipient);
 
-    processor.processKeyExchangeMessage(preKey);
+    processor.processKeyExchangeMessage(preKey, threadId);
 
     MessageCipher       messageCipher       = new MessageCipher(context, masterSecret, identityKeyPair);
     CiphertextMessage   ciphertextMessage   = messageCipher.encrypt(recipient, plaintext);
diff --git a/src/org/thoughtcrime/securesms/transport/SmsTransport.java b/src/org/thoughtcrime/securesms/transport/SmsTransport.java
index 768e36d176b..38928059f1e 100644
--- a/src/org/thoughtcrime/securesms/transport/SmsTransport.java
+++ b/src/org/thoughtcrime/securesms/transport/SmsTransport.java
@@ -37,7 +37,6 @@
 import org.whispersystems.textsecure.crypto.MasterSecret;
 import org.whispersystems.textsecure.crypto.MessageCipher;
 import org.whispersystems.textsecure.crypto.ecc.Curve;
-import org.whispersystems.textsecure.crypto.ecc.ECPublicKey;
 import org.whispersystems.textsecure.crypto.protocol.CiphertextMessage;
 import org.whispersystems.textsecure.crypto.protocol.PreKeyBundleMessage;
 
@@ -70,7 +69,7 @@ private void deliverSecureMessage(SmsMessageRecord message) throws Undeliverable
     }
 
     ArrayList<String> messages                = multipartMessageHandler.divideMessage(transportMessage);
-    ArrayList<PendingIntent> sentIntents      = constructSentIntents(message.getId(), message.getType(), messages);
+    ArrayList<PendingIntent> sentIntents      = constructSentIntents(message.getId(), message.getType(), messages, true);
     ArrayList<PendingIntent> deliveredIntents = constructDeliveredIntents(message.getId(), message.getType(), messages);
 
     Log.w("SmsTransport", "Secure divide into message parts: " + messages.size());
@@ -103,7 +102,7 @@ private void deliverPlaintextMessage(SmsMessageRecord message)
       throws UndeliverableMessageException
   {
     ArrayList<String> messages                = SmsManager.getDefault().divideMessage(message.getBody().getBody());
-    ArrayList<PendingIntent> sentIntents      = constructSentIntents(message.getId(), message.getType(), messages);
+    ArrayList<PendingIntent> sentIntents      = constructSentIntents(message.getId(), message.getType(), messages, false);
     ArrayList<PendingIntent> deliveredIntents = constructDeliveredIntents(message.getId(), message.getType(), messages);
     String recipient                          = message.getIndividualRecipient().getNumber();
 
@@ -132,12 +131,14 @@ private void deliverPlaintextMessage(SmsMessageRecord message)
     }
   }
 
-  private ArrayList<PendingIntent> constructSentIntents(long messageId, long type, ArrayList<String> messages) {
+  private ArrayList<PendingIntent> constructSentIntents(long messageId, long type,
+                                                        ArrayList<String> messages, boolean secure)
+  {
     ArrayList<PendingIntent> sentIntents = new ArrayList<PendingIntent>(messages.size());
 
     for (String ignored : messages) {
       sentIntents.add(PendingIntent.getBroadcast(context, 0,
-                                                 constructSentIntent(context, messageId, type),
+                                                 constructSentIntent(context, messageId, type, secure),
                                                  0));
     }
 
diff --git a/src/org/thoughtcrime/securesms/transport/UniversalTransport.java b/src/org/thoughtcrime/securesms/transport/UniversalTransport.java
index 37fd4993cb9..4b5230c2566 100644
--- a/src/org/thoughtcrime/securesms/transport/UniversalTransport.java
+++ b/src/org/thoughtcrime/securesms/transport/UniversalTransport.java
@@ -76,7 +76,9 @@ public void deliver(SmsMessageRecord message) throws UndeliverableMessageExcepti
     }
   }
 
-  public Pair<byte[], Integer> deliver(SendReq mediaMessage) throws UndeliverableMessageException {
+  public Pair<byte[], Integer> deliver(SendReq mediaMessage, long threadId)
+      throws UndeliverableMessageException
+  {
     if (!TextSecurePreferences.isPushRegistered(context)) {
       return mmsTransport.deliver(mediaMessage);
     }
@@ -86,7 +88,7 @@ public Pair<byte[], Integer> deliver(SendReq mediaMessage) throws UndeliverableM
     if (isPushTransport(destinations)) {
       try {
         Log.w("UniversalTransport", "Delivering media message with GCM...");
-        pushTransport.deliver(mediaMessage, destinations);
+        pushTransport.deliver(mediaMessage, destinations, threadId);
         return new Pair<byte[], Integer>("push".getBytes("UTF-8"), 0);
       } catch (IOException ioe) {
         Log.w("UniversalTransport", ioe);
