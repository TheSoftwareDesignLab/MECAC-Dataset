diff --git a/.gitignore b/.gitignore
index cd6a3d9b15d8..1cbbb457376f 100644
--- a/.gitignore
+++ b/.gitignore
@@ -16,6 +16,7 @@ bin/
 gen/
 build/
 */build/
+captures/
 
 # Local configuration file (sdk path, etc)
 local.properties
@@ -46,3 +47,6 @@ WordPress/src/main/res/values/com_crashlytics_export_strings.xml
 
 # Monkey runner settings
 *.pyc
+
+# libs
+libs/utils
diff --git a/.travis.yml b/.travis.yml
index 797aec1f8a69..a656dc434d94 100644
--- a/.travis.yml
+++ b/.travis.yml
@@ -3,8 +3,10 @@ jdk: oraclejdk7
 
 android:
   components:
-    - build-tools-21.1.1
-    - android-19
+    - extra-android-m2repository
+    - extra-android-support
+    - build-tools-22.0.1
+    - android-22
 
 env:
   global:
@@ -13,4 +15,4 @@ env:
     - ANDROID_TARGET=android-14
 
 script:
-  - ./gradlew -PdisablePreDex build
+  - ./gradlew build
diff --git a/LICENSE-MIT b/LICENSE-MIT
deleted file mode 100644
index 63ecc8b97bb5..000000000000
--- a/LICENSE-MIT
+++ /dev/null
@@ -1,21 +0,0 @@
-The MIT License (MIT)
-
-Copyright (c) 2013 Automattic Inc.
-
-Permission is hereby granted, free of charge, to any person obtaining a copy
-of this software and associated documentation files (the "Software"), to deal
-in the Software without restriction, including without limitation the rights
-to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
-copies of the Software, and to permit persons to whom the Software is
-furnished to do so, subject to the following conditions:
-
-The above copyright notice and this permission notice shall be included in
-all copies or substantial portions of the Software.
-
-THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
-IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
-FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
-AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
-LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
-OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
-THE SOFTWARE.
\ No newline at end of file
diff --git a/LICENSE.md b/LICENSE.md
new file mode 100644
index 000000000000..0671f06ac7c3
--- /dev/null
+++ b/LICENSE.md
@@ -0,0 +1,264 @@
+The GNU General Public License, Version 2, June 1991 (GPLv2)
+============================================================
+
+> Copyright (C) 1989, 1991 Free Software Foundation, Inc.
+> 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA
+
+Everyone is permitted to copy and distribute verbatim copies of this license
+document, but changing it is not allowed.
+
+
+Preamble
+--------
+
+The licenses for most software are designed to take away your freedom to share
+and change it. By contrast, the GNU General Public License is intended to
+guarantee your freedom to share and change free software--to make sure the
+software is free for all its users. This General Public License applies to most
+of the Free Software Foundation's software and to any other program whose
+authors commit to using it. (Some other Free Software Foundation software is
+covered by the GNU Library General Public License instead.) You can apply it to
+your programs, too.
+
+When we speak of free software, we are referring to freedom, not price. Our
+General Public Licenses are designed to make sure that you have the freedom to
+distribute copies of free software (and charge for this service if you wish),
+that you receive source code or can get it if you want it, that you can change
+the software or use pieces of it in new free programs; and that you know you can
+do these things.
+
+To protect your rights, we need to make restrictions that forbid anyone to deny
+you these rights or to ask you to surrender the rights. These restrictions
+translate to certain responsibilities for you if you distribute copies of the
+software, or if you modify it.
+
+For example, if you distribute copies of such a program, whether gratis or for a
+fee, you must give the recipients all the rights that you have. You must make
+sure that they, too, receive or can get the source code. And you must show them
+these terms so they know their rights.
+
+We protect your rights with two steps: (1) copyright the software, and (2) offer
+you this license which gives you legal permission to copy, distribute and/or
+modify the software.
+
+Also, for each author's protection and ours, we want to make certain that
+everyone understands that there is no warranty for this free software. If the
+software is modified by someone else and passed on, we want its recipients to
+know that what they have is not the original, so that any problems introduced by
+others will not reflect on the original authors' reputations.
+
+Finally, any free program is threatened constantly by software patents. We wish
+to avoid the danger that redistributors of a free program will individually
+obtain patent licenses, in effect making the program proprietary. To prevent
+this, we have made it clear that any patent must be licensed for everyone's free
+use or not licensed at all.
+
+The precise terms and conditions for copying, distribution and modification
+follow.
+
+
+Terms And Conditions For Copying, Distribution And Modification
+---------------------------------------------------------------
+
+**0.** This License applies to any program or other work which contains a notice
+placed by the copyright holder saying it may be distributed under the terms of
+this General Public License. The "Program", below, refers to any such program or
+work, and a "work based on the Program" means either the Program or any
+derivative work under copyright law: that is to say, a work containing the
+Program or a portion of it, either verbatim or with modifications and/or
+translated into another language. (Hereinafter, translation is included without
+limitation in the term "modification".) Each licensee is addressed as "you".
+
+Activities other than copying, distribution and modification are not covered by
+this License; they are outside its scope. The act of running the Program is not
+restricted, and the output from the Program is covered only if its contents
+constitute a work based on the Program (independent of having been made by
+running the Program). Whether that is true depends on what the Program does.
+
+**1.** You may copy and distribute verbatim copies of the Program's source code
+as you receive it, in any medium, provided that you conspicuously and
+appropriately publish on each copy an appropriate copyright notice and
+disclaimer of warranty; keep intact all the notices that refer to this License
+and to the absence of any warranty; and give any other recipients of the Program
+a copy of this License along with the Program.
+
+You may charge a fee for the physical act of transferring a copy, and you may at
+your option offer warranty protection in exchange for a fee.
+
+**2.** You may modify your copy or copies of the Program or any portion of it,
+thus forming a work based on the Program, and copy and distribute such
+modifications or work under the terms of Section 1 above, provided that you also
+meet all of these conditions:
+
+*   **a)** You must cause the modified files to carry prominent notices stating
+    that you changed the files and the date of any change.
+
+*   **b)** You must cause any work that you distribute or publish, that in whole
+    or in part contains or is derived from the Program or any part thereof, to
+    be licensed as a whole at no charge to all third parties under the terms of
+    this License.
+
+*   **c)** If the modified program normally reads commands interactively when
+    run, you must cause it, when started running for such interactive use in the
+    most ordinary way, to print or display an announcement including an
+    appropriate copyright notice and a notice that there is no warranty (or
+    else, saying that you provide a warranty) and that users may redistribute
+    the program under these conditions, and telling the user how to view a copy
+    of this License. (Exception: if the Program itself is interactive but does
+    not normally print such an announcement, your work based on the Program is
+    not required to print an announcement.)
+
+These requirements apply to the modified work as a whole. If identifiable
+sections of that work are not derived from the Program, and can be reasonably
+considered independent and separate works in themselves, then this License, and
+its terms, do not apply to those sections when you distribute them as separate
+works. But when you distribute the same sections as part of a whole which is a
+work based on the Program, the distribution of the whole must be on the terms of
+this License, whose permissions for other licensees extend to the entire whole,
+and thus to each and every part regardless of who wrote it.
+
+Thus, it is not the intent of this section to claim rights or contest your
+rights to work written entirely by you; rather, the intent is to exercise the
+right to control the distribution of derivative or collective works based on the
+Program.
+
+In addition, mere aggregation of another work not based on the Program with the
+Program (or with a work based on the Program) on a volume of a storage or
+distribution medium does not bring the other work under the scope of this
+License.
+
+**3.** You may copy and distribute the Program (or a work based on it, under
+Section 2) in object code or executable form under the terms of Sections 1 and 2
+above provided that you also do one of the following:
+
+*   **a)** Accompany it with the complete corresponding machine-readable source
+    code, which must be distributed under the terms of Sections 1 and 2 above on
+    a medium customarily used for software interchange; or,
+
+*   **b)** Accompany it with a written offer, valid for at least three years, to
+    give any third party, for a charge no more than your cost of physically
+    performing source distribution, a complete machine-readable copy of the
+    corresponding source code, to be distributed under the terms of Sections 1
+    and 2 above on a medium customarily used for software interchange; or,
+
+*   **c)** Accompany it with the information you received as to the offer to
+    distribute corresponding source code. (This alternative is allowed only for
+    noncommercial distribution and only if you received the program in object
+    code or executable form with such an offer, in accord with Subsection b
+    above.)
+
+The source code for a work means the preferred form of the work for making
+modifications to it. For an executable work, complete source code means all the
+source code for all modules it contains, plus any associated interface
+definition files, plus the scripts used to control compilation and installation
+of the executable. However, as a special exception, the source code distributed
+need not include anything that is normally distributed (in either source or
+binary form) with the major components (compiler, kernel, and so on) of the
+operating system on which the executable runs, unless that component itself
+accompanies the executable.
+
+If distribution of executable or object code is made by offering access to copy
+from a designated place, then offering equivalent access to copy the source code
+from the same place counts as distribution of the source code, even though third
+parties are not compelled to copy the source along with the object code.
+
+**4.** You may not copy, modify, sublicense, or distribute the Program except as
+expressly provided under this License. Any attempt otherwise to copy, modify,
+sublicense or distribute the Program is void, and will automatically terminate
+your rights under this License. However, parties who have received copies, or
+rights, from you under this License will not have their licenses terminated so
+long as such parties remain in full compliance.
+
+**5.** You are not required to accept this License, since you have not signed
+it. However, nothing else grants you permission to modify or distribute the
+Program or its derivative works. These actions are prohibited by law if you do
+not accept this License. Therefore, by modifying or distributing the Program (or
+any work based on the Program), you indicate your acceptance of this License to
+do so, and all its terms and conditions for copying, distributing or modifying
+the Program or works based on it.
+
+**6.** Each time you redistribute the Program (or any work based on the
+Program), the recipient automatically receives a license from the original
+licensor to copy, distribute or modify the Program subject to these terms and
+conditions. You may not impose any further restrictions on the recipients'
+exercise of the rights granted herein. You are not responsible for enforcing
+compliance by third parties to this License.
+
+**7.** If, as a consequence of a court judgment or allegation of patent
+infringement or for any other reason (not limited to patent issues), conditions
+are imposed on you (whether by court order, agreement or otherwise) that
+contradict the conditions of this License, they do not excuse you from the
+conditions of this License. If you cannot distribute so as to satisfy
+simultaneously your obligations under this License and any other pertinent
+obligations, then as a consequence you may not distribute the Program at all.
+For example, if a patent license would not permit royalty-free redistribution of
+the Program by all those who receive copies directly or indirectly through you,
+then the only way you could satisfy both it and this License would be to refrain
+entirely from distribution of the Program.
+
+If any portion of this section is held invalid or unenforceable under any
+particular circumstance, the balance of the section is intended to apply and the
+section as a whole is intended to apply in other circumstances.
+
+It is not the purpose of this section to induce you to infringe any patents or
+other property right claims or to contest validity of any such claims; this
+section has the sole purpose of protecting the integrity of the free software
+distribution system, which is implemented by public license practices. Many
+people have made generous contributions to the wide range of software
+distributed through that system in reliance on consistent application of that
+system; it is up to the author/donor to decide if he or she is willing to
+distribute software through any other system and a licensee cannot impose that
+choice.
+
+This section is intended to make thoroughly clear what is believed to be a
+consequence of the rest of this License.
+
+**8.** If the distribution and/or use of the Program is restricted in certain
+countries either by patents or by copyrighted interfaces, the original copyright
+holder who places the Program under this License may add an explicit
+geographical distribution limitation excluding those countries, so that
+distribution is permitted only in or among countries not thus excluded. In such
+case, this License incorporates the limitation as if written in the body of this
+License.
+
+**9.** The Free Software Foundation may publish revised and/or new versions of
+the General Public License from time to time. Such new versions will be similar
+in spirit to the present version, but may differ in detail to address new
+problems or concerns.
+
+Each version is given a distinguishing version number. If the Program specifies
+a version number of this License which applies to it and "any later version",
+you have the option of following the terms and conditions either of that version
+or of any later version published by the Free Software Foundation. If the
+Program does not specify a version number of this License, you may choose any
+version ever published by the Free Software Foundation.
+
+**10.** If you wish to incorporate parts of the Program into other free programs
+whose distribution conditions are different, write to the author to ask for
+permission. For software which is copyrighted by the Free Software Foundation,
+write to the Free Software Foundation; we sometimes make exceptions for this.
+Our decision will be guided by the two goals of preserving the free status of
+all derivatives of our free software and of promoting the sharing and reuse of
+software generally.
+
+
+No Warranty
+-----------
+
+**11.** BECAUSE THE PROGRAM IS LICENSED FREE OF CHARGE, THERE IS NO WARRANTY FOR
+THE PROGRAM, TO THE EXTENT PERMITTED BY APPLICABLE LAW. EXCEPT WHEN OTHERWISE
+STATED IN WRITING THE COPYRIGHT HOLDERS AND/OR OTHER PARTIES PROVIDE THE PROGRAM
+"AS IS" WITHOUT WARRANTY OF ANY KIND, EITHER EXPRESSED OR IMPLIED, INCLUDING,
+BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A
+PARTICULAR PURPOSE. THE ENTIRE RISK AS TO THE QUALITY AND PERFORMANCE OF THE
+PROGRAM IS WITH YOU. SHOULD THE PROGRAM PROVE DEFECTIVE, YOU ASSUME THE COST OF
+ALL NECESSARY SERVICING, REPAIR OR CORRECTION.
+
+**12.** IN NO EVENT UNLESS REQUIRED BY APPLICABLE LAW OR AGREED TO IN WRITING
+WILL ANY COPYRIGHT HOLDER, OR ANY OTHER PARTY WHO MAY MODIFY AND/OR REDISTRIBUTE
+THE PROGRAM AS PERMITTED ABOVE, BE LIABLE TO YOU FOR DAMAGES, INCLUDING ANY
+GENERAL, SPECIAL, INCIDENTAL OR CONSEQUENTIAL DAMAGES ARISING OUT OF THE USE OR
+INABILITY TO USE THE PROGRAM (INCLUDING BUT NOT LIMITED TO LOSS OF DATA OR DATA
+BEING RENDERED INACCURATE OR LOSSES SUSTAINED BY YOU OR THIRD PARTIES OR A
+FAILURE OF THE PROGRAM TO OPERATE WITH ANY OTHER PROGRAMS), EVEN IF SUCH HOLDER
+OR OTHER PARTY HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGES.
diff --git a/README.md b/README.md
index 80a0172530d0..a3781d021ea1 100644
--- a/README.md
+++ b/README.md
@@ -1,9 +1,39 @@
-# WordPress-Android-Editor
+# WordPress-Editor-Android #
 
-## Introduction
+[![Build Status](https://travis-ci.org/wordpress-mobile/WordPress-Editor-Android.svg?branch=develop)](https://travis-ci.org/wordpress-mobile/WordPress-Editor-Android)
 
-The WordPress-Android-Editor is the text editor used in the [WordPress Android app](https://github.com/wordpress-mobile/WordPress-Android) to create and edit pages & posts. In short it's a simple, straightforward way to visually edit HTML.
+## Introduction ##
 
-## LICENSE
+WordPress-Editor-Android is the text editor used in the [WordPress Android app](https://github.com/wordpress-mobile/WordPress-Android) to create and edit pages & posts. In short it's a simple, straightforward way to visually edit HTML.
 
-This library is licensed under[MIT](LICENSE-MIT)
+## Build Instructions ##
+
+Post-checkout instructions for Windows, necessary to convert the assets symlink to a Windows symlink:
+
+From git bash, inside the cloned project root:
+
+    $ rm WordPressEditor/src/main/assets
+    $ git ls-files --deleted -z | git update-index --assume-unchanged -z --stdin
+
+Then, from a Windows command prompt:
+
+    mklink /D [PROJECT_ROOT]\WordPressEditor\src\main\assets %PROJECT_ROOT%\libs\editor-common\assets
+
+Finally, update `[PROJECT_ROOT]\.git\info\exclude` to ignore the symlink locally:
+
+    # assets symlink
+    WordPressEditor/src/main/assets
+
+## Testing ##
+
+This project has both unit testing and integration testing, maintained and run separately.
+
+Unit testing is done with the [Robolectric framework](http://robolectric.org/). To run unit tests simply run `gradlew testDebug`. Code coverage reports can be generated via [JaCoCo.](http://www.eclemma.org/jacoco/) To generate them locally run `gradlew jacocoTestReport`.
+
+Integration testing is done with the [Android testing framework](http://developer.android.com/tools/testing/testing_android.html). To run integration tests run `gradlew connectedAndroidTest`.
+
+Add new unit tests to `src/test/java/` and integration tests to `stc/androidTest/java/`.
+
+## LICENSE ##
+
+WordPress-Editor-Android is an Open Source project covered by the [GNU General Public License version 2](LICENSE.md).
diff --git a/WordPressEditor/build.gradle b/WordPressEditor/build.gradle
index f1b71cea54ed..5cec6ee06feb 100644
--- a/WordPressEditor/build.gradle
+++ b/WordPressEditor/build.gradle
@@ -3,11 +3,14 @@ buildscript {
         mavenCentral()
     }
     dependencies {
-        classpath 'com.android.tools.build:gradle:1.0.0'
+        classpath 'com.android.tools.build:gradle:1.2.3'
+        classpath 'org.robolectric:robolectric-gradle-plugin:1.1.0'
     }
 }
 
 apply plugin: 'com.android.library'
+apply plugin: 'org.robolectric'
+apply plugin: 'jacoco'
 apply plugin: 'maven'
 apply plugin: 'signing'
 
@@ -18,14 +21,14 @@ repositories {
 android {
     publishNonDefault true
 
-    compileSdkVersion 21
-    buildToolsVersion "21.1.1"
+    compileSdkVersion 22
+    buildToolsVersion "22.0.1"
 
     defaultConfig {
         versionCode 1
         versionName "1.0"
         minSdkVersion 14
-        targetSdkVersion 21
+        targetSdkVersion 22
     }
     buildTypes {
         release {
@@ -33,13 +36,33 @@ android {
             proguardFiles getDefaultProguardFile('proguard-android.txt'), 'proguard-rules.pro'
         }
     }
+
+    // Avoid 'duplicate files during packaging of APK' errors
+    packagingOptions {
+        exclude 'LICENSE.txt'
+        exclude 'META-INF/LICENSE.txt'
+        exclude 'META-INF/LICENSE'
+        exclude 'META-INF/NOTICE'
+        exclude 'META-INF/NOTICE.txt'
+    }
 }
 
 dependencies {
-    compile 'com.android.support:appcompat-v7:21.0.+'
-    compile 'com.android.support:support-v4:21.0.+'
+    compile 'com.android.support:appcompat-v7:22.2.0'
+    compile 'com.android.support:support-v4:22.2.0'
     compile 'org.wordpress:analytics:1.0.0'
-    compile 'org.wordpress:utils:1.3.0'
+    compile 'org.wordpress:utils:1.6.0'
+
+    // Test libraries
+    testCompile 'junit:junit:4.11'
+    testCompile 'org.mockito:mockito-core:1.10.19'
+    testCompile 'org.robolectric:robolectric:2.4'
+
+    // Workaround for IDE bug
+    // http://stackoverflow.com/questions/22246183/android-studio-doesnt-recognize-espresso-classes
+    provided 'junit:junit:4.11'
+    provided 'org.mockito:mockito-core:1.10.19'
+    provided 'org.robolectric:robolectric:2.4'
 }
 
 signing {
@@ -97,3 +120,45 @@ uploadArchives {
         }
     }
 }
+
+//
+// Testing and code coverage
+//
+
+android.testOptions.unitTests.all {
+    include '**/*Test.class'
+    exclude '**/ApplicationTest.class'
+}
+
+jacoco {
+    toolVersion = "0.7.1.201405082137"
+}
+
+// Use these to define which classes to include and exclude from code coverage analysis
+def coverageSourceDirs = [ 'src/main/java' ]
+def coverageExclusions = [ '**/R.class',
+                           '**/R$*.class',
+                           '**/*$ViewInjector*.*',
+                           '**/BuildConfig.*',
+                           '**/Manifest*.*',
+                           '**/Legacy**.class',
+                           '**/legacy/**/*.class' ]
+
+task jacocoTestReport(type: JacocoReport, dependsOn: "testDebug") {
+    group = "Reporting"
+    description = "Generate Jacoco coverage reports"
+
+    classDirectories = fileTree(
+            dir: 'build/intermediates/classes/debug',
+            excludes: coverageExclusions
+    )
+
+    additionalSourceDirs = files(coverageSourceDirs)
+    sourceDirectories = files(coverageSourceDirs)
+    executionData = files('build/jacoco/testDebug.exec')
+
+    reports {
+        xml.enabled = true
+        html.enabled = true
+    }
+}
diff --git a/WordPressEditor/lint.xml b/WordPressEditor/lint.xml
new file mode 100644
index 000000000000..b7b4876d98b8
--- /dev/null
+++ b/WordPressEditor/lint.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0" encoding="UTF-8"?>
+<lint>
+    <issue id="InvalidPackage">
+        <ignore regexp="robolectric-2.4.jar" />
+    </issue>
+</lint>
\ No newline at end of file
diff --git a/WordPressEditor/src/androidTest/AndroidManifest.xml b/WordPressEditor/src/androidTest/AndroidManifest.xml
new file mode 100644
index 000000000000..e05834c605df
--- /dev/null
+++ b/WordPressEditor/src/androidTest/AndroidManifest.xml
@@ -0,0 +1,11 @@
+<?xml version="1.0" encoding="utf-8"?>
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+    package="org.wordpress.android.editor" >
+    <application>
+        <activity android:name=".MockActivity"
+                  android:exported="false" />
+        <activity android:name=".MockEditorActivity"
+                  android:theme="@style/Theme.AppCompat.Light.DarkActionBar"
+                  android:exported="false"/>
+    </application>>
+</manifest>
diff --git a/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/EditorFragmentForTests.java b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/EditorFragmentForTests.java
new file mode 100644
index 000000000000..c06ffb8c892e
--- /dev/null
+++ b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/EditorFragmentForTests.java
@@ -0,0 +1,45 @@
+package org.wordpress.android.editor;
+
+import android.os.Bundle;
+import android.view.LayoutInflater;
+import android.view.View;
+import android.view.ViewGroup;
+
+import org.wordpress.android.editor.EditorFragment;
+import org.wordpress.android.editor.EditorWebViewAbstract;
+import org.wordpress.android.editor.R;
+
+import java.util.Map;
+
+public class EditorFragmentForTests extends EditorFragment {
+    protected EditorWebViewAbstract mWebView;
+
+    protected boolean mInitCalled = false;
+    protected boolean mDomLoaded = false;
+    protected boolean mOnSelectionStyleChangedCalled = false;
+
+    @Override
+    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
+        View view = super.onCreateView(inflater, container, savedInstanceState);
+        mWebView = (EditorWebViewAbstract) view.findViewById(R.id.webview);
+        return view;
+    }
+
+    @Override
+    protected void initJsEditor() {
+        super.initJsEditor();
+        mInitCalled = true;
+    }
+
+    @Override
+    public void onDomLoaded() {
+        super.onDomLoaded();
+        mDomLoaded = true;
+    }
+
+    @Override
+    public void onSelectionStyleChanged(final Map<String, Boolean> changeMap) {
+        super.onSelectionStyleChanged(changeMap);
+        mOnSelectionStyleChangedCalled = true;
+    }
+}
diff --git a/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/EditorFragmentTest.java b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/EditorFragmentTest.java
new file mode 100644
index 000000000000..955f455b71c8
--- /dev/null
+++ b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/EditorFragmentTest.java
@@ -0,0 +1,108 @@
+package org.wordpress.android.editor;
+
+import android.app.Activity;
+import android.test.ActivityInstrumentationTestCase2;
+import android.view.View;
+import android.widget.ToggleButton;
+
+import org.wordpress.android.editor.R;
+
+import java.util.HashMap;
+import java.util.Map;
+
+import static org.wordpress.android.editor.TestingUtils.waitFor;
+
+public class EditorFragmentTest extends ActivityInstrumentationTestCase2<MockEditorActivity> {
+    private Activity mActivity;
+    private EditorFragmentForTests mFragment;
+
+    public EditorFragmentTest() {
+        super(MockEditorActivity.class);
+    }
+
+    @Override
+    protected void setUp() throws Exception {
+        super.setUp();
+        mActivity = getActivity();
+        mFragment = (EditorFragmentForTests) mActivity.getFragmentManager().findFragmentByTag("editorFragment");
+    }
+
+    public void testDomLoadedCallbackReceived() {
+        // initJsEditor() should have been called on setup
+        assertTrue(mFragment.mInitCalled);
+
+        long start = System.currentTimeMillis();
+        while(!mFragment.mDomLoaded) {
+            waitFor(10);
+            if (System.currentTimeMillis() - start > 5000) {
+                throw(new RuntimeException("Callback wait timed out"));
+            }
+        }
+
+        // The JS editor should have sent out a callback when the DOM loaded, triggering onDomLoaded()
+        assertTrue(mFragment.mDomLoaded);
+    }
+
+    public void testFormatBarToggledOnSelectedFieldChanged() {
+        Map<String, String> selectionArgs = new HashMap<>();
+
+        selectionArgs.put("id", "zss_field_title");
+        mFragment.onSelectionChanged(selectionArgs);
+
+        waitFor(100);
+
+        View view = mFragment.getView();
+
+        if (view == null) {
+            throw(new IllegalStateException("Fragment view is empty"));
+        }
+
+        // The formatting buttons should be disabled while the title field is selected
+        ToggleButton mediaButton = (ToggleButton) view.findViewById(R.id.format_bar_button_media);
+        ToggleButton boldButton = (ToggleButton) view.findViewById(R.id.format_bar_button_bold);
+        ToggleButton italicButton = (ToggleButton) view.findViewById(R.id.format_bar_button_italic);
+        ToggleButton quoteButton = (ToggleButton) view.findViewById(R.id.format_bar_button_quote);
+        ToggleButton ulButton = (ToggleButton) view.findViewById(R.id.format_bar_button_ul);
+        ToggleButton olButton = (ToggleButton) view.findViewById(R.id.format_bar_button_ol);
+        ToggleButton linkButton = (ToggleButton) view.findViewById(R.id.format_bar_button_link);
+        ToggleButton strikethroughButton = (ToggleButton) view.findViewById(R.id.format_bar_button_strikethrough);
+
+        assertFalse(mediaButton.isEnabled());
+        assertFalse(boldButton.isEnabled());
+        assertFalse(italicButton.isEnabled());
+        assertFalse(quoteButton.isEnabled());
+        assertFalse(ulButton.isEnabled());
+        assertFalse(olButton.isEnabled());
+        assertFalse(linkButton.isEnabled());
+
+        if (strikethroughButton != null) {
+            assertFalse(strikethroughButton.isEnabled());
+        }
+
+        // The HTML button should always be enabled
+        ToggleButton htmlButton = (ToggleButton) view.findViewById(R.id.format_bar_button_html);
+        assertTrue(htmlButton.isEnabled());
+
+        selectionArgs.clear();
+        selectionArgs.put("id", "zss_field_content");
+        mFragment.onSelectionChanged(selectionArgs);
+
+        waitFor(100);
+
+        // The formatting buttons should be enabled while the content field is selected
+        assertTrue(mediaButton.isEnabled());
+        assertTrue(boldButton.isEnabled());
+        assertTrue(italicButton.isEnabled());
+        assertTrue(quoteButton.isEnabled());
+        assertTrue(ulButton.isEnabled());
+        assertTrue(olButton.isEnabled());
+        assertTrue(linkButton.isEnabled());
+
+        if (strikethroughButton != null) {
+            assertTrue(strikethroughButton.isEnabled());
+        }
+
+        // The HTML button should always be enabled
+        assertTrue(htmlButton.isEnabled());
+    }
+}
\ No newline at end of file
diff --git a/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/MockActivity.java b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/MockActivity.java
new file mode 100644
index 000000000000..d22446aee553
--- /dev/null
+++ b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/MockActivity.java
@@ -0,0 +1,7 @@
+package org.wordpress.android.editor;
+
+import android.app.Activity;
+
+public class MockActivity extends Activity {
+
+}
diff --git a/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/MockEditorActivity.java b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/MockEditorActivity.java
new file mode 100644
index 000000000000..b09ce03970fe
--- /dev/null
+++ b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/MockEditorActivity.java
@@ -0,0 +1,53 @@
+package org.wordpress.android.editor;
+
+import android.app.FragmentManager;
+import android.app.FragmentTransaction;
+import android.os.Bundle;
+import android.support.v7.app.ActionBarActivity;
+import android.widget.LinearLayout;
+
+import org.wordpress.android.editor.EditorFragment;
+import org.wordpress.android.editor.EditorFragmentAbstract;
+import org.wordpress.android.util.helpers.MediaFile;
+
+public class MockEditorActivity extends ActionBarActivity implements EditorFragmentAbstract.EditorFragmentListener {
+    public static final int LAYOUT_ID = 999;
+
+    @SuppressWarnings("ResourceType")
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+
+        LinearLayout linearLayout = new LinearLayout(this);
+        linearLayout.setId(LAYOUT_ID);
+        setContentView(linearLayout);
+
+        FragmentManager fragmentManager = getFragmentManager();
+        FragmentTransaction fragmentTransaction = fragmentManager.beginTransaction();
+
+        EditorFragment fragment = new EditorFragmentForTests();
+        fragmentTransaction.add(linearLayout.getId(), fragment, "editorFragment");
+        fragmentTransaction.commit();
+    }
+
+    @Override
+    public void onEditorFragmentInitialized() {
+
+    }
+
+    @Override
+    public void onSettingsClicked() {
+
+    }
+
+    @Override
+    public void onAddMediaClicked() {
+
+    }
+
+    @Override
+    public void saveMediaFile(MediaFile mediaFile) {
+
+    }
+}
+
diff --git a/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/TestingUtils.java b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/TestingUtils.java
new file mode 100644
index 000000000000..e51cba6bafd2
--- /dev/null
+++ b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/TestingUtils.java
@@ -0,0 +1,14 @@
+package org.wordpress.android.editor;
+
+import org.wordpress.android.util.AppLog;
+
+public class TestingUtils {
+
+    static public void waitFor(long milliseconds) {
+        try {
+            Thread.sleep(milliseconds);
+        } catch(InterruptedException e) {
+            AppLog.e(AppLog.T.EDITOR, "Thread interrupted");
+        }
+    }
+}
diff --git a/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/ZssEditorTest.java b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/ZssEditorTest.java
new file mode 100644
index 000000000000..f25d937e1c99
--- /dev/null
+++ b/WordPressEditor/src/androidTest/java/org.wordpress.android.editor/ZssEditorTest.java
@@ -0,0 +1,107 @@
+package org.wordpress.android.editor;
+
+import android.annotation.SuppressLint;
+import android.app.Activity;
+import android.app.Instrumentation;
+import android.test.ActivityInstrumentationTestCase2;
+import android.webkit.JavascriptInterface;
+
+import org.wordpress.android.editor.EditorWebView;
+import org.wordpress.android.editor.EditorWebViewAbstract;
+import org.wordpress.android.editor.Utils;
+
+import java.util.HashSet;
+import java.util.Set;
+import java.util.concurrent.CountDownLatch;
+import java.util.concurrent.TimeUnit;
+
+/**
+ * Tests for the <code>ZSSEditor</code> inside an <code>EditorWebViewAbstract</code>, with no UI.
+ */
+public class ZssEditorTest extends ActivityInstrumentationTestCase2<MockActivity> {
+    private static final String JS_CALLBACK_HANDLER = "nativeCallbackHandler";
+
+    private Instrumentation mInstrumentation;
+    private EditorWebViewAbstract mWebView;
+
+    private CountDownLatch mSetUpLatch;
+
+    private TestMethod mTestMethod;
+    private CountDownLatch mCallbackLatch;
+    private CountDownLatch mDomLoadedCallbackLatch;
+    private Set<String> mCallbackSet;
+
+    private enum TestMethod {
+        INIT
+    }
+
+    public ZssEditorTest() {
+        super(MockActivity.class);
+    }
+
+    @SuppressLint("AddJavascriptInterface")
+    @Override
+    protected void setUp() throws Exception {
+        super.setUp();
+        mInstrumentation = getInstrumentation();
+        Activity activity = getActivity();
+        mSetUpLatch = new CountDownLatch(1);
+        mDomLoadedCallbackLatch = new CountDownLatch(1);
+
+        mSetUpLatch.countDown();
+
+        final String htmlEditor = Utils.getHtmlFromFile(activity, "android-editor.html");
+        activity.runOnUiThread(new Runnable() {
+            @Override
+            public void run() {
+                mWebView = new EditorWebView(mInstrumentation.getContext(), null);
+                mWebView.addJavascriptInterface(new MockJsCallbackReceiver(), JS_CALLBACK_HANDLER);
+                mWebView.loadDataWithBaseURL("file:///android_asset/", htmlEditor, "text/html", "utf-8", "");
+                mSetUpLatch.countDown();
+            }
+        });
+    }
+
+    public void testInitialization() throws InterruptedException {
+        // Wait for setUp() to finish initializing the WebView
+        mSetUpLatch.await();
+
+        // Identify this method to the MockJsCallbackReceiver
+        mTestMethod = TestMethod.INIT;
+
+        // Expecting three startup callbacks from the ZSS editor
+        mCallbackLatch = new CountDownLatch(3);
+        mCallbackSet = new HashSet<>();
+        boolean callbacksReceived = mCallbackLatch.await(5, TimeUnit.SECONDS);
+        assertTrue(callbacksReceived);
+
+        Set<String> expectedSet = new HashSet<>();
+        expectedSet.add("callback-new-field:id=zss_field_title");
+        expectedSet.add("callback-new-field:id=zss_field_content");
+        expectedSet.add("callback-dom-loaded:undefined");
+
+        assertEquals(expectedSet, mCallbackSet);
+    }
+
+    private class MockJsCallbackReceiver {
+        @JavascriptInterface
+        public void executeCallback(String callbackId, String params) {
+            if (callbackId.equals("callback-dom-loaded")) {
+                // Notify test methods that the dom has loaded
+                mDomLoadedCallbackLatch.countDown();
+            }
+
+            // Handle callbacks and count down latches according to the currently running test
+            switch(mTestMethod) {
+                case INIT:
+                    if (callbackId.equals("callback-new-field") || callbackId.equals("callback-dom-loaded")) {
+                        mCallbackSet.add(callbackId + ":" + params);
+                        mCallbackLatch.countDown();
+                    }
+                    break;
+                default:
+                    throw(new RuntimeException("Unknown calling method"));
+            }
+        }
+    }
+}
diff --git a/WordPressEditor/src/main/AndroidManifest.xml b/WordPressEditor/src/main/AndroidManifest.xml
index a450a0b8b95f..fcade320900d 100644
--- a/WordPressEditor/src/main/AndroidManifest.xml
+++ b/WordPressEditor/src/main/AndroidManifest.xml
@@ -1,5 +1,7 @@
 <?xml version="1.0" encoding="utf-8"?>
 <manifest xmlns:android="http://schemas.android.com/apk/res/android"
     package="org.wordpress.android.editor" >
-
+    <application>
+        <activity android:name=".legacy.EditLinkActivity" />
+    </application>>
 </manifest>
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragment.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragment.java
old mode 100644
new mode 100755
index b14ab2adde8f..793a4e7ed823
--- a/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragment.java
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragment.java
@@ -1,33 +1,65 @@
 package org.wordpress.android.editor;
 
 import android.annotation.SuppressLint;
-import android.content.res.AssetManager;
+import android.content.res.Configuration;
+import android.os.Build;
 import android.os.Bundle;
+import android.os.Looper;
+import android.support.v7.app.ActionBar;
+import android.support.v7.app.ActionBarActivity;
+import android.text.Spanned;
 import android.view.LayoutInflater;
+import android.view.MotionEvent;
 import android.view.View;
 import android.view.ViewGroup;
-import android.webkit.ConsoleMessage;
-import android.webkit.JsResult;
-import android.webkit.WebChromeClient;
-import android.webkit.WebSettings;
 import android.webkit.WebView;
-import android.webkit.WebViewClient;
+import android.widget.ToggleButton;
+
+import com.android.volley.toolbox.ImageLoader;
 
 import org.wordpress.android.util.AppLog;
 import org.wordpress.android.util.AppLog.T;
+import org.wordpress.android.util.StringUtils;
+import org.wordpress.android.util.helpers.MediaFile;
+import org.wordpress.android.util.helpers.MediaGallery;
 
-import java.io.BufferedReader;
-import java.io.IOException;
-import java.io.InputStream;
-import java.io.InputStreamReader;
+import java.util.HashMap;
+import java.util.Map;
+import java.util.concurrent.CountDownLatch;
+import java.util.concurrent.TimeUnit;
 
-public class EditorFragment extends EditorFragmentAbstract {
+public class EditorFragment extends EditorFragmentAbstract implements View.OnClickListener, View.OnTouchListener,
+        OnJsEditorStateChangedListener {
     private static final String ARG_PARAM_TITLE = "param_title";
     private static final String ARG_PARAM_CONTENT = "param_content";
 
-    private String mParamTitle;
-    private String mParamContent;
-    private WebView mWebView;
+    private static final String JS_CALLBACK_HANDLER = "nativeCallbackHandler";
+
+    private static final String TAG_FORMAT_BAR_BUTTON_MEDIA = "media";
+    private static final String TAG_FORMAT_BAR_BUTTON_BOLD = "bold";
+    private static final String TAG_FORMAT_BAR_BUTTON_ITALIC = "italic";
+    private static final String TAG_FORMAT_BAR_BUTTON_QUOTE = "blockquote";
+    private static final String TAG_FORMAT_BAR_BUTTON_UL = "unorderedList";
+    private static final String TAG_FORMAT_BAR_BUTTON_OL = "orderedList";
+    private static final String TAG_FORMAT_BAR_BUTTON_LINK = "link";
+    private static final String TAG_FORMAT_BAR_BUTTON_STRIKETHROUGH = "strikeThrough";
+
+    private static final float TOOLBAR_ALPHA_ENABLED = 1;
+    private static final float TOOLBAR_ALPHA_DISABLED = 0.5f;
+
+    private String mTitle = "";
+    private String mContentHtml = "";
+
+    private ActionBarActivity mActivity;
+    private EditorWebViewAbstract mWebView;
+    private ActionBar mActionBar;
+
+    private boolean mHideActionBarOnSoftKeyboardUp;
+
+    private CountDownLatch mGetTitleCountDownLatch;
+    private CountDownLatch mGetContentCountDownLatch;
+
+    private final Map<String, ToggleButton> mTagToggleButtonMap = new HashMap<>();
 
     public static EditorFragment newInstance(String title, String content) {
         EditorFragment fragment = new EditorFragment();
@@ -44,18 +76,72 @@ public EditorFragment() {
     @Override
     public void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
-        if (getArguments() != null) {
-            mParamTitle = getArguments().getString(ARG_PARAM_TITLE);
-            mParamContent = getArguments().getString(ARG_PARAM_CONTENT);
-        }
+        mActivity = (ActionBarActivity) getActivity();
+        mActionBar = mActivity.getSupportActionBar();
     }
 
     @Override
-    public View onCreateView(LayoutInflater inflater, ViewGroup container,
-                             Bundle savedInstanceState) {
+    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
         View view = inflater.inflate(R.layout.fragment_editor, container, false);
-        mWebView = (WebView) view.findViewById(R.id.webview);
-        initWebView();
+
+        mWebView = (EditorWebViewAbstract) view.findViewById(R.id.webview);
+
+        mWebView.setOnTouchListener(this);
+
+        // Setup hiding the action bar when the soft keyboard is displayed for narrow viewports
+        if (getResources().getConfiguration().orientation == Configuration.ORIENTATION_LANDSCAPE
+                && !getResources().getBoolean(R.bool.is_large_tablet_landscape)) {
+            mHideActionBarOnSoftKeyboardUp = true;
+        }
+
+        // Intercept back key presses while the keyboard is up, and reveal the action bar
+        mWebView.setOnImeBackListener(new EditorWebViewAbstract.OnImeBackListener() {
+            @Override
+            public void onImeBack() {
+                if (mHideActionBarOnSoftKeyboardUp && mActionBar != null && !mActionBar.isShowing()) {
+                    mActionBar.show();
+                }
+            }
+        });
+
+        mEditorFragmentListener.onEditorFragmentInitialized();
+
+        initJsEditor();
+
+        ToggleButton mediaButton = (ToggleButton) view.findViewById(R.id.format_bar_button_media);
+        mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_MEDIA, mediaButton);
+
+        ToggleButton boldButton = (ToggleButton) view.findViewById(R.id.format_bar_button_bold);
+        mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_BOLD, boldButton);
+
+        ToggleButton italicButton = (ToggleButton) view.findViewById(R.id.format_bar_button_italic);
+        mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_ITALIC, italicButton);
+
+        ToggleButton quoteButton = (ToggleButton) view.findViewById(R.id.format_bar_button_quote);
+        mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_QUOTE, quoteButton);
+
+        ToggleButton ulButton = (ToggleButton) view.findViewById(R.id.format_bar_button_ul);
+        mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_UL, ulButton);
+
+        ToggleButton olButton = (ToggleButton) view.findViewById(R.id.format_bar_button_ol);
+        mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_OL, olButton);
+
+        ToggleButton linkButton = (ToggleButton) view.findViewById(R.id.format_bar_button_link);
+        mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_LINK, linkButton);
+
+        // Tablet-only
+        ToggleButton strikethroughButton = (ToggleButton) view.findViewById(R.id.format_bar_button_strikethrough);
+        if (strikethroughButton != null) {
+            mTagToggleButtonMap.put(TAG_FORMAT_BAR_BUTTON_STRIKETHROUGH, strikethroughButton);
+        }
+
+        ToggleButton htmlButton = (ToggleButton) view.findViewById(R.id.format_bar_button_html);
+        htmlButton.setOnClickListener(this);
+
+        for (ToggleButton button : mTagToggleButtonMap.values()) {
+            button.setOnClickListener(this);
+        }
+
         return view;
     }
 
@@ -64,83 +150,234 @@ public void onDetach() {
         super.onDetach();
     }
 
-    @SuppressLint("SetJavaScriptEnabled")
-    private void initWebView() {
-        WebSettings webSettings = mWebView.getSettings();
-        webSettings.setJavaScriptEnabled(true);
-        webSettings.setDefaultTextEncodingName("utf-8");
-        mWebView.setWebViewClient(new WebViewClient() {
-            public void onReceivedError(WebView view, int errorCode, String description, String failingUrl) {
-                AppLog.e(T.EDITOR, description);
-            }
-        });
-        mWebView.setWebChromeClient(new WebChromeClient() {
-            public boolean onConsoleMessage(ConsoleMessage cm) {
-                AppLog.e(T.EDITOR, cm.message() + " -- From line " + cm.lineNumber() + " of " + cm.sourceId());
-                return true;
-            }
+    @Override
+    public void onConfigurationChanged(Configuration newConfig) {
+        super.onConfigurationChanged(newConfig);
 
-            @Override
-            public boolean onJsAlert(WebView view, String url, String message, JsResult result) {
-                AppLog.e(T.EDITOR, message);
-                return true;
-            }
+        // Toggle action bar auto-hiding for the new orientation
+        if (newConfig.orientation == Configuration.ORIENTATION_LANDSCAPE
+                && !getResources().getBoolean(R.bool.is_large_tablet_landscape)) {
+            mHideActionBarOnSoftKeyboardUp = true;
+        } else {
+            mHideActionBarOnSoftKeyboardUp = false;
+        }
+    }
+
+    protected void initJsEditor() {
+        String htmlEditor = Utils.getHtmlFromFile(mActivity, "android-editor.html");
+
+        mWebView.addJavascriptInterface(new JsCallbackReceiver(this), JS_CALLBACK_HANDLER);
 
-            @Override
-            public void onConsoleMessage(String message, int lineNumber, String sourceId) {
-                AppLog.e(T.EDITOR, message + " -- from line " + lineNumber + " of " + sourceId);
-            }
-        });
-        String htmlEditor = getHtmlEditor();
         mWebView.loadDataWithBaseURL("file:///android_asset/", htmlEditor, "text/html", "utf-8", "");
+
+        enableWebDebugging(true);
     }
 
-    private String getStringFromAsset(String filename) throws IOException {
-        if (!isAdded()) {
-            return null;
+    @Override
+    public void onClick(View v) {
+        int id = v.getId();
+        if (id == R.id.format_bar_button_bold) {
+            mWebView.execJavaScriptFromString("ZSSEditor.setBold();");
+        } else if (id == R.id.format_bar_button_italic) {
+            mWebView.execJavaScriptFromString("ZSSEditor.setItalic();");
+        } else if (id == R.id.format_bar_button_strikethrough) {
+            mWebView.execJavaScriptFromString("ZSSEditor.setStrikeThrough();");
+        } else if (id == R.id.format_bar_button_quote) {
+            mWebView.execJavaScriptFromString("ZSSEditor.setBlockquote();");
+        } else if (id == R.id.format_bar_button_ul) {
+            mWebView.execJavaScriptFromString("ZSSEditor.setUnorderedList();");
+        } else if (id == R.id.format_bar_button_ol) {
+            mWebView.execJavaScriptFromString("ZSSEditor.setOrderedList();");
+        } else if (id == R.id.format_bar_button_media) {
+            // TODO: Handle inserting media
+            ((ToggleButton) v).setChecked(false);
+        } else if (id == R.id.format_bar_button_link) {
+            // TODO: Handle inserting a link
+            ((ToggleButton) v).setChecked(false);
+        } else if (id == R.id.format_bar_button_html) {
+            // TODO: Handle HTML mode toggling
+            ((ToggleButton) v).setChecked(false);
         }
-        AssetManager assetManager = getActivity().getAssets();
-        InputStream in = assetManager.open(filename);
-        InputStreamReader is = new InputStreamReader(in);
-        StringBuilder sb = new StringBuilder();
-        BufferedReader br = new BufferedReader(is);
-        String read = br.readLine();
-        while (read != null) {
-            sb.append(read);
-            sb.append('\n');
-            read = br.readLine();
+    }
+
+    @Override
+    public boolean onTouch(View view, MotionEvent event) {
+        if (mHideActionBarOnSoftKeyboardUp && event.getAction() == MotionEvent.ACTION_UP) {
+            // If the WebView has received a touch event, the keyboard will be displayed and the action bar should hide
+            if (isAdded() && mActionBar != null && mActionBar.isShowing()) {
+                mActionBar.hide();
+                return false;
+            }
         }
-        return sb.toString();
+        return false;
     }
 
-    private String getHtmlEditor() {
-        try {
-            return getStringFromAsset("android-editor.html");
-        } catch (IOException e) {
-            AppLog.e(T.EDITOR, e.getMessage());
-            return null;
+    @SuppressLint("NewApi")
+    private void enableWebDebugging(boolean enable) {
+        if(Build.VERSION.SDK_INT >= Build.VERSION_CODES.KITKAT) {
+            AppLog.i(T.EDITOR, "Enabling web debugging");
+            WebView.setWebContentsDebuggingEnabled(enable);
         }
     }
 
     @Override
     public void setTitle(CharSequence text) {
-        // TODO
+        mTitle = text.toString();
     }
 
     @Override
     public void setContent(CharSequence text) {
-        // TODO
+        mContentHtml = text.toString();
     }
 
+    /**
+     * Returns the contents of the title field from the JavaScript editor. Should be called from a background thread
+     * where possible.
+     */
     @Override
     public CharSequence getTitle() {
-        // TODO
-        return null;
+        if (Looper.myLooper() == Looper.getMainLooper()) {
+            AppLog.d(T.EDITOR, "getTitle() called from UI thread");
+        }
+
+        mGetTitleCountDownLatch = new CountDownLatch(1);
+
+        // All WebView methods must be called from the UI thread
+        mActivity.runOnUiThread(new Runnable() {
+            @Override
+            public void run() {
+                mWebView.execJavaScriptFromString("ZSSEditor.getField('zss_field_title').getHTMLForCallback();");
+            }
+        });
+
+        try {
+            mGetTitleCountDownLatch.await(1, TimeUnit.SECONDS);
+        } catch (InterruptedException e) {
+            AppLog.e(T.EDITOR, e);
+            Thread.currentThread().interrupt();
+        }
+
+        return StringUtils.notNullStr(mTitle);
     }
 
+    /**
+     * Returns the contents of the content field from the JavaScript editor. Should be called from a background thread
+     * where possible.
+     */
     @Override
     public CharSequence getContent() {
+        if (Looper.myLooper() == Looper.getMainLooper()) {
+            AppLog.d(T.EDITOR, "getContent() called from UI thread");
+        }
+
+        mGetContentCountDownLatch = new CountDownLatch(1);
+
+        // All WebView methods must be called from the UI thread
+        mActivity.runOnUiThread(new Runnable() {
+            @Override
+            public void run() {
+                mWebView.execJavaScriptFromString("ZSSEditor.getField('zss_field_content').getHTMLForCallback();");
+            }
+        });
+
+        try {
+            mGetContentCountDownLatch.await(1, TimeUnit.SECONDS);
+        } catch (InterruptedException e) {
+            AppLog.e(T.EDITOR, e);
+            Thread.currentThread().interrupt();
+        }
+
+        return StringUtils.notNullStr(mContentHtml);
+    }
+
+    @Override
+    public void appendMediaFile(MediaFile mediaFile, String imageUrl, ImageLoader imageLoader) {
+        // TODO
+    }
+
+    @Override
+    public void appendGallery(MediaGallery mediaGallery) {
         // TODO
+    }
+
+    @Override
+    public Spanned getSpannedContent() {
         return null;
     }
+
+    public void onDomLoaded() {
+        mWebView.post(new Runnable() {
+            public void run() {
+                mWebView.execJavaScriptFromString("ZSSEditor.getField('zss_field_content').setMultiline('true');");
+
+                // Load title and content into ZSSEditor
+                mWebView.execJavaScriptFromString("ZSSEditor.getField('zss_field_title').setHTML('" +
+                        Utils.escapeHtml(mTitle) + "');");
+                mWebView.execJavaScriptFromString("ZSSEditor.getField('zss_field_content').setHTML('" +
+                        Utils.escapeHtml(mContentHtml) + "');");
+
+                if (mHideActionBarOnSoftKeyboardUp) {
+                    mActionBar.hide();
+                }
+            }
+        });
+    }
+
+    public void onSelectionStyleChanged(final Map<String, Boolean> changeMap) {
+        mWebView.post(new Runnable() {
+            public void run() {
+                for (Map.Entry<String, Boolean> entry : changeMap.entrySet()) {
+                    // Handle toggling format bar style buttons
+                    ToggleButton button = mTagToggleButtonMap.get(entry.getKey());
+                    if (button != null) {
+                        button.setChecked(entry.getValue());
+                    }
+                }
+            }
+        });
+    }
+
+    public void onSelectionChanged(final Map<String, String> selectionArgs) {
+        final String focusedFieldId = selectionArgs.get("id"); // The field now in focus
+        mWebView.post(new Runnable() {
+            @Override
+            public void run() {
+                if (!focusedFieldId.isEmpty()) {
+                    switch(focusedFieldId) {
+                        case "zss_field_title":
+                            updateToolbarEnabledState(false);
+                            break;
+                        case "zss_field_content":
+                            updateToolbarEnabledState(true);
+                            break;
+                    }
+                }
+            }
+        });
+    }
+
+    public void onGetHtmlResponse(Map<String, String> inputArgs) {
+        String fieldId = inputArgs.get("id");
+        String fieldContents = inputArgs.get("contents");
+        if (!fieldId.isEmpty()) {
+            switch (fieldId) {
+                case "zss_field_title":
+                    mTitle = fieldContents;
+                    mGetTitleCountDownLatch.countDown();
+                    break;
+                case "zss_field_content":
+                    mContentHtml = fieldContents;
+                    mGetContentCountDownLatch.countDown();
+                    break;
+            }
+        }
+    }
+
+    void updateToolbarEnabledState(boolean enabled) {
+        float alpha = (enabled ? TOOLBAR_ALPHA_ENABLED : TOOLBAR_ALPHA_DISABLED);
+        for(ToggleButton button : mTagToggleButtonMap.values()) {
+            button.setEnabled(enabled);
+            button.setAlpha(alpha);
+        }
+    }
 }
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragmentAbstract.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragmentAbstract.java
index c7d437f95125..75dd0e5bdc89 100644
--- a/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragmentAbstract.java
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorFragmentAbstract.java
@@ -2,14 +2,33 @@
 
 import android.app.Activity;
 import android.app.Fragment;
+import android.os.Bundle;
+
+import android.text.Spanned;
+
+import com.android.volley.toolbox.ImageLoader;
+
+import org.wordpress.android.util.helpers.MediaFile;
+import org.wordpress.android.util.helpers.MediaGallery;
 
 public abstract class EditorFragmentAbstract extends Fragment {
     public abstract void setTitle(CharSequence text);
     public abstract void setContent(CharSequence text);
     public abstract CharSequence getTitle();
     public abstract CharSequence getContent();
+    public abstract void appendMediaFile(MediaFile mediaFile, String imageUrl, ImageLoader imageLoader);
+    public abstract void appendGallery(MediaGallery mediaGallery);
+
+    // TODO: remove this as soon as we can (we'll need to drop the legacy editor or fix html2spanned translation)
+    public abstract Spanned getSpannedContent();
+
+    private static final String FEATURED_IMAGE_SUPPORT_KEY = "featured-image-supported";
+    private static final String FEATURED_IMAGE_WIDTH_KEY   = "featured-image-width";
 
     protected EditorFragmentListener mEditorFragmentListener;
+    protected boolean mFeaturedImageSupported;
+    protected String mBlogSettingMaxImageWidth;
+    protected ImageLoader mImageLoader;
 
     @Override
     public void onAttach(Activity activity) {
@@ -21,8 +40,65 @@ public void onAttach(Activity activity) {
         }
     }
 
+    @Override
+    public void onSaveInstanceState(Bundle outState) {
+        super.onSaveInstanceState(outState);
+
+        outState.putBoolean(FEATURED_IMAGE_SUPPORT_KEY, mFeaturedImageSupported);
+        outState.putString(FEATURED_IMAGE_WIDTH_KEY, mBlogSettingMaxImageWidth);
+    }
+
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+
+        if (savedInstanceState != null) {
+            if (savedInstanceState.containsKey(FEATURED_IMAGE_SUPPORT_KEY)) {
+                mFeaturedImageSupported = savedInstanceState.getBoolean(FEATURED_IMAGE_SUPPORT_KEY);
+            }
+            if (savedInstanceState.containsKey(FEATURED_IMAGE_WIDTH_KEY)) {
+                mBlogSettingMaxImageWidth = savedInstanceState.getString(FEATURED_IMAGE_WIDTH_KEY);
+            }
+        }
+    }
+
+    public void setImageLoader(ImageLoader imageLoader) {
+        mImageLoader = imageLoader;
+    }
+
+    public void setFeaturedImageSupported(boolean featuredImageSupported) {
+        mFeaturedImageSupported = featuredImageSupported;
+    }
+
+    public void setBlogSettingMaxImageWidth(String blogSettingMaxImageWidth) {
+        mBlogSettingMaxImageWidth = blogSettingMaxImageWidth;
+    }
+
+    /**
+     * Called by the activity when back button is pressed.
+     */
+    public boolean onBackPressed() {
+        return false;
+    }
+
+    /**
+     * The editor may need to differentiate local draft and published articles
+     *
+     * @param isLocalDraft edited post is a local draft
+     */
+    public void setLocalDraft(boolean isLocalDraft) {
+        // Not unused in the new editor
+    }
+
+    /**
+     * Callbacks used to communicate with the parent Activity
+     */
     public interface EditorFragmentListener {
+        public void onEditorFragmentInitialized();
         public void onSettingsClicked();
-        public void onAddMediaButtonClicked();
+        public void onAddMediaClicked();
+        // TODO: remove saveMediaFile, it's currently needed for the legacy editor - we should have something like
+        // "EditorFragmentAbstract.getFeaturedImage()" returning the remote id
+        public void saveMediaFile(MediaFile mediaFile);
     }
 }
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebView.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebView.java
new file mode 100644
index 000000000000..f9daf0485b09
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebView.java
@@ -0,0 +1,23 @@
+package org.wordpress.android.editor;
+
+import android.annotation.SuppressLint;
+import android.content.Context;
+import android.os.Build;
+import android.util.AttributeSet;
+
+public class EditorWebView extends EditorWebViewAbstract {
+
+    public EditorWebView(Context context, AttributeSet attrs) {
+        super(context, attrs);
+    }
+
+    @SuppressLint("NewApi")
+    public void execJavaScriptFromString(String javaScript) {
+        if (Build.VERSION.SDK_INT >= 19) {
+            this.evaluateJavascript(javaScript, null);
+        } else {
+            this.loadUrl("javascript:" + javaScript);
+        }
+    }
+
+}
\ No newline at end of file
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebViewAbstract.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebViewAbstract.java
new file mode 100644
index 000000000000..902e51854fd0
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebViewAbstract.java
@@ -0,0 +1,79 @@
+package org.wordpress.android.editor;
+
+import android.annotation.SuppressLint;
+import android.content.Context;
+import android.support.annotation.NonNull;
+import android.util.AttributeSet;
+import android.view.KeyEvent;
+import android.webkit.ConsoleMessage;
+import android.webkit.JsResult;
+import android.webkit.WebChromeClient;
+import android.webkit.WebSettings;
+import android.webkit.WebView;
+import android.webkit.WebViewClient;
+
+import org.wordpress.android.util.AppLog;
+
+/**
+ * A text editor WebView with support for JavaScript execution.
+ */
+public abstract class EditorWebViewAbstract extends WebView {
+    public abstract void execJavaScriptFromString(String javaScript);
+
+    private OnImeBackListener mOnImeBackListener;
+
+    public EditorWebViewAbstract(Context context, AttributeSet attrs) {
+        super(context, attrs);
+        configureWebView();
+    }
+
+    @SuppressLint("SetJavaScriptEnabled")
+    private void configureWebView() {
+        WebSettings webSettings = this.getSettings();
+        webSettings.setJavaScriptEnabled(true);
+        webSettings.setDefaultTextEncodingName("utf-8");
+
+        this.setWebViewClient(new WebViewClient() {
+            public void onReceivedError(WebView view, int errorCode, String description, String failingUrl) {
+                AppLog.e(AppLog.T.EDITOR, description);
+            }
+        });
+
+        this.setWebChromeClient(new WebChromeClient() {
+            @Override
+            public boolean onConsoleMessage(@NonNull ConsoleMessage cm) {
+                AppLog.d(AppLog.T.EDITOR, cm.message() + " -- From line " + cm.lineNumber() + " of " + cm.sourceId());
+                return true;
+            }
+
+            @Override
+            public boolean onJsAlert(WebView view, String url, String message, JsResult result) {
+                AppLog.d(AppLog.T.EDITOR, message);
+                return true;
+            }
+        });
+    }
+
+    @Override
+    public boolean onCheckIsTextEditor() {
+        return true;
+    }
+
+    public void setOnImeBackListener(OnImeBackListener listener) {
+        mOnImeBackListener = listener;
+    }
+
+    @Override
+    public boolean onKeyPreIme(int keyCode, KeyEvent event) {
+        if (event.getKeyCode() == KeyEvent.KEYCODE_BACK && event.getAction() == KeyEvent.ACTION_UP) {
+            if (mOnImeBackListener != null) {
+                mOnImeBackListener.onImeBack();
+            }
+        }
+        return super.onKeyPreIme(keyCode, event);
+    }
+
+    public interface OnImeBackListener {
+        void onImeBack();
+    }
+}
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebViewCompatibility.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebViewCompatibility.java
new file mode 100644
index 000000000000..714f87ac8763
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/EditorWebViewCompatibility.java
@@ -0,0 +1,115 @@
+package org.wordpress.android.editor;
+
+import android.content.Context;
+import android.os.Build;
+import android.os.Message;
+import android.util.AttributeSet;
+import android.webkit.WebView;
+
+import org.wordpress.android.util.AppLog;
+import org.wordpress.android.util.AppLog.T;
+
+import java.lang.reflect.Field;
+import java.lang.reflect.InvocationTargetException;
+import java.lang.reflect.Method;
+
+/**
+ * <p>Compatibility <code>EditorWebView</code> for pre-Chromium WebView (API<19). Provides a custom method for executing
+ * JavaScript, {@link #loadJavaScript(String)}, instead of {@link WebView#loadUrl(String)}. This is needed because
+ * <code>WebView#loadUrl(String)</code> on API<19 eventually calls <code>WebViewClassic#hideSoftKeyboard()</code>,
+ * hiding the keyboard whenever JavaScript is executed.</p>
+ *
+ * <p>This class uses reflection to access the normally inaccessible <code>WebViewCore#sendMessage(Message)</code>
+ * and use it to execute JavaScript, sidestepping <code>WebView#loadUrl(String)</code> and the keyboard issue.</p>
+ */
+@SuppressWarnings("TryWithIdenticalCatches")
+public class EditorWebViewCompatibility extends EditorWebViewAbstract {
+    private static final int EXECUTE_JS = 194; // WebViewCore internal JS message code
+
+    private Object mWebViewCore;
+    private Method mSendMessageMethod;
+
+    public EditorWebViewCompatibility(Context context, AttributeSet attrs) {
+        super(context, attrs);
+        try {
+            this.initReflection();
+        } catch (ReflectionException e) {
+            AppLog.e(T.EDITOR, e);
+            handleReflectionFailure();
+        }
+    }
+
+    private void initReflection() throws ReflectionException {
+        Object webViewProvider;
+
+        try {
+            if (Build.VERSION.SDK_INT >= 16) {
+                // On API >= 16, the WebViewCore instance is not defined inside WebView itself but inside a
+                // WebViewClassic (implementation of WebViewProvider), referenced from the WebView as mProvider
+
+                // Access WebViewClassic object
+                Field webViewProviderField = WebView.class.getDeclaredField("mProvider");
+                webViewProviderField.setAccessible(true);
+                webViewProvider = webViewProviderField.get(this);
+
+                // Access WebViewCore object
+                Field webViewCoreField = webViewProvider.getClass().getDeclaredField("mWebViewCore");
+                webViewCoreField.setAccessible(true);
+                mWebViewCore = webViewCoreField.get(webViewProvider);
+            } else {
+                // On API < 16, the WebViewCore is directly accessible from the WebView
+
+                // Access WebViewCore object
+                Field webViewCoreField = WebView.class.getDeclaredField("mWebViewCore");
+                webViewCoreField.setAccessible(true);
+                mWebViewCore = webViewCoreField.get(this);
+            }
+
+            // Access WebViewCore#sendMessage(Message) method
+            if (mWebViewCore != null) {
+                mSendMessageMethod = mWebViewCore.getClass().getDeclaredMethod("sendMessage", Message.class);
+                mSendMessageMethod.setAccessible(true);
+            }
+        } catch (NoSuchFieldException e) {
+            throw new ReflectionException(e);
+        } catch (NoSuchMethodException e) {
+            throw new ReflectionException(e);
+        } catch (IllegalAccessException e) {
+            throw new ReflectionException(e);
+        }
+    }
+
+    private void loadJavaScript(final String javaScript) throws ReflectionException {
+        if (mSendMessageMethod == null) {
+            initReflection();
+        } else {
+            Message jsMessage = Message.obtain(null, EXECUTE_JS, javaScript);
+            try {
+                mSendMessageMethod.invoke(mWebViewCore, jsMessage);
+            } catch (InvocationTargetException e) {
+                throw new ReflectionException(e);
+            } catch (IllegalAccessException e) {
+                throw new ReflectionException(e);
+            }
+        }
+    }
+
+    public void execJavaScriptFromString(String javaScript) {
+        try {
+            loadJavaScript(javaScript);
+        } catch(ReflectionException e) {
+            AppLog.e(T.EDITOR, e);
+            handleReflectionFailure();
+        }
+    }
+
+    private void handleReflectionFailure() {
+        // TODO: Fallback to legacy editor and pass the error to analytics
+    }
+
+    public class ReflectionException extends Exception {
+        public ReflectionException(Throwable cause) {
+            super(cause);
+        }
+    }
+}
\ No newline at end of file
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/JsCallbackReceiver.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/JsCallbackReceiver.java
new file mode 100755
index 000000000000..6467927c1ffa
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/JsCallbackReceiver.java
@@ -0,0 +1,100 @@
+package org.wordpress.android.editor;
+
+import android.webkit.JavascriptInterface;
+
+import org.wordpress.android.util.AppLog;
+
+import java.util.HashSet;
+import java.util.Set;
+
+public class JsCallbackReceiver {
+    private static final String JS_CALLBACK_DELIMITER = "~";
+
+    private static final String CALLBACK_DOM_LOADED = "callback-dom-loaded";
+    private static final String CALLBACK_NEW_FIELD = "callback-new-field";
+
+    private static final String CALLBACK_INPUT = "callback-input";
+    private static final String CALLBACK_SELECTION_CHANGED = "callback-selection-changed";
+    private static final String CALLBACK_SELECTION_STYLE = "callback-selection-style";
+
+    private static final String CALLBACK_FOCUS_IN = "callback-focus-in";
+    private static final String CALLBACK_FOCUS_OUT = "callback-focus-out";
+
+    private static final String CALLBACK_IMAGE_REPLACED = "callback-image-replaced";
+    private static final String CALLBACK_IMAGE_TAP = "callback-image-tap";
+    private static final String CALLBACK_LINK_TAP = "callback-link-tap";
+
+    private static final String CALLBACK_LOG = "callback-log";
+
+    private static final String CALLBACK_RESPONSE_STRING = "callback-response-string";
+
+    private final OnJsEditorStateChangedListener mListener;
+
+    private Set<String> mPreviousStyleSet = new HashSet<>();
+
+    public JsCallbackReceiver(EditorFragmentAbstract editorFragmentAbstract) {
+        mListener = (OnJsEditorStateChangedListener) editorFragmentAbstract;
+    }
+
+    @JavascriptInterface
+    public void executeCallback(String callbackId, String params) {
+        switch (callbackId) {
+            case CALLBACK_DOM_LOADED:
+                mListener.onDomLoaded();
+                break;
+            case CALLBACK_SELECTION_STYLE:
+                // Compare the new styles to the previous ones, and notify the JsCallbackListener of the changeset
+                Set<String> newStyleSet = Utils.splitDelimitedString(params, JS_CALLBACK_DELIMITER);
+                mListener.onSelectionStyleChanged(Utils.getChangeMapFromSets(mPreviousStyleSet,
+                        newStyleSet));
+                mPreviousStyleSet = newStyleSet;
+                break;
+            case CALLBACK_SELECTION_CHANGED:
+                // Called for changes to the field in current focus and for changes made to selection
+                // (includes moving the caret without selecting text)
+                // TODO: Possibly needed for handling WebView scrolling when caret moves (from iOS)
+                Set<String> selectionKeyValueSet = Utils.splitDelimitedString(params, JS_CALLBACK_DELIMITER);
+                mListener.onSelectionChanged(Utils.buildMapFromKeyValuePairs(selectionKeyValueSet));
+                break;
+            case CALLBACK_INPUT:
+                // Called on key press
+                // TODO: Possibly needed for handling WebView scrolling when caret moves (from iOS)
+                break;
+            case CALLBACK_FOCUS_IN:
+                // TODO: Needed to handle displaying/graying the format bar when focus changes between the title and content
+                AppLog.d(AppLog.T.EDITOR, "Focus in callback received");
+                break;
+            case CALLBACK_FOCUS_OUT:
+                // TODO: Needed to handle displaying/graying the format bar when focus changes between the title and content
+                AppLog.d(AppLog.T.EDITOR, "Focus out callback received");
+                break;
+            case CALLBACK_NEW_FIELD:
+                // TODO: Used for logging/testing purposes on iOS
+                AppLog.d(AppLog.T.EDITOR, "New field created, " + params);
+                break;
+            case CALLBACK_IMAGE_REPLACED:
+                // TODO: Notifies that image upload has finished and that the local url was replaced by the remote url in the ZSS editor
+                AppLog.d(AppLog.T.EDITOR, "Image replaced, " + params);
+                break;
+            case CALLBACK_IMAGE_TAP:
+                // TODO: Notifies that an image was tapped
+                AppLog.d(AppLog.T.EDITOR, "Image tapped, " + params);
+                break;
+            case CALLBACK_LINK_TAP:
+                // TODO: Notifies that a link was tapped
+                AppLog.d(AppLog.T.EDITOR, "Link tapped, " + params);
+                break;
+            case CALLBACK_LOG:
+                // Strip 'msg=' from beginning of string
+                AppLog.d(AppLog.T.EDITOR, callbackId + ": " + params.substring(4));
+                break;
+            case CALLBACK_RESPONSE_STRING:
+                AppLog.d(AppLog.T.EDITOR, callbackId + ": " + params);
+                Set<String> responseKeyValueSet = Utils.splitDelimitedString(params, JS_CALLBACK_DELIMITER);
+                mListener.onGetHtmlResponse(Utils.buildMapFromKeyValuePairs(responseKeyValueSet));
+                break;
+            default:
+                AppLog.d(AppLog.T.EDITOR, "Unhandled callback: " + callbackId + ":" + params);
+        }
+    }
+}
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/LegacyEditorFragment.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/LegacyEditorFragment.java
index 958c27d7441e..467a6ea372cf 100644
--- a/WordPressEditor/src/main/java/org/wordpress/android/editor/LegacyEditorFragment.java
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/LegacyEditorFragment.java
@@ -1,7 +1,1119 @@
 package org.wordpress.android.editor;
 
-import android.app.Fragment;
+import android.app.AlertDialog;
+import android.content.Context;
+import android.content.DialogInterface;
+import android.content.Intent;
+import android.content.res.Configuration;
+import android.graphics.Bitmap;
+import android.graphics.BitmapFactory;
+import android.graphics.Typeface;
+import android.net.Uri;
+import android.os.Bundle;
+import android.os.Handler;
+import android.os.Looper;
+import android.os.Parcelable;
+import android.support.v7.app.ActionBar;
+import android.support.v7.app.ActionBarActivity;
+import android.text.Editable;
+import android.text.Layout;
+import android.text.Selection;
+import android.text.Spannable;
+import android.text.Spanned;
+import android.text.TextUtils;
+import android.text.TextWatcher;
+import android.text.method.ArrowKeyMovementMethod;
+import android.text.style.AlignmentSpan;
+import android.text.style.QuoteSpan;
+import android.text.style.StrikethroughSpan;
+import android.text.style.StyleSpan;
+import android.text.style.URLSpan;
+import android.view.KeyEvent;
+import android.view.LayoutInflater;
+import android.view.MotionEvent;
+import android.view.View;
+import android.view.ViewGroup;
+import android.view.ViewTreeObserver;
+import android.view.WindowManager;
+import android.view.animation.AlphaAnimation;
+import android.view.animation.Animation;
+import android.view.inputmethod.EditorInfo;
+import android.view.inputmethod.InputMethodManager;
+import android.webkit.URLUtil;
+import android.widget.ArrayAdapter;
+import android.widget.Button;
+import android.widget.CheckBox;
+import android.widget.CompoundButton;
+import android.widget.EditText;
+import android.widget.LinearLayout;
+import android.widget.SeekBar;
+import android.widget.Spinner;
+import android.widget.TextView;
+import android.widget.ToggleButton;
 
-public class LegacyEditorFragment extends Fragment {
+import com.android.volley.VolleyError;
+import com.android.volley.toolbox.ImageLoader;
 
+import org.wordpress.android.analytics.AnalyticsTracker;
+import org.wordpress.android.analytics.AnalyticsTracker.Stat;
+import org.wordpress.android.editor.legacy.EditLinkActivity;
+import org.wordpress.android.editor.legacy.WPEditImageSpan;
+import org.wordpress.android.util.AppLog;
+import org.wordpress.android.util.AppLog.T;
+import org.wordpress.android.util.DisplayUtils;
+import org.wordpress.android.util.ImageUtils;
+import org.wordpress.android.util.MediaUtils;
+import org.wordpress.android.util.helpers.MediaFile;
+import org.wordpress.android.util.helpers.MediaGallery;
+import org.wordpress.android.util.helpers.MediaGalleryImageSpan;
+import org.wordpress.android.util.helpers.WPImageSpan;
+import org.wordpress.android.util.helpers.WPUnderlineSpan;
+import org.wordpress.android.util.widgets.WPEditText;
+
+public class LegacyEditorFragment extends EditorFragmentAbstract implements TextWatcher,
+        WPEditText.OnSelectionChangedListener, View.OnTouchListener {
+    public static final int ACTIVITY_REQUEST_CODE_CREATE_LINK = 4;
+    public static final String ACTION_MEDIA_GALLERY_TOUCHED = "MEDIA_GALLERY_TOUCHED";
+    public static final String EXTRA_MEDIA_GALLERY = "EXTRA_MEDIA_GALLERY";
+
+    private static final int MIN_THUMBNAIL_WIDTH = 200;
+    private static final int CONTENT_ANIMATION_DURATION = 250;
+    private static final String KEY_IMAGE_SPANS = "image-spans";
+    private static final String KEY_START = "start";
+    private static final String KEY_END = "end";
+    private static final String KEY_CONTENT = "content";
+    private static final String TAG_FORMAT_BAR_BUTTON_STRONG = "strong";
+    private static final String TAG_FORMAT_BAR_BUTTON_EM = "em";
+    private static final String TAG_FORMAT_BAR_BUTTON_UNDERLINE = "u";
+    private static final String TAG_FORMAT_BAR_BUTTON_STRIKE = "strike";
+    private static final String TAG_FORMAT_BAR_BUTTON_QUOTE = "blockquote";
+
+    private ActionBarActivity mActivity;
+    private View mRootView;
+    private WPEditText mContentEditText;
+    private EditText mTitleEditText;
+    private ToggleButton mBoldToggleButton, mEmToggleButton, mBquoteToggleButton;
+    private ToggleButton mUnderlineToggleButton, mStrikeToggleButton;
+    private LinearLayout mFormatBar, mPostContentLinearLayout, mPostSettingsLinearLayout;
+    private boolean mIsBackspace;
+    private boolean mScrollDetected;
+    private boolean mIsLocalDraft;
+
+    private int mStyleStart, mSelectionStart, mSelectionEnd, mFullViewBottom;
+    private int mLastPosition = -1;
+    private CharSequence mTitle;
+    private CharSequence mContent;
+
+    private float mLastYPos = 0;
+
+    @Override
+    public boolean onBackPressed() {
+        // leave full screen mode back button is pressed
+        if (getActivity().getActionBar() != null && !getActivity().getActionBar().isShowing()) {
+            setContentEditingModeVisible(false);
+            return true;
+        }
+        return false;
+    }
+
+    @Override
+    public CharSequence getTitle() {
+        if (mTitleEditText != null) {
+            return mTitleEditText.getText().toString();
+        }
+        return mTitle;
+    }
+
+    @Override
+    public CharSequence getContent() {
+        if (mContentEditText != null) {
+            return mContentEditText.getText().toString();
+        }
+        return mContent;
+    }
+
+    @Override
+    public void setTitle(CharSequence text) {
+        mTitle = text;
+        if (mTitleEditText != null) {
+            mTitleEditText.setText(text);
+        } else {
+            // TODO
+        }
+    }
+
+    @Override
+    public void setContent(CharSequence text) {
+        mContent = text;
+        if (mContentEditText != null) {
+            mContentEditText.setText(text);
+            mContentEditText.setSelection(mSelectionStart, mSelectionEnd);
+        } else {
+            // TODO
+        }
+    }
+
+    @Override
+    public Spanned getSpannedContent() {
+        return mContentEditText.getText();
+    }
+
+    public void setLocalDraft(boolean isLocalDraft) {
+        mIsLocalDraft = isLocalDraft;
+    }
+
+    @Override
+    public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
+        mActivity = (ActionBarActivity) getActivity();
+
+        final ViewGroup rootView = (ViewGroup) inflater.inflate(R.layout.fragment_edit_post_content, container, false);
+
+        mFormatBar = (LinearLayout) rootView.findViewById(R.id.format_bar);
+        mTitleEditText = (EditText) rootView.findViewById(R.id.post_title);
+        mTitleEditText.setText(mTitle);
+        mTitleEditText.setOnEditorActionListener(new TextView.OnEditorActionListener() {
+            @Override
+            public boolean onEditorAction(TextView v, int actionId, KeyEvent event) {
+                // Go to full screen editor when 'next' button is tapped on soft keyboard
+                if (actionId == EditorInfo.IME_ACTION_NEXT && isAdded() && mActivity.getSupportActionBar() != null &&
+                        mActivity.getSupportActionBar().isShowing()) {
+                    setContentEditingModeVisible(true);
+                }
+                return false;
+            }
+        });
+
+        mContentEditText = (WPEditText) rootView.findViewById(R.id.post_content);
+        mContentEditText.setText(mContent);
+
+        mPostContentLinearLayout = (LinearLayout) rootView.findViewById(R.id.post_content_wrapper);
+        mPostSettingsLinearLayout = (LinearLayout) rootView.findViewById(R.id.post_settings_wrapper);
+        Button postSettingsButton = (Button) rootView.findViewById(R.id.post_settings_button);
+        postSettingsButton.setOnClickListener(new View.OnClickListener() {
+            @Override
+            public void onClick(View v) {
+                mEditorFragmentListener.onSettingsClicked();
+            }
+        });
+        mBoldToggleButton = (ToggleButton) rootView.findViewById(R.id.bold);
+        mEmToggleButton = (ToggleButton) rootView.findViewById(R.id.em);
+        mBquoteToggleButton = (ToggleButton) rootView.findViewById(R.id.bquote);
+        mUnderlineToggleButton = (ToggleButton) rootView.findViewById(R.id.underline);
+        mStrikeToggleButton = (ToggleButton) rootView.findViewById(R.id.strike);
+        Button addPictureButton = (Button) rootView.findViewById(R.id.addPictureButton);
+        Button linkButton = (Button) rootView.findViewById(R.id.link);
+        Button moreButton = (Button) rootView.findViewById(R.id.more);
+
+        registerForContextMenu(addPictureButton);
+        mContentEditText = (WPEditText) rootView.findViewById(R.id.post_content);
+        mContentEditText.setOnSelectionChangedListener(this);
+        mContentEditText.setOnTouchListener(this);
+        mContentEditText.addTextChangedListener(this);
+        mContentEditText.setOnEditTextImeBackListener(new WPEditText.EditTextImeBackListener() {
+            @Override
+            public void onImeBack(WPEditText ctrl, String text) {
+                // Go back to regular editor if IME keyboard is dismissed
+                // Bottom comparison is there to ensure that the keyboard is actually showing
+                if (mRootView.getBottom() < mFullViewBottom && isAdded() && mActivity.getSupportActionBar() != null
+                        && !mActivity.getSupportActionBar().isShowing()) {
+                    setContentEditingModeVisible(false);
+                }
+            }
+        });
+        addPictureButton.setOnClickListener(mFormatBarButtonClickListener);
+        mBoldToggleButton.setOnClickListener(mFormatBarButtonClickListener);
+        linkButton.setOnClickListener(mFormatBarButtonClickListener);
+        mEmToggleButton.setOnClickListener(mFormatBarButtonClickListener);
+        mUnderlineToggleButton.setOnClickListener(mFormatBarButtonClickListener);
+        mStrikeToggleButton.setOnClickListener(mFormatBarButtonClickListener);
+        mBquoteToggleButton.setOnClickListener(mFormatBarButtonClickListener);
+        moreButton.setOnClickListener(mFormatBarButtonClickListener);
+        mEditorFragmentListener.onEditorFragmentInitialized();
+
+        if (savedInstanceState != null) {
+            Parcelable[] spans = savedInstanceState.getParcelableArray(KEY_IMAGE_SPANS);
+
+            mContent = savedInstanceState.getString(KEY_CONTENT, "");
+            mContentEditText.setText(mContent);
+            mContentEditText.setSelection(savedInstanceState.getInt(KEY_START, 0),
+                                          savedInstanceState.getInt(KEY_END, 0));
+
+            if (spans != null && spans.length > 0) {
+                for (Parcelable s : spans) {
+                    WPImageSpan editSpan = (WPImageSpan)s;
+                    addMediaFile(editSpan.getMediaFile(), editSpan.getMediaFile().getFilePath(),
+                            mImageLoader, editSpan.getStartPosition(), editSpan.getEndPosition());
+                }
+            }
+        }
+
+        return rootView;
+    }
+
+    @Override
+    public void onViewCreated(View view, Bundle savedInstanceState) {
+        super.onViewCreated(view, savedInstanceState);
+        mRootView = view;
+        mRootView.getViewTreeObserver().addOnGlobalLayoutListener(mGlobalLayoutListener);
+    }
+
+    private ViewTreeObserver.OnGlobalLayoutListener mGlobalLayoutListener = new ViewTreeObserver.OnGlobalLayoutListener() {
+        public void onGlobalLayout() {
+            mRootView.getViewTreeObserver().removeGlobalOnLayoutListener(this);
+            mFullViewBottom = mRootView.getBottom();
+        }
+    };
+
+    public void setContentEditingModeVisible(boolean isVisible) {
+        if (!isAdded()) {
+            return;
+        }
+        ActionBar actionBar = mActivity.getSupportActionBar();
+        if (isVisible) {
+            Animation fadeAnimation = new AlphaAnimation(1, 0);
+            fadeAnimation.setDuration(CONTENT_ANIMATION_DURATION);
+            fadeAnimation.setAnimationListener(new Animation.AnimationListener() {
+                @Override
+                public void onAnimationStart(Animation animation) {
+                    mTitleEditText.setVisibility(View.GONE);
+                }
+
+                @Override
+                public void onAnimationEnd(Animation animation) {
+                    mPostSettingsLinearLayout.setVisibility(View.GONE);
+                    mFormatBar.setVisibility(View.VISIBLE);
+                }
+
+                @Override
+                public void onAnimationRepeat(Animation animation) {
+                }
+            });
+
+            mPostContentLinearLayout.startAnimation(fadeAnimation);
+            if (actionBar != null) {
+                actionBar.hide();
+            }
+        } else {
+            mTitleEditText.setVisibility(View.VISIBLE);
+            mFormatBar.setVisibility(View.GONE);
+            Animation fadeAnimation = new AlphaAnimation(0, 1);
+            fadeAnimation.setDuration(CONTENT_ANIMATION_DURATION);
+            fadeAnimation.setAnimationListener(new Animation.AnimationListener() {
+                @Override
+                public void onAnimationStart(Animation animation) {
+                }
+
+                @Override
+                public void onAnimationEnd(Animation animation) {
+                    mPostSettingsLinearLayout.setVisibility(View.VISIBLE);
+                }
+
+                @Override
+                public void onAnimationRepeat(Animation animation) {
+                }
+            });
+            mPostContentLinearLayout.startAnimation(fadeAnimation);
+            mActivity.invalidateOptionsMenu();
+            if (actionBar != null) {
+                actionBar.show();
+            }
+        }
+    }
+
+    @Override
+    public void onActivityResult(int requestCode, int resultCode, Intent data) {
+        super.onActivityResult(requestCode, resultCode, data);
+
+        if (requestCode == LegacyEditorFragment.ACTIVITY_REQUEST_CODE_CREATE_LINK) {
+            Bundle extras = data.getExtras();
+            if (extras == null) {
+                return;
+            }
+            String linkURL = extras.getString("linkURL");
+            String linkText = extras.getString("linkText");
+            createLinkFromSelection(linkURL, linkText);
+        }
+    }
+
+    public boolean hasEmptyContentFields() {
+        return TextUtils.isEmpty(mTitleEditText.getText()) && TextUtils.isEmpty(mContentEditText.getText());
+    }
+
+    @Override
+    public void onConfigurationChanged(Configuration newConfig) {
+        super.onConfigurationChanged(newConfig);
+        mFullViewBottom = mRootView.getBottom();
+    }
+
+    private void createLinkFromSelection(String linkURL, String linkText) {
+        try {
+            if (linkURL != null && !linkURL.equals("http://") && !linkURL.equals("")) {
+                if (mSelectionStart > mSelectionEnd) {
+                    int temp = mSelectionEnd;
+                    mSelectionEnd = mSelectionStart;
+                    mSelectionStart = temp;
+                }
+                Editable editable = mContentEditText.getText();
+                if (editable == null) {
+                    return;
+                }
+                if (mIsLocalDraft) {
+                    if (linkText == null) {
+                        if (mSelectionStart < mSelectionEnd) {
+                            editable.delete(mSelectionStart, mSelectionEnd);
+                        }
+                        editable.insert(mSelectionStart, linkURL);
+                        editable.setSpan(new URLSpan(linkURL), mSelectionStart, mSelectionStart + linkURL.length(),
+                                Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                        mContentEditText.setSelection(mSelectionStart + linkURL.length());
+                    } else {
+                        if (mSelectionStart < mSelectionEnd) {
+                            editable.delete(mSelectionStart, mSelectionEnd);
+                        }
+                        editable.insert(mSelectionStart, linkText);
+                        editable.setSpan(new URLSpan(linkURL), mSelectionStart, mSelectionStart + linkText.length(),
+                                Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                        mContentEditText.setSelection(mSelectionStart + linkText.length());
+                    }
+                } else {
+                    if (linkText == null) {
+                        if (mSelectionStart < mSelectionEnd) {
+                            editable.delete(mSelectionStart, mSelectionEnd);
+                        }
+                        String urlHTML = "<a href=\"" + linkURL + "\">" + linkURL + "</a>";
+                        editable.insert(mSelectionStart, urlHTML);
+                        mContentEditText.setSelection(mSelectionStart + urlHTML.length());
+                    } else {
+                        if (mSelectionStart < mSelectionEnd) {
+                            editable.delete(mSelectionStart, mSelectionEnd);
+                        }
+                        String urlHTML = "<a href=\"" + linkURL + "\">" + linkText + "</a>";
+                        editable.insert(mSelectionStart, urlHTML);
+                        mContentEditText.setSelection(mSelectionStart + urlHTML.length());
+                    }
+                }
+            }
+        } catch (RuntimeException e) {
+            AppLog.e(T.POSTS, e);
+        }
+    }
+
+    /**
+     * Formatting bar
+     */
+    private View.OnClickListener mFormatBarButtonClickListener = new View.OnClickListener() {
+        @Override
+        public void onClick(View v) {
+            int id = v.getId();
+            if (id == R.id.bold) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_BOLD);
+                onFormatButtonClick(mBoldToggleButton, TAG_FORMAT_BAR_BUTTON_STRONG);
+            } else if (id == R.id.em) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_ITALIC);
+                onFormatButtonClick(mEmToggleButton, TAG_FORMAT_BAR_BUTTON_EM);
+            } else if (id == R.id.underline) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_UNDERLINE);
+                onFormatButtonClick(mUnderlineToggleButton, TAG_FORMAT_BAR_BUTTON_UNDERLINE);
+            } else if (id == R.id.strike) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_STRIKETHROUGH);
+                onFormatButtonClick(mStrikeToggleButton, TAG_FORMAT_BAR_BUTTON_STRIKE);
+            } else if (id == R.id.bquote) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_BLOCKQUOTE);
+                onFormatButtonClick(mBquoteToggleButton, TAG_FORMAT_BAR_BUTTON_QUOTE);
+            } else if (id == R.id.more) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_MORE);
+                mSelectionEnd = mContentEditText.getSelectionEnd();
+                Editable str = mContentEditText.getText();
+                if (str != null) {
+                    if (mSelectionEnd > str.length())
+                        mSelectionEnd = str.length();
+                    str.insert(mSelectionEnd, "\n<!--more-->\n");
+                }
+            } else if (id == R.id.link) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_LINK);
+                mSelectionStart = mContentEditText.getSelectionStart();
+                mStyleStart = mSelectionStart;
+                mSelectionEnd = mContentEditText.getSelectionEnd();
+                if (mSelectionStart > mSelectionEnd) {
+                    int temp = mSelectionEnd;
+                    mSelectionEnd = mSelectionStart;
+                    mSelectionStart = temp;
+                }
+                Intent i = new Intent(getActivity(), EditLinkActivity.class);
+                if (mSelectionEnd > mSelectionStart) {
+                    if (mContentEditText.getText() != null) {
+                        String selectedText = mContentEditText.getText().subSequence(mSelectionStart, mSelectionEnd).toString();
+                        i.putExtra("selectedText", selectedText);
+                    }
+                }
+                startActivityForResult(i, ACTIVITY_REQUEST_CODE_CREATE_LINK);
+            } else if (id == R.id.addPictureButton) {
+                AnalyticsTracker.track(Stat.EDITOR_TAPPED_IMAGE);
+                mEditorFragmentListener.onAddMediaClicked();
+            }
+        }
+    };
+
+    private WPEditImageSpan createWPEditImageSpanLocal(Context context, MediaFile mediaFile) {
+        Uri imageUri = Uri.parse(mediaFile.getFilePath());
+        Bitmap thumbnailBitmap;
+        if (MediaUtils.isVideo(imageUri.toString())) {
+            thumbnailBitmap = BitmapFactory.decodeResource(context.getResources(), R.drawable.media_movieclip);
+        } else {
+            thumbnailBitmap = ImageUtils.getWPImageSpanThumbnailFromFilePath(context, imageUri.getEncodedPath(),
+                    ImageUtils.getMaximumThumbnailWidthForEditor(context));
+            if (thumbnailBitmap == null) {
+                // Use a placeholder in case thumbnail can't be decoded (OOM for instance)
+                thumbnailBitmap = BitmapFactory.decodeResource(context.getResources(),
+                        R.drawable.legacy_dashicon_format_image_big_grey);
+            }
+        }
+        WPEditImageSpan imageSpan = new WPEditImageSpan(context, thumbnailBitmap, imageUri);
+        mediaFile.setWidth(MediaUtils.getMinimumImageWidth(context, imageUri, mBlogSettingMaxImageWidth));
+        return imageSpan;
+    }
+
+    private WPEditImageSpan createWPEditImageSpanRemote(Context context, MediaFile mediaFile) {
+        int drawable = mediaFile.isVideo() ? R.drawable.media_movieclip : R.drawable.legacy_dashicon_format_image_big_grey;
+        Uri uri = Uri.parse(mediaFile.getFileURL());
+        WPEditImageSpan imageSpan = new WPEditImageSpan(context, drawable, uri);
+        imageSpan.setMediaFile(mediaFile);
+        return imageSpan;
+    }
+
+    private WPEditImageSpan createWPEditImageSpan(Context context, MediaFile mediaFile) {
+        if (!URLUtil.isNetworkUrl(mediaFile.getFileURL())) {
+            return createWPEditImageSpanLocal(context, mediaFile);
+        } else {
+            return createWPEditImageSpanRemote(context, mediaFile);
+        }
+    }
+
+    /**
+     * Applies formatting to selected text, or marks the entry for a new text style
+     * at the current cursor position
+     * @param toggleButton button from formatting bar
+     * @param tag HTML tag name for text style
+     */
+    private void onFormatButtonClick(ToggleButton toggleButton, String tag) {
+        Spannable s = mContentEditText.getText();
+        if (s == null)
+            return;
+        int selectionStart = mContentEditText.getSelectionStart();
+        mStyleStart = selectionStart;
+        int selectionEnd = mContentEditText.getSelectionEnd();
+
+        if (selectionStart > selectionEnd) {
+            int temp = selectionEnd;
+            selectionEnd = selectionStart;
+            selectionStart = temp;
+        }
+
+        Class styleClass = null;
+        if (tag.equals(TAG_FORMAT_BAR_BUTTON_STRONG) || tag.equals(TAG_FORMAT_BAR_BUTTON_EM))
+            styleClass = StyleSpan.class;
+        else if (tag.equals(TAG_FORMAT_BAR_BUTTON_UNDERLINE))
+            styleClass = WPUnderlineSpan.class;
+        else if (tag.equals(TAG_FORMAT_BAR_BUTTON_STRIKE))
+            styleClass = StrikethroughSpan.class;
+        else if (tag.equals(TAG_FORMAT_BAR_BUTTON_QUOTE))
+            styleClass = QuoteSpan.class;
+
+        if (styleClass == null)
+            return;
+
+        Object[] allSpans = s.getSpans(selectionStart, selectionEnd, styleClass);
+        boolean textIsSelected = selectionEnd > selectionStart;
+        if (mIsLocalDraft) {
+            // Local drafts can use the rich text editor. Yay!
+            boolean shouldAddSpan = true;
+            for (Object span : allSpans) {
+                if (span instanceof StyleSpan) {
+                    StyleSpan styleSpan = (StyleSpan)span;
+                    if ((styleSpan.getStyle() == Typeface.BOLD && !tag.equals(TAG_FORMAT_BAR_BUTTON_STRONG))
+                            || (styleSpan.getStyle() == Typeface.ITALIC && !tag.equals(TAG_FORMAT_BAR_BUTTON_EM))) {
+                        continue;
+                    }
+                }
+                if (!toggleButton.isChecked() && textIsSelected) {
+                    // If span exists and text is selected, remove the span
+                    s.removeSpan(span);
+                    shouldAddSpan = false;
+                    break;
+                } else if (!toggleButton.isChecked()) {
+                    // Remove span at cursor point if button isn't checked
+                    Object[] spans = s.getSpans(mStyleStart - 1, mStyleStart, styleClass);
+                    for (Object removeSpan : spans) {
+                        selectionStart = s.getSpanStart(removeSpan);
+                        selectionEnd = s.getSpanEnd(removeSpan);
+                        s.removeSpan(removeSpan);
+                    }
+                }
+            }
+
+            if (shouldAddSpan) {
+                if (tag.equals(TAG_FORMAT_BAR_BUTTON_STRONG)) {
+                    s.setSpan(new StyleSpan(android.graphics.Typeface.BOLD), selectionStart, selectionEnd, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                } else if (tag.equals(TAG_FORMAT_BAR_BUTTON_EM)) {
+                    s.setSpan(new StyleSpan(android.graphics.Typeface.ITALIC), selectionStart, selectionEnd, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                } else {
+                    try {
+                        s.setSpan(styleClass.newInstance(), selectionStart, selectionEnd, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                    } catch (java.lang.InstantiationException e) {
+                        AppLog.e(T.POSTS, e);
+                    } catch (IllegalAccessException e) {
+                        AppLog.e(T.POSTS, e);
+                    }
+                }
+            }
+        } else {
+            // Add HTML tags when editing an existing post
+            String startTag = "<" + tag + ">";
+            String endTag = "</" + tag + ">";
+            Editable content = mContentEditText.getText();
+            if (textIsSelected) {
+                content.insert(selectionStart, startTag);
+                content.insert(selectionEnd + startTag.length(), endTag);
+                toggleButton.setChecked(false);
+                mContentEditText.setSelection(selectionEnd + startTag.length() + endTag.length());
+            } else if (toggleButton.isChecked()) {
+                content.insert(selectionStart, startTag);
+                mContentEditText.setSelection(selectionEnd + startTag.length());
+            } else if (!toggleButton.isChecked()) {
+                content.insert(selectionEnd, endTag);
+                mContentEditText.setSelection(selectionEnd + endTag.length());
+            }
+        }
+    }
+
+    /**
+     * Rich Text Editor
+     */
+    public void showImageSettings(final View alertView, final EditText titleText,
+                                  final EditText caption, final EditText imageWidthText,
+                                  final CheckBox featuredCheckBox, final CheckBox featuredInPostCheckBox,
+                                  final int maxWidth, final Spinner alignmentSpinner, final WPImageSpan imageSpan) {
+        AlertDialog.Builder builder = new AlertDialog.Builder(getActivity());
+        builder.setTitle(getString(R.string.image_settings));
+        builder.setView(alertView);
+        builder.setPositiveButton(getString(android.R.string.ok), new DialogInterface.OnClickListener() {
+            public void onClick(DialogInterface dialog, int whichButton) {
+                String title = (titleText.getText() != null) ? titleText.getText().toString() : "";
+                MediaFile mediaFile = imageSpan.getMediaFile();
+                if (mediaFile == null) {
+                    return;
+                }
+                mediaFile.setTitle(title);
+                mediaFile.setHorizontalAlignment(alignmentSpinner.getSelectedItemPosition());
+                mediaFile.setWidth(getEditTextIntegerClamped(imageWidthText, 10, maxWidth));
+                String captionText = (caption.getText() != null) ? caption.getText().toString() : "";
+                mediaFile.setCaption(captionText);
+                mediaFile.setFeatured(featuredCheckBox.isChecked());
+                if (featuredCheckBox.isChecked()) {
+                    // remove featured flag from all other images
+                    Spannable contentSpannable = mContentEditText.getText();
+                    WPImageSpan[] imageSpans =
+                            contentSpannable.getSpans(0, contentSpannable.length(), WPImageSpan.class);
+                    if (imageSpans.length > 1) {
+                        for (WPImageSpan postImageSpan : imageSpans) {
+                            if (postImageSpan != imageSpan) {
+                                MediaFile postMediaFile = postImageSpan.getMediaFile();
+                                postMediaFile.setFeatured(false);
+                                postMediaFile.setFeaturedInPost(false);
+                                // TODO: remove this
+                                mEditorFragmentListener.saveMediaFile(postMediaFile);
+                            }
+                        }
+                    }
+                }
+                mediaFile.setFeaturedInPost(featuredInPostCheckBox.isChecked());
+                // TODO: remove this
+                mEditorFragmentListener.saveMediaFile(mediaFile);
+            }
+        });
+        builder.setNegativeButton(getString(android.R.string.cancel), new DialogInterface.OnClickListener() {
+            public void onClick(DialogInterface dialog, int whichButton) {
+                dialog.dismiss();
+            }
+        });
+        AlertDialog alertDialog = builder.create();
+        alertDialog.getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_HIDDEN);
+        alertDialog.show();
+    }
+
+    @Override
+    public boolean onTouch(View v, MotionEvent event) {
+        float pos = event.getY();
+
+        if (event.getAction() == 0)
+            mLastYPos = pos;
+
+        if (event.getAction() > 1) {
+            int scrollThreshold = DisplayUtils.dpToPx(getActivity(), 2);
+            if (((mLastYPos - pos) > scrollThreshold) || ((pos - mLastYPos) > scrollThreshold))
+                mScrollDetected = true;
+        }
+
+        mLastYPos = pos;
+
+        if (event.getAction() == MotionEvent.ACTION_UP) {
+            if (isAdded() && mActivity.getSupportActionBar() != null && mActivity.getSupportActionBar().isShowing()) {
+                setContentEditingModeVisible(true);
+                return false;
+            }
+        }
+
+        if (event.getAction() == MotionEvent.ACTION_UP && !mScrollDetected) {
+            Layout layout = ((TextView) v).getLayout();
+            int x = (int) event.getX();
+            int y = (int) event.getY();
+
+            x += v.getScrollX();
+            y += v.getScrollY();
+            if (layout != null) {
+                int line = layout.getLineForVertical(y);
+                int charPosition = layout.getOffsetForHorizontal(line, x);
+
+                Spannable spannable = mContentEditText.getText();
+                if (spannable == null) {
+                    return false;
+                }
+                // check if image span was tapped
+                WPImageSpan[] imageSpans = spannable.getSpans(charPosition, charPosition, WPImageSpan.class);
+
+                if (imageSpans.length != 0) {
+                    final WPImageSpan imageSpan = imageSpans[0];
+                    MediaFile mediaFile = imageSpan.getMediaFile();
+                    if (mediaFile == null)
+                        return false;
+                    if (!mediaFile.isVideo()) {
+                        LayoutInflater factory = LayoutInflater.from(getActivity());
+                        final View alertView = factory.inflate(R.layout.alert_image_options, null);
+                        if (alertView == null)
+                            return false;
+                        final EditText imageWidthText = (EditText) alertView.findViewById(R.id.imageWidthText);
+                        final EditText titleText = (EditText) alertView.findViewById(R.id.title);
+                        final EditText caption = (EditText) alertView.findViewById(R.id.caption);
+                        final CheckBox featuredCheckBox = (CheckBox) alertView.findViewById(R.id.featuredImage);
+                        final CheckBox featuredInPostCheckBox = (CheckBox) alertView.findViewById(R.id.featuredInPost);
+
+                        // show featured image checkboxes if supported
+                        if (mFeaturedImageSupported) {
+                            featuredCheckBox.setVisibility(View.VISIBLE);
+                            featuredInPostCheckBox.setVisibility(View.VISIBLE);
+                        }
+
+                        featuredCheckBox.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener() {
+                            @Override
+                            public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
+                                if (isChecked) {
+                                    featuredInPostCheckBox.setVisibility(View.VISIBLE);
+                                } else {
+                                    featuredInPostCheckBox.setVisibility(View.GONE);
+                                }
+
+                            }
+                        });
+
+                        final SeekBar seekBar = (SeekBar) alertView.findViewById(R.id.imageWidth);
+                        final Spinner alignmentSpinner = (Spinner) alertView.findViewById(R.id.alignment_spinner);
+                        ArrayAdapter<CharSequence> adapter =
+                                ArrayAdapter.createFromResource(getActivity(), R.array.alignment_array,
+                                        android.R.layout.simple_spinner_item);
+                        adapter.setDropDownViewResource(android.R.layout.simple_spinner_dropdown_item);
+                        alignmentSpinner.setAdapter(adapter);
+
+                        imageWidthText.setText(String.valueOf(mediaFile.getWidth()) + "px");
+                        seekBar.setProgress(mediaFile.getWidth());
+                        titleText.setText(mediaFile.getTitle());
+                        caption.setText(mediaFile.getCaption());
+                        featuredCheckBox.setChecked(mediaFile.isFeatured());
+
+                        if (mediaFile.isFeatured()) {
+                            featuredInPostCheckBox.setVisibility(View.VISIBLE);
+                        } else {
+                            featuredInPostCheckBox.setVisibility(View.GONE);
+                        }
+
+                        featuredInPostCheckBox.setChecked(mediaFile.isFeaturedInPost());
+
+                        alignmentSpinner.setSelection(mediaFile.getHorizontalAlignment(), true);
+
+                        final int maxWidth = MediaUtils.getMinimumImageWidth(getActivity(),
+                                imageSpan.getImageSource(), mBlogSettingMaxImageWidth);
+                        seekBar.setMax(maxWidth / 10);
+                        if (mediaFile.getWidth() != 0) {
+                            seekBar.setProgress(mediaFile.getWidth() / 10);
+                        }
+                        seekBar.setOnSeekBarChangeListener(new SeekBar.OnSeekBarChangeListener() {
+                            @Override
+                            public void onStopTrackingTouch(SeekBar seekBar) {
+                            }
+
+                            @Override
+                            public void onStartTrackingTouch(SeekBar seekBar) {
+                            }
+
+                            @Override
+                            public void onProgressChanged(SeekBar seekBar, int progress, boolean fromUser) {
+                                if (progress == 0) {
+                                    progress = 1;
+                                }
+                                imageWidthText.setText(progress * 10 + "px");
+                            }
+                        });
+
+                        imageWidthText.setOnFocusChangeListener(new View.OnFocusChangeListener() {
+                            @Override
+                            public void onFocusChange(View v, boolean hasFocus) {
+                                if (hasFocus) {
+                                    imageWidthText.setText("");
+                                }
+                            }
+                        });
+
+                        imageWidthText.setOnEditorActionListener(new TextView.OnEditorActionListener() {
+                            @Override
+                            public boolean onEditorAction(TextView v, int actionId, KeyEvent event) {
+                                int width = getEditTextIntegerClamped(imageWidthText, 10, maxWidth);
+                                seekBar.setProgress(width / 10);
+                                imageWidthText.setSelection((String.valueOf(width).length()));
+
+                                InputMethodManager imm = (InputMethodManager) getActivity()
+                                        .getSystemService(Context.INPUT_METHOD_SERVICE);
+                                imm.hideSoftInputFromWindow(imageWidthText.getWindowToken(),
+                                        InputMethodManager.RESULT_UNCHANGED_SHOWN);
+
+                                return true;
+                            }
+                        });
+
+                        showImageSettings(alertView, titleText, caption, imageWidthText, featuredCheckBox,
+                                featuredInPostCheckBox, maxWidth, alignmentSpinner, imageSpan);
+                        mScrollDetected = false;
+                        return true;
+                    }
+
+                } else {
+                    mContentEditText.setMovementMethod(ArrowKeyMovementMethod.getInstance());
+                    int selectionStart = mContentEditText.getSelectionStart();
+                    if (selectionStart >= 0 && mContentEditText.getSelectionEnd() >= selectionStart)
+                        mContentEditText.setSelection(selectionStart, mContentEditText.getSelectionEnd());
+                }
+
+                // get media gallery spans
+                MediaGalleryImageSpan[] gallerySpans = spannable.getSpans(charPosition, charPosition, MediaGalleryImageSpan.class);
+                if (gallerySpans.length > 0) {
+                    final MediaGalleryImageSpan gallerySpan = gallerySpans[0];
+                    Intent intent = new Intent(ACTION_MEDIA_GALLERY_TOUCHED);
+                    intent.putExtra(EXTRA_MEDIA_GALLERY, gallerySpan.getMediaGallery());
+                    mActivity.sendBroadcast(intent);
+                }
+            }
+        } else if (event.getAction() == 1) {
+            mScrollDetected = false;
+        }
+        return false;
+    }
+
+    @Override
+    public void afterTextChanged(Editable s) {
+        int position = Selection.getSelectionStart(mContentEditText.getText());
+        if ((mIsBackspace && position != 1) || mLastPosition == position || !mIsLocalDraft)
+            return;
+
+        if (position < 0) {
+            position = 0;
+        }
+        mLastPosition = position;
+        if (position > 0) {
+            if (mStyleStart > position) {
+                mStyleStart = position - 1;
+            }
+
+            boolean shouldBold = mBoldToggleButton.isChecked();
+            boolean shouldEm = mEmToggleButton.isChecked();
+            boolean shouldUnderline = mUnderlineToggleButton.isChecked();
+            boolean shouldStrike = mStrikeToggleButton.isChecked();
+            boolean shouldQuote = mBquoteToggleButton.isChecked();
+
+            Object[] allSpans = s.getSpans(mStyleStart, position, Object.class);
+            for (Object span : allSpans) {
+                if (span instanceof StyleSpan) {
+                    StyleSpan styleSpan = (StyleSpan) span;
+                    if (styleSpan.getStyle() == Typeface.BOLD)
+                        shouldBold = false;
+                    else if (styleSpan.getStyle() == Typeface.ITALIC)
+                        shouldEm = false;
+                } else if (span instanceof WPUnderlineSpan) {
+                    shouldUnderline = false;
+                } else if (span instanceof StrikethroughSpan) {
+                    shouldStrike = false;
+                } else if (span instanceof QuoteSpan) {
+                    shouldQuote = false;
+                }
+            }
+
+            if (shouldBold)
+                s.setSpan(new StyleSpan(android.graphics.Typeface.BOLD), mStyleStart, position, Spannable.SPAN_INCLUSIVE_INCLUSIVE);
+            if (shouldEm)
+                s.setSpan(new StyleSpan(android.graphics.Typeface.ITALIC), mStyleStart, position, Spannable.SPAN_INCLUSIVE_INCLUSIVE);
+            if (shouldUnderline)
+                s.setSpan(new WPUnderlineSpan(), mStyleStart, position, Spannable.SPAN_INCLUSIVE_INCLUSIVE);
+            if (shouldStrike)
+                s.setSpan(new StrikethroughSpan(), mStyleStart, position, Spannable.SPAN_INCLUSIVE_INCLUSIVE);
+            if (shouldQuote)
+                s.setSpan(new QuoteSpan(), mStyleStart, position, Spannable.SPAN_INCLUSIVE_INCLUSIVE);
+        }
+    }
+
+    @Override
+    public void beforeTextChanged(CharSequence s, int start, int count, int after) {
+        mIsBackspace = (count - after == 1) || (s.length() == 0);
+    }
+
+    @Override
+    public void onTextChanged(CharSequence s, int start, int before, int count) {
+    }
+
+    @Override
+    public void onSelectionChanged() {
+        if (!mIsLocalDraft) {
+            return;
+        }
+
+        final Spannable s = mContentEditText.getText();
+        if (s == null)
+            return;
+        // set toggle buttons if cursor is inside of a matching span
+        mStyleStart = mContentEditText.getSelectionStart();
+        Object[] spans = s.getSpans(mContentEditText.getSelectionStart(), mContentEditText.getSelectionStart(), Object.class);
+
+        mBoldToggleButton.setChecked(false);
+        mEmToggleButton.setChecked(false);
+        mBquoteToggleButton.setChecked(false);
+        mUnderlineToggleButton.setChecked(false);
+        mStrikeToggleButton.setChecked(false);
+        for (Object span : spans) {
+            if (span instanceof StyleSpan) {
+                StyleSpan ss = (StyleSpan) span;
+                if (ss.getStyle() == android.graphics.Typeface.BOLD) {
+                    mBoldToggleButton.setChecked(true);
+                }
+                if (ss.getStyle() == android.graphics.Typeface.ITALIC) {
+                    mEmToggleButton.setChecked(true);
+                }
+            }
+            if (span instanceof QuoteSpan) {
+                mBquoteToggleButton.setChecked(true);
+            }
+            if (span instanceof WPUnderlineSpan) {
+                mUnderlineToggleButton.setChecked(true);
+            }
+            if (span instanceof StrikethroughSpan) {
+                mStrikeToggleButton.setChecked(true);
+            }
+        }
+    }
+
+    private int getEditTextIntegerClamped(EditText editText, int min, int max) {
+        int width = 10;
+        try {
+            if (editText.getText() != null)
+                width = Integer.parseInt(editText.getText().toString().replace("px", ""));
+        } catch (NumberFormatException e) {
+            AppLog.e(T.POSTS, e);
+        }
+        width = Math.min(max, Math.max(width, min));
+        return width;
+    }
+
+    private void loadWPImageSpanThumbnail(MediaFile mediaFile, String imageURL, ImageLoader imageLoader) {
+        if (mediaFile == null || imageURL == null) {
+            return;
+        }
+        final String mediaId = mediaFile.getMediaId();
+        if (mediaId == null) {
+            return;
+        }
+
+        final int maxThumbWidth = ImageUtils.getMaximumThumbnailWidthForEditor(getActivity());
+
+        imageLoader.get(imageURL, new ImageLoader.ImageListener() {
+            @Override
+            public void onErrorResponse(VolleyError arg0) {
+            }
+
+            @Override
+            public void onResponse(ImageLoader.ImageContainer container, boolean arg1) {
+                Bitmap downloadedBitmap = container.getBitmap();
+                if (downloadedBitmap == null) {
+                    // no bitmap downloaded from the server.
+                    return;
+                }
+
+                if (downloadedBitmap.getWidth() < MIN_THUMBNAIL_WIDTH) {
+                    // Picture is too small. Show the placeholder in this case.
+                    return;
+                }
+
+                Bitmap resizedBitmap;
+                // resize the downloaded bitmap
+                resizedBitmap = ImageUtils.getScaledBitmapAtLongestSide(downloadedBitmap, maxThumbWidth);
+
+                if (resizedBitmap == null) {
+                    return;
+                }
+
+                final EditText editText = mContentEditText;
+                Editable s = editText.getText();
+                if (s == null) {
+                    return;
+                }
+                WPImageSpan[] spans = s.getSpans(0, s.length(), WPImageSpan.class);
+                if (spans.length != 0) {
+                    for (WPImageSpan is : spans) {
+                        MediaFile mediaFile = is.getMediaFile();
+                        if (mediaFile == null) {
+                            continue;
+                        }
+                        if (mediaId.equals(mediaFile.getMediaId()) && !is.isNetworkImageLoaded()) {
+                            // replace the existing span with a new one with the correct image, re-add
+                            // it to the same position.
+                            int spanStart = is.getStartPosition();
+                            int spanEnd = is.getEndPosition();
+                            WPEditImageSpan imageSpan = new WPEditImageSpan(getActivity(), resizedBitmap,
+                                    is.getImageSource());
+                            imageSpan.setMediaFile(is.getMediaFile());
+                            imageSpan.setNetworkImageLoaded(true);
+                            imageSpan.setPosition(spanStart, spanEnd);
+                            s.removeSpan(is);
+                            s.setSpan(imageSpan, spanStart, spanEnd + 1, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                            break;
+                        }
+                    }
+                }
+            }
+        }, 0, 0);
+    }
+
+    @Override
+    public void onSaveInstanceState(Bundle outState) {
+        super.onSaveInstanceState(outState);
+
+        WPImageSpan[] spans = mContentEditText.getText().getSpans(0, mContentEditText.getText().length(), WPEditImageSpan.class);
+
+        if (spans != null && spans.length > 0) {
+            outState.putParcelableArray(KEY_IMAGE_SPANS, spans);
+        }
+
+        outState.putInt(KEY_START, mContentEditText.getSelectionStart());
+        outState.putInt(KEY_END, mContentEditText.getSelectionEnd());
+        outState.putString(KEY_CONTENT, mContentEditText.getText().toString());
+    }
+
+    public void addMediaFile(final MediaFile mediaFile, final String imageUrl, final ImageLoader imageLoader, final int start, final int end) {
+        mediaFile.setFileURL(imageUrl);
+        mediaFile.setFilePath(imageUrl);
+        final WPEditImageSpan imageSpan = createWPEditImageSpan(mActivity, mediaFile);
+        mEditorFragmentListener.saveMediaFile(mediaFile);
+        imageSpan.setMediaFile(mediaFile);
+
+        Handler handler = new Handler(Looper.getMainLooper());
+        final Runnable r = new Runnable() {
+            @Override
+            public void run() {
+                // Insert the WPImageSpan in the content field
+                int selectionStart = start;
+                int selectionEnd = end;
+
+                if (selectionStart > selectionEnd) {
+                    int temp = selectionEnd;
+                    selectionEnd = selectionStart;
+                    selectionStart = temp;
+                }
+
+                imageSpan.setPosition(selectionStart, selectionEnd);
+
+                int line, column = 0;
+                if (mContentEditText.getLayout() != null) {
+                    line = mContentEditText.getLayout().getLineForOffset(selectionStart);
+                    column = selectionStart - mContentEditText.getLayout().getLineStart(line);
+                }
+
+                Editable s = mContentEditText.getText();
+                if (s == null) {
+                    return;
+                }
+
+                WPImageSpan[] imageSpans = s.getSpans(selectionStart, selectionEnd, WPImageSpan.class);
+                if (imageSpans.length != 0) {
+                    // insert a few line breaks if the cursor is already on an image
+                    s.insert(selectionEnd, "\n\n");
+                    selectionStart = selectionStart + 2;
+                    selectionEnd = selectionEnd + 2;
+                } else if (column != 0) {
+                    // insert one line break if the cursor is not at the first column
+                    s.insert(selectionEnd, "\n");
+                    selectionStart = selectionStart + 1;
+                    selectionEnd = selectionEnd + 1;
+                }
+
+                s.insert(selectionStart, " ");
+                s.setSpan(imageSpan, selectionStart, selectionEnd + 1, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                AlignmentSpan.Standard as = new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER);
+                s.setSpan(as, selectionStart, selectionEnd + 1, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+                s.insert(selectionEnd + 1, "\n\n");
+
+                // Fetch and replace the WPImageSpan if it's a remote media
+                if (imageLoader != null && URLUtil.isNetworkUrl(imageUrl)) {
+                    loadWPImageSpanThumbnail(mediaFile, imageUrl, imageLoader);
+                }
+            }
+        };
+        handler.postDelayed(r, 1);
+    }
+
+    @Override
+    public void appendMediaFile(final MediaFile mediaFile, final String imageUrl, final ImageLoader imageLoader) {
+        addMediaFile(mediaFile, imageUrl, imageLoader, mContentEditText.getSelectionStart(), mContentEditText.getSelectionEnd());
+    }
+
+    @Override
+    public void appendGallery(MediaGallery mediaGallery) {
+        Editable editableText = mContentEditText.getText();
+        if (editableText == null) {
+            return;
+        }
+
+        int selectionStart = mContentEditText.getSelectionStart();
+        int selectionEnd = mContentEditText.getSelectionEnd();
+
+        if (selectionStart > selectionEnd) {
+            int temp = selectionEnd;
+            selectionEnd = selectionStart;
+            selectionStart = temp;
+        }
+
+        int line, column = 0;
+        if (mContentEditText.getLayout() != null) {
+            line = mContentEditText.getLayout().getLineForOffset(selectionStart);
+            column = mContentEditText.getSelectionStart() - mContentEditText.getLayout().getLineStart(line);
+        }
+
+        if (column != 0) {
+            // insert one line break if the cursor is not at the first column
+            editableText.insert(selectionEnd, "\n");
+            selectionStart = selectionStart + 1;
+            selectionEnd = selectionEnd + 1;
+        }
+
+        editableText.insert(selectionStart, " ");
+        MediaGalleryImageSpan is = new MediaGalleryImageSpan(getActivity(), mediaGallery,
+                R.drawable.legacy_icon_mediagallery_placeholder);
+        editableText.setSpan(is, selectionStart, selectionEnd + 1, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+        AlignmentSpan.Standard as = new AlignmentSpan.Standard(Layout.Alignment.ALIGN_CENTER);
+        editableText.setSpan(as, selectionStart, selectionEnd + 1, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE);
+        editableText.insert(selectionEnd + 1, "\n\n");
+    }
 }
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/OnJsEditorStateChangedListener.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/OnJsEditorStateChangedListener.java
new file mode 100755
index 000000000000..215e6a2ce1eb
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/OnJsEditorStateChangedListener.java
@@ -0,0 +1,10 @@
+package org.wordpress.android.editor;
+
+import java.util.Map;
+
+public interface OnJsEditorStateChangedListener {
+    void onDomLoaded();
+    void onSelectionChanged(Map<String, String> selectionArgs);
+    void onSelectionStyleChanged(Map<String, Boolean> changeSet);
+    void onGetHtmlResponse(Map<String, String> responseArgs);
+}
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/Utils.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/Utils.java
new file mode 100644
index 000000000000..f32e058fd6f4
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/Utils.java
@@ -0,0 +1,116 @@
+package org.wordpress.android.editor;
+
+import android.app.Activity;
+import android.content.res.AssetManager;
+
+import org.wordpress.android.util.AppLog;
+
+import java.io.BufferedReader;
+import java.io.IOException;
+import java.io.InputStream;
+import java.io.InputStreamReader;
+import java.util.HashMap;
+import java.util.HashSet;
+import java.util.Map;
+import java.util.Set;
+import java.util.StringTokenizer;
+
+public class Utils {
+
+    public static String getHtmlFromFile(Activity activity, String filename) {
+        try {
+            AssetManager assetManager = activity.getAssets();
+            InputStream in = assetManager.open(filename);
+            return getStringFromInputStream(in);
+        } catch (IOException e) {
+            AppLog.e(AppLog.T.EDITOR, e.getMessage());
+            return null;
+        }
+    }
+
+    public static String getStringFromInputStream(InputStream inputStream) throws IOException {
+        InputStreamReader is = new InputStreamReader(inputStream);
+        StringBuilder sb = new StringBuilder();
+        BufferedReader br = new BufferedReader(is);
+        String read = br.readLine();
+        while (read != null) {
+            sb.append(read);
+            sb.append('\n');
+            read = br.readLine();
+        }
+        return sb.toString();
+    }
+
+    public static String escapeHtml(String html) {
+        if (html != null) {
+            html = html.replace("\\", "\\\\");
+            html = html.replace("\"", "\\\"");
+            html = html.replace("'", "\\'");
+            html = html.replace("\r", "\\r");
+            html = html.replace("\n", "\\n");
+        }
+        return html;
+    }
+
+    /**
+     * Splits a delimited string into a set of strings.
+     * @param string the delimited string to split
+     * @param delimiter the string delimiter
+     */
+    public static Set<String> splitDelimitedString(String string, String delimiter) {
+        Set<String> splitString = new HashSet<>();
+
+        StringTokenizer stringTokenizer = new StringTokenizer(string, delimiter);
+        while (stringTokenizer.hasMoreTokens()) {
+            splitString.add(stringTokenizer.nextToken());
+        }
+
+        return splitString;
+    }
+
+    /**
+     * Accepts a set of strings, each string being a key-value pair (<code>id=5</code>,
+     * <code>name=content-filed</code>). Returns a map of all the key-value pairs in the set.
+     * @param keyValueSet the set of key-value pair strings
+     */
+    public static Map<String, String> buildMapFromKeyValuePairs(Set<String> keyValueSet) {
+        Map<String, String> selectionArgs = new HashMap<>();
+        for (String pair : keyValueSet) {
+            int delimLoc = pair.indexOf("=");
+            if (delimLoc != -1) {
+                selectionArgs.put(pair.substring(0, delimLoc), pair.substring(delimLoc + 1));
+            }
+        }
+        return selectionArgs;
+    }
+
+    /**
+     * Compares two <code>Sets</code> and returns a <code>Map</code> of elements not contained in both
+     * <code>Sets</code>. Elements contained in <code>oldSet</code> but not in <code>newSet</code> will be marked
+     * <code>false</code> in the returned map; the converse will be marked <code>true</code>.
+     * @param oldSet the older of the two <code>Sets</code>
+     * @param newSet the newer of the two <code>Sets</code>
+     * @param <E> type of element stored in the <code>Sets</code>
+     * @return a <code>Map</code> containing the difference between <code>oldSet</code> and <code>newSet</code>, and whether the
+     * element was added (<code>true</code>) or removed (<code>false</code>) in <code>newSet</code>
+     */
+    public static <E> Map<E, Boolean> getChangeMapFromSets(Set<E> oldSet, Set<E> newSet) {
+        Map<E, Boolean> changeMap = new HashMap<>();
+
+        Set<E> additions = new HashSet<>(newSet);
+        additions.removeAll(oldSet);
+
+        Set<E> removals = new HashSet<>(oldSet);
+        removals.removeAll(newSet);
+
+        for (E s : additions) {
+            changeMap.put(s, true);
+        }
+
+        for (E s : removals) {
+            changeMap.put(s, false);
+        }
+
+        return changeMap;
+    }
+}
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/legacy/EditLinkActivity.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/legacy/EditLinkActivity.java
new file mode 100644
index 000000000000..452da8e85550
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/legacy/EditLinkActivity.java
@@ -0,0 +1,75 @@
+package org.wordpress.android.editor.legacy;
+
+import android.content.Intent;
+import android.os.Bundle;
+import android.support.v7.app.ActionBarActivity;
+import android.view.View;
+import android.widget.Button;
+import android.widget.EditText;
+
+import org.wordpress.android.editor.R;
+
+public class EditLinkActivity extends ActionBarActivity {
+    @Override
+    protected void onCreate(Bundle savedInstanceState) {
+        super.onCreate(savedInstanceState);
+
+        setContentView(R.layout.alert_create_link);
+
+        Bundle extras = getIntent().getExtras();
+        if (extras != null) {
+            String selectedText = extras.getString("selectedText");
+            if (selectedText != null) {
+                EditText linkTextET = (EditText) findViewById(R.id.linkText);
+                linkTextET.setText(selectedText);
+            }
+        }
+
+        final Button cancelButton = (Button) findViewById(R.id.cancel);
+        final Button okButton = (Button) findViewById(R.id.ok);
+
+        final EditText urlEditText = (EditText) findViewById(R.id.linkURL);
+        urlEditText.setOnClickListener(new View.OnClickListener() {
+            @Override
+            public void onClick(View v) {
+                if (urlEditText.getText().toString().equals("")) {
+                    urlEditText.setText("http://");
+                    urlEditText.setSelection(7);
+                }
+            }
+
+        });
+
+        okButton.setOnClickListener(new Button.OnClickListener() {
+            public void onClick(View v) {
+                EditText linkURLET = (EditText) findViewById(R.id.linkURL);
+                String linkURL = linkURLET.getText().toString();
+
+                EditText linkTextET = (EditText) findViewById(R.id.linkText);
+                String linkText = linkTextET.getText().toString();
+
+                Bundle bundle = new Bundle();
+                bundle.putString("linkURL", linkURL);
+                if (!linkText.equals("")) {
+                    bundle.putString("linkText", linkText);
+                }
+
+                Intent mIntent = new Intent();
+                mIntent.putExtras(bundle);
+                setResult(RESULT_OK, mIntent);
+                finish();
+            }
+        });
+
+        cancelButton.setOnClickListener(new Button.OnClickListener() {
+            public void onClick(View v) {
+                Intent mIntent = new Intent();
+                setResult(RESULT_CANCELED, mIntent);
+                finish();
+            }
+        });
+
+        // select end of url
+        urlEditText.performClick();
+    }
+}
diff --git a/WordPressEditor/src/main/java/org/wordpress/android/editor/legacy/WPEditImageSpan.java b/WordPressEditor/src/main/java/org/wordpress/android/editor/legacy/WPEditImageSpan.java
new file mode 100644
index 000000000000..edf21d8fa001
--- /dev/null
+++ b/WordPressEditor/src/main/java/org/wordpress/android/editor/legacy/WPEditImageSpan.java
@@ -0,0 +1,72 @@
+package org.wordpress.android.editor.legacy;
+
+import android.content.Context;
+import android.graphics.Bitmap;
+import android.graphics.BitmapFactory;
+import android.graphics.Canvas;
+import android.graphics.Color;
+import android.graphics.Paint;
+import android.net.Uri;
+import android.os.Parcel;
+import android.os.Parcelable;
+
+import org.wordpress.android.editor.R;
+import org.wordpress.android.util.helpers.MediaFile;
+import org.wordpress.android.util.helpers.WPImageSpan;
+
+public class WPEditImageSpan extends WPImageSpan {
+    private Bitmap mEditIconBitmap;
+
+    protected WPEditImageSpan() {
+        super();
+    }
+
+    public WPEditImageSpan(Context context, Bitmap b, Uri src) {
+        super(context, b, src);
+        init(context);
+    }
+
+    public WPEditImageSpan(Context context, int resId, Uri src) {
+        super(context, resId, src);
+        init(context);
+    }
+
+    private void init(Context context) {
+        mEditIconBitmap = BitmapFactory.decodeResource(context.getResources(), R.drawable.ab_icon_edit);
+    }
+
+    @Override
+    public void draw(Canvas canvas, CharSequence text, int start, int end, float x, int top, int y, int bottom,
+                     Paint paint) {
+        super.draw(canvas, text, start, end, x, top, y, bottom, paint);
+
+        if (!mMediaFile.isVideo()) {
+            // Add 'edit' icon at bottom right of image
+            int width = getSize(paint, text, start, end, paint.getFontMetricsInt());
+            float editIconXPosition = (x + width) - mEditIconBitmap.getWidth();
+            float editIconYPosition = bottom - mEditIconBitmap.getHeight();
+
+            // Add a black background with a bit of alpha
+            Paint bgPaint = new Paint();
+            bgPaint.setColor(Color.argb(200, 0, 0, 0));
+            canvas.drawRect(editIconXPosition, editIconYPosition, editIconXPosition + mEditIconBitmap.getWidth(),
+                    editIconYPosition + mEditIconBitmap.getHeight(), bgPaint);
+
+            // Add the icon to the canvas
+            canvas.drawBitmap(mEditIconBitmap, editIconXPosition, editIconYPosition, paint);
+        }
+    }
+
+    public static final Parcelable.Creator<WPEditImageSpan> CREATOR = new Parcelable.Creator<WPEditImageSpan>() {
+        public WPEditImageSpan createFromParcel(Parcel in) {
+            WPEditImageSpan editSpan = new WPEditImageSpan();
+            editSpan.setupFromParcel(in);
+
+            return editSpan;
+        }
+
+        public WPEditImageSpan[] newArray(int size) {
+            return new WPEditImageSpan[size];
+        }
+    };
+}
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/ab_icon_edit.png b/WordPressEditor/src/main/res/drawable-hdpi/ab_icon_edit.png
new file mode 100644
index 000000000000..4b8f443e1f18
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/ab_icon_edit.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_bold.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_bold.png
new file mode 100644
index 000000000000..89c3fdaaf1a9
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_bold.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_bold_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_bold_highlighted.png
new file mode 100755
index 000000000000..3ccf0a48b808
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_bold_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_html.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_html.png
new file mode 100644
index 000000000000..4d7e90d5b8c8
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_html.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_html_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_html_highlighted.png
new file mode 100755
index 000000000000..508f9f312cab
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_html_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_italic.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_italic.png
new file mode 100644
index 000000000000..3d1e92ad76f8
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_italic.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_italic_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_italic_highlighted.png
new file mode 100755
index 000000000000..ac2b45ade4da
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_italic_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_link.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_link.png
new file mode 100644
index 000000000000..78f957d3f091
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_link.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_link_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_link_highlighted.png
new file mode 100755
index 000000000000..570389bc5614
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_link_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_media.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_media.png
new file mode 100644
index 000000000000..48ae074cea8a
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_media.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_media_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_media_highlighted.png
new file mode 100755
index 000000000000..8a3730116c21
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_media_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_more.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_more.png
new file mode 100644
index 000000000000..f96fd5d76d47
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_more.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_more_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_more_highlighted.png
new file mode 100755
index 000000000000..9ab4487bf14c
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_more_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ol.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ol.png
new file mode 100644
index 000000000000..8d0476031774
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ol.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ol_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ol_highlighted.png
new file mode 100755
index 000000000000..201c5bd1aac6
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ol_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_quote.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_quote.png
new file mode 100644
index 000000000000..8f7adfbf05bd
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_quote.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_quote_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_quote_highlighted.png
new file mode 100755
index 000000000000..d2ece2f507db
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_quote_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_strikethrough.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_strikethrough.png
new file mode 100644
index 000000000000..19e4f6bb5458
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_strikethrough.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_strikethrough_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_strikethrough_highlighted.png
new file mode 100755
index 000000000000..50b45a58caaf
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_strikethrough_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ul.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ul.png
new file mode 100644
index 000000000000..b4ce71ee686d
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ul.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ul_highlighted.png b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ul_highlighted.png
new file mode 100755
index 000000000000..b9bca3f7365d
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/format_bar_button_ul_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_admin_links.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_admin_links.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_admin_links.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_admin_links.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_admin_links_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_admin_links_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_admin_links_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_admin_links_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_bold.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_bold.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_bold.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_bold.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_bold_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_bold_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_bold_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_bold_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_insertmore.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_insertmore.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_insertmore.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_insertmore.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_insertmore_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_insertmore_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_insertmore_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_insertmore_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_italic.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_italic.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_italic.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_italic.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_italic_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_italic_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_italic_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_italic_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_strikethrough.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_strikethrough.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_strikethrough.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_strikethrough.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_strikethrough_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_strikethrough_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_strikethrough_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_strikethrough_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_underline.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_underline.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_underline.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_underline.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_underline_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_underline_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_editor_underline_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_editor_underline_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_format_image_big_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_format_image_big_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_format_image_big_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_format_image_big_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_format_quote.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_format_quote.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_format_quote.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_format_quote.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/dashicon_format_quote_grey.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_format_quote_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-hdpi/dashicon_format_quote_grey.png
rename to WordPressEditor/src/main/res/drawable-hdpi/legacy_dashicon_format_quote_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/legacy_icon_mediagallery_placeholder.png b/WordPressEditor/src/main/res/drawable-hdpi/legacy_icon_mediagallery_placeholder.png
new file mode 100644
index 000000000000..9e2b6e4123ac
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/legacy_icon_mediagallery_placeholder.png differ
diff --git a/WordPressEditor/src/main/res/drawable-hdpi/media_movieclip.png b/WordPressEditor/src/main/res/drawable-hdpi/media_movieclip.png
new file mode 100644
index 000000000000..bb49bcdc2cbe
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-hdpi/media_movieclip.png differ
diff --git a/WordPressEditor/src/main/res/drawable-sw600dp-hdpi/format_bar_button_html.png b/WordPressEditor/src/main/res/drawable-sw600dp-hdpi/format_bar_button_html.png
new file mode 100644
index 000000000000..884fafdc23d4
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-sw600dp-hdpi/format_bar_button_html.png differ
diff --git a/WordPressEditor/src/main/res/drawable-sw600dp-hdpi/format_bar_button_html_highlighted.png b/WordPressEditor/src/main/res/drawable-sw600dp-hdpi/format_bar_button_html_highlighted.png
new file mode 100644
index 000000000000..253fd109fffe
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-sw600dp-hdpi/format_bar_button_html_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-sw600dp-xhdpi/format_bar_button_html.png b/WordPressEditor/src/main/res/drawable-sw600dp-xhdpi/format_bar_button_html.png
new file mode 100644
index 000000000000..ce40ac2d0537
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-sw600dp-xhdpi/format_bar_button_html.png differ
diff --git a/WordPressEditor/src/main/res/drawable-sw600dp-xhdpi/format_bar_button_html_highlighted.png b/WordPressEditor/src/main/res/drawable-sw600dp-xhdpi/format_bar_button_html_highlighted.png
new file mode 100644
index 000000000000..bfad2c98dc00
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-sw600dp-xhdpi/format_bar_button_html_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-sw600dp-xxhdpi/format_bar_button_html.png b/WordPressEditor/src/main/res/drawable-sw600dp-xxhdpi/format_bar_button_html.png
new file mode 100644
index 000000000000..4572062f4b5e
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-sw600dp-xxhdpi/format_bar_button_html.png differ
diff --git a/WordPressEditor/src/main/res/drawable-sw600dp-xxhdpi/format_bar_button_html_highlighted.png b/WordPressEditor/src/main/res/drawable-sw600dp-xxhdpi/format_bar_button_html_highlighted.png
new file mode 100644
index 000000000000..6770c73a2337
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-sw600dp-xxhdpi/format_bar_button_html_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/ab_icon_edit.png b/WordPressEditor/src/main/res/drawable-xhdpi/ab_icon_edit.png
new file mode 100644
index 000000000000..46d12a96d135
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/ab_icon_edit.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_bold.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_bold.png
new file mode 100644
index 000000000000..255d97743526
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_bold.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_bold_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_bold_highlighted.png
new file mode 100755
index 000000000000..4c494c5dd1b5
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_bold_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_html.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_html.png
new file mode 100644
index 000000000000..73f29b97d78f
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_html.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_html_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_html_highlighted.png
new file mode 100755
index 000000000000..1dc4d75f2463
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_html_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_italic.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_italic.png
new file mode 100644
index 000000000000..cc784480f194
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_italic.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_italic_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_italic_highlighted.png
new file mode 100755
index 000000000000..557316f6f18e
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_italic_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_link.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_link.png
new file mode 100644
index 000000000000..8f5f4cab8095
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_link.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_link_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_link_highlighted.png
new file mode 100755
index 000000000000..59c200cc359c
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_link_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_media.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_media.png
new file mode 100644
index 000000000000..c0fa0b66a5e6
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_media.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_media_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_media_highlighted.png
new file mode 100755
index 000000000000..e0cde28d7cdf
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_media_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_more.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_more.png
new file mode 100644
index 000000000000..4ecf7052aa90
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_more.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_more_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_more_highlighted.png
new file mode 100755
index 000000000000..575698bb7ca3
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_more_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ol.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ol.png
new file mode 100644
index 000000000000..766a81b1d33b
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ol.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ol_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ol_highlighted.png
new file mode 100755
index 000000000000..731bc7f81133
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ol_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_quote.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_quote.png
new file mode 100644
index 000000000000..10a864bc8590
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_quote.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_quote_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_quote_highlighted.png
new file mode 100755
index 000000000000..09d16fbb37bd
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_quote_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_strikethrough.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_strikethrough.png
new file mode 100644
index 000000000000..85097dbcf5d6
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_strikethrough.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_strikethrough_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_strikethrough_highlighted.png
new file mode 100755
index 000000000000..241292d3e3bd
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_strikethrough_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ul.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ul.png
new file mode 100644
index 000000000000..1993c45fef01
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ul.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ul_highlighted.png b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ul_highlighted.png
new file mode 100755
index 000000000000..f303ce361c3a
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/format_bar_button_ul_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_admin_links.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_admin_links.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_admin_links.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_admin_links.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_admin_links_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_admin_links_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_admin_links_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_admin_links_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_bold.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_bold.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_bold.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_bold.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_bold_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_bold_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_bold_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_bold_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_insertmore.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_insertmore.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_insertmore.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_insertmore.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_insertmore_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_insertmore_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_insertmore_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_insertmore_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_italic.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_italic.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_italic.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_italic.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_italic_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_italic_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_italic_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_italic_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_strikethrough.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_strikethrough.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_strikethrough.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_strikethrough.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_strikethrough_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_strikethrough_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_strikethrough_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_strikethrough_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_underline.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_underline.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_underline.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_underline.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_underline_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_underline_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_editor_underline_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_editor_underline_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_format_image_big_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_format_image_big_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_format_image_big_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_format_image_big_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_format_quote.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_format_quote.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_format_quote.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_format_quote.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/dashicon_format_quote_grey.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_format_quote_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xhdpi/dashicon_format_quote_grey.png
rename to WordPressEditor/src/main/res/drawable-xhdpi/legacy_dashicon_format_quote_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/legacy_icon_mediagallery_placeholder.png b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_icon_mediagallery_placeholder.png
new file mode 100644
index 000000000000..f3fe14ad3cf7
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/legacy_icon_mediagallery_placeholder.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xhdpi/media_movieclip.png b/WordPressEditor/src/main/res/drawable-xhdpi/media_movieclip.png
new file mode 100644
index 000000000000..d1dfae9ea3f6
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xhdpi/media_movieclip.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/ab_icon_edit.png b/WordPressEditor/src/main/res/drawable-xxhdpi/ab_icon_edit.png
new file mode 100644
index 000000000000..8c5d06a797da
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/ab_icon_edit.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_bold.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_bold.png
new file mode 100644
index 000000000000..435049aee0ee
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_bold.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_bold_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_bold_highlighted.png
new file mode 100755
index 000000000000..db0116bcfcc3
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_bold_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_html.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_html.png
new file mode 100644
index 000000000000..4ae28495c8eb
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_html.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_html_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_html_highlighted.png
new file mode 100755
index 000000000000..db0c60415725
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_html_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_italic.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_italic.png
new file mode 100644
index 000000000000..184b1dfa6e63
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_italic.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_italic_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_italic_highlighted.png
new file mode 100755
index 000000000000..2b4a9376ae37
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_italic_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_link.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_link.png
new file mode 100644
index 000000000000..f08f26ddd165
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_link.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_link_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_link_highlighted.png
new file mode 100755
index 000000000000..2accfc4d4067
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_link_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_media.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_media.png
new file mode 100644
index 000000000000..3be85757cf71
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_media.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_media_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_media_highlighted.png
new file mode 100755
index 000000000000..cffc6f72e219
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_media_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_more.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_more.png
new file mode 100644
index 000000000000..34e74b09deb1
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_more.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_more_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_more_highlighted.png
new file mode 100755
index 000000000000..4674a187bda0
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_more_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ol.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ol.png
new file mode 100644
index 000000000000..074aa098be6b
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ol.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ol_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ol_highlighted.png
new file mode 100755
index 000000000000..93fc1eacf342
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ol_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_quote.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_quote.png
new file mode 100644
index 000000000000..3f34d51000c6
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_quote.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_quote_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_quote_highlighted.png
new file mode 100755
index 000000000000..3607441c1331
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_quote_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_strikethrough.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_strikethrough.png
new file mode 100644
index 000000000000..263f3028796d
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_strikethrough.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_strikethrough_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_strikethrough_highlighted.png
new file mode 100755
index 000000000000..fb86d4c54313
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_strikethrough_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ul.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ul.png
new file mode 100644
index 000000000000..ed54395d8295
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ul.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ul_highlighted.png b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ul_highlighted.png
new file mode 100755
index 000000000000..11ba3cf4c240
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/format_bar_button_ul_highlighted.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_admin_links.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_admin_links.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_admin_links.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_admin_links.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_admin_links_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_admin_links_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_admin_links_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_admin_links_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_bold.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_bold.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_bold.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_bold.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_bold_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_bold_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_bold_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_bold_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_insertmore.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_insertmore.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_insertmore.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_insertmore.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_insertmore_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_insertmore_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_insertmore_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_insertmore_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_italic.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_italic.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_italic.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_italic.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_italic_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_italic_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_italic_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_italic_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_strikethrough.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_strikethrough.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_strikethrough.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_strikethrough.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_strikethrough_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_strikethrough_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_strikethrough_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_strikethrough_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_underline.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_underline.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_underline.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_underline.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_underline_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_underline_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_editor_underline_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_editor_underline_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_format_image_big_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_format_image_big_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_format_image_big_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_format_image_big_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_format_quote.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_format_quote.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_format_quote.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_format_quote.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_format_quote_grey.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_format_quote_grey.png
similarity index 100%
rename from WordPressEditor/src/main/res/drawable-xxhdpi/dashicon_format_quote_grey.png
rename to WordPressEditor/src/main/res/drawable-xxhdpi/legacy_dashicon_format_quote_grey.png
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_icon_mediagallery_placeholder.png b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_icon_mediagallery_placeholder.png
new file mode 100644
index 000000000000..40976b210a59
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/legacy_icon_mediagallery_placeholder.png differ
diff --git a/WordPressEditor/src/main/res/drawable-xxhdpi/media_movieclip.png b/WordPressEditor/src/main/res/drawable-xxhdpi/media_movieclip.png
new file mode 100644
index 000000000000..90e9b768a96d
Binary files /dev/null and b/WordPressEditor/src/main/res/drawable-xxhdpi/media_movieclip.png differ
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selected_state.xml
old mode 100644
new mode 100755
index 0e7309e4fb3a..4ab6a2e2615e
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selected_state.xml
@@ -2,11 +2,15 @@
 <layer-list
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
-        <shape>
-            <solid android:color="@color/blue_new_kid"/>
-        </shape>
+        <bitmap
+            android:src="@drawable/format_bar_button_bold_highlighted"
+            android:gravity="center"/>
     </item>
-    <item>
-        <bitmap android:src="@drawable/dashicon_editor_bold" android:gravity="center"/>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selector.xml
old mode 100644
new mode 100755
index 905d41c187f2..fdc1772d9ef1
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_bold_selector.xml
@@ -1,8 +1,10 @@
 <?xml version="1.0" encoding="utf-8"?>
-<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_checked="true" android:drawable="@drawable/format_bar_button_bold_selected_state"/>
     <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_bold_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_bold_grey" android:gravity="center"/>
+        <bitmap
+            android:src="@drawable/format_bar_button_bold"
+            android:gravity="center"/>
     </item>
 </selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_highlighted_underline.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_highlighted_underline.xml
new file mode 100644
index 000000000000..ed4a79dc9416
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_highlighted_underline.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0" encoding="utf-8"?>
+<shape android:shape="line" xmlns:android="http://schemas.android.com/apk/res/android">
+    <stroke
+        android:width="@dimen/format_bar_button_highlighted_underline_width"
+        android:color="@color/format_bar_button_highlighted_color"/>
+</shape>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_html_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_html_selected_state.xml
new file mode 100755
index 000000000000..696a6ce9c0be
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_html_selected_state.xml
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_html_highlighted"
+            android:gravity="center"/>
+    </item>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_html_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_html_selector.xml
new file mode 100755
index 000000000000..86229c0f76e2
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_html_selector.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_checked="true" android:drawable="@drawable/format_bar_button_html_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_html_selected_state"/>
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_html"
+            android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selected_state.xml
old mode 100644
new mode 100755
index b01b18738d8d..29eb69e4a705
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selected_state.xml
@@ -2,11 +2,15 @@
 <layer-list
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
-        <shape>
-            <solid android:color="@color/blue_new_kid"/>
-        </shape>
+        <bitmap
+            android:src="@drawable/format_bar_button_italic_highlighted"
+            android:gravity="center"/>
     </item>
-    <item>
-        <bitmap android:src="@drawable/dashicon_editor_italic" android:gravity="center"/>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selector.xml
old mode 100644
new mode 100755
index 2b8cb68bcfd0..c627cb34c42f
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_italic_selector.xml
@@ -1,8 +1,10 @@
 <?xml version="1.0" encoding="utf-8"?>
-<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_checked="true" android:drawable="@drawable/format_bar_button_italic_selected_state"/>
     <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_italic_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_italic_grey" android:gravity="center"/>
+        <bitmap
+            android:src="@drawable/format_bar_button_italic"
+            android:gravity="center"/>
     </item>
 </selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_link_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_link_selected_state.xml
old mode 100644
new mode 100755
index aa147f669e6e..55102f1b1366
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_link_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_link_selected_state.xml
@@ -2,11 +2,15 @@
 <layer-list
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
-        <shape>
-            <solid android:color="@color/blue_new_kid"/>
-        </shape>
+        <bitmap
+            android:src="@drawable/format_bar_button_link_highlighted"
+            android:gravity="center"/>
     </item>
-    <item>
-        <bitmap android:src="@drawable/dashicon_admin_links" android:gravity="center"/>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_link_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_link_selector.xml
old mode 100644
new mode 100755
index 736f212f1076..053cea8d32db
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_link_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_link_selector.xml
@@ -1,8 +1,10 @@
 <?xml version="1.0" encoding="utf-8"?>
-<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_checked="true" android:drawable="@drawable/format_bar_button_link_selected_state"/>
     <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_link_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/dashicon_admin_links_grey" android:gravity="center"/>
+        <bitmap
+            android:src="@drawable/format_bar_button_link"
+            android:gravity="center"/>
     </item>
 </selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_media_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_media_selected_state.xml
old mode 100644
new mode 100755
index 5041c00f77ba..4b1563f0f273
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_media_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_media_selected_state.xml
@@ -2,11 +2,15 @@
 <layer-list
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
-        <shape>
-            <solid android:color="@color/blue_new_kid"/>
-        </shape>
+        <bitmap
+            android:src="@drawable/format_bar_button_media_highlighted"
+            android:gravity="center"/>
     </item>
-    <item>
-        <bitmap android:src="@drawable/noticon_picture" android:gravity="center"/>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_media_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_media_selector.xml
old mode 100644
new mode 100755
index 7c2f5bb64ab5..003de550cc40
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_media_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_media_selector.xml
@@ -1,8 +1,10 @@
 <?xml version="1.0" encoding="utf-8"?>
-<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_checked="true" android:drawable="@drawable/format_bar_button_media_selected_state"/>
     <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_media_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/noticon_picture_grey" android:gravity="center"/>
+        <bitmap
+            android:src="@drawable/format_bar_button_media"
+            android:gravity="center"/>
     </item>
 </selector>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_ol_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_ol_selected_state.xml
new file mode 100755
index 000000000000..9d07fc4dc490
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_ol_selected_state.xml
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_ol_highlighted"
+            android:gravity="center"/>
+    </item>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_ol_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_ol_selector.xml
new file mode 100755
index 000000000000..c0f849cd0264
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_ol_selector.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_checked="true" android:drawable="@drawable/format_bar_button_ol_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_ol_selected_state"/>
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_ol"
+            android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selected_state.xml
old mode 100644
new mode 100755
index d145faf7882d..bcea43181cde
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selected_state.xml
@@ -2,11 +2,15 @@
 <layer-list
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
-        <shape>
-            <solid android:color="@color/blue_new_kid"/>
-        </shape>
+        <bitmap
+            android:src="@drawable/format_bar_button_quote_highlighted"
+            android:gravity="center"/>
     </item>
-    <item>
-        <bitmap android:src="@drawable/dashicon_format_quote" android:gravity="center"/>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selector.xml
old mode 100644
new mode 100755
index 4de783f1a1ab..bad08df8d9d1
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_quote_selector.xml
@@ -1,8 +1,10 @@
 <?xml version="1.0" encoding="utf-8"?>
-<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
     <item android:state_checked="true" android:drawable="@drawable/format_bar_button_quote_selected_state"/>
     <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_quote_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/dashicon_format_quote_grey" android:gravity="center"/>
+        <bitmap
+            android:src="@drawable/format_bar_button_quote"
+            android:gravity="center"/>
     </item>
-</selector>
\ No newline at end of file
+</selector>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_strikethrough_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_strikethrough_selected_state.xml
new file mode 100644
index 000000000000..1c89e03e9722
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_strikethrough_selected_state.xml
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_strikethrough_highlighted"
+            android:gravity="center"/>
+    </item>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_strikethrough_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_strikethrough_selector.xml
new file mode 100644
index 000000000000..07fe02a892c5
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_strikethrough_selector.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_checked="true" android:drawable="@drawable/format_bar_button_strikethrough_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_strikethrough_selected_state"/>
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_strikethrough"
+            android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_ul_selected_state.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_ul_selected_state.xml
new file mode 100755
index 000000000000..d9e9929d6d5d
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_ul_selected_state.xml
@@ -0,0 +1,16 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_ul_highlighted"
+            android:gravity="center"/>
+    </item>
+    <item android:top="@dimen/format_bar_button_highlighted_underline_top">
+        <shape android:shape="line">
+            <stroke
+                android:width="@dimen/format_bar_button_highlighted_underline_width"
+                android:color="@color/format_bar_button_highlighted_color"/>
+        </shape>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_ul_selector.xml b/WordPressEditor/src/main/res/drawable/format_bar_button_ul_selector.xml
new file mode 100755
index 000000000000..d66242298f5b
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/format_bar_button_ul_selector.xml
@@ -0,0 +1,10 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android">
+    <item android:state_checked="true" android:drawable="@drawable/format_bar_button_ul_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_ul_selected_state"/>
+    <item>
+        <bitmap
+            android:src="@drawable/format_bar_button_ul"
+            android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_more_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_bold_selected_state.xml
similarity index 50%
rename from WordPressEditor/src/main/res/drawable/format_bar_button_more_selected_state.xml
rename to WordPressEditor/src/main/res/drawable/legacy_format_bar_button_bold_selected_state.xml
index 9ff1e9f3480d..5e7ca3ef8408 100644
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_more_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_bold_selected_state.xml
@@ -3,10 +3,10 @@
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
         <shape>
-            <solid android:color="@color/blue_new_kid"/>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
         </shape>
     </item>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_insertmore" android:gravity="center"/>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_bold" android:gravity="center"/>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_strike_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_bold_selector.xml
similarity index 57%
rename from WordPressEditor/src/main/res/drawable/format_bar_button_strike_selector.xml
rename to WordPressEditor/src/main/res/drawable/legacy_format_bar_button_bold_selector.xml
index 9d00180ad04c..66d8b631f6f3 100644
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_strike_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_bold_selector.xml
@@ -1,8 +1,8 @@
 <?xml version="1.0" encoding="utf-8"?>
 <selector xmlns:android="http://schemas.android.com/apk/res/android" >
-    <item android:state_checked="true" android:drawable="@drawable/format_bar_button_strike_selected_state"/>
-    <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_strike_selected_state"/>
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_bold_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_bold_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_strikethrough_grey" android:gravity="center"/>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_bold_grey" android:gravity="center"/>
     </item>
 </selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_italic_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_italic_selected_state.xml
new file mode 100644
index 000000000000..13689b19a1eb
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_italic_selected_state.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
+        </shape>
+    </item>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_italic" android:gravity="center"/>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_italic_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_italic_selector.xml
new file mode 100644
index 000000000000..f0fd9049772b
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_italic_selector.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_italic_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_italic_selected_state"/>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_italic_grey" android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_strike_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_link_selected_state.xml
similarity index 50%
rename from WordPressEditor/src/main/res/drawable/format_bar_button_strike_selected_state.xml
rename to WordPressEditor/src/main/res/drawable/legacy_format_bar_button_link_selected_state.xml
index d00af024af89..d376ceef0eeb 100644
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_strike_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_link_selected_state.xml
@@ -3,10 +3,10 @@
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
         <shape>
-            <solid android:color="@color/blue_new_kid"/>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
         </shape>
     </item>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_strikethrough" android:gravity="center"/>
+        <bitmap android:src="@drawable/legacy_dashicon_admin_links" android:gravity="center"/>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_underline_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_link_selector.xml
similarity index 57%
rename from WordPressEditor/src/main/res/drawable/format_bar_button_underline_selector.xml
rename to WordPressEditor/src/main/res/drawable/legacy_format_bar_button_link_selector.xml
index 8f42668e2346..4c488f471d0d 100644
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_underline_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_link_selector.xml
@@ -1,8 +1,8 @@
 <?xml version="1.0" encoding="utf-8"?>
 <selector xmlns:android="http://schemas.android.com/apk/res/android" >
-    <item android:state_checked="true" android:drawable="@drawable/format_bar_button_underline_selected_state"/>
-    <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_underline_selected_state"/>
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_link_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_link_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_underline_grey" android:gravity="center"/>
+        <bitmap android:src="@drawable/legacy_dashicon_admin_links_grey" android:gravity="center"/>
     </item>
 </selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_underline_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_media_selected_state.xml
similarity index 52%
rename from WordPressEditor/src/main/res/drawable/format_bar_button_underline_selected_state.xml
rename to WordPressEditor/src/main/res/drawable/legacy_format_bar_button_media_selected_state.xml
index be0b25dd1e58..9d4cbf83ef45 100644
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_underline_selected_state.xml
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_media_selected_state.xml
@@ -3,10 +3,10 @@
     xmlns:android="http://schemas.android.com/apk/res/android">
     <item>
         <shape>
-            <solid android:color="@color/blue_new_kid"/>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
         </shape>
     </item>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_underline" android:gravity="center"/>
+        <bitmap android:src="@drawable/noticon_picture" android:gravity="center"/>
     </item>
-</layer-list>
\ No newline at end of file
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_media_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_media_selector.xml
new file mode 100644
index 000000000000..ece70b5c4f36
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_media_selector.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_media_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_media_selected_state"/>
+    <item>
+        <bitmap android:src="@drawable/noticon_picture_grey" android:gravity="center"/>
+    </item>
+</selector>
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_more_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_more_selected_state.xml
new file mode 100644
index 000000000000..0c7870ff52ce
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_more_selected_state.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
+        </shape>
+    </item>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_insertmore" android:gravity="center"/>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_more_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_more_selector.xml
new file mode 100644
index 000000000000..f28a013ce44a
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_more_selector.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_more_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_more_selected_state"/>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_insertmore_grey" android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_quote_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_quote_selected_state.xml
new file mode 100644
index 000000000000..b848cd831ccd
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_quote_selected_state.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
+        </shape>
+    </item>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_format_quote" android:gravity="center"/>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/format_bar_button_more_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_quote_selector.xml
similarity index 57%
rename from WordPressEditor/src/main/res/drawable/format_bar_button_more_selector.xml
rename to WordPressEditor/src/main/res/drawable/legacy_format_bar_button_quote_selector.xml
index 412de63a4799..ad0a2e684d26 100644
--- a/WordPressEditor/src/main/res/drawable/format_bar_button_more_selector.xml
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_quote_selector.xml
@@ -1,8 +1,8 @@
 <?xml version="1.0" encoding="utf-8"?>
 <selector xmlns:android="http://schemas.android.com/apk/res/android" >
-    <item android:state_checked="true" android:drawable="@drawable/format_bar_button_more_selected_state"/>
-    <item android:state_pressed="true" android:drawable="@drawable/format_bar_button_more_selected_state"/>
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_quote_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_quote_selected_state"/>
     <item>
-        <bitmap android:src="@drawable/dashicon_editor_insertmore_grey" android:gravity="center"/>
+        <bitmap android:src="@drawable/legacy_dashicon_format_quote_grey" android:gravity="center"/>
     </item>
 </selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_strike_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_strike_selected_state.xml
new file mode 100644
index 000000000000..43762ab9e36e
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_strike_selected_state.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
+        </shape>
+    </item>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_strikethrough" android:gravity="center"/>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_strike_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_strike_selector.xml
new file mode 100644
index 000000000000..d96797dc7e32
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_strike_selector.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_strike_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_strike_selected_state"/>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_strikethrough_grey" android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_underline_selected_state.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_underline_selected_state.xml
new file mode 100644
index 000000000000..786fe8d498ae
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_underline_selected_state.xml
@@ -0,0 +1,12 @@
+<?xml version="1.0" encoding="utf-8"?>
+<layer-list
+    xmlns:android="http://schemas.android.com/apk/res/android">
+    <item>
+        <shape>
+            <solid android:color="@color/legacy_format_bar_button_selected"/>
+        </shape>
+    </item>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_underline" android:gravity="center"/>
+    </item>
+</layer-list>
diff --git a/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_underline_selector.xml b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_underline_selector.xml
new file mode 100644
index 000000000000..38ea66806a3c
--- /dev/null
+++ b/WordPressEditor/src/main/res/drawable/legacy_format_bar_button_underline_selector.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<selector xmlns:android="http://schemas.android.com/apk/res/android" >
+    <item android:state_checked="true" android:drawable="@drawable/legacy_format_bar_button_underline_selected_state"/>
+    <item android:state_pressed="true" android:drawable="@drawable/legacy_format_bar_button_underline_selected_state"/>
+    <item>
+        <bitmap android:src="@drawable/legacy_dashicon_editor_underline_grey" android:gravity="center"/>
+    </item>
+</selector>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/drawable/list_divider.xml b/WordPressEditor/src/main/res/drawable/list_divider.xml
index 7e3bd2b8f19b..74267734f80f 100644
--- a/WordPressEditor/src/main/res/drawable/list_divider.xml
+++ b/WordPressEditor/src/main/res/drawable/list_divider.xml
@@ -4,7 +4,7 @@
     android:insetRight="@dimen/margin_extra_large">
     <shape android:shape="rectangle">
 
-        <solid android:color="@color/grey_extra_light" />
+        <solid android:color="@color/legacy_format_bar_background" />
 
     </shape>
-</inset>
\ No newline at end of file
+</inset>
diff --git a/WordPressEditor/src/main/res/drawable/pressed_background_wordpress.xml b/WordPressEditor/src/main/res/drawable/pressed_background_wordpress.xml
index b0a98b0879e6..4475720c27e6 100644
--- a/WordPressEditor/src/main/res/drawable/pressed_background_wordpress.xml
+++ b/WordPressEditor/src/main/res/drawable/pressed_background_wordpress.xml
@@ -18,5 +18,5 @@
 -->
 
 <shape xmlns:android="http://schemas.android.com/apk/res/android" android:shape="rectangle">
-    <solid android:color="@color/pressed_wordpress" />
+    <solid android:color="@color/legacy_pressed_wordpress" />
 </shape>
diff --git a/WordPressEditor/src/main/res/layout-sw600dp/fragment_editor.xml b/WordPressEditor/src/main/res/layout-sw600dp/fragment_editor.xml
new file mode 100644
index 000000000000..26281530c6ab
--- /dev/null
+++ b/WordPressEditor/src/main/res/layout-sw600dp/fragment_editor.xml
@@ -0,0 +1,134 @@
+<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:orientation="vertical"
+    tools:context="org.wordpress.android.editor.EditorFragment">
+
+    <include
+        layout="@layout/editor_webview"
+        android:id="@+id/webview"
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:layout_above="@+id/format_bar"/>
+
+    <LinearLayout
+        android:id="@+id/format_bar"
+        android:layout_width="fill_parent"
+        android:layout_height="@dimen/format_bar_height"
+        android:layout_gravity="bottom"
+        android:layout_alignParentBottom="true"
+        android:background="@android:color/white"
+        android:orientation="vertical">
+
+        <View
+            android:id="@+id/format_bar_horizontal_divider"
+            android:layout_width="fill_parent"
+            android:layout_height="@dimen/format_bar_horizontal_divider_height"
+            style="@style/Divider"/>
+
+        <LinearLayout
+            android:id="@+id/format_bar_buttons"
+            android:layout_width="fill_parent"
+            android:layout_height="@dimen/format_bar_height"
+            android:layout_gravity="bottom"
+            android:gravity="center"
+            android:orientation="horizontal"
+            tools:ignore="RtlHardcoded">
+
+            <LinearLayout
+                style="@style/FormatBarTabletGroup"
+                android:layout_width="wrap_content"
+                android:layout_height="fill_parent">
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_media"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_media_selector"/>
+            </LinearLayout>
+
+            <LinearLayout
+                style="@style/FormatBarTabletGroup"
+                android:layout_width="wrap_content"
+                android:layout_height="fill_parent">
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_bold"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_bold_selector"/>
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_italic"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_italic_selector"/>
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_strikethrough"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_strikethrough_selector"/>
+            </LinearLayout>
+
+            <LinearLayout
+                style="@style/FormatBarTabletGroup"
+                android:layout_width="wrap_content"
+                android:layout_height="fill_parent">
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_link"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_link_selector"/>
+            </LinearLayout>
+
+            <LinearLayout
+                style="@style/FormatBarTabletGroup"
+                android:layout_width="wrap_content"
+                android:layout_height="fill_parent">
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_ul"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_ul_selector"/>
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_ol"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_ol_selector"/>
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_quote"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_quote_selector"/>
+            </LinearLayout>
+
+            <LinearLayout
+                style="@style/FormatBarTabletGroup"
+                android:layout_width="wrap_content"
+                android:layout_height="fill_parent">
+
+                <ToggleButton
+                    android:id="@+id/format_bar_button_html"
+                    style="@style/FormatBarButtonTablet"
+                    android:layout_width="wrap_content"
+                    android:layout_height="fill_parent"
+                    android:background="@drawable/format_bar_button_html_selector"/>
+            </LinearLayout>
+        </LinearLayout>
+    </LinearLayout>
+
+</RelativeLayout>
diff --git a/WordPressEditor/src/main/res/layout-v19/editor_webview.xml b/WordPressEditor/src/main/res/layout-v19/editor_webview.xml
new file mode 100644
index 000000000000..fb826c2ff754
--- /dev/null
+++ b/WordPressEditor/src/main/res/layout-v19/editor_webview.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0" encoding="utf-8"?>
+<org.wordpress.android.editor.EditorWebView
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    />
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/layout/alert_create_link.xml b/WordPressEditor/src/main/res/layout/alert_create_link.xml
new file mode 100644
index 000000000000..840917184909
--- /dev/null
+++ b/WordPressEditor/src/main/res/layout/alert_create_link.xml
@@ -0,0 +1,42 @@
+<?xml version="1.0" encoding="utf-8"?>
+<RelativeLayout
+  xmlns:android="http://schemas.android.com/apk/res/android"
+  android:layout_width="fill_parent"
+  android:layout_height="wrap_content"
+  android:padding="@dimen/margin_medium"
+  android:layout_gravity="center_vertical">
+
+  <EditText
+    android:id="@+id/linkURL"
+    android:inputType="textUri"
+    android:layout_width="fill_parent"
+    android:layout_height="wrap_content"
+    android:hint="@string/link_enter_url"
+    android:imeOptions="actionNext" />
+
+  <EditText
+    android:id="@+id/linkText"
+    android:inputType="text"
+    android:layout_width="fill_parent"
+    android:layout_height="wrap_content"
+    android:layout_below="@id/linkURL"
+    android:hint="@string/link_enter_url_text" />
+
+  <Button
+    android:id="@+id/ok"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:layout_below="@id/linkText"
+    android:layout_alignParentRight="true"
+    android:layout_marginLeft="@dimen/margin_medium"
+    android:text="@android:string/ok" />
+
+  <Button
+    android:id="@+id/cancel"
+    android:layout_width="wrap_content"
+    android:layout_height="wrap_content"
+    android:layout_alignTop="@id/ok"
+    android:layout_toLeftOf="@id/ok"
+    android:text="@android:string/cancel" />
+
+</RelativeLayout>
diff --git a/WordPressEditor/src/main/res/layout/alert_image_options.xml b/WordPressEditor/src/main/res/layout/alert_image_options.xml
new file mode 100644
index 000000000000..b2d4fdb9c2ae
--- /dev/null
+++ b/WordPressEditor/src/main/res/layout/alert_image_options.xml
@@ -0,0 +1,81 @@
+<?xml version="1.0" encoding="utf-8"?>
+<ScrollView
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent">
+
+    <LinearLayout
+        android:orientation="vertical"
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:padding="10dp"
+        android:layout_gravity="center_horizontal"
+        android:gravity="center_horizontal">
+
+        <EditText
+            android:id="@+id/title"
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:hint="@string/title"
+            android:singleLine="true"/>
+
+        <EditText
+            android:id="@+id/caption"
+            android:layout_width="match_parent"
+            android:layout_height="wrap_content"
+            android:hint="@string/caption"
+            android:singleLine="true"
+            android:inputType="textCapSentences"/>
+
+        <TextView
+            android:layout_width="fill_parent"
+            android:layout_height="wrap_content"
+            android:text="@string/horizontal_alignment"
+            android:textStyle="bold"
+            android:textColor="@color/image_options_label"/>
+
+        <Spinner
+            android:id="@+id/alignment_spinner"
+            android:layout_width="fill_parent"
+            android:layout_height="wrap_content"
+            android:prompt="@string/image_alignment"/>
+
+        <TextView
+            android:layout_width="fill_parent"
+            android:layout_height="wrap_content"
+            android:text="@string/width"
+            android:textStyle="bold"
+            android:textColor="@color/image_options_label"/>
+
+        <SeekBar
+            android:layout_height="wrap_content"
+            android:id="@+id/imageWidth"
+            android:layout_width="match_parent"/>
+
+        <EditText
+            android:layout_width="fill_parent"
+            android:layout_height="wrap_content"
+            android:text=""
+            android:imeOptions="actionDone"
+            android:id="@+id/imageWidthText"
+            android:layout_gravity="left|center_vertical"
+            android:singleLine="true"
+            android:inputType="number"/>
+
+        <CheckBox
+            android:layout_gravity="left"
+            android:text="@string/featured"
+            android:id="@+id/featuredImage"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:visibility="gone"/>
+
+        <CheckBox
+            android:layout_gravity="left"
+            android:text="@string/featured_in_post"
+            android:id="@+id/featuredInPost"
+            android:layout_width="wrap_content"
+            android:layout_height="wrap_content"
+            android:visibility="gone"/>
+    </LinearLayout>
+</ScrollView>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/layout/editor_webview.xml b/WordPressEditor/src/main/res/layout/editor_webview.xml
new file mode 100644
index 000000000000..b02cf21daeff
--- /dev/null
+++ b/WordPressEditor/src/main/res/layout/editor_webview.xml
@@ -0,0 +1,6 @@
+<?xml version="1.0" encoding="utf-8"?>
+<org.wordpress.android.editor.EditorWebViewCompatibility
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    />
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/layout/fragment_edit_post_content.xml b/WordPressEditor/src/main/res/layout/fragment_edit_post_content.xml
index dd69d6704fec..6e9109983ed9 100644
--- a/WordPressEditor/src/main/res/layout/fragment_edit_post_content.xml
+++ b/WordPressEditor/src/main/res/layout/fragment_edit_post_content.xml
@@ -3,7 +3,7 @@
     android:layout_width="match_parent"
     android:layout_height="match_parent"
     android:orientation="vertical"
-    android:background="@color/white"
+    android:background="@android:color/white"
     android:focusableInTouchMode="true">
 
     <ScrollView
@@ -46,7 +46,7 @@
                 android:textSize="18sp"
                 android:inputType="textMultiLine|textCapSentences|textAutoCorrect"
                 android:imeOptions="flagNoExtractUi"
-                android:textColorLink="@color/wordpress_blue" />
+                android:textColorLink="@color/legacy_placeholder_content_text" />
         </LinearLayout>
     </ScrollView>
 
@@ -81,7 +81,7 @@
         android:layout_width="fill_parent"
         android:layout_height="@dimen/format_bar_height"
         android:layout_gravity="bottom"
-        android:background="@color/grey_extra_light"
+        android:background="@color/legacy_format_bar_background"
         android:orientation="horizontal"
         android:visibility="gone">
 
@@ -100,49 +100,49 @@
                     style="@style/ToggleButton"
                     android:layout_width="wrap_content"
                     android:layout_height="fill_parent"
-                    android:background="@drawable/format_bar_button_bold_selector" />
+                    android:background="@drawable/legacy_format_bar_button_bold_selector" />
 
                 <ToggleButton
                     android:id="@+id/em"
                     style="@style/ToggleButton"
                     android:layout_width="wrap_content"
                     android:layout_height="fill_parent"
-                    android:background="@drawable/format_bar_button_italic_selector" />
+                    android:background="@drawable/legacy_format_bar_button_italic_selector" />
 
                 <ToggleButton
                     android:id="@+id/underline"
                     style="@style/ToggleButton"
                     android:layout_width="wrap_content"
                     android:layout_height="fill_parent"
-                    android:background="@drawable/format_bar_button_underline_selector" />
+                    android:background="@drawable/legacy_format_bar_button_underline_selector" />
 
                 <ToggleButton
                     android:id="@+id/strike"
                     style="@style/ToggleButton"
                     android:layout_width="wrap_content"
                     android:layout_height="fill_parent"
-                    android:background="@drawable/format_bar_button_strike_selector" />
+                    android:background="@drawable/legacy_format_bar_button_strike_selector" />
 
                 <ToggleButton
                     android:id="@+id/bquote"
                     style="@style/ToggleButton"
                     android:layout_width="wrap_content"
                     android:layout_height="fill_parent"
-                    android:background="@drawable/format_bar_button_quote_selector" />
+                    android:background="@drawable/legacy_format_bar_button_quote_selector" />
 
                 <Button
                     android:id="@+id/link"
                     android:layout_width="wrap_content"
                     android:layout_height="fill_parent"
                     android:minWidth="@dimen/format_bar_height"
-                    android:background="@drawable/format_bar_button_link_selector" />
+                    android:background="@drawable/legacy_format_bar_button_link_selector" />
 
                 <Button
                     android:id="@+id/more"
                     android:layout_width="wrap_content"
                     android:layout_height="fill_parent"
                     android:minWidth="@dimen/format_bar_height"
-                    android:background="@drawable/format_bar_button_more_selector" />
+                    android:background="@drawable/legacy_format_bar_button_more_selector" />
             </LinearLayout>
         </HorizontalScrollView>
 
@@ -151,7 +151,7 @@
             android:layout_width="wrap_content"
             android:layout_height="fill_parent"
             android:minWidth="@dimen/format_bar_height"
-            android:background="@drawable/format_bar_button_media_selector" />
+            android:background="@drawable/legacy_format_bar_button_media_selector" />
     </LinearLayout>
 
 </LinearLayout>
diff --git a/WordPressEditor/src/main/res/layout/fragment_editor.xml b/WordPressEditor/src/main/res/layout/fragment_editor.xml
old mode 100644
new mode 100755
index 02eacce679e0..bbf2b860af26
--- a/WordPressEditor/src/main/res/layout/fragment_editor.xml
+++ b/WordPressEditor/src/main/res/layout/fragment_editor.xml
@@ -1,12 +1,118 @@
-<FrameLayout xmlns:android="http://schemas.android.com/apk/res/android"
-             xmlns:tools="http://schemas.android.com/tools"
-             android:layout_width="match_parent"
-             android:layout_height="match_parent"
-             tools:context="org.wordpress.android.editor.EditorFragment">
+<RelativeLayout xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:orientation="vertical"
+    tools:context="org.wordpress.android.editor.EditorFragment">
 
-    <WebView
+    <include
+        layout="@layout/editor_webview"
+        android:id="@+id/webview"
         android:layout_width="match_parent"
         android:layout_height="match_parent"
-        android:id="@+id/webview"/>
+        android:layout_above="@+id/format_bar"/>
 
-</FrameLayout>
+    <LinearLayout
+        android:id="@+id/format_bar"
+        android:layout_width="fill_parent"
+        android:layout_height="@dimen/format_bar_height"
+        android:layout_gravity="bottom"
+        android:layout_alignParentBottom="true"
+        android:background="@android:color/white"
+        android:orientation="vertical">
+
+        <View
+            android:id="@+id/format_bar_horizontal_divider"
+            android:layout_width="fill_parent"
+            android:layout_height="@dimen/format_bar_horizontal_divider_height"
+            style="@style/Divider"/>
+
+        <LinearLayout
+            android:id="@+id/format_bar_buttons"
+            android:layout_width="fill_parent"
+            android:layout_height="@dimen/format_bar_height"
+            android:layout_gravity="bottom"
+            android:layout_marginRight="@dimen/format_bar_right_margin"
+            android:orientation="horizontal"
+            tools:ignore="RtlHardcoded">
+
+            <HorizontalScrollView
+                android:layout_width="0dp"
+                android:layout_height="wrap_content"
+                android:layout_weight="1">
+
+                <LinearLayout
+                    android:layout_width="wrap_content"
+                    android:layout_height="wrap_content"
+                    android:layout_marginLeft="@dimen/format_bar_left_margin"
+                    android:orientation="horizontal"
+                    tools:ignore="RtlHardcoded">
+
+                    <ToggleButton
+                        android:id="@+id/format_bar_button_media"
+                        style="@style/FormatBarScrollViewButton"
+                        android:layout_width="wrap_content"
+                        android:layout_height="fill_parent"
+                        android:background="@drawable/format_bar_button_media_selector"/>
+
+                    <ToggleButton
+                        android:id="@+id/format_bar_button_bold"
+                        style="@style/FormatBarScrollViewButton"
+                        android:layout_width="wrap_content"
+                        android:layout_height="fill_parent"
+                        android:background="@drawable/format_bar_button_bold_selector"/>
+
+                    <ToggleButton
+                        android:id="@+id/format_bar_button_italic"
+                        style="@style/FormatBarScrollViewButton"
+                        android:layout_width="wrap_content"
+                        android:layout_height="fill_parent"
+                        android:background="@drawable/format_bar_button_italic_selector"/>
+
+                    <ToggleButton
+                        android:id="@+id/format_bar_button_quote"
+                        style="@style/FormatBarScrollViewButton"
+                        android:layout_width="wrap_content"
+                        android:layout_height="fill_parent"
+                        android:background="@drawable/format_bar_button_quote_selector"/>
+
+                    <ToggleButton
+                        android:id="@+id/format_bar_button_ul"
+                        style="@style/FormatBarScrollViewButton"
+                        android:layout_width="wrap_content"
+                        android:layout_height="fill_parent"
+                        android:background="@drawable/format_bar_button_ul_selector"/>
+
+                    <ToggleButton
+                        android:id="@+id/format_bar_button_ol"
+                        style="@style/FormatBarScrollViewButton"
+                        android:layout_width="wrap_content"
+                        android:layout_height="fill_parent"
+                        android:background="@drawable/format_bar_button_ol_selector"/>
+
+                    <ToggleButton
+                        android:id="@+id/format_bar_button_link"
+                        style="@style/FormatBarScrollViewButton"
+                        android:layout_width="wrap_content"
+                        android:layout_height="fill_parent"
+                        android:background="@drawable/format_bar_button_link_selector"/>
+                </LinearLayout>
+            </HorizontalScrollView>
+
+            <View
+                android:id="@+id/format_bar_vertical_divider"
+                android:layout_width="@dimen/format_bar_vertical_divider_width"
+                android:layout_height="@dimen/format_bar_vertical_divider_height"
+                android:layout_gravity="center"
+                style="@style/Divider"/>
+
+            <ToggleButton
+                android:id="@+id/format_bar_button_html"
+                style="@style/FormatBarHtmlButton"
+                android:layout_width="wrap_content"
+                android:layout_height="fill_parent"
+                android:background="@drawable/format_bar_button_html_selector"/>
+        </LinearLayout>
+    </LinearLayout>
+
+</RelativeLayout>
diff --git a/WordPressEditor/src/main/res/values-w1280dp/layouts.xml b/WordPressEditor/src/main/res/values-w1280dp/layouts.xml
new file mode 100644
index 000000000000..17b7dd6bec5b
--- /dev/null
+++ b/WordPressEditor/src/main/res/values-w1280dp/layouts.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <bool name="is_large_tablet_landscape">true</bool>
+</resources>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/values-w800dp/dimens.xml b/WordPressEditor/src/main/res/values-w800dp/dimens.xml
new file mode 100644
index 000000000000..1f110a98b57e
--- /dev/null
+++ b/WordPressEditor/src/main/res/values-w800dp/dimens.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <dimen name="format_bar_button_margin_tablet">@dimen/format_bar_button_margin_tablet_large</dimen>
+    <dimen name="format_bar_button_group_tablet">@dimen/format_bar_button_group_tablet_large</dimen>
+</resources>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/values/colors.xml b/WordPressEditor/src/main/res/values/colors.xml
old mode 100644
new mode 100755
index 88aade532f93..79f935353f9d
--- a/WordPressEditor/src/main/res/values/colors.xml
+++ b/WordPressEditor/src/main/res/values/colors.xml
@@ -1,8 +1,12 @@
 <?xml version="1.0" encoding="utf-8"?>
 <resources>
-    <color name="white">#FFFFFF</color>
-    <color name="wordpress_blue">#21759B</color>
-    <color name="blue_new_kid">#2EA2CC</color>
-    <color name="grey_extra_light">#eeeeee</color>
-    <color name="pressed_wordpress">#CC78C8E6</color>
+    <color name="legacy_format_bar_button_selected">#00aadc</color>
+    <color name="legacy_placeholder_content_text">#21759B</color>
+    <color name="legacy_format_bar_background">#eeeeee</color>
+    <color name="legacy_pressed_wordpress">#CC78C8E6</color>
+
+    <color name="image_options_label">#cccccc</color>
+
+    <color name="format_bar_button_normal_color">@color/wp_gray</color>
+    <color name="format_bar_button_highlighted_color">@color/wp_blue</color>
 </resources>
diff --git a/WordPressEditor/src/main/res/values/dimens.xml b/WordPressEditor/src/main/res/values/dimens.xml
index e32b17d314b8..e3f7d467b552 100644
--- a/WordPressEditor/src/main/res/values/dimens.xml
+++ b/WordPressEditor/src/main/res/values/dimens.xml
@@ -1,8 +1,27 @@
 <?xml version="1.0" encoding="utf-8"?>
 <resources>
     <dimen name="format_bar_height">40dp</dimen>
-    <dimen name="post_editor_content_side_margin">20dp</dimen>
+    <dimen name="format_bar_left_margin">5dp</dimen>
+    <dimen name="format_bar_right_margin">2dp</dimen>
+    <dimen name="format_bar_button_right_margin">4dp</dimen>
+    <dimen name="format_bar_html_button_left_margin">3dp</dimen>
+
+    <dimen name="format_bar_button_margin_tablet">@dimen/format_bar_button_margin_tablet_small</dimen>
+    <dimen name="format_bar_button_margin_tablet_small">2dp</dimen>
+    <dimen name="format_bar_button_margin_tablet_large">7dp</dimen>
+
+    <dimen name="format_bar_button_group_tablet">@dimen/format_bar_button_group_tablet_small</dimen>
+    <dimen name="format_bar_button_group_tablet_small">20dp</dimen>
+    <dimen name="format_bar_button_group_tablet_large">30dp</dimen>
 
+    <dimen name="format_bar_horizontal_divider_height">1dp</dimen>
+    <dimen name="format_bar_vertical_divider_width">0.6dp</dimen>
+    <dimen name="format_bar_vertical_divider_height">28dp</dimen>
+
+    <dimen name="format_bar_button_highlighted_underline_top">37dp</dimen>
+    <dimen name="format_bar_button_highlighted_underline_width">2dp</dimen>
+
+    <dimen name="post_editor_content_side_margin">20dp</dimen>
 
     <dimen name="margin_extra_small">2dp</dimen>
     <dimen name="margin_small">4dp</dimen>
diff --git a/WordPressEditor/src/main/res/values/layouts.xml b/WordPressEditor/src/main/res/values/layouts.xml
new file mode 100644
index 000000000000..e6121ce4926c
--- /dev/null
+++ b/WordPressEditor/src/main/res/values/layouts.xml
@@ -0,0 +1,4 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <bool name="is_large_tablet_landscape">false</bool>
+</resources>
\ No newline at end of file
diff --git a/WordPressEditor/src/main/res/values/strings.xml b/WordPressEditor/src/main/res/values/strings.xml
index 224fe1376261..cf23160a4174 100644
--- a/WordPressEditor/src/main/res/values/strings.xml
+++ b/WordPressEditor/src/main/res/values/strings.xml
@@ -3,4 +3,29 @@
     <string name="post_settings">Settings</string>
     <string name="post_content">Content</string>
     <string name="post_title">Title</string>
+
+
+
+    <!-- link view -->
+    <string name="link_enter_url">URL</string>
+    <string name="link_enter_url_text">Link text (optional)</string>
+    <string name="create_a_link">Create a link</string>
+
+    <!-- image settings -->
+    <string name="image_settings">Image settings</string>
+    <string name="title">Title</string>
+    <string name="width">Width</string>
+    <string name="featured">Use as featured image</string>
+    <string name="featured_in_post">Include image in post content</string>
+    <string name="image_alignment">Alignment</string>
+    <string name="horizontal_alignment">Horizontal alignment</string>
+    <string name="caption">Caption (optional)</string>
+
+    <string-array name="alignment_array">
+        <item>None</item>
+        <item>Left</item>
+        <item>Center</item>
+        <item>Right</item>
+    </string-array>
+
 </resources>
diff --git a/WordPressEditor/src/main/res/values/styles.xml b/WordPressEditor/src/main/res/values/styles.xml
old mode 100644
new mode 100755
index b319abea3f8f..1bdc104c84d6
--- a/WordPressEditor/src/main/res/values/styles.xml
+++ b/WordPressEditor/src/main/res/values/styles.xml
@@ -6,4 +6,34 @@
         <item name="android:textOn">""</item>
         <item name="android:textOff">""</item>
     </style>
+
+    <style name="FormatBarButton">
+        <item name="android:minWidth">@dimen/format_bar_height</item>
+        <item name="android:minHeight">@dimen/format_bar_height</item>
+        <item name="android:textOn">""</item>
+        <item name="android:textOff">""</item>
+    </style>
+
+    <style name="FormatBarButtonTablet" parent="FormatBarButton">
+        <item name="android:layout_marginRight">@dimen/format_bar_button_margin_tablet</item>
+        <item name="android:layout_marginLeft">@dimen/format_bar_button_margin_tablet</item>
+    </style>
+
+    <style name="FormatBarScrollViewButton" parent="FormatBarButton">
+        <item name="android:layout_marginRight">@dimen/format_bar_button_right_margin</item>
+    </style>
+
+    <style name="FormatBarHtmlButton" parent="FormatBarButton">
+        <item name="android:layout_marginLeft">@dimen/format_bar_html_button_left_margin</item>
+    </style>
+
+    <style name="Divider">
+        <item name="android:background">@color/wp_gray</item>
+        <item name="android:alpha">0.5</item>
+    </style>
+
+    <style name="FormatBarTabletGroup">
+        <item name="android:layout_marginLeft">@dimen/format_bar_button_group_tablet</item>
+        <item name="android:layout_marginRight">@dimen/format_bar_button_group_tablet</item>
+    </style>
 </resources>
diff --git a/WordPressEditor/src/main/res/values/wp_colors.xml b/WordPressEditor/src/main/res/values/wp_colors.xml
new file mode 100644
index 000000000000..acfb9b2b60bc
--- /dev/null
+++ b/WordPressEditor/src/main/res/values/wp_colors.xml
@@ -0,0 +1,5 @@
+<?xml version="1.0" encoding="utf-8"?>
+<resources>
+    <color name="wp_gray">#87a6bc</color>
+    <color name="wp_blue">#0087be</color>
+</resources>
\ No newline at end of file
diff --git a/WordPressEditor/src/androidTest/java/org/wordpress/android/editor/ApplicationTest.java b/WordPressEditor/src/test/java/org/wordpress/android/editor/ApplicationTest.java
similarity index 100%
rename from WordPressEditor/src/androidTest/java/org/wordpress/android/editor/ApplicationTest.java
rename to WordPressEditor/src/test/java/org/wordpress/android/editor/ApplicationTest.java
diff --git a/WordPressEditor/src/test/java/org/wordpress/android/editor/EditorFragmentAbstractTest.java b/WordPressEditor/src/test/java/org/wordpress/android/editor/EditorFragmentAbstractTest.java
new file mode 100644
index 000000000000..53e7a31868cb
--- /dev/null
+++ b/WordPressEditor/src/test/java/org/wordpress/android/editor/EditorFragmentAbstractTest.java
@@ -0,0 +1,77 @@
+package org.wordpress.android.editor;
+
+import android.app.Activity;
+import android.text.Spanned;
+
+import com.android.volley.toolbox.ImageLoader;
+
+import org.junit.Assert;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.robolectric.Robolectric;
+import org.robolectric.RobolectricTestRunner;
+import org.robolectric.annotation.Config;
+import org.wordpress.android.util.helpers.MediaFile;
+import org.wordpress.android.util.helpers.MediaGallery;
+
+@Config(emulateSdk = 18)
+@RunWith(RobolectricTestRunner.class)
+public class EditorFragmentAbstractTest {
+    @Test
+    public void testActivityMustImplementEditorFragmentListener() {
+        // Host Activity must implement EditorFragmentListener, exception expected if not
+        boolean didPassTest = false;
+        Activity hostActivity = Robolectric.buildActivity(Activity.class).create().get();
+        EditorFragmentAbstract testFragment = new DefaultEditorFragment();
+
+        try {
+            testFragment.onAttach(hostActivity);
+        } catch (ClassCastException classCastException) {
+            didPassTest = true;
+        }
+
+        Assert.assertTrue(didPassTest);
+    }
+
+    @Test
+    public void testOnBackPressReturnsFalseByDefault() {
+        // The default behavior of onBackPressed should return false
+        Assert.assertFalse(new DefaultEditorFragment().onBackPressed());
+    }
+
+    /**
+     * Used to test default behavior of non-abstract methods.
+     */
+    public static class DefaultEditorFragment extends EditorFragmentAbstract {
+        @Override
+        public void setTitle(CharSequence text) {
+        }
+
+        @Override
+        public void setContent(CharSequence text) {
+        }
+
+        @Override
+        public CharSequence getTitle() {
+            return null;
+        }
+
+        @Override
+        public CharSequence getContent() {
+            return null;
+        }
+
+        @Override
+        public void appendMediaFile(MediaFile mediaFile, String imageUrl, ImageLoader imageLoader) {
+        }
+
+        @Override
+        public void appendGallery(MediaGallery mediaGallery) {
+        }
+
+        @Override
+        public Spanned getSpannedContent() {
+            return null;
+        }
+    }
+}
diff --git a/WordPressEditor/src/test/java/org/wordpress/android/editor/JsCallbackReceiverTest.java b/WordPressEditor/src/test/java/org/wordpress/android/editor/JsCallbackReceiverTest.java
new file mode 100644
index 000000000000..9181ef6ae5fd
--- /dev/null
+++ b/WordPressEditor/src/test/java/org/wordpress/android/editor/JsCallbackReceiverTest.java
@@ -0,0 +1,99 @@
+package org.wordpress.android.editor;
+
+import android.util.Log;
+
+import org.junit.Before;
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.robolectric.RobolectricTestRunner;
+import org.robolectric.annotation.Config;
+import org.robolectric.shadows.ShadowLog;
+import org.wordpress.android.util.AppLog;
+
+import java.util.List;
+
+import static junit.framework.Assert.assertEquals;
+import static junit.framework.Assert.assertFalse;
+import static org.mockito.Mockito.mock;
+import static org.robolectric.shadows.ShadowLog.LogItem;
+
+@Config(emulateSdk = 18)
+@RunWith(RobolectricTestRunner.class)
+public class JsCallbackReceiverTest {
+    private final static String EDITOR_LOG_TAG = "WordPress-" + AppLog.T.EDITOR.toString();
+
+    private JsCallbackReceiver mJsCallbackReceiver;
+
+    @Before
+    public void setUp() {
+        EditorFragment editorFragment = mock(EditorFragment.class);
+        mJsCallbackReceiver = new JsCallbackReceiver(editorFragment);
+    }
+
+    @Test
+    public void testCallbacksRecognized() {
+        mJsCallbackReceiver.executeCallback("callback-dom-loaded", "");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-new-field", "field-name");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-input", "arguments");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-selection-changed", "arguments");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-selection-style", "arguments");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-focus-in", "");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-focus-out", "");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-image-replaced", "arguments");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-image-tap", "arguments");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-link-tap", "arguments");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-log", "arguments");
+        assertNotLogged("Unhandled callback");
+
+        mJsCallbackReceiver.executeCallback("callback-response-string", "arguments");
+        assertNotLogged("Unhandled callback");
+    }
+
+    @Test
+    public void testUnknownCallbackShouldBeLogged() {
+        mJsCallbackReceiver.executeCallback("callback-does-not-exist", "content");
+        assertLogged(Log.DEBUG, EDITOR_LOG_TAG, "Unhandled callback: callback-does-not-exist:content", null);
+    }
+
+    @Test
+    public void testCallbackLog() {
+        mJsCallbackReceiver.executeCallback("callback-log", "msg=test-message");
+        assertLogged(Log.DEBUG, EDITOR_LOG_TAG, "callback-log: test-message", null);
+    }
+
+    private void assertLogged(int type, String tag, String msg, Throwable throwable) {
+        LogItem lastLog = ShadowLog.getLogs().get(0);
+        assertEquals(type, lastLog.type);
+        assertEquals(msg, lastLog.msg);
+        assertEquals(tag, lastLog.tag);
+        assertEquals(throwable, lastLog.throwable);
+    }
+
+    private void assertNotLogged(String msg) {
+        List<LogItem> logList = ShadowLog.getLogs();
+        if (!logList.isEmpty()) {
+            assertFalse(logList.get(0).msg.contains(msg));
+            ShadowLog.reset();
+        }
+    }
+}
diff --git a/WordPressEditor/src/test/java/org/wordpress/android/editor/UtilsTest.java b/WordPressEditor/src/test/java/org/wordpress/android/editor/UtilsTest.java
new file mode 100644
index 000000000000..3b8a15e08e81
--- /dev/null
+++ b/WordPressEditor/src/test/java/org/wordpress/android/editor/UtilsTest.java
@@ -0,0 +1,124 @@
+package org.wordpress.android.editor;
+
+import org.junit.Test;
+import org.junit.runner.RunWith;
+import org.robolectric.RobolectricTestRunner;
+import org.robolectric.annotation.Config;
+
+import java.util.Collections;
+import java.util.HashMap;
+import java.util.HashSet;
+import java.util.Map;
+import java.util.Set;
+
+import static org.junit.Assert.assertEquals;
+import static org.wordpress.android.editor.Utils.buildMapFromKeyValuePairs;
+import static org.wordpress.android.editor.Utils.escapeHtml;
+import static org.wordpress.android.editor.Utils.getChangeMapFromSets;
+import static org.wordpress.android.editor.Utils.splitDelimitedString;
+
+@Config(emulateSdk = 18)
+@RunWith(RobolectricTestRunner.class)
+public class UtilsTest {
+
+    @Test
+    public void testEscapeHtml() {
+        // Test null
+        assertEquals(null, escapeHtml(null));
+    }
+
+    @Test
+    public void testSplitDelimitedString() {
+        Set<String> splitString = new HashSet<>();
+
+        // Test normal usage
+        splitString.add("p");
+        splitString.add("bold");
+        splitString.add("justifyLeft");
+
+        assertEquals(splitString, splitDelimitedString("p~bold~justifyLeft", "~"));
+
+        // Test empty string
+        assertEquals(Collections.emptySet(), splitDelimitedString("", "~"));
+    }
+
+    @Test
+    public void testBuildMapFromKeyValuePairs() {
+        Set<String> keyValueSet = new HashSet<>();
+        Map<String, String> expectedMap = new HashMap<>();
+
+        // Test normal usage
+        keyValueSet.add("id=test");
+        keyValueSet.add("name=example");
+
+        expectedMap.put("id", "test");
+        expectedMap.put("name", "example");
+
+        assertEquals(expectedMap, buildMapFromKeyValuePairs(keyValueSet));
+
+        // Test mixed valid and invalid entries
+        keyValueSet.clear();
+        keyValueSet.add("test");
+        keyValueSet.add("name=example");
+
+        expectedMap.clear();
+        expectedMap.put("name", "example");
+
+        assertEquals(expectedMap, buildMapFromKeyValuePairs(keyValueSet));
+
+        // Test multiple '=' (should split at the first `=` and treat the rest of them as part of the string)
+        keyValueSet.clear();
+        keyValueSet.add("id=test");
+        keyValueSet.add("contents=some text\n<a href=\"http://wordpress.com\">WordPress</a>");
+
+        expectedMap.clear();
+        expectedMap.put("id", "test");
+        expectedMap.put("contents", "some text\n<a href=\"http://wordpress.com\">WordPress</a>");
+
+        assertEquals(expectedMap, buildMapFromKeyValuePairs(keyValueSet));
+
+        // Test invalid entry
+        keyValueSet.clear();
+        keyValueSet.add("test");
+
+        assertEquals(Collections.emptyMap(), buildMapFromKeyValuePairs(keyValueSet));
+
+        // Test empty sets
+        assertEquals(Collections.emptyMap(), buildMapFromKeyValuePairs(Collections.<String>emptySet()));
+    }
+
+    @Test
+    public void testGetChangeMapFromSets() {
+        Set<String> oldSet = new HashSet<>();
+        Set<String> newSet = new HashSet<>();
+        Map<String, Boolean> expectedMap = new HashMap<>();
+
+        // Test normal usage
+        oldSet.add("p");
+        oldSet.add("bold");
+        oldSet.add("justifyLeft");
+
+        newSet.add("p");
+        newSet.add("justifyRight");
+
+        expectedMap.put("bold", false);
+        expectedMap.put("justifyLeft", false);
+        expectedMap.put("justifyRight", true);
+
+        assertEquals(expectedMap, getChangeMapFromSets(oldSet, newSet));
+
+        // Test no changes
+        oldSet.clear();
+        oldSet.add("p");
+        oldSet.add("bold");
+
+        newSet.clear();
+        newSet.add("p");
+        newSet.add("bold");
+
+        assertEquals(Collections.emptyMap(), getChangeMapFromSets(oldSet, newSet));
+
+        // Test empty sets
+        assertEquals(Collections.emptyMap(), getChangeMapFromSets(Collections.emptySet(), Collections.emptySet()));
+    }
+}
diff --git a/example/build.gradle b/example/build.gradle
index a4717d961f44..1e1bd0cf95fa 100644
--- a/example/build.gradle
+++ b/example/build.gradle
@@ -3,7 +3,7 @@ buildscript {
         mavenCentral()
     }
     dependencies {
-        classpath 'com.android.tools.build:gradle:1.0.0'
+        classpath 'com.android.tools.build:gradle:1.2.3'
     }
 }
 
@@ -15,12 +15,12 @@ apply plugin: 'com.android.application'
 
 android {
     compileSdkVersion 21
-    buildToolsVersion "21.1.1"
+    buildToolsVersion "22.0.1"
 
     defaultConfig {
         applicationId "org.wordpress.editorexample"
         minSdkVersion 14
-        targetSdkVersion 21
+        targetSdkVersion 22
         versionCode 1
         versionName "1.0"
     }
diff --git a/example/src/main/AndroidManifest.xml b/example/src/main/AndroidManifest.xml
index dd5e8252a5e7..e0a9b12aa13d 100644
--- a/example/src/main/AndroidManifest.xml
+++ b/example/src/main/AndroidManifest.xml
@@ -9,7 +9,11 @@
         android:theme="@style/AppTheme" >
         <activity
             android:name=".MainExampleActivity"
-            android:label="@string/title_activity_example" >
+            android:label="@string/title_activity_example">
+            <intent-filter>
+                <action android:name="android.intent.action.MAIN" />
+                <category android:name="android.intent.category.LAUNCHER" />
+            </intent-filter>
         </activity>
         <activity
             android:name=".EditorExampleActivity" >
diff --git a/example/src/main/java/org/wordpress/example/EditorExampleActivity.java b/example/src/main/java/org/wordpress/example/EditorExampleActivity.java
index 99951537840f..1497edd3a12e 100644
--- a/example/src/main/java/org/wordpress/example/EditorExampleActivity.java
+++ b/example/src/main/java/org/wordpress/example/EditorExampleActivity.java
@@ -1,20 +1,29 @@
 package org.wordpress.android.editor.example;
 
+import android.app.Fragment;
+import android.app.FragmentManager;
 import android.os.Bundle;
 import android.support.v7.app.ActionBarActivity;
 
+import org.wordpress.android.editor.EditorFragmentAbstract;
 import org.wordpress.android.editor.EditorFragmentAbstract.EditorFragmentListener;
 import org.wordpress.android.util.ToastUtils;
+import org.wordpress.android.util.helpers.MediaFile;
 
 public class EditorExampleActivity extends ActionBarActivity implements EditorFragmentListener {
-    public static final String EDITOR_CHOICE = "EDITOR_CHOICE";
+    public static final String EDITOR_PARAM = "EDITOR_PARAM";
+    public static final String TITLE_PARAM = "TITLE_PARAM";
+    public static final String CONTENT_PARAM = "CONTENT_PARAM";
+    public static final String DRAFT_PARAM = "DRAFT_PARAM";
     public static final int USE_NEW_EDITOR = 1;
     public static final int USE_LEGACY_EDITOR = 2;
 
+    private EditorFragmentAbstract mEditorFragment;
+
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
-        if (getIntent().getIntExtra(EDITOR_CHOICE, USE_NEW_EDITOR) == USE_NEW_EDITOR) {
+        if (getIntent().getIntExtra(EDITOR_PARAM, USE_NEW_EDITOR) == USE_NEW_EDITOR) {
             ToastUtils.showToast(this, R.string.starting_new_editor);
             setContentView(R.layout.activity_new_editor);
         } else {
@@ -23,13 +32,41 @@ protected void onCreate(Bundle savedInstanceState) {
         }
     }
 
+    @Override
+    public void onAttachFragment(Fragment fragment) {
+        super.onAttachFragment(fragment);
+        if (fragment instanceof EditorFragmentAbstract) {
+            mEditorFragment = (EditorFragmentAbstract) fragment;
+        }
+    }
+
     @Override
     public void onSettingsClicked() {
         // TODO
     }
 
     @Override
-    public void onAddMediaButtonClicked() {
+    public void onAddMediaClicked() {
+        // TODO
+    }
+
+    @Override
+    public void onEditorFragmentInitialized() {
+        // arbitrary setup
+        mEditorFragment.setFeaturedImageSupported(true);
+        mEditorFragment.setBlogSettingMaxImageWidth("600");
+
+        // get title and content and draft switch
+        String title = getIntent().getStringExtra(TITLE_PARAM);
+        String content = getIntent().getStringExtra(CONTENT_PARAM);
+        boolean isLocalDraft = getIntent().getBooleanExtra(DRAFT_PARAM, true);
+        mEditorFragment.setTitle(title);
+        mEditorFragment.setContent(content);
+        mEditorFragment.setLocalDraft(isLocalDraft);
+    }
+
+    @Override
+    public void saveMediaFile(MediaFile mediaFile) {
         // TODO
     }
 }
diff --git a/example/src/main/java/org/wordpress/example/MainExampleActivity.java b/example/src/main/java/org/wordpress/example/MainExampleActivity.java
index 91910822e02d..7f432ea11e73 100644
--- a/example/src/main/java/org/wordpress/example/MainExampleActivity.java
+++ b/example/src/main/java/org/wordpress/example/MainExampleActivity.java
@@ -1,5 +1,6 @@
 package org.wordpress.android.editor.example;
 
+import android.app.Activity;
 import android.content.Intent;
 import android.os.Bundle;
 import android.support.v7.app.ActionBarActivity;
@@ -7,12 +8,16 @@
 import android.view.View.OnClickListener;
 import android.widget.Button;
 
+import org.wordpress.android.editor.Utils;
 import org.wordpress.android.editor.example.EditorExampleActivity;
 
 public class MainExampleActivity extends ActionBarActivity {
+    private Activity mActivity;
+
     @Override
     protected void onCreate(Bundle savedInstanceState) {
         super.onCreate(savedInstanceState);
+        mActivity = this;
         setContentView(R.layout.activity_example);
 
         Button newEditorPost1 = (Button) findViewById(R.id.new_editor_post_1);
@@ -20,18 +25,38 @@ protected void onCreate(Bundle savedInstanceState) {
             @Override public void onClick(View v) {
                 Intent intent = new Intent(MainExampleActivity.this, EditorExampleActivity.class);
                 Bundle bundle = new Bundle();
-                bundle.putInt(EditorExampleActivity.EDITOR_CHOICE, EditorExampleActivity.USE_NEW_EDITOR);
+                bundle.putString(EditorExampleActivity.TITLE_PARAM, getString(R.string.example_post_visual_title));
+                bundle.putString(EditorExampleActivity.CONTENT_PARAM, Utils.getHtmlFromFile(mActivity,
+                        "example-content.html"));
+                bundle.putInt(EditorExampleActivity.EDITOR_PARAM, EditorExampleActivity.USE_NEW_EDITOR);
+                intent.putExtras(bundle);
+                startActivity(intent);
+            }
+        });
+
+        Button legacyEditorPost1Local = (Button) findViewById(R.id.legacy_editor_post_1_local);
+        legacyEditorPost1Local.setOnClickListener(new OnClickListener() {
+            @Override public void onClick(View v) {
+                Intent intent = new Intent(MainExampleActivity.this, EditorExampleActivity.class);
+                Bundle bundle = new Bundle();
+                bundle.putString(EditorExampleActivity.TITLE_PARAM, getString(R.string.example_post_1_title));
+                bundle.putString(EditorExampleActivity.CONTENT_PARAM, getString(R.string.example_post_1_content));
+                bundle.putInt(EditorExampleActivity.EDITOR_PARAM, EditorExampleActivity.USE_LEGACY_EDITOR);
+                bundle.putBoolean(EditorExampleActivity.DRAFT_PARAM, true);
                 intent.putExtras(bundle);
                 startActivity(intent);
             }
         });
 
-        Button legacyEditorPost1 = (Button) findViewById(R.id.legacy_editor_post_1);
-        legacyEditorPost1.setOnClickListener(new OnClickListener() {
+        Button legacyEditorPost1Remote = (Button) findViewById(R.id.legacy_editor_post_1_remote);
+        legacyEditorPost1Remote.setOnClickListener(new OnClickListener() {
             @Override public void onClick(View v) {
                 Intent intent = new Intent(MainExampleActivity.this, EditorExampleActivity.class);
                 Bundle bundle = new Bundle();
-                bundle.putInt(EditorExampleActivity.EDITOR_CHOICE, EditorExampleActivity.USE_LEGACY_EDITOR);
+                bundle.putString(EditorExampleActivity.TITLE_PARAM, getString(R.string.example_post_1_title));
+                bundle.putString(EditorExampleActivity.CONTENT_PARAM, getString(R.string.example_post_1_content));
+                bundle.putInt(EditorExampleActivity.EDITOR_PARAM, EditorExampleActivity.USE_LEGACY_EDITOR);
+                bundle.putBoolean(EditorExampleActivity.DRAFT_PARAM, false);
                 intent.putExtras(bundle);
                 startActivity(intent);
             }
diff --git a/example/src/main/res/layout/activity_example.xml b/example/src/main/res/layout/activity_example.xml
index 9be001d0e6b2..44d2bcd187ad 100644
--- a/example/src/main/res/layout/activity_example.xml
+++ b/example/src/main/res/layout/activity_example.xml
@@ -16,10 +16,20 @@
     <Button
         android:layout_width="wrap_content"
         android:layout_height="wrap_content"
-        android:text="Legacy Editor - Post 1"
-        android:id="@+id/legacy_editor_post_1"
+        android:text="Legacy Editor - Post 1 - Local Draft"
+        android:id="@+id/legacy_editor_post_1_local"
         android:layout_marginTop="32dp"
         android:layout_centerHorizontal="true"
         android:layout_below="@id/new_editor_post_1"/>
 
+    <Button
+        android:layout_width="wrap_content"
+        android:layout_height="wrap_content"
+        android:text="Legacy Editor - Post 1 - Remote"
+        android:id="@+id/legacy_editor_post_1_remote"
+        android:layout_marginTop="32dp"
+        android:layout_centerHorizontal="true"
+        android:layout_below="@id/legacy_editor_post_1_local"/>
+
+
 </RelativeLayout>
diff --git a/example/src/main/res/layout/activity_legacy_editor.xml b/example/src/main/res/layout/activity_legacy_editor.xml
index 478e491e5cae..24756188d2c9 100644
--- a/example/src/main/res/layout/activity_legacy_editor.xml
+++ b/example/src/main/res/layout/activity_legacy_editor.xml
@@ -6,7 +6,7 @@
 
     <fragment
         android:id="@+id/postEditor"
-        android:name="org.wordpress.android.editor.EditorFragment"
+        android:name="org.wordpress.android.editor.LegacyEditorFragment"
         android:layout_width="match_parent"
         android:layout_height="match_parent"/>
 
diff --git a/example/src/main/res/values/strings.xml b/example/src/main/res/values/strings.xml
index e42f7ddf3faa..91f0440a703d 100644
--- a/example/src/main/res/values/strings.xml
+++ b/example/src/main/res/values/strings.xml
@@ -1,6 +1,13 @@
 <resources>
-    <string name="app_name">EditorExample</string>
-    <string name="title_activity_example">ExampleActivity</string>
+    <string name="app_name">Editor Example</string>
+    <string name="title_activity_example">Editor Example</string>
     <string name="starting_legacy_editor">Starting legacy editor</string>
     <string name="starting_new_editor">Starting new editor</string>
+    <string name="example_post_visual_title">I\'m editing a post!</string>
+    <string name="example_post_1_title">Post 1</string>
+    <string name="example_post_1_content">Post 1 Content:\nBest post ever!</string>
+    <string name="example_post_2_title">Post 2</string>
+    <string name="example_post_2_content">
+        <![CDATA[<p>Post 2 Content</p><blockquote>Quoted text</blockquote><br/>]]>
+    </string>
 </resources>
diff --git a/libs/editor-common/assets/ZSSRichTextEditor.js b/libs/editor-common/assets/ZSSRichTextEditor.js
old mode 100644
new mode 100755
index 052c44f8f622..61684103ef5f
--- a/libs/editor-common/assets/ZSSRichTextEditor.js
+++ b/libs/editor-common/assets/ZSSRichTextEditor.js
@@ -8,11 +8,26 @@
  */
 
 // If we are using iOS or desktop
-var isUsingiOS = true;
+var isUsingiOS = false;
+var isUsingAndroid = true;
 
 // THe default callback parameter separator
 var defaultCallbackSeparator = '~';
 
+const NodeName = {
+    BLOCKQUOTE: "BLOCKQUOTE",
+    PARAGRAPH: "P",
+    STRONG: "STRONG",
+    DEL: "DEL",
+    EM: "EM",
+    A: "A",
+    OL: "OL",
+    UL: "UL",
+    LI: "LI",
+    CODE: "CODE",
+    SPAN: "SPAN"
+};
+
 // The editor object
 var ZSSEditor = {};
 
@@ -50,7 +65,9 @@ ZSSEditor.defaultParagraphSeparator = 'p';
  * The initializer function that must be called onLoad
  */
 ZSSEditor.init = function() {
-    
+
+    rangy.init();
+
     // Change a few CSS values if the device is an iPad
     ZSSEditor.isiPad = (navigator.userAgent.match(/iPad/i) != null);
     if (ZSSEditor.isiPad) {
@@ -58,18 +75,18 @@ ZSSEditor.init = function() {
         $('#zss_field_title').addClass('ipad_field_title');
         $('#zss_field_content').addClass('ipad_field_content');
     }
-    
+
     document.execCommand('insertBrOnReturn', false, false);
     document.execCommand('defaultParagraphSeparator', false, this.defaultParagraphSeparator);
-    
+
     var editor = $('div.field').each(function() {
         var editableField = new ZSSField($(this));
         var editableFieldId = editableField.getNodeId();
-                                             
+
         ZSSEditor.editableFields[editableFieldId] = editableField;
         ZSSEditor.callback("callback-new-field", "id=" + editableFieldId);
     });
-    
+
 	document.addEventListener("selectionchange", function(e) {
 		ZSSEditor.currentEditingLink = null;
 		// DRM: only do something here if the editor has focus.  The reason is that when the
@@ -93,16 +110,16 @@ ZSSEditor.init = function() {
 ZSSEditor.logMainElementSizes = function() {
     msg = 'Window [w:' + $(window).width() + '|h:' + $(window).height() + ']';
     this.log(msg);
-    
+
     var msg = encodeURIComponent('Viewport [w:' + window.innerWidth + '|h:' + window.innerHeight + ']');
     this.log(msg);
-    
+
     msg = encodeURIComponent('Body [w:' + $(document.body).width() + '|h:' + $(document.body).height() + ']');
     this.log(msg);
-    
+
     msg = encodeURIComponent('HTML [w:' + $('html').width() + '|h:' + $('html').height() + ']');
     this.log(msg);
-    
+
     msg = encodeURIComponent('Document [w:' + $(document).width() + '|h:' + $(document).height() + ']');
     this.log(msg);
 };
@@ -120,8 +137,31 @@ ZSSEditor.focusFirstEditableField = function() {
     $('div[contenteditable=true]:first').focus();
 };
 
+ZSSEditor.formatNewLine = function(e) {
+
+    var currentField = this.getFocusedField();
+
+    if (currentField.isMultiline()) {
+        var parentBlockQuoteNode = ZSSEditor.closerParentNodeWithName('blockquote');
+
+        if (parentBlockQuoteNode) {
+            this.formatNewLineInsideBlockquote(e);
+        } else if (!ZSSEditor.isCommandEnabled('insertOrderedList')
+                   && !ZSSEditor.isCommandEnabled('insertUnorderedList')) {
+            document.execCommand('formatBlock', false, 'p');
+        }
+    } else {
+        e.preventDefault();
+    }
+};
+
+ZSSEditor.formatNewLineInsideBlockquote = function(e) {
+    this.insertBreakTagAtCaretPosition();
+    e.preventDefault();
+};
+
 ZSSEditor.getField = function(fieldId) {
-    
+
     var field = this.editableFields[fieldId];
 
     return field;
@@ -130,14 +170,14 @@ ZSSEditor.getField = function(fieldId) {
 ZSSEditor.getFocusedField = function() {
     var currentField = $(this.closerParentNodeWithName('div'));
     var currentFieldId = currentField.attr('id');
-    
+
     while (currentField
            && (!currentFieldId || this.editableFields[currentFieldId] == null)) {
         currentField = this.closerParentNodeStartingAtNode('div', currentField);
         currentFieldId = currentField.attr('id');
-        
+
     }
-    
+
     return this.editableFields[currentFieldId];
 };
 
@@ -150,28 +190,30 @@ ZSSEditor.log = function(msg) {
 // MARK: - Callbacks
 
 ZSSEditor.domLoadedCallback = function() {
-	
+
 	ZSSEditor.callback("callback-dom-loaded");
 };
 
 ZSSEditor.selectionChangedCallback = function () {
-    
+
     var joinedArguments = ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();
-    
+
     ZSSEditor.callback('callback-selection-changed', joinedArguments);
     this.callback("callback-input", joinedArguments);
 };
 
 ZSSEditor.callback = function(callbackScheme, callbackPath) {
-    
+
 	var url =  callbackScheme + ":";
- 
+
 	if (callbackPath) {
 		url = url + callbackPath;
 	}
-	
+
 	if (isUsingiOS) {
         ZSSEditor.callbackThroughIFrame(url);
+    } else if (isUsingAndroid) {
+        nativeCallbackHandler.executeCallback(callbackScheme, callbackPath);
 	} else {
 		console.log(url);
 	}
@@ -189,14 +231,14 @@ ZSSEditor.callback = function(callbackScheme, callbackPath) {
 ZSSEditor.callbackThroughIFrame = function(url) {
     var iframe = document.createElement("IFRAME");
     iframe.setAttribute("src", url);
-    
+
     // IMPORTANT: the IFrame was showing up as a black box below our text.  By setting its borders
     // to be 0px transparent we make sure it's not shown at all.
     //
     // REF BUG: https://github.com/wordpress-mobile/WordPress-iOS-Editor/issues/318
     //
     iframe.style.cssText = "border: 0px transparent;";
-    
+
     document.documentElement.appendChild(iframe);
     iframe.parentNode.removeChild(iframe);
     iframe = null;
@@ -205,7 +247,7 @@ ZSSEditor.callbackThroughIFrame = function(url) {
 ZSSEditor.stylesCallback = function(stylesArray) {
 
 	var stylesString = '';
-	
+
 	if (stylesArray.length > 0) {
 		stylesString = stylesArray.join(defaultCallbackSeparator);
 	}
@@ -218,7 +260,7 @@ ZSSEditor.stylesCallback = function(stylesArray) {
 ZSSEditor.backupRange = function(){
 	var selection = window.getSelection();
     var range = selection.getRangeAt(0);
-    
+
     ZSSEditor.currentSelection =
     {
         "startContainer": range.startContainer,
@@ -232,7 +274,7 @@ ZSSEditor.restoreRange = function(){
     if (this.currentSelection) {
         var selection = window.getSelection();
         selection.removeAllRanges();
-        
+
         var range = document.createRange();
         range.setStart(this.currentSelection.startContainer, this.currentSelection.startOffset);
         range.setEnd(this.currentSelection.endContainer, this.currentSelection.endOffset);
@@ -242,87 +284,112 @@ ZSSEditor.restoreRange = function(){
 
 ZSSEditor.getSelectedText = function() {
 	var selection = window.getSelection();
-	
+
 	return selection.toString();
 };
 
 ZSSEditor.getCaretArguments = function() {
     var caretInfo = this.getYCaretInfo();
-    
-    this.caretArguments[0] = 'yOffset=' + caretInfo.y;
-    this.caretArguments[1] = 'height=' + caretInfo.height;
-    
-    return this.caretArguments;
+
+    if (caretInfo == null) {
+        return null;
+    } else {
+        this.caretArguments[0] = 'yOffset=' + caretInfo.y;
+        this.caretArguments[1] = 'height=' + caretInfo.height;
+        return this.caretArguments;
+    }
 };
 
 ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments = function() {
-    
+
     var joinedArguments = ZSSEditor.getJoinedCaretArguments();
     var idArgument = "id=" + ZSSEditor.getFocusedField().getNodeId();
-    
+
     joinedArguments = idArgument + defaultCallbackSeparator + joinedArguments;
-    
+
     return joinedArguments;
 };
 
 ZSSEditor.getJoinedCaretArguments = function() {
-    
+
     var caretArguments = this.getCaretArguments();
     var joinedArguments = this.caretArguments.join(defaultCallbackSeparator);
-    
+
     return joinedArguments;
 };
 
+ZSSEditor.getCaretYPosition = function() {
+    var selection = window.getSelection();
+    var range = selection.getRangeAt(0);
+    var span = document.createElement("span");
+    // Ensure span has dimensions and position by
+    // adding a zero-width space character
+    span.appendChild( document.createTextNode("\u200b") );
+    range.insertNode(span);
+    var y = span.offsetTop;
+    var spanParent = span.parentNode;
+    spanParent.removeChild(span);
+
+    // Glue any broken text nodes back together
+    spanParent.normalize();
+
+    return y;
+}
+
 ZSSEditor.getYCaretInfo = function() {
-    var y = 0, height = 0;
-    var sel = window.getSelection();
-    if (sel.rangeCount) {
-        
-        var range = sel.getRangeAt(0);
-        var needsToWorkAroundNewlineBug = (range.startOffset == 0 || range.getClientRects().length == 0);
-        
-        // PROBLEM: iOS seems to have problems getting the offset for some empty nodes and return
-        // 0 (zero) as the selection range top offset.
-        //
-        // WORKAROUND: To fix this problem we just get the node's offset instead.
-        //
-        if (needsToWorkAroundNewlineBug) {
-            var closerParentNode = ZSSEditor.closerParentNode();
-            var closerDiv = ZSSEditor.closerParentNodeWithName('div');
-            
-            var fontSize = $(closerParentNode).css('font-size');
-            var lineHeight = Math.floor(parseInt(fontSize.replace('px','')) * 1.5);
-            
-            y = closerParentNode.offsetTop;
-            height = lineHeight;
-        } else {
-            if (range.getClientRects) {
-                var rects = range.getClientRects();
-                if (rects.length > 0) {
-                    // PROBLEM: some iOS versions differ in what is returned by getClientRects()
-                    // Some versions return the offset from the page's top, some other return the
-                    // offset from the visible viewport's top.
-                    //
-                    // WORKAROUND: see if the offset of the body's top is ever negative.  If it is
-                    // then it means that the offset we have is relative to the body's top, and we
-                    // should add the scroll offset.
-                    //
-                    var addsScrollOffset = document.body.getClientRects()[0].top < 0;
-                    
-                    if (addsScrollOffset) {
-                        y = document.body.scrollTop;
-                    }
-                    
-                    y += rects[0].top;
-                    height = rects[0].height;
+    var selection = window.getSelection();
+    var noSelectionAvailable = selection.rangeCount == 0;
+
+    if (noSelectionAvailable) {
+        return null;
+    }
+
+    var y = 0;
+    var height = 0;
+    var range = selection.getRangeAt(0);
+    var needsToWorkAroundNewlineBug = (range.getClientRects().length == 0);
+
+    // PROBLEM: iOS seems to have problems getting the offset for some empty nodes and return
+    // 0 (zero) as the selection range top offset.
+    //
+    // WORKAROUND: To fix this problem we use a different method to obtain the Y position instead.
+    //
+    if (needsToWorkAroundNewlineBug) {
+        var closerParentNode = ZSSEditor.closerParentNode();
+        var closerDiv = ZSSEditor.closerParentNodeWithName('div');
+
+        var fontSize = $(closerParentNode).css('font-size');
+        var lineHeight = Math.floor(parseInt(fontSize.replace('px','')) * 1.5);
+
+        y = this.getCaretYPosition();
+        height = lineHeight;
+    } else {
+        if (range.getClientRects) {
+            var rects = range.getClientRects();
+            if (rects.length > 0) {
+                // PROBLEM: some iOS versions differ in what is returned by getClientRects()
+                // Some versions return the offset from the page's top, some other return the
+                // offset from the visible viewport's top.
+                //
+                // WORKAROUND: see if the offset of the body's top is ever negative.  If it is
+                // then it means that the offset we have is relative to the body's top, and we
+                // should add the scroll offset.
+                //
+                var addsScrollOffset = document.body.getClientRects()[0].top < 0;
+
+                if (addsScrollOffset) {
+                    y = document.body.scrollTop;
                 }
+
+                y += rects[0].top;
+                height = rects[0].height;
             }
         }
     }
-    
+
     this.caretInfo.y = y;
     this.caretInfo.height = height;
-    
+
     return this.caretInfo;
 };
 
@@ -357,48 +424,48 @@ ZSSEditor.setSuperscript = function() {
 ZSSEditor.setStrikeThrough = function() {
 	var commandName = 'strikeThrough';
 	var isDisablingStrikeThrough = ZSSEditor.isCommandEnabled(commandName);
-	
+
 	document.execCommand(commandName, false, null);
-	
+
 	// DRM: WebKit has a problem disabling strikeThrough when the tag <del> is used instead of
 	// <strike>.  The code below serves as a way to fix this issue.
 	//
 	var mustHandleWebKitIssue = (isDisablingStrikeThrough
 								 && ZSSEditor.isCommandEnabled(commandName));
-	
+
 	if (mustHandleWebKitIssue) {
 		var troublesomeNodeNames = ['del'];
-		
+
 		var selection = window.getSelection();
 		var range = selection.getRangeAt(0).cloneRange();
-		
+
 		var container = range.commonAncestorContainer;
 		var nodeFound = false;
 		var textNode = null;
-		
+
 		while (container && !nodeFound) {
 			nodeFound = (container
 						 && container.nodeType == document.ELEMENT_NODE
 						 && troublesomeNodeNames.indexOf(container.nodeName.toLowerCase()) > -1);
-			
+
 			if (!nodeFound) {
 				container = container.parentElement;
 			}
 		}
-		
+
 		if (container) {
 			var newObject = $(container).replaceWith(container.innerHTML);
-			
+
 			var finalSelection = window.getSelection();
 			var finalRange = selection.getRangeAt(0).cloneRange();
-			
+
 			finalRange.setEnd(finalRange.startContainer, finalRange.startOffset + 1);
-			
+
 			selection.removeAllRanges();
 			selection.addRange(finalRange);
 		}
 	}
-	
+
 	ZSSEditor.sendEnabledStyles();
 };
 
@@ -407,17 +474,36 @@ ZSSEditor.setUnderline = function() {
 	ZSSEditor.sendEnabledStyles();
 };
 
+/**
+ *  @brief      Turns blockquote ON or OFF for the current selection.
+ *  @details    This method makes sure that the contents of the blockquotes are surrounded by the
+ *              defaultParagraphSeparatorTag (by default '<p>').  This ensures parity with the web
+ *              editor.
+ */
 ZSSEditor.setBlockquote = function() {
-	var formatTag = "blockquote";
-	var formatBlock = document.queryCommandValue('formatBlock');
-	 
-	if (formatBlock.length > 0 && formatBlock.toLowerCase() == formatTag) {
-        document.execCommand('formatBlock', false, this.defaultParagraphSeparatorTag());
-	} else {
-		document.execCommand('formatBlock', false, '<' + formatTag + '>');
-	}
 
-	 ZSSEditor.sendEnabledStyles();
+    var savedSelection = rangy.saveSelection();
+    var selection = document.getSelection();
+    var range = selection.getRangeAt(0).cloneRange();
+    var sendStyles = false;
+
+    var ancestorElement = this.getAncestorElementForSettingBlockquote(range);
+
+    if (ancestorElement) {
+        sendStyles = true;
+
+        var childNodes = this.getChildNodesIntersectingRange(ancestorElement, range);
+
+        if (childNodes && childNodes.length) {
+            this.toggleBlockquoteForSpecificChildNodes(ancestorElement, childNodes);
+        }
+    }
+
+    rangy.restoreSelection(savedSelection);
+
+    if (sendStyles) {
+        ZSSEditor.sendEnabledStyles();
+    }
 };
 
 ZSSEditor.removeFormating = function() {
@@ -433,26 +519,26 @@ ZSSEditor.setHorizontalRule = function() {
 ZSSEditor.setHeading = function(heading) {
 	var formatTag = heading;
 	var formatBlock = document.queryCommandValue('formatBlock');
-	
+
 	if (formatBlock.length > 0 && formatBlock.toLowerCase() == formatTag) {
 		document.execCommand('formatBlock', false, this.defaultParagraphSeparatorTag());
 	} else {
 		document.execCommand('formatBlock', false, '<' + formatTag + '>');
 	}
-	
+
 	ZSSEditor.sendEnabledStyles();
 };
 
 ZSSEditor.setParagraph = function() {
 	var formatTag = "p";
 	var formatBlock = document.queryCommandValue('formatBlock');
-	
+
 	if (formatBlock.length > 0 && formatBlock.toLowerCase() == formatTag) {
 		document.execCommand('formatBlock', false, this.defaultParagraphSeparatorTag());
 	} else {
 		document.execCommand('formatBlock', false, '<' + formatTag + '>');
 	}
-	
+
 	ZSSEditor.sendEnabledStyles();
 };
 
@@ -528,13 +614,13 @@ ZSSEditor.setBackgroundColor = function(color) {
 ZSSEditor.insertLink = function(url, title) {
 
     ZSSEditor.restoreRange();
-	
+
     var sel = document.getSelection();
 	if (sel.rangeCount) {
 
 		var el = document.createElement("a");
 		el.setAttribute("href", url);
-		
+
 		var range = sel.getRangeAt(0).cloneRange();
 		range.surroundContents(el);
 		el.innerHTML = title;
@@ -546,11 +632,11 @@ ZSSEditor.insertLink = function(url, title) {
 };
 
 ZSSEditor.updateLink = function(url, title) {
-	
+
     ZSSEditor.restoreRange();
-	
+
     var currentLinkNode = ZSSEditor.lastTappedNode;
-	
+
     if (currentLinkNode) {
 		currentLinkNode.setAttribute("href", url);
 		currentLinkNode.innerHTML = title;
@@ -559,22 +645,25 @@ ZSSEditor.updateLink = function(url, title) {
 };
 
 ZSSEditor.unlink = function() {
-	
+	var savedSelection = rangy.saveSelection();
+
 	var currentLinkNode = ZSSEditor.closerParentNodeWithName('a');
-	
+
 	if (currentLinkNode) {
 		ZSSEditor.unwrapNode(currentLinkNode);
 	}
-	
+
+    rangy.restoreSelection(savedSelection);
+
 	ZSSEditor.sendEnabledStyles();
 };
 
 ZSSEditor.unwrapNode = function(node) {
-	var newObject = $(node).replaceWith(node.innerHTML);
+    $(node).contents().unwrap();
 };
 
 ZSSEditor.quickLink = function() {
-	
+
 	var sel = document.getSelection();
 	var link_url = "";
 	var test = new String(sel);
@@ -604,6 +693,96 @@ ZSSEditor.quickLink = function() {
 	ZSSEditor.insertHTML(html_code);
 };
 
+// MARK: - Blockquotes
+
+/**
+ *  @brief      This method toggles blockquote for the specified child nodes.  This is useful since
+ *              we can toggle blockquote either for some or ALL of the child nodes, depending on
+ *              what we need to achieve.
+ *  @details    CASE 1: If the parent node is a blockquote node, the child nodes will be extracted
+ *              from it leaving the remaining siblings untouched (by splitting the parent blockquote
+ *              node in two if necessary).
+ *              CASE 2: If the parent node is NOT a blockquote node, but the first child is, the
+ *              method will make sure all child nodes that are blockquote nodes will be toggled to
+ *              non-blockquote nodes.
+ *              CASE 3: If both the parent node and the first node are non-blockquote nodes, this
+ *              method will turn all child nodes into blockquote nodes.
+ *
+ *  @param      parentNode      The parent node.  Can be either a blockquote or non-blockquote node.
+ *                              Cannot be null.
+ *  @param      nodes           The child nodes.  Can be any combination of blockquote and
+ *                              non-blockquote nodes.  Cannot be null.
+ */
+ZSSEditor.toggleBlockquoteForSpecificChildNodes = function(parentNode, nodes) {
+
+    if (nodes && nodes.length > 0) {
+        if (parentNode.nodeName == NodeName.BLOCKQUOTE) {
+            for (var counter = 0; counter < nodes.length; counter++) {
+                this.turnBlockquoteOffForNode(nodes[counter]);
+            }
+        } else {
+
+            var turnOn = (nodes[0].nodeName != NodeName.BLOCKQUOTE);
+
+            for (var counter = 0; counter < nodes.length; counter++) {
+                if (turnOn) {
+                    this.turnBlockquoteOnForNode(nodes[counter]);
+                } else {
+                    this.turnBlockquoteOffForNode(nodes[counter]);
+                }
+            }
+        }
+    }
+};
+
+
+/**
+ *  @brief      Turns blockquote off for the specified node.
+ *
+ *  @param      node    The node to turn the blockquote off for.  It can either be a blockquote
+ *                      node (in which case it will be removed and all child nodes extracted) or
+ *                      have a parent blockquote node (in which case the node will be extracted
+ *                      from its parent).
+ */
+ZSSEditor.turnBlockquoteOffForNode = function(node) {
+
+    if (node.nodeName == NodeName.BLOCKQUOTE) {
+        for (var i = 0; i < node.childNodes.length; i++) {
+            this.extractNodeFromAncestorNode(node.childNodes[i], node);
+        }
+    } else {
+        if (node.parentNode.nodeName == NodeName.BLOCKQUOTE) {
+            this.extractNodeFromAncestorNode(node, node.parentNode);
+        }
+    }
+};
+
+/**
+ *  @brief      Turns blockquote on for the specified node.
+ *
+ *  @param      node    The node to turn blockquote on for.  Will attempt to attach the newly
+ *                      created blockquote to sibling or uncle blockquote nodes.  If the node is
+ *                      null or it's parent is null, this method will exit without affecting it
+ *                      (this can actually be caused by this method modifying the surrounding
+ *                      nodes, if those nodes are stored in an array - and thus are not notified
+ *                      of DOM hierarchy changes).
+ */
+ZSSEditor.turnBlockquoteOnForNode = function(node) {
+
+    if (!node || !node.parentNode) {
+        return;
+    }
+
+    var couldJoinBlockquotes = this.joinAdjacentSiblingsOrAncestorBlockquotes(node);
+
+    if (!couldJoinBlockquotes) {
+        var blockquote = document.createElement(NodeName.BLOCKQUOTE);
+
+        node.parentNode.insertBefore(blockquote, node);
+        blockquote.appendChild(node);
+    }
+};
+
 // MARK: - Images
 
 ZSSEditor.updateImage = function(url, alt) {
@@ -621,7 +800,7 @@ ZSSEditor.updateImage = function(url, alt) {
 
 ZSSEditor.insertImage = function(url, alt) {
     var html = '<img src="'+url+'" alt="'+alt+'" />';
-    
+
     this.insertHTML(html);
     this.sendEnabledStyles();
 };
@@ -640,8 +819,7 @@ ZSSEditor.insertImage = function(url, alt) {
  *                                      does not check for that.  It would be a mistake.
  */
 ZSSEditor.insertLocalImage = function(imageNodeIdentifier, localImageUrl) {
-    // this hiddenChar helps with editing the content around images: http://stackoverflow.com/questions/18985261/cursor-in-wrong-place-in-contenteditable
-    var hiddenChar = '\ufeff';
+    var space = '&nbsp';
     var progressIdentifier = this.getImageProgressIdentifier(imageNodeIdentifier);
     var imageContainerIdentifier = this.getImageContainerIdentifier(imageNodeIdentifier);
     var imgContainerStart = '<span id="' + imageContainerIdentifier+'" class="img_container" contenteditable="false" data-failed="Tap to try again!">';
@@ -649,8 +827,8 @@ ZSSEditor.insertLocalImage = function(imageNodeIdentifier, localImageUrl) {
     var progress = '<progress id="' + progressIdentifier+'" value=0  class="wp_media_indicator"  contenteditable="false"></progress>';
     var image = '<img data-wpid="' + imageNodeIdentifier + '" src="' + localImageUrl + '" alt="" />';
     var html = imgContainerStart + progress+image + imgContainerEnd;
-    html = hiddenChar + html + hiddenChar;
-    
+    html = space + html + space;
+
     this.insertHTML(html);
     this.sendEnabledStyles();
 };
@@ -688,33 +866,35 @@ ZSSEditor.getImageContainerNodeWithIdentifier = function(imageNodeIdentifier) {
  *  @param      remoteImageUrl          The URL of the remote image to display.
  */
 ZSSEditor.replaceLocalImageWithRemoteImage = function(imageNodeIdentifier, remoteImageUrl) {
-    
     var imageNode = this.getImageNodeWithIdentifier(imageNodeIdentifier);
-    
+
     if (imageNode.length == 0) {
+        // even if the image is not present anymore we must do callback
+        this.markImageUploadDone(imageNodeIdentifier);
         return;
     }
-    //when we decide to put the final url we can remove this from the node.
-    imageNode.removeAttr('data-wpid');
-    
+
     var image = new Image;
-    
+
     image.onload = function () {
-        imageNode.attr('src', image.src);            
+        imageNode.attr('src', image.src);
+        ZSSEditor.markImageUploadDone(imageNodeIdentifier);
         var joinedArguments = ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();
         ZSSEditor.callback("callback-input", joinedArguments);
+
     }
-    
+
     image.onerror = function () {
         // Even on an error, we swap the image for the time being.  This is because private
         // blogs are currently failing to download images due to access privilege issues.
         //
         imageNode.attr('src', image.src);
-        
+        ZSSEditor.markImageUploadDone(imageNodeIdentifier);
         var joinedArguments = ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();
         ZSSEditor.callback("callback-input", joinedArguments);
+
     }
-    
+
     image.src = remoteImageUrl;
 };
 
@@ -729,24 +909,58 @@ ZSSEditor.setProgressOnImage = function(imageNodeIdentifier, progress) {
     if (imageNode.length == 0){
         return;
     }
-    if (progress >=1){
-        imageNode.removeClass("uploading");
-        imageNode.removeAttr("class");
-    } else {
+    if (progress < 1){
         imageNode.addClass("uploading");
     }
-    
+
     var imageProgressNode = this.getImageProgressNodeWithIdentifier(imageNodeIdentifier);
     if (imageProgressNode.length == 0){
           return;
     }
     imageProgressNode.attr("value",progress);
-    // if progress is finished remove all extra nodes.
-    if (progress >=1 &&
-        (imageNode.parent().attr("id") == this.getImageContainerIdentifier(imageNodeIdentifier)))
-    {
+};
+
+/**
+ *  @brief      Notifies that the image upload as finished
+ *
+ *  @param      imageNodeIdentifier     The unique image ID for the uploaded image
+ */
+ZSSEditor.markImageUploadDone = function(imageNodeIdentifier) {
+
+    this.sendImageReplacedCallback(imageNodeIdentifier);
+
+    var imageNode = this.getImageNodeWithIdentifier(imageNodeIdentifier);
+    if (imageNode.length == 0){
+        return;
+    }
+
+    // remove identifier attributed from image
+    imageNode.removeAttr('data-wpid');
+
+    // remove uploading style
+    imageNode.removeClass("uploading");
+    imageNode.removeAttr("class");
+
+    // Remove all extra formatting nodes for progress
+    if (imageNode.parent().attr("id") == this.getImageContainerIdentifier(imageNodeIdentifier)) {
         imageNode.parent().replaceWith(imageNode);
     }
+    // Wrap link around image
+    var linkTag = '<a href="' + imageNode.attr("src") + '"></a>';
+    imageNode.wrap(linkTag);
+};
+
+/**
+ *  @brief      Callbacks to native that the image upload as finished and the local url was replaced by the remote url
+ *
+ *  @param      imageNodeIdentifier     The unique image ID for the uploaded image
+ */
+ZSSEditor.sendImageReplacedCallback = function( imageNodeIdentifier ) {
+    var arguments = ['id=' + encodeURIComponent( imageNodeIdentifier )];
+
+    var joinedArguments = arguments.join( defaultCallbackSeparator );
+
+    this.callback("callback-image-replaced", joinedArguments);
 };
 
 /**
@@ -760,15 +974,24 @@ ZSSEditor.markImageUploadFailed = function(imageNodeIdentifier, message) {
     if (imageNode.length == 0){
         return;
     }
-    
+
+    var sizeClass = '';
+    if ( imageNode[0].width > 480 && imageNode[0].height > 240 ) {
+        sizeClass = "largeFail";
+    } else if ( imageNode[0].width < 100 || imageNode[0].height < 100 ) {
+        sizeClass = "smallFail";
+    }
+
     imageNode.addClass('failed');
-    
+
     var imageContainerNode = this.getImageContainerNodeWithIdentifier(imageNodeIdentifier);
     if(imageContainerNode.length != 0){
         imageContainerNode.attr("data-failed", message);
+        imageNode.removeClass("uploading");
         imageContainerNode.addClass('failed');
+        imageContainerNode.addClass(sizeClass);
     }
-    
+
     var imageProgressNode = this.getImageProgressNodeWithIdentifier(imageNodeIdentifier);
     if (imageProgressNode.length != 0){
         imageProgressNode.addClass('failed');
@@ -784,15 +1007,14 @@ ZSSEditor.unmarkImageUploadFailed = function(imageNodeIdentifier, message) {
     var imageNode = this.getImageNodeWithIdentifier(imageNodeIdentifier);
     if (imageNode.length != 0){
         imageNode.removeClass('failed');
-        imageNode.attr("contenteditable","false");
     }
-    
+
     var imageContainerNode = this.getImageContainerNodeWithIdentifier(imageNodeIdentifier);
     if(imageContainerNode.length != 0){
         imageContainerNode.removeAttr("data-failed");
         imageContainerNode.removeClass('failed');
     }
-    
+
     var imageProgressNode = this.getImageProgressNodeWithIdentifier(imageNodeIdentifier);
     if (imageProgressNode.length != 0){
         imageProgressNode.removeClass('failed');
@@ -846,10 +1068,8 @@ ZSSEditor.updateCurrentImageMeta = function( imageMetaString ) {
 ZSSEditor.applyImageSelectionFormatting = function( imageNode ) {
     var node = ZSSEditor.findImageCaptionNode( imageNode );
 
-    var sizeClass = '';
-    if ( imageNode.width > 200 && imageNode.height > 240 ) {
-        sizeClass = " large";
-    } else if ( imageNode.width < 100 || imageNode.height < 100 ) {
+    var sizeClass = "";
+    if ( imageNode.width < 100 || imageNode.height < 100 ) {
         sizeClass = " small";
     }
 
@@ -872,6 +1092,21 @@ ZSSEditor.removeImageSelectionFormatting = function( imageNode ) {
     parentNode.remove();
 }
 
+ZSSEditor.removeImageSelectionFormattingFromHTML = function( html ) {
+    var tmp = document.createElement( "div" );
+    var tmpDom = $( tmp ).html( html );
+
+    var matches = tmpDom.find( "span.edit-container img" );
+    if ( matches.length == 0 ) {
+        return html;
+    }
+
+    for ( var i = 0; i < matches.length; i++ ) {
+        ZSSEditor.removeImageSelectionFormatting( matches[i] );
+    }
+
+    return tmpDom.html();
+}
 
 /**
  *  @brief       Finds all related caption nodes for the specified image node.
@@ -978,6 +1213,8 @@ ZSSEditor.createImageFromMeta = function( props ) {
 
         if ( props.align ) {
             shortcode.align = 'align' + props.align;
+        } else {
+            shortcode.align = 'alignnone';
         }
 
         if (props.captionClassName) {
@@ -1028,13 +1265,17 @@ ZSSEditor.extractImageMeta = function( imageNode ) {
         size: 'custom',     // Accepted values: custom, medium, large, thumbnail, or empty string
         src: '',            // The src attribute of the image
         title: '',          // The title attribute of the image (if any)
-        width: ''           // The image width attribute
+        width: '',          // The image width attribute
+        naturalWidth:'',    // The natural width of the image.
+        naturalHeight:''    // The natural height of the image.
     };
 
     // populate metadata with values of matched attributes
     metadata.src = $( imageNode ).attr( 'src' ) || '';
     metadata.alt = $( imageNode ).attr( 'alt' ) || '';
     metadata.title = $( imageNode ).attr( 'title' ) || '';
+    metadata.naturalWidth = imageNode.naturalWidth;
+    metadata.naturalHeight = imageNode.naturalHeight;
 
     width = $(imageNode).attr( 'width' );
     height = $(imageNode).attr( 'height' );
@@ -1152,7 +1393,9 @@ ZSSEditor.captionMetaForImage = function( imageNode ) {
  */
 ZSSEditor.applyCaptionFormatting = function( match ) {
     var attrs = match.attrs.named;
-    var out = '<label class="wp-temp" data-wp-temp="caption" contenteditable="false">';
+    // The empty 'onclick' is important. It prevents the cursor jumping to the end
+    // of the content body when `-webkit-user-select: none` is set and the caption is tapped.
+    var out = '<label class="wp-temp" data-wp-temp="caption" contenteditable="false" onclick="">';
     out += '<span class="wp-caption"';
 
     if ( attrs.width ) {
@@ -1181,7 +1424,7 @@ ZSSEditor.removeCaptionFormatting = function( html ) {
     // call methods to restore any transformed content from its visual presentation to its source code.
     var regex = /<label class="wp-temp" data-wp-temp="caption"[^>]*>([\s\S]+?)<\/label>/g;
 
-    var str = html.replace( regex, ZSSEditor.removeCaptionFormattingCallback ) + " "; // Add a trailing space for nice formatting.
+    var str = html.replace( regex, ZSSEditor.removeCaptionFormattingCallback );
 
     return str;
 }
@@ -1269,8 +1512,9 @@ ZSSEditor.applyVisualFormatting  = function( html ) {
  *  @return     Returns the string with the visual formatting removed.
  */
 ZSSEditor.removeVisualFormatting = function( html ) {
-    var str = ZSSEditor.removeCaptionFormatting( html );
-
+    var str = html;
+    str = ZSSEditor.removeImageSelectionFormattingFromHTML( str );
+    str = ZSSEditor.removeCaptionFormatting( str );
     return str;
 }
 
@@ -1286,27 +1530,29 @@ ZSSEditor.isCommandEnabled = function(commandName) {
 ZSSEditor.sendEnabledStyles = function(e) {
 
 	var items = [];
-	
+
     var focusedField = this.getFocusedField();
-    
+
     if (!focusedField.hasNoStyle) {
         // Find all relevant parent tags
         var parentTags = ZSSEditor.parentTags();
-        
+
         for (var i = 0; i < parentTags.length; i++) {
             var currentNode = parentTags[i];
-            
+
             if (currentNode.nodeName.toLowerCase() == 'a') {
                 ZSSEditor.currentEditingLink = currentNode;
-                
+
                 var title = encodeURIComponent(currentNode.text);
                 var href = encodeURIComponent(currentNode.href);
-                
+
                 items.push('link-title:' + title);
                 items.push('link:' + href);
+            } else if (currentNode.nodeName == NodeName.BLOCKQUOTE) {
+                items.push('blockquote');
             }
         }
-        
+
         if (ZSSEditor.isCommandEnabled('bold')) {
             items.push('bold');
         }
@@ -1327,7 +1573,7 @@ ZSSEditor.sendEnabledStyles = function(e) {
         }
         if (ZSSEditor.isCommandEnabled('underline')) {
             var isUnderlined = false;
-            
+
             // DRM: 'underline' gets highlighted if it's inside of a link... so we need a special test
             // in that case.
             if (!ZSSEditor.currentEditingLink) {
@@ -1359,14 +1605,14 @@ ZSSEditor.sendEnabledStyles = function(e) {
         if (formatBlock.length > 0) {
             items.push(formatBlock);
         }
-        
+
         // Use jQuery to figure out those that are not supported
         if (typeof(e) != "undefined") {
-            
+
             // The target element
             var t = $(e.target);
             var nodeName = e.target.nodeName.toLowerCase();
-            
+
             // Background Color
             try
             {
@@ -1380,7 +1626,7 @@ ZSSEditor.sendEnabledStyles = function(e) {
                 // DRM: I had to add these stupid try-catch blocks to solve an issue with t.css throwing
                 // exceptions for no reason.
             }
-            
+
             // Text Color
             try
             {
@@ -1394,11 +1640,7 @@ ZSSEditor.sendEnabledStyles = function(e) {
                 // DRM: I had to add these stupid try-catch blocks to solve an issue with t.css throwing
                 // exceptions for no reason.
             }
-            
-            // Blockquote
-            if (nodeName == 'blockquote') {
-                items.push('indent');
-            }
+
             // Image
             if (nodeName == 'img') {
                 ZSSEditor.currentEditingImage = t;
@@ -1409,136 +1651,396 @@ ZSSEditor.sendEnabledStyles = function(e) {
             }
         }
     }
-	
+
 	ZSSEditor.stylesCallback(items);
 };
 
+// MARK: - Commands: High Level Editing
+
+/**
+ *  @brief      Inserts a br tag at the caret position.
+ */
+ZSSEditor.insertBreakTagAtCaretPosition = function() {
+    // iOS IMPORTANT: we were adding <br> tags with range.insertNode() before using
+    // this method.  Unfortunately this was causing issues with the first <br> tag
+    // being completely ignored under iOS:
+    //
+    // https://bugs.webkit.org/show_bug.cgi?id=23474
+    //
+    // The following line seems to work fine under iOS, so please be careful if this
+    // needs to be changed for any reason.
+    //
+    document.execCommand("insertLineBreak");
+};
+
+// MARK: - Advanced Node Manipulation
+
+/**
+ *  @brief      Extracts a node from a parent node, and from all nodes in between the two.
+ */
+ZSSEditor.extractNodeFromAncestorNode = function(descendant, ancestor) {
+
+    while (ancestor.contains(descendant)) {
+
+        this.extractNodeFromParent(descendant);
+        break;
+    }
+};
+
+/**
+ *  @brief      Extract the specified node from its direct parent node.
+ *  @details    If the node has siblings, before or after it, the parent node is split accordingly
+ *              into two new clones of it.
+ */
+ZSSEditor.extractNodeFromParent = function(node) {
+
+    var parentNode = node.parentNode;
+    var grandParentNode = parentNode.parentNode;
+    var clonedParentForPreviousSiblings = null;
+    var clonedParentForNextSiblings = null;
+
+    if (node.previousSibling != null) {
+        var clonedParentForPreviousSiblings = parentNode.cloneNode();
+
+        while (parentNode.firstChild != node) {
+            clonedParentForPreviousSiblings.appendChild(parentNode.firstChild);
+        }
+    }
+
+    if (node.nextSibling != null) {
+        var clonedParentForNextSiblings = parentNode.cloneNode();
+
+        while (node.nextSibling != null) {
+            clonedParentForNextSiblings.appendChild(node.nextSibling);
+        }
+    }
+
+    if (clonedParentForPreviousSiblings) {
+        grandParentNode.insertBefore(clonedParentForPreviousSiblings, parentNode);
+    }
+
+    grandParentNode.insertBefore(node, parentNode);
+
+    if (clonedParentForNextSiblings) {
+        grandParentNode.insertBefore(clonedParentForNextSiblings, parentNode);
+    }
+
+    grandParentNode.removeChild(parentNode);
+};
+
+ZSSEditor.getChildNodesIntersectingRange = function(parentNode, range) {
+
+    var nodes = new Array();
+
+    if (parentNode) {
+        var currentNode = parentNode.firstChild;
+        var pushNodes = false;
+        var exit = false;
+
+        while (currentNode) {
+
+            if (range.intersectsNode(currentNode)) {
+                nodes.push(currentNode);
+            }
+
+            currentNode = currentNode.nextSibling;
+        }
+    }
+
+    return nodes;
+};
+
+/**
+ *  @brief      Given the specified range, find the ancestor element that  will be used to set the
+ *              blockquote ON or OFF.
+ *
+ *  @param      range       The range we want to set the blockquote ON or OFF for.
+ *
+ *  @returns    If a parent BLOCKQUOTE element is found, it will be return.  Otherwise the closest
+ *              parent non-paragraph element will be returned.
+ */
+ZSSEditor.getAncestorElementForSettingBlockquote = function(range) {
+
+    var nodes = new Array();
+    var parentElement = range.commonAncestorContainer;
+
+    while (parentElement
+           && (parentElement.nodeType != document.ELEMENT_NODE
+               || parentElement.nodeName == NodeName.PARAGRAPH
+               || parentElement.nodeName == NodeName.STRONG
+               || parentElement.nodeName == NodeName.EM
+               || parentElement.nodeName == NodeName.DEL
+               || parentElement.nodeName == NodeName.A
+               || parentElement.nodeName == NodeName.UL
+               || parentElement.nodeName == NodeName.OL
+               || parentElement.nodeName == NodeName.LI
+               || parentElement.nodeName == NodeName.CODE
+               || parentElement.nodeName == NodeName.SPAN)) {
+        parentElement = parentElement.parentNode;
+    }
+
+    var currentElement = parentElement;
+
+    while (currentElement
+           && currentElement.nodeName != NodeName.BLOCKQUOTE) {
+        currentElement = currentElement.parentElement;
+    }
+
+    var result = currentElement ? currentElement : parentElement;
+
+    return result;
+};
+
+/**
+ *  @brief      Joins any adjacent blockquote siblings.
+ *  @details    You probably want to call joinAdjacentSiblingsOrAncestorBlockquotes() instead of
+ *              this.
+ *
+ *  @returns    true if a sibling was joined.  false otherwise.
+ */
+ZSSEditor.joinAdjacentSiblingsBlockquotes = function(node) {
+
+    var shouldJoinToPreviousSibling = this.hasPreviousSiblingWithName(node, NodeName.BLOCKQUOTE);
+    var shouldJoinToNextSibling = this.hasNextSiblingWithName(node, NodeName.BLOCKQUOTE);
+    var joinedASibling = (shouldJoinToPreviousSibling || shouldJoinToNextSibling);
+
+    var previousSibling = node.previousSibling;
+    var nextSibling = node.nextSibling;
+
+    if (shouldJoinToPreviousSibling) {
+
+        previousSibling.appendChild(node);
+
+        if (shouldJoinToNextSibling) {
+
+            while (nextSibling.firstChild) {
+                previousSibling.appendChild(nextSibling.firstChild);
+            }
+
+            nextSibling.parentNode.removeChild(nextSibling);
+        }
+    } else if (shouldJoinToNextSibling) {
+
+        nextSibling.insertBefore(node, nextSibling.firstChild);
+    }
+
+    return joinedASibling;
+};
+
+/**
+ *  @brief      Joins any adjacent blockquote siblings, or the blockquote siblings of any ancestor.
+ *  @details    When turning blockquotes back on, this method makes sure that we attach new
+ *              blockquotes to exiting ones.
+ *
+ *  @returns    true if a sibling or ancestor sibling was joined.  false otherwise.
+ */
+ZSSEditor.joinAdjacentSiblingsOrAncestorBlockquotes = function(node) {
+
+    var currentNode = node;
+    var rootNode = this.getFocusedField().wrappedDomNode();
+    var joined = false;
+
+    while (currentNode
+           && currentNode != rootNode
+           && !joined) {
+
+        joined = this.joinAdjacentSiblingsBlockquotes(currentNode);
+        currentNode = currentNode.parentNode;
+    };
+
+    return joined;
+};
+
+/**
+ *  @brief      Surrounds a node's contents into another node
+ *  @details    When creating new nodes that should force paragraphs inside of them, this method
+ *              should be called.
+ *
+ *  @param      node            The node that will have its contents wrapped into a new node.
+ *  @param      wrapperNodeName The nodeName of the node that will created to wrap the contents.
+ *
+ *  @returns    The newly created wrapper node.
+ */
+ZSSEditor.surroundNodeContentsWithNode = function(node, wrapperNodeName) {
+
+    var range = document.createRange();
+    var wrapperNode = document.createElement(wrapperNodeName);
+
+    range.selectNodeContents(node);
+    range.surroundContents(wrapperNode);
+
+    return wrapperNode;
+};
+
+/**
+ *  @brief      Surrounds a node's contents with a paragraph node.
+ *  @details    When creating new nodes that should force paragraphs inside of them, this method
+ *              should be called.
+ *
+ *  @returns    The paragraph node.
+ */
+ZSSEditor.surroundNodeContentsWithAParagraphNode = function(node) {
+
+    return this.surroundNodeContentsWithNode(node, this.defaultParagraphSeparator);
+};
+
+// MARK: - Sibling nodes
+
+ZSSEditor.hasNextSiblingWithName = function(node, siblingNodeName) {
+    return node.nextSibling && node.nextSibling.nodeName == siblingNodeName;
+};
+
+ZSSEditor.hasPreviousSiblingWithName = function(node, siblingNodeName) {
+    return node.previousSibling && node.previousSibling.nodeName == siblingNodeName;
+};
+
+
 // MARK: - Parent nodes & tags
 
 ZSSEditor.closerParentNode = function() {
-    
+
     var parentNode = null;
     var selection = window.getSelection();
     var range = selection.getRangeAt(0).cloneRange();
-    
+
     var currentNode = range.commonAncestorContainer;
-    
+
     while (currentNode) {
         if (currentNode.nodeType == document.ELEMENT_NODE) {
             parentNode = currentNode;
-            
+
             break;
         }
-        
+
         currentNode = currentNode.parentElement;
     }
-    
+
     return parentNode;
 };
 
 ZSSEditor.closerParentNodeStartingAtNode = function(nodeName, startingNode) {
-    
+
     nodeName = nodeName.toLowerCase();
-    
+
     var parentNode = null;
     var currentNode = startingNode,parentElement;
-    
+
     while (currentNode) {
-        
+
         if (currentNode.nodeName == document.body.nodeName) {
             break;
         }
-        
+
         if (currentNode.nodeName.toLowerCase() == nodeName
             && currentNode.nodeType == document.ELEMENT_NODE) {
             parentNode = currentNode;
-            
+
             break;
         }
-        
+
         currentNode = currentNode.parentElement;
     }
-    
+
     return parentNode;
 };
 
 ZSSEditor.closerParentNodeWithName = function(nodeName) {
-    
+
     nodeName = nodeName.toLowerCase();
-    
+
     var parentNode = null;
     var selection = window.getSelection();
     var range = selection.getRangeAt(0).cloneRange();
-    
-    var currentNode = range.commonAncestorContainer;
-    
+
+    var referenceNode = range.commonAncestorContainer;
+
+    return this.closerParentNodeWithNameRelativeToNode(nodeName, referenceNode);
+};
+
+ZSSEditor.closerParentNodeWithNameRelativeToNode = function(nodeName, referenceNode) {
+
+    nodeName = nodeName.toUpperCase();
+
+    var parentNode = null;
+    var currentNode = referenceNode;
+
     while (currentNode) {
-        
+
         if (currentNode.nodeName == document.body.nodeName) {
             break;
         }
-        
-        if (currentNode.nodeName.toLowerCase() == nodeName
+
+        if (currentNode.nodeName == nodeName
             && currentNode.nodeType == document.ELEMENT_NODE) {
             parentNode = currentNode;
-            
+
             break;
         }
-        
+
         currentNode = currentNode.parentElement;
     }
-    
+
     return parentNode;
 };
 
+ZSSEditor.isCloserParentNodeABlockquote = function() {
+    return this.closerParentNode().nodeName == NodeName.BLOCKQUOTE;
+};
+
 ZSSEditor.parentTags = function() {
-    
+
     var parentTags = [];
     var selection = window.getSelection();
     var range = selection.getRangeAt(0);
-    
+
     var currentNode = range.commonAncestorContainer;
     while (currentNode) {
-        
+
         if (currentNode.nodeName == document.body.nodeName) {
             break;
         }
-        
+
         if (currentNode.nodeType == document.ELEMENT_NODE) {
             parentTags.push(currentNode);
         }
-        
+
         currentNode = currentNode.parentElement;
     }
-    
+
     return parentTags;
 };
 
 // MARK: - ZSSField Constructor
 
 function ZSSField(wrappedObject) {
+    // When this bool is true, we are going to restrict input and certain callbacks
+    // so IME keyboards behave properly when composing.
+    this.isComposing = false;
+
     this.multiline = false;
     this.wrappedObject = wrappedObject;
     this.bodyPlaceholderColor = '#000000';
-    
+
     if (this.wrappedDomNode().hasAttribute('nostyle')) {
         this.hasNoStyle = true;
     }
 
     this.useVisualFormatting = (this.wrappedObject.data("wpUseVisualFormatting") === "true")
-    
+
     this.bindListeners();
 };
 
 ZSSField.prototype.bindListeners = function() {
-    
+
     var thisObj = this;
-    
+
     this.wrappedObject.bind('tap', function(e) { thisObj.handleTapEvent(e); });
     this.wrappedObject.bind('focus', function(e) { thisObj.handleFocusEvent(e); });
     this.wrappedObject.bind('blur', function(e) { thisObj.handleBlurEvent(e); });
     this.wrappedObject.bind('keydown', function(e) { thisObj.handleKeyDownEvent(e); });
     this.wrappedObject.bind('input', function(e) { thisObj.handleInputEvent(e); });
+    this.wrappedObject.bind('compositionstart', function(e) { thisObj.handleCompositionStartEvent(e); });
+    this.wrappedObject.bind('compositionend', function(e) { thisObj.handleCompositionEndEvent(e); });
 };
 
 // MARK: - Emptying the field when it should be, well... empty (HTML madness)
@@ -1552,12 +2054,14 @@ ZSSField.prototype.emptyFieldIfNoContents = function() {
 
     var nbsp = '\xa0';
     var text = this.wrappedObject.text().replace(nbsp, '');
-    
+
     if (text.length == 0) {
-        
+
         var hasChildImages = (this.wrappedObject.find('img').length > 0);
-        
-        if (!hasChildImages) {
+        var hasUnorderedList = (this.wrappedObject.find('ul').length > 0);
+        var hasOrderedList = (this.wrappedObject.find('ol').length > 0);
+
+        if (!hasChildImages && !hasUnorderedList && !hasOrderedList) {
             this.wrappedObject.empty();
         }
     }
@@ -1574,13 +2078,13 @@ ZSSField.prototype.handleBlurEvent = function(e) {
     ZSSEditor.focusedField = null;
 
     this.emptyFieldIfNoContentsAndRefreshPlaceholderColor();
-    
+
     this.callback("callback-focus-out");
 };
 
 ZSSField.prototype.handleFocusEvent = function(e) {
     ZSSEditor.focusedField = this;
-    
+
     // IMPORTANT: this is the only case where checking the current focus will not work.
     // We sidestep this issue by indicating that the field is about to gain focus.
     //
@@ -1589,44 +2093,58 @@ ZSSField.prototype.handleFocusEvent = function(e) {
 };
 
 ZSSField.prototype.handleKeyDownEvent = function(e) {
-    
-    // IMPORTANT: without this code, we can have text written outside of paragraphs...
-    //
-    if (ZSSEditor.closerParentNode() == this.wrappedDomNode()) {
-        document.execCommand('formatBlock', false, 'p');
+
+    var wasEnterPressed = (e.keyCode == '13');
+
+    if (this.isComposing) {
+        e.stopPropagation();
+    } else if (wasEnterPressed && !this.isMultiline()) {
+        e.preventDefault();
+    } else if (this.isMultiline()) {
+        this.wrapCaretInParagraphIfNecessary();
     }
 };
 
 ZSSField.prototype.handleInputEvent = function(e) {
-    
+
+    // Skip this if we are composing on an IME keyboard
+    if (this.isComposing ) { return; }
+
     // IMPORTANT: we want the placeholder to come up if there's no text, so we clear the field if
     // there's no real content in it.  It's important to do this here and not on keyDown or keyUp
     // as the field could become empty because of a cut or paste operation as well as a key press.
     // This event takes care of all cases.
     //
     this.emptyFieldIfNoContentsAndRefreshPlaceholderColor();
-    
-    var joinedArguments = ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();
 
+    var joinedArguments = ZSSEditor.getJoinedFocusedFieldIdAndCaretArguments();
     ZSSEditor.callback('callback-selection-changed', joinedArguments);
     this.callback("callback-input", joinedArguments);
 };
 
+ZSSField.prototype.handleCompositionStartEvent = function(e) {
+    this.isComposing = true;
+};
+
+ZSSField.prototype.handleCompositionEndEvent = function(e) {
+    this.isComposing = false;
+};
+
 ZSSField.prototype.handleTapEvent = function(e) {
     var targetNode = e.target;
-    
+
     if (targetNode) {
-        
+
         ZSSEditor.lastTappedNode = targetNode;
-        
+
         if (targetNode.nodeName.toLowerCase() == 'a') {
             var arguments = ['url=' + encodeURIComponent(targetNode.href),
                              'title=' + encodeURIComponent(targetNode.innerHTML)];
-            
+
             var joinedArguments = arguments.join(defaultCallbackSeparator);
-            
+
             var thisObj = this;
-            
+
             // WORKAROUND: force the event to become sort of "after-tap" through setTimeout()
             //
             setTimeout(function() { thisObj.callback('callback-link-tap', joinedArguments);}, 500);
@@ -1707,9 +2225,11 @@ ZSSField.prototype.callback = function(callbackScheme, callbackPath) {
     if (callbackPath) {
         url = url + defaultCallbackSeparator + callbackPath;
     }
-    
+
     if (isUsingiOS) {
         ZSSEditor.callbackThroughIFrame(url);
+    } else if (isUsingAndroid) {
+        nativeCallbackHandler.executeCallback(callbackScheme, callbackPath);
     } else {
         console.log(url);
     }
@@ -1723,7 +2243,7 @@ ZSSField.prototype.isFocused = function() {
 };
 
 ZSSField.prototype.focus = function() {
-    
+
     if (!this.isFocused()) {
         this.wrappedObject.focus();
     }
@@ -1754,9 +2274,9 @@ ZSSField.prototype.getNodeId = function() {
 // MARK: - Editing
 
 ZSSField.prototype.enableEditing = function () {
-    
+
     this.wrappedObject.attr('contenteditable', true);
-    
+
     if (!ZSSEditor.focusedField) {
         ZSSEditor.focusFirstEditableField();
     }
@@ -1768,10 +2288,46 @@ ZSSField.prototype.disableEditing = function () {
     // removed from the screen.
     //
     this.blur();
-    
+
     this.wrappedObject.attr('contenteditable', false);
 };
 
+// MARK: - Caret
+
+/**
+ *  @brief      Whenever this method is called, a check will be performed on the caret position
+ *              to figure out if it needs to be wrapped in a paragraph node.
+ *  @details    A parent paragraph node should be added if the current parent is either the field
+ *              node itself, or a blockquote node.
+ */
+ZSSField.prototype.wrapCaretInParagraphIfNecessary = function()
+{
+    var closerParentNode = ZSSEditor.closerParentNode();
+    var parentNodeShouldBeParagraph = (closerParentNode == this.wrappedDomNode()
+                                       || closerParentNode.nodeName == NodeName.BLOCKQUOTE);
+
+    if (parentNodeShouldBeParagraph) {
+        var selection = window.getSelection();
+
+        if (selection) {
+            var range = selection.getRangeAt(0);
+
+            if (range.startContainer == range.endContainer) {
+                var paragraph = document.createElement("p");
+                var textNode = document.createTextNode("&#x200b;");
+
+                paragraph.appendChild(textNode);
+
+                range.insertNode(paragraph);
+                range.selectNode(textNode);
+
+                selection.removeAllRanges();
+                selection.addRange(range);
+            }
+        }
+    }
+};
+
 // MARK: - i18n
 
 ZSSField.prototype.isRightToLeftTextEnabled = function() {
@@ -1791,26 +2347,40 @@ ZSSField.prototype.enableRightToLeftText = function(isRTL) {
 ZSSField.prototype.isEmpty = function() {
     var html = this.getHTML();
     var isEmpty = (html.length == 0 || html == "<br>");
-    
+
     return isEmpty;
 };
 
 ZSSField.prototype.getHTML = function() {
-    var html = this.wrappedObject.html();
-    html = ZSSEditor.removeVisualFormatting(html);
-    return html
+    var html = wp.saveText(this.wrappedObject.html());
+    html = ZSSEditor.removeVisualFormatting( html );
+    return html;
+};
+
+ZSSField.prototype.getHTMLForCallback = function() {
+    var idArgument = "id=" + this.getNodeId();
+    var contentsArgument = "contents=" + this.getHTML();
+    var joinedArguments = idArgument + defaultCallbackSeparator + contentsArgument;
+    ZSSEditor.callback('callback-response-string', joinedArguments);
 };
 
 ZSSField.prototype.strippedHTML = function() {
     return this.wrappedObject.text();
 };
 
-ZSSField.prototype.setHTML = function(html) {
-    html = ZSSEditor.applyVisualFormatting(html);
-    this.wrappedObject.html(html);
+ZSSField.prototype.setPlainText = function(text) {
+    ZSSEditor.currentEditingImage = null;
+    this.wrappedObject.text(text);
     this.refreshPlaceholderColor();
 };
 
+ZSSField.prototype.setHTML = function(html) {
+    ZSSEditor.currentEditingImage = null;
+    var mutatedHTML = wp.loadText(html);
+    mutatedHTML = ZSSEditor.applyVisualFormatting(mutatedHTML);
+    this.wrappedObject.html(mutatedHTML);
+    this.refreshPlaceholderColor();
+};
 
 // MARK: - Placeholder
 
@@ -1819,7 +2389,7 @@ ZSSField.prototype.hasPlaceholderText = function() {
 };
 
 ZSSField.prototype.setPlaceholderText = function(placeholder) {
-    
+
     this.wrappedObject.attr('placeholderText', placeholder);
 };
 
@@ -1841,9 +2411,9 @@ ZSSField.prototype.refreshPlaceholderColorAboutToGainFocus = function(willGainFo
 };
 
 ZSSField.prototype.refreshPlaceholderColorForAttributes = function(hasPlaceholderText, isFocused, isEmpty) {
-    
+
     var shouldColorText = hasPlaceholderText && isEmpty;
-    
+
     if (shouldColorText) {
         if (isFocused) {
             this.wrappedObject.css('color', this.bodyPlaceholderColor);
@@ -1853,7 +2423,7 @@ ZSSField.prototype.refreshPlaceholderColorForAttributes = function(hasPlaceholde
     } else {
         this.wrappedObject.css('color', '');
     }
-    
+
 };
 
 // MARK: - Wrapped Object
diff --git a/libs/editor-common/assets/android-editor.html b/libs/editor-common/assets/android-editor.html
old mode 100644
new mode 100755
index 1793dc003127..13b6281d6603
--- a/libs/editor-common/assets/android-editor.html
+++ b/libs/editor-common/assets/android-editor.html
@@ -2,27 +2,40 @@
 <html>
   <head>
     <title>ZSSRichTextEditor</title>
-    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0" />
-    <script type="text/javascript" src="jquery-2.0.3.min.js"></script>
-    <script type="text/javascript" src="underscore-min.js"></script>
-    <script type="text/javascript" src="shortcode.js"></script>
-    <script type="text/javascript" src="jquery.mobile-events.min.js"></script>
-    <script type="text/javascript" src="ZSSRichTextEditor.js"></script>
-    <script type="text/javascript">
+    <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0, maximum-scale=1.0, user-scalable=0">
+    <script src="jquery-2.1.3.min.js"></script>
+    <script src="js-beautifier.js"></script>
+    <script src="underscore-min.js"></script>
+    <script src="shortcode.js"></script>
+    <script src="jquery.mobile-events.min.js"></script>
+    <script src="ZSSRichTextEditor.js"></script>
+    <script src="wpload.js"></script>
+    <script src="wpsave.js"></script>
+    <script src="rangy-core.js"></script>
+    <script src="rangy-classapplier.js"></script>
+    <script src="rangy-highlighter.js"></script>
+    <script src="rangy-selectionsaverestore.js"></script>
+    <script src="rangy-serializer.js"></script>
+    <script src="rangy-textrange.js"></script>
+    <script>
+        // DRM: onLoad does not get called when offline, if there's remote content in the editor
+        // (such as remote images).  We use the 'ready' event for this reason.
+        //
         $(document).ready(function() {
-          ZSSEditor.init();
-          ZSSEditor.domLoadedCallback();
-          console.log("ZSSEditor initialized");
+            ZSSEditor.init();
+            ZSSEditor.domLoadedCallback();
         });
     </script>
+    <link rel="stylesheet" href="editor.css">
+    <link rel="stylesheet" href="editor-android.css">
   </head>
   <body>
-      <div contenteditable="false" id="zss_field_title" class="field" nostyle>
+      <div contenteditable="true" id="zss_field_title" class="field" nostyle>
       </div>
       <div contenteditable="false" id="separatorDiv" >
-          <hr/>
+          <hr>
       </div>
-      <div contenteditable="false" id="zss_field_content" class="field">
+      <div contenteditable="true" id="zss_field_content" class="field">
       </div>
   </body>
 </html>
diff --git a/libs/editor-common/assets/editor-android.css b/libs/editor-common/assets/editor-android.css
new file mode 100644
index 000000000000..054e561ecdba
--- /dev/null
+++ b/libs/editor-common/assets/editor-android.css
@@ -0,0 +1,13 @@
+@media screen and (min-width: 720px) and (max-width: 1279px) {
+    body {
+        padding-left:80px;
+        padding-right:80px;
+    }
+}
+
+@media screen and (min-width: 1280px){
+    body {
+        padding-left:160px;
+        padding-right:160px;
+    }
+}
\ No newline at end of file
diff --git a/libs/editor-common/assets/editor.css b/libs/editor-common/assets/editor.css
new file mode 100644
index 000000000000..4cdf2a35c2aa
--- /dev/null
+++ b/libs/editor-common/assets/editor.css
@@ -0,0 +1,303 @@
+@font-face {
+    font-family: 'OpenSans';
+    src: local("OpenSans");
+    font-weight: normal;
+    font-style: normal;
+}
+@font-face {
+    font-family: 'OpenSans';
+    src: local("OpenSans-Italic");
+    font-weight: normal;
+    font-style: italic;
+}
+@font-face {
+    font-family: 'OpenSans';
+    src: local("OpenSans-Bold");
+    font-weight: bold;
+    font-style: normal;
+}
+@font-face {
+    font-family: 'OpenSans';
+    src: local("OpenSans-BoldItalic");
+    font-weight: bold;
+    font-style: italic;
+}
+
+* {outline: 0px solid transparent;
+    -webkit-tap-highlight-color: rgba(0,0,0,0);
+    -webkit-touch-callout: none;
+}
+
+html {
+    padding:0;
+    box-sizing: border-box;
+}
+
+html, body {
+    margin:0;
+    font-family:OpenSans, sans-serif;
+    font-size:1em;
+    color:#2D2D2D;
+}
+
+body {
+    padding-left:5px;
+    padding-right:5px;
+    padding-top: 0px;
+    padding-bottom: 0px;
+    overflow-y: auto;
+    min-height: 100vh;
+    word-wrap: break-word;
+}
+
+p {
+    line-height: 24px;
+    margin-top: 0px;
+    margin-bottom: 24px;
+}
+
+hr {
+    border: none;
+    height: 1px;
+    color: #e8f0f5;
+    background-color: #e8f0f5;
+    width: 100%;
+}
+
+img {
+    width: auto;
+    height: auto;
+    margin: 0px 0 0px 0;
+    min-width: 30px;
+    min-height: 30px;
+    max-width: 100%;
+    opacity:1;
+}
+
+a {
+    color: #0087be;
+    text-decoration: none;
+}
+
+blockquote {
+    background: #e8f0f5;
+    padding: 10px 10px 10px 20px;
+    margin: 10px 0 10px 0;
+    border-radius: 2px;
+}
+
+img.zs_active {
+    border: 2px dashed #000;
+}
+
+img.uploading {
+    opacity:0.3;
+    -webkit-user-select: none;
+}
+
+img.failed {
+    -webkit-filter: blur(4px) grayscale(0.3);
+    margin:-1px;
+    padding:1px;
+    z-index:-1;
+    -webkit-user-select: none;
+    overflow: hidden;
+}
+
+span.img_container {
+    position: relative;
+    display: inline-block;
+    -webkit-user-select: none;
+}
+
+span.img_container.failed {
+    overflow: hidden;
+}
+
+span.img_container.failed::before {
+    position: absolute;
+    top: 50%;
+    -webkit-transform: translateY(-50%);
+    left:0%;
+    text-align: center;
+    color: white;
+    width:100%;
+    height:85px;
+    opacity:1;
+    z-index:10;
+    -webkit-user-select: none;
+    pointer-events: none;
+    content:"";
+    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="54" height="54" viewBox="0 0 124 124"><circle fill="none" stroke="#FFFFFF" stroke-width="4"  cx="62" cy="62" r="60"/><path d="M79.0637899,40.93125 C74.1838649,36.0375 67.4465291,33 59.9831144,33 C45.0562852,33 33,45.0825 33,60 C33,74.9175 45.0562852,87 59.9831144,87 C72.5628518,87 83.0994371,78.39375 86.0881801,66.75 L79.0637899,66.75 C76.2776735,74.61375 68.8142589,80.25 59.9831144,80.25 C48.7879925,80.25 39.7204503,71.188125 39.7204503,60 C39.7204503,48.811875 48.7879925,39.75 59.9831144,39.75 C65.5722326,39.75 70.587242,42.07875 74.2514071,45.740625 L63.3602251,56.625 L87,56.625 L87,33 L79.0637899,40.93125 L79.0637899,40.93125 Z" fill="#FFFFFF"/></svg>') no-repeat center top;
+}
+
+span.img_container.failed.largeFail::before {
+    height:170px;
+    background:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="124" height="124" viewBox="0 0 124 124"><circle fill="none" stroke="#FFFFFF" stroke-width="4"  cx="62" cy="62" r="60"></circle><path d="M79.0637899,40.93125 C74.1838649,36.0375 67.4465291,33 59.9831144,33 C45.0562852,33 33,45.0825 33,60 C33,74.9175 45.0562852,87 59.9831144,87 C72.5628518,87 83.0994371,78.39375 86.0881801,66.75 L79.0637899,66.75 C76.2776735,74.61375 68.8142589,80.25 59.9831144,80.25 C48.7879925,80.25 39.7204503,71.188125 39.7204503,60 C39.7204503,48.811875 48.7879925,39.75 59.9831144,39.75 C65.5722326,39.75 70.587242,42.07875 74.2514071,45.740625 L63.3602251,56.625 L87,56.625 L87,33 L79.0637899,40.93125 L79.0637899,40.93125 Z" fill="#FFFFFF" ></path></svg>') no-repeat center top;
+}
+
+span.img_container.failed::after {
+    position: absolute;
+    padding:27px 0 0 0;
+    top:50%;
+    left:0%;
+    font-size:20px;
+    font-weight:600;
+    text-align: center;
+    text-shadow: 0 1px 2px rgba(0,0,0,.06);
+    background:clear;
+    color: white;
+    width:100%;
+    height:50%;
+    -webkit-user-select: none;
+    pointer-events: none;
+    content:attr(data-failed);
+}
+
+span.img_container.failed.largeFail::after {
+    padding:62px 0 0 0;
+}
+
+span.img_container.failed.smallFail::after {
+    content:attr(data-failed);
+}
+
+/* Image editing overlay styles */
+.edit-container {
+    position: relative;
+    display: inline-block;
+    -webkit-user-select: none;
+    overflow: hidden;
+}
+
+.edit-container img {
+    -webkit-filter: blur(4px) grayscale(0.3);
+    margin:-1px; /*tiny margin to keep crisp edges when blurring the image*/
+    padding:1px;
+}
+
+/* default. use when images are > 100px w/h */
+.edit-container .edit-overlay {
+    position: absolute;
+    width:100%;
+    top: 50%;
+    -webkit-transform: translateY(-50%);
+    width:100%;
+    z-index: 100;
+    height:95px;
+    background:url('data:image/svg+xml;utf8,<svg width="60px" height="60px" viewBox="0 0 120 120" version="1.1" opacity="0.9" xmlns="http://www.w3.org/2000/svg"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g transform="translate(2.000000, 2.000000)"><circle stroke="#FFFFFF" stroke-width="4" cx="58" cy="58" r="58"></circle><path d="M31.28125,85.4375 L49.28125,85.4375 L85.28125,49.4375 L67.28125,31.4375 L31.28125,67.4375 L31.28125,85.4375 Z M71.1383929,43.0089286 L47.2321429,66.9151786 L43.375,63.0580357 L67.28125,39.1517857 L71.1383929,43.0089286 Z M53.6607143,73.34375 L49.8035714,69.4866071 L73.7098214,45.5803571 L77.5669643,49.4375 L53.6607143,73.34375 Z M36.4241071,72.0089286 L41.5669643,66.8660714 L51.8526786,77.1517857 L46.7098214,82.2946429 L36.4241071,72.0089286 Z" fill="#FFFFFF"></path></g></g></svg>') no-repeat center top;
+    min-height: 95px;
+    min-width: 60px;
+}
+
+/* use when the image is < 100px w/h */
+.edit-container.small .edit-overlay {
+    height:27px;
+    min-height: 27px;
+    min-width: 27px;
+    background:url('data:image/svg+xml;utf8,<svg width="27px" height="27px" viewBox="0 0 54 54" version="1.1" xmlns="http://www.w3.org/2000/svg" opacity="0.9"><g stroke="none" stroke-width="1" fill="none" fill-rule="evenodd"><g fill="#FFFFFF"><path d="M0,54 L18,54 L54,18 L36,0 L0,36 L0,54 Z M39.8571429,11.5714286 L15.9508929,35.4776786 L12.09375,31.6205357 L36,7.71428571 L39.8571429,11.5714286 Z M22.3794643,41.90625 L18.5223214,38.0491071 L42.4285714,14.1428571 L46.2857143,18 L22.3794643,41.90625 Z M5.14285714,40.5714286 L10.2857143,35.4285714 L20.5714286,45.7142857 L15.4285714,50.8571429 L5.14285714,40.5714286 Z"></path></g></g></svg>') no-repeat center top;
+}
+
+.edit-container.small .edit-content {
+    display:none;
+}
+
+.edit-container .edit-content {
+    font-size:20px;
+    font-weight:600;
+    text-align: center;
+    text-shadow: 0px 1px 2px rgba(0,0,0,.06);
+    color: white;
+    -webkit-user-select: none;
+    pointer-events: none;
+    position: absolute;
+    bottom: 0;
+    width:100%;
+}
+
+progress.wp_media_indicator {
+    /* Reset the default appearance */
+    -webkit-appearance: none;
+    -webkit-user-select: none;
+    appearance: none;
+    position: absolute;
+    top:-2pt; height:2pt;
+    left:0px; width:100%;
+}
+
+progress.wp_media_indicator::-webkit-progress-bar {
+    background-color: rgba(232,240,247,1.0);
+}
+
+progress.wp_media_indicator::-webkit-progress-value {
+    background-color:rgba(0,135,190,1.0);
+    border-radius: 0 2pt 2pt 0;
+}
+
+progress.wp_media_indicator.failed::-webkit-progress-bar {
+    background-color: rgba(232,232,232,1.0);
+}
+
+progress.wp_media_indicator.failed::-webkit-progress-value {
+    background-color:rgba(135,135,135,1.0);
+    border-radius: 0 2pt 2pt 0;
+}
+
+
+div.field[contenteditable] {
+    padding: 15px 10px 5px 10px;
+    box-sizing: border-box;
+    font-size: 16px;
+}
+
+div.field[placeholderText][contenteditable=true]:empty:before {
+    content: attr(placeholderText);
+    transition: 0.2s ease opacity;
+}
+
+div.field[placeholderText][contenteditable=true]:empty:focus:before {
+    opacity: 0.6;
+}
+
+#separatorDiv {
+    -webkit-user-select: none;
+    padding-left: 10px;
+    padding-right: 10px;
+}
+
+#zss_field_title, #zss_field_title p {
+    font-family:'Merriweather', serif;
+    font-weight: bold;
+    font-size: 18px;
+    margin-bottom: 0px;
+}
+
+#zss_field_content {
+    margin-bottom: 10px;
+}
+
+.wp-temp[data-wp-temp="caption"] {
+    -webkit-user-select: none;
+}
+
+.wp-caption {
+    padding: 0px 10px 10px 0px;
+    font-size: 75%;
+    font-style: italic;
+    cursor: none;
+}
+
+.ipad_body {
+    padding-left: 80px;
+    padding-right: 80px;
+}
+
+.ipad_field_title {
+    font-size: 1.3em;
+}
+
+.ipad_field_content {
+    font-size: 1.125em;
+    line-height: 28px;
+}
+}
\ No newline at end of file
diff --git a/libs/editor-common/assets/example-content.html b/libs/editor-common/assets/example-content.html
new file mode 100644
index 000000000000..a1a607968e25
--- /dev/null
+++ b/libs/editor-common/assets/example-content.html
@@ -0,0 +1,53 @@
+<p>
+I'm a test post.
+
+<strong>Bold text</strong>
+
+<em>Italic text</em>
+
+<a href="http://www.wordpress.com">I'm a link!</a>
+
+<!--more-->
+
+<del datetime="2014-05-19T20:55:58+00:00">Strikethrough</del>
+
+Moar Text.
+</p>
+<p>
+Code:
+<code>
+    10 PRINT "HOWDY WORLD"
+    20 GOTO 10
+</code>
+</p>
+<p>
+Unordered List:
+<ul>
+	<li>One</li>
+	<li>Two</li>
+	<li>Three</li>
+</ul>
+</p>
+<p>
+Ordered List:
+<ol>
+	<li>One</li>
+	<li>Two</li>
+	<li>Three</li>
+</ol>
+</p>
+<p>
+Master cleanse Intelligentsia butcher Brooklyn Tumblr. Etsy lo-fi Marfa bicycle rights. Intelligentsia Helvetica fanny pack, normcore Odd Future fixie brunch mustache aesthetic kitsch artisan cardigan mlkshk. Pour-over hashtag selfies pug Tumblr mlkshk. Food truck small batch McSweeney's trust fund, Intelligentsia bitters Brooklyn twee meh authentic. Normcore distillery American Apparel single-origin coffee artisan try-hard, stumptown XOXO tote bag fanny pack Blue Bottle Shoreditch food truck Banksy. Church-key American Apparel Blue Bottle, swag try-hard Odd Future mustache chia iPhone.
+</p>
+<p>
+Block Quote:
+<blockquote>Kale chips Schlitz forage irony, kogi Tumblr Carles chillwave Etsy pug photo booth YOLO biodiesel tote bag actually. PBR Portland yr pickled, bespoke meggings selvage letterpress kitsch plaid before they sold out put a bird on it you probably haven't heard of them. Yr master cleanse slow-carb crucifix, sustainable keytar Helvetica Tumblr High Life mumblecore narwhal cornhole deep v craft beer. Portland forage hashtag locavore, before they sold out put a bird on it irony hella. Godard kale chips street art tote bag cardigan. Church-key next level seitan keytar meggings Portland. Keffiyeh flexitarian post-ironic drinking vinegar wayfarers.</blockquote>
+</p>
+<p>
+Image:<br/><br/>
+
+<img src="http://cdn.buzznet.com/assets/users16/yasfx/default/crazy-cat-fashions-sheriff-style--large-msg-128933191905.jpg" alt="Cowboy Cat" />
+</p>
+<p>
+Fanny pack Odd Future Intelligentsia lo-fi semiotics whatever. Selvage keffiyeh mustache sustainable ethnic, chambray mumblecore McSweeney's biodiesel Pitchfork four loko disrupt post-ironic art party American Apparel. Kitsch umami beard salvia, Vice before they sold out vegan tousled lomo jean shorts pickled PBR&amp;B. Tousled Wes Anderson Shoreditch flannel, 90's XOXO quinoa whatever mumblecore cliche Truffaut stumptown. Photo booth crucifix plaid Brooklyn. Authentic letterpress PBR&amp;B, sustainable VHS master cleanse ethnic High Life. Messenger bag umami pug flannel.
+</p>
\ No newline at end of file
diff --git a/libs/editor-common/assets/jquery-2.0.3.min.js b/libs/editor-common/assets/jquery-2.0.3.min.js
deleted file mode 100644
index 2be209dd2233..000000000000
--- a/libs/editor-common/assets/jquery-2.0.3.min.js
+++ /dev/null
@@ -1,6 +0,0 @@
-/*! jQuery v2.0.3 | (c) 2005, 2013 jQuery Foundation, Inc. | jquery.org/license
-//@ sourceMappingURL=jquery-2.0.3.min.map
-*/
-(function(e,undefined){var t,n,r=typeof undefined,i=e.location,o=e.document,s=o.documentElement,a=e.jQuery,u=e.$,l={},c=[],p="2.0.3",f=c.concat,h=c.push,d=c.slice,g=c.indexOf,m=l.toString,y=l.hasOwnProperty,v=p.trim,x=function(e,n){return new x.fn.init(e,n,t)},b=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,w=/\S+/g,T=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,C=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,k=/^-ms-/,N=/-([\da-z])/gi,E=function(e,t){return t.toUpperCase()},S=function(){o.removeEventListener("DOMContentLoaded",S,!1),e.removeEventListener("load",S,!1),x.ready()};x.fn=x.prototype={jquery:p,constructor:x,init:function(e,t,n){var r,i;if(!e)return this;if("string"==typeof e){if(r="<"===e.charAt(0)&&">"===e.charAt(e.length-1)&&e.length>=3?[null,e,null]:T.exec(e),!r||!r[1]&&t)return!t||t.jquery?(t||n).find(e):this.constructor(t).find(e);if(r[1]){if(t=t instanceof x?t[0]:t,x.merge(this,x.parseHTML(r[1],t&&t.nodeType?t.ownerDocument||t:o,!0)),C.test(r[1])&&x.isPlainObject(t))for(r in t)x.isFunction(this[r])?this[r](t[r]):this.attr(r,t[r]);return this}return i=o.getElementById(r[2]),i&&i.parentNode&&(this.length=1,this[0]=i),this.context=o,this.selector=e,this}return e.nodeType?(this.context=this[0]=e,this.length=1,this):x.isFunction(e)?n.ready(e):(e.selector!==undefined&&(this.selector=e.selector,this.context=e.context),x.makeArray(e,this))},selector:"",length:0,toArray:function(){return d.call(this)},get:function(e){return null==e?this.toArray():0>e?this[this.length+e]:this[e]},pushStack:function(e){var t=x.merge(this.constructor(),e);return t.prevObject=this,t.context=this.context,t},each:function(e,t){return x.each(this,e,t)},ready:function(e){return x.ready.promise().done(e),this},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(e){var t=this.length,n=+e+(0>e?t:0);return this.pushStack(n>=0&&t>n?[this[n]]:[])},map:function(e){return this.pushStack(x.map(this,function(t,n){return e.call(t,n,t)}))},end:function(){return this.prevObject||this.constructor(null)},push:h,sort:[].sort,splice:[].splice},x.fn.init.prototype=x.fn,x.extend=x.fn.extend=function(){var e,t,n,r,i,o,s=arguments[0]||{},a=1,u=arguments.length,l=!1;for("boolean"==typeof s&&(l=s,s=arguments[1]||{},a=2),"object"==typeof s||x.isFunction(s)||(s={}),u===a&&(s=this,--a);u>a;a++)if(null!=(e=arguments[a]))for(t in e)n=s[t],r=e[t],s!==r&&(l&&r&&(x.isPlainObject(r)||(i=x.isArray(r)))?(i?(i=!1,o=n&&x.isArray(n)?n:[]):o=n&&x.isPlainObject(n)?n:{},s[t]=x.extend(l,o,r)):r!==undefined&&(s[t]=r));return s},x.extend({expando:"jQuery"+(p+Math.random()).replace(/\D/g,""),noConflict:function(t){return e.$===x&&(e.$=u),t&&e.jQuery===x&&(e.jQuery=a),x},isReady:!1,readyWait:1,holdReady:function(e){e?x.readyWait++:x.ready(!0)},ready:function(e){(e===!0?--x.readyWait:x.isReady)||(x.isReady=!0,e!==!0&&--x.readyWait>0||(n.resolveWith(o,[x]),x.fn.trigger&&x(o).trigger("ready").off("ready")))},isFunction:function(e){return"function"===x.type(e)},isArray:Array.isArray,isWindow:function(e){return null!=e&&e===e.window},isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},type:function(e){return null==e?e+"":"object"==typeof e||"function"==typeof e?l[m.call(e)]||"object":typeof e},isPlainObject:function(e){if("object"!==x.type(e)||e.nodeType||x.isWindow(e))return!1;try{if(e.constructor&&!y.call(e.constructor.prototype,"isPrototypeOf"))return!1}catch(t){return!1}return!0},isEmptyObject:function(e){var t;for(t in e)return!1;return!0},error:function(e){throw Error(e)},parseHTML:function(e,t,n){if(!e||"string"!=typeof e)return null;"boolean"==typeof t&&(n=t,t=!1),t=t||o;var r=C.exec(e),i=!n&&[];return r?[t.createElement(r[1])]:(r=x.buildFragment([e],t,i),i&&x(i).remove(),x.merge([],r.childNodes))},parseJSON:JSON.parse,parseXML:function(e){var t,n;if(!e||"string"!=typeof e)return null;try{n=new DOMParser,t=n.parseFromString(e,"text/xml")}catch(r){t=undefined}return(!t||t.getElementsByTagName("parsererror").length)&&x.error("Invalid XML: "+e),t},noop:function(){},globalEval:function(e){var t,n=eval;e=x.trim(e),e&&(1===e.indexOf("use strict")?(t=o.createElement("script"),t.text=e,o.head.appendChild(t).parentNode.removeChild(t)):n(e))},camelCase:function(e){return e.replace(k,"ms-").replace(N,E)},nodeName:function(e,t){return e.nodeName&&e.nodeName.toLowerCase()===t.toLowerCase()},each:function(e,t,n){var r,i=0,o=e.length,s=j(e);if(n){if(s){for(;o>i;i++)if(r=t.apply(e[i],n),r===!1)break}else for(i in e)if(r=t.apply(e[i],n),r===!1)break}else if(s){for(;o>i;i++)if(r=t.call(e[i],i,e[i]),r===!1)break}else for(i in e)if(r=t.call(e[i],i,e[i]),r===!1)break;return e},trim:function(e){return null==e?"":v.call(e)},makeArray:function(e,t){var n=t||[];return null!=e&&(j(Object(e))?x.merge(n,"string"==typeof e?[e]:e):h.call(n,e)),n},inArray:function(e,t,n){return null==t?-1:g.call(t,e,n)},merge:function(e,t){var n=t.length,r=e.length,i=0;if("number"==typeof n)for(;n>i;i++)e[r++]=t[i];else while(t[i]!==undefined)e[r++]=t[i++];return e.length=r,e},grep:function(e,t,n){var r,i=[],o=0,s=e.length;for(n=!!n;s>o;o++)r=!!t(e[o],o),n!==r&&i.push(e[o]);return i},map:function(e,t,n){var r,i=0,o=e.length,s=j(e),a=[];if(s)for(;o>i;i++)r=t(e[i],i,n),null!=r&&(a[a.length]=r);else for(i in e)r=t(e[i],i,n),null!=r&&(a[a.length]=r);return f.apply([],a)},guid:1,proxy:function(e,t){var n,r,i;return"string"==typeof t&&(n=e[t],t=e,e=n),x.isFunction(e)?(r=d.call(arguments,2),i=function(){return e.apply(t||this,r.concat(d.call(arguments)))},i.guid=e.guid=e.guid||x.guid++,i):undefined},access:function(e,t,n,r,i,o,s){var a=0,u=e.length,l=null==n;if("object"===x.type(n)){i=!0;for(a in n)x.access(e,t,a,n[a],!0,o,s)}else if(r!==undefined&&(i=!0,x.isFunction(r)||(s=!0),l&&(s?(t.call(e,r),t=null):(l=t,t=function(e,t,n){return l.call(x(e),n)})),t))for(;u>a;a++)t(e[a],n,s?r:r.call(e[a],a,t(e[a],n)));return i?e:l?t.call(e):u?t(e[0],n):o},now:Date.now,swap:function(e,t,n,r){var i,o,s={};for(o in t)s[o]=e.style[o],e.style[o]=t[o];i=n.apply(e,r||[]);for(o in t)e.style[o]=s[o];return i}}),x.ready.promise=function(t){return n||(n=x.Deferred(),"complete"===o.readyState?setTimeout(x.ready):(o.addEventListener("DOMContentLoaded",S,!1),e.addEventListener("load",S,!1))),n.promise(t)},x.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(e,t){l["[object "+t+"]"]=t.toLowerCase()});function j(e){var t=e.length,n=x.type(e);return x.isWindow(e)?!1:1===e.nodeType&&t?!0:"array"===n||"function"!==n&&(0===t||"number"==typeof t&&t>0&&t-1 in e)}t=x(o),function(e,undefined){var t,n,r,i,o,s,a,u,l,c,p,f,h,d,g,m,y,v="sizzle"+-new Date,b=e.document,w=0,T=0,C=st(),k=st(),N=st(),E=!1,S=function(e,t){return e===t?(E=!0,0):0},j=typeof undefined,D=1<<31,A={}.hasOwnProperty,L=[],q=L.pop,H=L.push,O=L.push,F=L.slice,P=L.indexOf||function(e){var t=0,n=this.length;for(;n>t;t++)if(this[t]===e)return t;return-1},R="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",M="[\\x20\\t\\r\\n\\f]",W="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",$=W.replace("w","w#"),B="\\["+M+"*("+W+")"+M+"*(?:([*^$|!~]?=)"+M+"*(?:(['\"])((?:\\\\.|[^\\\\])*?)\\3|("+$+")|)|)"+M+"*\\]",I=":("+W+")(?:\\(((['\"])((?:\\\\.|[^\\\\])*?)\\3|((?:\\\\.|[^\\\\()[\\]]|"+B.replace(3,8)+")*)|.*)\\)|)",z=RegExp("^"+M+"+|((?:^|[^\\\\])(?:\\\\.)*)"+M+"+$","g"),_=RegExp("^"+M+"*,"+M+"*"),X=RegExp("^"+M+"*([>+~]|"+M+")"+M+"*"),U=RegExp(M+"*[+~]"),Y=RegExp("="+M+"*([^\\]'\"]*)"+M+"*\\]","g"),V=RegExp(I),G=RegExp("^"+$+"$"),J={ID:RegExp("^#("+W+")"),CLASS:RegExp("^\\.("+W+")"),TAG:RegExp("^("+W.replace("w","w*")+")"),ATTR:RegExp("^"+B),PSEUDO:RegExp("^"+I),CHILD:RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+M+"*(even|odd|(([+-]|)(\\d*)n|)"+M+"*(?:([+-]|)"+M+"*(\\d+)|))"+M+"*\\)|)","i"),bool:RegExp("^(?:"+R+")$","i"),needsContext:RegExp("^"+M+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+M+"*((?:-\\d)?\\d*)"+M+"*\\)|)(?=[^-]|$)","i")},Q=/^[^{]+\{\s*\[native \w/,K=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,Z=/^(?:input|select|textarea|button)$/i,et=/^h\d$/i,tt=/'|\\/g,nt=RegExp("\\\\([\\da-f]{1,6}"+M+"?|("+M+")|.)","ig"),rt=function(e,t,n){var r="0x"+t-65536;return r!==r||n?t:0>r?String.fromCharCode(r+65536):String.fromCharCode(55296|r>>10,56320|1023&r)};try{O.apply(L=F.call(b.childNodes),b.childNodes),L[b.childNodes.length].nodeType}catch(it){O={apply:L.length?function(e,t){H.apply(e,F.call(t))}:function(e,t){var n=e.length,r=0;while(e[n++]=t[r++]);e.length=n-1}}}function ot(e,t,r,i){var o,s,a,u,l,f,g,m,x,w;if((t?t.ownerDocument||t:b)!==p&&c(t),t=t||p,r=r||[],!e||"string"!=typeof e)return r;if(1!==(u=t.nodeType)&&9!==u)return[];if(h&&!i){if(o=K.exec(e))if(a=o[1]){if(9===u){if(s=t.getElementById(a),!s||!s.parentNode)return r;if(s.id===a)return r.push(s),r}else if(t.ownerDocument&&(s=t.ownerDocument.getElementById(a))&&y(t,s)&&s.id===a)return r.push(s),r}else{if(o[2])return O.apply(r,t.getElementsByTagName(e)),r;if((a=o[3])&&n.getElementsByClassName&&t.getElementsByClassName)return O.apply(r,t.getElementsByClassName(a)),r}if(n.qsa&&(!d||!d.test(e))){if(m=g=v,x=t,w=9===u&&e,1===u&&"object"!==t.nodeName.toLowerCase()){f=gt(e),(g=t.getAttribute("id"))?m=g.replace(tt,"\\$&"):t.setAttribute("id",m),m="[id='"+m+"'] ",l=f.length;while(l--)f[l]=m+mt(f[l]);x=U.test(e)&&t.parentNode||t,w=f.join(",")}if(w)try{return O.apply(r,x.querySelectorAll(w)),r}catch(T){}finally{g||t.removeAttribute("id")}}}return kt(e.replace(z,"$1"),t,r,i)}function st(){var e=[];function t(n,r){return e.push(n+=" ")>i.cacheLength&&delete t[e.shift()],t[n]=r}return t}function at(e){return e[v]=!0,e}function ut(e){var t=p.createElement("div");try{return!!e(t)}catch(n){return!1}finally{t.parentNode&&t.parentNode.removeChild(t),t=null}}function lt(e,t){var n=e.split("|"),r=e.length;while(r--)i.attrHandle[n[r]]=t}function ct(e,t){var n=t&&e,r=n&&1===e.nodeType&&1===t.nodeType&&(~t.sourceIndex||D)-(~e.sourceIndex||D);if(r)return r;if(n)while(n=n.nextSibling)if(n===t)return-1;return e?1:-1}function pt(e){return function(t){var n=t.nodeName.toLowerCase();return"input"===n&&t.type===e}}function ft(e){return function(t){var n=t.nodeName.toLowerCase();return("input"===n||"button"===n)&&t.type===e}}function ht(e){return at(function(t){return t=+t,at(function(n,r){var i,o=e([],n.length,t),s=o.length;while(s--)n[i=o[s]]&&(n[i]=!(r[i]=n[i]))})})}s=ot.isXML=function(e){var t=e&&(e.ownerDocument||e).documentElement;return t?"HTML"!==t.nodeName:!1},n=ot.support={},c=ot.setDocument=function(e){var t=e?e.ownerDocument||e:b,r=t.defaultView;return t!==p&&9===t.nodeType&&t.documentElement?(p=t,f=t.documentElement,h=!s(t),r&&r.attachEvent&&r!==r.top&&r.attachEvent("onbeforeunload",function(){c()}),n.attributes=ut(function(e){return e.className="i",!e.getAttribute("className")}),n.getElementsByTagName=ut(function(e){return e.appendChild(t.createComment("")),!e.getElementsByTagName("*").length}),n.getElementsByClassName=ut(function(e){return e.innerHTML="<div class='a'></div><div class='a i'></div>",e.firstChild.className="i",2===e.getElementsByClassName("i").length}),n.getById=ut(function(e){return f.appendChild(e).id=v,!t.getElementsByName||!t.getElementsByName(v).length}),n.getById?(i.find.ID=function(e,t){if(typeof t.getElementById!==j&&h){var n=t.getElementById(e);return n&&n.parentNode?[n]:[]}},i.filter.ID=function(e){var t=e.replace(nt,rt);return function(e){return e.getAttribute("id")===t}}):(delete i.find.ID,i.filter.ID=function(e){var t=e.replace(nt,rt);return function(e){var n=typeof e.getAttributeNode!==j&&e.getAttributeNode("id");return n&&n.value===t}}),i.find.TAG=n.getElementsByTagName?function(e,t){return typeof t.getElementsByTagName!==j?t.getElementsByTagName(e):undefined}:function(e,t){var n,r=[],i=0,o=t.getElementsByTagName(e);if("*"===e){while(n=o[i++])1===n.nodeType&&r.push(n);return r}return o},i.find.CLASS=n.getElementsByClassName&&function(e,t){return typeof t.getElementsByClassName!==j&&h?t.getElementsByClassName(e):undefined},g=[],d=[],(n.qsa=Q.test(t.querySelectorAll))&&(ut(function(e){e.innerHTML="<select><option selected=''></option></select>",e.querySelectorAll("[selected]").length||d.push("\\["+M+"*(?:value|"+R+")"),e.querySelectorAll(":checked").length||d.push(":checked")}),ut(function(e){var n=t.createElement("input");n.setAttribute("type","hidden"),e.appendChild(n).setAttribute("t",""),e.querySelectorAll("[t^='']").length&&d.push("[*^$]="+M+"*(?:''|\"\")"),e.querySelectorAll(":enabled").length||d.push(":enabled",":disabled"),e.querySelectorAll("*,:x"),d.push(",.*:")})),(n.matchesSelector=Q.test(m=f.webkitMatchesSelector||f.mozMatchesSelector||f.oMatchesSelector||f.msMatchesSelector))&&ut(function(e){n.disconnectedMatch=m.call(e,"div"),m.call(e,"[s!='']:x"),g.push("!=",I)}),d=d.length&&RegExp(d.join("|")),g=g.length&&RegExp(g.join("|")),y=Q.test(f.contains)||f.compareDocumentPosition?function(e,t){var n=9===e.nodeType?e.documentElement:e,r=t&&t.parentNode;return e===r||!(!r||1!==r.nodeType||!(n.contains?n.contains(r):e.compareDocumentPosition&&16&e.compareDocumentPosition(r)))}:function(e,t){if(t)while(t=t.parentNode)if(t===e)return!0;return!1},S=f.compareDocumentPosition?function(e,r){if(e===r)return E=!0,0;var i=r.compareDocumentPosition&&e.compareDocumentPosition&&e.compareDocumentPosition(r);return i?1&i||!n.sortDetached&&r.compareDocumentPosition(e)===i?e===t||y(b,e)?-1:r===t||y(b,r)?1:l?P.call(l,e)-P.call(l,r):0:4&i?-1:1:e.compareDocumentPosition?-1:1}:function(e,n){var r,i=0,o=e.parentNode,s=n.parentNode,a=[e],u=[n];if(e===n)return E=!0,0;if(!o||!s)return e===t?-1:n===t?1:o?-1:s?1:l?P.call(l,e)-P.call(l,n):0;if(o===s)return ct(e,n);r=e;while(r=r.parentNode)a.unshift(r);r=n;while(r=r.parentNode)u.unshift(r);while(a[i]===u[i])i++;return i?ct(a[i],u[i]):a[i]===b?-1:u[i]===b?1:0},t):p},ot.matches=function(e,t){return ot(e,null,null,t)},ot.matchesSelector=function(e,t){if((e.ownerDocument||e)!==p&&c(e),t=t.replace(Y,"='$1']"),!(!n.matchesSelector||!h||g&&g.test(t)||d&&d.test(t)))try{var r=m.call(e,t);if(r||n.disconnectedMatch||e.document&&11!==e.document.nodeType)return r}catch(i){}return ot(t,p,null,[e]).length>0},ot.contains=function(e,t){return(e.ownerDocument||e)!==p&&c(e),y(e,t)},ot.attr=function(e,t){(e.ownerDocument||e)!==p&&c(e);var r=i.attrHandle[t.toLowerCase()],o=r&&A.call(i.attrHandle,t.toLowerCase())?r(e,t,!h):undefined;return o===undefined?n.attributes||!h?e.getAttribute(t):(o=e.getAttributeNode(t))&&o.specified?o.value:null:o},ot.error=function(e){throw Error("Syntax error, unrecognized expression: "+e)},ot.uniqueSort=function(e){var t,r=[],i=0,o=0;if(E=!n.detectDuplicates,l=!n.sortStable&&e.slice(0),e.sort(S),E){while(t=e[o++])t===e[o]&&(i=r.push(o));while(i--)e.splice(r[i],1)}return e},o=ot.getText=function(e){var t,n="",r=0,i=e.nodeType;if(i){if(1===i||9===i||11===i){if("string"==typeof e.textContent)return e.textContent;for(e=e.firstChild;e;e=e.nextSibling)n+=o(e)}else if(3===i||4===i)return e.nodeValue}else for(;t=e[r];r++)n+=o(t);return n},i=ot.selectors={cacheLength:50,createPseudo:at,match:J,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(e){return e[1]=e[1].replace(nt,rt),e[3]=(e[4]||e[5]||"").replace(nt,rt),"~="===e[2]&&(e[3]=" "+e[3]+" "),e.slice(0,4)},CHILD:function(e){return e[1]=e[1].toLowerCase(),"nth"===e[1].slice(0,3)?(e[3]||ot.error(e[0]),e[4]=+(e[4]?e[5]+(e[6]||1):2*("even"===e[3]||"odd"===e[3])),e[5]=+(e[7]+e[8]||"odd"===e[3])):e[3]&&ot.error(e[0]),e},PSEUDO:function(e){var t,n=!e[5]&&e[2];return J.CHILD.test(e[0])?null:(e[3]&&e[4]!==undefined?e[2]=e[4]:n&&V.test(n)&&(t=gt(n,!0))&&(t=n.indexOf(")",n.length-t)-n.length)&&(e[0]=e[0].slice(0,t),e[2]=n.slice(0,t)),e.slice(0,3))}},filter:{TAG:function(e){var t=e.replace(nt,rt).toLowerCase();return"*"===e?function(){return!0}:function(e){return e.nodeName&&e.nodeName.toLowerCase()===t}},CLASS:function(e){var t=C[e+" "];return t||(t=RegExp("(^|"+M+")"+e+"("+M+"|$)"))&&C(e,function(e){return t.test("string"==typeof e.className&&e.className||typeof e.getAttribute!==j&&e.getAttribute("class")||"")})},ATTR:function(e,t,n){return function(r){var i=ot.attr(r,e);return null==i?"!="===t:t?(i+="","="===t?i===n:"!="===t?i!==n:"^="===t?n&&0===i.indexOf(n):"*="===t?n&&i.indexOf(n)>-1:"$="===t?n&&i.slice(-n.length)===n:"~="===t?(" "+i+" ").indexOf(n)>-1:"|="===t?i===n||i.slice(0,n.length+1)===n+"-":!1):!0}},CHILD:function(e,t,n,r,i){var o="nth"!==e.slice(0,3),s="last"!==e.slice(-4),a="of-type"===t;return 1===r&&0===i?function(e){return!!e.parentNode}:function(t,n,u){var l,c,p,f,h,d,g=o!==s?"nextSibling":"previousSibling",m=t.parentNode,y=a&&t.nodeName.toLowerCase(),x=!u&&!a;if(m){if(o){while(g){p=t;while(p=p[g])if(a?p.nodeName.toLowerCase()===y:1===p.nodeType)return!1;d=g="only"===e&&!d&&"nextSibling"}return!0}if(d=[s?m.firstChild:m.lastChild],s&&x){c=m[v]||(m[v]={}),l=c[e]||[],h=l[0]===w&&l[1],f=l[0]===w&&l[2],p=h&&m.childNodes[h];while(p=++h&&p&&p[g]||(f=h=0)||d.pop())if(1===p.nodeType&&++f&&p===t){c[e]=[w,h,f];break}}else if(x&&(l=(t[v]||(t[v]={}))[e])&&l[0]===w)f=l[1];else while(p=++h&&p&&p[g]||(f=h=0)||d.pop())if((a?p.nodeName.toLowerCase()===y:1===p.nodeType)&&++f&&(x&&((p[v]||(p[v]={}))[e]=[w,f]),p===t))break;return f-=i,f===r||0===f%r&&f/r>=0}}},PSEUDO:function(e,t){var n,r=i.pseudos[e]||i.setFilters[e.toLowerCase()]||ot.error("unsupported pseudo: "+e);return r[v]?r(t):r.length>1?(n=[e,e,"",t],i.setFilters.hasOwnProperty(e.toLowerCase())?at(function(e,n){var i,o=r(e,t),s=o.length;while(s--)i=P.call(e,o[s]),e[i]=!(n[i]=o[s])}):function(e){return r(e,0,n)}):r}},pseudos:{not:at(function(e){var t=[],n=[],r=a(e.replace(z,"$1"));return r[v]?at(function(e,t,n,i){var o,s=r(e,null,i,[]),a=e.length;while(a--)(o=s[a])&&(e[a]=!(t[a]=o))}):function(e,i,o){return t[0]=e,r(t,null,o,n),!n.pop()}}),has:at(function(e){return function(t){return ot(e,t).length>0}}),contains:at(function(e){return function(t){return(t.textContent||t.innerText||o(t)).indexOf(e)>-1}}),lang:at(function(e){return G.test(e||"")||ot.error("unsupported lang: "+e),e=e.replace(nt,rt).toLowerCase(),function(t){var n;do if(n=h?t.lang:t.getAttribute("xml:lang")||t.getAttribute("lang"))return n=n.toLowerCase(),n===e||0===n.indexOf(e+"-");while((t=t.parentNode)&&1===t.nodeType);return!1}}),target:function(t){var n=e.location&&e.location.hash;return n&&n.slice(1)===t.id},root:function(e){return e===f},focus:function(e){return e===p.activeElement&&(!p.hasFocus||p.hasFocus())&&!!(e.type||e.href||~e.tabIndex)},enabled:function(e){return e.disabled===!1},disabled:function(e){return e.disabled===!0},checked:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&!!e.checked||"option"===t&&!!e.selected},selected:function(e){return e.parentNode&&e.parentNode.selectedIndex,e.selected===!0},empty:function(e){for(e=e.firstChild;e;e=e.nextSibling)if(e.nodeName>"@"||3===e.nodeType||4===e.nodeType)return!1;return!0},parent:function(e){return!i.pseudos.empty(e)},header:function(e){return et.test(e.nodeName)},input:function(e){return Z.test(e.nodeName)},button:function(e){var t=e.nodeName.toLowerCase();return"input"===t&&"button"===e.type||"button"===t},text:function(e){var t;return"input"===e.nodeName.toLowerCase()&&"text"===e.type&&(null==(t=e.getAttribute("type"))||t.toLowerCase()===e.type)},first:ht(function(){return[0]}),last:ht(function(e,t){return[t-1]}),eq:ht(function(e,t,n){return[0>n?n+t:n]}),even:ht(function(e,t){var n=0;for(;t>n;n+=2)e.push(n);return e}),odd:ht(function(e,t){var n=1;for(;t>n;n+=2)e.push(n);return e}),lt:ht(function(e,t,n){var r=0>n?n+t:n;for(;--r>=0;)e.push(r);return e}),gt:ht(function(e,t,n){var r=0>n?n+t:n;for(;t>++r;)e.push(r);return e})}},i.pseudos.nth=i.pseudos.eq;for(t in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})i.pseudos[t]=pt(t);for(t in{submit:!0,reset:!0})i.pseudos[t]=ft(t);function dt(){}dt.prototype=i.filters=i.pseudos,i.setFilters=new dt;function gt(e,t){var n,r,o,s,a,u,l,c=k[e+" "];if(c)return t?0:c.slice(0);a=e,u=[],l=i.preFilter;while(a){(!n||(r=_.exec(a)))&&(r&&(a=a.slice(r[0].length)||a),u.push(o=[])),n=!1,(r=X.exec(a))&&(n=r.shift(),o.push({value:n,type:r[0].replace(z," ")}),a=a.slice(n.length));for(s in i.filter)!(r=J[s].exec(a))||l[s]&&!(r=l[s](r))||(n=r.shift(),o.push({value:n,type:s,matches:r}),a=a.slice(n.length));if(!n)break}return t?a.length:a?ot.error(e):k(e,u).slice(0)}function mt(e){var t=0,n=e.length,r="";for(;n>t;t++)r+=e[t].value;return r}function yt(e,t,n){var i=t.dir,o=n&&"parentNode"===i,s=T++;return t.first?function(t,n,r){while(t=t[i])if(1===t.nodeType||o)return e(t,n,r)}:function(t,n,a){var u,l,c,p=w+" "+s;if(a){while(t=t[i])if((1===t.nodeType||o)&&e(t,n,a))return!0}else while(t=t[i])if(1===t.nodeType||o)if(c=t[v]||(t[v]={}),(l=c[i])&&l[0]===p){if((u=l[1])===!0||u===r)return u===!0}else if(l=c[i]=[p],l[1]=e(t,n,a)||r,l[1]===!0)return!0}}function vt(e){return e.length>1?function(t,n,r){var i=e.length;while(i--)if(!e[i](t,n,r))return!1;return!0}:e[0]}function xt(e,t,n,r,i){var o,s=[],a=0,u=e.length,l=null!=t;for(;u>a;a++)(o=e[a])&&(!n||n(o,r,i))&&(s.push(o),l&&t.push(a));return s}function bt(e,t,n,r,i,o){return r&&!r[v]&&(r=bt(r)),i&&!i[v]&&(i=bt(i,o)),at(function(o,s,a,u){var l,c,p,f=[],h=[],d=s.length,g=o||Ct(t||"*",a.nodeType?[a]:a,[]),m=!e||!o&&t?g:xt(g,f,e,a,u),y=n?i||(o?e:d||r)?[]:s:m;if(n&&n(m,y,a,u),r){l=xt(y,h),r(l,[],a,u),c=l.length;while(c--)(p=l[c])&&(y[h[c]]=!(m[h[c]]=p))}if(o){if(i||e){if(i){l=[],c=y.length;while(c--)(p=y[c])&&l.push(m[c]=p);i(null,y=[],l,u)}c=y.length;while(c--)(p=y[c])&&(l=i?P.call(o,p):f[c])>-1&&(o[l]=!(s[l]=p))}}else y=xt(y===s?y.splice(d,y.length):y),i?i(null,s,y,u):O.apply(s,y)})}function wt(e){var t,n,r,o=e.length,s=i.relative[e[0].type],a=s||i.relative[" "],l=s?1:0,c=yt(function(e){return e===t},a,!0),p=yt(function(e){return P.call(t,e)>-1},a,!0),f=[function(e,n,r){return!s&&(r||n!==u)||((t=n).nodeType?c(e,n,r):p(e,n,r))}];for(;o>l;l++)if(n=i.relative[e[l].type])f=[yt(vt(f),n)];else{if(n=i.filter[e[l].type].apply(null,e[l].matches),n[v]){for(r=++l;o>r;r++)if(i.relative[e[r].type])break;return bt(l>1&&vt(f),l>1&&mt(e.slice(0,l-1).concat({value:" "===e[l-2].type?"*":""})).replace(z,"$1"),n,r>l&&wt(e.slice(l,r)),o>r&&wt(e=e.slice(r)),o>r&&mt(e))}f.push(n)}return vt(f)}function Tt(e,t){var n=0,o=t.length>0,s=e.length>0,a=function(a,l,c,f,h){var d,g,m,y=[],v=0,x="0",b=a&&[],T=null!=h,C=u,k=a||s&&i.find.TAG("*",h&&l.parentNode||l),N=w+=null==C?1:Math.random()||.1;for(T&&(u=l!==p&&l,r=n);null!=(d=k[x]);x++){if(s&&d){g=0;while(m=e[g++])if(m(d,l,c)){f.push(d);break}T&&(w=N,r=++n)}o&&((d=!m&&d)&&v--,a&&b.push(d))}if(v+=x,o&&x!==v){g=0;while(m=t[g++])m(b,y,l,c);if(a){if(v>0)while(x--)b[x]||y[x]||(y[x]=q.call(f));y=xt(y)}O.apply(f,y),T&&!a&&y.length>0&&v+t.length>1&&ot.uniqueSort(f)}return T&&(w=N,u=C),b};return o?at(a):a}a=ot.compile=function(e,t){var n,r=[],i=[],o=N[e+" "];if(!o){t||(t=gt(e)),n=t.length;while(n--)o=wt(t[n]),o[v]?r.push(o):i.push(o);o=N(e,Tt(i,r))}return o};function Ct(e,t,n){var r=0,i=t.length;for(;i>r;r++)ot(e,t[r],n);return n}function kt(e,t,r,o){var s,u,l,c,p,f=gt(e);if(!o&&1===f.length){if(u=f[0]=f[0].slice(0),u.length>2&&"ID"===(l=u[0]).type&&n.getById&&9===t.nodeType&&h&&i.relative[u[1].type]){if(t=(i.find.ID(l.matches[0].replace(nt,rt),t)||[])[0],!t)return r;e=e.slice(u.shift().value.length)}s=J.needsContext.test(e)?0:u.length;while(s--){if(l=u[s],i.relative[c=l.type])break;if((p=i.find[c])&&(o=p(l.matches[0].replace(nt,rt),U.test(u[0].type)&&t.parentNode||t))){if(u.splice(s,1),e=o.length&&mt(u),!e)return O.apply(r,o),r;break}}}return a(e,f)(o,t,!h,r,U.test(e)),r}n.sortStable=v.split("").sort(S).join("")===v,n.detectDuplicates=E,c(),n.sortDetached=ut(function(e){return 1&e.compareDocumentPosition(p.createElement("div"))}),ut(function(e){return e.innerHTML="<a href='#'></a>","#"===e.firstChild.getAttribute("href")})||lt("type|href|height|width",function(e,t,n){return n?undefined:e.getAttribute(t,"type"===t.toLowerCase()?1:2)}),n.attributes&&ut(function(e){return e.innerHTML="<input/>",e.firstChild.setAttribute("value",""),""===e.firstChild.getAttribute("value")})||lt("value",function(e,t,n){return n||"input"!==e.nodeName.toLowerCase()?undefined:e.defaultValue}),ut(function(e){return null==e.getAttribute("disabled")})||lt(R,function(e,t,n){var r;return n?undefined:(r=e.getAttributeNode(t))&&r.specified?r.value:e[t]===!0?t.toLowerCase():null}),x.find=ot,x.expr=ot.selectors,x.expr[":"]=x.expr.pseudos,x.unique=ot.uniqueSort,x.text=ot.getText,x.isXMLDoc=ot.isXML,x.contains=ot.contains}(e);var D={};function A(e){var t=D[e]={};return x.each(e.match(w)||[],function(e,n){t[n]=!0}),t}x.Callbacks=function(e){e="string"==typeof e?D[e]||A(e):x.extend({},e);var t,n,r,i,o,s,a=[],u=!e.once&&[],l=function(p){for(t=e.memory&&p,n=!0,s=i||0,i=0,o=a.length,r=!0;a&&o>s;s++)if(a[s].apply(p[0],p[1])===!1&&e.stopOnFalse){t=!1;break}r=!1,a&&(u?u.length&&l(u.shift()):t?a=[]:c.disable())},c={add:function(){if(a){var n=a.length;(function s(t){x.each(t,function(t,n){var r=x.type(n);"function"===r?e.unique&&c.has(n)||a.push(n):n&&n.length&&"string"!==r&&s(n)})})(arguments),r?o=a.length:t&&(i=n,l(t))}return this},remove:function(){return a&&x.each(arguments,function(e,t){var n;while((n=x.inArray(t,a,n))>-1)a.splice(n,1),r&&(o>=n&&o--,s>=n&&s--)}),this},has:function(e){return e?x.inArray(e,a)>-1:!(!a||!a.length)},empty:function(){return a=[],o=0,this},disable:function(){return a=u=t=undefined,this},disabled:function(){return!a},lock:function(){return u=undefined,t||c.disable(),this},locked:function(){return!u},fireWith:function(e,t){return!a||n&&!u||(t=t||[],t=[e,t.slice?t.slice():t],r?u.push(t):l(t)),this},fire:function(){return c.fireWith(this,arguments),this},fired:function(){return!!n}};return c},x.extend({Deferred:function(e){var t=[["resolve","done",x.Callbacks("once memory"),"resolved"],["reject","fail",x.Callbacks("once memory"),"rejected"],["notify","progress",x.Callbacks("memory")]],n="pending",r={state:function(){return n},always:function(){return i.done(arguments).fail(arguments),this},then:function(){var e=arguments;return x.Deferred(function(n){x.each(t,function(t,o){var s=o[0],a=x.isFunction(e[t])&&e[t];i[o[1]](function(){var e=a&&a.apply(this,arguments);e&&x.isFunction(e.promise)?e.promise().done(n.resolve).fail(n.reject).progress(n.notify):n[s+"With"](this===r?n.promise():this,a?[e]:arguments)})}),e=null}).promise()},promise:function(e){return null!=e?x.extend(e,r):r}},i={};return r.pipe=r.then,x.each(t,function(e,o){var s=o[2],a=o[3];r[o[1]]=s.add,a&&s.add(function(){n=a},t[1^e][2].disable,t[2][2].lock),i[o[0]]=function(){return i[o[0]+"With"](this===i?r:this,arguments),this},i[o[0]+"With"]=s.fireWith}),r.promise(i),e&&e.call(i,i),i},when:function(e){var t=0,n=d.call(arguments),r=n.length,i=1!==r||e&&x.isFunction(e.promise)?r:0,o=1===i?e:x.Deferred(),s=function(e,t,n){return function(r){t[e]=this,n[e]=arguments.length>1?d.call(arguments):r,n===a?o.notifyWith(t,n):--i||o.resolveWith(t,n)}},a,u,l;if(r>1)for(a=Array(r),u=Array(r),l=Array(r);r>t;t++)n[t]&&x.isFunction(n[t].promise)?n[t].promise().done(s(t,l,n)).fail(o.reject).progress(s(t,u,a)):--i;return i||o.resolveWith(l,n),o.promise()}}),x.support=function(t){var n=o.createElement("input"),r=o.createDocumentFragment(),i=o.createElement("div"),s=o.createElement("select"),a=s.appendChild(o.createElement("option"));return n.type?(n.type="checkbox",t.checkOn=""!==n.value,t.optSelected=a.selected,t.reliableMarginRight=!0,t.boxSizingReliable=!0,t.pixelPosition=!1,n.checked=!0,t.noCloneChecked=n.cloneNode(!0).checked,s.disabled=!0,t.optDisabled=!a.disabled,n=o.createElement("input"),n.value="t",n.type="radio",t.radioValue="t"===n.value,n.setAttribute("checked","t"),n.setAttribute("name","t"),r.appendChild(n),t.checkClone=r.cloneNode(!0).cloneNode(!0).lastChild.checked,t.focusinBubbles="onfocusin"in e,i.style.backgroundClip="content-box",i.cloneNode(!0).style.backgroundClip="",t.clearCloneStyle="content-box"===i.style.backgroundClip,x(function(){var n,r,s="padding:0;margin:0;border:0;display:block;-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box",a=o.getElementsByTagName("body")[0];a&&(n=o.createElement("div"),n.style.cssText="border:0;width:0;height:0;position:absolute;top:0;left:-9999px;margin-top:1px",a.appendChild(n).appendChild(i),i.innerHTML="",i.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;padding:1px;border:1px;display:block;width:4px;margin-top:1%;position:absolute;top:1%",x.swap(a,null!=a.style.zoom?{zoom:1}:{},function(){t.boxSizing=4===i.offsetWidth}),e.getComputedStyle&&(t.pixelPosition="1%"!==(e.getComputedStyle(i,null)||{}).top,t.boxSizingReliable="4px"===(e.getComputedStyle(i,null)||{width:"4px"}).width,r=i.appendChild(o.createElement("div")),r.style.cssText=i.style.cssText=s,r.style.marginRight=r.style.width="0",i.style.width="1px",t.reliableMarginRight=!parseFloat((e.getComputedStyle(r,null)||{}).marginRight)),a.removeChild(n))}),t):t}({});var L,q,H=/(?:\{[\s\S]*\}|\[[\s\S]*\])$/,O=/([A-Z])/g;function F(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=x.expando+Math.random()}F.uid=1,F.accepts=function(e){return e.nodeType?1===e.nodeType||9===e.nodeType:!0},F.prototype={key:function(e){if(!F.accepts(e))return 0;var t={},n=e[this.expando];if(!n){n=F.uid++;try{t[this.expando]={value:n},Object.defineProperties(e,t)}catch(r){t[this.expando]=n,x.extend(e,t)}}return this.cache[n]||(this.cache[n]={}),n},set:function(e,t,n){var r,i=this.key(e),o=this.cache[i];if("string"==typeof t)o[t]=n;else if(x.isEmptyObject(o))x.extend(this.cache[i],t);else for(r in t)o[r]=t[r];return o},get:function(e,t){var n=this.cache[this.key(e)];return t===undefined?n:n[t]},access:function(e,t,n){var r;return t===undefined||t&&"string"==typeof t&&n===undefined?(r=this.get(e,t),r!==undefined?r:this.get(e,x.camelCase(t))):(this.set(e,t,n),n!==undefined?n:t)},remove:function(e,t){var n,r,i,o=this.key(e),s=this.cache[o];if(t===undefined)this.cache[o]={};else{x.isArray(t)?r=t.concat(t.map(x.camelCase)):(i=x.camelCase(t),t in s?r=[t,i]:(r=i,r=r in s?[r]:r.match(w)||[])),n=r.length;while(n--)delete s[r[n]]}},hasData:function(e){return!x.isEmptyObject(this.cache[e[this.expando]]||{})},discard:function(e){e[this.expando]&&delete this.cache[e[this.expando]]}},L=new F,q=new F,x.extend({acceptData:F.accepts,hasData:function(e){return L.hasData(e)||q.hasData(e)},data:function(e,t,n){return L.access(e,t,n)},removeData:function(e,t){L.remove(e,t)},_data:function(e,t,n){return q.access(e,t,n)},_removeData:function(e,t){q.remove(e,t)}}),x.fn.extend({data:function(e,t){var n,r,i=this[0],o=0,s=null;if(e===undefined){if(this.length&&(s=L.get(i),1===i.nodeType&&!q.get(i,"hasDataAttrs"))){for(n=i.attributes;n.length>o;o++)r=n[o].name,0===r.indexOf("data-")&&(r=x.camelCase(r.slice(5)),P(i,r,s[r]));q.set(i,"hasDataAttrs",!0)}return s}return"object"==typeof e?this.each(function(){L.set(this,e)}):x.access(this,function(t){var n,r=x.camelCase(e);if(i&&t===undefined){if(n=L.get(i,e),n!==undefined)return n;if(n=L.get(i,r),n!==undefined)return n;if(n=P(i,r,undefined),n!==undefined)return n}else this.each(function(){var n=L.get(this,r);L.set(this,r,t),-1!==e.indexOf("-")&&n!==undefined&&L.set(this,e,t)})},null,t,arguments.length>1,null,!0)},removeData:function(e){return this.each(function(){L.remove(this,e)})}});function P(e,t,n){var r;if(n===undefined&&1===e.nodeType)if(r="data-"+t.replace(O,"-$1").toLowerCase(),n=e.getAttribute(r),"string"==typeof n){try{n="true"===n?!0:"false"===n?!1:"null"===n?null:+n+""===n?+n:H.test(n)?JSON.parse(n):n}catch(i){}L.set(e,t,n)}else n=undefined;return n}x.extend({queue:function(e,t,n){var r;return e?(t=(t||"fx")+"queue",r=q.get(e,t),n&&(!r||x.isArray(n)?r=q.access(e,t,x.makeArray(n)):r.push(n)),r||[]):undefined},dequeue:function(e,t){t=t||"fx";var n=x.queue(e,t),r=n.length,i=n.shift(),o=x._queueHooks(e,t),s=function(){x.dequeue(e,t)
-};"inprogress"===i&&(i=n.shift(),r--),i&&("fx"===t&&n.unshift("inprogress"),delete o.stop,i.call(e,s,o)),!r&&o&&o.empty.fire()},_queueHooks:function(e,t){var n=t+"queueHooks";return q.get(e,n)||q.access(e,n,{empty:x.Callbacks("once memory").add(function(){q.remove(e,[t+"queue",n])})})}}),x.fn.extend({queue:function(e,t){var n=2;return"string"!=typeof e&&(t=e,e="fx",n--),n>arguments.length?x.queue(this[0],e):t===undefined?this:this.each(function(){var n=x.queue(this,e,t);x._queueHooks(this,e),"fx"===e&&"inprogress"!==n[0]&&x.dequeue(this,e)})},dequeue:function(e){return this.each(function(){x.dequeue(this,e)})},delay:function(e,t){return e=x.fx?x.fx.speeds[e]||e:e,t=t||"fx",this.queue(t,function(t,n){var r=setTimeout(t,e);n.stop=function(){clearTimeout(r)}})},clearQueue:function(e){return this.queue(e||"fx",[])},promise:function(e,t){var n,r=1,i=x.Deferred(),o=this,s=this.length,a=function(){--r||i.resolveWith(o,[o])};"string"!=typeof e&&(t=e,e=undefined),e=e||"fx";while(s--)n=q.get(o[s],e+"queueHooks"),n&&n.empty&&(r++,n.empty.add(a));return a(),i.promise(t)}});var R,M,W=/[\t\r\n\f]/g,$=/\r/g,B=/^(?:input|select|textarea|button)$/i;x.fn.extend({attr:function(e,t){return x.access(this,x.attr,e,t,arguments.length>1)},removeAttr:function(e){return this.each(function(){x.removeAttr(this,e)})},prop:function(e,t){return x.access(this,x.prop,e,t,arguments.length>1)},removeProp:function(e){return this.each(function(){delete this[x.propFix[e]||e]})},addClass:function(e){var t,n,r,i,o,s=0,a=this.length,u="string"==typeof e&&e;if(x.isFunction(e))return this.each(function(t){x(this).addClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];a>s;s++)if(n=this[s],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(W," "):" ")){o=0;while(i=t[o++])0>r.indexOf(" "+i+" ")&&(r+=i+" ");n.className=x.trim(r)}return this},removeClass:function(e){var t,n,r,i,o,s=0,a=this.length,u=0===arguments.length||"string"==typeof e&&e;if(x.isFunction(e))return this.each(function(t){x(this).removeClass(e.call(this,t,this.className))});if(u)for(t=(e||"").match(w)||[];a>s;s++)if(n=this[s],r=1===n.nodeType&&(n.className?(" "+n.className+" ").replace(W," "):"")){o=0;while(i=t[o++])while(r.indexOf(" "+i+" ")>=0)r=r.replace(" "+i+" "," ");n.className=e?x.trim(r):""}return this},toggleClass:function(e,t){var n=typeof e;return"boolean"==typeof t&&"string"===n?t?this.addClass(e):this.removeClass(e):x.isFunction(e)?this.each(function(n){x(this).toggleClass(e.call(this,n,this.className,t),t)}):this.each(function(){if("string"===n){var t,i=0,o=x(this),s=e.match(w)||[];while(t=s[i++])o.hasClass(t)?o.removeClass(t):o.addClass(t)}else(n===r||"boolean"===n)&&(this.className&&q.set(this,"__className__",this.className),this.className=this.className||e===!1?"":q.get(this,"__className__")||"")})},hasClass:function(e){var t=" "+e+" ",n=0,r=this.length;for(;r>n;n++)if(1===this[n].nodeType&&(" "+this[n].className+" ").replace(W," ").indexOf(t)>=0)return!0;return!1},val:function(e){var t,n,r,i=this[0];{if(arguments.length)return r=x.isFunction(e),this.each(function(n){var i;1===this.nodeType&&(i=r?e.call(this,n,x(this).val()):e,null==i?i="":"number"==typeof i?i+="":x.isArray(i)&&(i=x.map(i,function(e){return null==e?"":e+""})),t=x.valHooks[this.type]||x.valHooks[this.nodeName.toLowerCase()],t&&"set"in t&&t.set(this,i,"value")!==undefined||(this.value=i))});if(i)return t=x.valHooks[i.type]||x.valHooks[i.nodeName.toLowerCase()],t&&"get"in t&&(n=t.get(i,"value"))!==undefined?n:(n=i.value,"string"==typeof n?n.replace($,""):null==n?"":n)}}}),x.extend({valHooks:{option:{get:function(e){var t=e.attributes.value;return!t||t.specified?e.value:e.text}},select:{get:function(e){var t,n,r=e.options,i=e.selectedIndex,o="select-one"===e.type||0>i,s=o?null:[],a=o?i+1:r.length,u=0>i?a:o?i:0;for(;a>u;u++)if(n=r[u],!(!n.selected&&u!==i||(x.support.optDisabled?n.disabled:null!==n.getAttribute("disabled"))||n.parentNode.disabled&&x.nodeName(n.parentNode,"optgroup"))){if(t=x(n).val(),o)return t;s.push(t)}return s},set:function(e,t){var n,r,i=e.options,o=x.makeArray(t),s=i.length;while(s--)r=i[s],(r.selected=x.inArray(x(r).val(),o)>=0)&&(n=!0);return n||(e.selectedIndex=-1),o}}},attr:function(e,t,n){var i,o,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return typeof e.getAttribute===r?x.prop(e,t,n):(1===s&&x.isXMLDoc(e)||(t=t.toLowerCase(),i=x.attrHooks[t]||(x.expr.match.bool.test(t)?M:R)),n===undefined?i&&"get"in i&&null!==(o=i.get(e,t))?o:(o=x.find.attr(e,t),null==o?undefined:o):null!==n?i&&"set"in i&&(o=i.set(e,n,t))!==undefined?o:(e.setAttribute(t,n+""),n):(x.removeAttr(e,t),undefined))},removeAttr:function(e,t){var n,r,i=0,o=t&&t.match(w);if(o&&1===e.nodeType)while(n=o[i++])r=x.propFix[n]||n,x.expr.match.bool.test(n)&&(e[r]=!1),e.removeAttribute(n)},attrHooks:{type:{set:function(e,t){if(!x.support.radioValue&&"radio"===t&&x.nodeName(e,"input")){var n=e.value;return e.setAttribute("type",t),n&&(e.value=n),t}}}},propFix:{"for":"htmlFor","class":"className"},prop:function(e,t,n){var r,i,o,s=e.nodeType;if(e&&3!==s&&8!==s&&2!==s)return o=1!==s||!x.isXMLDoc(e),o&&(t=x.propFix[t]||t,i=x.propHooks[t]),n!==undefined?i&&"set"in i&&(r=i.set(e,n,t))!==undefined?r:e[t]=n:i&&"get"in i&&null!==(r=i.get(e,t))?r:e[t]},propHooks:{tabIndex:{get:function(e){return e.hasAttribute("tabindex")||B.test(e.nodeName)||e.href?e.tabIndex:-1}}}}),M={set:function(e,t,n){return t===!1?x.removeAttr(e,n):e.setAttribute(n,n),n}},x.each(x.expr.match.bool.source.match(/\w+/g),function(e,t){var n=x.expr.attrHandle[t]||x.find.attr;x.expr.attrHandle[t]=function(e,t,r){var i=x.expr.attrHandle[t],o=r?undefined:(x.expr.attrHandle[t]=undefined)!=n(e,t,r)?t.toLowerCase():null;return x.expr.attrHandle[t]=i,o}}),x.support.optSelected||(x.propHooks.selected={get:function(e){var t=e.parentNode;return t&&t.parentNode&&t.parentNode.selectedIndex,null}}),x.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){x.propFix[this.toLowerCase()]=this}),x.each(["radio","checkbox"],function(){x.valHooks[this]={set:function(e,t){return x.isArray(t)?e.checked=x.inArray(x(e).val(),t)>=0:undefined}},x.support.checkOn||(x.valHooks[this].get=function(e){return null===e.getAttribute("value")?"on":e.value})});var I=/^key/,z=/^(?:mouse|contextmenu)|click/,_=/^(?:focusinfocus|focusoutblur)$/,X=/^([^.]*)(?:\.(.+)|)$/;function U(){return!0}function Y(){return!1}function V(){try{return o.activeElement}catch(e){}}x.event={global:{},add:function(e,t,n,i,o){var s,a,u,l,c,p,f,h,d,g,m,y=q.get(e);if(y){n.handler&&(s=n,n=s.handler,o=s.selector),n.guid||(n.guid=x.guid++),(l=y.events)||(l=y.events={}),(a=y.handle)||(a=y.handle=function(e){return typeof x===r||e&&x.event.triggered===e.type?undefined:x.event.dispatch.apply(a.elem,arguments)},a.elem=e),t=(t||"").match(w)||[""],c=t.length;while(c--)u=X.exec(t[c])||[],d=m=u[1],g=(u[2]||"").split(".").sort(),d&&(f=x.event.special[d]||{},d=(o?f.delegateType:f.bindType)||d,f=x.event.special[d]||{},p=x.extend({type:d,origType:m,data:i,handler:n,guid:n.guid,selector:o,needsContext:o&&x.expr.match.needsContext.test(o),namespace:g.join(".")},s),(h=l[d])||(h=l[d]=[],h.delegateCount=0,f.setup&&f.setup.call(e,i,g,a)!==!1||e.addEventListener&&e.addEventListener(d,a,!1)),f.add&&(f.add.call(e,p),p.handler.guid||(p.handler.guid=n.guid)),o?h.splice(h.delegateCount++,0,p):h.push(p),x.event.global[d]=!0);e=null}},remove:function(e,t,n,r,i){var o,s,a,u,l,c,p,f,h,d,g,m=q.hasData(e)&&q.get(e);if(m&&(u=m.events)){t=(t||"").match(w)||[""],l=t.length;while(l--)if(a=X.exec(t[l])||[],h=g=a[1],d=(a[2]||"").split(".").sort(),h){p=x.event.special[h]||{},h=(r?p.delegateType:p.bindType)||h,f=u[h]||[],a=a[2]&&RegExp("(^|\\.)"+d.join("\\.(?:.*\\.|)")+"(\\.|$)"),s=o=f.length;while(o--)c=f[o],!i&&g!==c.origType||n&&n.guid!==c.guid||a&&!a.test(c.namespace)||r&&r!==c.selector&&("**"!==r||!c.selector)||(f.splice(o,1),c.selector&&f.delegateCount--,p.remove&&p.remove.call(e,c));s&&!f.length&&(p.teardown&&p.teardown.call(e,d,m.handle)!==!1||x.removeEvent(e,h,m.handle),delete u[h])}else for(h in u)x.event.remove(e,h+t[l],n,r,!0);x.isEmptyObject(u)&&(delete m.handle,q.remove(e,"events"))}},trigger:function(t,n,r,i){var s,a,u,l,c,p,f,h=[r||o],d=y.call(t,"type")?t.type:t,g=y.call(t,"namespace")?t.namespace.split("."):[];if(a=u=r=r||o,3!==r.nodeType&&8!==r.nodeType&&!_.test(d+x.event.triggered)&&(d.indexOf(".")>=0&&(g=d.split("."),d=g.shift(),g.sort()),c=0>d.indexOf(":")&&"on"+d,t=t[x.expando]?t:new x.Event(d,"object"==typeof t&&t),t.isTrigger=i?2:3,t.namespace=g.join("."),t.namespace_re=t.namespace?RegExp("(^|\\.)"+g.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,t.result=undefined,t.target||(t.target=r),n=null==n?[t]:x.makeArray(n,[t]),f=x.event.special[d]||{},i||!f.trigger||f.trigger.apply(r,n)!==!1)){if(!i&&!f.noBubble&&!x.isWindow(r)){for(l=f.delegateType||d,_.test(l+d)||(a=a.parentNode);a;a=a.parentNode)h.push(a),u=a;u===(r.ownerDocument||o)&&h.push(u.defaultView||u.parentWindow||e)}s=0;while((a=h[s++])&&!t.isPropagationStopped())t.type=s>1?l:f.bindType||d,p=(q.get(a,"events")||{})[t.type]&&q.get(a,"handle"),p&&p.apply(a,n),p=c&&a[c],p&&x.acceptData(a)&&p.apply&&p.apply(a,n)===!1&&t.preventDefault();return t.type=d,i||t.isDefaultPrevented()||f._default&&f._default.apply(h.pop(),n)!==!1||!x.acceptData(r)||c&&x.isFunction(r[d])&&!x.isWindow(r)&&(u=r[c],u&&(r[c]=null),x.event.triggered=d,r[d](),x.event.triggered=undefined,u&&(r[c]=u)),t.result}},dispatch:function(e){e=x.event.fix(e);var t,n,r,i,o,s=[],a=d.call(arguments),u=(q.get(this,"events")||{})[e.type]||[],l=x.event.special[e.type]||{};if(a[0]=e,e.delegateTarget=this,!l.preDispatch||l.preDispatch.call(this,e)!==!1){s=x.event.handlers.call(this,e,u),t=0;while((i=s[t++])&&!e.isPropagationStopped()){e.currentTarget=i.elem,n=0;while((o=i.handlers[n++])&&!e.isImmediatePropagationStopped())(!e.namespace_re||e.namespace_re.test(o.namespace))&&(e.handleObj=o,e.data=o.data,r=((x.event.special[o.origType]||{}).handle||o.handler).apply(i.elem,a),r!==undefined&&(e.result=r)===!1&&(e.preventDefault(),e.stopPropagation()))}return l.postDispatch&&l.postDispatch.call(this,e),e.result}},handlers:function(e,t){var n,r,i,o,s=[],a=t.delegateCount,u=e.target;if(a&&u.nodeType&&(!e.button||"click"!==e.type))for(;u!==this;u=u.parentNode||this)if(u.disabled!==!0||"click"!==e.type){for(r=[],n=0;a>n;n++)o=t[n],i=o.selector+" ",r[i]===undefined&&(r[i]=o.needsContext?x(i,this).index(u)>=0:x.find(i,this,null,[u]).length),r[i]&&r.push(o);r.length&&s.push({elem:u,handlers:r})}return t.length>a&&s.push({elem:this,handlers:t.slice(a)}),s},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(e,t){return null==e.which&&(e.which=null!=t.charCode?t.charCode:t.keyCode),e}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(e,t){var n,r,i,s=t.button;return null==e.pageX&&null!=t.clientX&&(n=e.target.ownerDocument||o,r=n.documentElement,i=n.body,e.pageX=t.clientX+(r&&r.scrollLeft||i&&i.scrollLeft||0)-(r&&r.clientLeft||i&&i.clientLeft||0),e.pageY=t.clientY+(r&&r.scrollTop||i&&i.scrollTop||0)-(r&&r.clientTop||i&&i.clientTop||0)),e.which||s===undefined||(e.which=1&s?1:2&s?3:4&s?2:0),e}},fix:function(e){if(e[x.expando])return e;var t,n,r,i=e.type,s=e,a=this.fixHooks[i];a||(this.fixHooks[i]=a=z.test(i)?this.mouseHooks:I.test(i)?this.keyHooks:{}),r=a.props?this.props.concat(a.props):this.props,e=new x.Event(s),t=r.length;while(t--)n=r[t],e[n]=s[n];return e.target||(e.target=o),3===e.target.nodeType&&(e.target=e.target.parentNode),a.filter?a.filter(e,s):e},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==V()&&this.focus?(this.focus(),!1):undefined},delegateType:"focusin"},blur:{trigger:function(){return this===V()&&this.blur?(this.blur(),!1):undefined},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&x.nodeName(this,"input")?(this.click(),!1):undefined},_default:function(e){return x.nodeName(e.target,"a")}},beforeunload:{postDispatch:function(e){e.result!==undefined&&(e.originalEvent.returnValue=e.result)}}},simulate:function(e,t,n,r){var i=x.extend(new x.Event,n,{type:e,isSimulated:!0,originalEvent:{}});r?x.event.trigger(i,null,t):x.event.dispatch.call(t,i),i.isDefaultPrevented()&&n.preventDefault()}},x.removeEvent=function(e,t,n){e.removeEventListener&&e.removeEventListener(t,n,!1)},x.Event=function(e,t){return this instanceof x.Event?(e&&e.type?(this.originalEvent=e,this.type=e.type,this.isDefaultPrevented=e.defaultPrevented||e.getPreventDefault&&e.getPreventDefault()?U:Y):this.type=e,t&&x.extend(this,t),this.timeStamp=e&&e.timeStamp||x.now(),this[x.expando]=!0,undefined):new x.Event(e,t)},x.Event.prototype={isDefaultPrevented:Y,isPropagationStopped:Y,isImmediatePropagationStopped:Y,preventDefault:function(){var e=this.originalEvent;this.isDefaultPrevented=U,e&&e.preventDefault&&e.preventDefault()},stopPropagation:function(){var e=this.originalEvent;this.isPropagationStopped=U,e&&e.stopPropagation&&e.stopPropagation()},stopImmediatePropagation:function(){this.isImmediatePropagationStopped=U,this.stopPropagation()}},x.each({mouseenter:"mouseover",mouseleave:"mouseout"},function(e,t){x.event.special[e]={delegateType:t,bindType:t,handle:function(e){var n,r=this,i=e.relatedTarget,o=e.handleObj;return(!i||i!==r&&!x.contains(r,i))&&(e.type=o.origType,n=o.handler.apply(this,arguments),e.type=t),n}}}),x.support.focusinBubbles||x.each({focus:"focusin",blur:"focusout"},function(e,t){var n=0,r=function(e){x.event.simulate(t,e.target,x.event.fix(e),!0)};x.event.special[t]={setup:function(){0===n++&&o.addEventListener(e,r,!0)},teardown:function(){0===--n&&o.removeEventListener(e,r,!0)}}}),x.fn.extend({on:function(e,t,n,r,i){var o,s;if("object"==typeof e){"string"!=typeof t&&(n=n||t,t=undefined);for(s in e)this.on(s,t,n,e[s],i);return this}if(null==n&&null==r?(r=t,n=t=undefined):null==r&&("string"==typeof t?(r=n,n=undefined):(r=n,n=t,t=undefined)),r===!1)r=Y;else if(!r)return this;return 1===i&&(o=r,r=function(e){return x().off(e),o.apply(this,arguments)},r.guid=o.guid||(o.guid=x.guid++)),this.each(function(){x.event.add(this,e,r,n,t)})},one:function(e,t,n,r){return this.on(e,t,n,r,1)},off:function(e,t,n){var r,i;if(e&&e.preventDefault&&e.handleObj)return r=e.handleObj,x(e.delegateTarget).off(r.namespace?r.origType+"."+r.namespace:r.origType,r.selector,r.handler),this;if("object"==typeof e){for(i in e)this.off(i,t,e[i]);return this}return(t===!1||"function"==typeof t)&&(n=t,t=undefined),n===!1&&(n=Y),this.each(function(){x.event.remove(this,e,n,t)})},trigger:function(e,t){return this.each(function(){x.event.trigger(e,t,this)})},triggerHandler:function(e,t){var n=this[0];return n?x.event.trigger(e,t,n,!0):undefined}});var G=/^.[^:#\[\.,]*$/,J=/^(?:parents|prev(?:Until|All))/,Q=x.expr.match.needsContext,K={children:!0,contents:!0,next:!0,prev:!0};x.fn.extend({find:function(e){var t,n=[],r=this,i=r.length;if("string"!=typeof e)return this.pushStack(x(e).filter(function(){for(t=0;i>t;t++)if(x.contains(r[t],this))return!0}));for(t=0;i>t;t++)x.find(e,r[t],n);return n=this.pushStack(i>1?x.unique(n):n),n.selector=this.selector?this.selector+" "+e:e,n},has:function(e){var t=x(e,this),n=t.length;return this.filter(function(){var e=0;for(;n>e;e++)if(x.contains(this,t[e]))return!0})},not:function(e){return this.pushStack(et(this,e||[],!0))},filter:function(e){return this.pushStack(et(this,e||[],!1))},is:function(e){return!!et(this,"string"==typeof e&&Q.test(e)?x(e):e||[],!1).length},closest:function(e,t){var n,r=0,i=this.length,o=[],s=Q.test(e)||"string"!=typeof e?x(e,t||this.context):0;for(;i>r;r++)for(n=this[r];n&&n!==t;n=n.parentNode)if(11>n.nodeType&&(s?s.index(n)>-1:1===n.nodeType&&x.find.matchesSelector(n,e))){n=o.push(n);break}return this.pushStack(o.length>1?x.unique(o):o)},index:function(e){return e?"string"==typeof e?g.call(x(e),this[0]):g.call(this,e.jquery?e[0]:e):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(e,t){var n="string"==typeof e?x(e,t):x.makeArray(e&&e.nodeType?[e]:e),r=x.merge(this.get(),n);return this.pushStack(x.unique(r))},addBack:function(e){return this.add(null==e?this.prevObject:this.prevObject.filter(e))}});function Z(e,t){while((e=e[t])&&1!==e.nodeType);return e}x.each({parent:function(e){var t=e.parentNode;return t&&11!==t.nodeType?t:null},parents:function(e){return x.dir(e,"parentNode")},parentsUntil:function(e,t,n){return x.dir(e,"parentNode",n)},next:function(e){return Z(e,"nextSibling")},prev:function(e){return Z(e,"previousSibling")},nextAll:function(e){return x.dir(e,"nextSibling")},prevAll:function(e){return x.dir(e,"previousSibling")},nextUntil:function(e,t,n){return x.dir(e,"nextSibling",n)},prevUntil:function(e,t,n){return x.dir(e,"previousSibling",n)},siblings:function(e){return x.sibling((e.parentNode||{}).firstChild,e)},children:function(e){return x.sibling(e.firstChild)},contents:function(e){return e.contentDocument||x.merge([],e.childNodes)}},function(e,t){x.fn[e]=function(n,r){var i=x.map(this,t,n);return"Until"!==e.slice(-5)&&(r=n),r&&"string"==typeof r&&(i=x.filter(r,i)),this.length>1&&(K[e]||x.unique(i),J.test(e)&&i.reverse()),this.pushStack(i)}}),x.extend({filter:function(e,t,n){var r=t[0];return n&&(e=":not("+e+")"),1===t.length&&1===r.nodeType?x.find.matchesSelector(r,e)?[r]:[]:x.find.matches(e,x.grep(t,function(e){return 1===e.nodeType}))},dir:function(e,t,n){var r=[],i=n!==undefined;while((e=e[t])&&9!==e.nodeType)if(1===e.nodeType){if(i&&x(e).is(n))break;r.push(e)}return r},sibling:function(e,t){var n=[];for(;e;e=e.nextSibling)1===e.nodeType&&e!==t&&n.push(e);return n}});function et(e,t,n){if(x.isFunction(t))return x.grep(e,function(e,r){return!!t.call(e,r,e)!==n});if(t.nodeType)return x.grep(e,function(e){return e===t!==n});if("string"==typeof t){if(G.test(t))return x.filter(t,e,n);t=x.filter(t,e)}return x.grep(e,function(e){return g.call(t,e)>=0!==n})}var tt=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,nt=/<([\w:]+)/,rt=/<|&#?\w+;/,it=/<(?:script|style|link)/i,ot=/^(?:checkbox|radio)$/i,st=/checked\s*(?:[^=]|=\s*.checked.)/i,at=/^$|\/(?:java|ecma)script/i,ut=/^true\/(.*)/,lt=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ct={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};ct.optgroup=ct.option,ct.tbody=ct.tfoot=ct.colgroup=ct.caption=ct.thead,ct.th=ct.td,x.fn.extend({text:function(e){return x.access(this,function(e){return e===undefined?x.text(this):this.empty().append((this[0]&&this[0].ownerDocument||o).createTextNode(e))},null,e,arguments.length)},append:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=pt(this,e);t.appendChild(e)}})},prepend:function(){return this.domManip(arguments,function(e){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var t=pt(this,e);t.insertBefore(e,t.firstChild)}})},before:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this)})},after:function(){return this.domManip(arguments,function(e){this.parentNode&&this.parentNode.insertBefore(e,this.nextSibling)})},remove:function(e,t){var n,r=e?x.filter(e,this):this,i=0;for(;null!=(n=r[i]);i++)t||1!==n.nodeType||x.cleanData(mt(n)),n.parentNode&&(t&&x.contains(n.ownerDocument,n)&&dt(mt(n,"script")),n.parentNode.removeChild(n));return this},empty:function(){var e,t=0;for(;null!=(e=this[t]);t++)1===e.nodeType&&(x.cleanData(mt(e,!1)),e.textContent="");return this},clone:function(e,t){return e=null==e?!1:e,t=null==t?e:t,this.map(function(){return x.clone(this,e,t)})},html:function(e){return x.access(this,function(e){var t=this[0]||{},n=0,r=this.length;if(e===undefined&&1===t.nodeType)return t.innerHTML;if("string"==typeof e&&!it.test(e)&&!ct[(nt.exec(e)||["",""])[1].toLowerCase()]){e=e.replace(tt,"<$1></$2>");try{for(;r>n;n++)t=this[n]||{},1===t.nodeType&&(x.cleanData(mt(t,!1)),t.innerHTML=e);t=0}catch(i){}}t&&this.empty().append(e)},null,e,arguments.length)},replaceWith:function(){var e=x.map(this,function(e){return[e.nextSibling,e.parentNode]}),t=0;return this.domManip(arguments,function(n){var r=e[t++],i=e[t++];i&&(r&&r.parentNode!==i&&(r=this.nextSibling),x(this).remove(),i.insertBefore(n,r))},!0),t?this:this.remove()},detach:function(e){return this.remove(e,!0)},domManip:function(e,t,n){e=f.apply([],e);var r,i,o,s,a,u,l=0,c=this.length,p=this,h=c-1,d=e[0],g=x.isFunction(d);if(g||!(1>=c||"string"!=typeof d||x.support.checkClone)&&st.test(d))return this.each(function(r){var i=p.eq(r);g&&(e[0]=d.call(this,r,i.html())),i.domManip(e,t,n)});if(c&&(r=x.buildFragment(e,this[0].ownerDocument,!1,!n&&this),i=r.firstChild,1===r.childNodes.length&&(r=i),i)){for(o=x.map(mt(r,"script"),ft),s=o.length;c>l;l++)a=r,l!==h&&(a=x.clone(a,!0,!0),s&&x.merge(o,mt(a,"script"))),t.call(this[l],a,l);if(s)for(u=o[o.length-1].ownerDocument,x.map(o,ht),l=0;s>l;l++)a=o[l],at.test(a.type||"")&&!q.access(a,"globalEval")&&x.contains(u,a)&&(a.src?x._evalUrl(a.src):x.globalEval(a.textContent.replace(lt,"")))}return this}}),x.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(e,t){x.fn[e]=function(e){var n,r=[],i=x(e),o=i.length-1,s=0;for(;o>=s;s++)n=s===o?this:this.clone(!0),x(i[s])[t](n),h.apply(r,n.get());return this.pushStack(r)}}),x.extend({clone:function(e,t,n){var r,i,o,s,a=e.cloneNode(!0),u=x.contains(e.ownerDocument,e);if(!(x.support.noCloneChecked||1!==e.nodeType&&11!==e.nodeType||x.isXMLDoc(e)))for(s=mt(a),o=mt(e),r=0,i=o.length;i>r;r++)yt(o[r],s[r]);if(t)if(n)for(o=o||mt(e),s=s||mt(a),r=0,i=o.length;i>r;r++)gt(o[r],s[r]);else gt(e,a);return s=mt(a,"script"),s.length>0&&dt(s,!u&&mt(e,"script")),a},buildFragment:function(e,t,n,r){var i,o,s,a,u,l,c=0,p=e.length,f=t.createDocumentFragment(),h=[];for(;p>c;c++)if(i=e[c],i||0===i)if("object"===x.type(i))x.merge(h,i.nodeType?[i]:i);else if(rt.test(i)){o=o||f.appendChild(t.createElement("div")),s=(nt.exec(i)||["",""])[1].toLowerCase(),a=ct[s]||ct._default,o.innerHTML=a[1]+i.replace(tt,"<$1></$2>")+a[2],l=a[0];while(l--)o=o.lastChild;x.merge(h,o.childNodes),o=f.firstChild,o.textContent=""}else h.push(t.createTextNode(i));f.textContent="",c=0;while(i=h[c++])if((!r||-1===x.inArray(i,r))&&(u=x.contains(i.ownerDocument,i),o=mt(f.appendChild(i),"script"),u&&dt(o),n)){l=0;while(i=o[l++])at.test(i.type||"")&&n.push(i)}return f},cleanData:function(e){var t,n,r,i,o,s,a=x.event.special,u=0;for(;(n=e[u])!==undefined;u++){if(F.accepts(n)&&(o=n[q.expando],o&&(t=q.cache[o]))){if(r=Object.keys(t.events||{}),r.length)for(s=0;(i=r[s])!==undefined;s++)a[i]?x.event.remove(n,i):x.removeEvent(n,i,t.handle);q.cache[o]&&delete q.cache[o]}delete L.cache[n[L.expando]]}},_evalUrl:function(e){return x.ajax({url:e,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})}});function pt(e,t){return x.nodeName(e,"table")&&x.nodeName(1===t.nodeType?t:t.firstChild,"tr")?e.getElementsByTagName("tbody")[0]||e.appendChild(e.ownerDocument.createElement("tbody")):e}function ft(e){return e.type=(null!==e.getAttribute("type"))+"/"+e.type,e}function ht(e){var t=ut.exec(e.type);return t?e.type=t[1]:e.removeAttribute("type"),e}function dt(e,t){var n=e.length,r=0;for(;n>r;r++)q.set(e[r],"globalEval",!t||q.get(t[r],"globalEval"))}function gt(e,t){var n,r,i,o,s,a,u,l;if(1===t.nodeType){if(q.hasData(e)&&(o=q.access(e),s=q.set(t,o),l=o.events)){delete s.handle,s.events={};for(i in l)for(n=0,r=l[i].length;r>n;n++)x.event.add(t,i,l[i][n])}L.hasData(e)&&(a=L.access(e),u=x.extend({},a),L.set(t,u))}}function mt(e,t){var n=e.getElementsByTagName?e.getElementsByTagName(t||"*"):e.querySelectorAll?e.querySelectorAll(t||"*"):[];return t===undefined||t&&x.nodeName(e,t)?x.merge([e],n):n}function yt(e,t){var n=t.nodeName.toLowerCase();"input"===n&&ot.test(e.type)?t.checked=e.checked:("input"===n||"textarea"===n)&&(t.defaultValue=e.defaultValue)}x.fn.extend({wrapAll:function(e){var t;return x.isFunction(e)?this.each(function(t){x(this).wrapAll(e.call(this,t))}):(this[0]&&(t=x(e,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&t.insertBefore(this[0]),t.map(function(){var e=this;while(e.firstElementChild)e=e.firstElementChild;return e}).append(this)),this)},wrapInner:function(e){return x.isFunction(e)?this.each(function(t){x(this).wrapInner(e.call(this,t))}):this.each(function(){var t=x(this),n=t.contents();n.length?n.wrapAll(e):t.append(e)})},wrap:function(e){var t=x.isFunction(e);return this.each(function(n){x(this).wrapAll(t?e.call(this,n):e)})},unwrap:function(){return this.parent().each(function(){x.nodeName(this,"body")||x(this).replaceWith(this.childNodes)}).end()}});var vt,xt,bt=/^(none|table(?!-c[ea]).+)/,wt=/^margin/,Tt=RegExp("^("+b+")(.*)$","i"),Ct=RegExp("^("+b+")(?!px)[a-z%]+$","i"),kt=RegExp("^([+-])=("+b+")","i"),Nt={BODY:"block"},Et={position:"absolute",visibility:"hidden",display:"block"},St={letterSpacing:0,fontWeight:400},jt=["Top","Right","Bottom","Left"],Dt=["Webkit","O","Moz","ms"];function At(e,t){if(t in e)return t;var n=t.charAt(0).toUpperCase()+t.slice(1),r=t,i=Dt.length;while(i--)if(t=Dt[i]+n,t in e)return t;return r}function Lt(e,t){return e=t||e,"none"===x.css(e,"display")||!x.contains(e.ownerDocument,e)}function qt(t){return e.getComputedStyle(t,null)}function Ht(e,t){var n,r,i,o=[],s=0,a=e.length;for(;a>s;s++)r=e[s],r.style&&(o[s]=q.get(r,"olddisplay"),n=r.style.display,t?(o[s]||"none"!==n||(r.style.display=""),""===r.style.display&&Lt(r)&&(o[s]=q.access(r,"olddisplay",Rt(r.nodeName)))):o[s]||(i=Lt(r),(n&&"none"!==n||!i)&&q.set(r,"olddisplay",i?n:x.css(r,"display"))));for(s=0;a>s;s++)r=e[s],r.style&&(t&&"none"!==r.style.display&&""!==r.style.display||(r.style.display=t?o[s]||"":"none"));return e}x.fn.extend({css:function(e,t){return x.access(this,function(e,t,n){var r,i,o={},s=0;if(x.isArray(t)){for(r=qt(e),i=t.length;i>s;s++)o[t[s]]=x.css(e,t[s],!1,r);return o}return n!==undefined?x.style(e,t,n):x.css(e,t)},e,t,arguments.length>1)},show:function(){return Ht(this,!0)},hide:function(){return Ht(this)},toggle:function(e){return"boolean"==typeof e?e?this.show():this.hide():this.each(function(){Lt(this)?x(this).show():x(this).hide()})}}),x.extend({cssHooks:{opacity:{get:function(e,t){if(t){var n=vt(e,"opacity");return""===n?"1":n}}}},cssNumber:{columnCount:!0,fillOpacity:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(e,t,n,r){if(e&&3!==e.nodeType&&8!==e.nodeType&&e.style){var i,o,s,a=x.camelCase(t),u=e.style;return t=x.cssProps[a]||(x.cssProps[a]=At(u,a)),s=x.cssHooks[t]||x.cssHooks[a],n===undefined?s&&"get"in s&&(i=s.get(e,!1,r))!==undefined?i:u[t]:(o=typeof n,"string"===o&&(i=kt.exec(n))&&(n=(i[1]+1)*i[2]+parseFloat(x.css(e,t)),o="number"),null==n||"number"===o&&isNaN(n)||("number"!==o||x.cssNumber[a]||(n+="px"),x.support.clearCloneStyle||""!==n||0!==t.indexOf("background")||(u[t]="inherit"),s&&"set"in s&&(n=s.set(e,n,r))===undefined||(u[t]=n)),undefined)}},css:function(e,t,n,r){var i,o,s,a=x.camelCase(t);return t=x.cssProps[a]||(x.cssProps[a]=At(e.style,a)),s=x.cssHooks[t]||x.cssHooks[a],s&&"get"in s&&(i=s.get(e,!0,n)),i===undefined&&(i=vt(e,t,r)),"normal"===i&&t in St&&(i=St[t]),""===n||n?(o=parseFloat(i),n===!0||x.isNumeric(o)?o||0:i):i}}),vt=function(e,t,n){var r,i,o,s=n||qt(e),a=s?s.getPropertyValue(t)||s[t]:undefined,u=e.style;return s&&(""!==a||x.contains(e.ownerDocument,e)||(a=x.style(e,t)),Ct.test(a)&&wt.test(t)&&(r=u.width,i=u.minWidth,o=u.maxWidth,u.minWidth=u.maxWidth=u.width=a,a=s.width,u.width=r,u.minWidth=i,u.maxWidth=o)),a};function Ot(e,t,n){var r=Tt.exec(t);return r?Math.max(0,r[1]-(n||0))+(r[2]||"px"):t}function Ft(e,t,n,r,i){var o=n===(r?"border":"content")?4:"width"===t?1:0,s=0;for(;4>o;o+=2)"margin"===n&&(s+=x.css(e,n+jt[o],!0,i)),r?("content"===n&&(s-=x.css(e,"padding"+jt[o],!0,i)),"margin"!==n&&(s-=x.css(e,"border"+jt[o]+"Width",!0,i))):(s+=x.css(e,"padding"+jt[o],!0,i),"padding"!==n&&(s+=x.css(e,"border"+jt[o]+"Width",!0,i)));return s}function Pt(e,t,n){var r=!0,i="width"===t?e.offsetWidth:e.offsetHeight,o=qt(e),s=x.support.boxSizing&&"border-box"===x.css(e,"boxSizing",!1,o);if(0>=i||null==i){if(i=vt(e,t,o),(0>i||null==i)&&(i=e.style[t]),Ct.test(i))return i;r=s&&(x.support.boxSizingReliable||i===e.style[t]),i=parseFloat(i)||0}return i+Ft(e,t,n||(s?"border":"content"),r,o)+"px"}function Rt(e){var t=o,n=Nt[e];return n||(n=Mt(e,t),"none"!==n&&n||(xt=(xt||x("<iframe frameborder='0' width='0' height='0'/>").css("cssText","display:block !important")).appendTo(t.documentElement),t=(xt[0].contentWindow||xt[0].contentDocument).document,t.write("<!doctype html><html><body>"),t.close(),n=Mt(e,t),xt.detach()),Nt[e]=n),n}function Mt(e,t){var n=x(t.createElement(e)).appendTo(t.body),r=x.css(n[0],"display");return n.remove(),r}x.each(["height","width"],function(e,t){x.cssHooks[t]={get:function(e,n,r){return n?0===e.offsetWidth&&bt.test(x.css(e,"display"))?x.swap(e,Et,function(){return Pt(e,t,r)}):Pt(e,t,r):undefined},set:function(e,n,r){var i=r&&qt(e);return Ot(e,n,r?Ft(e,t,r,x.support.boxSizing&&"border-box"===x.css(e,"boxSizing",!1,i),i):0)}}}),x(function(){x.support.reliableMarginRight||(x.cssHooks.marginRight={get:function(e,t){return t?x.swap(e,{display:"inline-block"},vt,[e,"marginRight"]):undefined}}),!x.support.pixelPosition&&x.fn.position&&x.each(["top","left"],function(e,t){x.cssHooks[t]={get:function(e,n){return n?(n=vt(e,t),Ct.test(n)?x(e).position()[t]+"px":n):undefined}}})}),x.expr&&x.expr.filters&&(x.expr.filters.hidden=function(e){return 0>=e.offsetWidth&&0>=e.offsetHeight},x.expr.filters.visible=function(e){return!x.expr.filters.hidden(e)}),x.each({margin:"",padding:"",border:"Width"},function(e,t){x.cssHooks[e+t]={expand:function(n){var r=0,i={},o="string"==typeof n?n.split(" "):[n];for(;4>r;r++)i[e+jt[r]+t]=o[r]||o[r-2]||o[0];return i}},wt.test(e)||(x.cssHooks[e+t].set=Ot)});var Wt=/%20/g,$t=/\[\]$/,Bt=/\r?\n/g,It=/^(?:submit|button|image|reset|file)$/i,zt=/^(?:input|select|textarea|keygen)/i;x.fn.extend({serialize:function(){return x.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var e=x.prop(this,"elements");return e?x.makeArray(e):this}).filter(function(){var e=this.type;return this.name&&!x(this).is(":disabled")&&zt.test(this.nodeName)&&!It.test(e)&&(this.checked||!ot.test(e))}).map(function(e,t){var n=x(this).val();return null==n?null:x.isArray(n)?x.map(n,function(e){return{name:t.name,value:e.replace(Bt,"\r\n")}}):{name:t.name,value:n.replace(Bt,"\r\n")}}).get()}}),x.param=function(e,t){var n,r=[],i=function(e,t){t=x.isFunction(t)?t():null==t?"":t,r[r.length]=encodeURIComponent(e)+"="+encodeURIComponent(t)};if(t===undefined&&(t=x.ajaxSettings&&x.ajaxSettings.traditional),x.isArray(e)||e.jquery&&!x.isPlainObject(e))x.each(e,function(){i(this.name,this.value)});else for(n in e)_t(n,e[n],t,i);return r.join("&").replace(Wt,"+")};function _t(e,t,n,r){var i;if(x.isArray(t))x.each(t,function(t,i){n||$t.test(e)?r(e,i):_t(e+"["+("object"==typeof i?t:"")+"]",i,n,r)});else if(n||"object"!==x.type(t))r(e,t);else for(i in t)_t(e+"["+i+"]",t[i],n,r)}x.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(e,t){x.fn[t]=function(e,n){return arguments.length>0?this.on(t,null,e,n):this.trigger(t)}}),x.fn.extend({hover:function(e,t){return this.mouseenter(e).mouseleave(t||e)},bind:function(e,t,n){return this.on(e,null,t,n)},unbind:function(e,t){return this.off(e,null,t)
-},delegate:function(e,t,n,r){return this.on(t,e,n,r)},undelegate:function(e,t,n){return 1===arguments.length?this.off(e,"**"):this.off(t,e||"**",n)}});var Xt,Ut,Yt=x.now(),Vt=/\?/,Gt=/#.*$/,Jt=/([?&])_=[^&]*/,Qt=/^(.*?):[ \t]*([^\r\n]*)$/gm,Kt=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,Zt=/^(?:GET|HEAD)$/,en=/^\/\//,tn=/^([\w.+-]+:)(?:\/\/([^\/?#:]*)(?::(\d+)|)|)/,nn=x.fn.load,rn={},on={},sn="*/".concat("*");try{Ut=i.href}catch(an){Ut=o.createElement("a"),Ut.href="",Ut=Ut.href}Xt=tn.exec(Ut.toLowerCase())||[];function un(e){return function(t,n){"string"!=typeof t&&(n=t,t="*");var r,i=0,o=t.toLowerCase().match(w)||[];if(x.isFunction(n))while(r=o[i++])"+"===r[0]?(r=r.slice(1)||"*",(e[r]=e[r]||[]).unshift(n)):(e[r]=e[r]||[]).push(n)}}function ln(e,t,n,r){var i={},o=e===on;function s(a){var u;return i[a]=!0,x.each(e[a]||[],function(e,a){var l=a(t,n,r);return"string"!=typeof l||o||i[l]?o?!(u=l):undefined:(t.dataTypes.unshift(l),s(l),!1)}),u}return s(t.dataTypes[0])||!i["*"]&&s("*")}function cn(e,t){var n,r,i=x.ajaxSettings.flatOptions||{};for(n in t)t[n]!==undefined&&((i[n]?e:r||(r={}))[n]=t[n]);return r&&x.extend(!0,e,r),e}x.fn.load=function(e,t,n){if("string"!=typeof e&&nn)return nn.apply(this,arguments);var r,i,o,s=this,a=e.indexOf(" ");return a>=0&&(r=e.slice(a),e=e.slice(0,a)),x.isFunction(t)?(n=t,t=undefined):t&&"object"==typeof t&&(i="POST"),s.length>0&&x.ajax({url:e,type:i,dataType:"html",data:t}).done(function(e){o=arguments,s.html(r?x("<div>").append(x.parseHTML(e)).find(r):e)}).complete(n&&function(e,t){s.each(n,o||[e.responseText,t,e])}),this},x.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(e,t){x.fn[t]=function(e){return this.on(t,e)}}),x.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:Ut,type:"GET",isLocal:Kt.test(Xt[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":sn,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":x.parseJSON,"text xml":x.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(e,t){return t?cn(cn(e,x.ajaxSettings),t):cn(x.ajaxSettings,e)},ajaxPrefilter:un(rn),ajaxTransport:un(on),ajax:function(e,t){"object"==typeof e&&(t=e,e=undefined),t=t||{};var n,r,i,o,s,a,u,l,c=x.ajaxSetup({},t),p=c.context||c,f=c.context&&(p.nodeType||p.jquery)?x(p):x.event,h=x.Deferred(),d=x.Callbacks("once memory"),g=c.statusCode||{},m={},y={},v=0,b="canceled",T={readyState:0,getResponseHeader:function(e){var t;if(2===v){if(!o){o={};while(t=Qt.exec(i))o[t[1].toLowerCase()]=t[2]}t=o[e.toLowerCase()]}return null==t?null:t},getAllResponseHeaders:function(){return 2===v?i:null},setRequestHeader:function(e,t){var n=e.toLowerCase();return v||(e=y[n]=y[n]||e,m[e]=t),this},overrideMimeType:function(e){return v||(c.mimeType=e),this},statusCode:function(e){var t;if(e)if(2>v)for(t in e)g[t]=[g[t],e[t]];else T.always(e[T.status]);return this},abort:function(e){var t=e||b;return n&&n.abort(t),k(0,t),this}};if(h.promise(T).complete=d.add,T.success=T.done,T.error=T.fail,c.url=((e||c.url||Ut)+"").replace(Gt,"").replace(en,Xt[1]+"//"),c.type=t.method||t.type||c.method||c.type,c.dataTypes=x.trim(c.dataType||"*").toLowerCase().match(w)||[""],null==c.crossDomain&&(a=tn.exec(c.url.toLowerCase()),c.crossDomain=!(!a||a[1]===Xt[1]&&a[2]===Xt[2]&&(a[3]||("http:"===a[1]?"80":"443"))===(Xt[3]||("http:"===Xt[1]?"80":"443")))),c.data&&c.processData&&"string"!=typeof c.data&&(c.data=x.param(c.data,c.traditional)),ln(rn,c,t,T),2===v)return T;u=c.global,u&&0===x.active++&&x.event.trigger("ajaxStart"),c.type=c.type.toUpperCase(),c.hasContent=!Zt.test(c.type),r=c.url,c.hasContent||(c.data&&(r=c.url+=(Vt.test(r)?"&":"?")+c.data,delete c.data),c.cache===!1&&(c.url=Jt.test(r)?r.replace(Jt,"$1_="+Yt++):r+(Vt.test(r)?"&":"?")+"_="+Yt++)),c.ifModified&&(x.lastModified[r]&&T.setRequestHeader("If-Modified-Since",x.lastModified[r]),x.etag[r]&&T.setRequestHeader("If-None-Match",x.etag[r])),(c.data&&c.hasContent&&c.contentType!==!1||t.contentType)&&T.setRequestHeader("Content-Type",c.contentType),T.setRequestHeader("Accept",c.dataTypes[0]&&c.accepts[c.dataTypes[0]]?c.accepts[c.dataTypes[0]]+("*"!==c.dataTypes[0]?", "+sn+"; q=0.01":""):c.accepts["*"]);for(l in c.headers)T.setRequestHeader(l,c.headers[l]);if(c.beforeSend&&(c.beforeSend.call(p,T,c)===!1||2===v))return T.abort();b="abort";for(l in{success:1,error:1,complete:1})T[l](c[l]);if(n=ln(on,c,t,T)){T.readyState=1,u&&f.trigger("ajaxSend",[T,c]),c.async&&c.timeout>0&&(s=setTimeout(function(){T.abort("timeout")},c.timeout));try{v=1,n.send(m,k)}catch(C){if(!(2>v))throw C;k(-1,C)}}else k(-1,"No Transport");function k(e,t,o,a){var l,m,y,b,w,C=t;2!==v&&(v=2,s&&clearTimeout(s),n=undefined,i=a||"",T.readyState=e>0?4:0,l=e>=200&&300>e||304===e,o&&(b=pn(c,T,o)),b=fn(c,b,T,l),l?(c.ifModified&&(w=T.getResponseHeader("Last-Modified"),w&&(x.lastModified[r]=w),w=T.getResponseHeader("etag"),w&&(x.etag[r]=w)),204===e||"HEAD"===c.type?C="nocontent":304===e?C="notmodified":(C=b.state,m=b.data,y=b.error,l=!y)):(y=C,(e||!C)&&(C="error",0>e&&(e=0))),T.status=e,T.statusText=(t||C)+"",l?h.resolveWith(p,[m,C,T]):h.rejectWith(p,[T,C,y]),T.statusCode(g),g=undefined,u&&f.trigger(l?"ajaxSuccess":"ajaxError",[T,c,l?m:y]),d.fireWith(p,[T,C]),u&&(f.trigger("ajaxComplete",[T,c]),--x.active||x.event.trigger("ajaxStop")))}return T},getJSON:function(e,t,n){return x.get(e,t,n,"json")},getScript:function(e,t){return x.get(e,undefined,t,"script")}}),x.each(["get","post"],function(e,t){x[t]=function(e,n,r,i){return x.isFunction(n)&&(i=i||r,r=n,n=undefined),x.ajax({url:e,type:t,dataType:i,data:n,success:r})}});function pn(e,t,n){var r,i,o,s,a=e.contents,u=e.dataTypes;while("*"===u[0])u.shift(),r===undefined&&(r=e.mimeType||t.getResponseHeader("Content-Type"));if(r)for(i in a)if(a[i]&&a[i].test(r)){u.unshift(i);break}if(u[0]in n)o=u[0];else{for(i in n){if(!u[0]||e.converters[i+" "+u[0]]){o=i;break}s||(s=i)}o=o||s}return o?(o!==u[0]&&u.unshift(o),n[o]):undefined}function fn(e,t,n,r){var i,o,s,a,u,l={},c=e.dataTypes.slice();if(c[1])for(s in e.converters)l[s.toLowerCase()]=e.converters[s];o=c.shift();while(o)if(e.responseFields[o]&&(n[e.responseFields[o]]=t),!u&&r&&e.dataFilter&&(t=e.dataFilter(t,e.dataType)),u=o,o=c.shift())if("*"===o)o=u;else if("*"!==u&&u!==o){if(s=l[u+" "+o]||l["* "+o],!s)for(i in l)if(a=i.split(" "),a[1]===o&&(s=l[u+" "+a[0]]||l["* "+a[0]])){s===!0?s=l[i]:l[i]!==!0&&(o=a[0],c.unshift(a[1]));break}if(s!==!0)if(s&&e["throws"])t=s(t);else try{t=s(t)}catch(p){return{state:"parsererror",error:s?p:"No conversion from "+u+" to "+o}}}return{state:"success",data:t}}x.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(e){return x.globalEval(e),e}}}),x.ajaxPrefilter("script",function(e){e.cache===undefined&&(e.cache=!1),e.crossDomain&&(e.type="GET")}),x.ajaxTransport("script",function(e){if(e.crossDomain){var t,n;return{send:function(r,i){t=x("<script>").prop({async:!0,charset:e.scriptCharset,src:e.url}).on("load error",n=function(e){t.remove(),n=null,e&&i("error"===e.type?404:200,e.type)}),o.head.appendChild(t[0])},abort:function(){n&&n()}}}});var hn=[],dn=/(=)\?(?=&|$)|\?\?/;x.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var e=hn.pop()||x.expando+"_"+Yt++;return this[e]=!0,e}}),x.ajaxPrefilter("json jsonp",function(t,n,r){var i,o,s,a=t.jsonp!==!1&&(dn.test(t.url)?"url":"string"==typeof t.data&&!(t.contentType||"").indexOf("application/x-www-form-urlencoded")&&dn.test(t.data)&&"data");return a||"jsonp"===t.dataTypes[0]?(i=t.jsonpCallback=x.isFunction(t.jsonpCallback)?t.jsonpCallback():t.jsonpCallback,a?t[a]=t[a].replace(dn,"$1"+i):t.jsonp!==!1&&(t.url+=(Vt.test(t.url)?"&":"?")+t.jsonp+"="+i),t.converters["script json"]=function(){return s||x.error(i+" was not called"),s[0]},t.dataTypes[0]="json",o=e[i],e[i]=function(){s=arguments},r.always(function(){e[i]=o,t[i]&&(t.jsonpCallback=n.jsonpCallback,hn.push(i)),s&&x.isFunction(o)&&o(s[0]),s=o=undefined}),"script"):undefined}),x.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(e){}};var gn=x.ajaxSettings.xhr(),mn={0:200,1223:204},yn=0,vn={};e.ActiveXObject&&x(e).on("unload",function(){for(var e in vn)vn[e]();vn=undefined}),x.support.cors=!!gn&&"withCredentials"in gn,x.support.ajax=gn=!!gn,x.ajaxTransport(function(e){var t;return x.support.cors||gn&&!e.crossDomain?{send:function(n,r){var i,o,s=e.xhr();if(s.open(e.type,e.url,e.async,e.username,e.password),e.xhrFields)for(i in e.xhrFields)s[i]=e.xhrFields[i];e.mimeType&&s.overrideMimeType&&s.overrideMimeType(e.mimeType),e.crossDomain||n["X-Requested-With"]||(n["X-Requested-With"]="XMLHttpRequest");for(i in n)s.setRequestHeader(i,n[i]);t=function(e){return function(){t&&(delete vn[o],t=s.onload=s.onerror=null,"abort"===e?s.abort():"error"===e?r(s.status||404,s.statusText):r(mn[s.status]||s.status,s.statusText,"string"==typeof s.responseText?{text:s.responseText}:undefined,s.getAllResponseHeaders()))}},s.onload=t(),s.onerror=t("error"),t=vn[o=yn++]=t("abort"),s.send(e.hasContent&&e.data||null)},abort:function(){t&&t()}}:undefined});var xn,bn,wn=/^(?:toggle|show|hide)$/,Tn=RegExp("^(?:([+-])=|)("+b+")([a-z%]*)$","i"),Cn=/queueHooks$/,kn=[An],Nn={"*":[function(e,t){var n=this.createTween(e,t),r=n.cur(),i=Tn.exec(t),o=i&&i[3]||(x.cssNumber[e]?"":"px"),s=(x.cssNumber[e]||"px"!==o&&+r)&&Tn.exec(x.css(n.elem,e)),a=1,u=20;if(s&&s[3]!==o){o=o||s[3],i=i||[],s=+r||1;do a=a||".5",s/=a,x.style(n.elem,e,s+o);while(a!==(a=n.cur()/r)&&1!==a&&--u)}return i&&(s=n.start=+s||+r||0,n.unit=o,n.end=i[1]?s+(i[1]+1)*i[2]:+i[2]),n}]};function En(){return setTimeout(function(){xn=undefined}),xn=x.now()}function Sn(e,t,n){var r,i=(Nn[t]||[]).concat(Nn["*"]),o=0,s=i.length;for(;s>o;o++)if(r=i[o].call(n,t,e))return r}function jn(e,t,n){var r,i,o=0,s=kn.length,a=x.Deferred().always(function(){delete u.elem}),u=function(){if(i)return!1;var t=xn||En(),n=Math.max(0,l.startTime+l.duration-t),r=n/l.duration||0,o=1-r,s=0,u=l.tweens.length;for(;u>s;s++)l.tweens[s].run(o);return a.notifyWith(e,[l,o,n]),1>o&&u?n:(a.resolveWith(e,[l]),!1)},l=a.promise({elem:e,props:x.extend({},t),opts:x.extend(!0,{specialEasing:{}},n),originalProperties:t,originalOptions:n,startTime:xn||En(),duration:n.duration,tweens:[],createTween:function(t,n){var r=x.Tween(e,l.opts,t,n,l.opts.specialEasing[t]||l.opts.easing);return l.tweens.push(r),r},stop:function(t){var n=0,r=t?l.tweens.length:0;if(i)return this;for(i=!0;r>n;n++)l.tweens[n].run(1);return t?a.resolveWith(e,[l,t]):a.rejectWith(e,[l,t]),this}}),c=l.props;for(Dn(c,l.opts.specialEasing);s>o;o++)if(r=kn[o].call(l,e,c,l.opts))return r;return x.map(c,Sn,l),x.isFunction(l.opts.start)&&l.opts.start.call(e,l),x.fx.timer(x.extend(u,{elem:e,anim:l,queue:l.opts.queue})),l.progress(l.opts.progress).done(l.opts.done,l.opts.complete).fail(l.opts.fail).always(l.opts.always)}function Dn(e,t){var n,r,i,o,s;for(n in e)if(r=x.camelCase(n),i=t[r],o=e[n],x.isArray(o)&&(i=o[1],o=e[n]=o[0]),n!==r&&(e[r]=o,delete e[n]),s=x.cssHooks[r],s&&"expand"in s){o=s.expand(o),delete e[r];for(n in o)n in e||(e[n]=o[n],t[n]=i)}else t[r]=i}x.Animation=x.extend(jn,{tweener:function(e,t){x.isFunction(e)?(t=e,e=["*"]):e=e.split(" ");var n,r=0,i=e.length;for(;i>r;r++)n=e[r],Nn[n]=Nn[n]||[],Nn[n].unshift(t)},prefilter:function(e,t){t?kn.unshift(e):kn.push(e)}});function An(e,t,n){var r,i,o,s,a,u,l=this,c={},p=e.style,f=e.nodeType&&Lt(e),h=q.get(e,"fxshow");n.queue||(a=x._queueHooks(e,"fx"),null==a.unqueued&&(a.unqueued=0,u=a.empty.fire,a.empty.fire=function(){a.unqueued||u()}),a.unqueued++,l.always(function(){l.always(function(){a.unqueued--,x.queue(e,"fx").length||a.empty.fire()})})),1===e.nodeType&&("height"in t||"width"in t)&&(n.overflow=[p.overflow,p.overflowX,p.overflowY],"inline"===x.css(e,"display")&&"none"===x.css(e,"float")&&(p.display="inline-block")),n.overflow&&(p.overflow="hidden",l.always(function(){p.overflow=n.overflow[0],p.overflowX=n.overflow[1],p.overflowY=n.overflow[2]}));for(r in t)if(i=t[r],wn.exec(i)){if(delete t[r],o=o||"toggle"===i,i===(f?"hide":"show")){if("show"!==i||!h||h[r]===undefined)continue;f=!0}c[r]=h&&h[r]||x.style(e,r)}if(!x.isEmptyObject(c)){h?"hidden"in h&&(f=h.hidden):h=q.access(e,"fxshow",{}),o&&(h.hidden=!f),f?x(e).show():l.done(function(){x(e).hide()}),l.done(function(){var t;q.remove(e,"fxshow");for(t in c)x.style(e,t,c[t])});for(r in c)s=Sn(f?h[r]:0,r,l),r in h||(h[r]=s.start,f&&(s.end=s.start,s.start="width"===r||"height"===r?1:0))}}function Ln(e,t,n,r,i){return new Ln.prototype.init(e,t,n,r,i)}x.Tween=Ln,Ln.prototype={constructor:Ln,init:function(e,t,n,r,i,o){this.elem=e,this.prop=n,this.easing=i||"swing",this.options=t,this.start=this.now=this.cur(),this.end=r,this.unit=o||(x.cssNumber[n]?"":"px")},cur:function(){var e=Ln.propHooks[this.prop];return e&&e.get?e.get(this):Ln.propHooks._default.get(this)},run:function(e){var t,n=Ln.propHooks[this.prop];return this.pos=t=this.options.duration?x.easing[this.easing](e,this.options.duration*e,0,1,this.options.duration):e,this.now=(this.end-this.start)*t+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),n&&n.set?n.set(this):Ln.propHooks._default.set(this),this}},Ln.prototype.init.prototype=Ln.prototype,Ln.propHooks={_default:{get:function(e){var t;return null==e.elem[e.prop]||e.elem.style&&null!=e.elem.style[e.prop]?(t=x.css(e.elem,e.prop,""),t&&"auto"!==t?t:0):e.elem[e.prop]},set:function(e){x.fx.step[e.prop]?x.fx.step[e.prop](e):e.elem.style&&(null!=e.elem.style[x.cssProps[e.prop]]||x.cssHooks[e.prop])?x.style(e.elem,e.prop,e.now+e.unit):e.elem[e.prop]=e.now}}},Ln.propHooks.scrollTop=Ln.propHooks.scrollLeft={set:function(e){e.elem.nodeType&&e.elem.parentNode&&(e.elem[e.prop]=e.now)}},x.each(["toggle","show","hide"],function(e,t){var n=x.fn[t];x.fn[t]=function(e,r,i){return null==e||"boolean"==typeof e?n.apply(this,arguments):this.animate(qn(t,!0),e,r,i)}}),x.fn.extend({fadeTo:function(e,t,n,r){return this.filter(Lt).css("opacity",0).show().end().animate({opacity:t},e,n,r)},animate:function(e,t,n,r){var i=x.isEmptyObject(e),o=x.speed(t,n,r),s=function(){var t=jn(this,x.extend({},e),o);(i||q.get(this,"finish"))&&t.stop(!0)};return s.finish=s,i||o.queue===!1?this.each(s):this.queue(o.queue,s)},stop:function(e,t,n){var r=function(e){var t=e.stop;delete e.stop,t(n)};return"string"!=typeof e&&(n=t,t=e,e=undefined),t&&e!==!1&&this.queue(e||"fx",[]),this.each(function(){var t=!0,i=null!=e&&e+"queueHooks",o=x.timers,s=q.get(this);if(i)s[i]&&s[i].stop&&r(s[i]);else for(i in s)s[i]&&s[i].stop&&Cn.test(i)&&r(s[i]);for(i=o.length;i--;)o[i].elem!==this||null!=e&&o[i].queue!==e||(o[i].anim.stop(n),t=!1,o.splice(i,1));(t||!n)&&x.dequeue(this,e)})},finish:function(e){return e!==!1&&(e=e||"fx"),this.each(function(){var t,n=q.get(this),r=n[e+"queue"],i=n[e+"queueHooks"],o=x.timers,s=r?r.length:0;for(n.finish=!0,x.queue(this,e,[]),i&&i.stop&&i.stop.call(this,!0),t=o.length;t--;)o[t].elem===this&&o[t].queue===e&&(o[t].anim.stop(!0),o.splice(t,1));for(t=0;s>t;t++)r[t]&&r[t].finish&&r[t].finish.call(this);delete n.finish})}});function qn(e,t){var n,r={height:e},i=0;for(t=t?1:0;4>i;i+=2-t)n=jt[i],r["margin"+n]=r["padding"+n]=e;return t&&(r.opacity=r.width=e),r}x.each({slideDown:qn("show"),slideUp:qn("hide"),slideToggle:qn("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(e,t){x.fn[e]=function(e,n,r){return this.animate(t,e,n,r)}}),x.speed=function(e,t,n){var r=e&&"object"==typeof e?x.extend({},e):{complete:n||!n&&t||x.isFunction(e)&&e,duration:e,easing:n&&t||t&&!x.isFunction(t)&&t};return r.duration=x.fx.off?0:"number"==typeof r.duration?r.duration:r.duration in x.fx.speeds?x.fx.speeds[r.duration]:x.fx.speeds._default,(null==r.queue||r.queue===!0)&&(r.queue="fx"),r.old=r.complete,r.complete=function(){x.isFunction(r.old)&&r.old.call(this),r.queue&&x.dequeue(this,r.queue)},r},x.easing={linear:function(e){return e},swing:function(e){return.5-Math.cos(e*Math.PI)/2}},x.timers=[],x.fx=Ln.prototype.init,x.fx.tick=function(){var e,t=x.timers,n=0;for(xn=x.now();t.length>n;n++)e=t[n],e()||t[n]!==e||t.splice(n--,1);t.length||x.fx.stop(),xn=undefined},x.fx.timer=function(e){e()&&x.timers.push(e)&&x.fx.start()},x.fx.interval=13,x.fx.start=function(){bn||(bn=setInterval(x.fx.tick,x.fx.interval))},x.fx.stop=function(){clearInterval(bn),bn=null},x.fx.speeds={slow:600,fast:200,_default:400},x.fx.step={},x.expr&&x.expr.filters&&(x.expr.filters.animated=function(e){return x.grep(x.timers,function(t){return e===t.elem}).length}),x.fn.offset=function(e){if(arguments.length)return e===undefined?this:this.each(function(t){x.offset.setOffset(this,e,t)});var t,n,i=this[0],o={top:0,left:0},s=i&&i.ownerDocument;if(s)return t=s.documentElement,x.contains(t,i)?(typeof i.getBoundingClientRect!==r&&(o=i.getBoundingClientRect()),n=Hn(s),{top:o.top+n.pageYOffset-t.clientTop,left:o.left+n.pageXOffset-t.clientLeft}):o},x.offset={setOffset:function(e,t,n){var r,i,o,s,a,u,l,c=x.css(e,"position"),p=x(e),f={};"static"===c&&(e.style.position="relative"),a=p.offset(),o=x.css(e,"top"),u=x.css(e,"left"),l=("absolute"===c||"fixed"===c)&&(o+u).indexOf("auto")>-1,l?(r=p.position(),s=r.top,i=r.left):(s=parseFloat(o)||0,i=parseFloat(u)||0),x.isFunction(t)&&(t=t.call(e,n,a)),null!=t.top&&(f.top=t.top-a.top+s),null!=t.left&&(f.left=t.left-a.left+i),"using"in t?t.using.call(e,f):p.css(f)}},x.fn.extend({position:function(){if(this[0]){var e,t,n=this[0],r={top:0,left:0};return"fixed"===x.css(n,"position")?t=n.getBoundingClientRect():(e=this.offsetParent(),t=this.offset(),x.nodeName(e[0],"html")||(r=e.offset()),r.top+=x.css(e[0],"borderTopWidth",!0),r.left+=x.css(e[0],"borderLeftWidth",!0)),{top:t.top-r.top-x.css(n,"marginTop",!0),left:t.left-r.left-x.css(n,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var e=this.offsetParent||s;while(e&&!x.nodeName(e,"html")&&"static"===x.css(e,"position"))e=e.offsetParent;return e||s})}}),x.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(t,n){var r="pageYOffset"===n;x.fn[t]=function(i){return x.access(this,function(t,i,o){var s=Hn(t);return o===undefined?s?s[n]:t[i]:(s?s.scrollTo(r?e.pageXOffset:o,r?o:e.pageYOffset):t[i]=o,undefined)},t,i,arguments.length,null)}});function Hn(e){return x.isWindow(e)?e:9===e.nodeType&&e.defaultView}x.each({Height:"height",Width:"width"},function(e,t){x.each({padding:"inner"+e,content:t,"":"outer"+e},function(n,r){x.fn[r]=function(r,i){var o=arguments.length&&(n||"boolean"!=typeof r),s=n||(r===!0||i===!0?"margin":"border");return x.access(this,function(t,n,r){var i;return x.isWindow(t)?t.document.documentElement["client"+e]:9===t.nodeType?(i=t.documentElement,Math.max(t.body["scroll"+e],i["scroll"+e],t.body["offset"+e],i["offset"+e],i["client"+e])):r===undefined?x.css(t,n,s):x.style(t,n,r,s)},t,o?r:undefined,o,null)}})}),x.fn.size=function(){return this.length},x.fn.andSelf=x.fn.addBack,"object"==typeof module&&module&&"object"==typeof module.exports?module.exports=x:"function"==typeof define&&define.amd&&define("jquery",[],function(){return x}),"object"==typeof e&&"object"==typeof e.document&&(e.jQuery=e.$=x)})(window);
diff --git a/libs/editor-common/assets/jquery-2.1.3.min.js b/libs/editor-common/assets/jquery-2.1.3.min.js
new file mode 100644
index 000000000000..25714ed29ab6
--- /dev/null
+++ b/libs/editor-common/assets/jquery-2.1.3.min.js
@@ -0,0 +1,4 @@
+/*! jQuery v2.1.3 | (c) 2005, 2014 jQuery Foundation, Inc. | jquery.org/license */
+!function(a,b){"object"==typeof module&&"object"==typeof module.exports?module.exports=a.document?b(a,!0):function(a){if(!a.document)throw new Error("jQuery requires a window with a document");return b(a)}:b(a)}("undefined"!=typeof window?window:this,function(a,b){var c=[],d=c.slice,e=c.concat,f=c.push,g=c.indexOf,h={},i=h.toString,j=h.hasOwnProperty,k={},l=a.document,m="2.1.3",n=function(a,b){return new n.fn.init(a,b)},o=/^[\s\uFEFF\xA0]+|[\s\uFEFF\xA0]+$/g,p=/^-ms-/,q=/-([\da-z])/gi,r=function(a,b){return b.toUpperCase()};n.fn=n.prototype={jquery:m,constructor:n,selector:"",length:0,toArray:function(){return d.call(this)},get:function(a){return null!=a?0>a?this[a+this.length]:this[a]:d.call(this)},pushStack:function(a){var b=n.merge(this.constructor(),a);return b.prevObject=this,b.context=this.context,b},each:function(a,b){return n.each(this,a,b)},map:function(a){return this.pushStack(n.map(this,function(b,c){return a.call(b,c,b)}))},slice:function(){return this.pushStack(d.apply(this,arguments))},first:function(){return this.eq(0)},last:function(){return this.eq(-1)},eq:function(a){var b=this.length,c=+a+(0>a?b:0);return this.pushStack(c>=0&&b>c?[this[c]]:[])},end:function(){return this.prevObject||this.constructor(null)},push:f,sort:c.sort,splice:c.splice},n.extend=n.fn.extend=function(){var a,b,c,d,e,f,g=arguments[0]||{},h=1,i=arguments.length,j=!1;for("boolean"==typeof g&&(j=g,g=arguments[h]||{},h++),"object"==typeof g||n.isFunction(g)||(g={}),h===i&&(g=this,h--);i>h;h++)if(null!=(a=arguments[h]))for(b in a)c=g[b],d=a[b],g!==d&&(j&&d&&(n.isPlainObject(d)||(e=n.isArray(d)))?(e?(e=!1,f=c&&n.isArray(c)?c:[]):f=c&&n.isPlainObject(c)?c:{},g[b]=n.extend(j,f,d)):void 0!==d&&(g[b]=d));return g},n.extend({expando:"jQuery"+(m+Math.random()).replace(/\D/g,""),isReady:!0,error:function(a){throw new Error(a)},noop:function(){},isFunction:function(a){return"function"===n.type(a)},isArray:Array.isArray,isWindow:function(a){return null!=a&&a===a.window},isNumeric:function(a){return!n.isArray(a)&&a-parseFloat(a)+1>=0},isPlainObject:function(a){return"object"!==n.type(a)||a.nodeType||n.isWindow(a)?!1:a.constructor&&!j.call(a.constructor.prototype,"isPrototypeOf")?!1:!0},isEmptyObject:function(a){var b;for(b in a)return!1;return!0},type:function(a){return null==a?a+"":"object"==typeof a||"function"==typeof a?h[i.call(a)]||"object":typeof a},globalEval:function(a){var b,c=eval;a=n.trim(a),a&&(1===a.indexOf("use strict")?(b=l.createElement("script"),b.text=a,l.head.appendChild(b).parentNode.removeChild(b)):c(a))},camelCase:function(a){return a.replace(p,"ms-").replace(q,r)},nodeName:function(a,b){return a.nodeName&&a.nodeName.toLowerCase()===b.toLowerCase()},each:function(a,b,c){var d,e=0,f=a.length,g=s(a);if(c){if(g){for(;f>e;e++)if(d=b.apply(a[e],c),d===!1)break}else for(e in a)if(d=b.apply(a[e],c),d===!1)break}else if(g){for(;f>e;e++)if(d=b.call(a[e],e,a[e]),d===!1)break}else for(e in a)if(d=b.call(a[e],e,a[e]),d===!1)break;return a},trim:function(a){return null==a?"":(a+"").replace(o,"")},makeArray:function(a,b){var c=b||[];return null!=a&&(s(Object(a))?n.merge(c,"string"==typeof a?[a]:a):f.call(c,a)),c},inArray:function(a,b,c){return null==b?-1:g.call(b,a,c)},merge:function(a,b){for(var c=+b.length,d=0,e=a.length;c>d;d++)a[e++]=b[d];return a.length=e,a},grep:function(a,b,c){for(var d,e=[],f=0,g=a.length,h=!c;g>f;f++)d=!b(a[f],f),d!==h&&e.push(a[f]);return e},map:function(a,b,c){var d,f=0,g=a.length,h=s(a),i=[];if(h)for(;g>f;f++)d=b(a[f],f,c),null!=d&&i.push(d);else for(f in a)d=b(a[f],f,c),null!=d&&i.push(d);return e.apply([],i)},guid:1,proxy:function(a,b){var c,e,f;return"string"==typeof b&&(c=a[b],b=a,a=c),n.isFunction(a)?(e=d.call(arguments,2),f=function(){return a.apply(b||this,e.concat(d.call(arguments)))},f.guid=a.guid=a.guid||n.guid++,f):void 0},now:Date.now,support:k}),n.each("Boolean Number String Function Array Date RegExp Object Error".split(" "),function(a,b){h["[object "+b+"]"]=b.toLowerCase()});function s(a){var b=a.length,c=n.type(a);return"function"===c||n.isWindow(a)?!1:1===a.nodeType&&b?!0:"array"===c||0===b||"number"==typeof b&&b>0&&b-1 in a}var t=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u="sizzle"+1*new Date,v=a.document,w=0,x=0,y=hb(),z=hb(),A=hb(),B=function(a,b){return a===b&&(l=!0),0},C=1<<31,D={}.hasOwnProperty,E=[],F=E.pop,G=E.push,H=E.push,I=E.slice,J=function(a,b){for(var c=0,d=a.length;d>c;c++)if(a[c]===b)return c;return-1},K="checked|selected|async|autofocus|autoplay|controls|defer|disabled|hidden|ismap|loop|multiple|open|readonly|required|scoped",L="[\\x20\\t\\r\\n\\f]",M="(?:\\\\.|[\\w-]|[^\\x00-\\xa0])+",N=M.replace("w","w#"),O="\\["+L+"*("+M+")(?:"+L+"*([*^$|!~]?=)"+L+"*(?:'((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\"|("+N+"))|)"+L+"*\\]",P=":("+M+")(?:\\((('((?:\\\\.|[^\\\\'])*)'|\"((?:\\\\.|[^\\\\\"])*)\")|((?:\\\\.|[^\\\\()[\\]]|"+O+")*)|.*)\\)|)",Q=new RegExp(L+"+","g"),R=new RegExp("^"+L+"+|((?:^|[^\\\\])(?:\\\\.)*)"+L+"+$","g"),S=new RegExp("^"+L+"*,"+L+"*"),T=new RegExp("^"+L+"*([>+~]|"+L+")"+L+"*"),U=new RegExp("="+L+"*([^\\]'\"]*?)"+L+"*\\]","g"),V=new RegExp(P),W=new RegExp("^"+N+"$"),X={ID:new RegExp("^#("+M+")"),CLASS:new RegExp("^\\.("+M+")"),TAG:new RegExp("^("+M.replace("w","w*")+")"),ATTR:new RegExp("^"+O),PSEUDO:new RegExp("^"+P),CHILD:new RegExp("^:(only|first|last|nth|nth-last)-(child|of-type)(?:\\("+L+"*(even|odd|(([+-]|)(\\d*)n|)"+L+"*(?:([+-]|)"+L+"*(\\d+)|))"+L+"*\\)|)","i"),bool:new RegExp("^(?:"+K+")$","i"),needsContext:new RegExp("^"+L+"*[>+~]|:(even|odd|eq|gt|lt|nth|first|last)(?:\\("+L+"*((?:-\\d)?\\d*)"+L+"*\\)|)(?=[^-]|$)","i")},Y=/^(?:input|select|textarea|button)$/i,Z=/^h\d$/i,$=/^[^{]+\{\s*\[native \w/,_=/^(?:#([\w-]+)|(\w+)|\.([\w-]+))$/,ab=/[+~]/,bb=/'|\\/g,cb=new RegExp("\\\\([\\da-f]{1,6}"+L+"?|("+L+")|.)","ig"),db=function(a,b,c){var d="0x"+b-65536;return d!==d||c?b:0>d?String.fromCharCode(d+65536):String.fromCharCode(d>>10|55296,1023&d|56320)},eb=function(){m()};try{H.apply(E=I.call(v.childNodes),v.childNodes),E[v.childNodes.length].nodeType}catch(fb){H={apply:E.length?function(a,b){G.apply(a,I.call(b))}:function(a,b){var c=a.length,d=0;while(a[c++]=b[d++]);a.length=c-1}}}function gb(a,b,d,e){var f,h,j,k,l,o,r,s,w,x;if((b?b.ownerDocument||b:v)!==n&&m(b),b=b||n,d=d||[],k=b.nodeType,"string"!=typeof a||!a||1!==k&&9!==k&&11!==k)return d;if(!e&&p){if(11!==k&&(f=_.exec(a)))if(j=f[1]){if(9===k){if(h=b.getElementById(j),!h||!h.parentNode)return d;if(h.id===j)return d.push(h),d}else if(b.ownerDocument&&(h=b.ownerDocument.getElementById(j))&&t(b,h)&&h.id===j)return d.push(h),d}else{if(f[2])return H.apply(d,b.getElementsByTagName(a)),d;if((j=f[3])&&c.getElementsByClassName)return H.apply(d,b.getElementsByClassName(j)),d}if(c.qsa&&(!q||!q.test(a))){if(s=r=u,w=b,x=1!==k&&a,1===k&&"object"!==b.nodeName.toLowerCase()){o=g(a),(r=b.getAttribute("id"))?s=r.replace(bb,"\\$&"):b.setAttribute("id",s),s="[id='"+s+"'] ",l=o.length;while(l--)o[l]=s+rb(o[l]);w=ab.test(a)&&pb(b.parentNode)||b,x=o.join(",")}if(x)try{return H.apply(d,w.querySelectorAll(x)),d}catch(y){}finally{r||b.removeAttribute("id")}}}return i(a.replace(R,"$1"),b,d,e)}function hb(){var a=[];function b(c,e){return a.push(c+" ")>d.cacheLength&&delete b[a.shift()],b[c+" "]=e}return b}function ib(a){return a[u]=!0,a}function jb(a){var b=n.createElement("div");try{return!!a(b)}catch(c){return!1}finally{b.parentNode&&b.parentNode.removeChild(b),b=null}}function kb(a,b){var c=a.split("|"),e=a.length;while(e--)d.attrHandle[c[e]]=b}function lb(a,b){var c=b&&a,d=c&&1===a.nodeType&&1===b.nodeType&&(~b.sourceIndex||C)-(~a.sourceIndex||C);if(d)return d;if(c)while(c=c.nextSibling)if(c===b)return-1;return a?1:-1}function mb(a){return function(b){var c=b.nodeName.toLowerCase();return"input"===c&&b.type===a}}function nb(a){return function(b){var c=b.nodeName.toLowerCase();return("input"===c||"button"===c)&&b.type===a}}function ob(a){return ib(function(b){return b=+b,ib(function(c,d){var e,f=a([],c.length,b),g=f.length;while(g--)c[e=f[g]]&&(c[e]=!(d[e]=c[e]))})})}function pb(a){return a&&"undefined"!=typeof a.getElementsByTagName&&a}c=gb.support={},f=gb.isXML=function(a){var b=a&&(a.ownerDocument||a).documentElement;return b?"HTML"!==b.nodeName:!1},m=gb.setDocument=function(a){var b,e,g=a?a.ownerDocument||a:v;return g!==n&&9===g.nodeType&&g.documentElement?(n=g,o=g.documentElement,e=g.defaultView,e&&e!==e.top&&(e.addEventListener?e.addEventListener("unload",eb,!1):e.attachEvent&&e.attachEvent("onunload",eb)),p=!f(g),c.attributes=jb(function(a){return a.className="i",!a.getAttribute("className")}),c.getElementsByTagName=jb(function(a){return a.appendChild(g.createComment("")),!a.getElementsByTagName("*").length}),c.getElementsByClassName=$.test(g.getElementsByClassName),c.getById=jb(function(a){return o.appendChild(a).id=u,!g.getElementsByName||!g.getElementsByName(u).length}),c.getById?(d.find.ID=function(a,b){if("undefined"!=typeof b.getElementById&&p){var c=b.getElementById(a);return c&&c.parentNode?[c]:[]}},d.filter.ID=function(a){var b=a.replace(cb,db);return function(a){return a.getAttribute("id")===b}}):(delete d.find.ID,d.filter.ID=function(a){var b=a.replace(cb,db);return function(a){var c="undefined"!=typeof a.getAttributeNode&&a.getAttributeNode("id");return c&&c.value===b}}),d.find.TAG=c.getElementsByTagName?function(a,b){return"undefined"!=typeof b.getElementsByTagName?b.getElementsByTagName(a):c.qsa?b.querySelectorAll(a):void 0}:function(a,b){var c,d=[],e=0,f=b.getElementsByTagName(a);if("*"===a){while(c=f[e++])1===c.nodeType&&d.push(c);return d}return f},d.find.CLASS=c.getElementsByClassName&&function(a,b){return p?b.getElementsByClassName(a):void 0},r=[],q=[],(c.qsa=$.test(g.querySelectorAll))&&(jb(function(a){o.appendChild(a).innerHTML="<a id='"+u+"'></a><select id='"+u+"-\f]' msallowcapture=''><option selected=''></option></select>",a.querySelectorAll("[msallowcapture^='']").length&&q.push("[*^$]="+L+"*(?:''|\"\")"),a.querySelectorAll("[selected]").length||q.push("\\["+L+"*(?:value|"+K+")"),a.querySelectorAll("[id~="+u+"-]").length||q.push("~="),a.querySelectorAll(":checked").length||q.push(":checked"),a.querySelectorAll("a#"+u+"+*").length||q.push(".#.+[+~]")}),jb(function(a){var b=g.createElement("input");b.setAttribute("type","hidden"),a.appendChild(b).setAttribute("name","D"),a.querySelectorAll("[name=d]").length&&q.push("name"+L+"*[*^$|!~]?="),a.querySelectorAll(":enabled").length||q.push(":enabled",":disabled"),a.querySelectorAll("*,:x"),q.push(",.*:")})),(c.matchesSelector=$.test(s=o.matches||o.webkitMatchesSelector||o.mozMatchesSelector||o.oMatchesSelector||o.msMatchesSelector))&&jb(function(a){c.disconnectedMatch=s.call(a,"div"),s.call(a,"[s!='']:x"),r.push("!=",P)}),q=q.length&&new RegExp(q.join("|")),r=r.length&&new RegExp(r.join("|")),b=$.test(o.compareDocumentPosition),t=b||$.test(o.contains)?function(a,b){var c=9===a.nodeType?a.documentElement:a,d=b&&b.parentNode;return a===d||!(!d||1!==d.nodeType||!(c.contains?c.contains(d):a.compareDocumentPosition&&16&a.compareDocumentPosition(d)))}:function(a,b){if(b)while(b=b.parentNode)if(b===a)return!0;return!1},B=b?function(a,b){if(a===b)return l=!0,0;var d=!a.compareDocumentPosition-!b.compareDocumentPosition;return d?d:(d=(a.ownerDocument||a)===(b.ownerDocument||b)?a.compareDocumentPosition(b):1,1&d||!c.sortDetached&&b.compareDocumentPosition(a)===d?a===g||a.ownerDocument===v&&t(v,a)?-1:b===g||b.ownerDocument===v&&t(v,b)?1:k?J(k,a)-J(k,b):0:4&d?-1:1)}:function(a,b){if(a===b)return l=!0,0;var c,d=0,e=a.parentNode,f=b.parentNode,h=[a],i=[b];if(!e||!f)return a===g?-1:b===g?1:e?-1:f?1:k?J(k,a)-J(k,b):0;if(e===f)return lb(a,b);c=a;while(c=c.parentNode)h.unshift(c);c=b;while(c=c.parentNode)i.unshift(c);while(h[d]===i[d])d++;return d?lb(h[d],i[d]):h[d]===v?-1:i[d]===v?1:0},g):n},gb.matches=function(a,b){return gb(a,null,null,b)},gb.matchesSelector=function(a,b){if((a.ownerDocument||a)!==n&&m(a),b=b.replace(U,"='$1']"),!(!c.matchesSelector||!p||r&&r.test(b)||q&&q.test(b)))try{var d=s.call(a,b);if(d||c.disconnectedMatch||a.document&&11!==a.document.nodeType)return d}catch(e){}return gb(b,n,null,[a]).length>0},gb.contains=function(a,b){return(a.ownerDocument||a)!==n&&m(a),t(a,b)},gb.attr=function(a,b){(a.ownerDocument||a)!==n&&m(a);var e=d.attrHandle[b.toLowerCase()],f=e&&D.call(d.attrHandle,b.toLowerCase())?e(a,b,!p):void 0;return void 0!==f?f:c.attributes||!p?a.getAttribute(b):(f=a.getAttributeNode(b))&&f.specified?f.value:null},gb.error=function(a){throw new Error("Syntax error, unrecognized expression: "+a)},gb.uniqueSort=function(a){var b,d=[],e=0,f=0;if(l=!c.detectDuplicates,k=!c.sortStable&&a.slice(0),a.sort(B),l){while(b=a[f++])b===a[f]&&(e=d.push(f));while(e--)a.splice(d[e],1)}return k=null,a},e=gb.getText=function(a){var b,c="",d=0,f=a.nodeType;if(f){if(1===f||9===f||11===f){if("string"==typeof a.textContent)return a.textContent;for(a=a.firstChild;a;a=a.nextSibling)c+=e(a)}else if(3===f||4===f)return a.nodeValue}else while(b=a[d++])c+=e(b);return c},d=gb.selectors={cacheLength:50,createPseudo:ib,match:X,attrHandle:{},find:{},relative:{">":{dir:"parentNode",first:!0}," ":{dir:"parentNode"},"+":{dir:"previousSibling",first:!0},"~":{dir:"previousSibling"}},preFilter:{ATTR:function(a){return a[1]=a[1].replace(cb,db),a[3]=(a[3]||a[4]||a[5]||"").replace(cb,db),"~="===a[2]&&(a[3]=" "+a[3]+" "),a.slice(0,4)},CHILD:function(a){return a[1]=a[1].toLowerCase(),"nth"===a[1].slice(0,3)?(a[3]||gb.error(a[0]),a[4]=+(a[4]?a[5]+(a[6]||1):2*("even"===a[3]||"odd"===a[3])),a[5]=+(a[7]+a[8]||"odd"===a[3])):a[3]&&gb.error(a[0]),a},PSEUDO:function(a){var b,c=!a[6]&&a[2];return X.CHILD.test(a[0])?null:(a[3]?a[2]=a[4]||a[5]||"":c&&V.test(c)&&(b=g(c,!0))&&(b=c.indexOf(")",c.length-b)-c.length)&&(a[0]=a[0].slice(0,b),a[2]=c.slice(0,b)),a.slice(0,3))}},filter:{TAG:function(a){var b=a.replace(cb,db).toLowerCase();return"*"===a?function(){return!0}:function(a){return a.nodeName&&a.nodeName.toLowerCase()===b}},CLASS:function(a){var b=y[a+" "];return b||(b=new RegExp("(^|"+L+")"+a+"("+L+"|$)"))&&y(a,function(a){return b.test("string"==typeof a.className&&a.className||"undefined"!=typeof a.getAttribute&&a.getAttribute("class")||"")})},ATTR:function(a,b,c){return function(d){var e=gb.attr(d,a);return null==e?"!="===b:b?(e+="","="===b?e===c:"!="===b?e!==c:"^="===b?c&&0===e.indexOf(c):"*="===b?c&&e.indexOf(c)>-1:"$="===b?c&&e.slice(-c.length)===c:"~="===b?(" "+e.replace(Q," ")+" ").indexOf(c)>-1:"|="===b?e===c||e.slice(0,c.length+1)===c+"-":!1):!0}},CHILD:function(a,b,c,d,e){var f="nth"!==a.slice(0,3),g="last"!==a.slice(-4),h="of-type"===b;return 1===d&&0===e?function(a){return!!a.parentNode}:function(b,c,i){var j,k,l,m,n,o,p=f!==g?"nextSibling":"previousSibling",q=b.parentNode,r=h&&b.nodeName.toLowerCase(),s=!i&&!h;if(q){if(f){while(p){l=b;while(l=l[p])if(h?l.nodeName.toLowerCase()===r:1===l.nodeType)return!1;o=p="only"===a&&!o&&"nextSibling"}return!0}if(o=[g?q.firstChild:q.lastChild],g&&s){k=q[u]||(q[u]={}),j=k[a]||[],n=j[0]===w&&j[1],m=j[0]===w&&j[2],l=n&&q.childNodes[n];while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if(1===l.nodeType&&++m&&l===b){k[a]=[w,n,m];break}}else if(s&&(j=(b[u]||(b[u]={}))[a])&&j[0]===w)m=j[1];else while(l=++n&&l&&l[p]||(m=n=0)||o.pop())if((h?l.nodeName.toLowerCase()===r:1===l.nodeType)&&++m&&(s&&((l[u]||(l[u]={}))[a]=[w,m]),l===b))break;return m-=e,m===d||m%d===0&&m/d>=0}}},PSEUDO:function(a,b){var c,e=d.pseudos[a]||d.setFilters[a.toLowerCase()]||gb.error("unsupported pseudo: "+a);return e[u]?e(b):e.length>1?(c=[a,a,"",b],d.setFilters.hasOwnProperty(a.toLowerCase())?ib(function(a,c){var d,f=e(a,b),g=f.length;while(g--)d=J(a,f[g]),a[d]=!(c[d]=f[g])}):function(a){return e(a,0,c)}):e}},pseudos:{not:ib(function(a){var b=[],c=[],d=h(a.replace(R,"$1"));return d[u]?ib(function(a,b,c,e){var f,g=d(a,null,e,[]),h=a.length;while(h--)(f=g[h])&&(a[h]=!(b[h]=f))}):function(a,e,f){return b[0]=a,d(b,null,f,c),b[0]=null,!c.pop()}}),has:ib(function(a){return function(b){return gb(a,b).length>0}}),contains:ib(function(a){return a=a.replace(cb,db),function(b){return(b.textContent||b.innerText||e(b)).indexOf(a)>-1}}),lang:ib(function(a){return W.test(a||"")||gb.error("unsupported lang: "+a),a=a.replace(cb,db).toLowerCase(),function(b){var c;do if(c=p?b.lang:b.getAttribute("xml:lang")||b.getAttribute("lang"))return c=c.toLowerCase(),c===a||0===c.indexOf(a+"-");while((b=b.parentNode)&&1===b.nodeType);return!1}}),target:function(b){var c=a.location&&a.location.hash;return c&&c.slice(1)===b.id},root:function(a){return a===o},focus:function(a){return a===n.activeElement&&(!n.hasFocus||n.hasFocus())&&!!(a.type||a.href||~a.tabIndex)},enabled:function(a){return a.disabled===!1},disabled:function(a){return a.disabled===!0},checked:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&!!a.checked||"option"===b&&!!a.selected},selected:function(a){return a.parentNode&&a.parentNode.selectedIndex,a.selected===!0},empty:function(a){for(a=a.firstChild;a;a=a.nextSibling)if(a.nodeType<6)return!1;return!0},parent:function(a){return!d.pseudos.empty(a)},header:function(a){return Z.test(a.nodeName)},input:function(a){return Y.test(a.nodeName)},button:function(a){var b=a.nodeName.toLowerCase();return"input"===b&&"button"===a.type||"button"===b},text:function(a){var b;return"input"===a.nodeName.toLowerCase()&&"text"===a.type&&(null==(b=a.getAttribute("type"))||"text"===b.toLowerCase())},first:ob(function(){return[0]}),last:ob(function(a,b){return[b-1]}),eq:ob(function(a,b,c){return[0>c?c+b:c]}),even:ob(function(a,b){for(var c=0;b>c;c+=2)a.push(c);return a}),odd:ob(function(a,b){for(var c=1;b>c;c+=2)a.push(c);return a}),lt:ob(function(a,b,c){for(var d=0>c?c+b:c;--d>=0;)a.push(d);return a}),gt:ob(function(a,b,c){for(var d=0>c?c+b:c;++d<b;)a.push(d);return a})}},d.pseudos.nth=d.pseudos.eq;for(b in{radio:!0,checkbox:!0,file:!0,password:!0,image:!0})d.pseudos[b]=mb(b);for(b in{submit:!0,reset:!0})d.pseudos[b]=nb(b);function qb(){}qb.prototype=d.filters=d.pseudos,d.setFilters=new qb,g=gb.tokenize=function(a,b){var c,e,f,g,h,i,j,k=z[a+" "];if(k)return b?0:k.slice(0);h=a,i=[],j=d.preFilter;while(h){(!c||(e=S.exec(h)))&&(e&&(h=h.slice(e[0].length)||h),i.push(f=[])),c=!1,(e=T.exec(h))&&(c=e.shift(),f.push({value:c,type:e[0].replace(R," ")}),h=h.slice(c.length));for(g in d.filter)!(e=X[g].exec(h))||j[g]&&!(e=j[g](e))||(c=e.shift(),f.push({value:c,type:g,matches:e}),h=h.slice(c.length));if(!c)break}return b?h.length:h?gb.error(a):z(a,i).slice(0)};function rb(a){for(var b=0,c=a.length,d="";c>b;b++)d+=a[b].value;return d}function sb(a,b,c){var d=b.dir,e=c&&"parentNode"===d,f=x++;return b.first?function(b,c,f){while(b=b[d])if(1===b.nodeType||e)return a(b,c,f)}:function(b,c,g){var h,i,j=[w,f];if(g){while(b=b[d])if((1===b.nodeType||e)&&a(b,c,g))return!0}else while(b=b[d])if(1===b.nodeType||e){if(i=b[u]||(b[u]={}),(h=i[d])&&h[0]===w&&h[1]===f)return j[2]=h[2];if(i[d]=j,j[2]=a(b,c,g))return!0}}}function tb(a){return a.length>1?function(b,c,d){var e=a.length;while(e--)if(!a[e](b,c,d))return!1;return!0}:a[0]}function ub(a,b,c){for(var d=0,e=b.length;e>d;d++)gb(a,b[d],c);return c}function vb(a,b,c,d,e){for(var f,g=[],h=0,i=a.length,j=null!=b;i>h;h++)(f=a[h])&&(!c||c(f,d,e))&&(g.push(f),j&&b.push(h));return g}function wb(a,b,c,d,e,f){return d&&!d[u]&&(d=wb(d)),e&&!e[u]&&(e=wb(e,f)),ib(function(f,g,h,i){var j,k,l,m=[],n=[],o=g.length,p=f||ub(b||"*",h.nodeType?[h]:h,[]),q=!a||!f&&b?p:vb(p,m,a,h,i),r=c?e||(f?a:o||d)?[]:g:q;if(c&&c(q,r,h,i),d){j=vb(r,n),d(j,[],h,i),k=j.length;while(k--)(l=j[k])&&(r[n[k]]=!(q[n[k]]=l))}if(f){if(e||a){if(e){j=[],k=r.length;while(k--)(l=r[k])&&j.push(q[k]=l);e(null,r=[],j,i)}k=r.length;while(k--)(l=r[k])&&(j=e?J(f,l):m[k])>-1&&(f[j]=!(g[j]=l))}}else r=vb(r===g?r.splice(o,r.length):r),e?e(null,g,r,i):H.apply(g,r)})}function xb(a){for(var b,c,e,f=a.length,g=d.relative[a[0].type],h=g||d.relative[" "],i=g?1:0,k=sb(function(a){return a===b},h,!0),l=sb(function(a){return J(b,a)>-1},h,!0),m=[function(a,c,d){var e=!g&&(d||c!==j)||((b=c).nodeType?k(a,c,d):l(a,c,d));return b=null,e}];f>i;i++)if(c=d.relative[a[i].type])m=[sb(tb(m),c)];else{if(c=d.filter[a[i].type].apply(null,a[i].matches),c[u]){for(e=++i;f>e;e++)if(d.relative[a[e].type])break;return wb(i>1&&tb(m),i>1&&rb(a.slice(0,i-1).concat({value:" "===a[i-2].type?"*":""})).replace(R,"$1"),c,e>i&&xb(a.slice(i,e)),f>e&&xb(a=a.slice(e)),f>e&&rb(a))}m.push(c)}return tb(m)}function yb(a,b){var c=b.length>0,e=a.length>0,f=function(f,g,h,i,k){var l,m,o,p=0,q="0",r=f&&[],s=[],t=j,u=f||e&&d.find.TAG("*",k),v=w+=null==t?1:Math.random()||.1,x=u.length;for(k&&(j=g!==n&&g);q!==x&&null!=(l=u[q]);q++){if(e&&l){m=0;while(o=a[m++])if(o(l,g,h)){i.push(l);break}k&&(w=v)}c&&((l=!o&&l)&&p--,f&&r.push(l))}if(p+=q,c&&q!==p){m=0;while(o=b[m++])o(r,s,g,h);if(f){if(p>0)while(q--)r[q]||s[q]||(s[q]=F.call(i));s=vb(s)}H.apply(i,s),k&&!f&&s.length>0&&p+b.length>1&&gb.uniqueSort(i)}return k&&(w=v,j=t),r};return c?ib(f):f}return h=gb.compile=function(a,b){var c,d=[],e=[],f=A[a+" "];if(!f){b||(b=g(a)),c=b.length;while(c--)f=xb(b[c]),f[u]?d.push(f):e.push(f);f=A(a,yb(e,d)),f.selector=a}return f},i=gb.select=function(a,b,e,f){var i,j,k,l,m,n="function"==typeof a&&a,o=!f&&g(a=n.selector||a);if(e=e||[],1===o.length){if(j=o[0]=o[0].slice(0),j.length>2&&"ID"===(k=j[0]).type&&c.getById&&9===b.nodeType&&p&&d.relative[j[1].type]){if(b=(d.find.ID(k.matches[0].replace(cb,db),b)||[])[0],!b)return e;n&&(b=b.parentNode),a=a.slice(j.shift().value.length)}i=X.needsContext.test(a)?0:j.length;while(i--){if(k=j[i],d.relative[l=k.type])break;if((m=d.find[l])&&(f=m(k.matches[0].replace(cb,db),ab.test(j[0].type)&&pb(b.parentNode)||b))){if(j.splice(i,1),a=f.length&&rb(j),!a)return H.apply(e,f),e;break}}}return(n||h(a,o))(f,b,!p,e,ab.test(a)&&pb(b.parentNode)||b),e},c.sortStable=u.split("").sort(B).join("")===u,c.detectDuplicates=!!l,m(),c.sortDetached=jb(function(a){return 1&a.compareDocumentPosition(n.createElement("div"))}),jb(function(a){return a.innerHTML="<a href='#'></a>","#"===a.firstChild.getAttribute("href")})||kb("type|href|height|width",function(a,b,c){return c?void 0:a.getAttribute(b,"type"===b.toLowerCase()?1:2)}),c.attributes&&jb(function(a){return a.innerHTML="<input/>",a.firstChild.setAttribute("value",""),""===a.firstChild.getAttribute("value")})||kb("value",function(a,b,c){return c||"input"!==a.nodeName.toLowerCase()?void 0:a.defaultValue}),jb(function(a){return null==a.getAttribute("disabled")})||kb(K,function(a,b,c){var d;return c?void 0:a[b]===!0?b.toLowerCase():(d=a.getAttributeNode(b))&&d.specified?d.value:null}),gb}(a);n.find=t,n.expr=t.selectors,n.expr[":"]=n.expr.pseudos,n.unique=t.uniqueSort,n.text=t.getText,n.isXMLDoc=t.isXML,n.contains=t.contains;var u=n.expr.match.needsContext,v=/^<(\w+)\s*\/?>(?:<\/\1>|)$/,w=/^.[^:#\[\.,]*$/;function x(a,b,c){if(n.isFunction(b))return n.grep(a,function(a,d){return!!b.call(a,d,a)!==c});if(b.nodeType)return n.grep(a,function(a){return a===b!==c});if("string"==typeof b){if(w.test(b))return n.filter(b,a,c);b=n.filter(b,a)}return n.grep(a,function(a){return g.call(b,a)>=0!==c})}n.filter=function(a,b,c){var d=b[0];return c&&(a=":not("+a+")"),1===b.length&&1===d.nodeType?n.find.matchesSelector(d,a)?[d]:[]:n.find.matches(a,n.grep(b,function(a){return 1===a.nodeType}))},n.fn.extend({find:function(a){var b,c=this.length,d=[],e=this;if("string"!=typeof a)return this.pushStack(n(a).filter(function(){for(b=0;c>b;b++)if(n.contains(e[b],this))return!0}));for(b=0;c>b;b++)n.find(a,e[b],d);return d=this.pushStack(c>1?n.unique(d):d),d.selector=this.selector?this.selector+" "+a:a,d},filter:function(a){return this.pushStack(x(this,a||[],!1))},not:function(a){return this.pushStack(x(this,a||[],!0))},is:function(a){return!!x(this,"string"==typeof a&&u.test(a)?n(a):a||[],!1).length}});var y,z=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/,A=n.fn.init=function(a,b){var c,d;if(!a)return this;if("string"==typeof a){if(c="<"===a[0]&&">"===a[a.length-1]&&a.length>=3?[null,a,null]:z.exec(a),!c||!c[1]&&b)return!b||b.jquery?(b||y).find(a):this.constructor(b).find(a);if(c[1]){if(b=b instanceof n?b[0]:b,n.merge(this,n.parseHTML(c[1],b&&b.nodeType?b.ownerDocument||b:l,!0)),v.test(c[1])&&n.isPlainObject(b))for(c in b)n.isFunction(this[c])?this[c](b[c]):this.attr(c,b[c]);return this}return d=l.getElementById(c[2]),d&&d.parentNode&&(this.length=1,this[0]=d),this.context=l,this.selector=a,this}return a.nodeType?(this.context=this[0]=a,this.length=1,this):n.isFunction(a)?"undefined"!=typeof y.ready?y.ready(a):a(n):(void 0!==a.selector&&(this.selector=a.selector,this.context=a.context),n.makeArray(a,this))};A.prototype=n.fn,y=n(l);var B=/^(?:parents|prev(?:Until|All))/,C={children:!0,contents:!0,next:!0,prev:!0};n.extend({dir:function(a,b,c){var d=[],e=void 0!==c;while((a=a[b])&&9!==a.nodeType)if(1===a.nodeType){if(e&&n(a).is(c))break;d.push(a)}return d},sibling:function(a,b){for(var c=[];a;a=a.nextSibling)1===a.nodeType&&a!==b&&c.push(a);return c}}),n.fn.extend({has:function(a){var b=n(a,this),c=b.length;return this.filter(function(){for(var a=0;c>a;a++)if(n.contains(this,b[a]))return!0})},closest:function(a,b){for(var c,d=0,e=this.length,f=[],g=u.test(a)||"string"!=typeof a?n(a,b||this.context):0;e>d;d++)for(c=this[d];c&&c!==b;c=c.parentNode)if(c.nodeType<11&&(g?g.index(c)>-1:1===c.nodeType&&n.find.matchesSelector(c,a))){f.push(c);break}return this.pushStack(f.length>1?n.unique(f):f)},index:function(a){return a?"string"==typeof a?g.call(n(a),this[0]):g.call(this,a.jquery?a[0]:a):this[0]&&this[0].parentNode?this.first().prevAll().length:-1},add:function(a,b){return this.pushStack(n.unique(n.merge(this.get(),n(a,b))))},addBack:function(a){return this.add(null==a?this.prevObject:this.prevObject.filter(a))}});function D(a,b){while((a=a[b])&&1!==a.nodeType);return a}n.each({parent:function(a){var b=a.parentNode;return b&&11!==b.nodeType?b:null},parents:function(a){return n.dir(a,"parentNode")},parentsUntil:function(a,b,c){return n.dir(a,"parentNode",c)},next:function(a){return D(a,"nextSibling")},prev:function(a){return D(a,"previousSibling")},nextAll:function(a){return n.dir(a,"nextSibling")},prevAll:function(a){return n.dir(a,"previousSibling")},nextUntil:function(a,b,c){return n.dir(a,"nextSibling",c)},prevUntil:function(a,b,c){return n.dir(a,"previousSibling",c)},siblings:function(a){return n.sibling((a.parentNode||{}).firstChild,a)},children:function(a){return n.sibling(a.firstChild)},contents:function(a){return a.contentDocument||n.merge([],a.childNodes)}},function(a,b){n.fn[a]=function(c,d){var e=n.map(this,b,c);return"Until"!==a.slice(-5)&&(d=c),d&&"string"==typeof d&&(e=n.filter(d,e)),this.length>1&&(C[a]||n.unique(e),B.test(a)&&e.reverse()),this.pushStack(e)}});var E=/\S+/g,F={};function G(a){var b=F[a]={};return n.each(a.match(E)||[],function(a,c){b[c]=!0}),b}n.Callbacks=function(a){a="string"==typeof a?F[a]||G(a):n.extend({},a);var b,c,d,e,f,g,h=[],i=!a.once&&[],j=function(l){for(b=a.memory&&l,c=!0,g=e||0,e=0,f=h.length,d=!0;h&&f>g;g++)if(h[g].apply(l[0],l[1])===!1&&a.stopOnFalse){b=!1;break}d=!1,h&&(i?i.length&&j(i.shift()):b?h=[]:k.disable())},k={add:function(){if(h){var c=h.length;!function g(b){n.each(b,function(b,c){var d=n.type(c);"function"===d?a.unique&&k.has(c)||h.push(c):c&&c.length&&"string"!==d&&g(c)})}(arguments),d?f=h.length:b&&(e=c,j(b))}return this},remove:function(){return h&&n.each(arguments,function(a,b){var c;while((c=n.inArray(b,h,c))>-1)h.splice(c,1),d&&(f>=c&&f--,g>=c&&g--)}),this},has:function(a){return a?n.inArray(a,h)>-1:!(!h||!h.length)},empty:function(){return h=[],f=0,this},disable:function(){return h=i=b=void 0,this},disabled:function(){return!h},lock:function(){return i=void 0,b||k.disable(),this},locked:function(){return!i},fireWith:function(a,b){return!h||c&&!i||(b=b||[],b=[a,b.slice?b.slice():b],d?i.push(b):j(b)),this},fire:function(){return k.fireWith(this,arguments),this},fired:function(){return!!c}};return k},n.extend({Deferred:function(a){var b=[["resolve","done",n.Callbacks("once memory"),"resolved"],["reject","fail",n.Callbacks("once memory"),"rejected"],["notify","progress",n.Callbacks("memory")]],c="pending",d={state:function(){return c},always:function(){return e.done(arguments).fail(arguments),this},then:function(){var a=arguments;return n.Deferred(function(c){n.each(b,function(b,f){var g=n.isFunction(a[b])&&a[b];e[f[1]](function(){var a=g&&g.apply(this,arguments);a&&n.isFunction(a.promise)?a.promise().done(c.resolve).fail(c.reject).progress(c.notify):c[f[0]+"With"](this===d?c.promise():this,g?[a]:arguments)})}),a=null}).promise()},promise:function(a){return null!=a?n.extend(a,d):d}},e={};return d.pipe=d.then,n.each(b,function(a,f){var g=f[2],h=f[3];d[f[1]]=g.add,h&&g.add(function(){c=h},b[1^a][2].disable,b[2][2].lock),e[f[0]]=function(){return e[f[0]+"With"](this===e?d:this,arguments),this},e[f[0]+"With"]=g.fireWith}),d.promise(e),a&&a.call(e,e),e},when:function(a){var b=0,c=d.call(arguments),e=c.length,f=1!==e||a&&n.isFunction(a.promise)?e:0,g=1===f?a:n.Deferred(),h=function(a,b,c){return function(e){b[a]=this,c[a]=arguments.length>1?d.call(arguments):e,c===i?g.notifyWith(b,c):--f||g.resolveWith(b,c)}},i,j,k;if(e>1)for(i=new Array(e),j=new Array(e),k=new Array(e);e>b;b++)c[b]&&n.isFunction(c[b].promise)?c[b].promise().done(h(b,k,c)).fail(g.reject).progress(h(b,j,i)):--f;return f||g.resolveWith(k,c),g.promise()}});var H;n.fn.ready=function(a){return n.ready.promise().done(a),this},n.extend({isReady:!1,readyWait:1,holdReady:function(a){a?n.readyWait++:n.ready(!0)},ready:function(a){(a===!0?--n.readyWait:n.isReady)||(n.isReady=!0,a!==!0&&--n.readyWait>0||(H.resolveWith(l,[n]),n.fn.triggerHandler&&(n(l).triggerHandler("ready"),n(l).off("ready"))))}});function I(){l.removeEventListener("DOMContentLoaded",I,!1),a.removeEventListener("load",I,!1),n.ready()}n.ready.promise=function(b){return H||(H=n.Deferred(),"complete"===l.readyState?setTimeout(n.ready):(l.addEventListener("DOMContentLoaded",I,!1),a.addEventListener("load",I,!1))),H.promise(b)},n.ready.promise();var J=n.access=function(a,b,c,d,e,f,g){var h=0,i=a.length,j=null==c;if("object"===n.type(c)){e=!0;for(h in c)n.access(a,b,h,c[h],!0,f,g)}else if(void 0!==d&&(e=!0,n.isFunction(d)||(g=!0),j&&(g?(b.call(a,d),b=null):(j=b,b=function(a,b,c){return j.call(n(a),c)})),b))for(;i>h;h++)b(a[h],c,g?d:d.call(a[h],h,b(a[h],c)));return e?a:j?b.call(a):i?b(a[0],c):f};n.acceptData=function(a){return 1===a.nodeType||9===a.nodeType||!+a.nodeType};function K(){Object.defineProperty(this.cache={},0,{get:function(){return{}}}),this.expando=n.expando+K.uid++}K.uid=1,K.accepts=n.acceptData,K.prototype={key:function(a){if(!K.accepts(a))return 0;var b={},c=a[this.expando];if(!c){c=K.uid++;try{b[this.expando]={value:c},Object.defineProperties(a,b)}catch(d){b[this.expando]=c,n.extend(a,b)}}return this.cache[c]||(this.cache[c]={}),c},set:function(a,b,c){var d,e=this.key(a),f=this.cache[e];if("string"==typeof b)f[b]=c;else if(n.isEmptyObject(f))n.extend(this.cache[e],b);else for(d in b)f[d]=b[d];return f},get:function(a,b){var c=this.cache[this.key(a)];return void 0===b?c:c[b]},access:function(a,b,c){var d;return void 0===b||b&&"string"==typeof b&&void 0===c?(d=this.get(a,b),void 0!==d?d:this.get(a,n.camelCase(b))):(this.set(a,b,c),void 0!==c?c:b)},remove:function(a,b){var c,d,e,f=this.key(a),g=this.cache[f];if(void 0===b)this.cache[f]={};else{n.isArray(b)?d=b.concat(b.map(n.camelCase)):(e=n.camelCase(b),b in g?d=[b,e]:(d=e,d=d in g?[d]:d.match(E)||[])),c=d.length;while(c--)delete g[d[c]]}},hasData:function(a){return!n.isEmptyObject(this.cache[a[this.expando]]||{})},discard:function(a){a[this.expando]&&delete this.cache[a[this.expando]]}};var L=new K,M=new K,N=/^(?:\{[\w\W]*\}|\[[\w\W]*\])$/,O=/([A-Z])/g;function P(a,b,c){var d;if(void 0===c&&1===a.nodeType)if(d="data-"+b.replace(O,"-$1").toLowerCase(),c=a.getAttribute(d),"string"==typeof c){try{c="true"===c?!0:"false"===c?!1:"null"===c?null:+c+""===c?+c:N.test(c)?n.parseJSON(c):c}catch(e){}M.set(a,b,c)}else c=void 0;return c}n.extend({hasData:function(a){return M.hasData(a)||L.hasData(a)},data:function(a,b,c){return M.access(a,b,c)
+},removeData:function(a,b){M.remove(a,b)},_data:function(a,b,c){return L.access(a,b,c)},_removeData:function(a,b){L.remove(a,b)}}),n.fn.extend({data:function(a,b){var c,d,e,f=this[0],g=f&&f.attributes;if(void 0===a){if(this.length&&(e=M.get(f),1===f.nodeType&&!L.get(f,"hasDataAttrs"))){c=g.length;while(c--)g[c]&&(d=g[c].name,0===d.indexOf("data-")&&(d=n.camelCase(d.slice(5)),P(f,d,e[d])));L.set(f,"hasDataAttrs",!0)}return e}return"object"==typeof a?this.each(function(){M.set(this,a)}):J(this,function(b){var c,d=n.camelCase(a);if(f&&void 0===b){if(c=M.get(f,a),void 0!==c)return c;if(c=M.get(f,d),void 0!==c)return c;if(c=P(f,d,void 0),void 0!==c)return c}else this.each(function(){var c=M.get(this,d);M.set(this,d,b),-1!==a.indexOf("-")&&void 0!==c&&M.set(this,a,b)})},null,b,arguments.length>1,null,!0)},removeData:function(a){return this.each(function(){M.remove(this,a)})}}),n.extend({queue:function(a,b,c){var d;return a?(b=(b||"fx")+"queue",d=L.get(a,b),c&&(!d||n.isArray(c)?d=L.access(a,b,n.makeArray(c)):d.push(c)),d||[]):void 0},dequeue:function(a,b){b=b||"fx";var c=n.queue(a,b),d=c.length,e=c.shift(),f=n._queueHooks(a,b),g=function(){n.dequeue(a,b)};"inprogress"===e&&(e=c.shift(),d--),e&&("fx"===b&&c.unshift("inprogress"),delete f.stop,e.call(a,g,f)),!d&&f&&f.empty.fire()},_queueHooks:function(a,b){var c=b+"queueHooks";return L.get(a,c)||L.access(a,c,{empty:n.Callbacks("once memory").add(function(){L.remove(a,[b+"queue",c])})})}}),n.fn.extend({queue:function(a,b){var c=2;return"string"!=typeof a&&(b=a,a="fx",c--),arguments.length<c?n.queue(this[0],a):void 0===b?this:this.each(function(){var c=n.queue(this,a,b);n._queueHooks(this,a),"fx"===a&&"inprogress"!==c[0]&&n.dequeue(this,a)})},dequeue:function(a){return this.each(function(){n.dequeue(this,a)})},clearQueue:function(a){return this.queue(a||"fx",[])},promise:function(a,b){var c,d=1,e=n.Deferred(),f=this,g=this.length,h=function(){--d||e.resolveWith(f,[f])};"string"!=typeof a&&(b=a,a=void 0),a=a||"fx";while(g--)c=L.get(f[g],a+"queueHooks"),c&&c.empty&&(d++,c.empty.add(h));return h(),e.promise(b)}});var Q=/[+-]?(?:\d*\.|)\d+(?:[eE][+-]?\d+|)/.source,R=["Top","Right","Bottom","Left"],S=function(a,b){return a=b||a,"none"===n.css(a,"display")||!n.contains(a.ownerDocument,a)},T=/^(?:checkbox|radio)$/i;!function(){var a=l.createDocumentFragment(),b=a.appendChild(l.createElement("div")),c=l.createElement("input");c.setAttribute("type","radio"),c.setAttribute("checked","checked"),c.setAttribute("name","t"),b.appendChild(c),k.checkClone=b.cloneNode(!0).cloneNode(!0).lastChild.checked,b.innerHTML="<textarea>x</textarea>",k.noCloneChecked=!!b.cloneNode(!0).lastChild.defaultValue}();var U="undefined";k.focusinBubbles="onfocusin"in a;var V=/^key/,W=/^(?:mouse|pointer|contextmenu)|click/,X=/^(?:focusinfocus|focusoutblur)$/,Y=/^([^.]*)(?:\.(.+)|)$/;function Z(){return!0}function $(){return!1}function _(){try{return l.activeElement}catch(a){}}n.event={global:{},add:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=L.get(a);if(r){c.handler&&(f=c,c=f.handler,e=f.selector),c.guid||(c.guid=n.guid++),(i=r.events)||(i=r.events={}),(g=r.handle)||(g=r.handle=function(b){return typeof n!==U&&n.event.triggered!==b.type?n.event.dispatch.apply(a,arguments):void 0}),b=(b||"").match(E)||[""],j=b.length;while(j--)h=Y.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o&&(l=n.event.special[o]||{},o=(e?l.delegateType:l.bindType)||o,l=n.event.special[o]||{},k=n.extend({type:o,origType:q,data:d,handler:c,guid:c.guid,selector:e,needsContext:e&&n.expr.match.needsContext.test(e),namespace:p.join(".")},f),(m=i[o])||(m=i[o]=[],m.delegateCount=0,l.setup&&l.setup.call(a,d,p,g)!==!1||a.addEventListener&&a.addEventListener(o,g,!1)),l.add&&(l.add.call(a,k),k.handler.guid||(k.handler.guid=c.guid)),e?m.splice(m.delegateCount++,0,k):m.push(k),n.event.global[o]=!0)}},remove:function(a,b,c,d,e){var f,g,h,i,j,k,l,m,o,p,q,r=L.hasData(a)&&L.get(a);if(r&&(i=r.events)){b=(b||"").match(E)||[""],j=b.length;while(j--)if(h=Y.exec(b[j])||[],o=q=h[1],p=(h[2]||"").split(".").sort(),o){l=n.event.special[o]||{},o=(d?l.delegateType:l.bindType)||o,m=i[o]||[],h=h[2]&&new RegExp("(^|\\.)"+p.join("\\.(?:.*\\.|)")+"(\\.|$)"),g=f=m.length;while(f--)k=m[f],!e&&q!==k.origType||c&&c.guid!==k.guid||h&&!h.test(k.namespace)||d&&d!==k.selector&&("**"!==d||!k.selector)||(m.splice(f,1),k.selector&&m.delegateCount--,l.remove&&l.remove.call(a,k));g&&!m.length&&(l.teardown&&l.teardown.call(a,p,r.handle)!==!1||n.removeEvent(a,o,r.handle),delete i[o])}else for(o in i)n.event.remove(a,o+b[j],c,d,!0);n.isEmptyObject(i)&&(delete r.handle,L.remove(a,"events"))}},trigger:function(b,c,d,e){var f,g,h,i,k,m,o,p=[d||l],q=j.call(b,"type")?b.type:b,r=j.call(b,"namespace")?b.namespace.split("."):[];if(g=h=d=d||l,3!==d.nodeType&&8!==d.nodeType&&!X.test(q+n.event.triggered)&&(q.indexOf(".")>=0&&(r=q.split("."),q=r.shift(),r.sort()),k=q.indexOf(":")<0&&"on"+q,b=b[n.expando]?b:new n.Event(q,"object"==typeof b&&b),b.isTrigger=e?2:3,b.namespace=r.join("."),b.namespace_re=b.namespace?new RegExp("(^|\\.)"+r.join("\\.(?:.*\\.|)")+"(\\.|$)"):null,b.result=void 0,b.target||(b.target=d),c=null==c?[b]:n.makeArray(c,[b]),o=n.event.special[q]||{},e||!o.trigger||o.trigger.apply(d,c)!==!1)){if(!e&&!o.noBubble&&!n.isWindow(d)){for(i=o.delegateType||q,X.test(i+q)||(g=g.parentNode);g;g=g.parentNode)p.push(g),h=g;h===(d.ownerDocument||l)&&p.push(h.defaultView||h.parentWindow||a)}f=0;while((g=p[f++])&&!b.isPropagationStopped())b.type=f>1?i:o.bindType||q,m=(L.get(g,"events")||{})[b.type]&&L.get(g,"handle"),m&&m.apply(g,c),m=k&&g[k],m&&m.apply&&n.acceptData(g)&&(b.result=m.apply(g,c),b.result===!1&&b.preventDefault());return b.type=q,e||b.isDefaultPrevented()||o._default&&o._default.apply(p.pop(),c)!==!1||!n.acceptData(d)||k&&n.isFunction(d[q])&&!n.isWindow(d)&&(h=d[k],h&&(d[k]=null),n.event.triggered=q,d[q](),n.event.triggered=void 0,h&&(d[k]=h)),b.result}},dispatch:function(a){a=n.event.fix(a);var b,c,e,f,g,h=[],i=d.call(arguments),j=(L.get(this,"events")||{})[a.type]||[],k=n.event.special[a.type]||{};if(i[0]=a,a.delegateTarget=this,!k.preDispatch||k.preDispatch.call(this,a)!==!1){h=n.event.handlers.call(this,a,j),b=0;while((f=h[b++])&&!a.isPropagationStopped()){a.currentTarget=f.elem,c=0;while((g=f.handlers[c++])&&!a.isImmediatePropagationStopped())(!a.namespace_re||a.namespace_re.test(g.namespace))&&(a.handleObj=g,a.data=g.data,e=((n.event.special[g.origType]||{}).handle||g.handler).apply(f.elem,i),void 0!==e&&(a.result=e)===!1&&(a.preventDefault(),a.stopPropagation()))}return k.postDispatch&&k.postDispatch.call(this,a),a.result}},handlers:function(a,b){var c,d,e,f,g=[],h=b.delegateCount,i=a.target;if(h&&i.nodeType&&(!a.button||"click"!==a.type))for(;i!==this;i=i.parentNode||this)if(i.disabled!==!0||"click"!==a.type){for(d=[],c=0;h>c;c++)f=b[c],e=f.selector+" ",void 0===d[e]&&(d[e]=f.needsContext?n(e,this).index(i)>=0:n.find(e,this,null,[i]).length),d[e]&&d.push(f);d.length&&g.push({elem:i,handlers:d})}return h<b.length&&g.push({elem:this,handlers:b.slice(h)}),g},props:"altKey bubbles cancelable ctrlKey currentTarget eventPhase metaKey relatedTarget shiftKey target timeStamp view which".split(" "),fixHooks:{},keyHooks:{props:"char charCode key keyCode".split(" "),filter:function(a,b){return null==a.which&&(a.which=null!=b.charCode?b.charCode:b.keyCode),a}},mouseHooks:{props:"button buttons clientX clientY offsetX offsetY pageX pageY screenX screenY toElement".split(" "),filter:function(a,b){var c,d,e,f=b.button;return null==a.pageX&&null!=b.clientX&&(c=a.target.ownerDocument||l,d=c.documentElement,e=c.body,a.pageX=b.clientX+(d&&d.scrollLeft||e&&e.scrollLeft||0)-(d&&d.clientLeft||e&&e.clientLeft||0),a.pageY=b.clientY+(d&&d.scrollTop||e&&e.scrollTop||0)-(d&&d.clientTop||e&&e.clientTop||0)),a.which||void 0===f||(a.which=1&f?1:2&f?3:4&f?2:0),a}},fix:function(a){if(a[n.expando])return a;var b,c,d,e=a.type,f=a,g=this.fixHooks[e];g||(this.fixHooks[e]=g=W.test(e)?this.mouseHooks:V.test(e)?this.keyHooks:{}),d=g.props?this.props.concat(g.props):this.props,a=new n.Event(f),b=d.length;while(b--)c=d[b],a[c]=f[c];return a.target||(a.target=l),3===a.target.nodeType&&(a.target=a.target.parentNode),g.filter?g.filter(a,f):a},special:{load:{noBubble:!0},focus:{trigger:function(){return this!==_()&&this.focus?(this.focus(),!1):void 0},delegateType:"focusin"},blur:{trigger:function(){return this===_()&&this.blur?(this.blur(),!1):void 0},delegateType:"focusout"},click:{trigger:function(){return"checkbox"===this.type&&this.click&&n.nodeName(this,"input")?(this.click(),!1):void 0},_default:function(a){return n.nodeName(a.target,"a")}},beforeunload:{postDispatch:function(a){void 0!==a.result&&a.originalEvent&&(a.originalEvent.returnValue=a.result)}}},simulate:function(a,b,c,d){var e=n.extend(new n.Event,c,{type:a,isSimulated:!0,originalEvent:{}});d?n.event.trigger(e,null,b):n.event.dispatch.call(b,e),e.isDefaultPrevented()&&c.preventDefault()}},n.removeEvent=function(a,b,c){a.removeEventListener&&a.removeEventListener(b,c,!1)},n.Event=function(a,b){return this instanceof n.Event?(a&&a.type?(this.originalEvent=a,this.type=a.type,this.isDefaultPrevented=a.defaultPrevented||void 0===a.defaultPrevented&&a.returnValue===!1?Z:$):this.type=a,b&&n.extend(this,b),this.timeStamp=a&&a.timeStamp||n.now(),void(this[n.expando]=!0)):new n.Event(a,b)},n.Event.prototype={isDefaultPrevented:$,isPropagationStopped:$,isImmediatePropagationStopped:$,preventDefault:function(){var a=this.originalEvent;this.isDefaultPrevented=Z,a&&a.preventDefault&&a.preventDefault()},stopPropagation:function(){var a=this.originalEvent;this.isPropagationStopped=Z,a&&a.stopPropagation&&a.stopPropagation()},stopImmediatePropagation:function(){var a=this.originalEvent;this.isImmediatePropagationStopped=Z,a&&a.stopImmediatePropagation&&a.stopImmediatePropagation(),this.stopPropagation()}},n.each({mouseenter:"mouseover",mouseleave:"mouseout",pointerenter:"pointerover",pointerleave:"pointerout"},function(a,b){n.event.special[a]={delegateType:b,bindType:b,handle:function(a){var c,d=this,e=a.relatedTarget,f=a.handleObj;return(!e||e!==d&&!n.contains(d,e))&&(a.type=f.origType,c=f.handler.apply(this,arguments),a.type=b),c}}}),k.focusinBubbles||n.each({focus:"focusin",blur:"focusout"},function(a,b){var c=function(a){n.event.simulate(b,a.target,n.event.fix(a),!0)};n.event.special[b]={setup:function(){var d=this.ownerDocument||this,e=L.access(d,b);e||d.addEventListener(a,c,!0),L.access(d,b,(e||0)+1)},teardown:function(){var d=this.ownerDocument||this,e=L.access(d,b)-1;e?L.access(d,b,e):(d.removeEventListener(a,c,!0),L.remove(d,b))}}}),n.fn.extend({on:function(a,b,c,d,e){var f,g;if("object"==typeof a){"string"!=typeof b&&(c=c||b,b=void 0);for(g in a)this.on(g,b,c,a[g],e);return this}if(null==c&&null==d?(d=b,c=b=void 0):null==d&&("string"==typeof b?(d=c,c=void 0):(d=c,c=b,b=void 0)),d===!1)d=$;else if(!d)return this;return 1===e&&(f=d,d=function(a){return n().off(a),f.apply(this,arguments)},d.guid=f.guid||(f.guid=n.guid++)),this.each(function(){n.event.add(this,a,d,c,b)})},one:function(a,b,c,d){return this.on(a,b,c,d,1)},off:function(a,b,c){var d,e;if(a&&a.preventDefault&&a.handleObj)return d=a.handleObj,n(a.delegateTarget).off(d.namespace?d.origType+"."+d.namespace:d.origType,d.selector,d.handler),this;if("object"==typeof a){for(e in a)this.off(e,b,a[e]);return this}return(b===!1||"function"==typeof b)&&(c=b,b=void 0),c===!1&&(c=$),this.each(function(){n.event.remove(this,a,c,b)})},trigger:function(a,b){return this.each(function(){n.event.trigger(a,b,this)})},triggerHandler:function(a,b){var c=this[0];return c?n.event.trigger(a,b,c,!0):void 0}});var ab=/<(?!area|br|col|embed|hr|img|input|link|meta|param)(([\w:]+)[^>]*)\/>/gi,bb=/<([\w:]+)/,cb=/<|&#?\w+;/,db=/<(?:script|style|link)/i,eb=/checked\s*(?:[^=]|=\s*.checked.)/i,fb=/^$|\/(?:java|ecma)script/i,gb=/^true\/(.*)/,hb=/^\s*<!(?:\[CDATA\[|--)|(?:\]\]|--)>\s*$/g,ib={option:[1,"<select multiple='multiple'>","</select>"],thead:[1,"<table>","</table>"],col:[2,"<table><colgroup>","</colgroup></table>"],tr:[2,"<table><tbody>","</tbody></table>"],td:[3,"<table><tbody><tr>","</tr></tbody></table>"],_default:[0,"",""]};ib.optgroup=ib.option,ib.tbody=ib.tfoot=ib.colgroup=ib.caption=ib.thead,ib.th=ib.td;function jb(a,b){return n.nodeName(a,"table")&&n.nodeName(11!==b.nodeType?b:b.firstChild,"tr")?a.getElementsByTagName("tbody")[0]||a.appendChild(a.ownerDocument.createElement("tbody")):a}function kb(a){return a.type=(null!==a.getAttribute("type"))+"/"+a.type,a}function lb(a){var b=gb.exec(a.type);return b?a.type=b[1]:a.removeAttribute("type"),a}function mb(a,b){for(var c=0,d=a.length;d>c;c++)L.set(a[c],"globalEval",!b||L.get(b[c],"globalEval"))}function nb(a,b){var c,d,e,f,g,h,i,j;if(1===b.nodeType){if(L.hasData(a)&&(f=L.access(a),g=L.set(b,f),j=f.events)){delete g.handle,g.events={};for(e in j)for(c=0,d=j[e].length;d>c;c++)n.event.add(b,e,j[e][c])}M.hasData(a)&&(h=M.access(a),i=n.extend({},h),M.set(b,i))}}function ob(a,b){var c=a.getElementsByTagName?a.getElementsByTagName(b||"*"):a.querySelectorAll?a.querySelectorAll(b||"*"):[];return void 0===b||b&&n.nodeName(a,b)?n.merge([a],c):c}function pb(a,b){var c=b.nodeName.toLowerCase();"input"===c&&T.test(a.type)?b.checked=a.checked:("input"===c||"textarea"===c)&&(b.defaultValue=a.defaultValue)}n.extend({clone:function(a,b,c){var d,e,f,g,h=a.cloneNode(!0),i=n.contains(a.ownerDocument,a);if(!(k.noCloneChecked||1!==a.nodeType&&11!==a.nodeType||n.isXMLDoc(a)))for(g=ob(h),f=ob(a),d=0,e=f.length;e>d;d++)pb(f[d],g[d]);if(b)if(c)for(f=f||ob(a),g=g||ob(h),d=0,e=f.length;e>d;d++)nb(f[d],g[d]);else nb(a,h);return g=ob(h,"script"),g.length>0&&mb(g,!i&&ob(a,"script")),h},buildFragment:function(a,b,c,d){for(var e,f,g,h,i,j,k=b.createDocumentFragment(),l=[],m=0,o=a.length;o>m;m++)if(e=a[m],e||0===e)if("object"===n.type(e))n.merge(l,e.nodeType?[e]:e);else if(cb.test(e)){f=f||k.appendChild(b.createElement("div")),g=(bb.exec(e)||["",""])[1].toLowerCase(),h=ib[g]||ib._default,f.innerHTML=h[1]+e.replace(ab,"<$1></$2>")+h[2],j=h[0];while(j--)f=f.lastChild;n.merge(l,f.childNodes),f=k.firstChild,f.textContent=""}else l.push(b.createTextNode(e));k.textContent="",m=0;while(e=l[m++])if((!d||-1===n.inArray(e,d))&&(i=n.contains(e.ownerDocument,e),f=ob(k.appendChild(e),"script"),i&&mb(f),c)){j=0;while(e=f[j++])fb.test(e.type||"")&&c.push(e)}return k},cleanData:function(a){for(var b,c,d,e,f=n.event.special,g=0;void 0!==(c=a[g]);g++){if(n.acceptData(c)&&(e=c[L.expando],e&&(b=L.cache[e]))){if(b.events)for(d in b.events)f[d]?n.event.remove(c,d):n.removeEvent(c,d,b.handle);L.cache[e]&&delete L.cache[e]}delete M.cache[c[M.expando]]}}}),n.fn.extend({text:function(a){return J(this,function(a){return void 0===a?n.text(this):this.empty().each(function(){(1===this.nodeType||11===this.nodeType||9===this.nodeType)&&(this.textContent=a)})},null,a,arguments.length)},append:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.appendChild(a)}})},prepend:function(){return this.domManip(arguments,function(a){if(1===this.nodeType||11===this.nodeType||9===this.nodeType){var b=jb(this,a);b.insertBefore(a,b.firstChild)}})},before:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this)})},after:function(){return this.domManip(arguments,function(a){this.parentNode&&this.parentNode.insertBefore(a,this.nextSibling)})},remove:function(a,b){for(var c,d=a?n.filter(a,this):this,e=0;null!=(c=d[e]);e++)b||1!==c.nodeType||n.cleanData(ob(c)),c.parentNode&&(b&&n.contains(c.ownerDocument,c)&&mb(ob(c,"script")),c.parentNode.removeChild(c));return this},empty:function(){for(var a,b=0;null!=(a=this[b]);b++)1===a.nodeType&&(n.cleanData(ob(a,!1)),a.textContent="");return this},clone:function(a,b){return a=null==a?!1:a,b=null==b?a:b,this.map(function(){return n.clone(this,a,b)})},html:function(a){return J(this,function(a){var b=this[0]||{},c=0,d=this.length;if(void 0===a&&1===b.nodeType)return b.innerHTML;if("string"==typeof a&&!db.test(a)&&!ib[(bb.exec(a)||["",""])[1].toLowerCase()]){a=a.replace(ab,"<$1></$2>");try{for(;d>c;c++)b=this[c]||{},1===b.nodeType&&(n.cleanData(ob(b,!1)),b.innerHTML=a);b=0}catch(e){}}b&&this.empty().append(a)},null,a,arguments.length)},replaceWith:function(){var a=arguments[0];return this.domManip(arguments,function(b){a=this.parentNode,n.cleanData(ob(this)),a&&a.replaceChild(b,this)}),a&&(a.length||a.nodeType)?this:this.remove()},detach:function(a){return this.remove(a,!0)},domManip:function(a,b){a=e.apply([],a);var c,d,f,g,h,i,j=0,l=this.length,m=this,o=l-1,p=a[0],q=n.isFunction(p);if(q||l>1&&"string"==typeof p&&!k.checkClone&&eb.test(p))return this.each(function(c){var d=m.eq(c);q&&(a[0]=p.call(this,c,d.html())),d.domManip(a,b)});if(l&&(c=n.buildFragment(a,this[0].ownerDocument,!1,this),d=c.firstChild,1===c.childNodes.length&&(c=d),d)){for(f=n.map(ob(c,"script"),kb),g=f.length;l>j;j++)h=c,j!==o&&(h=n.clone(h,!0,!0),g&&n.merge(f,ob(h,"script"))),b.call(this[j],h,j);if(g)for(i=f[f.length-1].ownerDocument,n.map(f,lb),j=0;g>j;j++)h=f[j],fb.test(h.type||"")&&!L.access(h,"globalEval")&&n.contains(i,h)&&(h.src?n._evalUrl&&n._evalUrl(h.src):n.globalEval(h.textContent.replace(hb,"")))}return this}}),n.each({appendTo:"append",prependTo:"prepend",insertBefore:"before",insertAfter:"after",replaceAll:"replaceWith"},function(a,b){n.fn[a]=function(a){for(var c,d=[],e=n(a),g=e.length-1,h=0;g>=h;h++)c=h===g?this:this.clone(!0),n(e[h])[b](c),f.apply(d,c.get());return this.pushStack(d)}});var qb,rb={};function sb(b,c){var d,e=n(c.createElement(b)).appendTo(c.body),f=a.getDefaultComputedStyle&&(d=a.getDefaultComputedStyle(e[0]))?d.display:n.css(e[0],"display");return e.detach(),f}function tb(a){var b=l,c=rb[a];return c||(c=sb(a,b),"none"!==c&&c||(qb=(qb||n("<iframe frameborder='0' width='0' height='0'/>")).appendTo(b.documentElement),b=qb[0].contentDocument,b.write(),b.close(),c=sb(a,b),qb.detach()),rb[a]=c),c}var ub=/^margin/,vb=new RegExp("^("+Q+")(?!px)[a-z%]+$","i"),wb=function(b){return b.ownerDocument.defaultView.opener?b.ownerDocument.defaultView.getComputedStyle(b,null):a.getComputedStyle(b,null)};function xb(a,b,c){var d,e,f,g,h=a.style;return c=c||wb(a),c&&(g=c.getPropertyValue(b)||c[b]),c&&(""!==g||n.contains(a.ownerDocument,a)||(g=n.style(a,b)),vb.test(g)&&ub.test(b)&&(d=h.width,e=h.minWidth,f=h.maxWidth,h.minWidth=h.maxWidth=h.width=g,g=c.width,h.width=d,h.minWidth=e,h.maxWidth=f)),void 0!==g?g+"":g}function yb(a,b){return{get:function(){return a()?void delete this.get:(this.get=b).apply(this,arguments)}}}!function(){var b,c,d=l.documentElement,e=l.createElement("div"),f=l.createElement("div");if(f.style){f.style.backgroundClip="content-box",f.cloneNode(!0).style.backgroundClip="",k.clearCloneStyle="content-box"===f.style.backgroundClip,e.style.cssText="border:0;width:0;height:0;top:0;left:-9999px;margin-top:1px;position:absolute",e.appendChild(f);function g(){f.style.cssText="-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;display:block;margin-top:1%;top:1%;border:1px;padding:1px;width:4px;position:absolute",f.innerHTML="",d.appendChild(e);var g=a.getComputedStyle(f,null);b="1%"!==g.top,c="4px"===g.width,d.removeChild(e)}a.getComputedStyle&&n.extend(k,{pixelPosition:function(){return g(),b},boxSizingReliable:function(){return null==c&&g(),c},reliableMarginRight:function(){var b,c=f.appendChild(l.createElement("div"));return c.style.cssText=f.style.cssText="-webkit-box-sizing:content-box;-moz-box-sizing:content-box;box-sizing:content-box;display:block;margin:0;border:0;padding:0",c.style.marginRight=c.style.width="0",f.style.width="1px",d.appendChild(e),b=!parseFloat(a.getComputedStyle(c,null).marginRight),d.removeChild(e),f.removeChild(c),b}})}}(),n.swap=function(a,b,c,d){var e,f,g={};for(f in b)g[f]=a.style[f],a.style[f]=b[f];e=c.apply(a,d||[]);for(f in b)a.style[f]=g[f];return e};var zb=/^(none|table(?!-c[ea]).+)/,Ab=new RegExp("^("+Q+")(.*)$","i"),Bb=new RegExp("^([+-])=("+Q+")","i"),Cb={position:"absolute",visibility:"hidden",display:"block"},Db={letterSpacing:"0",fontWeight:"400"},Eb=["Webkit","O","Moz","ms"];function Fb(a,b){if(b in a)return b;var c=b[0].toUpperCase()+b.slice(1),d=b,e=Eb.length;while(e--)if(b=Eb[e]+c,b in a)return b;return d}function Gb(a,b,c){var d=Ab.exec(b);return d?Math.max(0,d[1]-(c||0))+(d[2]||"px"):b}function Hb(a,b,c,d,e){for(var f=c===(d?"border":"content")?4:"width"===b?1:0,g=0;4>f;f+=2)"margin"===c&&(g+=n.css(a,c+R[f],!0,e)),d?("content"===c&&(g-=n.css(a,"padding"+R[f],!0,e)),"margin"!==c&&(g-=n.css(a,"border"+R[f]+"Width",!0,e))):(g+=n.css(a,"padding"+R[f],!0,e),"padding"!==c&&(g+=n.css(a,"border"+R[f]+"Width",!0,e)));return g}function Ib(a,b,c){var d=!0,e="width"===b?a.offsetWidth:a.offsetHeight,f=wb(a),g="border-box"===n.css(a,"boxSizing",!1,f);if(0>=e||null==e){if(e=xb(a,b,f),(0>e||null==e)&&(e=a.style[b]),vb.test(e))return e;d=g&&(k.boxSizingReliable()||e===a.style[b]),e=parseFloat(e)||0}return e+Hb(a,b,c||(g?"border":"content"),d,f)+"px"}function Jb(a,b){for(var c,d,e,f=[],g=0,h=a.length;h>g;g++)d=a[g],d.style&&(f[g]=L.get(d,"olddisplay"),c=d.style.display,b?(f[g]||"none"!==c||(d.style.display=""),""===d.style.display&&S(d)&&(f[g]=L.access(d,"olddisplay",tb(d.nodeName)))):(e=S(d),"none"===c&&e||L.set(d,"olddisplay",e?c:n.css(d,"display"))));for(g=0;h>g;g++)d=a[g],d.style&&(b&&"none"!==d.style.display&&""!==d.style.display||(d.style.display=b?f[g]||"":"none"));return a}n.extend({cssHooks:{opacity:{get:function(a,b){if(b){var c=xb(a,"opacity");return""===c?"1":c}}}},cssNumber:{columnCount:!0,fillOpacity:!0,flexGrow:!0,flexShrink:!0,fontWeight:!0,lineHeight:!0,opacity:!0,order:!0,orphans:!0,widows:!0,zIndex:!0,zoom:!0},cssProps:{"float":"cssFloat"},style:function(a,b,c,d){if(a&&3!==a.nodeType&&8!==a.nodeType&&a.style){var e,f,g,h=n.camelCase(b),i=a.style;return b=n.cssProps[h]||(n.cssProps[h]=Fb(i,h)),g=n.cssHooks[b]||n.cssHooks[h],void 0===c?g&&"get"in g&&void 0!==(e=g.get(a,!1,d))?e:i[b]:(f=typeof c,"string"===f&&(e=Bb.exec(c))&&(c=(e[1]+1)*e[2]+parseFloat(n.css(a,b)),f="number"),null!=c&&c===c&&("number"!==f||n.cssNumber[h]||(c+="px"),k.clearCloneStyle||""!==c||0!==b.indexOf("background")||(i[b]="inherit"),g&&"set"in g&&void 0===(c=g.set(a,c,d))||(i[b]=c)),void 0)}},css:function(a,b,c,d){var e,f,g,h=n.camelCase(b);return b=n.cssProps[h]||(n.cssProps[h]=Fb(a.style,h)),g=n.cssHooks[b]||n.cssHooks[h],g&&"get"in g&&(e=g.get(a,!0,c)),void 0===e&&(e=xb(a,b,d)),"normal"===e&&b in Db&&(e=Db[b]),""===c||c?(f=parseFloat(e),c===!0||n.isNumeric(f)?f||0:e):e}}),n.each(["height","width"],function(a,b){n.cssHooks[b]={get:function(a,c,d){return c?zb.test(n.css(a,"display"))&&0===a.offsetWidth?n.swap(a,Cb,function(){return Ib(a,b,d)}):Ib(a,b,d):void 0},set:function(a,c,d){var e=d&&wb(a);return Gb(a,c,d?Hb(a,b,d,"border-box"===n.css(a,"boxSizing",!1,e),e):0)}}}),n.cssHooks.marginRight=yb(k.reliableMarginRight,function(a,b){return b?n.swap(a,{display:"inline-block"},xb,[a,"marginRight"]):void 0}),n.each({margin:"",padding:"",border:"Width"},function(a,b){n.cssHooks[a+b]={expand:function(c){for(var d=0,e={},f="string"==typeof c?c.split(" "):[c];4>d;d++)e[a+R[d]+b]=f[d]||f[d-2]||f[0];return e}},ub.test(a)||(n.cssHooks[a+b].set=Gb)}),n.fn.extend({css:function(a,b){return J(this,function(a,b,c){var d,e,f={},g=0;if(n.isArray(b)){for(d=wb(a),e=b.length;e>g;g++)f[b[g]]=n.css(a,b[g],!1,d);return f}return void 0!==c?n.style(a,b,c):n.css(a,b)},a,b,arguments.length>1)},show:function(){return Jb(this,!0)},hide:function(){return Jb(this)},toggle:function(a){return"boolean"==typeof a?a?this.show():this.hide():this.each(function(){S(this)?n(this).show():n(this).hide()})}});function Kb(a,b,c,d,e){return new Kb.prototype.init(a,b,c,d,e)}n.Tween=Kb,Kb.prototype={constructor:Kb,init:function(a,b,c,d,e,f){this.elem=a,this.prop=c,this.easing=e||"swing",this.options=b,this.start=this.now=this.cur(),this.end=d,this.unit=f||(n.cssNumber[c]?"":"px")},cur:function(){var a=Kb.propHooks[this.prop];return a&&a.get?a.get(this):Kb.propHooks._default.get(this)},run:function(a){var b,c=Kb.propHooks[this.prop];return this.pos=b=this.options.duration?n.easing[this.easing](a,this.options.duration*a,0,1,this.options.duration):a,this.now=(this.end-this.start)*b+this.start,this.options.step&&this.options.step.call(this.elem,this.now,this),c&&c.set?c.set(this):Kb.propHooks._default.set(this),this}},Kb.prototype.init.prototype=Kb.prototype,Kb.propHooks={_default:{get:function(a){var b;return null==a.elem[a.prop]||a.elem.style&&null!=a.elem.style[a.prop]?(b=n.css(a.elem,a.prop,""),b&&"auto"!==b?b:0):a.elem[a.prop]},set:function(a){n.fx.step[a.prop]?n.fx.step[a.prop](a):a.elem.style&&(null!=a.elem.style[n.cssProps[a.prop]]||n.cssHooks[a.prop])?n.style(a.elem,a.prop,a.now+a.unit):a.elem[a.prop]=a.now}}},Kb.propHooks.scrollTop=Kb.propHooks.scrollLeft={set:function(a){a.elem.nodeType&&a.elem.parentNode&&(a.elem[a.prop]=a.now)}},n.easing={linear:function(a){return a},swing:function(a){return.5-Math.cos(a*Math.PI)/2}},n.fx=Kb.prototype.init,n.fx.step={};var Lb,Mb,Nb=/^(?:toggle|show|hide)$/,Ob=new RegExp("^(?:([+-])=|)("+Q+")([a-z%]*)$","i"),Pb=/queueHooks$/,Qb=[Vb],Rb={"*":[function(a,b){var c=this.createTween(a,b),d=c.cur(),e=Ob.exec(b),f=e&&e[3]||(n.cssNumber[a]?"":"px"),g=(n.cssNumber[a]||"px"!==f&&+d)&&Ob.exec(n.css(c.elem,a)),h=1,i=20;if(g&&g[3]!==f){f=f||g[3],e=e||[],g=+d||1;do h=h||".5",g/=h,n.style(c.elem,a,g+f);while(h!==(h=c.cur()/d)&&1!==h&&--i)}return e&&(g=c.start=+g||+d||0,c.unit=f,c.end=e[1]?g+(e[1]+1)*e[2]:+e[2]),c}]};function Sb(){return setTimeout(function(){Lb=void 0}),Lb=n.now()}function Tb(a,b){var c,d=0,e={height:a};for(b=b?1:0;4>d;d+=2-b)c=R[d],e["margin"+c]=e["padding"+c]=a;return b&&(e.opacity=e.width=a),e}function Ub(a,b,c){for(var d,e=(Rb[b]||[]).concat(Rb["*"]),f=0,g=e.length;g>f;f++)if(d=e[f].call(c,b,a))return d}function Vb(a,b,c){var d,e,f,g,h,i,j,k,l=this,m={},o=a.style,p=a.nodeType&&S(a),q=L.get(a,"fxshow");c.queue||(h=n._queueHooks(a,"fx"),null==h.unqueued&&(h.unqueued=0,i=h.empty.fire,h.empty.fire=function(){h.unqueued||i()}),h.unqueued++,l.always(function(){l.always(function(){h.unqueued--,n.queue(a,"fx").length||h.empty.fire()})})),1===a.nodeType&&("height"in b||"width"in b)&&(c.overflow=[o.overflow,o.overflowX,o.overflowY],j=n.css(a,"display"),k="none"===j?L.get(a,"olddisplay")||tb(a.nodeName):j,"inline"===k&&"none"===n.css(a,"float")&&(o.display="inline-block")),c.overflow&&(o.overflow="hidden",l.always(function(){o.overflow=c.overflow[0],o.overflowX=c.overflow[1],o.overflowY=c.overflow[2]}));for(d in b)if(e=b[d],Nb.exec(e)){if(delete b[d],f=f||"toggle"===e,e===(p?"hide":"show")){if("show"!==e||!q||void 0===q[d])continue;p=!0}m[d]=q&&q[d]||n.style(a,d)}else j=void 0;if(n.isEmptyObject(m))"inline"===("none"===j?tb(a.nodeName):j)&&(o.display=j);else{q?"hidden"in q&&(p=q.hidden):q=L.access(a,"fxshow",{}),f&&(q.hidden=!p),p?n(a).show():l.done(function(){n(a).hide()}),l.done(function(){var b;L.remove(a,"fxshow");for(b in m)n.style(a,b,m[b])});for(d in m)g=Ub(p?q[d]:0,d,l),d in q||(q[d]=g.start,p&&(g.end=g.start,g.start="width"===d||"height"===d?1:0))}}function Wb(a,b){var c,d,e,f,g;for(c in a)if(d=n.camelCase(c),e=b[d],f=a[c],n.isArray(f)&&(e=f[1],f=a[c]=f[0]),c!==d&&(a[d]=f,delete a[c]),g=n.cssHooks[d],g&&"expand"in g){f=g.expand(f),delete a[d];for(c in f)c in a||(a[c]=f[c],b[c]=e)}else b[d]=e}function Xb(a,b,c){var d,e,f=0,g=Qb.length,h=n.Deferred().always(function(){delete i.elem}),i=function(){if(e)return!1;for(var b=Lb||Sb(),c=Math.max(0,j.startTime+j.duration-b),d=c/j.duration||0,f=1-d,g=0,i=j.tweens.length;i>g;g++)j.tweens[g].run(f);return h.notifyWith(a,[j,f,c]),1>f&&i?c:(h.resolveWith(a,[j]),!1)},j=h.promise({elem:a,props:n.extend({},b),opts:n.extend(!0,{specialEasing:{}},c),originalProperties:b,originalOptions:c,startTime:Lb||Sb(),duration:c.duration,tweens:[],createTween:function(b,c){var d=n.Tween(a,j.opts,b,c,j.opts.specialEasing[b]||j.opts.easing);return j.tweens.push(d),d},stop:function(b){var c=0,d=b?j.tweens.length:0;if(e)return this;for(e=!0;d>c;c++)j.tweens[c].run(1);return b?h.resolveWith(a,[j,b]):h.rejectWith(a,[j,b]),this}}),k=j.props;for(Wb(k,j.opts.specialEasing);g>f;f++)if(d=Qb[f].call(j,a,k,j.opts))return d;return n.map(k,Ub,j),n.isFunction(j.opts.start)&&j.opts.start.call(a,j),n.fx.timer(n.extend(i,{elem:a,anim:j,queue:j.opts.queue})),j.progress(j.opts.progress).done(j.opts.done,j.opts.complete).fail(j.opts.fail).always(j.opts.always)}n.Animation=n.extend(Xb,{tweener:function(a,b){n.isFunction(a)?(b=a,a=["*"]):a=a.split(" ");for(var c,d=0,e=a.length;e>d;d++)c=a[d],Rb[c]=Rb[c]||[],Rb[c].unshift(b)},prefilter:function(a,b){b?Qb.unshift(a):Qb.push(a)}}),n.speed=function(a,b,c){var d=a&&"object"==typeof a?n.extend({},a):{complete:c||!c&&b||n.isFunction(a)&&a,duration:a,easing:c&&b||b&&!n.isFunction(b)&&b};return d.duration=n.fx.off?0:"number"==typeof d.duration?d.duration:d.duration in n.fx.speeds?n.fx.speeds[d.duration]:n.fx.speeds._default,(null==d.queue||d.queue===!0)&&(d.queue="fx"),d.old=d.complete,d.complete=function(){n.isFunction(d.old)&&d.old.call(this),d.queue&&n.dequeue(this,d.queue)},d},n.fn.extend({fadeTo:function(a,b,c,d){return this.filter(S).css("opacity",0).show().end().animate({opacity:b},a,c,d)},animate:function(a,b,c,d){var e=n.isEmptyObject(a),f=n.speed(b,c,d),g=function(){var b=Xb(this,n.extend({},a),f);(e||L.get(this,"finish"))&&b.stop(!0)};return g.finish=g,e||f.queue===!1?this.each(g):this.queue(f.queue,g)},stop:function(a,b,c){var d=function(a){var b=a.stop;delete a.stop,b(c)};return"string"!=typeof a&&(c=b,b=a,a=void 0),b&&a!==!1&&this.queue(a||"fx",[]),this.each(function(){var b=!0,e=null!=a&&a+"queueHooks",f=n.timers,g=L.get(this);if(e)g[e]&&g[e].stop&&d(g[e]);else for(e in g)g[e]&&g[e].stop&&Pb.test(e)&&d(g[e]);for(e=f.length;e--;)f[e].elem!==this||null!=a&&f[e].queue!==a||(f[e].anim.stop(c),b=!1,f.splice(e,1));(b||!c)&&n.dequeue(this,a)})},finish:function(a){return a!==!1&&(a=a||"fx"),this.each(function(){var b,c=L.get(this),d=c[a+"queue"],e=c[a+"queueHooks"],f=n.timers,g=d?d.length:0;for(c.finish=!0,n.queue(this,a,[]),e&&e.stop&&e.stop.call(this,!0),b=f.length;b--;)f[b].elem===this&&f[b].queue===a&&(f[b].anim.stop(!0),f.splice(b,1));for(b=0;g>b;b++)d[b]&&d[b].finish&&d[b].finish.call(this);delete c.finish})}}),n.each(["toggle","show","hide"],function(a,b){var c=n.fn[b];n.fn[b]=function(a,d,e){return null==a||"boolean"==typeof a?c.apply(this,arguments):this.animate(Tb(b,!0),a,d,e)}}),n.each({slideDown:Tb("show"),slideUp:Tb("hide"),slideToggle:Tb("toggle"),fadeIn:{opacity:"show"},fadeOut:{opacity:"hide"},fadeToggle:{opacity:"toggle"}},function(a,b){n.fn[a]=function(a,c,d){return this.animate(b,a,c,d)}}),n.timers=[],n.fx.tick=function(){var a,b=0,c=n.timers;for(Lb=n.now();b<c.length;b++)a=c[b],a()||c[b]!==a||c.splice(b--,1);c.length||n.fx.stop(),Lb=void 0},n.fx.timer=function(a){n.timers.push(a),a()?n.fx.start():n.timers.pop()},n.fx.interval=13,n.fx.start=function(){Mb||(Mb=setInterval(n.fx.tick,n.fx.interval))},n.fx.stop=function(){clearInterval(Mb),Mb=null},n.fx.speeds={slow:600,fast:200,_default:400},n.fn.delay=function(a,b){return a=n.fx?n.fx.speeds[a]||a:a,b=b||"fx",this.queue(b,function(b,c){var d=setTimeout(b,a);c.stop=function(){clearTimeout(d)}})},function(){var a=l.createElement("input"),b=l.createElement("select"),c=b.appendChild(l.createElement("option"));a.type="checkbox",k.checkOn=""!==a.value,k.optSelected=c.selected,b.disabled=!0,k.optDisabled=!c.disabled,a=l.createElement("input"),a.value="t",a.type="radio",k.radioValue="t"===a.value}();var Yb,Zb,$b=n.expr.attrHandle;n.fn.extend({attr:function(a,b){return J(this,n.attr,a,b,arguments.length>1)},removeAttr:function(a){return this.each(function(){n.removeAttr(this,a)})}}),n.extend({attr:function(a,b,c){var d,e,f=a.nodeType;if(a&&3!==f&&8!==f&&2!==f)return typeof a.getAttribute===U?n.prop(a,b,c):(1===f&&n.isXMLDoc(a)||(b=b.toLowerCase(),d=n.attrHooks[b]||(n.expr.match.bool.test(b)?Zb:Yb)),void 0===c?d&&"get"in d&&null!==(e=d.get(a,b))?e:(e=n.find.attr(a,b),null==e?void 0:e):null!==c?d&&"set"in d&&void 0!==(e=d.set(a,c,b))?e:(a.setAttribute(b,c+""),c):void n.removeAttr(a,b))
+},removeAttr:function(a,b){var c,d,e=0,f=b&&b.match(E);if(f&&1===a.nodeType)while(c=f[e++])d=n.propFix[c]||c,n.expr.match.bool.test(c)&&(a[d]=!1),a.removeAttribute(c)},attrHooks:{type:{set:function(a,b){if(!k.radioValue&&"radio"===b&&n.nodeName(a,"input")){var c=a.value;return a.setAttribute("type",b),c&&(a.value=c),b}}}}}),Zb={set:function(a,b,c){return b===!1?n.removeAttr(a,c):a.setAttribute(c,c),c}},n.each(n.expr.match.bool.source.match(/\w+/g),function(a,b){var c=$b[b]||n.find.attr;$b[b]=function(a,b,d){var e,f;return d||(f=$b[b],$b[b]=e,e=null!=c(a,b,d)?b.toLowerCase():null,$b[b]=f),e}});var _b=/^(?:input|select|textarea|button)$/i;n.fn.extend({prop:function(a,b){return J(this,n.prop,a,b,arguments.length>1)},removeProp:function(a){return this.each(function(){delete this[n.propFix[a]||a]})}}),n.extend({propFix:{"for":"htmlFor","class":"className"},prop:function(a,b,c){var d,e,f,g=a.nodeType;if(a&&3!==g&&8!==g&&2!==g)return f=1!==g||!n.isXMLDoc(a),f&&(b=n.propFix[b]||b,e=n.propHooks[b]),void 0!==c?e&&"set"in e&&void 0!==(d=e.set(a,c,b))?d:a[b]=c:e&&"get"in e&&null!==(d=e.get(a,b))?d:a[b]},propHooks:{tabIndex:{get:function(a){return a.hasAttribute("tabindex")||_b.test(a.nodeName)||a.href?a.tabIndex:-1}}}}),k.optSelected||(n.propHooks.selected={get:function(a){var b=a.parentNode;return b&&b.parentNode&&b.parentNode.selectedIndex,null}}),n.each(["tabIndex","readOnly","maxLength","cellSpacing","cellPadding","rowSpan","colSpan","useMap","frameBorder","contentEditable"],function(){n.propFix[this.toLowerCase()]=this});var ac=/[\t\r\n\f]/g;n.fn.extend({addClass:function(a){var b,c,d,e,f,g,h="string"==typeof a&&a,i=0,j=this.length;if(n.isFunction(a))return this.each(function(b){n(this).addClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):" ")){f=0;while(e=b[f++])d.indexOf(" "+e+" ")<0&&(d+=e+" ");g=n.trim(d),c.className!==g&&(c.className=g)}return this},removeClass:function(a){var b,c,d,e,f,g,h=0===arguments.length||"string"==typeof a&&a,i=0,j=this.length;if(n.isFunction(a))return this.each(function(b){n(this).removeClass(a.call(this,b,this.className))});if(h)for(b=(a||"").match(E)||[];j>i;i++)if(c=this[i],d=1===c.nodeType&&(c.className?(" "+c.className+" ").replace(ac," "):"")){f=0;while(e=b[f++])while(d.indexOf(" "+e+" ")>=0)d=d.replace(" "+e+" "," ");g=a?n.trim(d):"",c.className!==g&&(c.className=g)}return this},toggleClass:function(a,b){var c=typeof a;return"boolean"==typeof b&&"string"===c?b?this.addClass(a):this.removeClass(a):this.each(n.isFunction(a)?function(c){n(this).toggleClass(a.call(this,c,this.className,b),b)}:function(){if("string"===c){var b,d=0,e=n(this),f=a.match(E)||[];while(b=f[d++])e.hasClass(b)?e.removeClass(b):e.addClass(b)}else(c===U||"boolean"===c)&&(this.className&&L.set(this,"__className__",this.className),this.className=this.className||a===!1?"":L.get(this,"__className__")||"")})},hasClass:function(a){for(var b=" "+a+" ",c=0,d=this.length;d>c;c++)if(1===this[c].nodeType&&(" "+this[c].className+" ").replace(ac," ").indexOf(b)>=0)return!0;return!1}});var bc=/\r/g;n.fn.extend({val:function(a){var b,c,d,e=this[0];{if(arguments.length)return d=n.isFunction(a),this.each(function(c){var e;1===this.nodeType&&(e=d?a.call(this,c,n(this).val()):a,null==e?e="":"number"==typeof e?e+="":n.isArray(e)&&(e=n.map(e,function(a){return null==a?"":a+""})),b=n.valHooks[this.type]||n.valHooks[this.nodeName.toLowerCase()],b&&"set"in b&&void 0!==b.set(this,e,"value")||(this.value=e))});if(e)return b=n.valHooks[e.type]||n.valHooks[e.nodeName.toLowerCase()],b&&"get"in b&&void 0!==(c=b.get(e,"value"))?c:(c=e.value,"string"==typeof c?c.replace(bc,""):null==c?"":c)}}}),n.extend({valHooks:{option:{get:function(a){var b=n.find.attr(a,"value");return null!=b?b:n.trim(n.text(a))}},select:{get:function(a){for(var b,c,d=a.options,e=a.selectedIndex,f="select-one"===a.type||0>e,g=f?null:[],h=f?e+1:d.length,i=0>e?h:f?e:0;h>i;i++)if(c=d[i],!(!c.selected&&i!==e||(k.optDisabled?c.disabled:null!==c.getAttribute("disabled"))||c.parentNode.disabled&&n.nodeName(c.parentNode,"optgroup"))){if(b=n(c).val(),f)return b;g.push(b)}return g},set:function(a,b){var c,d,e=a.options,f=n.makeArray(b),g=e.length;while(g--)d=e[g],(d.selected=n.inArray(d.value,f)>=0)&&(c=!0);return c||(a.selectedIndex=-1),f}}}}),n.each(["radio","checkbox"],function(){n.valHooks[this]={set:function(a,b){return n.isArray(b)?a.checked=n.inArray(n(a).val(),b)>=0:void 0}},k.checkOn||(n.valHooks[this].get=function(a){return null===a.getAttribute("value")?"on":a.value})}),n.each("blur focus focusin focusout load resize scroll unload click dblclick mousedown mouseup mousemove mouseover mouseout mouseenter mouseleave change select submit keydown keypress keyup error contextmenu".split(" "),function(a,b){n.fn[b]=function(a,c){return arguments.length>0?this.on(b,null,a,c):this.trigger(b)}}),n.fn.extend({hover:function(a,b){return this.mouseenter(a).mouseleave(b||a)},bind:function(a,b,c){return this.on(a,null,b,c)},unbind:function(a,b){return this.off(a,null,b)},delegate:function(a,b,c,d){return this.on(b,a,c,d)},undelegate:function(a,b,c){return 1===arguments.length?this.off(a,"**"):this.off(b,a||"**",c)}});var cc=n.now(),dc=/\?/;n.parseJSON=function(a){return JSON.parse(a+"")},n.parseXML=function(a){var b,c;if(!a||"string"!=typeof a)return null;try{c=new DOMParser,b=c.parseFromString(a,"text/xml")}catch(d){b=void 0}return(!b||b.getElementsByTagName("parsererror").length)&&n.error("Invalid XML: "+a),b};var ec=/#.*$/,fc=/([?&])_=[^&]*/,gc=/^(.*?):[ \t]*([^\r\n]*)$/gm,hc=/^(?:about|app|app-storage|.+-extension|file|res|widget):$/,ic=/^(?:GET|HEAD)$/,jc=/^\/\//,kc=/^([\w.+-]+:)(?:\/\/(?:[^\/?#]*@|)([^\/?#:]*)(?::(\d+)|)|)/,lc={},mc={},nc="*/".concat("*"),oc=a.location.href,pc=kc.exec(oc.toLowerCase())||[];function qc(a){return function(b,c){"string"!=typeof b&&(c=b,b="*");var d,e=0,f=b.toLowerCase().match(E)||[];if(n.isFunction(c))while(d=f[e++])"+"===d[0]?(d=d.slice(1)||"*",(a[d]=a[d]||[]).unshift(c)):(a[d]=a[d]||[]).push(c)}}function rc(a,b,c,d){var e={},f=a===mc;function g(h){var i;return e[h]=!0,n.each(a[h]||[],function(a,h){var j=h(b,c,d);return"string"!=typeof j||f||e[j]?f?!(i=j):void 0:(b.dataTypes.unshift(j),g(j),!1)}),i}return g(b.dataTypes[0])||!e["*"]&&g("*")}function sc(a,b){var c,d,e=n.ajaxSettings.flatOptions||{};for(c in b)void 0!==b[c]&&((e[c]?a:d||(d={}))[c]=b[c]);return d&&n.extend(!0,a,d),a}function tc(a,b,c){var d,e,f,g,h=a.contents,i=a.dataTypes;while("*"===i[0])i.shift(),void 0===d&&(d=a.mimeType||b.getResponseHeader("Content-Type"));if(d)for(e in h)if(h[e]&&h[e].test(d)){i.unshift(e);break}if(i[0]in c)f=i[0];else{for(e in c){if(!i[0]||a.converters[e+" "+i[0]]){f=e;break}g||(g=e)}f=f||g}return f?(f!==i[0]&&i.unshift(f),c[f]):void 0}function uc(a,b,c,d){var e,f,g,h,i,j={},k=a.dataTypes.slice();if(k[1])for(g in a.converters)j[g.toLowerCase()]=a.converters[g];f=k.shift();while(f)if(a.responseFields[f]&&(c[a.responseFields[f]]=b),!i&&d&&a.dataFilter&&(b=a.dataFilter(b,a.dataType)),i=f,f=k.shift())if("*"===f)f=i;else if("*"!==i&&i!==f){if(g=j[i+" "+f]||j["* "+f],!g)for(e in j)if(h=e.split(" "),h[1]===f&&(g=j[i+" "+h[0]]||j["* "+h[0]])){g===!0?g=j[e]:j[e]!==!0&&(f=h[0],k.unshift(h[1]));break}if(g!==!0)if(g&&a["throws"])b=g(b);else try{b=g(b)}catch(l){return{state:"parsererror",error:g?l:"No conversion from "+i+" to "+f}}}return{state:"success",data:b}}n.extend({active:0,lastModified:{},etag:{},ajaxSettings:{url:oc,type:"GET",isLocal:hc.test(pc[1]),global:!0,processData:!0,async:!0,contentType:"application/x-www-form-urlencoded; charset=UTF-8",accepts:{"*":nc,text:"text/plain",html:"text/html",xml:"application/xml, text/xml",json:"application/json, text/javascript"},contents:{xml:/xml/,html:/html/,json:/json/},responseFields:{xml:"responseXML",text:"responseText",json:"responseJSON"},converters:{"* text":String,"text html":!0,"text json":n.parseJSON,"text xml":n.parseXML},flatOptions:{url:!0,context:!0}},ajaxSetup:function(a,b){return b?sc(sc(a,n.ajaxSettings),b):sc(n.ajaxSettings,a)},ajaxPrefilter:qc(lc),ajaxTransport:qc(mc),ajax:function(a,b){"object"==typeof a&&(b=a,a=void 0),b=b||{};var c,d,e,f,g,h,i,j,k=n.ajaxSetup({},b),l=k.context||k,m=k.context&&(l.nodeType||l.jquery)?n(l):n.event,o=n.Deferred(),p=n.Callbacks("once memory"),q=k.statusCode||{},r={},s={},t=0,u="canceled",v={readyState:0,getResponseHeader:function(a){var b;if(2===t){if(!f){f={};while(b=gc.exec(e))f[b[1].toLowerCase()]=b[2]}b=f[a.toLowerCase()]}return null==b?null:b},getAllResponseHeaders:function(){return 2===t?e:null},setRequestHeader:function(a,b){var c=a.toLowerCase();return t||(a=s[c]=s[c]||a,r[a]=b),this},overrideMimeType:function(a){return t||(k.mimeType=a),this},statusCode:function(a){var b;if(a)if(2>t)for(b in a)q[b]=[q[b],a[b]];else v.always(a[v.status]);return this},abort:function(a){var b=a||u;return c&&c.abort(b),x(0,b),this}};if(o.promise(v).complete=p.add,v.success=v.done,v.error=v.fail,k.url=((a||k.url||oc)+"").replace(ec,"").replace(jc,pc[1]+"//"),k.type=b.method||b.type||k.method||k.type,k.dataTypes=n.trim(k.dataType||"*").toLowerCase().match(E)||[""],null==k.crossDomain&&(h=kc.exec(k.url.toLowerCase()),k.crossDomain=!(!h||h[1]===pc[1]&&h[2]===pc[2]&&(h[3]||("http:"===h[1]?"80":"443"))===(pc[3]||("http:"===pc[1]?"80":"443")))),k.data&&k.processData&&"string"!=typeof k.data&&(k.data=n.param(k.data,k.traditional)),rc(lc,k,b,v),2===t)return v;i=n.event&&k.global,i&&0===n.active++&&n.event.trigger("ajaxStart"),k.type=k.type.toUpperCase(),k.hasContent=!ic.test(k.type),d=k.url,k.hasContent||(k.data&&(d=k.url+=(dc.test(d)?"&":"?")+k.data,delete k.data),k.cache===!1&&(k.url=fc.test(d)?d.replace(fc,"$1_="+cc++):d+(dc.test(d)?"&":"?")+"_="+cc++)),k.ifModified&&(n.lastModified[d]&&v.setRequestHeader("If-Modified-Since",n.lastModified[d]),n.etag[d]&&v.setRequestHeader("If-None-Match",n.etag[d])),(k.data&&k.hasContent&&k.contentType!==!1||b.contentType)&&v.setRequestHeader("Content-Type",k.contentType),v.setRequestHeader("Accept",k.dataTypes[0]&&k.accepts[k.dataTypes[0]]?k.accepts[k.dataTypes[0]]+("*"!==k.dataTypes[0]?", "+nc+"; q=0.01":""):k.accepts["*"]);for(j in k.headers)v.setRequestHeader(j,k.headers[j]);if(k.beforeSend&&(k.beforeSend.call(l,v,k)===!1||2===t))return v.abort();u="abort";for(j in{success:1,error:1,complete:1})v[j](k[j]);if(c=rc(mc,k,b,v)){v.readyState=1,i&&m.trigger("ajaxSend",[v,k]),k.async&&k.timeout>0&&(g=setTimeout(function(){v.abort("timeout")},k.timeout));try{t=1,c.send(r,x)}catch(w){if(!(2>t))throw w;x(-1,w)}}else x(-1,"No Transport");function x(a,b,f,h){var j,r,s,u,w,x=b;2!==t&&(t=2,g&&clearTimeout(g),c=void 0,e=h||"",v.readyState=a>0?4:0,j=a>=200&&300>a||304===a,f&&(u=tc(k,v,f)),u=uc(k,u,v,j),j?(k.ifModified&&(w=v.getResponseHeader("Last-Modified"),w&&(n.lastModified[d]=w),w=v.getResponseHeader("etag"),w&&(n.etag[d]=w)),204===a||"HEAD"===k.type?x="nocontent":304===a?x="notmodified":(x=u.state,r=u.data,s=u.error,j=!s)):(s=x,(a||!x)&&(x="error",0>a&&(a=0))),v.status=a,v.statusText=(b||x)+"",j?o.resolveWith(l,[r,x,v]):o.rejectWith(l,[v,x,s]),v.statusCode(q),q=void 0,i&&m.trigger(j?"ajaxSuccess":"ajaxError",[v,k,j?r:s]),p.fireWith(l,[v,x]),i&&(m.trigger("ajaxComplete",[v,k]),--n.active||n.event.trigger("ajaxStop")))}return v},getJSON:function(a,b,c){return n.get(a,b,c,"json")},getScript:function(a,b){return n.get(a,void 0,b,"script")}}),n.each(["get","post"],function(a,b){n[b]=function(a,c,d,e){return n.isFunction(c)&&(e=e||d,d=c,c=void 0),n.ajax({url:a,type:b,dataType:e,data:c,success:d})}}),n._evalUrl=function(a){return n.ajax({url:a,type:"GET",dataType:"script",async:!1,global:!1,"throws":!0})},n.fn.extend({wrapAll:function(a){var b;return n.isFunction(a)?this.each(function(b){n(this).wrapAll(a.call(this,b))}):(this[0]&&(b=n(a,this[0].ownerDocument).eq(0).clone(!0),this[0].parentNode&&b.insertBefore(this[0]),b.map(function(){var a=this;while(a.firstElementChild)a=a.firstElementChild;return a}).append(this)),this)},wrapInner:function(a){return this.each(n.isFunction(a)?function(b){n(this).wrapInner(a.call(this,b))}:function(){var b=n(this),c=b.contents();c.length?c.wrapAll(a):b.append(a)})},wrap:function(a){var b=n.isFunction(a);return this.each(function(c){n(this).wrapAll(b?a.call(this,c):a)})},unwrap:function(){return this.parent().each(function(){n.nodeName(this,"body")||n(this).replaceWith(this.childNodes)}).end()}}),n.expr.filters.hidden=function(a){return a.offsetWidth<=0&&a.offsetHeight<=0},n.expr.filters.visible=function(a){return!n.expr.filters.hidden(a)};var vc=/%20/g,wc=/\[\]$/,xc=/\r?\n/g,yc=/^(?:submit|button|image|reset|file)$/i,zc=/^(?:input|select|textarea|keygen)/i;function Ac(a,b,c,d){var e;if(n.isArray(b))n.each(b,function(b,e){c||wc.test(a)?d(a,e):Ac(a+"["+("object"==typeof e?b:"")+"]",e,c,d)});else if(c||"object"!==n.type(b))d(a,b);else for(e in b)Ac(a+"["+e+"]",b[e],c,d)}n.param=function(a,b){var c,d=[],e=function(a,b){b=n.isFunction(b)?b():null==b?"":b,d[d.length]=encodeURIComponent(a)+"="+encodeURIComponent(b)};if(void 0===b&&(b=n.ajaxSettings&&n.ajaxSettings.traditional),n.isArray(a)||a.jquery&&!n.isPlainObject(a))n.each(a,function(){e(this.name,this.value)});else for(c in a)Ac(c,a[c],b,e);return d.join("&").replace(vc,"+")},n.fn.extend({serialize:function(){return n.param(this.serializeArray())},serializeArray:function(){return this.map(function(){var a=n.prop(this,"elements");return a?n.makeArray(a):this}).filter(function(){var a=this.type;return this.name&&!n(this).is(":disabled")&&zc.test(this.nodeName)&&!yc.test(a)&&(this.checked||!T.test(a))}).map(function(a,b){var c=n(this).val();return null==c?null:n.isArray(c)?n.map(c,function(a){return{name:b.name,value:a.replace(xc,"\r\n")}}):{name:b.name,value:c.replace(xc,"\r\n")}}).get()}}),n.ajaxSettings.xhr=function(){try{return new XMLHttpRequest}catch(a){}};var Bc=0,Cc={},Dc={0:200,1223:204},Ec=n.ajaxSettings.xhr();a.attachEvent&&a.attachEvent("onunload",function(){for(var a in Cc)Cc[a]()}),k.cors=!!Ec&&"withCredentials"in Ec,k.ajax=Ec=!!Ec,n.ajaxTransport(function(a){var b;return k.cors||Ec&&!a.crossDomain?{send:function(c,d){var e,f=a.xhr(),g=++Bc;if(f.open(a.type,a.url,a.async,a.username,a.password),a.xhrFields)for(e in a.xhrFields)f[e]=a.xhrFields[e];a.mimeType&&f.overrideMimeType&&f.overrideMimeType(a.mimeType),a.crossDomain||c["X-Requested-With"]||(c["X-Requested-With"]="XMLHttpRequest");for(e in c)f.setRequestHeader(e,c[e]);b=function(a){return function(){b&&(delete Cc[g],b=f.onload=f.onerror=null,"abort"===a?f.abort():"error"===a?d(f.status,f.statusText):d(Dc[f.status]||f.status,f.statusText,"string"==typeof f.responseText?{text:f.responseText}:void 0,f.getAllResponseHeaders()))}},f.onload=b(),f.onerror=b("error"),b=Cc[g]=b("abort");try{f.send(a.hasContent&&a.data||null)}catch(h){if(b)throw h}},abort:function(){b&&b()}}:void 0}),n.ajaxSetup({accepts:{script:"text/javascript, application/javascript, application/ecmascript, application/x-ecmascript"},contents:{script:/(?:java|ecma)script/},converters:{"text script":function(a){return n.globalEval(a),a}}}),n.ajaxPrefilter("script",function(a){void 0===a.cache&&(a.cache=!1),a.crossDomain&&(a.type="GET")}),n.ajaxTransport("script",function(a){if(a.crossDomain){var b,c;return{send:function(d,e){b=n("<script>").prop({async:!0,charset:a.scriptCharset,src:a.url}).on("load error",c=function(a){b.remove(),c=null,a&&e("error"===a.type?404:200,a.type)}),l.head.appendChild(b[0])},abort:function(){c&&c()}}}});var Fc=[],Gc=/(=)\?(?=&|$)|\?\?/;n.ajaxSetup({jsonp:"callback",jsonpCallback:function(){var a=Fc.pop()||n.expando+"_"+cc++;return this[a]=!0,a}}),n.ajaxPrefilter("json jsonp",function(b,c,d){var e,f,g,h=b.jsonp!==!1&&(Gc.test(b.url)?"url":"string"==typeof b.data&&!(b.contentType||"").indexOf("application/x-www-form-urlencoded")&&Gc.test(b.data)&&"data");return h||"jsonp"===b.dataTypes[0]?(e=b.jsonpCallback=n.isFunction(b.jsonpCallback)?b.jsonpCallback():b.jsonpCallback,h?b[h]=b[h].replace(Gc,"$1"+e):b.jsonp!==!1&&(b.url+=(dc.test(b.url)?"&":"?")+b.jsonp+"="+e),b.converters["script json"]=function(){return g||n.error(e+" was not called"),g[0]},b.dataTypes[0]="json",f=a[e],a[e]=function(){g=arguments},d.always(function(){a[e]=f,b[e]&&(b.jsonpCallback=c.jsonpCallback,Fc.push(e)),g&&n.isFunction(f)&&f(g[0]),g=f=void 0}),"script"):void 0}),n.parseHTML=function(a,b,c){if(!a||"string"!=typeof a)return null;"boolean"==typeof b&&(c=b,b=!1),b=b||l;var d=v.exec(a),e=!c&&[];return d?[b.createElement(d[1])]:(d=n.buildFragment([a],b,e),e&&e.length&&n(e).remove(),n.merge([],d.childNodes))};var Hc=n.fn.load;n.fn.load=function(a,b,c){if("string"!=typeof a&&Hc)return Hc.apply(this,arguments);var d,e,f,g=this,h=a.indexOf(" ");return h>=0&&(d=n.trim(a.slice(h)),a=a.slice(0,h)),n.isFunction(b)?(c=b,b=void 0):b&&"object"==typeof b&&(e="POST"),g.length>0&&n.ajax({url:a,type:e,dataType:"html",data:b}).done(function(a){f=arguments,g.html(d?n("<div>").append(n.parseHTML(a)).find(d):a)}).complete(c&&function(a,b){g.each(c,f||[a.responseText,b,a])}),this},n.each(["ajaxStart","ajaxStop","ajaxComplete","ajaxError","ajaxSuccess","ajaxSend"],function(a,b){n.fn[b]=function(a){return this.on(b,a)}}),n.expr.filters.animated=function(a){return n.grep(n.timers,function(b){return a===b.elem}).length};var Ic=a.document.documentElement;function Jc(a){return n.isWindow(a)?a:9===a.nodeType&&a.defaultView}n.offset={setOffset:function(a,b,c){var d,e,f,g,h,i,j,k=n.css(a,"position"),l=n(a),m={};"static"===k&&(a.style.position="relative"),h=l.offset(),f=n.css(a,"top"),i=n.css(a,"left"),j=("absolute"===k||"fixed"===k)&&(f+i).indexOf("auto")>-1,j?(d=l.position(),g=d.top,e=d.left):(g=parseFloat(f)||0,e=parseFloat(i)||0),n.isFunction(b)&&(b=b.call(a,c,h)),null!=b.top&&(m.top=b.top-h.top+g),null!=b.left&&(m.left=b.left-h.left+e),"using"in b?b.using.call(a,m):l.css(m)}},n.fn.extend({offset:function(a){if(arguments.length)return void 0===a?this:this.each(function(b){n.offset.setOffset(this,a,b)});var b,c,d=this[0],e={top:0,left:0},f=d&&d.ownerDocument;if(f)return b=f.documentElement,n.contains(b,d)?(typeof d.getBoundingClientRect!==U&&(e=d.getBoundingClientRect()),c=Jc(f),{top:e.top+c.pageYOffset-b.clientTop,left:e.left+c.pageXOffset-b.clientLeft}):e},position:function(){if(this[0]){var a,b,c=this[0],d={top:0,left:0};return"fixed"===n.css(c,"position")?b=c.getBoundingClientRect():(a=this.offsetParent(),b=this.offset(),n.nodeName(a[0],"html")||(d=a.offset()),d.top+=n.css(a[0],"borderTopWidth",!0),d.left+=n.css(a[0],"borderLeftWidth",!0)),{top:b.top-d.top-n.css(c,"marginTop",!0),left:b.left-d.left-n.css(c,"marginLeft",!0)}}},offsetParent:function(){return this.map(function(){var a=this.offsetParent||Ic;while(a&&!n.nodeName(a,"html")&&"static"===n.css(a,"position"))a=a.offsetParent;return a||Ic})}}),n.each({scrollLeft:"pageXOffset",scrollTop:"pageYOffset"},function(b,c){var d="pageYOffset"===c;n.fn[b]=function(e){return J(this,function(b,e,f){var g=Jc(b);return void 0===f?g?g[c]:b[e]:void(g?g.scrollTo(d?a.pageXOffset:f,d?f:a.pageYOffset):b[e]=f)},b,e,arguments.length,null)}}),n.each(["top","left"],function(a,b){n.cssHooks[b]=yb(k.pixelPosition,function(a,c){return c?(c=xb(a,b),vb.test(c)?n(a).position()[b]+"px":c):void 0})}),n.each({Height:"height",Width:"width"},function(a,b){n.each({padding:"inner"+a,content:b,"":"outer"+a},function(c,d){n.fn[d]=function(d,e){var f=arguments.length&&(c||"boolean"!=typeof d),g=c||(d===!0||e===!0?"margin":"border");return J(this,function(b,c,d){var e;return n.isWindow(b)?b.document.documentElement["client"+a]:9===b.nodeType?(e=b.documentElement,Math.max(b.body["scroll"+a],e["scroll"+a],b.body["offset"+a],e["offset"+a],e["client"+a])):void 0===d?n.css(b,c,g):n.style(b,c,d,g)},b,f?d:void 0,f,null)}})}),n.fn.size=function(){return this.length},n.fn.andSelf=n.fn.addBack,"function"==typeof define&&define.amd&&define("jquery",[],function(){return n});var Kc=a.jQuery,Lc=a.$;return n.noConflict=function(b){return a.$===n&&(a.$=Lc),b&&a.jQuery===n&&(a.jQuery=Kc),n},typeof b===U&&(a.jQuery=a.$=n),n});
diff --git a/libs/editor-common/assets/jquery.mobile-events.min.js b/libs/editor-common/assets/jquery.mobile-events.min.js
old mode 100644
new mode 100755
diff --git a/libs/editor-common/assets/js-beautifier.js b/libs/editor-common/assets/js-beautifier.js
new file mode 100644
index 000000000000..e0227ebeb1f7
--- /dev/null
+++ b/libs/editor-common/assets/js-beautifier.js
@@ -0,0 +1,766 @@
+/*
+ 
+ The MIT License (MIT)
+ 
+ Copyright (c) 2007-2013 Einar Lielmanis and contributors.
+ 
+ Permission is hereby granted, free of charge, to any person
+ obtaining a copy of this software and associated documentation files
+ (the "Software"), to deal in the Software without restriction,
+ including without limitation the rights to use, copy, modify, merge,
+ publish, distribute, sublicense, and/or sell copies of the Software,
+ and to permit persons to whom the Software is furnished to do so,
+ subject to the following conditions:
+ 
+ The above copyright notice and this permission notice shall be
+ included in all copies or substantial portions of the Software.
+ 
+ THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND,
+ EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
+ MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND
+ NONINFRINGEMENT. IN NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS
+ BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, WHETHER IN AN
+ ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF OR IN
+ CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
+ SOFTWARE.
+ 
+ JS Beautifier
+ ---------------
+ 
+ */
+
+function trim(s) {
+    return s.replace(/^\s+|\s+$/g, '');
+}
+
+function ltrim(s) {
+    return s.replace(/^\s+/g, '');
+}
+
+function style_html(html_source, options) {
+    //Wrapper function to invoke all the necessary constructors and deal with the output.
+    
+    var multi_parser,
+    indent_inner_html,
+    indent_size,
+    indent_character,
+    wrap_line_length,
+    brace_style,
+    unformatted,
+    preserve_newlines,
+    max_preserve_newlines;
+    
+    options = options || {};
+    
+    // backwards compatibility to 1.3.4
+    if ((options.wrap_line_length === undefined || parseInt(options.wrap_line_length, 10) === 0) &&
+        (options.max_char === undefined || parseInt(options.max_char, 10) === 0)) {
+        options.wrap_line_length = options.max_char;
+    }
+    
+    indent_inner_html = options.indent_inner_html || false;
+    indent_size = parseInt(options.indent_size || 4, 10);
+    indent_character = options.indent_char || ' ';
+    brace_style = options.brace_style || 'collapse';
+    wrap_line_length =  parseInt(options.wrap_line_length, 10) === 0 ? 32786 : parseInt(options.wrap_line_length || 250, 10);
+    unformatted = options.unformatted || ['a', 'span', 'bdo', 'em', 'strong', 'dfn', 'code', 'samp', 'kbd', 'var', 'cite', 'abbr', 'acronym', 'q', 'sub', 'sup', 'tt', 'i', 'b', 'big', 'small', 'u', 's', 'strike', 'font', 'ins', 'del', 'pre', 'address', 'dt', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6'];
+    preserve_newlines = options.preserve_newlines || true;
+    max_preserve_newlines = preserve_newlines ? parseInt(options.max_preserve_newlines || 32786, 10) : 0;
+    indent_handlebars = options.indent_handlebars || false;
+    
+    function Parser() {
+        
+        this.pos = 0; //Parser position
+        this.token = '';
+        this.current_mode = 'CONTENT'; //reflects the current Parser mode: TAG/CONTENT
+        this.tags = { //An object to hold tags, their position, and their parent-tags, initiated with default values
+        parent: 'parent1',
+        parentcount: 1,
+        parent1: ''
+        };
+        this.tag_type = '';
+        this.token_text = this.last_token = this.last_text = this.token_type = '';
+        this.newlines = 0;
+        this.indent_content = indent_inner_html;
+        
+        this.Utils = { //Uilities made available to the various functions
+        whitespace: "\n\r\t ".split(''),
+        single_token: 'br,input,link,meta,!doctype,basefont,base,area,hr,wbr,param,img,isindex,?xml,embed,?php,?,?='.split(','), //all the single tags for HTML
+        extra_liners: 'head,body,/html'.split(','), //for tags that need a line of whitespace before them
+        in_array: function(what, arr) {
+            for (var i = 0; i < arr.length; i++) {
+                if (what === arr[i]) {
+                    return true;
+                }
+            }
+            return false;
+        }
+        };
+        
+        this.traverse_whitespace = function() {
+            var input_char = '';
+            
+            input_char = this.input.charAt(this.pos);
+            if (this.Utils.in_array(input_char, this.Utils.whitespace)) {
+                this.newlines = 0;
+                while (this.Utils.in_array(input_char, this.Utils.whitespace)) {
+                    if (preserve_newlines && input_char === '\n' && this.newlines <= max_preserve_newlines) {
+                        this.newlines += 1;
+                    }
+                    
+                    this.pos++;
+                    input_char = this.input.charAt(this.pos);
+                }
+                return true;
+            }
+            return false;
+        };
+        
+        this.get_content = function() { //function to capture regular content between tags
+            
+            var input_char = '',
+            content = [],
+            space = false; //if a space is needed
+            
+            while (this.input.charAt(this.pos) !== '<') {
+                if (this.pos >= this.input.length) {
+                    return content.length ? content.join('') : ['', 'TK_EOF'];
+                }
+                
+                if (this.traverse_whitespace()) {
+                    if (content.length) {
+                        space = true;
+                    }
+                    continue; //don't want to insert unnecessary space
+                }
+                
+                if (indent_handlebars) {
+                    // Handlebars parsing is complicated.
+                    // {{#foo}} and {{/foo}} are formatted tags.
+                    // {{something}} should get treated as content, except:
+                    // {{else}} specifically behaves like {{#if}} and {{/if}}
+                    var peek3 = this.input.substr(this.pos, 3);
+                    if (peek3 === '{{#' || peek3 === '{{/') {
+                        // These are tags and not content.
+                        break;
+                    } else if (this.input.substr(this.pos, 2) === '{{') {
+                        if (this.get_tag(true) === '{{else}}') {
+                            break;
+                        }
+                    }
+                }
+                
+                input_char = this.input.charAt(this.pos);
+                this.pos++;
+                
+                if (space) {
+                    if (this.line_char_count >= this.wrap_line_length) { //insert a line when the wrap_line_length is reached
+                        this.print_newline(false, content);
+                        this.print_indentation(content);
+                    } else {
+                        this.line_char_count++;
+                        content.push(' ');
+                    }
+                    space = false;
+                }
+                this.line_char_count++;
+                content.push(input_char); //letter at-a-time (or string) inserted to an array
+            }
+            return content.length ? content.join('') : '';
+        };
+        
+        this.get_contents_to = function(name) { //get the full content of a script or style to pass to js_beautify
+            if (this.pos === this.input.length) {
+                return ['', 'TK_EOF'];
+            }
+            var input_char = '';
+            var content = '';
+            var reg_match = new RegExp('</' + name + '\\s*>', 'igm');
+            reg_match.lastIndex = this.pos;
+            var reg_array = reg_match.exec(this.input);
+            var end_script = reg_array ? reg_array.index : this.input.length; //absolute end of script
+            if (this.pos < end_script) { //get everything in between the script tags
+                content = this.input.substring(this.pos, end_script);
+                this.pos = end_script;
+            }
+            return content;
+        };
+        
+        this.record_tag = function(tag) { //function to record a tag and its parent in this.tags Object
+            if (this.tags[tag + 'count']) { //check for the existence of this tag type
+                this.tags[tag + 'count']++;
+                this.tags[tag + this.tags[tag + 'count']] = this.indent_level; //and record the present indent level
+            } else { //otherwise initialize this tag type
+                this.tags[tag + 'count'] = 1;
+                this.tags[tag + this.tags[tag + 'count']] = this.indent_level; //and record the present indent level
+            }
+            this.tags[tag + this.tags[tag + 'count'] + 'parent'] = this.tags.parent; //set the parent (i.e. in the case of a div this.tags.div1parent)
+            this.tags.parent = tag + this.tags[tag + 'count']; //and make this the current parent (i.e. in the case of a div 'div1')
+        };
+        
+        this.retrieve_tag = function(tag) { //function to retrieve the opening tag to the corresponding closer
+            if (this.tags[tag + 'count']) { //if the openener is not in the Object we ignore it
+                var temp_parent = this.tags.parent; //check to see if it's a closable tag.
+                while (temp_parent) { //till we reach '' (the initial value);
+                    if (tag + this.tags[tag + 'count'] === temp_parent) { //if this is it use it
+                        break;
+                    }
+                    temp_parent = this.tags[temp_parent + 'parent']; //otherwise keep on climbing up the DOM Tree
+                }
+                if (temp_parent) { //if we caught something
+                    this.indent_level = this.tags[tag + this.tags[tag + 'count']]; //set the indent_level accordingly
+                    this.tags.parent = this.tags[temp_parent + 'parent']; //and set the current parent
+                }
+                delete this.tags[tag + this.tags[tag + 'count'] + 'parent']; //delete the closed tags parent reference...
+                delete this.tags[tag + this.tags[tag + 'count']]; //...and the tag itself
+                if (this.tags[tag + 'count'] === 1) {
+                    delete this.tags[tag + 'count'];
+                } else {
+                    this.tags[tag + 'count']--;
+                }
+            }
+        };
+        
+        this.indent_to_tag = function(tag) {
+            // Match the indentation level to the last use of this tag, but don't remove it.
+            if (!this.tags[tag + 'count']) {
+                return;
+            }
+            var temp_parent = this.tags.parent;
+            while (temp_parent) {
+                if (tag + this.tags[tag + 'count'] === temp_parent) {
+                    break;
+                }
+                temp_parent = this.tags[temp_parent + 'parent'];
+            }
+            if (temp_parent) {
+                this.indent_level = this.tags[tag + this.tags[tag + 'count']];
+            }
+        };
+        
+        this.get_tag = function(peek) { //function to get a full tag and parse its type
+            var input_char = '',
+            content = [],
+            comment = '',
+            space = false,
+            tag_start, tag_end,
+            tag_start_char,
+            orig_pos = this.pos,
+            orig_line_char_count = this.line_char_count;
+            
+            peek = peek !== undefined ? peek : false;
+            
+            do {
+                if (this.pos >= this.input.length) {
+                    if (peek) {
+                        this.pos = orig_pos;
+                        this.line_char_count = orig_line_char_count;
+                    }
+                    return content.length ? content.join('') : ['', 'TK_EOF'];
+                }
+                
+                input_char = this.input.charAt(this.pos);
+                this.pos++;
+                
+                if (this.Utils.in_array(input_char, this.Utils.whitespace)) { //don't want to insert unnecessary space
+                    space = true;
+                    continue;
+                }
+                
+                if (input_char === "'" || input_char === '"') {
+                    input_char += this.get_unformatted(input_char);
+                    space = true;
+                    
+                }
+                
+                if (input_char === '=') { //no space before =
+                    space = false;
+                }
+                
+                if (content.length && content[content.length - 1] !== '=' && input_char !== '>' && space) {
+                    //no space after = or before >
+                    if (this.line_char_count >= this.wrap_line_length) {
+                        this.print_newline(false, content);
+                        this.print_indentation(content);
+                    } else {
+                        content.push(' ');
+                        this.line_char_count++;
+                    }
+                    space = false;
+                }
+                
+                if (indent_handlebars && tag_start_char === '<') {
+                    // When inside an angle-bracket tag, put spaces around
+                    // handlebars not inside of strings.
+                    if ((input_char + this.input.charAt(this.pos)) === '{{') {
+                        input_char += this.get_unformatted('}}');
+                        if (content.length && content[content.length - 1] !== ' ' && content[content.length - 1] !== '<') {
+                            input_char = ' ' + input_char;
+                        }
+                        space = true;
+                    }
+                }
+                
+                if (input_char === '<' && !tag_start_char) {
+                    tag_start = this.pos - 1;
+                    tag_start_char = '<';
+                }
+                
+                if (indent_handlebars && !tag_start_char) {
+                    if (content.length >= 2 && content[content.length - 1] === '{' && content[content.length - 2] == '{') {
+                        if (input_char === '#' || input_char === '/') {
+                            tag_start = this.pos - 3;
+                        } else {
+                            tag_start = this.pos - 2;
+                        }
+                        tag_start_char = '{';
+                    }
+                }
+                
+                this.line_char_count++;
+                content.push(input_char); //inserts character at-a-time (or string)
+                
+                if (content[1] && content[1] === '!') { //if we're in a comment, do something special
+                    // We treat all comments as literals, even more than preformatted tags
+                    // we just look for the appropriate close tag
+                    content = [this.get_comment(tag_start)];
+                    break;
+                }
+                
+                if (indent_handlebars && tag_start_char === '{' && content.length > 2 && content[content.length - 2] === '}' && content[content.length - 1] === '}') {
+                    break;
+                }
+            } while (input_char !== '>');
+            
+            var tag_complete = content.join('');
+            var tag_index;
+            var tag_offset;
+            
+            if (tag_complete.indexOf(' ') !== -1) { //if there's whitespace, thats where the tag name ends
+                tag_index = tag_complete.indexOf(' ');
+            } else if (tag_complete[0] === '{') {
+                tag_index = tag_complete.indexOf('}');
+            } else { //otherwise go with the tag ending
+                tag_index = tag_complete.indexOf('>');
+            }
+            if (tag_complete[0] === '<' || !indent_handlebars) {
+                tag_offset = 1;
+            } else {
+                tag_offset = tag_complete[2] === '#' ? 3 : 2;
+            }
+            var tag_check = tag_complete.substring(tag_offset, tag_index).toLowerCase();
+            if (tag_complete.charAt(tag_complete.length - 2) === '/' ||
+                this.Utils.in_array(tag_check, this.Utils.single_token)) { //if this tag name is a single tag type (either in the list or has a closing /)
+                if (!peek) {
+                    this.tag_type = 'SINGLE';
+                }
+            } else if (indent_handlebars && tag_complete[0] === '{' && tag_check === 'else') {
+                if (!peek) {
+                    this.indent_to_tag('if');
+                    this.tag_type = 'HANDLEBARS_ELSE';
+                    this.indent_content = true;
+                    this.traverse_whitespace();
+                }
+            } else if (tag_check === 'script') { //for later script handling
+                if (!peek) {
+                    this.record_tag(tag_check);
+                    this.tag_type = 'SCRIPT';
+                }
+            } else if (tag_check === 'style') { //for future style handling (for now it justs uses get_content)
+                if (!peek) {
+                    this.record_tag(tag_check);
+                    this.tag_type = 'STYLE';
+                }
+            } else if (this.is_unformatted(tag_check, unformatted)) { // do not reformat the "unformatted" tags
+                comment = this.get_unformatted('</' + tag_check + '>', tag_complete); //...delegate to get_unformatted function
+                content.push(comment);
+                // Preserve collapsed whitespace either before or after this tag.
+                if (tag_start > 0 && this.Utils.in_array(this.input.charAt(tag_start - 1), this.Utils.whitespace)) {
+                    content.splice(0, 0, this.input.charAt(tag_start - 1));
+                }
+                tag_end = this.pos - 1;
+                if (this.Utils.in_array(this.input.charAt(tag_end + 1), this.Utils.whitespace)) {
+                    content.push(this.input.charAt(tag_end + 1));
+                }
+                this.tag_type = 'SINGLE';
+            } else if (tag_check.charAt(0) === '!') { //peek for <! comment
+                // for comments content is already correct.
+                if (!peek) {
+                    this.tag_type = 'SINGLE';
+                    this.traverse_whitespace();
+                }
+            } else if (!peek) {
+                if (tag_check.charAt(0) === '/') { //this tag is a double tag so check for tag-ending
+                    this.retrieve_tag(tag_check.substring(1)); //remove it and all ancestors
+                    this.tag_type = 'END';
+                    this.traverse_whitespace();
+                } else { //otherwise it's a start-tag
+                    this.record_tag(tag_check); //push it on the tag stack
+                    if (tag_check.toLowerCase() !== 'html') {
+                        this.indent_content = true;
+                    }
+                    this.tag_type = 'START';
+                    
+                    // Allow preserving of newlines after a start tag
+                    this.traverse_whitespace();
+                }
+                if (this.Utils.in_array(tag_check, this.Utils.extra_liners)) { //check if this double needs an extra line
+                    this.print_newline(false, this.output);
+                    if (this.output.length && this.output[this.output.length - 2] !== '\n') {
+                        this.print_newline(true, this.output);
+                    }
+                }
+            }
+            
+            if (peek) {
+                this.pos = orig_pos;
+                this.line_char_count = orig_line_char_count;
+            }
+            
+            return content.join(''); //returns fully formatted tag
+        };
+        
+        this.get_comment = function(start_pos) { //function to return comment content in its entirety
+            // this is will have very poor perf, but will work for now.
+            var comment = '',
+            delimiter = '>',
+            matched = false;
+            
+            this.pos = start_pos;
+            input_char = this.input.charAt(this.pos);
+            this.pos++;
+            
+            while (this.pos <= this.input.length) {
+                comment += input_char;
+                
+                // only need to check for the delimiter if the last chars match
+                if (comment[comment.length - 1] === delimiter[delimiter.length - 1] &&
+                    comment.indexOf(delimiter) !== -1) {
+                    break;
+                }
+                
+                // only need to search for custom delimiter for the first few characters
+                if (!matched && comment.length < 10) {
+                    if (comment.indexOf('<![if') === 0) { //peek for <![if conditional comment
+                        delimiter = '<![endif]>';
+                        matched = true;
+                    } else if (comment.indexOf('<![cdata[') === 0) { //if it's a <[cdata[ comment...
+                        delimiter = ']]>';
+                        matched = true;
+                    } else if (comment.indexOf('<![') === 0) { // some other ![ comment? ...
+                        delimiter = ']>';
+                        matched = true;
+                    } else if (comment.indexOf('<!--') === 0) { // <!-- comment ...
+                        delimiter = '-->';
+                        matched = true;
+                    }
+                }
+                
+                input_char = this.input.charAt(this.pos);
+                this.pos++;
+            }
+            
+            return comment;
+        };
+        
+        this.get_unformatted = function(delimiter, orig_tag) { //function to return unformatted content in its entirety
+            
+            if (orig_tag && orig_tag.toLowerCase().indexOf(delimiter) !== -1) {
+                return '';
+            }
+            var input_char = '';
+            var content = '';
+            var min_index = 0;
+            var space = true;
+            do {
+                
+                if (this.pos >= this.input.length) {
+                    return content;
+                }
+                
+                input_char = this.input.charAt(this.pos);
+                this.pos++;
+                
+                if (this.Utils.in_array(input_char, this.Utils.whitespace)) {
+                    if (!space) {
+                        this.line_char_count--;
+                        continue;
+                    }
+                    if (input_char === '\n' || input_char === '\r') {
+                        content += '\n';
+                        /*  Don't change tab indention for unformatted blocks.  If using code for html editing, this will greatly affect <pre> tags if they are specified in the 'unformatted array'
+                         for (var i=0; i<this.indent_level; i++) {
+                         content += this.indent_string;
+                         }
+                         space = false; //...and make sure other indentation is erased
+                         */
+                        this.line_char_count = 0;
+                        continue;
+                    }
+                }
+                content += input_char;
+                this.line_char_count++;
+                space = true;
+                
+                if (indent_handlebars && input_char === '{' && content.length && content[content.length - 2] === '{') {
+                    // Handlebars expressions in strings should also be unformatted.
+                    content += this.get_unformatted('}}');
+                    // These expressions are opaque.  Ignore delimiters found in them.
+                    min_index = content.length;
+                }
+            } while (content.toLowerCase().indexOf(delimiter, min_index) === -1);
+            return content;
+        };
+        
+        this.get_token = function() { //initial handler for token-retrieval
+            var token;
+            
+            if (this.last_token === 'TK_TAG_SCRIPT' || this.last_token === 'TK_TAG_STYLE') { //check if we need to format javascript
+                var type = this.last_token.substr(7);
+                token = this.get_contents_to(type);
+                if (typeof token !== 'string') {
+                    return token;
+                }
+                return [token, 'TK_' + type];
+            }
+            if (this.current_mode === 'CONTENT') {
+                token = this.get_content();
+                if (typeof token !== 'string') {
+                    return token;
+                } else {
+                    return [token, 'TK_CONTENT'];
+                }
+            }
+            
+            if (this.current_mode === 'TAG') {
+                token = this.get_tag();
+                if (typeof token !== 'string') {
+                    return token;
+                } else {
+                    var tag_name_type = 'TK_TAG_' + this.tag_type;
+                    return [token, tag_name_type];
+                }
+            }
+        };
+        
+        this.get_full_indent = function(level) {
+            level = this.indent_level + level || 0;
+            if (level < 1) {
+                return '';
+            }
+            
+            return Array(level + 1).join(this.indent_string);
+        };
+        
+        this.is_unformatted = function(tag_check, unformatted) {
+            //is this an HTML5 block-level link?
+            if (!this.Utils.in_array(tag_check, unformatted)) {
+                return false;
+            }
+            
+            if (tag_check.toLowerCase() !== 'a' || !this.Utils.in_array('a', unformatted)) {
+                return true;
+            }
+            
+            //at this point we have an  tag; is its first child something we want to remain
+            //unformatted?
+            var next_tag = this.get_tag(true /* peek. */ );
+            
+            // test next_tag to see if it is just html tag (no external content)
+            var tag = (next_tag || "").match(/^\s*<\s*\/?([a-z]*)\s*[^>]*>\s*$/);
+            
+            // if next_tag comes back but is not an isolated tag, then
+            // let's treat the 'a' tag as having content
+            // and respect the unformatted option
+            if (!tag || this.Utils.in_array(tag, unformatted)) {
+                return true;
+            } else {
+                return false;
+            }
+        };
+        
+        this.printer = function(js_source, indent_character, indent_size, wrap_line_length, brace_style) { //handles input/output and some other printing functions
+            
+            this.input = js_source || ''; //gets the input for the Parser
+            this.output = [];
+            this.indent_character = indent_character;
+            this.indent_string = '';
+            this.indent_size = indent_size;
+            this.brace_style = brace_style;
+            this.indent_level = 0;
+            this.wrap_line_length = wrap_line_length;
+            this.line_char_count = 0; //count to see if wrap_line_length was exceeded
+            
+            for (var i = 0; i < this.indent_size; i++) {
+                this.indent_string += this.indent_character;
+            }
+            
+            this.print_newline = function(force, arr) {
+                this.line_char_count = 0;
+                if (!arr || !arr.length) {
+                    return;
+                }
+                if (force || (arr[arr.length - 1] !== '\n')) { //we might want the extra line
+                    arr.push('\n');
+                }
+            };
+            
+            this.print_indentation = function(arr) {
+                for (var i = 0; i < this.indent_level; i++) {
+                    arr.push(this.indent_string);
+                    this.line_char_count += this.indent_string.length;
+                }
+            };
+            
+            this.print_token = function(text) {
+                if (text || text !== '') {
+                    if (this.output.length && this.output[this.output.length - 1] === '\n') {
+                        this.print_indentation(this.output);
+                        text = ltrim(text);
+                    }
+                }
+                this.print_token_raw(text);
+            };
+            
+            this.print_token_raw = function(text) {
+                if (text && text !== '') {
+                    if (text.length > 1 && text[text.length - 1] === '\n') {
+                        // unformatted tags can grab newlines as their last character
+                        this.output.push(text.slice(0, -1));
+                        this.print_newline(false, this.output);
+                    } else {
+                        this.output.push(text);
+                    }
+                }
+                
+                for (var n = 0; n < this.newlines; n++) {
+                    this.print_newline(n > 0, this.output);
+                }
+                this.newlines = 0;
+            };
+            
+            this.indent = function() {
+                this.indent_level++;
+            };
+            
+            this.unindent = function() {
+                if (this.indent_level > 0) {
+                    this.indent_level--;
+                }
+            };
+        };
+        return this;
+    }
+    
+    /*_____________________--------------------_____________________*/
+    
+    multi_parser = new Parser(); //wrapping functions Parser
+    multi_parser.printer(html_source, indent_character, indent_size, wrap_line_length, brace_style); //initialize starting values
+    
+    while (true) {
+        var t = multi_parser.get_token();
+        multi_parser.token_text = t[0];
+        multi_parser.token_type = t[1];
+        
+        if (multi_parser.token_type === 'TK_EOF') {
+            break;
+        }
+        
+        switch (multi_parser.token_type) {
+            case 'TK_TAG_START':
+                multi_parser.print_newline(false, multi_parser.output);
+                multi_parser.print_token(multi_parser.token_text);
+                if (multi_parser.indent_content) {
+                    multi_parser.indent();
+                    multi_parser.indent_content = false;
+                }
+                multi_parser.current_mode = 'CONTENT';
+                break;
+            case 'TK_TAG_STYLE':
+            case 'TK_TAG_SCRIPT':
+                multi_parser.print_newline(false, multi_parser.output);
+                multi_parser.print_token(multi_parser.token_text);
+                multi_parser.current_mode = 'CONTENT';
+                break;
+            case 'TK_TAG_END':
+                //Print new line only if the tag has no content and has child
+                if (multi_parser.last_token === 'TK_CONTENT' && multi_parser.last_text === '') {
+                    var tag_name = multi_parser.token_text.match(/\w+/)[0];
+                    var tag_extracted_from_last_output = null;
+                    if (multi_parser.output.length) {
+                        tag_extracted_from_last_output = multi_parser.output[multi_parser.output.length - 1].match(/(?:<|{{#)\s*(\w+)/);
+                    }
+                    if (tag_extracted_from_last_output === null ||
+                        tag_extracted_from_last_output[1] !== tag_name) {
+                        multi_parser.print_newline(false, multi_parser.output);
+                    }
+                }
+                multi_parser.print_token(multi_parser.token_text);
+                multi_parser.current_mode = 'CONTENT';
+                break;
+            case 'TK_TAG_SINGLE':
+                // Don't add a newline before elements that should remain unformatted.
+                var tag_check = multi_parser.token_text.match(/^\s*<([a-z]+)/i);
+                if (!tag_check || !multi_parser.Utils.in_array(tag_check[1], unformatted)) {
+                    multi_parser.print_newline(false, multi_parser.output);
+                }
+                multi_parser.print_token(multi_parser.token_text);
+                multi_parser.current_mode = 'CONTENT';
+                break;
+            case 'TK_TAG_HANDLEBARS_ELSE':
+                multi_parser.print_token(multi_parser.token_text);
+                if (multi_parser.indent_content) {
+                    multi_parser.indent();
+                    multi_parser.indent_content = false;
+                }
+                multi_parser.current_mode = 'CONTENT';
+                break;
+            case 'TK_CONTENT':
+                multi_parser.print_token(multi_parser.token_text);
+                multi_parser.current_mode = 'TAG';
+                break;
+            case 'TK_STYLE':
+            case 'TK_SCRIPT':
+                if (multi_parser.token_text !== '') {
+                    multi_parser.print_newline(false, multi_parser.output);
+                    var text = multi_parser.token_text,
+                    _beautifier,
+                    script_indent_level = 1;
+                    if (multi_parser.token_type === 'TK_SCRIPT') {
+                        _beautifier = typeof js_beautify === 'function' && js_beautify;
+                    } else if (multi_parser.token_type === 'TK_STYLE') {
+                        _beautifier = typeof css_beautify === 'function' && css_beautify;
+                    }
+                    
+                    if (options.indent_scripts === "keep") {
+                        script_indent_level = 0;
+                    } else if (options.indent_scripts === "separate") {
+                        script_indent_level = -multi_parser.indent_level;
+                    }
+                    
+                    var indentation = multi_parser.get_full_indent(script_indent_level);
+                    if (_beautifier) {
+                        // call the Beautifier if avaliable
+                        text = _beautifier(text.replace(/^\s*/, indentation), options);
+                    } else {
+                        // simply indent the string otherwise
+                        var white = text.match(/^\s*/)[0];
+                        var _level = white.match(/[^\n\r]*$/)[0].split(multi_parser.indent_string).length - 1;
+                        var reindent = multi_parser.get_full_indent(script_indent_level - _level);
+                        text = text.replace(/^\s*/, indentation)
+                        .replace(/\r\n|\r|\n/g, '\n' + reindent)
+                        .replace(/\s+$/, '');
+                    }
+                    if (text) {
+                        multi_parser.print_token_raw(indentation + trim(text));
+                        multi_parser.print_newline(false, multi_parser.output);
+                    }
+                }
+                multi_parser.current_mode = 'TAG';
+                break;
+        }
+        multi_parser.last_token = multi_parser.token_type;
+        multi_parser.last_text = multi_parser.token_text;
+    }
+    return multi_parser.output.join('');
+}
\ No newline at end of file
diff --git a/libs/editor-common/assets/rangy-classapplier.js b/libs/editor-common/assets/rangy-classapplier.js
new file mode 100755
index 000000000000..f0ea1271effb
--- /dev/null
+++ b/libs/editor-common/assets/rangy-classapplier.js
@@ -0,0 +1,15 @@
+/**
+ * Class Applier module for Rangy.
+ * Adds, removes and toggles classes on Ranges and Selections
+ *
+ * Part of Rangy, a cross-browser JavaScript range and selection library
+ * https://github.com/timdown/rangy
+ *
+ * Depends on Rangy core.
+ *
+ * Copyright 2015, Tim Down
+ * Licensed under the MIT license.
+ * Version: 1.3.0
+ * Build date: 10 May 2015
+ */
+!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("ClassApplier",["WrappedSelection"],function(e,t){function n(e,t){for(var n in e)if(e.hasOwnProperty(n)&&t(n,e[n])===!1)return!1;return!0}function s(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function r(e,t){return!!e&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e)}function o(e,t){if("object"==typeof e.classList)return e.classList.contains(t);var n="string"==typeof e.className,s=n?e.className:e.getAttribute("class");return r(s,t)}function a(e,t){if("object"==typeof e.classList)e.classList.add(t);else{var n="string"==typeof e.className,s=n?e.className:e.getAttribute("class");s?r(s,t)||(s+=" "+t):s=t,n?e.className=s:e.setAttribute("class",s)}}function l(e){var t="string"==typeof e.className;return t?e.className:e.getAttribute("class")}function u(e){return e&&e.split(/\s+/).sort().join(" ")}function f(e){return u(l(e))}function c(e,t){return f(e)==f(t)}function p(e,t){for(var n=t.split(/\s+/),r=0,i=n.length;i>r;++r)if(!o(e,s(n[r])))return!1;return!0}function d(e){var t=e.parentNode;return t&&1==t.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(t.nodeName)}function h(e,t,n,s,r){var i=e.node,o=e.offset,a=i,l=o;i==s&&o>r&&++l,i!=t||o!=n&&o!=n+1||(a=s,l+=r-n),i==t&&o>n+1&&--l,e.node=a,e.offset=l}function m(e,t,n){e.node==t&&e.offset>n&&--e.offset}function g(e,t,n,s){-1==n&&(n=t.childNodes.length);var r=e.parentNode,i=$.getNodeIndex(e);U(s,function(e){h(e,r,i,t,n)}),t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function N(e,t){var n=e.parentNode,s=$.getNodeIndex(e);U(t,function(e){m(e,n,s)}),$.removeNode(e)}function v(e,t,n,s,r){for(var i,o=[];i=e.firstChild;)g(i,t,n++,r),o.push(i);return s&&N(e,r),o}function y(e,t){return v(e,e.parentNode,$.getNodeIndex(e),!0,t)}function C(e,t){var n=e.cloneRange();n.selectNodeContents(t);var s=n.intersection(e),r=s?s.toString():"";return""!=r}function T(e){for(var t,n=e.getNodes([3]),s=0;(t=n[s])&&!C(e,t);)++s;for(var r=n.length-1;(t=n[r])&&!C(e,t);)--r;return n.slice(s,r+1)}function E(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,s,r,i=0,o=e.attributes.length;o>i;++i)if(n=e.attributes[i],r=n.name,"class"!=r){if(s=t.attributes.getNamedItem(r),null===n!=(null===s))return!1;if(n.specified!=s.specified)return!1;if(n.specified&&n.nodeValue!==s.nodeValue)return!1}return!0}function b(e,t){for(var n,s=0,r=e.attributes.length;r>s;++s)if(n=e.attributes[s].name,(!t||!B(t,n))&&e.attributes[s].specified&&"class"!=n)return!0;return!1}function A(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||G(e)&&!G(e.parentNode))}function S(e){return(G(e)||1!=e.nodeType&&G(e.parentNode))&&!A(e)}function x(e){return e&&1==e.nodeType&&!J.test(F(e,"display"))}function R(e){if(0==e.data.length)return!0;if(K.test(e.data))return!1;var t=F(e.parentNode,"whiteSpace");switch(t){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return x(e.previousSibling)||x(e.nextSibling)}function P(e){var t,n,s=[];for(t=0;n=e[t++];)s.push(new z(n.startContainer,n.startOffset),new z(n.endContainer,n.endOffset));return s}function w(e,t){for(var n,s,r,i=0,o=e.length;o>i;++i)n=e[i],s=t[2*i],r=t[2*i+1],n.setStartAndEnd(s.node,s.offset,r.node,r.offset)}function O(e,t){return $.isCharacterDataNode(e)?0==t?!!e.previousSibling:t==e.length?!!e.nextSibling:!0:t>0&&t<e.childNodes.length}function I(e,n,s,r){var i,o,a=0==s;if($.isAncestorOf(n,e))return e;if($.isCharacterDataNode(n)){var l=$.getNodeIndex(n);if(0==s)s=l;else{if(s!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+s+" in "+n.data);s=l+1}n=n.parentNode}if(O(n,s)){i=n.cloneNode(!1),o=n.parentNode,i.id&&i.removeAttribute("id");for(var u,f=0;u=n.childNodes[s];)g(u,i,f++,r);return g(i,o,$.getNodeIndex(n)+1,r),n==e?i:I(e,o,$.getNodeIndex(i),r)}if(e!=n){i=n.parentNode;var c=$.getNodeIndex(n);return a||c++,I(e,i,c,r)}return e}function W(e,t){return e.namespaceURI==t.namespaceURI&&e.tagName.toLowerCase()==t.tagName.toLowerCase()&&c(e,t)&&E(e,t)&&"inline"==F(e,"display")&&"inline"==F(t,"display")}function L(e){var t=e?"nextSibling":"previousSibling";return function(n,s){var r=n.parentNode,i=n[t];if(i){if(i&&3==i.nodeType)return i}else if(s&&(i=r[t],i&&1==i.nodeType&&W(r,i))){var o=i[e?"firstChild":"lastChild"];if(o&&3==o.nodeType)return o}return null}}function M(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function H(e,t,r){var i,o,a,l,f=this;f.cssClass=f.className=e;var c=null,p={};if("object"==typeof t&&null!==t){for("undefined"!=typeof t.elementTagName&&(t.elementTagName=t.elementTagName.toLowerCase()),r=t.tagNames,c=t.elementProperties,p=t.elementAttributes,o=0;l=Y[o++];)t.hasOwnProperty(l)&&(f[l]=t[l]);i=t.normalize}else i=t;f.normalize="undefined"==typeof i?!0:i,f.attrExceptions=[];var d=document.createElement(f.elementTagName);f.elementProperties=f.copyPropertiesToElement(c,d,!0),n(p,function(e,t){f.attrExceptions.push(e),p[e]=""+t}),f.elementAttributes=p,f.elementSortedClassName=f.elementProperties.hasOwnProperty("className")?u(f.elementProperties.className+" "+e):e,f.applyToAnyTagName=!1;var h=typeof r;if("string"==h)"*"==r?f.applyToAnyTagName=!0:f.tagNames=s(r.toLowerCase()).split(/\s*,\s*/);else if("object"==h&&"number"==typeof r.length)for(f.tagNames=[],o=0,a=r.length;a>o;++o)"*"==r[o]?f.applyToAnyTagName=!0:f.tagNames.push(r[o].toLowerCase());else f.tagNames=[f.elementTagName]}function j(e,t,n){return new H(e,t,n)}var $=e.dom,z=$.DomPosition,B=$.arrayContains,D=e.util,U=D.forEach,V="span",k=D.isHostMethod(document,"createElementNS"),q=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){if("object"==typeof t.classList)t.classList.remove(n);else{var s="string"==typeof t.className,r=s?t.className:t.getAttribute("class");r=r.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e),s?t.className=r:t.setAttribute("class",r)}}}(),F=$.getComputedStyleProperty,G=function(){var e=document.createElement("div");return"boolean"==typeof e.isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return e&&1==e.nodeType&&"false"!=e.contentEditable?"true"==e.contentEditable||G(e.parentNode):!1}}(),J=/^inline(-block|-table)?$/i,K=/[^\r\n\t\f \u200B]/,Q=L(!1),X=L(!0);M.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){var s,r=$.getNodeIndex(n),i=[],o=0;U(t,function(t,a){s=t.parentNode,a>0&&(s.removeChild(t),s.hasChildNodes()||$.removeNode(s),e&&U(e,function(e){e.node==t&&(e.node=n,e.offset+=o),e.node==s&&e.offset>r&&(--e.offset,e.offset==r+1&&len-1>a&&(e.node=n,e.offset=o))})),i[a]=t.data,o+=t.data.length}),n.data=i.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){var e=[];return U(this.textNodes,function(t,n){e[n]="'"+t.data+"'"}),"[Merge("+e.join(",")+")]"}};var Y=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],Z={};H.prototype={elementTagName:V,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var s,r,i,o,l,f,c={};for(var p in e)if(e.hasOwnProperty(p))if(o=e[p],l=t[p],"className"==p)a(t,o),a(t,this.className),t[p]=u(t[p]),n&&(c[p]=o);else if("style"==p){r=l,n&&(c[p]=i={});for(s in e[p])e[p].hasOwnProperty(s)&&(r[s]=o[s],n&&(i[s]=r[s]));this.attrExceptions.push(p)}else t[p]=o,n&&(c[p]=t[p],f=Z.hasOwnProperty(p)?Z[p]:p,this.attrExceptions.push(f));return n?c:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&t.setAttribute(n,e[n])},appliesToElement:function(e){return B(this.tagNames,e.tagName.toLowerCase())},getEmptyElements:function(e){var t=this;return e.getNodes([1],function(e){return t.appliesToElement(e)&&!e.hasChildNodes()})},hasClass:function(e){return 1==e.nodeType&&(this.applyToAnyTagName||this.appliesToElement(e))&&o(e,this.className)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||S(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&R(e)},postApply:function(e,t,n,s){var r,o,a=e[0],l=e[e.length-1],u=[],f=a,c=l,p=0,d=l.length;U(e,function(e){o=Q(e,!s),o?(r||(r=new M(o),u.push(r)),r.textNodes.push(e),e===a&&(f=r.textNodes[0],p=f.length),e===l&&(c=r.textNodes[0],d=r.getLength())):r=null});var h=X(l,!s);if(h&&(r||(r=new M(l),u.push(r)),r.textNodes.push(h)),u.length){for(i=0,len=u.length;len>i;++i)u[i].doMerge(n);t.setStartAndEnd(f,p,c,d)}},createContainer:function(e){var t,n=$.getDocument(e),s=k&&!$.isHtmlNamespace(e)&&(t=e.namespaceURI)?n.createElementNS(e.namespaceURI,this.elementTagName):n.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,s,!1),this.copyAttributesToElement(this.elementAttributes,s),a(s,this.className),this.onElementCreate&&this.onElementCreate(s,this),s},elementHasProperties:function(e,t){var s=this;return n(t,function(t,n){if("className"==t)return p(e,n);if("object"==typeof n){if(!s.elementHasProperties(e[t],n))return!1}else if(e[t]!==n)return!1})},elementHasAttributes:function(e,t){return n(t,function(t,n){return e.getAttribute(t)!==n?!1:void 0})},applyToTextNode:function(e){if(d(e)){var t=e.parentNode;if(1==t.childNodes.length&&this.useExistingElements&&this.appliesToElement(t)&&this.elementHasProperties(t,this.elementProperties)&&this.elementHasAttributes(t,this.elementAttributes))a(t,this.className);else{var n=e.parentNode,s=this.createContainer(n);n.insertBefore(s,e),s.appendChild(e)}}},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&f(e)==this.elementSortedClassName&&this.elementHasProperties(e,this.elementProperties)&&!b(e,this.attrExceptions)&&this.elementHasAttributes(e,this.elementAttributes)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){var t=this,n=e.getNodes([1],function(e){return t.isEmptyContainer(e)}),s=[e],r=P(s);U(n,function(e){N(e,r)}),w(s,r)},undoToTextNode:function(e,t,n,s){if(!t.containsNode(n)){var r=t.cloneRange();r.selectNode(n),r.isPointInRange(t.endContainer,t.endOffset)&&(I(n,t.endContainer,t.endOffset,s),t.setEndAfter(n)),r.isPointInRange(t.startContainer,t.startOffset)&&(n=I(n,t.startContainer,t.startOffset,s))}this.isRemovable(n)?y(n,s):q(n,this.className)},splitAncestorWithClass:function(e,t,n){var s=this.getSelfOrAncestorWithClass(e);s&&I(s,e,t,n)},undoToAncestor:function(e,t){this.isRemovable(e)?y(e,t):q(e,this.className)},applyToRange:function(e,t){var n=this;t=t||[];var s=P(t||[]);e.splitBoundariesPreservingPositions(s),n.removeEmptyElements&&n.removeEmptyContainers(e);var r=T(e);if(r.length){U(r,function(e){n.isIgnorableWhiteSpaceNode(e)||n.getSelfOrAncestorWithClass(e)||!n.isModifiable(e)||n.applyToTextNode(e,s)});var i=r[r.length-1];e.setStartAndEnd(r[0],0,i,i.length),n.normalize&&n.postApply(r,e,s,!1),w(t,s)}var o=n.getEmptyElements(e);U(o,function(e){a(e,n.className)})},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){var n=this;t=t||[];var s=P(t);e.splitBoundariesPreservingPositions(s),n.removeEmptyElements&&n.removeEmptyContainers(e,s);var r,i,o=T(e),a=o[o.length-1];if(o.length){n.splitAncestorWithClass(e.endContainer,e.endOffset,s),n.splitAncestorWithClass(e.startContainer,e.startOffset,s);for(var l=0,u=o.length;u>l;++l)r=o[l],i=n.getSelfOrAncestorWithClass(r),i&&n.isModifiable(r)&&n.undoToAncestor(i,s);e.setStartAndEnd(o[0],0,a,a.length),n.normalize&&n.postApply(o,e,s,!0),w(t,s)}var f=n.getEmptyElements(e);U(f,function(e){q(e,n.className)})},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),s=e.getSelection(t).getAllRanges();this.undoToRanges(s),n.setRanges(s)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,s=0;n=t[s++];)if(!this.isIgnorableWhiteSpaceNode(n)&&C(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var t=[],n=this;return e.getNodes([3],function(e){var s=n.getSelfOrAncestorWithClass(e);s&&!B(t,s)&&t.push(s)}),t},detach:function(){}},H.util={hasClass:o,addClass:a,removeClass:q,getClass:l,hasSameClasses:c,hasAllClasses:p,replaceWithOwnChildren:y,elementsHaveSameNonClassAttributes:E,elementHasNonClassAttributes:b,splitNodeAt:I,isEditableElement:G,isEditingHost:A,isEditable:S},e.CssClassApplier=e.ClassApplier=H,e.createClassApplier=j,D.createAliasForDeprecatedMethod(e,"createCssClassApplier","createClassApplier",t)}),e},this);
\ No newline at end of file
diff --git a/libs/editor-common/assets/rangy-core.js b/libs/editor-common/assets/rangy-core.js
new file mode 100755
index 000000000000..fb8b28d83531
--- /dev/null
+++ b/libs/editor-common/assets/rangy-core.js
@@ -0,0 +1,11 @@
+/**
+ * Rangy, a cross-browser JavaScript range and selection library
+ * https://github.com/timdown/rangy
+ *
+ * Copyright 2015, Tim Down
+ * Licensed under the MIT license.
+ * Version: 1.3.0
+ * Build date: 10 May 2015
+ */
+!function(e,t){"function"==typeof define&&define.amd?define(e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e():t.rangy=e()}(function(){function e(e,t){var n=typeof e[t];return n==N||!(n!=C||!e[t])||"unknown"==n}function t(e,t){return!(typeof e[t]!=C||!e[t])}function n(e,t){return typeof e[t]!=E}function r(e){return function(t,n){for(var r=n.length;r--;)if(!e(t,n[r]))return!1;return!0}}function o(e){return e&&O(e,T)&&D(e,w)}function i(e){return t(e,"body")?e.body:e.getElementsByTagName("body")[0]}function a(t){typeof console!=E&&e(console,"log")&&console.log(t)}function s(e,t){b&&t?alert(e):a(e)}function c(e){I.initialized=!0,I.supported=!1,s("Rangy is not supported in this environment. Reason: "+e,I.config.alertOnFail)}function d(e){s("Rangy warning: "+e,I.config.alertOnWarn)}function f(e){return e.message||e.description||String(e)}function u(){if(b&&!I.initialized){var t,n=!1,r=!1;e(document,"createRange")&&(t=document.createRange(),O(t,y)&&D(t,S)&&(n=!0));var s=i(document);if(!s||"body"!=s.nodeName.toLowerCase())return void c("No body element found");if(s&&e(s,"createTextRange")&&(t=s.createTextRange(),o(t)&&(r=!0)),!n&&!r)return void c("Neither Range nor TextRange are available");I.initialized=!0,I.features={implementsDomRange:n,implementsTextRange:r};var d,u;for(var l in x)(d=x[l])instanceof p&&d.init(d,I);for(var h=0,g=M.length;g>h;++h)try{M[h](I)}catch(m){u="Rangy init listener threw an exception. Continuing. Detail: "+f(m),a(u)}}}function l(e,t,n){n&&(e+=" in module "+n.name),I.warn("DEPRECATED: "+e+" is deprecated. Please use "+t+" instead.")}function h(e,t,n,r){e[t]=function(){return l(t,n,r),e[n].apply(e,P.toArray(arguments))}}function g(e){e=e||window,u();for(var t=0,n=k.length;n>t;++t)k[t](e)}function p(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function m(e,t,n){var r=new p(e,t,function(t){if(!t.initialized){t.initialized=!0;try{n(I,t),t.supported=!0}catch(r){var o="Module '"+e+"' failed to load: "+f(r);a(o),r.stack&&a(r.stack)}}});return x[e]=r,r}function R(){}function v(){}var C="object",N="function",E="undefined",S=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],y=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],w=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],T=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],O=r(e),_=r(t),D=r(n),A=[].forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=0,r=e.length;r>n;++n)t(e[n],n)},x={},b=typeof window!=E&&typeof document!=E,P={isHostMethod:e,isHostObject:t,isHostProperty:n,areHostMethods:O,areHostObjects:_,areHostProperties:D,isTextRange:o,getBody:i,forEach:A},I={version:"1.3.0",initialized:!1,isBrowser:b,supported:!0,util:P,features:{},modules:x,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==E?!0:rangyAutoInitialize}};I.fail=c,I.warn=d;var B;({}).hasOwnProperty?(P.extend=B=function(e,t,n){var r,o;for(var i in t)t.hasOwnProperty(i)&&(r=e[i],o=t[i],n&&null!==r&&"object"==typeof r&&null!==o&&"object"==typeof o&&B(r,o,!0),e[i]=o);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e},P.createOptions=function(e,t){var n={};return B(n,t),e&&B(n,e),n}):c("hasOwnProperty not supported"),b||c("Rangy can only run in a browser"),function(){var e;if(b){var t=document.createElement("div");t.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(t.childNodes,0)[0].nodeType&&(e=function(e){return n.call(e,0)})}catch(r){}}e||(e=function(e){for(var t=[],n=0,r=e.length;r>n;++n)t[n]=e[n];return t}),P.toArray=e}();var H;b&&(e(document,"addEventListener")?H=function(e,t,n){e.addEventListener(t,n,!1)}:e(document,"attachEvent")?H=function(e,t,n){e.attachEvent("on"+t,n)}:c("Document does not have required addEventListener or attachEvent method"),P.addListener=H);var M=[];P.deprecationNotice=l,P.createAliasForDeprecatedMethod=h,I.init=u,I.addInitListener=function(e){I.initialized?e(I):M.push(e)};var k=[];I.addShimListener=function(e){k.push(e)},b&&(I.shim=I.createMissingNativeApi=g,h(I,"createMissingNativeApi","shim")),p.prototype={init:function(){for(var e,t,n=this.dependencies||[],r=0,o=n.length;o>r;++r){if(t=n[r],e=x[t],!(e&&e instanceof p))throw new Error("required module '"+t+"' not found");if(e.init(),!e.supported)throw new Error("required module '"+t+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error(e)},warn:function(e){I.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){I.warn("DEPRECATED: "+e+" in module "+this.name+" is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},I.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]);var r=m(e,n,t);I.initialized&&I.supported&&r.init()},I.createCoreModule=function(e,t,n){m(e,t,n)},I.RangePrototype=R,I.rangePrototype=new R,I.selectionPrototype=new v,I.createCoreModule("DomUtil",[],function(e,t){function n(e){var t;return typeof e.namespaceURI==b||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function r(e){var t=e.parentNode;return 1==t.nodeType?t:null}function o(e){for(var t=0;e=e.previousSibling;)++t;return t}function i(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function a(e,t){var n,r=[];for(n=e;n;n=n.parentNode)r.push(n);for(n=t;n;n=n.parentNode)if(M(r,n))return n;return null}function s(e,t,n){for(var r=n?t:t.parentNode;r;){if(r===e)return!0;r=r.parentNode}return!1}function c(e,t){return s(e,t,!0)}function d(e,t,n){for(var r,o=n?e:e.parentNode;o;){if(r=o.parentNode,r===t)return o;o=r}return null}function f(e){var t=e.nodeType;return 3==t||4==t||8==t}function u(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function l(e,t){var n=t.nextSibling,r=t.parentNode;return n?r.insertBefore(e,n):r.appendChild(e),e}function h(e,t,n){var r=e.cloneNode(!1);if(r.deleteData(0,t),e.deleteData(t,e.length-t),l(r,e),n)for(var i,a=0;i=n[a++];)i.node==e&&i.offset>t?(i.node=r,i.offset-=t):i.node==e.parentNode&&i.offset>o(e)&&++i.offset;return r}function g(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=b)return e.ownerDocument;if(typeof e.document!=b)return e.document;if(e.parentNode)return g(e.parentNode);throw t.createError("getDocument: no document found for node")}function p(e){var n=g(e);if(typeof n.defaultView!=b)return n.defaultView;if(typeof n.parentWindow!=b)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function m(e){if(typeof e.contentDocument!=b)return e.contentDocument;if(typeof e.contentWindow!=b)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function R(e){if(typeof e.contentWindow!=b)return e.contentWindow;if(typeof e.contentDocument!=b)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function v(e){return e&&P.isHostMethod(e,"setTimeout")&&P.isHostObject(e,"document")}function C(e,t,n){var r;if(e?P.isHostProperty(e,"nodeType")?r=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?m(e):g(e):v(e)&&(r=e.document):r=document,!r)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return r}function N(e){for(var t;t=e.parentNode;)e=t;return e}function E(e,n,r,i){var s,c,f,u,l;if(e==r)return n===i?0:i>n?-1:1;if(s=d(r,e,!0))return n<=o(s)?-1:1;if(s=d(e,r,!0))return o(s)<i?-1:1;if(c=a(e,r),!c)throw new Error("comparePoints error: nodes have no common ancestor");if(f=e===c?c:d(e,c,!0),u=r===c?c:d(r,c,!0),f===u)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(l=c.firstChild;l;){if(l===f)return-1;if(l===u)return 1;l=l.nextSibling}}function S(e){var t;try{return t=e.parentNode,!1}catch(n){return!0}}function y(e){if(!e)return"[No node]";if(k&&S(e))return"[Broken node]";if(f(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+o(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function w(e){for(var t,n=g(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n}function T(e,t,n){var r=I(e),o=e.createElement("div");o.contentEditable=""+!!n,t&&(o.innerHTML=t);var i=r.firstChild;return i?r.insertBefore(o,i):r.appendChild(o),o}function O(e){return e.parentNode.removeChild(e)}function _(e){this.root=e,this._next=e}function D(e){return new _(e)}function A(e,t){this.node=e,this.offset=t}function x(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var b="undefined",P=e.util,I=P.getBody;P.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),P.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var B=document.createElement("div");P.areHostMethods(B,["insertBefore","appendChild","cloneNode"]||!P.areHostObjects(B,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),P.isHostProperty(B,"innerHTML")||t.fail("Element is missing innerHTML property");var H=document.createTextNode("test");P.areHostMethods(H,["splitText","deleteData","insertData","appendData","cloneNode"]||!P.areHostObjects(B,["previousSibling","nextSibling","childNodes","parentNode"])||!P.areHostProperties(H,["data"]))||t.fail("Incomplete Text Node implementation");var M=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},k=!1;!function(){var t=document.createElement("b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br />",k=S(n),e.features.crashyTextNodes=k}();var L;typeof window.getComputedStyle!=b?L=function(e,t){return p(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=b?L=function(e,t){return e.currentStyle?e.currentStyle[t]:""}:t.fail("No means of obtaining computed style properties found"),_.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},A.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+y(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},x.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},x.prototype.toString=function(){return this.message},e.dom={arrayContains:M,isHtmlNamespace:n,parentElement:r,getNodeIndex:o,getNodeLength:i,getCommonAncestor:a,isAncestorOf:s,isOrIsAncestorOf:c,getClosestAncestorIn:d,isCharacterDataNode:f,isTextOrCommentNode:u,insertAfter:l,splitDataNode:h,getDocument:g,getWindow:p,getIframeWindow:R,getIframeDocument:m,getBody:I,isWindow:v,getContentDocument:C,getRootContainer:N,comparePoints:E,isBrokenNode:S,inspectNode:y,getComputedStyleProperty:L,createTestElement:T,removeNode:O,fragmentFromNodeChildren:w,createIterator:D,DomPosition:A},e.DOMException=x}),I.createCoreModule("DomRange",["DomUtil"],function(e){function t(e,t){return 3!=e.nodeType&&(F(e,t.startContainer)||F(e,t.endContainer))}function n(e){return e.document||j(e.startContainer)}function r(e){return Q(e.startContainer)}function o(e){return new M(e.parentNode,W(e))}function i(e){return new M(e.parentNode,W(e)+1)}function a(e,t,n){var r=11==e.nodeType?e.firstChild:e;return L(t)?n==t.length?B.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:U(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),r}function s(e,t,r){if(w(e),w(t),n(t)!=n(e))throw new k("WRONG_DOCUMENT_ERR");var o=z(e.startContainer,e.startOffset,t.endContainer,t.endOffset),i=z(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return r?0>=o&&i>=0:0>o&&i>0}function c(e){for(var t,r,o,i=n(e.range).createDocumentFragment();r=e.next();){if(t=e.isPartiallySelectedSubtree(),r=r.cloneNode(!t),t&&(o=e.getSubtreeIterator(),r.appendChild(c(o)),o.detach()),10==r.nodeType)throw new k("HIERARCHY_REQUEST_ERR");i.appendChild(r)}return i}function d(e,t,n){var r,o;n=n||{stop:!1};for(var i,a;i=e.next();)if(e.isPartiallySelectedSubtree()){if(t(i)===!1)return void(n.stop=!0);if(a=e.getSubtreeIterator(),d(a,t,n),a.detach(),n.stop)return}else for(r=B.createIterator(i);o=r.next();)if(t(o)===!1)return void(n.stop=!0)}function f(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),f(t),t.detach()):e.remove()}function u(e){for(var t,r,o=n(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),r=e.getSubtreeIterator(),t.appendChild(u(r)),r.detach()):e.remove(),10==t.nodeType)throw new k("HIERARCHY_REQUEST_ERR");o.appendChild(t)}return o}function l(e,t,n){var r,o=!(!t||!t.length),i=!!n;o&&(r=new RegExp("^("+t.join("|")+")$"));var a=[];return d(new g(e,!1),function(t){if(!(o&&!r.test(t.nodeType)||i&&!n(t))){var s=e.startContainer;if(t!=s||!L(s)||e.startOffset!=s.length){var c=e.endContainer;t==c&&L(c)&&0==e.endOffset||a.push(t)}}}),a}function h(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+B.inspectNode(e.startContainer)+":"+e.startOffset+", "+B.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function g(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&L(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||L(this.sc)?V(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||L(this.ec)?V(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function p(e){return function(t,n){for(var r,o=n?t:t.parentNode;o;){if(r=o.nodeType,Y(e,r))return o;o=o.parentNode}return null}}function m(e,t){if(rt(e,t))throw new k("INVALID_NODE_TYPE_ERR")}function R(e,t){if(!Y(t,e.nodeType))throw new k("INVALID_NODE_TYPE_ERR")}function v(e,t){if(0>t||t>(L(e)?e.length:e.childNodes.length))throw new k("INDEX_SIZE_ERR")}function C(e,t){if(tt(e,!0)!==tt(t,!0))throw new k("WRONG_DOCUMENT_ERR")}function N(e){if(nt(e,!0))throw new k("NO_MODIFICATION_ALLOWED_ERR")}function E(e,t){if(!e)throw new k(t)}function S(e,t){return t<=(L(e)?e.length:e.childNodes.length)}function y(e){return!!e.startContainer&&!!e.endContainer&&!(G&&(B.isBrokenNode(e.startContainer)||B.isBrokenNode(e.endContainer)))&&Q(e.startContainer)==Q(e.endContainer)&&S(e.startContainer,e.startOffset)&&S(e.endContainer,e.endOffset)}function w(e){if(!y(e))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+e.inspect()+")")}function T(e,t){w(e);var n=e.startContainer,r=e.startOffset,o=e.endContainer,i=e.endOffset,a=n===o;L(o)&&i>0&&i<o.length&&U(o,i,t),L(n)&&r>0&&r<n.length&&(n=U(n,r,t),a?(i-=r,o=n):o==n.parentNode&&i>=W(n)&&i++,r=0),e.setStartAndEnd(n,r,o,i)}function O(e){w(e);var t=e.commonAncestorContainer.parentNode.cloneNode(!1);return t.appendChild(e.cloneContents()),t.innerHTML}function _(e){e.START_TO_START=dt,e.START_TO_END=ft,e.END_TO_END=ut,e.END_TO_START=lt,e.NODE_BEFORE=ht,e.NODE_AFTER=gt,e.NODE_BEFORE_AND_AFTER=pt,e.NODE_INSIDE=mt}function D(e){_(e),_(e.prototype)}function A(e,t){return function(){w(this);var n,r,o=this.startContainer,a=this.startOffset,s=this.commonAncestorContainer,c=new g(this,!0);o!==s&&(n=V(o,s,!0),r=i(n),o=r.node,a=r.offset),d(c,N),c.reset();var f=e(c);return c.detach(),t(this,o,a,o,a),f}}function x(n,r){function a(e,t){return function(n){R(n,Z),R(Q(n),$);var r=(e?o:i)(n);(t?s:c)(this,r.node,r.offset)}}function s(e,t,n){var o=e.endContainer,i=e.endOffset;(t!==e.startContainer||n!==e.startOffset)&&((Q(t)!=Q(o)||1==z(t,n,o,i))&&(o=t,i=n),r(e,t,n,o,i))}function c(e,t,n){var o=e.startContainer,i=e.startOffset;(t!==e.endContainer||n!==e.endOffset)&&((Q(t)!=Q(o)||-1==z(t,n,o,i))&&(o=t,i=n),r(e,o,i,t,n))}var d=function(){};d.prototype=e.rangePrototype,n.prototype=new d,H.extend(n.prototype,{setStart:function(e,t){m(e,!0),v(e,t),s(this,e,t)},setEnd:function(e,t){m(e,!0),v(e,t),c(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],o=t,i=n;switch(e.length){case 3:i=e[2];break;case 4:o=e[2],i=e[3]}r(this,t,n,o,i)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:a(!0,!0),setStartAfter:a(!1,!0),setEndBefore:a(!0,!1),setEndAfter:a(!1,!1),collapse:function(e){w(this),e?r(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):r(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){m(e,!0),r(this,e,0,e,q(e))},selectNode:function(e){m(e,!1),R(e,Z);var t=o(e),n=i(e);r(this,t.node,t.offset,n.node,n.offset)},extractContents:A(u,r),deleteContents:A(f,r),canSurroundContents:function(){w(this),N(this.startContainer),N(this.endContainer);var e=new g(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},splitBoundaries:function(){T(this)},splitBoundariesPreservingPositions:function(e){T(this,e)},normalizeBoundaries:function(){w(this);var e,t=this.startContainer,n=this.startOffset,o=this.endContainer,i=this.endOffset,a=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(o=e,i=e.length,e.appendData(t.data),X(t))},s=function(e){var r=e.previousSibling;if(r&&r.nodeType==e.nodeType){t=e;var a=e.length;if(n=r.length,e.insertData(0,r.data),X(r),t==o)i+=n,o=t;else if(o==e.parentNode){var s=W(e);i==s?(o=e,i=a):i>s&&i--}}},c=!0;if(L(o))i==o.length?a(o):0==i&&(e=o.previousSibling,e&&e.nodeType==o.nodeType&&(i=e.length,t==o&&(c=!1),e.appendData(o.data),X(o),o=e));else{if(i>0){var d=o.childNodes[i-1];d&&L(d)&&a(d)}c=!this.collapsed}if(c){if(L(t))0==n?s(t):n==t.length&&(e=t.nextSibling,e&&e.nodeType==t.nodeType&&(o==e&&(o=t,i+=t.length),t.appendData(e.data),X(e)));else if(n<t.childNodes.length){var f=t.childNodes[n];f&&L(f)&&s(f)}}else t=o,n=i;r(this,t,n,o,i)},collapseToPoint:function(e,t){m(e,!0),v(e,t),this.setStartAndEnd(e,t)}}),D(n)}function b(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:B.getCommonAncestor(e.startContainer,e.endContainer)}function P(e,t,n,r,o){e.startContainer=t,e.startOffset=n,e.endContainer=r,e.endOffset=o,e.document=B.getDocument(t),b(e)}function I(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,b(this)}var B=e.dom,H=e.util,M=B.DomPosition,k=e.DOMException,L=B.isCharacterDataNode,W=B.getNodeIndex,F=B.isOrIsAncestorOf,j=B.getDocument,z=B.comparePoints,U=B.splitDataNode,V=B.getClosestAncestorIn,q=B.getNodeLength,Y=B.arrayContains,Q=B.getRootContainer,G=e.features.crashyTextNodes,X=B.removeNode;g.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,L(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!L(n)||n!==this.sc&&n!==this.ec?n.parentNode&&X(n):(e=n===this.sc?this.so:0,t=n===this.ec?this.eo:n.length,e!=t&&n.deleteData(e,t-e))},isPartiallySelectedSubtree:function(){var e=this._current;return t(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new I(n(this.range));var t=this._current,r=t,o=0,i=t,a=q(t);F(t,this.sc)&&(r=this.sc,o=this.so),F(t,this.ec)&&(i=this.ec,a=this.eo),P(e,r,o,i,a)}return new g(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var Z=[1,3,4,5,7,8,10],$=[2,9,11],J=[5,6,10,12],K=[1,3,4,5,7,8,10,11],et=[1,3,4,5,7,8],tt=p([9,11]),nt=p(J),rt=p([6,10,12]),ot=document.createElement("style"),it=!1;try{ot.innerHTML="<b>x</b>",it=3==ot.firstChild.nodeType}catch(at){}e.features.htmlParsingConforms=it;var st=it?function(e){var t=this.startContainer,n=j(t);if(!t)throw new k("INVALID_STATE_ERR");var r=null;return 1==t.nodeType?r=t:L(t)&&(r=B.parentElement(t)),r=null===r||"HTML"==r.nodeName&&B.isHtmlNamespace(j(r).documentElement)&&B.isHtmlNamespace(r)?n.createElement("body"):r.cloneNode(!1),r.innerHTML=e,B.fragmentFromNodeChildren(r)}:function(e){var t=n(this),r=t.createElement("body");return r.innerHTML=e,B.fragmentFromNodeChildren(r)},ct=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],dt=0,ft=1,ut=2,lt=3,ht=0,gt=1,pt=2,mt=3;H.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){w(this),C(this.startContainer,t.startContainer);var n,r,o,i,a=e==lt||e==dt?"start":"end",s=e==ft||e==dt?"start":"end";return n=this[a+"Container"],r=this[a+"Offset"],o=t[s+"Container"],i=t[s+"Offset"],z(n,r,o,i)},insertNode:function(e){if(w(this),R(e,K),N(this.startContainer),F(e,this.startContainer))throw new k("HIERARCHY_REQUEST_ERR");var t=a(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){w(this);var e,t;if(this.collapsed)return n(this).createDocumentFragment();if(this.startContainer===this.endContainer&&L(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=n(this).createDocumentFragment(),t.appendChild(e),t;var r=new g(this,!0);return e=c(r),r.detach(),e},canSurroundContents:function(){w(this),N(this.startContainer),N(this.endContainer);var e=new g(this,!0),n=e._first&&t(e._first,this)||e._last&&t(e._last,this);return e.detach(),!n},surroundContents:function(e){if(R(e,et),!this.canSurroundContents())throw new k("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);a(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){w(this);for(var e,t=new I(n(this)),r=ct.length;r--;)e=ct[r],t[e]=this[e];return t},toString:function(){w(this);var e=this.startContainer;if(e===this.endContainer&&L(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new g(this,!0);return d(n,function(e){(3==e.nodeType||4==e.nodeType)&&t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){w(this);var t=e.parentNode,n=W(e);if(!t)throw new k("NOT_FOUND_ERR");var r=this.comparePoint(t,n),o=this.comparePoint(t,n+1);return 0>r?o>0?pt:ht:o>0?gt:mt},comparePoint:function(e,t){return w(this),E(e,"HIERARCHY_REQUEST_ERR"),C(e,this.startContainer),z(e,t,this.startContainer,this.startOffset)<0?-1:z(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:st,toHtml:function(){return O(this)},intersectsNode:function(e,t){if(w(this),Q(e)!=r(this))return!1;var n=e.parentNode,o=W(e);if(!n)return!0;var i=z(n,o,this.endContainer,this.endOffset),a=z(n,o+1,this.startContainer,this.startOffset);return t?0>=i&&a>=0:0>i&&a>0},isPointInRange:function(e,t){return w(this),E(e,"HIERARCHY_REQUEST_ERR"),C(e,this.startContainer),z(e,t,this.startContainer,this.startOffset)>=0&&z(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return s(this,e,!1)},intersectsOrTouchesRange:function(e){return s(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=z(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=z(this.endContainer,this.endOffset,e.endContainer,e.endOffset),r=this.cloneRange();return-1==t&&r.setStart(e.startContainer,e.startOffset),1==n&&r.setEnd(e.endContainer,e.endOffset),r}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return-1==z(e.startContainer,e.startOffset,this.startContainer,this.startOffset)&&t.setStart(e.startContainer,e.startOffset),1==z(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new k("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==mt},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,q(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var r=n.pop();return t.setEnd(r,r.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return w(this),l(this,e,t)},getDocument:function(){return n(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){var r=n(this),o=e.createRange(r);t=t||B.getBody(r),o.selectNodeContents(t);var i=this.intersection(o),a=0,s=0;return i&&(o.setEnd(i.startContainer,i.startOffset),a=o.toString().length,s=a+i.toString().length),{start:a,end:s,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var r,o,i,a,s=[t],c=!1,d=!1;!d&&(r=s.pop());)if(3==r.nodeType)o=n+r.length,!c&&e.start>=n&&e.start<=o&&(this.setStart(r,e.start-n),c=!0),c&&e.end>=n&&e.end<=o&&(this.setEnd(r,e.end-n),d=!0),n=o;else for(a=r.childNodes,i=a.length;i--;)s.push(a[i])},getName:function(){return"DomRange"},equals:function(e){return I.rangesEqual(this,e)},isValid:function(){return y(this)},inspect:function(){return h(this)},detach:function(){}}),x(I,P),H.extend(I,{rangeProperties:ct,RangeIterator:g,copyComparisonConstants:D,createPrototypeRange:x,inspect:h,toHtml:O,getRangeDocument:n,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=I}),I.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,r,o=e.dom,i=e.util,a=o.DomPosition,s=e.DomRange,c=o.getBody,d=o.getContentDocument,f=o.isCharacterDataNode;if(e.features.implementsDomRange&&!function(){function r(e){for(var t,n=l.length;n--;)t=l[n],e[t]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function a(e,t,n,r,o){var i=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==r||e.endOffset!=o,s=!e.equals(e.nativeRange);(i||a||s)&&(e.setEnd(r,o),e.setStart(t,n))}var f,u,l=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,r(this)},s.createPrototypeRange(n,a),f=n.prototype,f.selectNode=function(e){this.nativeRange.selectNode(e),r(this)},f.cloneContents=function(){return this.nativeRange.cloneContents()},f.surroundContents=function(e){this.nativeRange.surroundContents(e),r(this)},f.collapse=function(e){this.nativeRange.collapse(e),r(this)},f.cloneRange=function(){return new n(this.nativeRange.cloneRange())},f.refresh=function(){r(this)},f.toString=function(){return this.nativeRange.toString()};var h=document.createTextNode("test");c(document).appendChild(h);var g=document.createRange();g.setStart(h,0),g.setEnd(h,0);try{g.setStart(h,1),f.setStart=function(e,t){this.nativeRange.setStart(e,t),r(this)},f.setEnd=function(e,t){this.nativeRange.setEnd(e,t),r(this)},u=function(e){return function(t){this.nativeRange[e](t),r(this)}}}catch(p){f.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}r(this)},f.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}r(this)},u=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(o){this.nativeRange[t](n),this.nativeRange[e](n)}r(this)}}}f.setStartBefore=u("setStartBefore","setEndBefore"),f.setStartAfter=u("setStartAfter","setEndAfter"),f.setEndBefore=u("setEndBefore","setStartBefore"),f.setEndAfter=u("setEndAfter","setStartAfter"),f.selectNodeContents=function(e){this.setStartAndEnd(e,0,o.getNodeLength(e))},g.selectNodeContents(h),g.setEnd(h,3);var m=document.createRange();m.selectNodeContents(h),m.setEnd(h,4),m.setStart(h,2),f.compareBoundaryPoints=-1==g.compareBoundaryPoints(g.START_TO_END,m)&&1==g.compareBoundaryPoints(g.END_TO_START,m)?function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var R=document.createElement("div");R.innerHTML="123";var v=R.firstChild,C=c(document);C.appendChild(R),g.setStart(v,1),g.setEnd(v,2),g.deleteContents(),"13"==v.data&&(f.deleteContents=function(){this.nativeRange.deleteContents(),r(this)},f.extractContents=function(){var e=this.nativeRange.extractContents();return r(this),e}),C.removeChild(R),C=null,i.isHostMethod(g,"createContextualFragment")&&(f.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),c(document).removeChild(h),f.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=d(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var u=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var r=n.parentElement();n=e.duplicate(),n.collapse(!1);var i=n.parentElement(),a=r==i?r:o.getCommonAncestor(r,i);return a==t?a:o.getCommonAncestor(t,a)},l=function(e){return 0==e.compareEndPoints("StartToEnd",e)},h=function(e,t,n,r,i){var s=e.duplicate();s.collapse(n);var c=s.parentElement();if(o.isOrIsAncestorOf(t,c)||(c=t),!c.canHaveHTML){var d=new a(c.parentNode,o.getNodeIndex(c));return{boundaryPosition:d,nodeInfo:{nodeIndex:d.offset,containerElement:d.node}}}var u=o.getDocument(c).createElement("span");u.parentNode&&o.removeNode(u);for(var l,h,g,p,m,R=n?"StartToStart":"StartToEnd",v=i&&i.containerElement==c?i.nodeIndex:0,C=c.childNodes.length,N=C,E=N;;){if(E==C?c.appendChild(u):c.insertBefore(u,c.childNodes[E]),s.moveToElementText(u),l=s.compareEndPoints(R,e),0==l||v==N)break;if(-1==l){if(N==v+1)break;v=E}else N=N==v+1?v:E;E=Math.floor((v+N)/2),c.removeChild(u)}if(m=u.nextSibling,-1==l&&m&&f(m)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var S;if(/[\r\n]/.test(m.data)){var y=s.duplicate(),w=y.text.replace(/\r\n/g,"\r").length;for(S=y.moveStart("character",w);-1==(l=y.compareEndPoints("StartToEnd",y));)S++,y.moveStart("character",1)}else S=s.text.length;p=new a(m,S)}else h=(r||!n)&&u.previousSibling,g=(r||n)&&u.nextSibling,p=g&&f(g)?new a(g,0):h&&f(h)?new a(h,h.data.length):new a(c,o.getNodeIndex(u));return o.removeNode(u),{boundaryPosition:p,nodeInfo:{nodeIndex:E,containerElement:c}}},g=function(e,t){var n,r,i,a,s=e.offset,d=o.getDocument(e.node),u=c(d).createTextRange(),l=f(e.node);return l?(n=e.node,r=n.parentNode):(a=e.node.childNodes,n=s<a.length?a[s]:null,r=e.node),i=d.createElement("span"),i.innerHTML="&#feff;",n?r.insertBefore(i,n):r.appendChild(i),u.moveToElementText(i),u.collapse(!t),r.removeChild(i),l&&u[t?"moveStart":"moveEnd"]("character",s),u};r=function(e){this.textRange=e,this.refresh()},r.prototype=new s(document),r.prototype.refresh=function(){var e,t,n,r=u(this.textRange);
+l(this.textRange)?t=e=h(this.textRange,r,!0,!0).boundaryPosition:(n=h(this.textRange,r,!0,!1),e=n.boundaryPosition,t=h(this.textRange,r,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},r.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(r);var p=function(e){if(e.collapsed)return g(new a(e.startContainer,e.startOffset),!0);var t=g(new a(e.startContainer,e.startOffset),!0),n=g(new a(e.endContainer,e.endOffset),!1),r=c(s.getRangeDocument(e)).createTextRange();return r.setEndPoint("StartToStart",t),r.setEndPoint("EndToEnd",n),r};if(r.rangeToTextRange=p,r.prototype.toTextRange=function(){return p(this)},e.WrappedTextRange=r,!e.features.implementsDomRange||e.config.preferTextRange){var m=function(e){return e("return this;")()}(Function);"undefined"==typeof m.Range&&(m.Range=r),e.createNativeRange=function(e){return e=d(e,t,"createNativeRange"),c(e).createTextRange()},e.WrappedRange=r}}e.createRange=function(n){return n=d(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=d(e,t,"createRangyRange"),new s(e)},i.createAliasForDeprecatedMethod(e,"createIframeRange","createRange"),i.createAliasForDeprecatedMethod(e,"createIframeRangyRange","createRangyRange"),e.addShimListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),I.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function n(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function r(e,n){if(e){if(D.isWindow(e))return e;if(e instanceof R)return e.win;var r=D.getContentDocument(e,t,n);return D.getWindow(r)}return window}function o(e){return r(e,"getWinSelection").getSelection()}function i(e){return r(e,"getDocSelection").document.selection}function a(e){var t=!1;return e.anchorNode&&(t=1==D.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function s(e,t,n){var r=n?"end":"start",o=n?"start":"end";e.anchorNode=t[r+"Container"],e.anchorOffset=t[r+"Offset"],e.focusNode=t[o+"Container"],e.focusOffset=t[o+"Offset"]}function c(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function d(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function f(t){var n;return t instanceof b?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof P?n=t.nativeRange:H.implementsDomRange&&t instanceof D.getWindow(t.startContainer).Range&&(n=t),n}function u(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;n>t;++t)if(!D.isAncestorOf(e[0],e[t]))return!1;return!0}function l(e){var n=e.getNodes();if(!u(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function h(e){return!!e&&"undefined"!=typeof e.text}function g(e,t){var n=new P(t);e._ranges=[n],s(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function p(t){if(t._ranges.length=0,"None"==t.docSelection.type)d(t);else{var n=t.docSelection.createRange();if(h(n))g(t,n);else{t.rangeCount=n.length;for(var r,o=k(n.item(0)),i=0;i<t.rangeCount;++i)r=e.createRange(o),r.selectNode(n.item(i)),t._ranges.push(r);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,s(t,t._ranges[t.rangeCount-1],!1)}}}function m(e,n){for(var r=e.docSelection.createRange(),o=l(n),i=k(r.item(0)),a=L(i).createControlRange(),s=0,c=r.length;c>s;++s)a.add(r.item(s));try{a.add(o)}catch(d){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}a.select(),p(e)}function R(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function v(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function C(e,t){for(var n,r,o=tt.length;o--;)if(n=tt[o],r=n.selection,"deleteAll"==t)v(r);else if(n.win==e)return"delete"==t?(tt.splice(o,1),!0):r;return"deleteAll"==t&&(tt.length=0),null}function N(e,n){for(var r,o=k(n[0].startContainer),i=L(o).createControlRange(),a=0,s=n.length;s>a;++a){r=l(n[a]);try{i.add(r)}catch(c){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}i.select(),p(e)}function E(e,t){if(e.win.document!=k(t))throw new I("WRONG_DOCUMENT_ERR")}function S(t){return function(n,r){var o;this.rangeCount?(o=this.getRangeAt(0),o["set"+(t?"Start":"End")](n,r)):(o=e.createRange(this.win.document),o.setStartAndEnd(n,r)),this.setSingleRange(o,this.isBackward())}}function y(e){var t=[],n=new B(e.anchorNode,e.anchorOffset),r=new B(e.focusNode,e.focusOffset),o="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var i=0,a=e.rangeCount;a>i;++i)t[i]=b.inspect(e.getRangeAt(i));return"["+o+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+r.inspect()+"]"}e.config.checkSelectionRanges=!0;var w,T,O="boolean",_="number",D=e.dom,A=e.util,x=A.isHostMethod,b=e.DomRange,P=e.WrappedRange,I=e.DOMException,B=D.DomPosition,H=e.features,M="Control",k=D.getDocument,L=D.getBody,W=b.rangesEqual,F=x(window,"getSelection"),j=A.isHostObject(document,"selection");H.implementsWinGetSelection=F,H.implementsDocSelection=j;var z=j&&(!F||e.config.preferTextRange);if(z)w=i,e.isSelectionValid=function(e){var t=r(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||k(n.createRange().parentElement())==t};else{if(!F)return t.fail("Neither document.selection or window.getSelection() detected."),!1;w=o,e.isSelectionValid=function(){return!0}}e.getNativeSelection=w;var U=w();if(!U)return t.fail("Native selection was null (possibly issue 138?)"),!1;var V=e.createNativeRange(document),q=L(document),Y=A.areHostProperties(U,["anchorNode","focusNode","anchorOffset","focusOffset"]);H.selectionHasAnchorAndFocus=Y;var Q=x(U,"extend");H.selectionHasExtend=Q;var G=typeof U.rangeCount==_;H.selectionHasRangeCount=G;var X=!1,Z=!0,$=Q?function(t,n){var r=b.getRangeDocument(n),o=e.createRange(r);o.collapseToPoint(n.endContainer,n.endOffset),t.addRange(f(o)),t.extend(n.startContainer,n.startOffset)}:null;A.areHostMethods(U,["addRange","getRangeAt","removeAllRanges"])&&typeof U.rangeCount==_&&H.implementsDomRange&&!function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,r=n>1,o=[],i=a(t),s=0;n>s;++s)o[s]=t.getRangeAt(s);var c=D.createTestElement(document,"",!1),d=c.appendChild(document.createTextNode("")),f=document.createRange();if(f.setStart(d,1),f.collapse(!0),t.removeAllRanges(),t.addRange(f),Z=1==t.rangeCount,t.removeAllRanges(),!r){var u=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(u&&parseInt(u[1])>=36)X=!1;else{var l=f.cloneRange();f.setStart(d,0),l.setEnd(d,3),l.setStart(d,2),t.addRange(f),t.addRange(l),X=2==t.rangeCount}}for(D.removeNode(c),t.removeAllRanges(),s=0;n>s;++s)0==s&&i?$?$(t,o[s]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(o[s])):t.addRange(o[s])}}(),H.selectionSupportsMultipleRanges=X,H.collapsedNonEditableSelectionsSupported=Z;var J,K=!1;q&&x(q,"createControlRange")&&(J=q.createControlRange(),A.areHostProperties(J,["item","add"])&&(K=!0)),H.implementsControlRange=K,T=Y?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return e.rangeCount?e.getRangeAt(e.rangeCount-1).collapsed:!1};var et;x(U,"getRangeAt")?et=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:Y&&(et=function(t){var n=k(t.anchorNode),r=e.createRange(n);return r.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),r.collapsed!==this.isCollapsed&&r.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),r}),R.prototype=e.selectionPrototype;var tt=[],nt=function(e){if(e&&e instanceof R)return e.refresh(),e;e=r(e,"getNativeSelection");var t=C(e),n=w(e),o=j?i(e):null;return t?(t.nativeSelection=n,t.docSelection=o,t.refresh()):(t=new R(n,o,e),tt.push({win:e,selection:t})),t};e.getSelection=nt,A.createAliasForDeprecatedMethod(e,"getIframeSelection","getSelection");var rt=R.prototype;if(!z&&Y&&A.areHostMethods(U,["removeAllRanges","addRange"])){rt.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),d(this)};var ot=function(e,t){$(e.nativeSelection,t),e.refresh()};rt.addRange=G?function(t,r){if(K&&j&&this.docSelection.type==M)m(this,t);else if(n(r)&&Q)ot(this,t);else{var o;X?o=this.rangeCount:(this.removeAllRanges(),o=0);var i=f(t).cloneRange();try{this.nativeSelection.addRange(i)}catch(a){}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==o+1){if(e.config.checkSelectionRanges){var c=et(this.nativeSelection,this.rangeCount-1);c&&!W(c,t)&&(t=new P(c))}this._ranges[this.rangeCount-1]=t,s(this,t,st(this.nativeSelection)),this.isCollapsed=T(this)}else this.refresh()}}:function(e,t){n(t)&&Q?ot(this,e):(this.nativeSelection.addRange(f(e)),this.refresh())},rt.setRanges=function(e){if(K&&j&&e.length>1)N(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;n>t;++t)this.addRange(e[t])}}}else{if(!(x(U,"empty")&&x(V,"select")&&K&&z))return t.fail("No means of selecting a Range or TextRange was found"),!1;rt.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=k(this.anchorNode);else if(this.docSelection.type==M){var t=this.docSelection.createRange();t.length&&(e=k(t.item(0)))}if(e){var n=L(e).createTextRange();n.select(),this.docSelection.empty()}}}catch(r){}d(this)},rt.addRange=function(t){this.docSelection.type==M?m(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,s(this,t,!1))},rt.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?N(this,e):t&&this.addRange(e[0])}}rt.getRangeAt=function(e){if(0>e||e>=this.rangeCount)throw new I("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var it;if(z)it=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=L(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==M?p(t):h(n)?g(t,n):d(t)};else if(x(U,"getRangeAt")&&typeof U.rangeCount==_)it=function(t){if(K&&j&&t.docSelection.type==M)p(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,r=t.rangeCount;r>n;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));s(t,t._ranges[t.rangeCount-1],st(t.nativeSelection)),t.isCollapsed=T(t)}else d(t)};else{if(!Y||typeof U.isCollapsed!=O||typeof V.collapsed!=O||!H.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;it=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=et(n,0),e._ranges=[t],e.rangeCount=1,c(e),e.isCollapsed=T(e)):d(e)}}rt.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,r=this.anchorOffset;if(it(this),e){var o=t.length;if(o!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=r)return!0;for(;o--;)if(!W(t[o],this._ranges[o]))return!0;return!1}};var at=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var r=0,o=n.length;o>r;++r)W(t,n[r])||e.addRange(n[r]);e.rangeCount||d(e)};rt.removeRange=K&&j?function(e){if(this.docSelection.type==M){for(var t,n=this.docSelection.createRange(),r=l(e),o=k(n.item(0)),i=L(o).createControlRange(),a=!1,s=0,c=n.length;c>s;++s)t=n.item(s),t!==r||a?i.add(n.item(s)):a=!0;i.select(),p(this)}else at(this,e)}:function(e){at(this,e)};var st;!z&&Y&&H.implementsDomRange?(st=a,rt.isBackward=function(){return st(this)}):st=rt.isBackward=function(){return!1},rt.isBackwards=rt.isBackward,rt.toString=function(){for(var e=[],t=0,n=this.rangeCount;n>t;++t)e[t]=""+this._ranges[t];return e.join("")},rt.collapse=function(t,n){E(this,t);var r=e.createRange(t);r.collapseToPoint(t,n),this.setSingleRange(r),this.isCollapsed=!0},rt.collapseToStart=function(){if(!this.rangeCount)throw new I("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},rt.collapseToEnd=function(){if(!this.rangeCount)throw new I("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},rt.selectAllChildren=function(t){E(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},rt.deleteFromDocument=function(){if(K&&j&&this.docSelection.type==M){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),D.removeNode(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var r=0,o=n.length;o>r;++r)n[r].deleteContents();this.addRange(n[o-1])}}},rt.eachRange=function(e,t){for(var n=0,r=this._ranges.length;r>n;++n)if(e(this.getRangeAt(n)))return t},rt.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},rt.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},rt.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(r){n.push(r[e].apply(r,t||[]))}),n},rt.setStart=S(!0),rt.setEnd=S(!1),e.rangePrototype.select=function(e){nt(this.getDocument()).setSingleRange(this,e)},rt.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},rt.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)||!1},rt.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},rt.moveToBookmark=function(t){for(var n,r,o=[],i=0;n=t.rangeBookmarks[i++];)r=e.createRange(this.win),r.moveToBookmark(n),o.push(r);t.backward?this.setSingleRange(o[0],"backward"):this.setRanges(o)},rt.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},rt.restoreRanges=function(e){this.removeAllRanges();for(var t,n=0;t=e.ranges[n];++n)this.addRange(t,e.backward&&0==n)},rt.toHtml=function(){var e=[];return this.eachRange(function(t){e.push(b.toHtml(t))}),e.join("")},H.implementsTextRange&&(rt.getNativeTextRange=function(){var n;if(n=this.docSelection){var r=n.createRange();if(h(r))return r;throw t.createError("getNativeTextRange: selection is a control selection")}if(this.rangeCount>0)return e.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw t.createError("getNativeTextRange: selection contains no range")}),rt.getName=function(){return"WrappedSelection"},rt.inspect=function(){return y(this)},rt.detach=function(){C(this.win,"delete"),v(this)},R.detachAll=function(){C(null,"deleteAll")},R.inspect=y,R.isDirectionBackward=n,e.Selection=R,e.selectionPrototype=rt,e.addShimListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return nt(e)}),e=null})});var L=!1,W=function(){L||(L=!0,!I.initialized&&I.config.autoInitialize&&u())};return b&&("complete"==document.readyState?W():(e(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",W,!1),H(window,"load",W))),I},this);
\ No newline at end of file
diff --git a/libs/editor-common/assets/rangy-cssclassapplier.js b/libs/editor-common/assets/rangy-cssclassapplier.js
new file mode 100644
index 000000000000..60064a334a0d
--- /dev/null
+++ b/libs/editor-common/assets/rangy-cssclassapplier.js
@@ -0,0 +1,32 @@
+/*
+ CSS Class Applier module for Rangy.
+ Adds, removes and toggles CSS classes on Ranges and Selections
+
+ Part of Rangy, a cross-browser JavaScript range and selection library
+ http://code.google.com/p/rangy/
+
+ Depends on Rangy core.
+
+ Copyright 2012, Tim Down
+ Licensed under the MIT license.
+ Version: 1.2.3
+ Build date: 26 February 2012
+*/
+rangy.createModule("CssClassApplier",function(i,v){function r(a,b){return a.className&&RegExp("(?:^|\\s)"+b+"(?:\\s|$)").test(a.className)}function s(a,b){if(a.className)r(a,b)||(a.className+=" "+b);else a.className=b}function o(a){return a.split(/\s+/).sort().join(" ")}function w(a,b){return o(a.className)==o(b.className)}function x(a){for(var b=a.parentNode;a.hasChildNodes();)b.insertBefore(a.firstChild,a);b.removeChild(a)}function y(a,b){var c=a.cloneRange();c.selectNodeContents(b);var d=c.intersection(a);
+d=d?d.toString():"";c.detach();return d!=""}function z(a){return a.getNodes([3],function(b){return y(a,b)})}function A(a,b){if(a.attributes.length!=b.attributes.length)return false;for(var c=0,d=a.attributes.length,e,f;c<d;++c){e=a.attributes[c];f=e.name;if(f!="class"){f=b.attributes.getNamedItem(f);if(e.specified!=f.specified)return false;if(e.specified&&e.nodeValue!==f.nodeValue)return false}}return true}function B(a,b){for(var c=0,d=a.attributes.length,e;c<d;++c){e=a.attributes[c].name;if(!(b&&
+h.arrayContains(b,e))&&a.attributes[c].specified&&e!="class")return true}return false}function C(a){var b;return a&&a.nodeType==1&&((b=a.parentNode)&&b.nodeType==9&&b.designMode=="on"||k(a)&&!k(a.parentNode))}function D(a){return(k(a)||a.nodeType!=1&&k(a.parentNode))&&!C(a)}function E(a){return a&&a.nodeType==1&&!M.test(p(a,"display"))}function N(a){if(a.data.length==0)return true;if(O.test(a.data))return false;switch(p(a.parentNode,"whiteSpace")){case "pre":case "pre-wrap":case "-moz-pre-wrap":return false;
+case "pre-line":if(/[\r\n]/.test(a.data))return false}return E(a.previousSibling)||E(a.nextSibling)}function m(a,b,c,d){var e,f=c==0;if(h.isAncestorOf(b,a))return a;if(h.isCharacterDataNode(b))if(c==0){c=h.getNodeIndex(b);b=b.parentNode}else if(c==b.length){c=h.getNodeIndex(b)+1;b=b.parentNode}else throw v.createError("splitNodeAt should not be called with offset in the middle of a data node ("+c+" in "+b.data);var g;g=b;var j=c;g=h.isCharacterDataNode(g)?j==0?!!g.previousSibling:j==g.length?!!g.nextSibling:
+true:j>0&&j<g.childNodes.length;if(g){if(!e){e=b.cloneNode(false);for(e.id&&e.removeAttribute("id");f=b.childNodes[c];)e.appendChild(f);h.insertAfter(e,b)}return b==a?e:m(a,e.parentNode,h.getNodeIndex(e),d)}else if(a!=b){e=b.parentNode;b=h.getNodeIndex(b);f||b++;return m(a,e,b,d)}return a}function F(a){var b=a?"nextSibling":"previousSibling";return function(c,d){var e=c.parentNode,f=c[b];if(f){if(f&&f.nodeType==3)return f}else if(d)if((f=e[b])&&f.nodeType==1&&e.tagName==f.tagName&&w(e,f)&&A(e,f))return f[a?
+"firstChild":"lastChild"];return null}}function t(a){this.firstTextNode=(this.isElementMerge=a.nodeType==1)?a.lastChild:a;this.textNodes=[this.firstTextNode]}function q(a,b,c){this.cssClass=a;var d,e,f=null;if(typeof b=="object"&&b!==null){c=b.tagNames;f=b.elementProperties;for(d=0;e=P[d++];)if(b.hasOwnProperty(e))this[e]=b[e];d=b.normalize}else d=b;this.normalize=typeof d=="undefined"?true:d;this.attrExceptions=[];d=document.createElement(this.elementTagName);this.elementProperties={};for(var g in f)if(f.hasOwnProperty(g)){if(G.hasOwnProperty(g))g=
+G[g];d[g]=f[g];this.elementProperties[g]=d[g];this.attrExceptions.push(g)}this.elementSortedClassName=this.elementProperties.hasOwnProperty("className")?o(this.elementProperties.className+" "+a):a;this.applyToAnyTagName=false;a=typeof c;if(a=="string")if(c=="*")this.applyToAnyTagName=true;else this.tagNames=c.toLowerCase().replace(/^\s\s*/,"").replace(/\s\s*$/,"").split(/\s*,\s*/);else if(a=="object"&&typeof c.length=="number"){this.tagNames=[];d=0;for(a=c.length;d<a;++d)if(c[d]=="*")this.applyToAnyTagName=
+true;else this.tagNames.push(c[d].toLowerCase())}else this.tagNames=[this.elementTagName]}i.requireModules(["WrappedSelection","WrappedRange"]);var h=i.dom,H=function(){function a(b,c,d){return c&&d?" ":""}return function(b,c){if(b.className)b.className=b.className.replace(RegExp("(?:^|\\s)"+c+"(?:\\s|$)"),a)}}(),p;if(typeof window.getComputedStyle!="undefined")p=function(a,b){return h.getWindow(a).getComputedStyle(a,null)[b]};else if(typeof document.documentElement.currentStyle!="undefined")p=function(a,
+b){return a.currentStyle[b]};else v.fail("No means of obtaining computed style properties found");var k;(function(){k=typeof document.createElement("div").isContentEditable=="boolean"?function(a){return a&&a.nodeType==1&&a.isContentEditable}:function(a){if(!a||a.nodeType!=1||a.contentEditable=="false")return false;return a.contentEditable=="true"||k(a.parentNode)}})();var M=/^inline(-block|-table)?$/i,O=/[^\r\n\t\f \u200B]/,Q=F(false),R=F(true);t.prototype={doMerge:function(){for(var a=[],b,c,d=0,
+e=this.textNodes.length;d<e;++d){b=this.textNodes[d];c=b.parentNode;a[d]=b.data;if(d){c.removeChild(b);c.hasChildNodes()||c.parentNode.removeChild(c)}}return this.firstTextNode.data=a=a.join("")},getLength:function(){for(var a=this.textNodes.length,b=0;a--;)b+=this.textNodes[a].length;return b},toString:function(){for(var a=[],b=0,c=this.textNodes.length;b<c;++b)a[b]="'"+this.textNodes[b].data+"'";return"[Merge("+a.join(",")+")]"}};var P=["elementTagName","ignoreWhiteSpace","applyToEditableOnly"],
+G={"class":"className"};q.prototype={elementTagName:"span",elementProperties:{},ignoreWhiteSpace:true,applyToEditableOnly:false,hasClass:function(a){return a.nodeType==1&&h.arrayContains(this.tagNames,a.tagName.toLowerCase())&&r(a,this.cssClass)},getSelfOrAncestorWithClass:function(a){for(;a;){if(this.hasClass(a,this.cssClass))return a;a=a.parentNode}return null},isModifiable:function(a){return!this.applyToEditableOnly||D(a)},isIgnorableWhiteSpaceNode:function(a){return this.ignoreWhiteSpace&&a&&
+a.nodeType==3&&N(a)},postApply:function(a,b,c){for(var d=a[0],e=a[a.length-1],f=[],g,j=d,I=e,J=0,K=e.length,n,L,l=0,u=a.length;l<u;++l){n=a[l];if(L=Q(n,!c)){if(!g){g=new t(L);f.push(g)}g.textNodes.push(n);if(n===d){j=g.firstTextNode;J=j.length}if(n===e){I=g.firstTextNode;K=g.getLength()}}else g=null}if(a=R(e,!c)){if(!g){g=new t(e);f.push(g)}g.textNodes.push(a)}if(f.length){l=0;for(u=f.length;l<u;++l)f[l].doMerge();b.setStart(j,J);b.setEnd(I,K)}},createContainer:function(a){a=a.createElement(this.elementTagName);
+i.util.extend(a,this.elementProperties);s(a,this.cssClass);return a},applyToTextNode:function(a){var b=a.parentNode;if(b.childNodes.length==1&&h.arrayContains(this.tagNames,b.tagName.toLowerCase()))s(b,this.cssClass);else{b=this.createContainer(h.getDocument(a));a.parentNode.insertBefore(b,a);b.appendChild(a)}},isRemovable:function(a){var b;if(b=a.tagName.toLowerCase()==this.elementTagName){if(b=o(a.className)==this.elementSortedClassName){var c;a:{b=this.elementProperties;for(c in b)if(b.hasOwnProperty(c)&&
+a[c]!==b[c]){c=false;break a}c=true}b=c&&!B(a,this.attrExceptions)&&this.isModifiable(a)}b=b}return b},undoToTextNode:function(a,b,c){if(!b.containsNode(c)){a=b.cloneRange();a.selectNode(c);if(a.isPointInRange(b.endContainer,b.endOffset)){m(c,b.endContainer,b.endOffset,[b]);b.setEndAfter(c)}if(a.isPointInRange(b.startContainer,b.startOffset))c=m(c,b.startContainer,b.startOffset,[b])}this.isRemovable(c)?x(c):H(c,this.cssClass)},applyToRange:function(a){a.splitBoundaries();var b=z(a);if(b.length){for(var c,
+d=0,e=b.length;d<e;++d){c=b[d];!this.isIgnorableWhiteSpaceNode(c)&&!this.getSelfOrAncestorWithClass(c)&&this.isModifiable(c)&&this.applyToTextNode(c)}a.setStart(b[0],0);c=b[b.length-1];a.setEnd(c,c.length);this.normalize&&this.postApply(b,a,false)}},applyToSelection:function(a){a=a||window;a=i.getSelection(a);var b,c=a.getAllRanges();a.removeAllRanges();for(var d=c.length;d--;){b=c[d];this.applyToRange(b);a.addRange(b)}},undoToRange:function(a){a.splitBoundaries();var b=z(a),c,d,e=b[b.length-1];if(b.length){for(var f=
+0,g=b.length;f<g;++f){c=b[f];(d=this.getSelfOrAncestorWithClass(c))&&this.isModifiable(c)&&this.undoToTextNode(c,a,d);a.setStart(b[0],0);a.setEnd(e,e.length)}this.normalize&&this.postApply(b,a,true)}},undoToSelection:function(a){a=a||window;a=i.getSelection(a);var b=a.getAllRanges(),c;a.removeAllRanges();for(var d=0,e=b.length;d<e;++d){c=b[d];this.undoToRange(c);a.addRange(c)}},getTextSelectedByRange:function(a,b){var c=b.cloneRange();c.selectNodeContents(a);var d=c.intersection(b);d=d?d.toString():
+"";c.detach();return d},isAppliedToRange:function(a){if(a.collapsed)return!!this.getSelfOrAncestorWithClass(a.commonAncestorContainer);else{for(var b=a.getNodes([3]),c=0,d;d=b[c++];)if(!this.isIgnorableWhiteSpaceNode(d)&&y(a,d)&&this.isModifiable(d)&&!this.getSelfOrAncestorWithClass(d))return false;return true}},isAppliedToSelection:function(a){a=a||window;a=i.getSelection(a).getAllRanges();for(var b=a.length;b--;)if(!this.isAppliedToRange(a[b]))return false;return true},toggleRange:function(a){this.isAppliedToRange(a)?
+this.undoToRange(a):this.applyToRange(a)},toggleSelection:function(a){this.isAppliedToSelection(a)?this.undoToSelection(a):this.applyToSelection(a)},detach:function(){}};q.util={hasClass:r,addClass:s,removeClass:H,hasSameClasses:w,replaceWithOwnChildren:x,elementsHaveSameNonClassAttributes:A,elementHasNonClassAttributes:B,splitNodeAt:m,isEditableElement:k,isEditingHost:C,isEditable:D};i.CssClassApplier=q;i.createCssClassApplier=function(a,b,c){return new q(a,b,c)}});
\ No newline at end of file
diff --git a/libs/editor-common/assets/rangy-highlighter.js b/libs/editor-common/assets/rangy-highlighter.js
new file mode 100755
index 000000000000..b2dbb79db9ee
--- /dev/null
+++ b/libs/editor-common/assets/rangy-highlighter.js
@@ -0,0 +1,12 @@
+/**
+ * Highlighter module for Rangy, a cross-browser JavaScript range and selection library
+ * https://github.com/timdown/rangy
+ *
+ * Depends on Rangy core, ClassApplier and optionally TextRange modules.
+ *
+ * Copyright 2015, Tim Down
+ * Licensed under the MIT license.
+ * Version: 1.3.0
+ * Build date: 10 May 2015
+ */
+!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("Highlighter",["ClassApplier"],function(e){function t(e,t){return e.characterRange.start-t.characterRange.start}function n(e,t){return t?e.getElementById(t):l(e)}function r(e,t){this.type=e,this.converterCreator=t}function i(e,t){f[e]=new r(e,t)}function a(e){var t=f[e];if(t instanceof r)return t.create();throw new Error("Highlighter type '"+e+"' is not valid")}function s(e,t){this.start=e,this.end=t}function h(e,t,n,r,i,a){i?(this.id=i,d=Math.max(d,i+1)):this.id=d++,this.characterRange=t,this.doc=e,this.classApplier=n,this.converter=r,this.containerElementId=a||null,this.applied=!1}function o(e,t){t=t||"textContent",this.doc=e||document,this.classAppliers={},this.highlights=[],this.converter=a(t)}var c=e.dom,g=c.arrayContains,l=c.getBody,u=e.util.createOptions,p=e.util.forEach,d=1,f={};r.prototype.create=function(){var e=this.converterCreator();return e.type=this.type,e},e.registerHighlighterType=i,s.prototype={intersects:function(e){return this.start<e.end&&this.end>e.start},isContiguousWith:function(e){return this.start==e.end||this.end==e.start},union:function(e){return new s(Math.min(this.start,e.start),Math.max(this.end,e.end))},intersection:function(e){return new s(Math.max(this.start,e.start),Math.min(this.end,e.end))},getComplements:function(e){var t=[];if(this.start>=e.start){if(this.end<=e.end)return[];t.push(new s(e.end,this.end))}else t.push(new s(this.start,Math.min(this.end,e.start))),this.end>e.end&&t.push(new s(e.end,this.end));return t},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},s.fromCharacterRange=function(e){return new s(e.start,e.end)};var R={rangeToCharacterRange:function(e,t){var n=e.getBookmark(t);return new s(n.start,n.end)},characterRangeToRange:function(t,n,r){var i=e.createRange(t);return i.moveToBookmark({start:n.start,end:n.end,containerNode:r}),i},serializeSelection:function(e,t){for(var n=e.getAllRanges(),r=n.length,i=[],a=1==r&&e.isBackward(),s=0,h=n.length;h>s;++s)i[s]={characterRange:this.rangeToCharacterRange(n[s],t),backward:a};return i},restoreSelection:function(e,t,n){e.removeAllRanges();for(var r,i,a,s=e.win.document,h=0,o=t.length;o>h;++h)i=t[h],a=i.characterRange,r=this.characterRangeToRange(s,i.characterRange,n),e.addRange(r,i.backward)}};i("textContent",function(){return R}),i("TextRange",function(){var t;return function(){if(!t){var n=e.modules.TextRange;if(!n)throw new Error("TextRange module is missing.");if(!n.supported)throw new Error("TextRange module is present but not supported.");t={rangeToCharacterRange:function(e,t){return s.fromCharacterRange(e.toCharacterRange(t))},characterRangeToRange:function(t,n,r){var i=e.createRange(t);return i.selectCharacters(r,n.start,n.end),i},serializeSelection:function(e,t){return e.saveCharacterRanges(t)},restoreSelection:function(e,t,n){e.restoreCharacterRanges(n,t)}}}return t}}()),h.prototype={getContainerElement:function(){return n(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(e){this.characterRange=this.converter.rangeToCharacterRange(e,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(e){return this.getRange().containsNodeContents(e.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},o.prototype={addClassApplier:function(e){this.classAppliers[e.className]=e},getHighlightForElement:function(e){for(var t=this.highlights,n=0,r=t.length;r>n;++n)if(t[n].containsElement(e))return t[n];return null},removeHighlights:function(e){for(var t,n=0,r=this.highlights.length;r>n;++n)t=this.highlights[n],g(e,t)&&(t.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(e){var t=[],n=this.highlights;return p(e,function(e){p(n,function(n){e.intersectsRange(n.getRange())&&!g(t,n)&&t.push(n)})}),t},highlightCharacterRanges:function(t,n,r){var i,a,o,c=this.highlights,g=this.converter,l=this.doc,d=[],f=t?this.classAppliers[t]:null;r=u(r,{containerElementId:null,exclusive:!0});var R,v,m,C=r.containerElementId,w=r.exclusive;C&&(R=this.doc.getElementById(C),R&&(v=e.createRange(this.doc),v.selectNodeContents(R),m=new s(0,v.toString().length)));var y,E,T,x,A,H;for(i=0,a=n.length;a>i;++i)if(y=n[i],A=[],m&&(y=y.intersection(m)),y.start!=y.end){for(o=0;o<c.length;++o)T=!1,C==c[o].containerElementId&&(E=c[o].characterRange,x=f==c[o].classApplier,H=!x&&w,(E.intersects(y)||E.isContiguousWith(y))&&(x||H)&&(H&&p(E.getComplements(y),function(e){A.push(new h(l,e,c[o].classApplier,g,null,C))}),T=!0,x&&(y=E.union(y)))),T?(d.push(c[o]),c[o]=new h(l,E.union(y),f,g,null,C)):A.push(c[o]);f&&A.push(new h(l,y,f,g,null,C)),this.highlights=c=A}p(d,function(e){e.unapply()});var I=[];return p(c,function(e){e.applied||(e.apply(),I.push(e))}),I},highlightRanges:function(t,n,r){var i=[],a=this.converter;r=u(r,{containerElement:null,exclusive:!0});var s,h=r.containerElement,o=h?h.id:null;return h&&(s=e.createRange(h),s.selectNodeContents(h)),p(n,function(e){var t=h?s.intersection(e):e;i.push(a.rangeToCharacterRange(t,h||l(e.getDocument())))}),this.highlightCharacterRanges(t,i,{containerElementId:o,exclusive:r.exclusive})},highlightSelection:function(t,r){var i=this.converter,a=t?this.classAppliers[t]:!1;r=u(r,{containerElementId:null,selection:e.getSelection(this.doc),exclusive:!0});var h=r.containerElementId,o=r.exclusive,c=r.selection,g=c.win.document,l=n(g,h);if(!a&&t!==!1)throw new Error("No class applier found for class '"+t+"'");var d=i.serializeSelection(c,l),f=[];p(d,function(e){f.push(s.fromCharacterRange(e.characterRange))});var R=this.highlightCharacterRanges(t,f,{containerElementId:h,exclusive:o});return i.restoreSelection(c,d,l),R},unhighlightSelection:function(t){t=t||e.getSelection(this.doc);var n=this.getIntersectingHighlights(t.getAllRanges());return this.removeHighlights(n),t.removeAllRanges(),n},getHighlightsInSelection:function(t){return t=t||e.getSelection(this.doc),this.getIntersectingHighlights(t.getAllRanges())},selectionOverlapsHighlight:function(e){return this.getHighlightsInSelection(e).length>0},serialize:function(e){var n,r,i,s,h=this,o=h.highlights;return o.sort(t),e=u(e,{serializeHighlightText:!1,type:h.converter.type}),n=e.type,i=n!=h.converter.type,i&&(s=a(n)),r=["type:"+n],p(o,function(t){var n,a=t.characterRange;i&&(n=t.getContainerElement(),a=s.rangeToCharacterRange(h.converter.characterRangeToRange(h.doc,a,n),n));var o=[a.start,a.end,t.id,t.classApplier.className,t.containerElementId];e.serializeHighlightText&&o.push(t.getText()),r.push(o.join("$"))}),r.join("|")},deserialize:function(e){var t,r,i,o=e.split("|"),c=[],g=o[0],l=!1;if(!g||!(t=/^type:(\w+)$/.exec(g)))throw new Error("Serialized highlights are invalid.");r=t[1],r!=this.converter.type&&(i=a(r),l=!0),o.shift();for(var u,p,d,f,R,v,m=o.length;m-->0;){if(v=o[m].split("$"),d=new s(+v[0],+v[1]),f=v[4]||null,l&&(R=n(this.doc,f),d=this.converter.rangeToCharacterRange(i.characterRangeToRange(this.doc,d,R),R)),u=this.classAppliers[v[3]],!u)throw new Error("No class applier found for class '"+v[3]+"'");p=new h(this.doc,d,u,this.converter,parseInt(v[2]),f),p.apply(),c.push(p)}this.highlights=c}},e.Highlighter=o,e.createHighlighter=function(e,t){return new o(e,t)}}),e},this);
\ No newline at end of file
diff --git a/libs/editor-common/assets/rangy-selectionsaverestore.js b/libs/editor-common/assets/rangy-selectionsaverestore.js
new file mode 100755
index 000000000000..61d44cc98594
--- /dev/null
+++ b/libs/editor-common/assets/rangy-selectionsaverestore.js
@@ -0,0 +1,15 @@
+/**
+ * Selection save and restore module for Rangy.
+ * Saves and restores user selections using marker invisible elements in the DOM.
+ *
+ * Part of Rangy, a cross-browser JavaScript range and selection library
+ * https://github.com/timdown/rangy
+ *
+ * Depends on Rangy core.
+ *
+ * Copyright 2015, Tim Down
+ * Licensed under the MIT license.
+ * Version: 1.3.0
+ * Build date: 10 May 2015
+ */
+!function(e,n){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(n.rangy)}(function(e){return e.createModule("SaveRestore",["WrappedRange"],function(e,n){function r(e,n){return(n||document).getElementById(e)}function t(e,n){var r,t="selectionBoundary_"+ +new Date+"_"+(""+Math.random()).slice(2),a=m.getDocument(e.startContainer),o=e.cloneRange();return o.collapse(n),r=a.createElement("span"),r.id=t,r.style.lineHeight="0",r.style.display="none",r.className="rangySelectionBoundary",r.appendChild(a.createTextNode(k)),o.insertNode(r),r}function a(e,t,a,o){var s=r(a,e);s?(t[o?"setStartBefore":"setEndBefore"](s),p(s)):n.warn("Marker element has been removed. Cannot restore selection.")}function o(e,n){return n.compareBoundaryPoints(e.START_TO_START,e)}function s(n,r){var a,o,s=e.DomRange.getRangeDocument(n),i=n.toString(),d=v(r);return n.collapsed?(o=t(n,!1),{document:s,markerId:o.id,collapsed:!0}):(o=t(n,!1),a=t(n,!0),{document:s,startMarkerId:a.id,endMarkerId:o.id,collapsed:!1,backward:d,toString:function(){return"original text: '"+i+"', new text: '"+n.toString()+"'"}})}function i(t,o){var s=t.document;"undefined"==typeof o&&(o=!0);var i=e.createRange(s);if(t.collapsed){var d=r(t.markerId,s);if(d){d.style.display="inline";var l=d.previousSibling;l&&3==l.nodeType?(p(d),i.collapseToPoint(l,l.length)):(i.collapseBefore(d),p(d))}else n.warn("Marker element has been removed. Cannot restore selection.")}else a(s,i,t.startMarkerId,!0),a(s,i,t.endMarkerId,!1);return o&&i.normalizeBoundaries(),i}function d(n,t){var a,i,d=[],l=v(t);n=n.slice(0),n.sort(o);for(var c=0,u=n.length;u>c;++c)d[c]=s(n[c],l);for(c=u-1;c>=0;--c)a=n[c],i=e.DomRange.getRangeDocument(a),a.collapsed?a.collapseAfter(r(d[c].markerId,i)):(a.setEndBefore(r(d[c].endMarkerId,i)),a.setStartAfter(r(d[c].startMarkerId,i)));return d}function l(r){if(!e.isSelectionValid(r))return n.warn("Cannot save selection. This usually happens when the selection is collapsed and the selection document has lost focus."),null;var t=e.getSelection(r),a=t.getAllRanges(),o=1==a.length&&t.isBackward(),s=d(a,o);return o?t.setSingleRange(a[0],o):t.setRanges(a),{win:r,rangeInfos:s,restored:!1}}function c(e){for(var n=[],r=e.length,t=r-1;t>=0;t--)n[t]=i(e[t],!0);return n}function u(n,r){if(!n.restored){var t=n.rangeInfos,a=e.getSelection(n.win),o=c(t),s=t.length;1==s&&r&&e.features.selectionHasExtend&&t[0].backward?(a.removeAllRanges(),a.addRange(o[0],!0)):a.setRanges(o),n.restored=!0}}function f(e,n){var t=r(n,e);t&&p(t)}function g(e){for(var n,r=e.rangeInfos,t=0,a=r.length;a>t;++t)n=r[t],n.collapsed?f(e.doc,n.markerId):(f(e.doc,n.startMarkerId),f(e.doc,n.endMarkerId))}var m=e.dom,p=m.removeNode,v=e.Selection.isDirectionBackward,k="";e.util.extend(e,{saveRange:s,restoreRange:i,saveRanges:d,restoreRanges:c,saveSelection:l,restoreSelection:u,removeMarkerElement:f,removeMarkers:g})}),e},this);
\ No newline at end of file
diff --git a/libs/editor-common/assets/rangy-serializer.js b/libs/editor-common/assets/rangy-serializer.js
new file mode 100755
index 000000000000..c5d100f32a6b
--- /dev/null
+++ b/libs/editor-common/assets/rangy-serializer.js
@@ -0,0 +1,16 @@
+/**
+ * Serializer module for Rangy.
+ * Serializes Ranges and Selections. An example use would be to store a user's selection on a particular page in a
+ * cookie or local storage and restore it on the user's next visit to the same page.
+ *
+ * Part of Rangy, a cross-browser JavaScript range and selection library
+ * https://github.com/timdown/rangy
+ *
+ * Depends on Rangy core.
+ *
+ * Copyright 2015, Tim Down
+ * Licensed under the MIT license.
+ * Version: 1.3.0
+ * Build date: 10 May 2015
+ */
+!function(e,n){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(n.rangy)}(function(e){return e.createModule("Serializer",["WrappedSelection"],function(e,n){function t(e){return e.replace(/</g,"&lt;").replace(/>/g,"&gt;")}function o(e,n){n=n||[];var r=e.nodeType,i=e.childNodes,c=i.length,a=[r,e.nodeName,c].join(":"),d="",u="";switch(r){case 3:d=t(e.nodeValue);break;case 8:d="<!--"+t(e.nodeValue)+"-->";break;default:d="<"+a+">",u="</>"}d&&n.push(d);for(var s=0;c>s;++s)o(i[s],n);return u&&n.push(u),n}function r(e){var n=o(e).join("");return w(n).toString(16)}function i(e,n,t){var o=[],r=e;for(t=t||R.getDocument(e).documentElement;r&&r!=t;)o.push(R.getNodeIndex(r,!0)),r=r.parentNode;return o.join("/")+":"+n}function c(e,t,o){t||(t=(o||document).documentElement);for(var r,i=e.split(":"),c=t,a=i[0]?i[0].split("/"):[],d=a.length;d--;){if(r=parseInt(a[d],10),!(r<c.childNodes.length))throw n.createError("deserializePosition() failed: node "+R.inspectNode(c)+" has no child with index "+r+", "+d);c=c.childNodes[r]}return new R.DomPosition(c,parseInt(i[1],10))}function a(t,o,c){if(c=c||e.DomRange.getRangeDocument(t).documentElement,!R.isOrIsAncestorOf(c,t.commonAncestorContainer))throw n.createError("serializeRange(): range "+t.inspect()+" is not wholly contained within specified root node "+R.inspectNode(c));var a=i(t.startContainer,t.startOffset,c)+","+i(t.endContainer,t.endOffset,c);return o||(a+="{"+r(c)+"}"),a}function d(t,o,i){o?i=i||R.getDocument(o):(i=i||document,o=i.documentElement);var a=S.exec(t),d=a[4];if(d){var u=r(o);if(d!==u)throw n.createError("deserializeRange(): checksums of serialized range root node ("+d+") and target root node ("+u+") do not match")}var s=c(a[1],o,i),l=c(a[2],o,i),f=e.createRange(i);return f.setStartAndEnd(s.node,s.offset,l.node,l.offset),f}function u(e,n,t){n||(n=(t||document).documentElement);var o=S.exec(e),i=o[3];return!i||i===r(n)}function s(n,t,o){n=e.getSelection(n);for(var r=n.getAllRanges(),i=[],c=0,d=r.length;d>c;++c)i[c]=a(r[c],t,o);return i.join("|")}function l(n,t,o){t?o=o||R.getWindow(t):(o=o||window,t=o.document.documentElement);for(var r=n.split("|"),i=e.getSelection(o),c=[],a=0,u=r.length;u>a;++a)c[a]=d(r[a],t,o.document);return i.setRanges(c),i}function f(e,n,t){var o;n?o=t?t.document:R.getDocument(n):(t=t||window,n=t.document.documentElement);for(var r=e.split("|"),i=0,c=r.length;c>i;++i)if(!u(r[i],n,o))return!1;return!0}function m(e){for(var n,t,o=e.split(/[;,]/),r=0,i=o.length;i>r;++r)if(n=o[r].split("="),n[0].replace(/^\s+/,"")==C&&(t=n[1]))return decodeURIComponent(t.replace(/\s+$/,""));return null}function p(e){e=e||window;var n=m(e.document.cookie);n&&l(n,e.doc)}function g(n,t){n=n||window,t="object"==typeof t?t:{};var o=t.expires?";expires="+t.expires.toUTCString():"",r=t.path?";path="+t.path:"",i=t.domain?";domain="+t.domain:"",c=t.secure?";secure":"",a=s(e.getSelection(n));n.document.cookie=encodeURIComponent(C)+"="+encodeURIComponent(a)+o+r+i+c}var h="undefined",v=e.util;(typeof encodeURIComponent==h||typeof decodeURIComponent==h)&&n.fail("encodeURIComponent and/or decodeURIComponent method is missing");var w=function(){function e(e){for(var n,t=[],o=0,r=e.length;r>o;++o)n=e.charCodeAt(o),128>n?t.push(n):2048>n?t.push(n>>6|192,63&n|128):t.push(n>>12|224,n>>6&63|128,63&n|128);return t}function n(){for(var e,n,t=[],o=0;256>o;++o){for(n=o,e=8;e--;)1==(1&n)?n=n>>>1^3988292384:n>>>=1;t[o]=n>>>0}return t}function t(){return o||(o=n()),o}var o=null;return function(n){for(var o,r=e(n),i=-1,c=t(),a=0,d=r.length;d>a;++a)o=255&(i^r[a]),i=i>>>8^c[o];return(-1^i)>>>0}}(),R=e.dom,S=/^([^,]+),([^,\{]+)(\{([^}]+)\})?$/,C="rangySerializedSelection";v.extend(e,{serializePosition:i,deserializePosition:c,serializeRange:a,deserializeRange:d,canDeserializeRange:u,serializeSelection:s,deserializeSelection:l,canDeserializeSelection:f,restoreSelectionFromCookie:p,saveSelectionCookie:g,getElementChecksum:r,nodeToInfoString:o}),v.crc32=w}),e},this);
\ No newline at end of file
diff --git a/libs/editor-common/assets/rangy-textrange.js b/libs/editor-common/assets/rangy-textrange.js
new file mode 100755
index 000000000000..90732e3799f5
--- /dev/null
+++ b/libs/editor-common/assets/rangy-textrange.js
@@ -0,0 +1,32 @@
+/**
+ * Text range module for Rangy.
+ * Text-based manipulation and searching of ranges and selections.
+ *
+ * Features
+ *
+ * - Ability to move range boundaries by character or word offsets
+ * - Customizable word tokenizer
+ * - Ignores text nodes inside <script> or <style> elements or those hidden by CSS display and visibility properties
+ * - Range findText method to search for text or regex within the page or within a range. Flags for whole words and case
+ *   sensitivity
+ * - Selection and range save/restore as text offsets within a node
+ * - Methods to return visible text within a range or selection
+ * - innerText method for elements
+ *
+ * References
+ *
+ * https://www.w3.org/Bugs/Public/show_bug.cgi?id=13145
+ * http://aryeh.name/spec/innertext/innertext.html
+ * http://dvcs.w3.org/hg/editing/raw-file/tip/editing.html
+ *
+ * Part of Rangy, a cross-browser JavaScript range and selection library
+ * https://github.com/timdown/rangy
+ *
+ * Depends on Rangy core.
+ *
+ * Copyright 2015, Tim Down
+ * Licensed under the MIT license.
+ * Version: 1.3.0
+ * Build date: 10 May 2015
+ */
+!function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("TextRange",["WrappedSelection"],function(e,t){function n(e,t){function n(e,t,n){s.push({start:e,end:t,isWord:n})}for(var r,i,o,a=e.join(""),s=[],c=0;r=t.wordRegex.exec(a);){if(i=r.index,o=i+r[0].length,i>c&&n(c,i,!1),t.includeTrailingSpace)for(;X.test(e[o]);)++o;n(i,o,!0),c=o}return c<e.length&&n(c,e.length,!1),s}function r(e,t){for(var n=e.slice(t.start,t.end),r={isWord:t.isWord,chars:n,toString:function(){return n.join("")}},i=0,o=n.length;o>i;++i)n[i].token=r;return r}function i(e,t,n){for(var i,o=n(e,t),a=[],s=0;i=o[s++];)a.push(r(e,i));return a}function o(e){var t=e||"",n="string"==typeof t?t.split(""):t;return n.sort(function(e,t){return e.charCodeAt(0)-t.charCodeAt(0)}),n.join("").replace(/(.)\1+/g,"$1")}function a(e){var t,n;return e?(t=e.language||Z,n={},K(n,ct[t]||ct[Z]),K(n,e),n):ct[Z]}function s(e,t){var n=z(e,t);return t.hasOwnProperty("wordOptions")&&(n.wordOptions=a(n.wordOptions)),t.hasOwnProperty("characterOptions")&&(n.characterOptions=z(n.characterOptions,at)),n}function c(e,t){var n=pt(e,"display",t),r=e.tagName.toLowerCase();return"block"==n&&ot&&ft.hasOwnProperty(r)?ft[r]:n}function u(e){for(var t=f(e),n=0,r=t.length;r>n;++n)if(1==t[n].nodeType&&"none"==c(t[n]))return!0;return!1}function d(e){var t;return 3==e.nodeType&&(t=e.parentNode)&&"hidden"==pt(t,"visibility")}function l(e){return e&&(1==e.nodeType&&!/^(inline(-block|-table)?|none)$/.test(c(e))||9==e.nodeType||11==e.nodeType)}function h(e){return U.isCharacterDataNode(e)||!/^(area|base|basefont|br|col|frame|hr|img|input|isindex|link|meta|param)$/i.test(e.nodeName)}function p(e){for(var t=[];e.parentNode;)t.unshift(e.parentNode),e=e.parentNode;return t}function f(e){return p(e).concat([e])}function g(e){for(;e&&!e.nextSibling;)e=e.parentNode;return e?e.nextSibling:null}function v(e,t){return!t&&e.hasChildNodes()?e.firstChild:g(e)}function S(e){var t=e.previousSibling;if(t){for(e=t;e.hasChildNodes();)e=e.lastChild;return e}var n=e.parentNode;return n&&1==n.nodeType?n:null}function C(e){if(!e||3!=e.nodeType)return!1;var t=e.data;if(""===t)return!0;var n=e.parentNode;if(!n||1!=n.nodeType)return!1;var r=pt(e.parentNode,"whiteSpace");return/^[\t\n\r ]+$/.test(t)&&/^(normal|nowrap)$/.test(r)||/^[\t\r ]+$/.test(t)&&"pre-line"==r}function N(e){if(""===e.data)return!0;if(!C(e))return!1;var t=e.parentNode;return t?u(e)?!0:!1:!0}function y(e){var t=e.nodeType;return 7==t||8==t||u(e)||/^(script|style)$/i.test(e.nodeName)||d(e)||N(e)}function m(e,t){var n=e.nodeType;return 7==n||8==n||1==n&&"none"==c(e,t)}function x(){this.store={}}function T(e,t,n){return function(r){var i=this.cache;if(i.hasOwnProperty(e))return gt++,i[e];vt++;var o=t.call(this,n?this[n]:this,r);return i[e]=o,o}}function P(e,t){this.node=e,this.session=t,this.cache=new x,this.positions=new x}function b(e,t){this.offset=t,this.nodeWrapper=e,this.node=e.node,this.session=e.session,this.cache=new x}function w(){return"[Position("+U.inspectNode(this.node)+":"+this.offset+")]"}function R(){return B(),Bt=new Ot}function E(){return Bt||R()}function B(){Bt&&Bt.detach(),Bt=null}function O(e,n,r,i){function o(){var e=null;return n?(e=s,c||(s=s.previousVisible(),c=!s||r&&s.equals(r))):c||(e=s=s.nextVisible(),c=!s||r&&s.equals(r)),c&&(s=null),e}r&&(n?y(r.node)&&(r=e.previousVisible()):y(r.node)&&(r=r.nextVisible()));var a,s=e,c=!1,u=!1;return{next:function(){if(u)return u=!1,a;for(var e,t;e=o();)if(t=e.getCharacter(i))return a=e,e;return null},rewind:function(){if(!a)throw t.createError("createCharacterIterator: cannot rewind. Only one position can be rewound.");u=!0},dispose:function(){e=r=null}}}function k(e,t,n){function r(e){for(var t,n,r=[],i=e?o:a,s=!1,c=!1;t=i.next();){if(n=t.character,Q.test(n))c&&(c=!1,s=!0);else{if(s){i.rewind();break}c=!0}r.push(t)}return r}var o=O(e,!1,null,t),a=O(e,!0,null,t),s=n.tokenizer,c=r(!0),u=r(!1).reverse(),d=i(u.concat(c),n,s),l=c.length?d.slice(kt(d,c[0].token)):[],h=u.length?d.slice(0,kt(d,u.pop().token)+1):[];return{nextEndToken:function(){for(var e,t;1==l.length&&!(e=l[0]).isWord&&(t=r(!0)).length>0;)l=i(e.chars.concat(t),n,s);return l.shift()},previousStartToken:function(){for(var e,t;1==h.length&&!(e=h[0]).isWord&&(t=r(!1)).length>0;)h=i(t.reverse().concat(e.chars),n,s);return h.pop()},dispose:function(){o.dispose(),a.dispose(),l=h=null}}}function L(e,t,n,r,i){var o,a,s,c,u=0,d=e,l=Math.abs(n);if(0!==n){var h=0>n;switch(t){case M:for(a=O(e,h,null,r);(o=a.next())&&l>u;)++u,d=o;s=o,a.dispose();break;case j:for(var p=k(e,r,i),f=h?p.previousStartToken:p.nextEndToken;(c=f())&&l>u;)c.isWord&&(++u,d=h?c.chars[0]:c.chars[c.chars.length-1]);break;default:throw new Error("movePositionBy: unit '"+t+"' not implemented")}h?(d=d.previousVisible(),u=-u):d&&d.isLeadingSpace&&!d.isTrailingSpace&&(t==j&&(a=O(e,!1,null,r),s=a.next(),a.dispose()),s&&(d=s.previousVisible()))}return{position:d,unitsMoved:u}}function I(e,t,n,r){var i=e.getRangeBoundaryPosition(t,!0),o=e.getRangeBoundaryPosition(t,!1),a=r?o:i,s=r?i:o;return O(a,!!r,s,n)}function A(e,t,n){for(var r,i=[],o=I(e,t,n);r=o.next();)i.push(r);return o.dispose(),i}function W(t,n,r){var i=e.createRange(t.node);return i.setStartAndEnd(t.node,t.offset,n.node,n.offset),!i.expand("word",{wordOptions:r})}function _(e,t,n,r,i){function o(e,t){var n=g[e].previousVisible(),r=g[t-1],o=!i.wholeWordsOnly||W(n,r,i.wordOptions);return{startPos:n,endPos:r,valid:o}}for(var a,s,c,u,d,l,h=et(i.direction),p=O(e,h,e.session.getRangeBoundaryPosition(r,h),i.characterOptions),f="",g=[],v=null;a=p.next();)if(s=a.character,n||i.caseSensitive||(s=s.toLowerCase()),h?(g.unshift(a),f=s+f):(g.push(a),f+=s),n){if(d=t.exec(f))if(c=d.index,u=c+d[0].length,l){if(!h&&u<f.length||h&&c>0){v=o(c,u);break}}else l=!0}else if(-1!=(c=f.indexOf(t))){v=o(c,c+t.length);break}return l&&(v=o(c,u)),p.dispose(),v}function D(e){return function(){var t=!!Bt,n=E(),r=[n].concat(G.toArray(arguments)),i=e.apply(this,r);return t||B(),i}}function F(e,t){return D(function(n,r,i,o){typeof i==q&&(i=r,r=M),o=s(o,dt);var a=e;t&&(a=i>=0,this.collapse(!a));var c=L(n.getRangeBoundaryPosition(this,a),r,i,o.characterOptions,o.wordOptions),u=c.position;return this[a?"setStart":"setEnd"](u.node,u.offset),c.unitsMoved})}function V(e){return D(function(t,n){n=z(n,at);for(var r,i=I(t,this,n,!e),o=0;(r=i.next())&&Q.test(r.character);)++o;i.dispose();var a=o>0;return a&&this[e?"moveStart":"moveEnd"]("character",e?o:-o,{characterOptions:n}),a})}function $(e){return D(function(t,n){var r=!1;return this.changeEachRange(function(t){r=t[e](n)||r}),r})}var q="undefined",M="character",j="word",U=e.dom,G=e.util,K=G.extend,z=G.createOptions,H=U.getBody,Y=/^[ \t\f\r\n]+$/,J=/^[ \t\f\r]+$/,Q=/^[\t-\r \u0085\u00A0\u1680\u180E\u2000-\u200B\u2028\u2029\u202F\u205F\u3000]+$/,X=/^[\t \u00A0\u1680\u180E\u2000-\u200B\u202F\u205F\u3000]+$/,Z="en",et=e.Selection.isDirectionBackward,tt=!1,nt=!1,rt=!1,it=!0;!function(){var t=U.createTestElement(document,"<p>1 </p><p></p>",!0),n=t.firstChild,r=e.getSelection();r.collapse(n.lastChild,2),r.setStart(n.firstChild,0),tt=1==(""+r).length,t.innerHTML="1 <br />",r.collapse(t,2),r.setStart(t.firstChild,0),nt=1==(""+r).length,t.innerHTML="1 <p>1</p>",r.collapse(t,2),r.setStart(t.firstChild,0),rt=1==(""+r).length,U.removeNode(t),r.removeAllRanges()}();var ot,at={includeBlockContentTrailingSpace:!0,includeSpaceBeforeBr:!0,includeSpaceBeforeBlock:!0,includePreLineTrailingSpace:!0,ignoreCharacters:""},st={includeBlockContentTrailingSpace:!it,includeSpaceBeforeBr:!nt,includeSpaceBeforeBlock:!rt,includePreLineTrailingSpace:!0},ct={en:{wordRegex:/[a-z0-9]+('[a-z0-9]+)*/gi,includeTrailingSpace:!1,tokenizer:n}},ut={caseSensitive:!1,withinRange:null,wholeWordsOnly:!1,wrap:!1,direction:"forward",wordOptions:null,characterOptions:null},dt={wordOptions:null,characterOptions:null},lt={wordOptions:null,characterOptions:null,trim:!1,trimStart:!0,trimEnd:!0},ht={wordOptions:null,characterOptions:null,direction:"forward"},pt=U.getComputedStyleProperty;!function(){var e=document.createElement("table"),t=H(document);t.appendChild(e),ot="block"==pt(e,"display"),t.removeChild(e)}();var ft={table:"table",caption:"table-caption",colgroup:"table-column-group",col:"table-column",thead:"table-header-group",tbody:"table-row-group",tfoot:"table-footer-group",tr:"table-row",td:"table-cell",th:"table-cell"};x.prototype={get:function(e){return this.store.hasOwnProperty(e)?this.store[e]:null},set:function(e,t){return this.store[e]=t}};var gt=0,vt=0,St={getPosition:function(e){var t=this.positions;return t.get(e)||t.set(e,new b(this,e))},toString:function(){return"[NodeWrapper("+U.inspectNode(this.node)+")]"}};P.prototype=St;var Ct="EMPTY",Nt="NON_SPACE",yt="UNCOLLAPSIBLE_SPACE",mt="COLLAPSIBLE_SPACE",xt="TRAILING_SPACE_BEFORE_BLOCK",Tt="TRAILING_SPACE_IN_BLOCK",Pt="TRAILING_SPACE_BEFORE_BR",bt="PRE_LINE_TRAILING_SPACE_BEFORE_LINE_BREAK",wt="TRAILING_LINE_BREAK_AFTER_BR",Rt="INCLUDED_TRAILING_LINE_BREAK_AFTER_BR";K(St,{isCharacterDataNode:T("isCharacterDataNode",U.isCharacterDataNode,"node"),getNodeIndex:T("nodeIndex",U.getNodeIndex,"node"),getLength:T("nodeLength",U.getNodeLength,"node"),containsPositions:T("containsPositions",h,"node"),isWhitespace:T("isWhitespace",C,"node"),isCollapsedWhitespace:T("isCollapsedWhitespace",N,"node"),getComputedDisplay:T("computedDisplay",c,"node"),isCollapsed:T("collapsed",y,"node"),isIgnored:T("ignored",m,"node"),next:T("nextPos",v,"node"),previous:T("previous",S,"node"),getTextNodeInfo:T("textNodeInfo",function(e){var t=null,n=!1,r=pt(e.parentNode,"whiteSpace"),i="pre-line"==r;return i?(t=J,n=!0):("normal"==r||"nowrap"==r)&&(t=Y,n=!0),{node:e,text:e.data,spaceRegex:t,collapseSpaces:n,preLine:i}},"node"),hasInnerText:T("hasInnerText",function(e,t){for(var n=this.session,r=n.getPosition(e.parentNode,this.getNodeIndex()+1),i=n.getPosition(e,0),o=t?r:i,a=t?i:r;o!==a;){if(o.prepopulateChar(),o.isDefinitelyNonEmpty())return!0;o=t?o.previousVisible():o.nextVisible()}return!1},"node"),isRenderedBlock:T("isRenderedBlock",function(e){for(var t=e.getElementsByTagName("br"),n=0,r=t.length;r>n;++n)if(!y(t[n]))return!0;return this.hasInnerText()},"node"),getTrailingSpace:T("trailingSpace",function(e){if("br"==e.tagName.toLowerCase())return"";switch(this.getComputedDisplay()){case"inline":for(var t=e.lastChild;t;){if(!m(t))return 1==t.nodeType?this.session.getNodeWrapper(t).getTrailingSpace():"";t=t.previousSibling}break;case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":break;case"table-cell":return"	";default:return this.isRenderedBlock(!0)?"\n":""}return""},"node"),getLeadingSpace:T("leadingSpace",function(){switch(this.getComputedDisplay()){case"inline":case"inline-block":case"inline-table":case"none":case"table-column":case"table-column-group":case"table-cell":break;default:return this.isRenderedBlock(!1)?"\n":""}return""},"node")});var Et={character:"",characterType:Ct,isBr:!1,prepopulateChar:function(){var e=this;if(!e.prepopulatedChar){var t=e.node,n=e.offset,r="",i=Ct,o=!1;if(n>0)if(3==t.nodeType){var a=t.data,s=a.charAt(n-1),c=e.nodeWrapper.getTextNodeInfo(),u=c.spaceRegex;c.collapseSpaces?u.test(s)?n>1&&u.test(a.charAt(n-2))||(c.preLine&&"\n"===a.charAt(n)?(r=" ",i=bt):(r=" ",i=mt)):(r=s,i=Nt,o=!0):(r=s,i=yt,o=!0)}else{var d=t.childNodes[n-1];if(d&&1==d.nodeType&&!y(d)&&("br"==d.tagName.toLowerCase()?(r="\n",e.isBr=!0,i=mt,o=!1):e.checkForTrailingSpace=!0),!r){var l=t.childNodes[n];l&&1==l.nodeType&&!y(l)&&(e.checkForLeadingSpace=!0)}}e.prepopulatedChar=!0,e.character=r,e.characterType=i,e.isCharInvariant=o}},isDefinitelyNonEmpty:function(){var e=this.characterType;return e==Nt||e==yt},resolveLeadingAndTrailingSpaces:function(){if(this.prepopulatedChar||this.prepopulateChar(),this.checkForTrailingSpace){var e=this.session.getNodeWrapper(this.node.childNodes[this.offset-1]).getTrailingSpace();e&&(this.isTrailingSpace=!0,this.character=e,this.characterType=mt),this.checkForTrailingSpace=!1}if(this.checkForLeadingSpace){var t=this.session.getNodeWrapper(this.node.childNodes[this.offset]).getLeadingSpace();t&&(this.isLeadingSpace=!0,this.character=t,this.characterType=mt),this.checkForLeadingSpace=!1}},getPrecedingUncollapsedPosition:function(e){for(var t,n=this;n=n.previousVisible();)if(t=n.getCharacter(e),""!==t)return n;return null},getCharacter:function(e){function t(){return p||(d=f.getPrecedingUncollapsedPosition(e),p=!0),d}this.resolveLeadingAndTrailingSpaces();var n,r=this.character,i=o(e.ignoreCharacters),a=""!==r&&i.indexOf(r)>-1;if(this.isCharInvariant)return n=a?"":r;var s=["character",e.includeSpaceBeforeBr,e.includeBlockContentTrailingSpace,e.includePreLineTrailingSpace,i].join("_"),c=this.cache.get(s);if(null!==c)return c;var u,d,l="",h=this.characterType==mt,p=!1,f=this;return h&&(this.type==Rt?l="\n":" "==r&&(!t()||d.isTrailingSpace||"\n"==d.character||" "==d.character&&d.characterType==mt)||("\n"==r&&this.isLeadingSpace?t()&&"\n"!=d.character&&(l="\n"):(u=this.nextUncollapsed(),u&&(u.isBr?this.type=Pt:u.isTrailingSpace&&"\n"==u.character?this.type=Tt:u.isLeadingSpace&&"\n"==u.character&&(this.type=xt),"\n"==u.character?(this.type!=Pt||e.includeSpaceBeforeBr)&&(this.type!=xt||e.includeSpaceBeforeBlock)&&(this.type==Tt&&u.isTrailingSpace&&!e.includeBlockContentTrailingSpace||(this.type!=bt||u.type!=Nt||e.includePreLineTrailingSpace)&&("\n"==r?u.isTrailingSpace?this.isTrailingSpace||this.isBr&&(u.type=wt,t()&&d.isLeadingSpace&&!d.isTrailingSpace&&"\n"==d.character?u.character="":u.type=Rt):l="\n":" "==r&&(l=" "))):l=r)))),i.indexOf(l)>-1&&(l=""),this.cache.set(s,l),l},equals:function(e){return!!e&&this.node===e.node&&this.offset===e.offset},inspect:w,toString:function(){return this.character}};b.prototype=Et,K(Et,{next:T("nextPos",function(e){var t=e.nodeWrapper,n=e.node,r=e.offset,i=t.session;if(!n)return null;var o,a,s;return r==t.getLength()?(o=n.parentNode,a=o?t.getNodeIndex()+1:0):t.isCharacterDataNode()?(o=n,a=r+1):(s=n.childNodes[r],i.getNodeWrapper(s).containsPositions()?(o=s,a=0):(o=n,a=r+1)),o?i.getPosition(o,a):null}),previous:T("previous",function(e){var t,n,r,i=e.nodeWrapper,o=e.node,a=e.offset,s=i.session;return 0==a?(t=o.parentNode,n=t?i.getNodeIndex():0):i.isCharacterDataNode()?(t=o,n=a-1):(r=o.childNodes[a-1],s.getNodeWrapper(r).containsPositions()?(t=r,n=U.getNodeLength(r)):(t=o,n=a-1)),t?s.getPosition(t,n):null}),nextVisible:T("nextVisible",function(e){var t=e.next();if(!t)return null;var n=t.nodeWrapper,r=t.node,i=t;return n.isCollapsed()&&(i=n.session.getPosition(r.parentNode,n.getNodeIndex()+1)),i}),nextUncollapsed:T("nextUncollapsed",function(e){for(var t=e;t=t.nextVisible();)if(t.resolveLeadingAndTrailingSpaces(),""!==t.character)return t;return null}),previousVisible:T("previousVisible",function(e){var t=e.previous();if(!t)return null;var n=t.nodeWrapper,r=t.node,i=t;return n.isCollapsed()&&(i=n.session.getPosition(r.parentNode,n.getNodeIndex())),i})});var Bt=null,Ot=function(){function e(e){var t=new x;return{get:function(n){var r=t.get(n[e]);if(r)for(var i,o=0;i=r[o++];)if(i.node===n)return i;return null},set:function(n){var r=n.node[e],i=t.get(r)||t.set(r,[]);i.push(n)}}}function t(){this.initCaches()}var n=G.isHostProperty(document.documentElement,"uniqueID");return t.prototype={initCaches:function(){this.elementCache=n?function(){var e=new x;return{get:function(t){return e.get(t.uniqueID)},set:function(t){e.set(t.node.uniqueID,t)}}}():e("tagName"),this.textNodeCache=e("data"),this.otherNodeCache=e("nodeName")},getNodeWrapper:function(e){var t;switch(e.nodeType){case 1:t=this.elementCache;break;case 3:t=this.textNodeCache;break;default:t=this.otherNodeCache}var n=t.get(e);return n||(n=new P(e,this),t.set(n)),n},getPosition:function(e,t){return this.getNodeWrapper(e).getPosition(t)},getRangeBoundaryPosition:function(e,t){var n=t?"start":"end";return this.getPosition(e[n+"Container"],e[n+"Offset"])},detach:function(){this.elementCache=this.textNodeCache=this.otherNodeCache=null}},t}();K(U,{nextNode:v,previousNode:S});var kt=Array.prototype.indexOf?function(e,t){return e.indexOf(t)}:function(e,t){for(var n=0,r=e.length;r>n;++n)if(e[n]===t)return n;return-1};K(e.rangePrototype,{moveStart:F(!0,!1),moveEnd:F(!1,!1),move:F(!0,!0),trimStart:V(!0),trimEnd:V(!1),trim:D(function(e,t){var n=this.trimStart(t),r=this.trimEnd(t);return n||r}),expand:D(function(e,t,n){var r=!1;n=s(n,lt);var i=n.characterOptions;if(t||(t=M),t==j){var o,a,c=n.wordOptions,u=e.getRangeBoundaryPosition(this,!0),d=e.getRangeBoundaryPosition(this,!1),l=k(u,i,c),h=l.nextEndToken(),p=h.chars[0].previousVisible();if(this.collapsed)o=h;else{var f=k(d,i,c);o=f.previousStartToken()}return a=o.chars[o.chars.length-1],p.equals(u)||(this.setStart(p.node,p.offset),r=!0),a&&!a.equals(d)&&(this.setEnd(a.node,a.offset),r=!0),n.trim&&(n.trimStart&&(r=this.trimStart(i)||r),n.trimEnd&&(r=this.trimEnd(i)||r)),r}return this.moveEnd(M,1,n)}),text:D(function(e,t){return this.collapsed?"":A(e,this,z(t,at)).join("")}),selectCharacters:D(function(e,t,n,r,i){var o={characterOptions:i};t||(t=H(this.getDocument())),this.selectNodeContents(t),this.collapse(!0),this.moveStart("character",n,o),this.collapse(!0),this.moveEnd("character",r-n,o)}),toCharacterRange:D(function(e,t,n){t||(t=H(this.getDocument()));var r,i,o=t.parentNode,a=U.getNodeIndex(t),s=-1==U.comparePoints(this.startContainer,this.endContainer,o,a),c=this.cloneRange();return s?(c.setStartAndEnd(this.startContainer,this.startOffset,o,a),r=-c.text(n).length):(c.setStartAndEnd(o,a,this.startContainer,this.startOffset),r=c.text(n).length),i=r+this.text(n).length,{start:r,end:i}}),findText:D(function(t,n,r){r=s(r,ut),r.wholeWordsOnly&&(r.wordOptions.includeTrailingSpace=!1);var i=et(r.direction),o=r.withinRange;o||(o=e.createRange(),o.selectNodeContents(this.getDocument()));var a=n,c=!1;"string"==typeof a?r.caseSensitive||(a=a.toLowerCase()):c=!0;var u=t.getRangeBoundaryPosition(this,!i),d=o.comparePoint(u.node,u.offset);-1===d?u=t.getRangeBoundaryPosition(o,!0):1===d&&(u=t.getRangeBoundaryPosition(o,!1));for(var l,h=u,p=!1;;)if(l=_(h,a,c,o,r)){if(l.valid)return this.setStartAndEnd(l.startPos.node,l.startPos.offset,l.endPos.node,l.endPos.offset),!0;h=i?l.startPos:l.endPos}else{if(!r.wrap||p)return!1;o=o.cloneRange(),h=t.getRangeBoundaryPosition(o,!i),o.setBoundary(u.node,u.offset,i),p=!0}}),pasteHtml:function(e){if(this.deleteContents(),e){var t=this.createContextualFragment(e),n=t.lastChild;this.insertNode(t),this.collapseAfter(n)}}}),K(e.selectionPrototype,{expand:D(function(e,t,n){this.changeEachRange(function(e){e.expand(t,n)})}),move:D(function(e,t,n,r){var i=0;if(this.focusNode){this.collapse(this.focusNode,this.focusOffset);var o=this.getRangeAt(0);r||(r={}),r.characterOptions=z(r.characterOptions,st),i=o.move(t,n,r),this.setSingleRange(o)}return i}),trimStart:$("trimStart"),trimEnd:$("trimEnd"),trim:$("trim"),selectCharacters:D(function(t,n,r,i,o,a){var s=e.createRange(n);s.selectCharacters(n,r,i,a),this.setSingleRange(s,o)}),saveCharacterRanges:D(function(e,t,n){for(var r=this.getAllRanges(),i=r.length,o=[],a=1==i&&this.isBackward(),s=0,c=r.length;c>s;++s)o[s]={characterRange:r[s].toCharacterRange(t,n),backward:a,characterOptions:n};return o}),restoreCharacterRanges:D(function(t,n,r){this.removeAllRanges();for(var i,o,a,s=0,c=r.length;c>s;++s)o=r[s],a=o.characterRange,i=e.createRange(n),i.selectCharacters(n,a.start,a.end,o.characterOptions),this.addRange(i,o.backward)}),text:D(function(e,t){for(var n=[],r=0,i=this.rangeCount;i>r;++r)n[r]=this.getRangeAt(r).text(t);return n.join("")})}),e.innerText=function(t,n){var r=e.createRange(t);r.selectNodeContents(t);var i=r.text(n);return i},e.createWordIterator=function(e,t,n){var r=E();n=s(n,ht);var i=r.getPosition(e,t),o=k(i,n.characterOptions,n.wordOptions),a=et(n.direction);return{next:function(){return a?o.previousStartToken():o.nextEndToken()},dispose:function(){o.dispose(),this.next=function(){}}}},e.noMutation=function(e){var t=E();e(t),B()},e.noMutation.createEntryPointFunction=D,e.textRange={isBlockNode:l,isCollapsedWhitespaceNode:N,createPosition:D(function(e,t,n){return e.getPosition(t,n)})}}),e},this);
\ No newline at end of file
diff --git a/libs/editor-common/assets/wpload.js b/libs/editor-common/assets/wpload.js
new file mode 100644
index 000000000000..1fc74b28c730
--- /dev/null
+++ b/libs/editor-common/assets/wpload.js
@@ -0,0 +1,108 @@
+/**
+* The code of this function comes from the WordPress source code,
+* from file `wp-admin/js/editor.js`, so we can get 100% consistent results
+* with wp-admin.
+*/
+
+// Ensure the global `wp` object exists.
+window.wp = window.wp || {};
+
+(function(){
+ 
+ /**
+  *  @brief      Performs multiple transformations to the post source code when
+  *              loading, replacing newlines with pargraph elements.
+  *
+  *  @param      pee   The string to transform
+  *
+  *  @return     Returns the transformed string
+  */
+  wp.loadText = function( pee ) {
+ 
+    if ( pee == null || !pee.trim() ) {
+        // Just whitespace, null, or undefined
+        return '';
+    }
+ 
+    var preserve_linebreaks = false,
+        preserve_br = false,
+        blocklist = 'table|thead|tfoot|caption|col|colgroup|tbody|tr|td|th|div|dl|dd|dt|ul|ol|li|pre' +
+                '|form|map|area|blockquote|address|math|style|p|h[1-6]|hr|fieldset|legend|section' +
+                '|article|aside|hgroup|header|footer|nav|figure|details|menu|summary';
+
+    if ( pee.indexOf( '<object' ) !== -1 ) {
+      pee = pee.replace( /<object[\s\S]+?<\/object>/g, function( a ) {
+        return a.replace( /[\r\n]+/g, '' );
+      });
+    }
+
+    pee = pee.replace( /<[^<>]+>/g, function( a ){
+      return a.replace( /[\r\n]+/g, ' ' );
+    });
+
+    // Protect pre|script tags
+    if ( pee.indexOf( '<pre' ) !== -1 || pee.indexOf( '<script' ) !== -1 ) {
+      preserve_linebreaks = true;
+      pee = pee.replace( /<(pre|script)[^>]*>[\s\S]+?<\/\1>/g, function( a ) {
+        return a.replace( /(\r\n|\n)/g, '<wp-line-break>' );
+      });
+    }
+
+    // keep <br> tags inside captions and convert line breaks
+    if ( pee.indexOf( '[caption' ) !== -1 ) {
+      preserve_br = true;
+      pee = pee.replace( /\[caption[\s\S]+?\[\/caption\]/g, function( a ) {
+        // keep existing <br>
+        a = a.replace( /<br([^>]*)>/g, '<wp-temp-br$1>' );
+        // no line breaks inside HTML tags
+        a = a.replace( /<[a-zA-Z0-9]+( [^<>]+)?>/g, function( b ) {
+          return b.replace( /[\r\n\t]+/, ' ' );
+        });
+        // convert remaining line breaks to <br>
+        return a.replace( /\s*\n\s*/g, '<wp-temp-br />' );
+      });
+    }
+
+    pee = pee + '\n\n';
+    pee = pee.replace( /<br \/>\s*<br \/>/gi, '\n\n' );
+    pee = pee.replace( new RegExp( '(<(?:' + blocklist + ')(?: [^>]*)?>)', 'gi' ), '\n$1' );
+    pee = pee.replace( new RegExp( '(</(?:' + blocklist + ')>)', 'gi' ), '$1\n\n' );
+    pee = pee.replace( /<hr( [^>]*)?>/gi, '<hr$1>\n\n' ); // hr is self closing block element
+    pee = pee.replace( /\s*<option/gi, '<option' ); // No <p> or <br> around <option>
+    pee = pee.replace( /<\/option>\s*/gi, '</option>' );
+    pee = pee.replace( /\r\n|\r/g, '\n' );
+    pee = pee.replace( /\n\s*\n+/g, '\n\n' );
+    pee = pee.replace( /([\s\S]+?)\n\n/g, '<p>$1</p>\n' );
+    pee = pee.replace( /<p>\s*?<\/p>/gi, '');
+    pee = pee.replace( new RegExp( '<p>\\s*(</?(?:' + blocklist + ')(?: [^>]*)?>)\\s*</p>', 'gi' ), '$1' );
+    pee = pee.replace( /<p>(<li.+?)<\/p>/gi, '$1');
+    pee = pee.replace( /<p>\s*<blockquote([^>]*)>/gi, '<blockquote$1><p>');
+    pee = pee.replace( /<\/blockquote>\s*<\/p>/gi, '</p></blockquote>');
+    pee = pee.replace( new RegExp( '<p>\\s*(</?(?:' + blocklist + ')(?: [^>]*)?>)', 'gi' ), '$1' );
+    pee = pee.replace( new RegExp( '(</?(?:' + blocklist + ')(?: [^>]*)?>)\\s*</p>', 'gi' ), '$1' );
+    pee = pee.replace( /\s*\n/gi, '<br />\n');
+    pee = pee.replace( new RegExp( '(</?(?:' + blocklist + ')[^>]*>)\\s*<br />', 'gi' ), '$1' );
+    pee = pee.replace( /<br \/>(\s*<\/?(?:p|li|div|dl|dd|dt|th|pre|td|ul|ol)>)/gi, '$1' );
+    pee = pee.replace( /(?:<p>|<br ?\/?>)*\s*\[caption([^\[]+)\[\/caption\]\s*(?:<\/p>|<br ?\/?>)*/gi, '[caption$1[/caption]' );
+
+    pee = pee.replace( /(<(?:div|th|td|form|fieldset|dd)[^>]*>)(.*?)<\/p>/g, function( a, b, c ) {
+      if ( c.match( /<p( [^>]*)?>/ ) ) {
+              return a;
+      }
+
+      return b + '<p>' + c + '</p>';
+    });
+
+    // put back the line breaks in pre|script
+    if ( preserve_linebreaks ) {
+      pee = pee.replace( /<wp-line-break>/g, '\n' );
+    }
+
+    if ( preserve_br ) {
+      pee = pee.replace( /<wp-temp-br([^>]*)>/g, '<br$1>' );
+    }
+
+    return pee;
+  }
+
+}());
diff --git a/libs/editor-common/assets/wpsave.js b/libs/editor-common/assets/wpsave.js
new file mode 100644
index 000000000000..798673d98a67
--- /dev/null
+++ b/libs/editor-common/assets/wpsave.js
@@ -0,0 +1,113 @@
+/**
+* The code of this function comes from the WordPress source code,
+* from file `wp-admin/js/editor.js`, so we can get 100% consistent results
+* with wp-admin.
+*/
+
+// Ensure the global `wp` object exists.
+window.wp = window.wp || {};
+
+(function(){
+
+ /**
+  *  @brief      Performs multiple transformations to the post source code when
+  *              saving, removing paragraphs whenever possible.
+  *
+  *  @param      content   The string to transform
+  *
+  *  @return     Returns the transformed string
+  */
+  wp.saveText = function( content ) {
+
+    if ( content == null || !content.trim() ) {
+        // Just whitespace, null, or undefined
+        return '';
+    }
+ 
+    var blocklist1, blocklist2,
+        preserve_linebreaks = false,
+        preserve_br = false;
+
+    // Protect pre|script tags
+    if ( content.indexOf( '<pre' ) !== -1 || content.indexOf( '<script' ) !== -1 ) {
+      preserve_linebreaks = true;
+      content = content.replace( /<(pre|script)[^>]*>[\s\S]+?<\/\1>/g, function( a ) {
+        a = a.replace( /<br ?\/?>(\r\n|\n)?/g, '<wp-line-break>' );
+        a = a.replace( /<\/?p( [^>]*)?>(\r\n|\n)?/g, '<wp-line-break>' );
+        return a.replace( /\r?\n/g, '<wp-line-break>' );
+      });
+    }
+
+    // keep <br> tags inside captions and remove line breaks
+    if ( content.indexOf( '[caption' ) !== -1 ) {
+      preserve_br = true;
+      content = content.replace( /\[caption[\s\S]+?\[\/caption\]/g, function( a ) {
+        return a.replace( /<br([^>]*)>/g, '<wp-temp-br$1>' ).replace( /[\r\n\t]+/, '' );
+      });
+    }
+
+    // Pretty it up for the source editor
+    blocklist1 = 'blockquote|ul|ol|li|table|thead|tbody|tfoot|tr|th|td|div|h[1-6]|p|fieldset';
+    content = content.replace( new RegExp( '\\s*</(' + blocklist1 + ')>\\s*', 'g' ), '</$1>\n' );
+    content = content.replace( new RegExp( '\\s*<((?:' + blocklist1 + ')(?: [^>]*)?)>', 'g' ), '\n<$1>' );
+
+    // Mark </p> if it has any attributes.
+    content = content.replace( /(<p [^>]+>.*?)<\/p>/g, '$1</p#>' );
+
+    // Separate <div> containing <p>
+    content = content.replace( /<div( [^>]*)?>\s*<p>/gi, '<div$1>\n\n' );
+
+    // Remove <p> and <br />
+    content = content.replace( /\s*<p>/gi, '' );
+    content = content.replace( /\s*<\/p>\s*/gi, '\n\n' );
+    content = content.replace( /\n[\s\u00a0]+\n/g, '\n\n' );
+    content = content.replace( /\s*<br ?\/?>\s*/gi, '\n' );
+
+    // Fix some block element newline issues
+    content = content.replace( /\s*<div/g, '\n<div' );
+    content = content.replace( /<\/div>\s*/g, '</div>\n' );
+    content = content.replace( /\s*\[caption([^\[]+)\[\/caption\]\s*/gi, '\n\n[caption$1[/caption]\n\n' );
+    content = content.replace( /caption\]\n\n+\[caption/g, 'caption]\n\n[caption' );
+
+    blocklist2 = 'blockquote|ul|ol|li|table|thead|tbody|tfoot|tr|th|td|h[1-6]|pre|fieldset';
+    content = content.replace( new RegExp('\\s*<((?:' + blocklist2 + ')(?: [^>]*)?)\\s*>', 'g' ), '\n<$1>' );
+    content = content.replace( new RegExp('\\s*</(' + blocklist2 + ')>\\s*', 'g' ), '</$1>\n' );
+    content = content.replace( /<li([^>]*)>/g, '\t<li$1>' );
+
+    if ( content.indexOf( '<option' ) !== -1 ) {
+      content = content.replace( /\s*<option/g, '\n<option' );
+      content = content.replace( /\s*<\/select>/g, '\n</select>' );
+    }
+
+    if ( content.indexOf( '<hr' ) !== -1 ) {
+      content = content.replace( /\s*<hr( [^>]*)?>\s*/g, '\n\n<hr$1>\n\n' );
+    }
+
+    if ( content.indexOf( '<object' ) !== -1 ) {
+      content = content.replace( /<object[\s\S]+?<\/object>/g, function( a ) {
+        return a.replace( /[\r\n]+/g, '' );
+      });
+    }
+
+    // Unmark special paragraph closing tags
+    content = content.replace( /<\/p#>/g, '</p>\n' );
+    content = content.replace( /\s*(<p [^>]+>[\s\S]*?<\/p>)/g, '\n$1' );
+
+    // Trim whitespace
+    content = content.replace( /^\s+/, '' );
+    content = content.replace( /[\s\u00a0]+$/, '' );
+
+    // put back the line breaks in pre|script
+    if ( preserve_linebreaks ) {
+      content = content.replace( /<wp-line-break>/g, '\n' );
+    }
+
+    // and the <br> tags in captions
+    if ( preserve_br ) {
+      content = content.replace( /<wp-temp-br([^>]*)>/g, '<br$1>' );
+    }
+
+    return content;
+  }
+
+}());
