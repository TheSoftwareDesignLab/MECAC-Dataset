diff --git a/OsmAnd-java/src/main/java/net/osmand/GPXUtilities.java b/OsmAnd-java/src/main/java/net/osmand/GPXUtilities.java
index 108d81cdeb3..000135a7ef4 100644
--- a/OsmAnd-java/src/main/java/net/osmand/GPXUtilities.java
+++ b/OsmAnd-java/src/main/java/net/osmand/GPXUtilities.java
@@ -918,6 +918,8 @@ public WptPt getPoint(int index) {
 
 		public abstract static class ElevationDiffsCalculator {
 
+			public static final double CALCULATED_GPX_WINDOW_LENGTH = 10d;
+
 			private double windowLength;
 			private final int startIndex;
 			private final int numberOfPoints;
@@ -929,7 +931,7 @@ public ElevationDiffsCalculator(int startIndex, int numberOfPoints) {
 				this.startIndex = startIndex;
 				this.numberOfPoints = numberOfPoints;
 				WptPt lastPoint = getPoint(startIndex + numberOfPoints - 1);
-				this.windowLength = Math.max(20d, lastPoint.distance / numberOfPoints * 4);
+				this.windowLength = lastPoint.time == 0 ? CALCULATED_GPX_WINDOW_LENGTH : Math.max(20d, lastPoint.distance / numberOfPoints * 4);
 			}
 
 			public ElevationDiffsCalculator(double windowLength, int startIndex, int numberOfPoints) {
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/widgets/ElevationProfileWidget.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/widgets/ElevationProfileWidget.java
index 3dc40cc7f60..ff5a7b67264 100644
--- a/OsmAnd/src/net/osmand/plus/views/mapwidgets/widgets/ElevationProfileWidget.java
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/widgets/ElevationProfileWidget.java
@@ -1,5 +1,7 @@
 package net.osmand.plus.views.mapwidgets.widgets;
 
+import static net.osmand.GPXUtilities.GPXTrackAnalysis.ElevationDiffsCalculator.CALCULATED_GPX_WINDOW_LENGTH;
+
 import android.graphics.Matrix;
 import android.graphics.Typeface;
 import android.graphics.drawable.Drawable;
@@ -385,9 +387,11 @@ private boolean updateWidgets() {
 		}
 		firstVisiblePointIndex = firstPointIndex;
 		lastVisiblePointIndex = lastPointIndex;
-		if (firstPointIndex >= 0 && lastPointIndex > firstPointIndex) {
-			ElevationDiffsCalculator elevationDiffsCalc =
-					new ElevationDiffsCalculator(10d, firstPointIndex, lastPointIndex - firstPointIndex + 1) {
+		firstPointIndex = Math.max(0, firstPointIndex - 1);
+		lastPointIndex = Math.min(points.size() - 1, lastPointIndex + 1);
+		if (lastPointIndex > firstPointIndex) {
+			ElevationDiffsCalculator elevationDiffsCalc = new ElevationDiffsCalculator(
+					CALCULATED_GPX_WINDOW_LENGTH, firstPointIndex, lastPointIndex - firstPointIndex + 1) {
 				@Override
 				public WptPt getPoint(int index) {
 					return points.get(index);
