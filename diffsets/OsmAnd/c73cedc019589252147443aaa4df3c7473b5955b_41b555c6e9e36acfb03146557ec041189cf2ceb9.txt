diff --git a/OsmAnd/res/layout-land/map_hud_bottom.xml b/OsmAnd/res/layout-land/map_hud_bottom.xml
index de70d55d41d..ccaf65e5acf 100644
--- a/OsmAnd/res/layout-land/map_hud_bottom.xml
+++ b/OsmAnd/res/layout-land/map_hud_bottom.xml
@@ -73,6 +73,13 @@
 
             <!-- PREPARATION SCREEN -->
 
+            <include
+                android:layout_width="wrap_content"
+                android:layout_height="wrap_content"
+                android:layout_gravity="bottom|left"
+                android:visibility="gone"
+                layout="@layout/recording_note_fragment" />
+
             <include
                 android:layout_width="@dimen/map_route_planning_land_width"
                 android:layout_height="@dimen/map_route_buttons_height"
diff --git a/OsmAnd/res/layout-land/recording_note_fragment.xml b/OsmAnd/res/layout-land/recording_note_fragment.xml
new file mode 100644
index 00000000000..57593cf2bab
--- /dev/null
+++ b/OsmAnd/res/layout-land/recording_note_fragment.xml
@@ -0,0 +1,133 @@
+<?xml version="1.0" encoding="utf-8"?>
+<FrameLayout
+    android:id="@+id/recording_note_layout"
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    android:layout_width="match_parent"
+    android:layout_height="match_parent"
+    android:layout_gravity="bottom"
+    android:background="?attr/left_menu_view_bg"
+    android:clickable="true"
+    android:visibility="gone"
+    tools:visibility="visible">
+
+    <LinearLayout
+        android:layout_width="match_parent"
+        android:layout_height="match_parent"
+        android:orientation="vertical">
+
+        <LinearLayout
+            android:id="@+id/viewfinder"
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:gravity="center"
+            android:orientation="vertical">
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:id="@+id/buttonsContainer"
+            android:layout_width="match_parent"
+            android:layout_height="@dimen/map_route_buttons_height"
+            android:orientation="horizontal">
+
+            <LinearLayout
+                android:id="@+id/showHideView"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_weight="1"
+                android:background="?attr/selectableItemBackground">
+
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center_vertical"
+                    android:layout_marginLeft="12dp"
+                    android:gravity="left|center_vertical">
+
+                    <ImageView
+                        android:id="@+id/showHideIcon"
+                        android:layout_width="24dp"
+                        android:layout_height="24dp"
+                        android:layout_gravity="center_vertical"
+                        android:scaleType="center"
+                        tools:src="@drawable/ic_action_minimize"/>
+
+                    <TextView
+                        android:id="@+id/showHideText"
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:layout_gravity="center_vertical"
+                        android:layout_marginLeft="8dp"
+                        android:layout_marginRight="8dp"
+                        android:text="@string/shared_string_hide"
+                        android:textColor="?android:textColorSecondary"
+                        android:textSize="@dimen/default_list_text_size"/>
+
+                </LinearLayout>
+
+            </LinearLayout>
+
+            <LinearLayout
+                android:id="@+id/recView"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_weight="1"
+                android:background="?attr/selectableItemBackground">
+
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center_vertical"
+                    android:gravity="center">
+
+                    <ImageView
+                        android:id="@+id/recIcon"
+                        android:layout_width="24dp"
+                        android:layout_height="24dp"
+                        android:layout_gravity="center_vertical"
+                        android:scaleType="center"
+                        tools:src="@drawable/ic_action_rec_stop"/>
+
+                    <TextView
+                        android:id="@+id/recText"
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:layout_gravity="center_vertical"
+                        android:layout_marginLeft="8dp"
+                        android:layout_marginRight="8dp"
+                        android:text="@string/shared_string_control_stop"
+                        android:textColor="?android:textColorSecondary"
+                        android:textSize="@dimen/default_list_text_size"/>
+
+                </LinearLayout>
+
+            </LinearLayout>
+
+            <LinearLayout
+                android:id="@+id/timeView"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center_vertical"
+                android:layout_weight="1">
+
+                <TextView
+                    android:id="@+id/timeText"
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center_vertical"
+                    android:layout_marginLeft="12dp"
+                    android:layout_marginRight="12dp"
+                    android:gravity="right"
+                    android:text="00:00:00"
+                    android:textColor="?android:textColorSecondary"
+                    android:textSize="@dimen/default_list_text_size"/>
+
+            </LinearLayout>
+
+        </LinearLayout>
+
+    </LinearLayout>
+
+</FrameLayout>
\ No newline at end of file
diff --git a/OsmAnd/res/layout/map_hud_bottom.xml b/OsmAnd/res/layout/map_hud_bottom.xml
index 8069c5aed0b..b8bdff8428d 100644
--- a/OsmAnd/res/layout/map_hud_bottom.xml
+++ b/OsmAnd/res/layout/map_hud_bottom.xml
@@ -194,6 +194,7 @@
         android:layout_height="wrap_content" >
 
         <include layout="@layout/map_route_prepare_bottom"/>
+        <include layout="@layout/recording_note_fragment"/>
         <LinearLayout
             android:id="@+id/map_context_menu_layout"
             android:layout_width="match_parent"
diff --git a/OsmAnd/res/layout/recording_note_fragment.xml b/OsmAnd/res/layout/recording_note_fragment.xml
new file mode 100644
index 00000000000..29a580c9477
--- /dev/null
+++ b/OsmAnd/res/layout/recording_note_fragment.xml
@@ -0,0 +1,143 @@
+<?xml version="1.0" encoding="utf-8"?>
+<FrameLayout
+    android:id="@+id/recording_note_layout"
+    xmlns:android="http://schemas.android.com/apk/res/android"
+    xmlns:tools="http://schemas.android.com/tools"
+    android:layout_width="match_parent"
+    android:layout_height="wrap_content"
+    android:layout_below="@id/map_route_preparation_layout"
+    android:layout_gravity="bottom"
+    android:background="?attr/bottom_menu_view_bg"
+    android:clickable="true"
+    android:visibility="gone"
+    tools:visibility="visible">
+
+    <LinearLayout
+        android:layout_width="match_parent"
+        android:layout_height="wrap_content"
+        android:orientation="vertical">
+
+        <LinearLayout
+            android:id="@+id/viewfinder"
+            android:layout_width="match_parent"
+            android:layout_height="240dp"
+            android:gravity="center"
+            android:orientation="vertical">
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:id="@+id/emptyview"
+            android:layout_width="match_parent"
+            android:layout_height="0dp"
+            android:layout_weight="1"
+            android:background="@color/color_transparent"
+            android:visibility="gone"
+            android:orientation="vertical">
+
+        </LinearLayout>
+
+        <LinearLayout
+            android:layout_width="match_parent"
+            android:layout_height="@dimen/map_route_buttons_height"
+            android:orientation="horizontal">
+
+            <LinearLayout
+                android:id="@+id/showHideView"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_weight="1"
+                android:background="?attr/selectableItemBackground">
+
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center_vertical"
+                    android:layout_marginLeft="12dp"
+                    android:gravity="left|center_vertical">
+
+                    <ImageView
+                        android:id="@+id/showHideIcon"
+                        android:layout_width="24dp"
+                        android:layout_height="24dp"
+                        android:layout_gravity="center_vertical"
+                        android:scaleType="center"
+                        tools:src="@drawable/ic_action_minimize"/>
+
+                    <TextView
+                        android:id="@+id/showHideText"
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:layout_gravity="center_vertical"
+                        android:layout_marginLeft="8dp"
+                        android:layout_marginRight="8dp"
+                        android:text="@string/shared_string_hide"
+                        android:textColor="?android:textColorSecondary"
+                        android:textSize="@dimen/default_list_text_size"/>
+
+                </LinearLayout>
+
+            </LinearLayout>
+
+            <LinearLayout
+                android:id="@+id/recView"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_weight="1"
+                android:background="?attr/selectableItemBackground">
+
+                <LinearLayout
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center_vertical"
+                    android:gravity="center">
+
+                    <ImageView
+                        android:id="@+id/recIcon"
+                        android:layout_width="24dp"
+                        android:layout_height="24dp"
+                        android:layout_gravity="center_vertical"
+                        android:scaleType="center"
+                        tools:src="@drawable/ic_action_rec_stop"/>
+
+                    <TextView
+                        android:id="@+id/recText"
+                        android:layout_width="wrap_content"
+                        android:layout_height="wrap_content"
+                        android:layout_gravity="center_vertical"
+                        android:layout_marginLeft="8dp"
+                        android:layout_marginRight="8dp"
+                        android:text="@string/shared_string_control_stop"
+                        android:textColor="?android:textColorSecondary"
+                        android:textSize="@dimen/default_list_text_size"/>
+
+                </LinearLayout>
+
+            </LinearLayout>
+
+            <LinearLayout
+                android:id="@+id/timeView"
+                android:layout_width="0dp"
+                android:layout_height="match_parent"
+                android:layout_gravity="center_vertical"
+                android:layout_weight="1">
+
+                <TextView
+                    android:id="@+id/timeText"
+                    android:layout_width="match_parent"
+                    android:layout_height="wrap_content"
+                    android:layout_gravity="center_vertical"
+                    android:layout_marginLeft="12dp"
+                    android:layout_marginRight="12dp"
+                    android:gravity="right"
+                    android:text="00:00:00"
+                    android:textColor="?android:textColorSecondary"
+                    android:textSize="@dimen/default_list_text_size"/>
+
+            </LinearLayout>
+
+        </LinearLayout>
+
+    </LinearLayout>
+
+</FrameLayout>
\ No newline at end of file
diff --git a/OsmAnd/res/values/strings.xml b/OsmAnd/res/values/strings.xml
index 85c16e4afe2..35609874f3f 100644
--- a/OsmAnd/res/values/strings.xml
+++ b/OsmAnd/res/values/strings.xml
@@ -9,7 +9,16 @@
          3. All your modified/created strings are in the top of the file (to make easier find what\'s translated).
     PLEASE: Have a look at http://code.google.com/p/osmand/wiki/UIConsistency, it may really improve your and our work  :-)  Thx - Hardy
     -->
-    
+
+    <string name="shared_string_hide">Hide</string>
+    <string name="av_video_quality_low">Lowest resolution</string>
+    <string name="av_video_quality_high">Highest resolution</string>
+    <string name="av_video_quality">Video output quality</string>
+    <string name="av_video_quality_descr">Select video output quality</string>
+    <string name="av_audio_format">Audio output format</string>
+    <string name="av_audio_format_descr">Select audio output format</string>
+    <string name="av_audio_bitrate">Audio bitrate</string>
+    <string name="av_audio_bitrate_descr">Select audio bitrate</string>
     <string name="please_specify_poi_type_only_from_list">Please specify the correct POI type or skip it. </string>
     <string name="access_from_map_description">Menu button launches dashboard, not menu</string>
     <string name="access_from_map">Access from map</string>
diff --git a/OsmAnd/src/net/osmand/plus/audionotes/AudioVideoNoteRecordingMenu.java b/OsmAnd/src/net/osmand/plus/audionotes/AudioVideoNoteRecordingMenu.java
new file mode 100644
index 00000000000..efce333129f
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/audionotes/AudioVideoNoteRecordingMenu.java
@@ -0,0 +1,215 @@
+package net.osmand.plus.audionotes;
+
+import android.content.res.Resources;
+import android.os.Handler;
+import android.util.TypedValue;
+import android.view.SurfaceView;
+import android.view.View;
+import android.view.ViewGroup;
+import android.widget.ImageView;
+import android.widget.LinearLayout;
+import android.widget.TextView;
+
+import net.osmand.plus.IconsCache;
+import net.osmand.plus.R;
+import net.osmand.plus.activities.MapActivity;
+import net.osmand.plus.audionotes.AudioVideoNotesPlugin.AVActionType;
+import net.osmand.plus.audionotes.AudioVideoNotesPlugin.CurrentRecording;
+import net.osmand.plus.helpers.AndroidUiHelper;
+import net.osmand.util.Algorithms;
+
+import static android.util.TypedValue.COMPLEX_UNIT_DIP;
+
+public class AudioVideoNoteRecordingMenu {
+
+	private View view;
+	private LinearLayout viewfinder;
+	private AudioVideoNotesPlugin plugin;
+	private long startTime;
+	private Handler handler;
+	private boolean counting;
+	private boolean portraitMode;
+	private boolean largeDevice;
+
+	public static boolean showViewfinder = true;
+
+	public AudioVideoNoteRecordingMenu(AudioVideoNotesPlugin plugin) {
+		this.plugin = plugin;
+		handler = new Handler();
+
+		MapActivity mapActivity = plugin.getMapActivity();
+		portraitMode = AndroidUiHelper.isOrientationPortrait(mapActivity);
+		largeDevice = AndroidUiHelper.isXLargeDevice(mapActivity);
+
+		view = mapActivity.findViewById(R.id.recording_note_layout);
+		viewfinder = (LinearLayout) view.findViewById(R.id.viewfinder);
+		showViewfinder = true;
+
+		update();
+	}
+
+	public SurfaceView prepareSurfaceView() {
+		viewfinder.removeAllViews();
+		SurfaceView surfaceView = new SurfaceView(viewfinder.getContext());
+		surfaceView.setLayoutParams(new LinearLayout.LayoutParams(
+				ViewGroup.LayoutParams.MATCH_PARENT,
+				ViewGroup.LayoutParams.MATCH_PARENT));
+
+		surfaceView.setZOrderMediaOverlay(true);
+		viewfinder.addView(surfaceView);
+		return surfaceView;
+	}
+
+	public boolean isLandscapeLayout() {
+		return !portraitMode && !largeDevice;
+	}
+
+	public void show() {
+		plugin.getMapActivity().getContextMenu().hide();
+		view.setVisibility(View.VISIBLE);
+		if (plugin.getCurrentRecording().getType() != AVActionType.REC_PHOTO) {
+			startCounter();
+		}
+	}
+
+	public void hide() {
+		view.setVisibility(View.GONE);
+		plugin.stopCamera();
+		viewfinder.removeAllViews();
+	}
+
+	public void update() {
+		CurrentRecording recording = plugin.getCurrentRecording();
+		IconsCache iconsCache = plugin.getMapActivity().getMyApplication().getIconsCache();
+
+		ImageView showHideIcon = (ImageView) view.findViewById(R.id.showHideIcon);
+		View showHideView = view.findViewById(R.id.showHideView);
+		if (recording.getType() != AVActionType.REC_AUDIO) {
+			showHideIcon.setImageDrawable(iconsCache.getContentIcon(R.drawable.ic_action_minimize));
+			TextView showHideText = (TextView) view.findViewById(R.id.showHideText);
+			showHideText.setText(showViewfinder ?
+					view.getResources().getString(R.string.shared_string_hide) : view.getResources().getString(R.string.shared_string_show));
+			showHideView.setVisibility(View.VISIBLE);
+			viewfinder.setVisibility(showViewfinder ? View.VISIBLE : View.GONE);
+		} else {
+			showHideView.setVisibility(View.INVISIBLE);
+			viewfinder.setVisibility(View.GONE);
+		}
+		showHideView.setOnClickListener(new View.OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				showHideViewfinder();
+			}
+		});
+
+		View recView = view.findViewById(R.id.recView);
+		ImageView recIcon = (ImageView) view.findViewById(R.id.recIcon);
+		TextView recText = (TextView) view.findViewById(R.id.recText);
+		View timeView = view.findViewById(R.id.timeView);
+		switch (recording.getType()) {
+			case REC_AUDIO:
+			case REC_VIDEO:
+				recIcon.setImageDrawable(iconsCache.getContentIcon(R.drawable.ic_action_rec_stop));
+				recText.setText(view.getResources().getString(R.string.shared_string_control_stop));
+				recText.setVisibility(View.VISIBLE);
+				updateDuration();
+				timeView.setVisibility(View.VISIBLE);
+				break;
+			case REC_PHOTO:
+				recIcon.setImageDrawable(iconsCache.getContentIcon(R.drawable.ic_action_photo_dark));
+				recText.setVisibility(View.GONE);
+				timeView.setVisibility(View.INVISIBLE);
+				break;
+		}
+		recView.setOnClickListener(new View.OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				rec(plugin.getMapActivity());
+			}
+		});
+		applyViewfinderVisibility();
+	}
+
+	public void updateDuration() {
+		TextView timeText = (TextView) view.findViewById(R.id.timeText);
+		int duration = (int) ((System.currentTimeMillis() - startTime) / 1000);
+		timeText.setText(Algorithms.formatDuration(duration));
+	}
+
+	private void applyViewfinderVisibility() {
+		MapActivity mapActivity = plugin.getMapActivity();
+		CurrentRecording recording = plugin.getCurrentRecording();
+		boolean show = showViewfinder && recording != null && recording.getType() != AVActionType.REC_AUDIO;
+		if (isLandscapeLayout() && mapActivity != null) {
+			int buttonsHeight = view.findViewById(R.id.buttonsContainer).getHeight();
+			int tileBoxHeight = mapActivity.getMapView().getCurrentRotatedTileBox().getPixHeight();
+			int h = show ? tileBoxHeight : buttonsHeight;
+			view.setLayoutParams(new LinearLayout.LayoutParams(dpToPx(320f, mapActivity), h));
+			view.requestLayout();
+		}
+		viewfinder.setVisibility(show ? View.VISIBLE : View.GONE);
+	}
+
+	public void showHideViewfinder() {
+		showViewfinder = !showViewfinder;
+		TextView showHideText = (TextView) view.findViewById(R.id.showHideText);
+		showHideText.setText(showViewfinder ? view.getResources().getString(R.string.shared_string_hide) : view.getResources().getString(R.string.shared_string_show));
+		applyViewfinderVisibility();
+	}
+
+	public int getViewfinderWidth() {
+		return viewfinder.getWidth();
+	}
+
+	public int getViewfinderHeight() {
+		return viewfinder.getHeight();
+	}
+
+	public void rec(final MapActivity mapActivity) {
+		stopCounter();
+		handler.postDelayed(new Runnable() {
+			@Override
+			public void run() {
+				CurrentRecording recording = plugin.getCurrentRecording();
+				if (recording != null) {
+					if (recording.getType() == AVActionType.REC_PHOTO) {
+						plugin.shoot();
+					} else {
+						plugin.stopRecording(mapActivity);
+					}
+				}
+			}
+		}, 200);
+	}
+
+	private void startCounter() {
+		startTime = System.currentTimeMillis();
+		counting = true;
+		updateCounter();
+	}
+
+	private void stopCounter() {
+		counting = false;
+	}
+
+	private void updateCounter() {
+		updateDuration();
+		if (counting) {
+			handler.postDelayed(new Runnable() {
+				@Override
+				public void run() {
+					updateCounter();
+				}
+			}, 1000);
+		}
+	}
+
+	private int dpToPx(float dp, MapActivity mapActivity) {
+		Resources r = mapActivity.getResources();
+		return (int) TypedValue.applyDimension(
+				COMPLEX_UNIT_DIP,
+				dp,
+				r.getDisplayMetrics()
+		);
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/audionotes/AudioVideoNotesPlugin.java b/OsmAnd/src/net/osmand/plus/audionotes/AudioVideoNotesPlugin.java
index b9cebf179a3..5daf7066af8 100644
--- a/OsmAnd/src/net/osmand/plus/audionotes/AudioVideoNotesPlugin.java
+++ b/OsmAnd/src/net/osmand/plus/audionotes/AudioVideoNotesPlugin.java
@@ -1,21 +1,21 @@
 package net.osmand.plus.audionotes;
 
 import android.app.Activity;
-import android.app.Dialog;
 import android.content.ComponentName;
 import android.content.Context;
 import android.content.DialogInterface;
 import android.content.DialogInterface.OnClickListener;
 import android.content.Intent;
+import android.content.res.AssetFileDescriptor;
 import android.graphics.Bitmap;
 import android.graphics.BitmapFactory;
 import android.graphics.BitmapFactory.Options;
 import android.graphics.Matrix;
 import android.hardware.Camera;
-import android.hardware.Camera.AutoFocusCallback;
 import android.hardware.Camera.Parameters;
 import android.hardware.Camera.PictureCallback;
 import android.media.AudioManager;
+import android.media.CamcorderProfile;
 import android.media.MediaPlayer;
 import android.media.MediaPlayer.OnPreparedListener;
 import android.media.MediaRecorder;
@@ -58,6 +58,7 @@
 import net.osmand.plus.activities.SavingTrackHelper;
 import net.osmand.plus.activities.TabActivity.TabItem;
 import net.osmand.plus.dashboard.tools.DashFragmentData;
+import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.mapcontextmenu.MapContextMenu;
 import net.osmand.plus.monitoring.OsmandMonitoringPlugin;
 import net.osmand.plus.myplaces.FavoritesActivity;
@@ -104,7 +105,13 @@ public class AudioVideoNotesPlugin extends OsmandPlugin {
 
 	public static final int VIDEO_OUTPUT_MP4 = 0;
 	public static final int VIDEO_OUTPUT_3GP = 1;
+	public static final int VIDEO_QUALITY_DEFAULT = CamcorderProfile.QUALITY_HIGH; // High (highest res)
+	public static final int AUDIO_FORMAT_DEFAULT = MediaRecorder.AudioEncoder.AAC; // AAC
+	public static final int AUDIO_BITRATE_DEFAULT = 64 * 1024; // 64 kbps
 	public final CommonPreference<Integer> AV_VIDEO_FORMAT;
+	public final CommonPreference<Integer> AV_VIDEO_QUALITY;
+	public final CommonPreference<Integer> AV_AUDIO_FORMAT;
+	public final CommonPreference<Integer> AV_AUDIO_BITRATE;
 
 	public static final int AV_DEFAULT_ACTION_AUDIO = 0;
 	public static final int AV_DEFAULT_ACTION_VIDEO = 1;
@@ -134,13 +141,38 @@ public class AudioVideoNotesPlugin extends OsmandPlugin {
 	private DataTileManager<Recording> recordings = new DataTileManager<AudioVideoNotesPlugin.Recording>(14);
 	private Map<String, Recording> recordingByFileName = new LinkedHashMap<>();
 	private AudioNotesLayer audioNotesLayer;
-	private MapActivity activity;
+
+	private MapActivity mapActivity;
+
 	private static File mediaRecFile;
 	private static MediaRecorder mediaRec;
 	private File lastTakingPhoto;
+	private Camera cam;
+	private int requestedOrientation;
+
+	private AudioVideoNoteRecordingMenu recordingMenu;
+	private CurrentRecording currentRecording;
+	private boolean recordingDone;
 
 	private final static char SPLIT_DESC = ' ';
 
+	public enum AVActionType {
+		REC_AUDIO,
+		REC_VIDEO,
+		REC_PHOTO
+	}
+
+	public static class CurrentRecording {
+		private AVActionType type;
+
+		public CurrentRecording(AVActionType type) {
+			this.type = type;
+		}
+		public AVActionType getType() {
+			return type;
+		}
+	}
+
 	public static class Recording {
 		public Recording(File f) {
 			this.file = f;
@@ -438,6 +470,9 @@ public AudioVideoNotesPlugin(OsmandApplication app) {
 		AV_EXTERNAL_RECORDER = settings.registerBooleanPreference("av_external_recorder", false).makeGlobal();
 		AV_EXTERNAL_PHOTO_CAM = settings.registerBooleanPreference("av_external_cam", true).makeGlobal();
 		AV_VIDEO_FORMAT = settings.registerIntPreference("av_video_format", VIDEO_OUTPUT_MP4).makeGlobal();
+		AV_VIDEO_QUALITY = settings.registerIntPreference("av_video_quality", VIDEO_QUALITY_DEFAULT).makeGlobal();
+		AV_AUDIO_FORMAT = settings.registerIntPreference("av_audio_format", AUDIO_FORMAT_DEFAULT).makeGlobal();
+		AV_AUDIO_BITRATE = settings.registerIntPreference("av_audio_bitrate", AUDIO_BITRATE_DEFAULT).makeGlobal();
 		AV_DEFAULT_ACTION = settings.registerIntPreference("av_default_action", AV_DEFAULT_ACTION_CHOOSE).makeGlobal();
 		// camera picture size:
 		AV_CAMERA_PICTURE_SIZE = settings.registerIntPreference("av_camera_picture_size", AV_PHOTO_SIZE_DEFAULT).makeGlobal();
@@ -475,7 +510,7 @@ public boolean init(final OsmandApplication app, Activity activity) {
 
 	@Override
 	public void registerLayers(MapActivity activity) {
-		this.activity = activity;
+		this.mapActivity = activity;
 		if (audioNotesLayer != null) {
 			activity.getMapView().removeLayer(audioNotesLayer);
 		}
@@ -484,6 +519,10 @@ public void registerLayers(MapActivity activity) {
 		registerWidget(activity);
 	}
 
+	public CurrentRecording getCurrentRecording() {
+		return currentRecording;
+	}
+
 	private void registerMediaListener(AudioManager am) {
 
 		ComponentName receiver = new ComponentName(app.getPackageName(), MediaRemoteControlReceiver.class.getName());
@@ -528,6 +567,9 @@ public boolean onContextMenuClick(ArrayAdapter<?> adapter, int itemId, int pos,
 	@Override
 	public void registerMapContextMenuActions(final MapActivity mapActivity, final double latitude, final double longitude,
 											  ContextMenuAdapter adapter, Object selectedObj) {
+		if (isRecording()) {
+			return;
+		}
 		adapter.item(R.string.recording_context_menu_arecord).iconColor(R.drawable.ic_action_micro_dark)
 				.listen(new OnContextMenuClick() {
 
@@ -699,9 +741,9 @@ public void captureVideoExternal(double lat, double lon, final MapActivity mapAc
 		Intent intent = new Intent(MediaStore.ACTION_VIDEO_CAPTURE);
 
 		String ext = MPEG4_EXTENSION;
-		if (AV_VIDEO_FORMAT.get() == VIDEO_OUTPUT_3GP) {
-			ext = THREEGP_EXTENSION;
-		}
+//		if (AV_VIDEO_FORMAT.get() == VIDEO_OUTPUT_3GP) {
+//			ext = THREEGP_EXTENSION;
+//		}
 		Uri fileUri = Uri.fromFile(getBaseFileName(lat, lon, app, ext));
 		intent.putExtra(MediaStore.EXTRA_OUTPUT, fileUri); // set the image file name
 
@@ -713,32 +755,59 @@ public void captureVideoExternal(double lat, double lon, final MapActivity mapAc
 
 	@Override
 	public void mapActivityScreenOff(MapActivity activity) {
-		stopRecording(activity);
+		stopCameraRecording(activity);
 	}
 
 	@Override
 	public void mapActivityResume(MapActivity activity) {
-		this.activity = activity;
-		;
+		this.mapActivity = activity;
 		((AudioManager) activity.getSystemService(Context.AUDIO_SERVICE)).registerMediaButtonEventReceiver(
 				new ComponentName(activity, MediaRemoteControlReceiver.class));
 	}
 
-	public MapActivity getActivity() {
-		return activity;
+	@Override
+	public void mapActivityPause(MapActivity activity) {
+		if (isRecording()) {
+			if (currentRecording.getType() == AVActionType.REC_PHOTO) {
+				recordingMenu.hide();
+			} else {
+				activity.getContextMenu().close();
+				stopRecording(activity);
+			}
+			finishRecording();
+		}
+		this.mapActivity = null;
+	}
+
+	public MapActivity getMapActivity() {
+		return mapActivity;
+	}
+
+	public boolean isRecording() {
+		return currentRecording != null;
+	}
+
+	private void initRecMenu(AVActionType actionType) {
+		currentRecording = new CurrentRecording(actionType);
+		recordingMenu = new AudioVideoNoteRecordingMenu(this);
+		recordingDone = false;
+		lockScreenOrientation();
 	}
 
 	public void recordVideo(final double lat, final double lon, final MapActivity mapActivity) {
 		if (AV_EXTERNAL_RECORDER.get()) {
 			captureVideoExternal(lat, lon, mapActivity);
 		} else {
-			recordVideoCamera(lat, lon, mapActivity);
+			openCamera();
+			if (cam != null) {
+				initRecMenu(AVActionType.REC_VIDEO);
+				recordVideoCamera(lat, lon, mapActivity);
+			}
 		}
 	}
 
 	public void recordVideoCamera(final double lat, final double lon, final MapActivity mapActivity) {
-		final Dialog dlg = new Dialog(mapActivity);
-		SurfaceView view = new SurfaceView(dlg.getContext());
+		SurfaceView view = recordingMenu.prepareSurfaceView();
 		view.getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);
 		view.getHolder().addCallback(new Callback() {
 
@@ -748,25 +817,46 @@ public void surfaceDestroyed(SurfaceHolder holder) {
 
 			@Override
 			public void surfaceCreated(SurfaceHolder holder) {
+
 				MediaRecorder mr = new MediaRecorder();
-				String ext = MPEG4_EXTENSION;
-				if (AV_VIDEO_FORMAT.get() == VIDEO_OUTPUT_3GP) {
-					ext = THREEGP_EXTENSION;
+				try {
+					Parameters parameters = cam.getParameters();
+					int cameraOrientation = getCamOrientation(mapActivity, Camera.CameraInfo.CAMERA_FACING_BACK);
+					cam.setDisplayOrientation(cameraOrientation);
+					parameters.set("rotation", cameraOrientation);
+					//parameters.setPreviewSize(recordingMenu.getViewfinderHeight(), recordingMenu.getViewfinderWidth());
+					cam.setParameters(parameters);
+					cam.setPreviewDisplay(holder);
+					cam.startPreview();
+
+					cam.unlock();
+					mr.setCamera(cam);
+
+				} catch (Exception e) {
+					logErr(e);
+					closeCamera();
 				}
+
+
+				String ext = MPEG4_EXTENSION;
+//				if (AV_VIDEO_FORMAT.get() == VIDEO_OUTPUT_3GP) {
+//					ext = THREEGP_EXTENSION;
+//				}
 				final File f = getBaseFileName(lat, lon, app, ext);
 
 				mr.setAudioSource(MediaRecorder.AudioSource.DEFAULT);
 				mr.setVideoSource(MediaRecorder.VideoSource.CAMERA);
-				if (AV_VIDEO_FORMAT.get() == VIDEO_OUTPUT_3GP) {
-					mr.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);
-				} else {
-					mr.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);
-				}
+//				if (AV_VIDEO_FORMAT.get() == VIDEO_OUTPUT_3GP) {
+//					mr.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);
+//				} else {
+//					mr.setOutputFormat(MediaRecorder.OutputFormat.MPEG_4);
+//				}
 
 				giveMediaRecorderHintRotatedScreen(mapActivity, mr);
-				mr.setPreviewDisplay(holder.getSurface());
-				mr.setAudioEncoder(MediaRecorder.AudioEncoder.DEFAULT);
-				mr.setVideoEncoder(MediaRecorder.VideoEncoder.DEFAULT);
+				//mr.setPreviewDisplay(holder.getSurface());
+
+				CamcorderProfile p = CamcorderProfile.get(AV_VIDEO_QUALITY.get());
+				mr.setProfile(p);
 				mr.setOutputFile(f.getAbsolutePath());
 				try {
 					runMediaRecorder(mapActivity, mr, f);
@@ -779,8 +869,7 @@ public void surfaceCreated(SurfaceHolder holder) {
 			public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) {
 			}
 		});
-		dlg.setContentView(view);
-		dlg.show();
+		recordingMenu.show();
 	}
 
 	private void giveMediaRecorderHintRotatedScreen(final MapActivity mapActivity, final MediaRecorder mr) {
@@ -806,22 +895,63 @@ private void logErr(Exception e) {
 		AccessibleToast.makeText(app, app.getString(R.string.recording_error) + " : " + e.getMessage(), Toast.LENGTH_LONG).show();
 	}
 
-	protected Camera openCamera() {
+	protected void openCamera() {
+		if (cam != null) {
+			try {
+				cam.release();
+				cam = null;
+			} catch (Exception e) {
+				logErr(e);
+			}
+		}
 		try {
-			return Camera.open();
+			cam = Camera.open();
 		} catch (Exception e) {
 			logErr(e);
-			return null;
 		}
 	}
 
-	private void stopRecording(final MapActivity mapActivity) {
+	protected void closeCamera() {
+		if (cam != null) {
+			try {
+				cam.release();
+			} catch (Exception e) {
+				logErr(e);
+			}
+			cam = null;
+		}
+	}
+
+	private void lockScreenOrientation() {
+		requestedOrientation = mapActivity.getRequestedOrientation();
+		mapActivity.setRequestedOrientation(AndroidUiHelper.getScreenOrientation(mapActivity));
+	}
+
+	private void restoreScreenOrientation() {
+		mapActivity.setRequestedOrientation(requestedOrientation);
+	}
+
+	protected void stopCamera() {
+		try {
+			if (cam != null) {
+				cam.stopPreview();
+				cam.setPreviewDisplay(null);
+			}
+		} catch (Exception e) {
+			logErr(e);
+		} finally {
+			closeCamera();
+		}
+	}
+
+	private void stopCameraRecording(final MapActivity mapActivity) {
 		if (mediaRec != null) {
 			mediaRec.stop();
 			mediaRec.release();
 			mediaRec = null;
 			indexFile(true, mediaRecFile);
 			mediaRecFile = null;
+			stopCamera();
 		}
 		if (recordControl != null) {
 			setRecordListener(recordControl, mapActivity);
@@ -829,11 +959,13 @@ private void stopRecording(final MapActivity mapActivity) {
 	}
 
 	public void recordAudio(double lat, double lon, final MapActivity mapActivity) {
+		initRecMenu(AVActionType.REC_AUDIO);
 		MediaRecorder mr = new MediaRecorder();
 		final File f = getBaseFileName(lat, lon, app, THREEGP_EXTENSION);
 		mr.setAudioSource(MediaRecorder.AudioSource.MIC);
 		mr.setOutputFormat(MediaRecorder.OutputFormat.THREE_GPP);
-		mr.setAudioEncoder(MediaRecorder.AudioEncoder.DEFAULT);
+		mr.setAudioEncoder(AV_AUDIO_FORMAT.get());
+		mr.setAudioEncodingBitRate(AV_AUDIO_BITRATE.get());
 		mr.setOutputFile(f.getAbsolutePath());
 		try {
 			runMediaRecorder(mapActivity, mr, f);
@@ -848,21 +980,20 @@ public void takePhoto(final double lat, final double lon, final MapActivity mapA
 		if (AV_EXTERNAL_PHOTO_CAM.get()) {
 			takeIntentPhoto(lat, lon, mapActivity);
 		} else {
-			final Camera cam = openCamera();
+			openCamera();
 			if (cam != null) {
-				takePhotoWithCamera(lat, lon, mapActivity, cam);
+				initRecMenu(AVActionType.REC_PHOTO);
+				takePhotoWithCamera(lat, lon, mapActivity);
 			} else {
 				takeIntentPhoto(lat, lon, mapActivity);
 			}
 		}
 	}
 
-	private void takePhotoWithCamera(final double lat, final double lon, final MapActivity mapActivity, final Camera cam) {
+	private void takePhotoWithCamera(final double lat, final double lon, final MapActivity mapActivity) {
 		try {
-			final Dialog dlg = new Dialog(mapActivity);
-			final File f = getBaseFileName(lat, lon, app, IMG_EXTENSION);
-			lastTakingPhoto = f;
-			SurfaceView view = new SurfaceView(dlg.getContext());
+			lastTakingPhoto = getBaseFileName(lat, lon, app, IMG_EXTENSION);
+			final SurfaceView view = recordingMenu.prepareSurfaceView();
 			view.getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);
 			view.getHolder().addCallback(new Callback() {
 
@@ -870,55 +1001,29 @@ private void takePhotoWithCamera(final double lat, final double lon, final MapAc
 				public void surfaceDestroyed(SurfaceHolder holder) {
 				}
 
-				public void setCameraDisplayOrientation(android.hardware.Camera camera, Parameters parameters) {
-					// android.hardware.Camera.CameraInfo info =
-					// new android.hardware.Camera.CameraInfo();
-					// android.hardware.Camera.getCameraInfo(cameraId, info);
-					int rotation = mapActivity.getWindowManager().getDefaultDisplay().getRotation();
-					int degrees = 0;
-					switch (rotation) {
-						case /* Surface.ROTATION_0 */ 0:
-							degrees = 0;
-							break;
-						case /* Surface.ROTATION_90 */ 1:
-							degrees = 90;
-							break;
-						case /* Surface.ROTATION_180 */ 2:
-							degrees = 180;
-							break;
-						case /* Surface.ROTATION_270 */ 3:
-							degrees = 270;
-							break;
-					}
-
-					// if (info.facing == Camera.CameraInfo.CAMERA_FACING_FRONT) {
-					// result = (info.orientation + degrees) % 360;
-					// result = (360 - result) % 360; // compensate the mirror
-					// } else { // back-facing
-					// result = (info.orientation - degrees + 360) % 360;
-					// }
-					// API 8
-					// camera.setDisplayOrientation((90 + 360 - degrees) % 360);
-					parameters.set("rotation", (90 + 360 - degrees) % 360);
-				}
-
 				@Override
 				public void surfaceCreated(SurfaceHolder holder) {
 					try {
-						// load sound befor shot:
+						// load sound befor shot
 						if (AV_PHOTO_PLAY_SOUND.get()) {
 							if (sp == null)
 								sp = new SoundPool(5, AudioManager.STREAM_MUSIC, 0);
 							log.info("Play sound on photo");
 							if (shotId == 0) {
-								shotId = sp.load(app.getAssets().openFd("sounds/camera_click.ogg"), 1);
-								log.debug("loaded file sound ID: " + shotId);
+								try {
+									AssetFileDescriptor assetFileDescriptor = app.getAssets().openFd("sounds/camera_click.ogg");
+									shotId = sp.load(assetFileDescriptor, 1);
+									assetFileDescriptor.close();
+									log.debug("loaded file sound ID: " + shotId);
+								} catch (Exception e) {
+									log.error("cannot get shotId for sounds/camera_click.ogg");
+								}
 							}
 						}
 
 						Parameters parameters = cam.getParameters();
 
-						// camera picture size:
+						// camera picture size
 						List<Camera.Size> psps = parameters.getSupportedPictureSizes();
 						int index = AV_CAMERA_PICTURE_SIZE.get();
 						log.debug("takePhotoWithCamera() index=" + index);
@@ -932,7 +1037,7 @@ public void surfaceCreated(SurfaceHolder holder) {
 						log.debug("takePhotoWithCamera() set Picture size: width=" + selectedCamPicSize.width
 								+ " height=" + selectedCamPicSize.height);
 
-						// camera focus type:
+						// camera focus type
 						boolean autofocus = true;
 						// boolean autofocus = !Boolean.parseBoolean(parameters.get("auto-exposure-lock-supported"));
 						parameters.setGpsLatitude(lat);
@@ -973,24 +1078,23 @@ public void surfaceCreated(SurfaceHolder holder) {
 						parameters.setWhiteBalance(Parameters.WHITE_BALANCE_AUTO);
 						parameters.setFlashMode(Parameters.FLASH_MODE_AUTO);
 
-						setCameraDisplayOrientation(cam, parameters);
+						int cameraOrientation = getCamOrientation(mapActivity, Camera.CameraInfo.CAMERA_FACING_BACK);
+						cam.setDisplayOrientation(cameraOrientation);
+						parameters.set("rotation", cameraOrientation);
+						if (cameraOrientation == 0 || cameraOrientation == 180) {
+							parameters.setPreviewSize(recordingMenu.getViewfinderWidth(), recordingMenu.getViewfinderHeight());
+						} else {
+							parameters.setPreviewSize(recordingMenu.getViewfinderHeight(), recordingMenu.getViewfinderWidth());
+						}
 						cam.setParameters(parameters);
 						cam.setPreviewDisplay(holder);
 						cam.startPreview();
-						if (!autofocus) {
-							printCamParams(parameters, !autofocus);
-							cam.takePicture(null, null, new AudioVideoPhotoHandler(dlg, f));
-						} else {
-							cam.autoFocus(new AutoFocusCallback() {
-								@Override
-								public void onAutoFocus(boolean success, Camera camera) {
-									cam.takePicture(null, null, new AudioVideoPhotoHandler(dlg, f));
-								}
-							});
+						if (autofocus) {
+							cam.autoFocus(null);
 						}
 					} catch (Exception e) {
 						logErr(e);
-						cam.release();
+						closeCamera();
 						e.printStackTrace();
 					}
 				}
@@ -1003,11 +1107,57 @@ private void printCamParams(Parameters parameters, boolean autoExposure) {
 				public void surfaceChanged(SurfaceHolder holder, int format, int width, int height) {
 				}
 			});
-			dlg.setContentView(view);
-			dlg.show();
+
+			recordingMenu.show();
+
 		} catch (RuntimeException e) {
 			logErr(e);
-			cam.release();
+			closeCamera();
+		}
+	}
+
+	private static int getCamOrientation(MapActivity mapActivity, int cameraId) {
+		android.hardware.Camera.CameraInfo info =
+				new android.hardware.Camera.CameraInfo();
+		android.hardware.Camera.getCameraInfo(cameraId, info);
+		int rotation = mapActivity.getWindowManager().getDefaultDisplay()
+				.getRotation();
+		int degrees = 0;
+		switch (rotation) {
+			case Surface.ROTATION_0:
+				degrees = 0;
+				break;
+			case Surface.ROTATION_90:
+				degrees = 90;
+				break;
+			case Surface.ROTATION_180:
+				degrees = 180;
+				break;
+			case Surface.ROTATION_270:
+				degrees = 270;
+				break;
+		}
+
+		int result;
+		if (info.facing == Camera.CameraInfo.CAMERA_FACING_FRONT) {
+			result = (info.orientation + degrees) % 360;
+			result = (360 - result) % 360;  // compensate the mirror
+		} else {  // back-facing
+			result = (info.orientation - degrees + 360) % 360;
+		}
+		return result;
+	}
+
+	public void shoot() {
+		if (!recordingDone) {
+			recordingDone = true;
+			if (cam != null && lastTakingPhoto != null) {
+				try {
+					cam.takePicture(null, null, new AudioVideoPhotoHandler(lastTakingPhoto));
+				} catch (RuntimeException e) {
+					closeCamera();
+				}
+			}
 		}
 	}
 
@@ -1030,48 +1180,55 @@ private void runMediaRecorder(final MapActivity mapActivity, MediaRecorder mr, f
 		mediaRec = mr;
 		mediaRecFile = f;
 
+		recordingMenu.show();
 		updateRecordControl(mapActivity, f);
 	}
 
 	private void updateRecordControl(final MapActivity mapActivity, final File f) {
 		recordControl.setText(app.getString(R.string.shared_string_control_stop), "");
-		recordControl.setImageDrawable(activity.getResources().getDrawable(R.drawable.widget_icon_av_active));
+		recordControl.setImageDrawable(mapActivity.getResources().getDrawable(R.drawable.widget_icon_av_active));
 		final MapInfoLayer mil = mapActivity.getMapLayers().getMapInfoLayer();
-		final boolean contains = recordControl.isVisible();
-		if (!contains) {
+		if (!recordControl.isVisible()) {
 			recordControl.setExplicitlyVisible(true);
 			mil.recreateControls();
 			mapActivity.getMapView().refreshMap(true);
 		}
-		AccessibleToast.makeText(mapActivity, R.string.recording_is_recorded, Toast.LENGTH_LONG).show();
 		recordControl.setOnClickListener(new View.OnClickListener() {
 			@Override
 			public void onClick(View v) {
-				if (!contains) {
-					recordControl.setExplicitlyVisible(false);
-					mil.recreateControls();
-				}
 				stopRecording(mapActivity);
-				SHOW_RECORDINGS.set(true);
-				mapActivity.getMapView().refreshMap();
-				updateWidgetIcon(recordControl);
 			}
 		});
 	}
 
-	private void updateContextMenu(Recording rec) {
-		if (activity != null) {
-			MapContextMenu menu = activity.getContextMenu();
-			if (menu.isVisible()) {
-				if (rec != null) {
-					menu.show(new LatLon(rec.lat, rec.lon), audioNotesLayer.getObjectName(rec), rec);
-				} else {
-					menu.close();
-				}
+	public void stopRecording(final MapActivity mapActivity) {
+		if (!recordingDone) {
+			recordingDone = true;
+			if (!recordControl.isVisible()) {
+				recordControl.setExplicitlyVisible(false);
+				mapActivity.getMapLayers().getMapInfoLayer().recreateControls();
 			}
+			stopCameraRecording(mapActivity);
+			SHOW_RECORDINGS.set(true);
+			mapActivity.getMapView().refreshMap();
+			updateWidgetIcon(recordControl);
+			recordingMenu.hide();
+			recordingMenu = null;
+			restoreScreenOrientation();
+		}
+	}
+
+	private void updateContextMenu(Recording rec) {
+		if (mapActivity != null && rec != null) {
+			MapContextMenu menu = mapActivity.getContextMenu();
+			menu.show(new LatLon(rec.lat, rec.lon), audioNotesLayer.getObjectName(rec), rec);
 		}
 	}
 
+	private void finishRecording() {
+		currentRecording = null;
+	}
+
 	@Override
 	public void addMyPlacesTab(FavoritesActivity favoritesActivity, List<TabItem> mTabs, Intent intent) {
 		if (getAllRecordings().size() > 0) {
@@ -1115,13 +1272,16 @@ public boolean indexSingleFile(File f) {
 		newMap.put(f.getName(), r);
 		recordingByFileName = newMap;
 
-		final Recording recordingForMenu = r;
-		app.runInUIThread(new Runnable() {
-			@Override
-			public void run() {
-				updateContextMenu(recordingForMenu);
-			}
-		}, 200);
+		if (isRecording()) {
+			finishRecording();
+			final Recording recordingForMenu = r;
+			app.runInUIThread(new Runnable() {
+				@Override
+				public void run() {
+					updateContextMenu(recordingForMenu);
+				}
+			}, 200);
+		}
 
 		return true;
 	}
@@ -1196,9 +1356,9 @@ public void deleteRecording(Recording r) {
 		newMap.remove(r.file.getName());
 		recordingByFileName = newMap;
 		Algorithms.removeAllFiles(r.file);
-		if (activity != null) {
-			activity.getContextMenu().close();
-			activity.getMapView().refreshMap();
+		if (mapActivity != null) {
+			mapActivity.getContextMenu().close();
+			mapActivity.getMapView().refreshMap();
 		}
 	}
 
@@ -1217,7 +1377,7 @@ public void onMapActivityExternalResult(int requestCode, int resultCode, Intent
 
 	public boolean onMapActivityKeyEvent(KeyEvent key) {
 		if (KeyEvent.KEYCODE_CAMERA == key.getKeyCode()) {
-			defaultAction(activity);
+			defaultAction(mapActivity);
 			return true;
 		}
 		return false;
@@ -1245,6 +1405,24 @@ public int compare(Recording object1, Recording object2) {
 	}
 
 	public void playRecording(final Context ctx, final Recording r) {
+		if (r.isVideo()) {
+			Intent vint = new Intent(Intent.ACTION_VIEW);
+			vint.setDataAndType(Uri.fromFile(r.file), "video/*");
+			vint.setFlags(0x10000000);
+			try {
+				ctx.startActivity(vint);
+			} catch (Exception e) {
+				e.printStackTrace();
+			}
+			return;
+		} else if (r.isPhoto()) {
+			Intent vint = new Intent(Intent.ACTION_VIEW);
+			vint.setDataAndType(Uri.fromFile(r.file), "image/*");
+			vint.setFlags(0x10000000);
+			ctx.startActivity(vint);
+			return;
+		}
+
 		final MediaPlayer player = r.isPhoto() ? null : new MediaPlayer();
 		final AccessibleAlertBuilder dlg = new AccessibleAlertBuilder(ctx);
 		dlg.setPositiveButton(R.string.recording_open_external_player, new OnClickListener() {
@@ -1328,10 +1506,8 @@ public boolean mapActivityKeyUp(MapActivity mapActivity, int keyCode) {
 
 	public class AudioVideoPhotoHandler implements PictureCallback {
 		private File pictureFile;
-		private Dialog dlg;
 
-		public AudioVideoPhotoHandler(Dialog dlg, File fileName) {
-			this.dlg = dlg;
+		public AudioVideoPhotoHandler(File fileName) {
 			this.pictureFile = fileName;
 		}
 
@@ -1342,7 +1518,6 @@ public void onPictureTaken(byte[] data, Camera camera) {
 				fos.write(data);
 				fos.close();
 				indexFile(true, pictureFile);
-				dlg.dismiss();
 				// play sound after photo - sound file must be loaded at this time:
 				if (AV_PHOTO_PLAY_SOUND.get()) {
 					if (sp != null && shotId != 0) {
@@ -1360,7 +1535,17 @@ public void onPictureTaken(byte[] data, Camera camera) {
 			} catch (Exception error) {
 				logErr(error);
 			} finally {
-				camera.release();
+				if (mapActivity != null) {
+					mapActivity.runOnUiThread(new Runnable() {
+						@Override
+						public void run() {
+							recordingMenu.hide();
+							recordingMenu = null;
+							restoreScreenOrientation();
+						}
+					});
+				}
+				closeCamera();
 			}
 		}
 	}
diff --git a/OsmAnd/src/net/osmand/plus/audionotes/SettingsAudioVideoActivity.java b/OsmAnd/src/net/osmand/plus/audionotes/SettingsAudioVideoActivity.java
index 1473619e88f..fafa04d24f8 100644
--- a/OsmAnd/src/net/osmand/plus/audionotes/SettingsAudioVideoActivity.java
+++ b/OsmAnd/src/net/osmand/plus/audionotes/SettingsAudioVideoActivity.java
@@ -1,42 +1,51 @@
 package net.osmand.plus.audionotes;
 
+import android.hardware.Camera;
+import android.hardware.Camera.Parameters;
+import android.media.CamcorderProfile;
+import android.media.MediaRecorder;
+import android.os.Build;
+import android.os.Bundle;
+import android.preference.ListPreference;
+import android.preference.PreferenceCategory;
+import android.preference.PreferenceScreen;
+import android.widget.TextView;
+
+import net.osmand.PlatformUtil;
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.OsmandPlugin;
+import net.osmand.plus.R;
+import net.osmand.plus.activities.SettingsBaseActivity;
+
+import org.apache.commons.logging.Log;
+
+import java.util.ArrayList;
+import java.util.List;
+
+import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AUDIO_BITRATE_DEFAULT;
+import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_AUTO;
+import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_CONTINUOUS;
+import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_EDOF;
+import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_HIPERFOCAL;
+import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_INFINITY;
+import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_MACRO;
 import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_DEFAULT_ACTION_AUDIO;
 import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_DEFAULT_ACTION_CHOOSE;
 import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_DEFAULT_ACTION_TAKEPICTURE;
 import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_DEFAULT_ACTION_VIDEO;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.VIDEO_OUTPUT_3GP;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.VIDEO_OUTPUT_MP4;
-// camera picture size:
 import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.cameraPictureSizeDefault;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_PHOTO_SIZE_DEFAULT;
+
+// camera picture size:
 // support camera focus select:
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_AUTO;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_HIPERFOCAL;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_EDOF;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_INFINITY;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_MACRO;
-import static net.osmand.plus.audionotes.AudioVideoNotesPlugin.AV_CAMERA_FOCUS_CONTINUOUS;
 ////
-import net.osmand.plus.OsmandApplication;
-import org.apache.commons.logging.Log;
-import net.osmand.PlatformUtil;
-import java.util.List;
-import java.util.ArrayList;
-import android.hardware.Camera.Parameters;
-import android.hardware.Camera;
-import net.osmand.plus.OsmandPlugin;
-import net.osmand.plus.R;
-import net.osmand.plus.activities.SettingsBaseActivity;
-import android.os.Bundle;
-import android.preference.ListPreference;
-import android.preference.PreferenceScreen;
+
 public class SettingsAudioVideoActivity extends SettingsBaseActivity {
 
 	private static final Log log = PlatformUtil.getLog(AudioVideoNotesPlugin.class);
 
 
 	@Override
-    public void onCreate(Bundle savedInstanceState) {
+	public void onCreate(Bundle savedInstanceState) {
 		((OsmandApplication) getApplication()).applyTheme(this);
 		super.onCreate(savedInstanceState);
 		getToolbar().setTitle(R.string.av_settings);
@@ -46,96 +55,96 @@ public void onCreate(Bundle savedInstanceState) {
 			String[] entries;
 			Integer[] intValues;
 
-			entries = new String[] { getString(R.string.av_def_action_choose), getString(R.string.av_def_action_audio),
-					getString(R.string.av_def_action_video), getString(R.string.av_def_action_picture) };
-			intValues = new Integer[] { AV_DEFAULT_ACTION_CHOOSE, AV_DEFAULT_ACTION_AUDIO, AV_DEFAULT_ACTION_VIDEO,
-					AV_DEFAULT_ACTION_TAKEPICTURE };
+			entries = new String[]{getString(R.string.av_def_action_choose), getString(R.string.av_def_action_audio),
+					getString(R.string.av_def_action_video), getString(R.string.av_def_action_picture)};
+			intValues = new Integer[]{AV_DEFAULT_ACTION_CHOOSE, AV_DEFAULT_ACTION_AUDIO, AV_DEFAULT_ACTION_VIDEO,
+					AV_DEFAULT_ACTION_TAKEPICTURE};
 			ListPreference defAct = createListPreference(p.AV_DEFAULT_ACTION, entries, intValues, R.string.av_widget_action,
 					R.string.av_widget_action_descr);
 			grp.addPreference(defAct);
+
+			PreferenceCategory photo = new PreferenceCategory(this);
+			photo.setTitle(R.string.shared_string_photo);
+			grp.addPreference(photo);
+
 			final Camera cam = openCamera();
 			if (cam != null) {
-				// camera type settings:
-				grp.addPreference(createCheckBoxPreference(p.AV_EXTERNAL_PHOTO_CAM, R.string.av_use_external_camera,
+				// camera type settings
+				photo.addPreference(createCheckBoxPreference(p.AV_EXTERNAL_PHOTO_CAM, R.string.av_use_external_camera,
 						R.string.av_use_external_camera_descr));
 
 				Parameters parameters = cam.getParameters();
 
 				// Photo picture size
-				// get supported sizes:
+				// get supported sizes
 				List<Camera.Size> psps = parameters.getSupportedPictureSizes();
-				// list of megapixels of each resolution:
+				// list of megapixels of each resolution
 				List<Integer> mpix = new ArrayList<Integer>();
-				// list of index each resolution in list, returned by getSupportedPictureSizes():
+				// list of index each resolution in list, returned by getSupportedPictureSizes()
 				List<Integer> picSizesValues = new ArrayList<Integer>();
-				// fill lists for sort:
+				// fill lists for sort
 				for (int index = 0; index < psps.size(); index++) {
-					mpix.add( (psps.get(index)).width*(psps.get(index)).height );
+					mpix.add((psps.get(index)).width * (psps.get(index)).height);
 					picSizesValues.add(index);
 				}
-				// sort list for max resolution in begining of list:
-				for (int i=0; i < mpix.size(); i++ )
-				{
-					for (int j=0; j < mpix.size() - i - 1; j++ )
-					{
-						if ( mpix.get(j) < mpix.get( j + 1 ) )
-						{
-							// change elements:
-							int tmp=mpix.get( j + 1 );
-							mpix.set( j + 1, mpix.get( j ) );
-							mpix.set( j, tmp );
-
-							tmp=picSizesValues.get( j + 1 );
-							picSizesValues.set( j + 1, picSizesValues.get( j ) );
-							picSizesValues.set( j, tmp );
+				// sort list for max resolution in begining of list
+				for (int i = 0; i < mpix.size(); i++) {
+					for (int j = 0; j < mpix.size() - i - 1; j++) {
+						if (mpix.get(j) < mpix.get(j + 1)) {
+							// change elements
+							int tmp = mpix.get(j + 1);
+							mpix.set(j + 1, mpix.get(j));
+							mpix.set(j, tmp);
+
+							tmp = picSizesValues.get(j + 1);
+							picSizesValues.set(j + 1, picSizesValues.get(j));
+							picSizesValues.set(j, tmp);
 						}
 					}
 				}
-				// set default photo size to max resolution (set index of element with max resolution in List, returned by getSupportedPictureSizes() ):
+				// set default photo size to max resolution (set index of element with max resolution in List, returned by getSupportedPictureSizes() )
 				cameraPictureSizeDefault = picSizesValues.get(0);
 				log.debug("onCreate() set cameraPictureSizeDefault=" + cameraPictureSizeDefault);
 
 				List<String> itemsPicSizes = new ArrayList<String>();
 				String prefix;
 				for (int index = 0; index < psps.size(); index++) {
-					float px=(float)((psps.get( picSizesValues.get(index) )).width*(psps.get( picSizesValues.get(index) )).height);
-					if(px>102400) // 100 K
+					float px = (float) ((psps.get(picSizesValues.get(index))).width * (psps.get(picSizesValues.get(index))).height);
+					if (px > 102400) // 100 K
 					{
-						px=px/1048576;
-						prefix="Mpx";
+						px = px / 1048576;
+						prefix = "Mpx";
+					} else {
+						px = px / 1024;
+						prefix = "Kpx";
 					}
-					else
-						{
-							px=px/1024;
-							prefix="Kpx";
-						}
 
-					itemsPicSizes.add( (psps.get( picSizesValues.get(index) )).width + 
-						"x" + 
-						(psps.get( picSizesValues.get(index) )).height + 
-						" ( " +
-						String.format("%.2f", px ) +
-						" " +
-						prefix +
-						" )");
+					itemsPicSizes.add((psps.get(picSizesValues.get(index))).width +
+							"x" +
+							(psps.get(picSizesValues.get(index))).height +
+							" ( " +
+							String.format("%.2f", px) +
+							" " +
+							prefix +
+							" )");
 				}
-				log.debug("onCreate() set default size: width=" + psps.get( cameraPictureSizeDefault ).width + " height=" 
-					+ psps.get( cameraPictureSizeDefault ).height + " index in ps=" + cameraPictureSizeDefault );
+				log.debug("onCreate() set default size: width=" + psps.get(cameraPictureSizeDefault).width + " height="
+						+ psps.get(cameraPictureSizeDefault).height + " index in ps=" + cameraPictureSizeDefault);
 
 				entries = itemsPicSizes.toArray(new String[itemsPicSizes.size()]);
 				intValues = picSizesValues.toArray(new Integer[picSizesValues.size()]);
 				if (entries.length > 0) {
 					ListPreference camSizes = createListPreference(p.AV_CAMERA_PICTURE_SIZE, entries, intValues, R.string.av_camera_pic_size,
 							R.string.av_camera_pic_size_descr);
-					grp.addPreference(camSizes);
+					photo.addPreference(camSizes);
 				}
 
-				// focus mode settings:
-				// show in menu only suppoted modes:
+				// focus mode settings
+				// show in menu only suppoted modes
 				List<String> sfm = parameters.getSupportedFocusModes();
 				List<String> items = new ArrayList<String>();
 				List<Integer> itemsValues = new ArrayList<Integer>();
-				// filtering known types for translate and set index:
+				// filtering known types for translate and set index
 				for (int index = 0; index < sfm.size(); index++) {
 					if (sfm.get(index).equals("auto")) {
 						items.add(getString(R.string.av_camera_focus_auto));
@@ -162,31 +171,89 @@ public void onCreate(Bundle savedInstanceState) {
 				if (entries.length > 0) {
 					ListPreference camFocus = createListPreference(p.AV_CAMERA_FOCUS_TYPE, entries, intValues, R.string.av_camera_focus,
 							R.string.av_camera_focus_descr);
-					grp.addPreference(camFocus);
+					photo.addPreference(camFocus);
 				}
 
-				// play sound on success photo:
-				grp.addPreference(createCheckBoxPreference(p.AV_PHOTO_PLAY_SOUND, R.string.av_photo_play_sound,
+				// play sound on success photo
+				photo.addPreference(createCheckBoxPreference(p.AV_PHOTO_PLAY_SOUND, R.string.av_photo_play_sound,
 						R.string.av_photo_play_sound_descr));
 
 				cam.release();
 			}
-			// video settings:
-			grp.addPreference(createCheckBoxPreference(p.AV_EXTERNAL_RECORDER, R.string.av_use_external_recorder,
+
+			// video settings
+			PreferenceCategory video = new PreferenceCategory(this);
+			video.setTitle(R.string.shared_string_video);
+			grp.addPreference(video);
+
+			video.addPreference(createCheckBoxPreference(p.AV_EXTERNAL_RECORDER, R.string.av_use_external_recorder,
 					R.string.av_use_external_recorder_descr));
-			
-			entries = new String[] { "3GP", "MP4" };
-			intValues = new Integer[] { VIDEO_OUTPUT_3GP, VIDEO_OUTPUT_MP4 };
-			ListPreference lp = createListPreference(p.AV_VIDEO_FORMAT, entries, intValues, R.string.av_video_format,
-					R.string.av_video_format_descr);
-			grp.addPreference(lp);
+
+//			entries = new String[] { "3GP", "MP4" };
+//			intValues = new Integer[] { VIDEO_OUTPUT_3GP, VIDEO_OUTPUT_MP4 };
+//			ListPreference lp = createListPreference(p.AV_VIDEO_FORMAT, entries, intValues, R.string.av_video_format,
+//					R.string.av_video_format_descr);
+//			video.addPreference(lp);
+
+			List<String> qNames = new ArrayList<>();
+			List<Integer> qValues = new ArrayList<>();
+			if (CamcorderProfile.hasProfile(CamcorderProfile.QUALITY_LOW)) {
+				qNames.add(getString(R.string.av_video_quality_low));
+				qValues.add(CamcorderProfile.QUALITY_LOW);
+			}
+			if (CamcorderProfile.hasProfile(CamcorderProfile.QUALITY_HIGH)) {
+				qNames.add(getString(R.string.av_video_quality_high));
+				qValues.add(CamcorderProfile.QUALITY_HIGH);
+			}
+			if (CamcorderProfile.hasProfile(CamcorderProfile.QUALITY_480P)) {
+				qNames.add("720 x 480 (480p)");
+				qValues.add(CamcorderProfile.QUALITY_480P);
+			}
+			if (CamcorderProfile.hasProfile(CamcorderProfile.QUALITY_720P)) {
+				qNames.add("1280 x 720 (720p)");
+				qValues.add(CamcorderProfile.QUALITY_720P);
+			}
+			if (CamcorderProfile.hasProfile(CamcorderProfile.QUALITY_1080P)) {
+				qNames.add("1920 x 1080 (1080p)");
+				qValues.add(CamcorderProfile.QUALITY_1080P);
+			}
+			if (Build.VERSION.SDK_INT >= 21 && CamcorderProfile.hasProfile(CamcorderProfile.QUALITY_2160P)) {
+				qNames.add("3840x2160 (2160p)");
+				qValues.add(CamcorderProfile.QUALITY_2160P);
+			}
+
+			ListPreference lp = createListPreference(p.AV_VIDEO_QUALITY,
+					qNames.toArray(new String[qNames.size()]),
+					qValues.toArray(new Integer[qValues.size()]),
+					R.string.av_video_quality,
+					R.string.av_video_quality_descr);
+			video.addPreference(lp);
+
+			// audio settings
+			PreferenceCategory audio = new PreferenceCategory(this);
+			audio.setTitle(R.string.shared_string_audio);
+			grp.addPreference(audio);
+
+			entries = new String[] { "Default", "AAC" };
+			intValues = new Integer[] { MediaRecorder.AudioEncoder.DEFAULT, MediaRecorder.AudioEncoder.AAC };
+			lp = createListPreference(p.AV_AUDIO_FORMAT, entries, intValues,
+					R.string.av_audio_format,
+					R.string.av_audio_format_descr);
+			audio.addPreference(lp);
+
+			entries = new String[] { "Default", "16 kbps", "32 kbps", "48 kbps", "64 kbps", "96 kbps", "128 kbps" };
+			intValues = new Integer[] { AUDIO_BITRATE_DEFAULT, 16 * 1024, 32 * 1024, 48 * 1024, 64 * 1024, 96 * 1024, 128 * 1024 };
+			lp = createListPreference(p.AV_AUDIO_BITRATE, entries, intValues,
+					R.string.av_audio_bitrate,
+					R.string.av_audio_bitrate_descr);
+			audio.addPreference(lp);
 		}
 	}
 
 	protected Camera openCamera() {
 		try {
 			return Camera.open();
-		} catch (Exception e ){
+		} catch (Exception e) {
 			log.error("Error open camera", e);
 			return null;
 		}
