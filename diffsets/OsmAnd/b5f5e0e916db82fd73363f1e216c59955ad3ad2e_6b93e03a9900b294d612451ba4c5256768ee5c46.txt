diff --git a/OsmAnd/res/layout/fragment_import.xml b/OsmAnd/res/layout/fragment_import.xml
index adb5757830f..792f7db928e 100644
--- a/OsmAnd/res/layout/fragment_import.xml
+++ b/OsmAnd/res/layout/fragment_import.xml
@@ -49,11 +49,7 @@
 		android:textSize="@dimen/default_list_text_size"
 		osmand:typeface="@string/font_roboto_medium" />
 
-	<include
-		android:id="@+id/description_divider"
-		layout="@layout/card_bottom_divider"
-		android:layout_width="match_parent"
-		android:layout_height="wrap_content"/>
+	<include layout="@layout/card_bottom_divider" />
 
 	<ExpandableListView
 		android:id="@+id/list"
@@ -66,6 +62,8 @@
 		android:groupIndicator="@android:color/transparent"
 		android:listSelector="@android:color/transparent" />
 
+	<include layout="@layout/card_top_divider" />
+
 	<LinearLayout
 		android:id="@+id/buttons_container"
 		android:layout_width="match_parent"
diff --git a/OsmAnd/res/layout/fragment_import_duplicates.xml b/OsmAnd/res/layout/fragment_import_duplicates.xml
index 16f45a773f4..6682b698386 100644
--- a/OsmAnd/res/layout/fragment_import_duplicates.xml
+++ b/OsmAnd/res/layout/fragment_import_duplicates.xml
@@ -49,9 +49,7 @@
 
 	<include
 		android:id="@+id/description_divider"
-		layout="@layout/card_bottom_divider"
-		android:layout_width="match_parent"
-		android:layout_height="wrap_content" />
+		layout="@layout/card_bottom_divider" />
 
 	<android.support.v7.widget.RecyclerView
 		android:id="@+id/list"
@@ -59,6 +57,9 @@
 		android:layout_height="0dp"
 		android:layout_weight="1" />
 
+	<include
+		layout="@layout/card_top_divider" />
+
 	<LinearLayout
 		android:layout_width="match_parent"
 		android:layout_height="wrap_content"
diff --git a/OsmAnd/res/values/strings.xml b/OsmAnd/res/values/strings.xml
index 8a38a38ea47..f2ef6809c63 100644
--- a/OsmAnd/res/values/strings.xml
+++ b/OsmAnd/res/values/strings.xml
@@ -11,6 +11,7 @@
 	Thx - Hardy
 
 -->
+    <string name="shared_sting_preparing">Preparing</string>
     <string name="shared_sting_poi_types">POI types</string>
     <string name="shared_sting_nothing_selected">Nothing selected</string>
     <string name="shared_sting_quick_actions">Quick actions</string>
diff --git a/OsmAnd/src/net/osmand/plus/SettingsHelper.java b/OsmAnd/src/net/osmand/plus/SettingsHelper.java
index c0b5f1bb586..585077b3589 100644
--- a/OsmAnd/src/net/osmand/plus/SettingsHelper.java
+++ b/OsmAnd/src/net/osmand/plus/SettingsHelper.java
@@ -2,6 +2,7 @@
 
 import android.annotation.SuppressLint;
 import android.app.Activity;
+import android.app.ProgressDialog;
 import android.content.Context;
 import android.content.DialogInterface;
 import android.os.AsyncTask;
@@ -23,6 +24,7 @@
 import net.osmand.plus.OsmandSettings.OsmandPreference;
 import net.osmand.plus.activities.MapActivity;
 import net.osmand.plus.poi.PoiUIFilter;
+import net.osmand.plus.profiles.ProfileIcons;
 import net.osmand.plus.quickaction.QuickAction;
 import net.osmand.plus.quickaction.QuickActionFactory;
 import net.osmand.util.Algorithms;
@@ -520,14 +522,29 @@ private void renameProfile() {
 
 		@Override
 		public void apply() {
-			if (appMode.isCustomProfile()) {
-				if (!shouldReplace && exists()) {
-					renameProfile();
-					builder = ApplicationMode.fromModeBean(app, modeBean);
-				}
-				appMode = ApplicationMode.saveProfile(builder, getSettings().getContext());
-				ApplicationMode.changeProfileAvailability(appMode, true, app);
+			if (!appMode.isCustomProfile() && !shouldReplace) {
+				ApplicationMode parent = ApplicationMode.valueOfStringKey(modeBean.stringKey, null);
+				renameProfile();
+				ApplicationMode.ApplicationModeBuilder builder = ApplicationMode
+						.createCustomMode(parent, modeBean.stringKey, app)
+						.setIconResName(modeBean.iconName)
+						.setUserProfileName(modeBean.userProfileName)
+						.setRoutingProfile(modeBean.routingProfile)
+						.setRouteService(modeBean.routeService)
+						.setIconColor(modeBean.iconColor)
+						.setLocationIcon(modeBean.locIcon)
+						.setNavigationIcon(modeBean.navIcon);
+				app.getSettings().copyPreferencesFromProfile(parent, builder.getApplicationMode());
+				appMode = ApplicationMode.saveProfile(builder, app);
+			} else if (!shouldReplace && exists()) {
+				renameProfile();
+				builder = ApplicationMode.fromModeBean(app, modeBean);
+				appMode = ApplicationMode.saveProfile(builder, app);
+			} else {
+				builder = ApplicationMode.fromModeBean(app, modeBean);
+				appMode = ApplicationMode.saveProfile(builder, app);
 			}
+			ApplicationMode.changeProfileAvailability(appMode, true, app);
 		}
 
 		@Override
@@ -1809,6 +1826,7 @@ private class ExportAsyncTask extends AsyncTask<Void, Void, Boolean> {
 		private SettingsExporter exporter;
 		private File file;
 		private SettingsExportListener listener;
+		private ProgressDialog progress;
 
 		ExportAsyncTask(@NonNull File settingsFile,
 						@Nullable SettingsExportListener listener,
@@ -1821,6 +1839,12 @@ private class ExportAsyncTask extends AsyncTask<Void, Void, Boolean> {
 			}
 		}
 
+		@Override
+		protected void onPreExecute() {
+			super.onPreExecute();
+			progress = ProgressDialog.show(activity, app.getString(R.string.export_profile), app.getString(R.string.shared_sting_preparing));
+		}
+
 		@Override
 		protected Boolean doInBackground(Void... voids) {
 			try {
@@ -1836,6 +1860,7 @@ protected Boolean doInBackground(Void... voids) {
 
 		@Override
 		protected void onPostExecute(Boolean success) {
+			progress.dismiss();
 			if (listener != null) {
 				listener.onSettingsExportFinished(file, success);
 			}
diff --git a/OsmAnd/src/net/osmand/plus/settings/DuplicatesSettingsAdapter.java b/OsmAnd/src/net/osmand/plus/settings/DuplicatesSettingsAdapter.java
index 764b3d43f03..210b07a977d 100644
--- a/OsmAnd/src/net/osmand/plus/settings/DuplicatesSettingsAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/settings/DuplicatesSettingsAdapter.java
@@ -1,6 +1,5 @@
 package net.osmand.plus.settings;
 
-import android.graphics.drawable.Drawable;
 import android.support.annotation.NonNull;
 import android.support.v7.widget.RecyclerView;
 import android.view.LayoutInflater;
@@ -9,13 +8,16 @@
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import net.osmand.AndroidUtils;
 import net.osmand.map.ITileSource;
 import net.osmand.plus.ApplicationMode;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
 import net.osmand.plus.poi.PoiUIFilter;
+import net.osmand.plus.profiles.ProfileIconColors;
 import net.osmand.plus.quickaction.QuickAction;
 import net.osmand.plus.render.RenderingIcons;
+import net.osmand.util.Algorithms;
 
 
 import java.io.File;
@@ -59,46 +61,54 @@ public void onBindViewHolder(@NonNull RecyclerView.ViewHolder holder, int positi
 					(String) currentItem));
 			((HeaderViewHolder) holder).divider.setVisibility(View.VISIBLE);
 		} else if (holder instanceof ItemViewHolder) {
-			String title = null;
-			String subTitle = null;
-			Drawable drawable = null;
-			if (currentItem instanceof ApplicationMode) {
-				title = ((ApplicationMode) currentItem).toHumanString();
-				subTitle = ((ApplicationMode) currentItem).getRoutingProfile();
-				drawable = app.getUIUtilities().getIcon(
-						((ApplicationMode) currentItem).getIconRes(),
-						((ApplicationMode) currentItem).getIconColorInfo().getColor(nightMode)
-				);
+			if (currentItem instanceof ApplicationMode.ApplicationModeBean) {
+				String profileName = ((ApplicationMode.ApplicationModeBean) currentItem).userProfileName;
+				if (Algorithms.isEmpty(profileName)) {
+					ApplicationMode appMode = ApplicationMode.valueOfStringKey(((ApplicationMode.ApplicationModeBean) currentItem).stringKey, null);
+					profileName = app.getString(appMode.getNameKeyResource());
+				}
+				((ItemViewHolder) holder).title.setText(profileName);
+				String routingProfile = (((ApplicationMode.ApplicationModeBean) currentItem).routingProfile);
+				if (Algorithms.isEmpty(routingProfile)) {
+					((ItemViewHolder) holder).subTitle.setVisibility(View.GONE);
+				} else {
+					((ItemViewHolder) holder).subTitle.setText(String.format(
+							app.getString(R.string.ltr_or_rtl_combine_via_colon),
+							app.getString(R.string.nav_type_hint),
+							routingProfile));
+					((ItemViewHolder) holder).subTitle.setVisibility(View.VISIBLE);
+				}
+				int profileIconRes = AndroidUtils.getDrawableId(app, ((ApplicationMode.ApplicationModeBean) currentItem).iconName);
+				ProfileIconColors iconColor = ((ApplicationMode.ApplicationModeBean) currentItem).iconColor;
+				((ItemViewHolder) holder).icon.setImageDrawable(app.getUIUtilities().getIcon(profileIconRes, iconColor.getColor(nightMode)));
+				((ItemViewHolder) holder).icon.setVisibility(View.VISIBLE);
 			} else if (currentItem instanceof QuickAction) {
-				title = ((QuickAction) currentItem).getName(app);
-				drawable = app.getUIUtilities().getIcon(((QuickAction) currentItem).getIconRes(), nightMode);
+				((ItemViewHolder) holder).title.setText(((QuickAction) currentItem).getName(app.getApplicationContext()));
+				((ItemViewHolder) holder).icon.setImageDrawable(app.getUIUtilities().getIcon(((QuickAction) currentItem).getIconRes(), nightMode));
+				((ItemViewHolder) holder).subTitle.setVisibility(View.GONE);
+				((ItemViewHolder) holder).icon.setVisibility(View.VISIBLE);
 			} else if (currentItem instanceof PoiUIFilter) {
-				title = ((PoiUIFilter) currentItem).getName();
+				((ItemViewHolder) holder).title.setText(((PoiUIFilter) currentItem).getName());
 				int iconRes = RenderingIcons.getBigIconResourceId(((PoiUIFilter) currentItem).getIconId());
-				drawable = app.getUIUtilities().getIcon(iconRes != 0 ? iconRes : R.drawable.ic_person, nightMode);
+				((ItemViewHolder) holder).icon.setImageDrawable(app.getUIUtilities().getIcon(iconRes != 0 ? iconRes : R.drawable.ic_person, nightMode));
+				((ItemViewHolder) holder).subTitle.setVisibility(View.GONE);
+				((ItemViewHolder) holder).icon.setVisibility(View.VISIBLE);
 			} else if (currentItem instanceof ITileSource) {
-				title = ((ITileSource) currentItem).getName();
-				drawable = app.getUIUtilities().getIcon(R.drawable.ic_action_info_dark, nightMode);
+				((ItemViewHolder) holder).title.setText(((ITileSource) currentItem).getName());
+				((ItemViewHolder) holder).icon.setImageResource(R.drawable.ic_action_info_dark);
+				((ItemViewHolder) holder).subTitle.setVisibility(View.GONE);
+				((ItemViewHolder) holder).icon.setVisibility(View.INVISIBLE);
 			} else if (currentItem instanceof File) {
-				title = ((File) currentItem).getName();
+				((ItemViewHolder) holder).title.setText(((File) currentItem).getName());
 				if (((File) currentItem).getName().contains("/rendering/")) {
-					drawable = app.getUIUtilities().getIcon(R.drawable.ic_action_map_style, nightMode);
+					((ItemViewHolder) holder).icon.setImageDrawable(app.getUIUtilities().getIcon(R.drawable.ic_action_map_style, nightMode));
+					((ItemViewHolder) holder).icon.setVisibility(View.VISIBLE);
+				} else {
+					((ItemViewHolder) holder).icon.setImageResource(R.drawable.ic_action_info_dark);
+					((ItemViewHolder) holder).icon.setVisibility(View.INVISIBLE);
 				}
-			}
-			((ItemViewHolder) holder).title.setText(title != null ? title : "");
-			if (subTitle != null) {
-				((ItemViewHolder) holder).subTitle.setText(subTitle);
-				((ItemViewHolder) holder).subTitle.setVisibility(View.VISIBLE);
-			} else {
 				((ItemViewHolder) holder).subTitle.setVisibility(View.GONE);
 			}
-			if (drawable != null) {
-				((ItemViewHolder) holder).icon.setImageDrawable(drawable);
-				((ItemViewHolder) holder).icon.setImageResource(View.VISIBLE);
-			} else {
-				((ItemViewHolder) holder).icon.setImageResource(R.drawable.ic_action_info_dark);
-				((ItemViewHolder) holder).icon.setVisibility(View.INVISIBLE);
-			}
 			((ItemViewHolder) holder).divider.setVisibility(shouldShowDivider(position) ? View.VISIBLE : View.GONE);
 		}
 	}
diff --git a/OsmAnd/src/net/osmand/plus/settings/ExportImportSettingsAdapter.java b/OsmAnd/src/net/osmand/plus/settings/ExportImportSettingsAdapter.java
index e75beefc788..fc593ab108e 100644
--- a/OsmAnd/src/net/osmand/plus/settings/ExportImportSettingsAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/settings/ExportImportSettingsAdapter.java
@@ -24,6 +24,7 @@
 import net.osmand.plus.profiles.ProfileIconColors;
 import net.osmand.plus.quickaction.QuickAction;
 import net.osmand.plus.render.RenderingIcons;
+import net.osmand.util.Algorithms;
 
 import java.io.File;
 import java.util.ArrayList;
@@ -147,12 +148,25 @@ public void onClick(View view) {
 
 		switch (type) {
 			case PROFILE:
-				title.setText(((ApplicationMode.ApplicationModeBean) currentItem).userProfileName);
-				subText.setText(((ApplicationMode.ApplicationModeBean) currentItem).routingProfile);
+				String profileName = ((ApplicationMode.ApplicationModeBean) currentItem).userProfileName;
+				if (Algorithms.isEmpty(profileName)) {
+					ApplicationMode appMode = ApplicationMode.valueOfStringKey(((ApplicationMode.ApplicationModeBean) currentItem).stringKey, null);
+					profileName = app.getString(appMode.getNameKeyResource());
+				}
+				title.setText(profileName);
+				String routingProfile = (((ApplicationMode.ApplicationModeBean) currentItem).routingProfile);
+				if (Algorithms.isEmpty(routingProfile)) {
+					subText.setVisibility(View.GONE);
+				} else {
+					subText.setText(String.format(
+							app.getString(R.string.ltr_or_rtl_combine_via_colon),
+							app.getString(R.string.nav_type_hint),
+							routingProfile));
+					subText.setVisibility(View.VISIBLE);
+				}
 				int profileIconRes = AndroidUtils.getDrawableId(app, ((ApplicationMode.ApplicationModeBean) currentItem).iconName);
 				ProfileIconColors iconColor = ((ApplicationMode.ApplicationModeBean) currentItem).iconColor;
 				icon.setImageDrawable(app.getUIUtilities().getIcon(profileIconRes, iconColor.getColor(nightMode)));
-				subText.setVisibility(View.VISIBLE);
 				icon.setVisibility(View.VISIBLE);
 				break;
 			case QUICK_ACTIONS:
diff --git a/OsmAnd/src/net/osmand/plus/settings/ImportDuplicatesFragment.java b/OsmAnd/src/net/osmand/plus/settings/ImportDuplicatesFragment.java
index 8fe5428767f..e0a42b78692 100644
--- a/OsmAnd/src/net/osmand/plus/settings/ImportDuplicatesFragment.java
+++ b/OsmAnd/src/net/osmand/plus/settings/ImportDuplicatesFragment.java
@@ -45,6 +45,7 @@ public static void showInstance(@NonNull FragmentManager fm, List<? super Object
 		fragment.setDuplicatesList(duplicatesList);
 		fragment.setSettingsItems(settingsItems);
 		fragment.setFile(file);
+		fragment.setRetainInstance(true);
 		fragment.show(fm, TAG);
 	}
 
@@ -90,7 +91,7 @@ public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceStat
 
 	private List<Object> prepareDuplicates() {
 		List<? super Object> duplicates = new ArrayList<>();
-		List<ApplicationMode> profiles = new ArrayList<>();
+		List<ApplicationMode.ApplicationModeBean> profiles = new ArrayList<>();
 		List<QuickAction> actions = new ArrayList<>();
 		List<PoiUIFilter> filters = new ArrayList<>();
 		List<ITileSource> tileSources = new ArrayList<>();
@@ -98,8 +99,8 @@ private List<Object> prepareDuplicates() {
 		List<File> routingFilesList = new ArrayList<>();
 
 		for (Object object : duplicatesList) {
-			if (object instanceof ApplicationMode) {
-				profiles.add((ApplicationMode) object);
+			if (object instanceof ApplicationMode.ApplicationModeBean) {
+				profiles.add((ApplicationMode.ApplicationModeBean) object);
 			} else if (object instanceof QuickAction) {
 				actions.add((QuickAction) object);
 			} else if (object instanceof PoiUIFilter) {
diff --git a/OsmAnd/src/net/osmand/plus/settings/ImportSettingsFragment.java b/OsmAnd/src/net/osmand/plus/settings/ImportSettingsFragment.java
index 8653c9cdddc..f0e641c59ed 100644
--- a/OsmAnd/src/net/osmand/plus/settings/ImportSettingsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/settings/ImportSettingsFragment.java
@@ -1 +1 @@
-package net.osmand.plus.settings;import android.os.Bundle;import android.support.annotation.NonNull;import android.support.annotation.Nullable;import android.support.v4.app.FragmentManager;import android.support.v7.widget.Toolbar;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.ExpandableListView;import net.osmand.map.ITileSource;import net.osmand.map.TileSourceManager;import net.osmand.plus.ApplicationMode;import net.osmand.plus.OsmandApplication;import net.osmand.plus.R;import net.osmand.plus.SQLiteTileSource;import net.osmand.plus.SettingsHelper;import net.osmand.plus.SettingsHelper.SettingsItem;import net.osmand.plus.UiUtilities;import net.osmand.plus.base.BaseOsmAndDialogFragment;import net.osmand.plus.poi.PoiUIFilter;import net.osmand.plus.profiles.AdditionalDataWrapper;import net.osmand.plus.quickaction.QuickAction;import net.osmand.plus.widgets.TextViewEx;import java.io.File;import java.util.ArrayList;import java.util.List;public class ImportSettingsFragment extends BaseOsmAndDialogFragment		implements View.OnClickListener {	public static final String TAG = ImportSettingsFragment.class.getSimpleName();	private OsmandApplication app;	private ExportImportSettingsAdapter adapter;	private ExpandableListView expandableList;	private TextViewEx selectBtn;	private List<SettingsItem> settingsItems;	private File file;	private boolean allSelected;	private boolean nightMode;	public static void showInstance(@NonNull FragmentManager fm, @NonNull List<SettingsItem> settingsItems, @NonNull File file) {		ImportSettingsFragment fragment = new ImportSettingsFragment();		fragment.setSettingsItems(settingsItems);		fragment.setFile(file);		fragment.show(fm, TAG);	}	@Override	public void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		app = getMyApplication();		nightMode = !getSettings().isLightContent();		if (settingsItems == null) {			settingsItems = app.getSettingsHelper().getSettingsItems();		}		if (file == null) {			file = app.getSettingsHelper().getSettingsFile();		}	}	@Nullable	@Override	public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {		inflater = UiUtilities.getInflater(app, nightMode);		View root = inflater.inflate(R.layout.fragment_import, container, false);		setupToolbar((Toolbar) root.findViewById(R.id.toolbar));		TextViewEx continueBtn = root.findViewById(R.id.continue_button);		selectBtn = root.findViewById(R.id.select_button);		expandableList = root.findViewById(R.id.list);		continueBtn.setOnClickListener(this);		selectBtn.setOnClickListener(this);		return root;	}	@Override	public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {		super.onViewCreated(view, savedInstanceState);		adapter = new ExportImportSettingsAdapter(getMyApplication(), getSettingsToOperate(), nightMode, true);		expandableList.setAdapter(adapter);	}	@Override	public void onClick(View view) {		switch (view.getId()) {			case R.id.select_button: {				allSelected = !allSelected;				selectBtn.setText(allSelected ? R.string.shared_string_deselect_all : R.string.shared_string_select_all);				adapter.selectAll(allSelected);				break;			}			case R.id.continue_button: {				if (adapter.getDataToOperate().isEmpty()) {					app.showShortToastMessage(getString(R.string.shared_sting_nothing_selected));				} else {					importItems();				}				break;			}		}	}	private void importItems() {		List<SettingsItem> settingsItems = getSettingsItemsFromData(adapter.getDataToOperate());		List<Object> duplicateItems = getDuplicatesData(settingsItems);		if (duplicateItems.isEmpty()) {			app.getSettingsHelper().importSettings(file, settingsItems, "", 1, new SettingsHelper.SettingsImportListener() {				@Override				public void onSettingsImportFinished(boolean succeed, boolean empty, @NonNull List<SettingsHelper.SettingsItem> items) {					if (succeed) {						app.showShortToastMessage(app.getString(R.string.file_imported_successfully, file.getName()));					} else if (empty) {						app.showShortToastMessage(app.getString(R.string.file_import_error, file.getName(), app.getString(R.string.shared_string_unexpected_error)));					}				}			});			dismiss();		} else {			ImportDuplicatesFragment.showInstance(getFragmentManager(), duplicateItems, settingsItems, file);			dismiss();		}	}	private List<Object> getDuplicatesData(List<SettingsItem> items) {		List<Object> duplicateItems = new ArrayList<>();		for (SettingsItem item : items) {			if (item instanceof SettingsHelper.ProfileSettingsItem) {				if (item.exists()) {					duplicateItems.add(((SettingsHelper.ProfileSettingsItem) item).getAppMode());				}			} else if (item instanceof SettingsHelper.QuickActionSettingsItem) {				List<QuickAction> duplicates = ((SettingsHelper.QuickActionSettingsItem) item).getDuplicates();				if (!duplicates.isEmpty()) {					duplicateItems.addAll(duplicates);				}			} else if (item instanceof SettingsHelper.PoiUiFilterSettingsItem) {				List<PoiUIFilter> duplicates = ((SettingsHelper.PoiUiFilterSettingsItem) item).getDuplicates();				if (!duplicates.isEmpty()) {					duplicateItems.addAll(duplicates);				}			} else if (item instanceof SettingsHelper.MapSourcesSettingsItem) {				List<ITileSource> duplicates = ((SettingsHelper.MapSourcesSettingsItem) item).getDuplicates();				if (!duplicates.isEmpty()) {					duplicateItems.addAll(duplicates);				}			} else if (item instanceof SettingsHelper.FileSettingsItem) {				if (item.exists()) {					duplicateItems.add(((SettingsHelper.FileSettingsItem) item).getFile());				}			}		}		return duplicateItems;	}	public void setSettingsItems(List<SettingsItem> settingsItems) {		this.settingsItems = settingsItems;	}	private List<SettingsItem> getSettingsItemsFromData(List<Object> dataToOperate) {		List<SettingsItem> settingsItems = new ArrayList<>();		List<QuickAction> quickActions = new ArrayList<>();		List<PoiUIFilter> poiUIFilters = new ArrayList<>();		List<ITileSource> tileSourceTemplates = new ArrayList<>();		for (Object object : dataToOperate) {			if (object instanceof ApplicationMode.ApplicationModeBean) {				settingsItems.add(new SettingsHelper.ProfileSettingsItem(app, (ApplicationMode.ApplicationModeBean) object));			}			if (object instanceof QuickAction) {				quickActions.add((QuickAction) object);			} else if (object instanceof PoiUIFilter) {				poiUIFilters.add((PoiUIFilter) object);			} else if (object instanceof TileSourceManager.TileSourceTemplate					|| object instanceof SQLiteTileSource) {				tileSourceTemplates.add((ITileSource) object);			} else if (object instanceof File) {				settingsItems.add(new SettingsHelper.FileSettingsItem(getMyApplication(), (File) object));			}		}		if (!quickActions.isEmpty()) {			settingsItems.add(new SettingsHelper.QuickActionSettingsItem(getMyApplication(), quickActions));		}		if (!poiUIFilters.isEmpty()) {			settingsItems.add(new SettingsHelper.PoiUiFilterSettingsItem(getMyApplication(), poiUIFilters));		}		if (!tileSourceTemplates.isEmpty()) {			settingsItems.add(new SettingsHelper.MapSourcesSettingsItem(getMyApplication(), tileSourceTemplates));		}		return settingsItems;	}	private List<AdditionalDataWrapper> getSettingsToOperate() {		List<AdditionalDataWrapper> settingsToOperate = new ArrayList<>();		List<ApplicationMode.ApplicationModeBean> profiles = new ArrayList<>();		List<QuickAction> quickActions = new ArrayList<>();		List<PoiUIFilter> poiUIFilters = new ArrayList<>();		List<ITileSource> tileSourceTemplates = new ArrayList<>();		List<File> routingFilesList = new ArrayList<>();		List<File> renderFilesList = new ArrayList<>();		for (SettingsHelper.SettingsItem item : settingsItems) {			if (item.getType().equals(SettingsHelper.SettingsItemType.PROFILE)) {				profiles.add(((SettingsHelper.ProfileSettingsItem) item).getModeBean());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.QUICK_ACTION)) {				quickActions.addAll(((SettingsHelper.QuickActionSettingsItem) item).getQuickActions());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.POI_UI_FILTERS)) {				poiUIFilters.addAll(((SettingsHelper.PoiUiFilterSettingsItem) item).getPoiUIFilters());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.MAP_SOURCES)) {				tileSourceTemplates.addAll(((SettingsHelper.MapSourcesSettingsItem) item).getMapSources());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.FILE)) {				if (item.getName().startsWith("/rendering/")) {					renderFilesList.add(((SettingsHelper.FileSettingsItem) item).getFile());				} else if (item.getName().startsWith("/routing/")) {					routingFilesList.add(((SettingsHelper.FileSettingsItem) item).getFile());				}			}		}		if (!profiles.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.PROFILE,					profiles));		}		if (!quickActions.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.QUICK_ACTIONS,					quickActions));		}		if (!poiUIFilters.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.POI_TYPES,					poiUIFilters));		}		if (!tileSourceTemplates.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.MAP_SOURCES,					tileSourceTemplates			));		}		if (!renderFilesList.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.CUSTOM_RENDER_STYLE,					renderFilesList			));		}		if (!routingFilesList.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.CUSTOM_ROUTING,					routingFilesList			));		}		return settingsToOperate;	}	private void setupToolbar(Toolbar toolbar) {		toolbar.setNavigationIcon(getPaintedContentIcon(R.drawable.headline_close_button, nightMode				? getResources().getColor(R.color.active_buttons_and_links_text_dark)				: getResources().getColor(R.color.active_buttons_and_links_text_light)));		toolbar.setNavigationContentDescription(R.string.shared_string_close);		toolbar.setNavigationOnClickListener(new View.OnClickListener() {			@Override			public void onClick(View v) {				dismiss();			}		});	}	public void setFile(File file) {		this.file = file;	}}
\ No newline at end of file
+package net.osmand.plus.settings;import android.os.Bundle;import android.support.annotation.NonNull;import android.support.annotation.Nullable;import android.support.v4.app.FragmentManager;import android.support.v7.widget.Toolbar;import android.view.LayoutInflater;import android.view.View;import android.view.ViewGroup;import android.widget.ExpandableListView;import net.osmand.map.ITileSource;import net.osmand.map.TileSourceManager;import net.osmand.plus.ApplicationMode;import net.osmand.plus.OsmandApplication;import net.osmand.plus.R;import net.osmand.plus.SQLiteTileSource;import net.osmand.plus.SettingsHelper;import net.osmand.plus.SettingsHelper.SettingsItem;import net.osmand.plus.UiUtilities;import net.osmand.plus.base.BaseOsmAndDialogFragment;import net.osmand.plus.poi.PoiUIFilter;import net.osmand.plus.profiles.AdditionalDataWrapper;import net.osmand.plus.quickaction.QuickAction;import net.osmand.plus.widgets.TextViewEx;import java.io.File;import java.util.ArrayList;import java.util.List;public class ImportSettingsFragment extends BaseOsmAndDialogFragment		implements View.OnClickListener {	public static final String TAG = ImportSettingsFragment.class.getSimpleName();	private OsmandApplication app;	private ExportImportSettingsAdapter adapter;	private ExpandableListView expandableList;	private TextViewEx selectBtn;	private List<SettingsItem> settingsItems;	private File file;	private boolean allSelected;	private boolean nightMode;	public static void showInstance(@NonNull FragmentManager fm, @NonNull List<SettingsItem> settingsItems, @NonNull File file) {		ImportSettingsFragment fragment = new ImportSettingsFragment();		fragment.setSettingsItems(settingsItems);		fragment.setFile(file);		fragment.show(fm, TAG);	}	@Override	public void onCreate(Bundle savedInstanceState) {		super.onCreate(savedInstanceState);		app = getMyApplication();		nightMode = !getSettings().isLightContent();		if (settingsItems == null) {			settingsItems = app.getSettingsHelper().getSettingsItems();		}		if (file == null) {			file = app.getSettingsHelper().getSettingsFile();		}	}	@Nullable	@Override	public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {		inflater = UiUtilities.getInflater(app, nightMode);		View root = inflater.inflate(R.layout.fragment_import, container, false);		setupToolbar((Toolbar) root.findViewById(R.id.toolbar));		TextViewEx continueBtn = root.findViewById(R.id.continue_button);		selectBtn = root.findViewById(R.id.select_button);		expandableList = root.findViewById(R.id.list);		continueBtn.setOnClickListener(this);		selectBtn.setOnClickListener(this);		return root;	}	@Override	public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceState) {		super.onViewCreated(view, savedInstanceState);		adapter = new ExportImportSettingsAdapter(getMyApplication(), getSettingsToOperate(), nightMode, true);		expandableList.setAdapter(adapter);	}	@Override	public void onClick(View view) {		switch (view.getId()) {			case R.id.select_button: {				allSelected = !allSelected;				selectBtn.setText(allSelected ? R.string.shared_string_deselect_all : R.string.shared_string_select_all);				adapter.selectAll(allSelected);				break;			}			case R.id.continue_button: {				if (adapter.getDataToOperate().isEmpty()) {					app.showShortToastMessage(getString(R.string.shared_sting_nothing_selected));				} else {					importItems();				}				break;			}		}	}	private void importItems() {		List<SettingsItem> settingsItems = getSettingsItemsFromData(adapter.getDataToOperate());		List<Object> duplicateItems = getDuplicatesData(settingsItems);		if (duplicateItems.isEmpty()) {			app.getSettingsHelper().importSettings(file, settingsItems, "", 1, new SettingsHelper.SettingsImportListener() {				@Override				public void onSettingsImportFinished(boolean succeed, boolean empty, @NonNull List<SettingsHelper.SettingsItem> items) {					if (succeed) {						app.showShortToastMessage(app.getString(R.string.file_imported_successfully, file.getName()));					} else if (empty) {						app.showShortToastMessage(app.getString(R.string.file_import_error, file.getName(), app.getString(R.string.shared_string_unexpected_error)));					}				}			});			dismiss();		} else {			ImportDuplicatesFragment.showInstance(getFragmentManager(), duplicateItems, settingsItems, file);			dismiss();		}	}	private List<Object> getDuplicatesData(List<SettingsItem> items) {		List<Object> duplicateItems = new ArrayList<>();		for (SettingsItem item : items) {			if (item instanceof SettingsHelper.ProfileSettingsItem) {				if (item.exists()) {					duplicateItems.add(((SettingsHelper.ProfileSettingsItem) item).getModeBean());				}			} else if (item instanceof SettingsHelper.QuickActionSettingsItem) {				List<QuickAction> duplicates = ((SettingsHelper.QuickActionSettingsItem) item).getDuplicates();				if (!duplicates.isEmpty()) {					duplicateItems.addAll(duplicates);				}			} else if (item instanceof SettingsHelper.PoiUiFilterSettingsItem) {				List<PoiUIFilter> duplicates = ((SettingsHelper.PoiUiFilterSettingsItem) item).getDuplicates();				if (!duplicates.isEmpty()) {					duplicateItems.addAll(duplicates);				}			} else if (item instanceof SettingsHelper.MapSourcesSettingsItem) {				List<ITileSource> duplicates = ((SettingsHelper.MapSourcesSettingsItem) item).getDuplicates();				if (!duplicates.isEmpty()) {					duplicateItems.addAll(duplicates);				}			} else if (item instanceof SettingsHelper.FileSettingsItem) {				if (item.exists()) {					duplicateItems.add(((SettingsHelper.FileSettingsItem) item).getFile());				}			}		}		return duplicateItems;	}	public void setSettingsItems(List<SettingsItem> settingsItems) {		this.settingsItems = settingsItems;	}	private List<SettingsItem> getSettingsItemsFromData(List<Object> dataToOperate) {		List<SettingsItem> settingsItems = new ArrayList<>();		List<QuickAction> quickActions = new ArrayList<>();		List<PoiUIFilter> poiUIFilters = new ArrayList<>();		List<ITileSource> tileSourceTemplates = new ArrayList<>();		for (Object object : dataToOperate) {			if (object instanceof ApplicationMode.ApplicationModeBean) {				settingsItems.add(new SettingsHelper.ProfileSettingsItem(app, (ApplicationMode.ApplicationModeBean) object));			}			if (object instanceof QuickAction) {				quickActions.add((QuickAction) object);			} else if (object instanceof PoiUIFilter) {				poiUIFilters.add((PoiUIFilter) object);			} else if (object instanceof TileSourceManager.TileSourceTemplate					|| object instanceof SQLiteTileSource) {				tileSourceTemplates.add((ITileSource) object);			} else if (object instanceof File) {				settingsItems.add(new SettingsHelper.FileSettingsItem(getMyApplication(), (File) object));			}		}		if (!quickActions.isEmpty()) {			settingsItems.add(new SettingsHelper.QuickActionSettingsItem(getMyApplication(), quickActions));		}		if (!poiUIFilters.isEmpty()) {			settingsItems.add(new SettingsHelper.PoiUiFilterSettingsItem(getMyApplication(), poiUIFilters));		}		if (!tileSourceTemplates.isEmpty()) {			settingsItems.add(new SettingsHelper.MapSourcesSettingsItem(getMyApplication(), tileSourceTemplates));		}		return settingsItems;	}	private List<AdditionalDataWrapper> getSettingsToOperate() {		List<AdditionalDataWrapper> settingsToOperate = new ArrayList<>();		List<ApplicationMode.ApplicationModeBean> profiles = new ArrayList<>();		List<QuickAction> quickActions = new ArrayList<>();		List<PoiUIFilter> poiUIFilters = new ArrayList<>();		List<ITileSource> tileSourceTemplates = new ArrayList<>();		List<File> routingFilesList = new ArrayList<>();		List<File> renderFilesList = new ArrayList<>();		for (SettingsHelper.SettingsItem item : settingsItems) {			if (item.getType().equals(SettingsHelper.SettingsItemType.PROFILE)) {				profiles.add(((SettingsHelper.ProfileSettingsItem) item).getModeBean());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.QUICK_ACTION)) {				quickActions.addAll(((SettingsHelper.QuickActionSettingsItem) item).getQuickActions());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.POI_UI_FILTERS)) {				poiUIFilters.addAll(((SettingsHelper.PoiUiFilterSettingsItem) item).getPoiUIFilters());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.MAP_SOURCES)) {				tileSourceTemplates.addAll(((SettingsHelper.MapSourcesSettingsItem) item).getMapSources());			} else if (item.getType().equals(SettingsHelper.SettingsItemType.FILE)) {				if (item.getName().startsWith("/rendering/")) {					renderFilesList.add(((SettingsHelper.FileSettingsItem) item).getFile());				} else if (item.getName().startsWith("/routing/")) {					routingFilesList.add(((SettingsHelper.FileSettingsItem) item).getFile());				}			}		}		if (!profiles.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.PROFILE,					profiles));		}		if (!quickActions.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.QUICK_ACTIONS,					quickActions));		}		if (!poiUIFilters.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.POI_TYPES,					poiUIFilters));		}		if (!tileSourceTemplates.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.MAP_SOURCES,					tileSourceTemplates			));		}		if (!renderFilesList.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.CUSTOM_RENDER_STYLE,					renderFilesList			));		}		if (!routingFilesList.isEmpty()) {			settingsToOperate.add(new AdditionalDataWrapper(					AdditionalDataWrapper.Type.CUSTOM_ROUTING,					routingFilesList			));		}		return settingsToOperate;	}	private void setupToolbar(Toolbar toolbar) {		toolbar.setNavigationIcon(getPaintedContentIcon(R.drawable.headline_close_button, nightMode				? getResources().getColor(R.color.active_buttons_and_links_text_dark)				: getResources().getColor(R.color.active_buttons_and_links_text_light)));		toolbar.setNavigationContentDescription(R.string.shared_string_close);		toolbar.setNavigationOnClickListener(new View.OnClickListener() {			@Override			public void onClick(View v) {				dismiss();			}		});	}	public void setFile(File file) {		this.file = file;	}}
\ No newline at end of file
