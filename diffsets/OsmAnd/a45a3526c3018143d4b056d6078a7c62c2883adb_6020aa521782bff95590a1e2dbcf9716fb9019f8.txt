diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationFragment.java b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationFragment.java
index b6e7caec044..5851a985c70 100644
--- a/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationFragment.java
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationFragment.java
@@ -20,11 +20,10 @@
 import androidx.fragment.app.FragmentActivity;
 import androidx.fragment.app.FragmentManager;
 
+import net.osmand.plus.routing.GpxApproximator;
 import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.gpx.GPXUtilities.WptPt;
-import net.osmand.LocationsHolder;
 import net.osmand.PlatformUtil;
-import net.osmand.ResultMatcher;
 import net.osmand.plus.utils.ColorUtilities;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
@@ -32,83 +31,36 @@
 import net.osmand.plus.activities.MapActivity;
 import net.osmand.plus.base.ContextMenuScrollFragment;
 import net.osmand.plus.helpers.AndroidUiHelper;
-import net.osmand.plus.routing.GpxApproximator;
-import net.osmand.plus.routing.GpxApproximator.GpxApproximationProgressCallback;
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.router.RoutePlannerFrontEnd.GpxRouteApproximation;
 
 import org.apache.commons.logging.Log;
 
-import java.io.IOException;
-import java.util.ArrayList;
-import java.util.HashMap;
 import java.util.List;
-import java.util.Map;
 
 public class GpxApproximationFragment extends ContextMenuScrollFragment
-		implements SliderCardListener, ProfileCardListener {
+		implements SliderCardListener, ProfileCardListener, GpxApproximationListener {
 
 	private static final Log LOG = PlatformUtil.getLog(GpxApproximationFragment.class);
+
 	public static final String TAG = GpxApproximationFragment.class.getName();
-	public static final String DISTANCE_THRESHOLD_KEY = "distance_threshold";
-	public static final String SNAP_TO_ROAD_APP_MODE_STRING_KEY = "snap_to_road_app_mode";
 
 	public static final int REQUEST_CODE = 1100;
 
-	private int menuTitleHeight;
-	private ApplicationMode snapToRoadAppMode = ApplicationMode.CAR;
-	private int distanceThreshold = 50;
+	@NonNull
+	private final GpxApproximationHelper helper;
 	private boolean applyApproximation;
-	private GpxApproximationProgressCallback approximationProgress;
-
-	private List<LocationsHolder> locationsHolders;
-	private final Map<LocationsHolder, GpxRouteApproximation> resultMap = new HashMap<>();
-
-	@Nullable
-	private GpxApproximator gpxApproximator;
-	private ProgressBar progressBar;
-	private View cancelButton;
-	private View applyButton;
 
+	private ProgressBar pbProgress;
+	private View btnCancel;
+	private View btnApply;
 	private SliderCard sliderCard;
+	private int menuTitleHeight;
 
-	@Override
-	public int getMainLayoutId() {
-		return R.layout.fragment_gpx_approximation_bottom_sheet_dialog;
-	}
-
-	@Override
-	public int getTopViewId() {
-		return R.id.gpx_approximation_top_shadow_all;
-	}
-
-	@Override
-	public int getHeaderViewHeight() {
-		return menuTitleHeight;
-	}
-
-	@Override
-	public boolean isHeaderViewDetached() {
-		return true;
-	}
-
-	@Override
-	public int getToolbarHeight() {
-		return 0;
-	}
-
-	public float getMiddleStateKoef() {
-		return 0.5f;
-	}
-
-	@Override
-	public int getSupportedMenuStatesPortrait() {
-		return MenuState.HEADER_ONLY | MenuState.HALF_SCREEN | MenuState.FULL_SCREEN;
-	}
-
-	@Override
-	public int getInitialMenuState() {
-		return MenuState.HALF_SCREEN;
+	public GpxApproximationFragment(@NonNull OsmandApplication app,
+	                                @NonNull GpxApproximationParams params) {
+		helper = new GpxApproximationHelper(app, params);
+		helper.setListener(this);
 	}
 
 	@Override
@@ -125,44 +77,21 @@ public void handleOnBackPressed() {
 	@Override
 	public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container, Bundle savedInstanceState) {
 		View mainView = super.onCreateView(inflater, container, savedInstanceState);
-		if (mainView == null || locationsHolders == null) {
+		if (mainView == null || !helper.canApproximate()) {
 			return null;
 		}
-		if (savedInstanceState != null) {
-			distanceThreshold = savedInstanceState.getInt(DISTANCE_THRESHOLD_KEY);
-			snapToRoadAppMode = ApplicationMode.valueOfStringKey(
-					savedInstanceState.getString(SNAP_TO_ROAD_APP_MODE_STRING_KEY), ApplicationMode.CAR);
-		}
-		approximationProgress = new GpxApproximationProgressCallback() {
-
-			@Override
-			public void start(GpxApproximator approximator) {
-			}
-
-			@Override
-			public void updateProgress(GpxApproximator approximator, int progress) {
-				if (isResumed() && approximator == GpxApproximationFragment.this.gpxApproximator) {
-					GpxApproximationFragment.this.updateProgress(progress);
-				}
-			}
-
-			@Override
-			public void finish(GpxApproximator approximator) {
-			}
-		};
-
-		applyButton = mainView.findViewById(R.id.right_bottom_button);
-		cancelButton = mainView.findViewById(R.id.dismiss_button);
+		btnApply = mainView.findViewById(R.id.right_bottom_button);
+		btnCancel = mainView.findViewById(R.id.dismiss_button);
 		if (isPortrait()) {
 			updateCardsLayout();
 		}
 		updateCards();
 		updateButtons(mainView);
 
-		progressBar = mainView.findViewById(R.id.progress_bar);
-		if (progressBar != null) {
-			requireMapActivity().setupRouteCalculationProgressBar(progressBar);
-			progressBar.setIndeterminate(false);
+		pbProgress = mainView.findViewById(R.id.progress_bar);
+		if (pbProgress != null) {
+			requireMapActivity().setupRouteCalculationProgressBar(pbProgress);
+			pbProgress.setIndeterminate(false);
 		}
 
 		if (!isPortrait()) {
@@ -172,12 +101,11 @@ public void finish(GpxApproximator approximator) {
 			mainView.findViewById(R.id.control_buttons).setLayoutParams(params);
 		}
 		runLayoutListener();
-
-		calculateGpxApproximation(true);
+		helper.calculateGpxApproximation(true);
 
 		ScrollView profileView = (ScrollView) getBottomScrollView();
 		profileView.postDelayed(() -> {
-			View view = profileView.findViewWithTag(snapToRoadAppMode.getStringKey());
+			View view = profileView.findViewWithTag(helper.getModeKey());
 			if (view != null) {
 				int headerHeight = getResources().getDimensionPixelSize(R.dimen.measurement_tool_button_height);
 				profileView.scrollTo(0, view.getTop() + headerHeight);
@@ -187,62 +115,15 @@ public void finish(GpxApproximator approximator) {
 		return mainView;
 	}
 
-	@Override
-	public void onResume() {
-		super.onResume();
-		if (locationsHolders == null) {
-			dismiss();
-		}
-	}
-
 	@Override
 	protected void calculateLayout(View view, boolean initLayout) {
 		int sliderHeight = sliderCard != null ? sliderCard.getViewHeight() : 0;
-		menuTitleHeight = view.findViewById(R.id.control_buttons).getHeight()
-				- view.findViewById(R.id.buttons_shadow).getHeight() + sliderHeight;
+		int controlButtonsHeight = view.findViewById(R.id.control_buttons).getHeight();
+		int buttonsShadowHeight = view.findViewById(R.id.buttons_shadow).getHeight();
+		menuTitleHeight = controlButtonsHeight - buttonsShadowHeight + sliderHeight;
 		super.calculateLayout(view, initLayout);
 	}
 
-	@Override
-	protected boolean isHideable() {
-		return false;
-	}
-
-	@Override
-	public void onSaveInstanceState(@NonNull Bundle outState) {
-		super.onSaveInstanceState(outState);
-		outState.putInt(DISTANCE_THRESHOLD_KEY, distanceThreshold);
-		outState.putString(SNAP_TO_ROAD_APP_MODE_STRING_KEY, snapToRoadAppMode.getStringKey());
-	}
-
-	@Override
-	public void onDestroyView() {
-		super.onDestroyView();
-		if (gpxApproximator != null) {
-			gpxApproximator.cancelApproximation();
-		}
-		if (!applyApproximation) {
-			Fragment fragment = getTargetFragment();
-			if (fragment instanceof GpxApproximationFragmentListener) {
-				((GpxApproximationFragmentListener) fragment).onCancelGpxApproximation();
-			}
-		}
-	}
-
-	private GpxApproximator getNewGpxApproximator(@NonNull LocationsHolder locationsHolder) {
-		GpxApproximator gpxApproximator = null;
-		try {
-			OsmandApplication app = getMyApplication();
-			if (app != null) {
-				gpxApproximator = new GpxApproximator(app, snapToRoadAppMode, distanceThreshold, locationsHolder);
-				gpxApproximator.setApproximationProgress(approximationProgress);
-			}
-		} catch (IOException e) {
-			LOG.error(e.getMessage(), e);
-		}
-		return gpxApproximator;
-	}
-
 	private void updateCardsLayout() {
 		View mainView = getMainView();
 		if (mainView != null) {
@@ -269,38 +150,26 @@ private void updateCardsLayout() {
 	private void updateButtons(View view) {
 		View buttonsContainer = view.findViewById(R.id.buttons_container);
 		buttonsContainer.setBackgroundColor(AndroidUtils.getColorFromAttr(view.getContext(), R.attr.bg_color));
-		applyButton.setOnClickListener(new View.OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				Fragment fragment = getTargetFragment();
-				if (fragment instanceof GpxApproximationFragmentListener) {
-					((GpxApproximationFragmentListener) fragment).onApplyGpxApproximation();
-				}
-				applyApproximation = true;
-				dismiss();
+		btnApply.setOnClickListener(v -> {
+			Fragment fragment = getTargetFragment();
+			if (fragment instanceof GpxApproximationFragmentListener) {
+				((GpxApproximationFragmentListener) fragment).onApplyGpxApproximation();
 			}
+			applyApproximation = true;
+			dismiss();
 		});
-		cancelButton.setOnClickListener(new View.OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				FragmentActivity activity = getActivity();
-				if (activity != null) {
-					activity.onBackPressed();
-				}
+		btnCancel.setOnClickListener(v -> {
+			FragmentActivity activity = getActivity();
+			if (activity != null) {
+				activity.onBackPressed();
 			}
 		});
-		UiUtilities.setupDialogButton(isNightMode(), cancelButton, UiUtilities.DialogButtonType.SECONDARY, R.string.shared_string_cancel);
-		UiUtilities.setupDialogButton(isNightMode(), applyButton, UiUtilities.DialogButtonType.PRIMARY, R.string.shared_string_apply);
-		AndroidUiHelper.updateVisibility(applyButton, true);
+		UiUtilities.setupDialogButton(isNightMode(), btnCancel, UiUtilities.DialogButtonType.SECONDARY, R.string.shared_string_cancel);
+		UiUtilities.setupDialogButton(isNightMode(), btnApply, UiUtilities.DialogButtonType.PRIMARY, R.string.shared_string_apply);
+		AndroidUiHelper.updateVisibility(btnApply, true);
 		AndroidUiHelper.updateVisibility(view.findViewById(R.id.buttons_divider), true);
 	}
 
-	private void setApplyButtonEnabled(boolean enabled) {
-		if (applyButton != null) {
-			applyButton.setEnabled(enabled);
-		}
-	}
-
 	private void updateCards() {
 		MapActivity mapActivity = getMapActivity();
 		if (mapActivity != null) {
@@ -308,186 +177,151 @@ private void updateCards() {
 			cardsContainer.removeAllViews();
 
 			if (getTopView() != null) {
-				sliderCard = new SliderCard(mapActivity, distanceThreshold);
+				sliderCard = new SliderCard(mapActivity, helper.getDistanceThreshold());
 				sliderCard.setListener(this);
 				getTopView().addView(sliderCard.build(mapActivity));
 			}
 
-			ProfileCard profileCard = new ProfileCard(mapActivity, snapToRoadAppMode);
+			ProfileCard profileCard = new ProfileCard(mapActivity, helper.getAppMode());
 			profileCard.setListener(this);
 			cardsContainer.addView(profileCard.build(mapActivity));
 		}
 	}
 
 	@Override
-	public boolean shouldShowMapControls(int menuState) {
-		return (menuState & (MenuState.HEADER_ONLY | MenuState.HALF_SCREEN)) != 0;
+	public void onSliderChange(int sliderValue) {
+		helper.setDistanceThreshold(sliderValue, true);
 	}
 
-	public static void showInstance(@NonNull FragmentManager fragmentManager,
-	                                @Nullable Fragment targetFragment,
-									@NonNull List<List<WptPt>> pointsList,
-	                                @Nullable ApplicationMode appMode) {
-		if (AndroidUtils.isFragmentCanBeAdded(fragmentManager, TAG)) {
-			GpxApproximationFragment fragment = new GpxApproximationFragment();
-			fragment.setRetainInstance(true);
-			fragment.setTargetFragment(targetFragment, REQUEST_CODE);
-			List<LocationsHolder> locationsHolders = new ArrayList<>();
-			for (List<WptPt> points : pointsList) {
-				locationsHolders.add(new LocationsHolder(points));
-			}
-			fragment.setLocationsHolders(locationsHolders);
-			fragment.setSnapToRoadAppMode(appMode);
-			fragmentManager.beginTransaction()
-					.replace(R.id.fragmentContainer, fragment, TAG)
-					.addToBackStack(TAG)
-					.commitAllowingStateLoss();
+	@Override
+	public void onProfileSelect(ApplicationMode applicationMode) {
+		helper.setAppMode(applicationMode, true);
+	}
+
+	@Override
+	public void onNewApproximation() {
+		startProgress();
+	}
+
+	@Override
+	public void onApproximationStarted() {
+		setApplyButtonEnabled(false);
+	}
+
+	@Override
+	public void updateApproximationProgress(@NonNull GpxApproximator approximator, int progress) {
+		if (isResumed() && helper.isSameApproximator(approximator)) {
+			updateProgress(progress);
 		}
 	}
 
-	public void dismissImmediate() {
-		MapActivity mapActivity = getMapActivity();
-		if (mapActivity != null) {
-			try {
-				mapActivity.getSupportFragmentManager().popBackStackImmediate(TAG, FragmentManager.POP_BACK_STACK_INCLUSIVE);
-			} catch (Exception e) {
-				LOG.error(e);
-			}
+	@Override
+	public void processApproximationResults(@NonNull List<GpxRouteApproximation> approximations,
+	                                        @NonNull List<List<WptPt>> points) {
+		finishProgress();
+		Fragment fragment = getTargetFragment();
+		if (fragment instanceof GpxApproximationFragmentListener) {
+			((GpxApproximationFragmentListener) fragment)
+					.onGpxApproximationDone(approximations, points, helper.getAppMode());
 		}
+		setApplyButtonEnabled(!approximations.isEmpty());
 	}
 
-	public boolean calculateGpxApproximation(boolean newCalculation) {
-		if (newCalculation) {
-			if (gpxApproximator != null) {
-				gpxApproximator.cancelApproximation();
-				gpxApproximator = null;
-			}
-			resultMap.clear();
-			startProgress();
+	private void setApplyButtonEnabled(boolean enabled) {
+		if (btnApply != null) {
+			btnApply.setEnabled(enabled);
 		}
-		GpxApproximator gpxApproximator = null;
-		for (LocationsHolder locationsHolder : locationsHolders) {
-			if (!resultMap.containsKey(locationsHolder)) {
-				gpxApproximator = getNewGpxApproximator(locationsHolder);
-				break;
-			}
+	}
+
+	public void startProgress() {
+		if (pbProgress != null) {
+			pbProgress.setProgress(0);
+			pbProgress.setVisibility(View.VISIBLE);
 		}
-		if (gpxApproximator != null) {
-			try {
-				this.gpxApproximator = gpxApproximator;
-				gpxApproximator.setMode(snapToRoadAppMode);
-				gpxApproximator.setPointApproximation(distanceThreshold);
-				approximateGpx(gpxApproximator);
-				return true;
-			} catch (Exception e) {
-				LOG.error(e.getMessage(), e);
+	}
+
+	public void updateProgress(int progress) {
+		if (pbProgress != null) {
+			if (pbProgress.getVisibility() != View.VISIBLE) {
+				pbProgress.setVisibility(View.VISIBLE);
 			}
+			pbProgress.setProgress(progress);
 		}
-		return false;
 	}
 
-	@Override
-	public void onSliderChange(int sliderValue) {
-		if (distanceThreshold != sliderValue) {
-			distanceThreshold = sliderValue;
-			calculateGpxApproximation(true);
+	public void finishProgress() {
+		if (pbProgress != null) {
+			pbProgress.setVisibility(View.GONE);
 		}
 	}
 
 	@Override
-	public void onProfileSelect(ApplicationMode applicationMode) {
-		if (setSnapToRoadAppMode(applicationMode)) {
-			calculateGpxApproximation(true);
+	public void onResume() {
+		super.onResume();
+		if (!helper.canApproximate()) {
+			dismiss();
 		}
 	}
 
-	public boolean setSnapToRoadAppMode(ApplicationMode appMode) {
-		if (appMode != null && snapToRoadAppMode != appMode) {
-			snapToRoadAppMode = appMode;
-			return true;
+	@Override
+	public void onDestroyView() {
+		super.onDestroyView();
+		helper.cancelApproximationIfPossible();
+		if (!applyApproximation) {
+			Fragment fragment = getTargetFragment();
+			if (fragment instanceof GpxApproximationFragmentListener) {
+				((GpxApproximationFragmentListener) fragment).onCancelGpxApproximation();
+			}
 		}
-		return false;
 	}
 
-	public List<LocationsHolder> getLocationsHolders() {
-		return locationsHolders;
+	@Override
+	public int getMainLayoutId() {
+		return R.layout.fragment_gpx_approximation_bottom_sheet_dialog;
 	}
 
-	public void setLocationsHolders(@NonNull List<LocationsHolder> locationsHolders) {
-		this.locationsHolders = locationsHolders;
+	@Override
+	public int getTopViewId() {
+		return R.id.gpx_approximation_top_shadow_all;
 	}
 
-	public void startProgress() {
-		if (progressBar != null) {
-			progressBar.setProgress(0);
-			progressBar.setVisibility(View.VISIBLE);
-		}
+	@Override
+	public int getHeaderViewHeight() {
+		return menuTitleHeight;
 	}
 
-	public void finishProgress() {
-		if (progressBar != null) {
-			progressBar.setVisibility(View.GONE);
-		}
+	@Override
+	public boolean isHeaderViewDetached() {
+		return true;
 	}
 
-	public void updateProgress(int progress) {
-		if (progressBar != null) {
-			if (progressBar.getVisibility() != View.VISIBLE) {
-				progressBar.setVisibility(View.VISIBLE);
-			}
-			progressBar.setProgress(progress);
-		}
+	@Override
+	public int getToolbarHeight() {
+		return 0;
 	}
 
-	private void approximateGpx(@NonNull GpxApproximator gpxApproximator) {
-		onApproximationStarted();
-		gpxApproximator.calculateGpxApproximation(new ResultMatcher<GpxRouteApproximation>() {
-			@Override
-			public boolean publish(GpxRouteApproximation gpxApproximation) {
-				OsmandApplication app = getMyApplication();
-				if (app != null) {
-					app.runInUIThread(() -> {
-						if (!gpxApproximator.isCancelled()) {
-							if (gpxApproximation != null) {
-								resultMap.put(gpxApproximator.getLocationsHolder(), gpxApproximation);
-							}
-							if (!calculateGpxApproximation(false)) {
-								onApproximationFinished();
-							}
-						}
-					});
-				}
-				return true;
-			}
+	public float getMiddleStateKoef() {
+		return 0.5f;
+	}
 
-			@Override
-			public boolean isCancelled() {
-				return false;
-			}
-		});
+	@Override
+	public int getSupportedMenuStatesPortrait() {
+		return MenuState.HEADER_ONLY | MenuState.HALF_SCREEN | MenuState.FULL_SCREEN;
 	}
 
-	private void onApproximationStarted() {
-		setApplyButtonEnabled(false);
+	@Override
+	public int getInitialMenuState() {
+		return MenuState.HALF_SCREEN;
 	}
 
-	private void onApproximationFinished() {
-		finishProgress();
-		Fragment fragment = getTargetFragment();
-		List<GpxRouteApproximation> approximations = new ArrayList<>();
-		List<List<WptPt>> points = new ArrayList<>();
-		for (LocationsHolder locationsHolder : locationsHolders) {
-			GpxRouteApproximation approximation = resultMap.get(locationsHolder);
-			if (approximation != null) {
-				approximations.add(approximation);
-				points.add(locationsHolder.getWptPtList());
-			}
-		}
-		if (fragment instanceof GpxApproximationFragmentListener) {
-			((GpxApproximationFragmentListener) fragment).onGpxApproximationDone(
-					approximations, points, snapToRoadAppMode);
-		}
-		setApplyButtonEnabled(!approximations.isEmpty());
+	@Override
+	protected boolean isHideable() {
+		return false;
+	}
+
+	@Override
+	public boolean shouldShowMapControls(int menuState) {
+		return (menuState & (MenuState.HEADER_ONLY | MenuState.HALF_SCREEN)) != 0;
 	}
 
 	@Override
@@ -495,12 +329,29 @@ protected String getThemeInfoProviderTag() {
 		return TAG;
 	}
 
-	public interface GpxApproximationFragmentListener {
-
-		void onGpxApproximationDone(List<GpxRouteApproximation> gpxApproximations, List<List<WptPt>> pointsList, ApplicationMode mode);
-
-		void onApplyGpxApproximation();
+	public void dismissImmediate() {
+		MapActivity mapActivity = getMapActivity();
+		if (mapActivity != null) {
+			try {
+				mapActivity.getSupportFragmentManager().popBackStackImmediate(TAG, FragmentManager.POP_BACK_STACK_INCLUSIVE);
+			} catch (Exception e) {
+				LOG.error(e);
+			}
+		}
+	}
 
-		void onCancelGpxApproximation();
+	public static void showInstance(@NonNull OsmandApplication app,
+	                                @NonNull FragmentManager fragmentManager,
+	                                @Nullable Fragment targetFragment,
+	                                @NonNull GpxApproximationParams params) {
+		if (AndroidUtils.isFragmentCanBeAdded(fragmentManager, TAG)) {
+			GpxApproximationFragment fragment = new GpxApproximationFragment(app, params);
+			fragment.setRetainInstance(true);
+			fragment.setTargetFragment(targetFragment, REQUEST_CODE);
+			fragmentManager.beginTransaction()
+					.replace(R.id.fragmentContainer, fragment, TAG)
+					.addToBackStack(TAG)
+					.commitAllowingStateLoss();
+		}
 	}
 }
diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationFragmentListener.java b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationFragmentListener.java
new file mode 100644
index 00000000000..7ed68cce577
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationFragmentListener.java
@@ -0,0 +1,17 @@
+package net.osmand.plus.measurementtool;
+
+import net.osmand.gpx.GPXUtilities.WptPt;
+import net.osmand.plus.settings.backend.ApplicationMode;
+import net.osmand.router.RoutePlannerFrontEnd.GpxRouteApproximation;
+
+import java.util.List;
+
+public interface GpxApproximationFragmentListener {
+
+	void onGpxApproximationDone(List<GpxRouteApproximation> gpxApproximations, List<List<WptPt>> pointsList, ApplicationMode mode);
+
+	void onApplyGpxApproximation();
+
+	void onCancelGpxApproximation();
+
+}
diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationHelper.java b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationHelper.java
new file mode 100644
index 00000000000..4bdf7ea3343
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationHelper.java
@@ -0,0 +1,220 @@
+package net.osmand.plus.measurementtool;
+
+import static net.osmand.plus.measurementtool.MeasurementToolFragment.getSuggestedFileName;
+
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+
+import net.osmand.CallbackWithObject;
+import net.osmand.LocationsHolder;
+import net.osmand.PlatformUtil;
+import net.osmand.ResultMatcher;
+import net.osmand.gpx.GPXFile;
+import net.osmand.gpx.GPXUtilities.WptPt;
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.routing.GpxApproximator;
+import net.osmand.plus.settings.backend.ApplicationMode;
+import net.osmand.router.RoutePlannerFrontEnd.GpxRouteApproximation;
+import net.osmand.util.Algorithms;
+
+import org.apache.commons.logging.Log;
+
+import java.io.IOException;
+import java.util.ArrayList;
+import java.util.HashMap;
+import java.util.List;
+import java.util.Map;
+
+public class GpxApproximationHelper {
+
+	private static final Log LOG = PlatformUtil.getLog(GpxApproximationHelper.class);
+
+	private final OsmandApplication app;
+	private GpxApproximator approximator;
+	@NonNull
+	private final GpxApproximationParams params;
+	private final Map<LocationsHolder, GpxRouteApproximation> resultMap = new HashMap<>();
+	private GpxApproximationListener listener;
+
+
+	public GpxApproximationHelper(@NonNull OsmandApplication app,
+	                              @NonNull GpxApproximationParams params) {
+		this.app = app;
+		this.params = params;
+	}
+
+	public boolean calculateGpxApproximation(boolean newCalculation) {
+		if (newCalculation) {
+			if (approximator != null) {
+				approximator.cancelApproximation();
+				approximator = null;
+			}
+			resultMap.clear();
+			notifyOnNewCalculation();
+		}
+		GpxApproximator gpxApproximator = null;
+		for (LocationsHolder locationsHolder : params.getLocationsHolders()) {
+			if (!resultMap.containsKey(locationsHolder)) {
+				gpxApproximator = createApproximator(locationsHolder);
+				break;
+			}
+		}
+		if (gpxApproximator != null) {
+			try {
+				this.approximator = gpxApproximator;
+				gpxApproximator.setMode(getAppMode());
+				gpxApproximator.setPointApproximation(getDistanceThreshold());
+				approximateGpx(gpxApproximator);
+				return true;
+			} catch (Exception e) {
+				LOG.error(e.getMessage(), e);
+			}
+		}
+		return false;
+	}
+
+	private void approximateGpx(@NonNull GpxApproximator gpxApproximator) {
+		notifyOnApproximationStarted();
+		gpxApproximator.calculateGpxApproximation(new ResultMatcher<GpxRouteApproximation>() {
+			@Override
+			public boolean publish(GpxRouteApproximation gpxApproximation) {
+				app.runInUIThread(() -> {
+					if (!gpxApproximator.isCancelled()) {
+						if (gpxApproximation != null) {
+							resultMap.put(gpxApproximator.getLocationsHolder(), gpxApproximation);
+						}
+						if (!calculateGpxApproximation(false)) {
+							notifyOnApproximationFinished();
+						}
+					}
+				});
+				return true;
+			}
+
+			@Override
+			public boolean isCancelled() {
+				return false;
+			}
+		});
+	}
+
+	public GpxApproximator createApproximator(@NonNull LocationsHolder locationsHolder) {
+		GpxApproximator approximator = null;
+		try {
+			approximator = new GpxApproximator(app, getAppMode(), getDistanceThreshold(), locationsHolder);
+			approximator.setApproximationListener(listener);
+		} catch (IOException e) {
+			LOG.error(e.getMessage(), e);
+		}
+		return approximator;
+	}
+
+	public void setListener(@Nullable GpxApproximationListener listener) {
+		this.listener = listener;
+	}
+
+	public void notifyOnNewCalculation() {
+		if (listener != null) {
+			listener.onNewApproximation();
+		}
+	}
+
+	public void notifyOnApproximationStarted() {
+		if (listener != null) {
+			listener.onApproximationStarted();
+		}
+	}
+
+	public void notifyOnApproximationFinished() {
+		if (listener != null) {
+			processApproximationResults();
+		}
+	}
+
+	private void processApproximationResults() {
+		List<GpxRouteApproximation> approximations = new ArrayList<>();
+		List<List<WptPt>> points = new ArrayList<>();
+		for (LocationsHolder locationsHolder : params.getLocationsHolders()) {
+			GpxRouteApproximation approximation = resultMap.get(locationsHolder);
+			if (approximation != null) {
+				approximations.add(approximation);
+				points.add(locationsHolder.getWptPtList());
+			}
+		}
+		listener.processApproximationResults(approximations, points);
+	}
+
+	public void setAppMode(@Nullable ApplicationMode appMode, boolean recalculate) {
+		if (params.setAppMode(appMode) && recalculate) {
+			calculateGpxApproximation(true);
+		}
+	}
+
+	@NonNull
+	public ApplicationMode getAppMode() {
+		return params.getAppMode();
+	}
+
+	@NonNull
+	public String getModeKey() {
+		ApplicationMode appMode = getAppMode();
+		return appMode.getStringKey();
+	}
+
+	public int getDistanceThreshold() {
+		return params.getDistanceThreshold();
+	}
+
+	public void setDistanceThreshold(int threshold, boolean recalculate) {
+		if (params.setDistanceThreshold(threshold) && recalculate) {
+			calculateGpxApproximation(true);
+		}
+	}
+
+	public boolean isSameApproximator(@NonNull GpxApproximator approximator) {
+		return this.approximator == approximator;
+	}
+
+	public boolean canApproximate() {
+		return !Algorithms.isEmpty(params.getLocationsHolders());
+	}
+
+	public void cancelApproximationIfPossible() {
+		if (approximator != null) {
+			approximator.cancelApproximation();
+		}
+	}
+
+	public static void approximateGpxSilently(@NonNull OsmandApplication app,
+	                                          @NonNull GPXFile gpxFile,
+	                                          @NonNull GpxApproximationParams params,
+	                                          @NonNull CallbackWithObject<GPXFile> callback) {
+		GpxData gpxData = new GpxData(gpxFile);
+		MeasurementEditingContext ctx = new MeasurementEditingContext(app);
+		ctx.setGpxData(gpxData);
+		ctx.setAppMode(params.getAppMode());
+		ctx.addPoints();
+		params.setTrackPoints(ctx.getSegmentsPoints());
+
+		GpxApproximationHelper helper = new GpxApproximationHelper(app, params);
+		helper.setListener(new GpxApproximationListener() {
+			@Override
+			public void processApproximationResults(@NonNull List<GpxRouteApproximation> approximations,
+			                                        @NonNull List<List<WptPt>> points) {
+				for (int i = 0; i < approximations.size(); i++) {
+					GpxRouteApproximation approximation = approximations.get(i);
+					List<WptPt> segment = points.get(i);
+					ctx.setPoints(approximation, segment, params.getAppMode(), false);
+				}
+				String trackName = getSuggestedFileName(app, ctx.getGpxData());
+				callback.processResult(ctx.exportGpx(trackName));
+			}
+		});
+
+		if (helper.canApproximate()) {
+			helper.calculateGpxApproximation(true);
+		} else {
+			callback.processResult(gpxFile);
+		}
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationListener.java b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationListener.java
new file mode 100644
index 00000000000..b76dac3320a
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationListener.java
@@ -0,0 +1,24 @@
+package net.osmand.plus.measurementtool;
+
+import androidx.annotation.NonNull;
+
+import net.osmand.gpx.GPXUtilities.WptPt;
+import net.osmand.plus.routing.GpxApproximator;
+import net.osmand.router.RoutePlannerFrontEnd.GpxRouteApproximation;
+
+import java.util.List;
+
+public interface GpxApproximationListener {
+	default void onNewApproximation() { }
+
+	default void onApproximationStarted() { }
+
+	default void onSegmentApproximationStarted(@NonNull GpxApproximator approximator) { }
+
+	default void onSegmentApproximationFinished(@NonNull GpxApproximator approximator) { }
+
+	default void updateApproximationProgress(@NonNull GpxApproximator approximator, int progress) { }
+
+	default void processApproximationResults(@NonNull List<GpxRouteApproximation> approximations,
+	                                         @NonNull List<List<WptPt>> points) { }
+}
diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationParams.java b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationParams.java
new file mode 100644
index 00000000000..20e7dffc1b5
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/GpxApproximationParams.java
@@ -0,0 +1,55 @@
+package net.osmand.plus.measurementtool;
+
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+
+import net.osmand.LocationsHolder;
+import net.osmand.gpx.GPXUtilities.WptPt;
+import net.osmand.plus.settings.backend.ApplicationMode;
+
+import java.util.ArrayList;
+import java.util.List;
+
+public class GpxApproximationParams {
+
+	private ApplicationMode appMode = ApplicationMode.CAR;
+	private int distanceThreshold = 50;
+	private List<LocationsHolder> locationsHolders;
+
+
+	public void setTrackPoints(@NonNull List<List<WptPt>> points) {
+		List<LocationsHolder> locationHolders = new ArrayList<>();
+		for (List<WptPt> segment : points) {
+			locationHolders.add(new LocationsHolder(segment));
+		}
+		this.locationsHolders = locationHolders;
+	}
+
+	public boolean setAppMode(@Nullable ApplicationMode appMode) {
+		if (appMode != null && this.appMode != appMode) {
+			this.appMode = appMode;
+			return true;
+		}
+		return false;
+	}
+
+	public boolean setDistanceThreshold(int newThreshold) {
+		if (this.distanceThreshold != newThreshold) {
+			this.distanceThreshold = newThreshold;
+			return true;
+		}
+		return false;
+	}
+
+	public ApplicationMode getAppMode() {
+		return appMode;
+	}
+
+	public int getDistanceThreshold() {
+		return distanceThreshold;
+	}
+
+	public List<LocationsHolder> getLocationsHolders() {
+		return locationsHolders;
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementEditingContext.java b/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementEditingContext.java
index 916c5077cad..37c2c474141 100644
--- a/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementEditingContext.java
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementEditingContext.java
@@ -344,6 +344,10 @@ public List<WptPt> getPoints() {
 		return getBeforePoints();
 	}
 
+	public List<List<WptPt>> getSegmentsPoints() {
+		return getSegmentsPoints(true, true);
+	}
+
 	@NonNull
 	public List<List<WptPt>> getSegmentsPoints(boolean plain, boolean route) {
 		List<List<WptPt>> res = new ArrayList<>();
diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java b/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java
index c7cce2d156b..323357a6a37 100644
--- a/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java
@@ -69,7 +69,6 @@
 import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.helpers.TargetPointsHelper;
 import net.osmand.plus.mapcontextmenu.other.TrackDetailsMenu;
-import net.osmand.plus.measurementtool.GpxApproximationFragment.GpxApproximationFragmentListener;
 import net.osmand.plus.measurementtool.MeasurementEditingContext.CalculationMode;
 import net.osmand.plus.measurementtool.OptionsBottomSheetDialogFragment.OptionsFragmentListener;
 import net.osmand.plus.measurementtool.RouteBetweenPointsBottomSheetDialogFragment.RouteBetweenPointsDialogMode;
@@ -433,38 +432,27 @@ public void refresh() {
 
 		Drawable undoDrawable = getActiveIcon(R.drawable.ic_action_undo_dark);
 		undoBtn.setImageDrawable(AndroidUtils.getDrawableForDirection(mapActivity, undoDrawable));
-		undoBtn.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View view) {
-				editingCtx.getCommandManager().undo();
-				updateUndoRedoButton(editingCtx.getCommandManager().canUndo(), undoBtn);
-				updateUndoRedoButton(true, redoBtn);
-				updateUndoRedoCommonStuff();
-			}
+		undoBtn.setOnClickListener(v -> {
+			editingCtx.getCommandManager().undo();
+			updateUndoRedoButton(editingCtx.getCommandManager().canUndo(), undoBtn);
+			updateUndoRedoButton(true, redoBtn);
+			updateUndoRedoCommonStuff();
 		});
 
 		Drawable redoDrawable = getActiveIcon(R.drawable.ic_action_redo_dark);
 		redoBtn.setImageDrawable(AndroidUtils.getDrawableForDirection(mapActivity, redoDrawable));
-		redoBtn.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View view) {
-				editingCtx.getCommandManager().redo();
-				updateUndoRedoButton(editingCtx.getCommandManager().canRedo(), redoBtn);
-				updateUndoRedoButton(true, undoBtn);
-				updateUndoRedoCommonStuff();
-			}
+		redoBtn.setOnClickListener(v -> {
+			editingCtx.getCommandManager().redo();
+			updateUndoRedoButton(editingCtx.getCommandManager().canRedo(), redoBtn);
+			updateUndoRedoButton(true, undoBtn);
+			updateUndoRedoCommonStuff();
 		});
 
 		View addPointButton = mainView.findViewById(R.id.add_point_button);
 		UiUtilities.setupDialogButton(nightMode, addPointButton,
 				UiUtilities.DialogButtonType.PRIMARY, R.string.shared_string_add);
 		addPointButton.setMinimumWidth(btnWidth);
-		addPointButton.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View view) {
-				addCenterPoint();
-			}
-		});
+		addPointButton.setOnClickListener(v -> addCenterPoint());
 
 		measurementLayer.setOnSingleTapListener(new MeasurementToolLayer.OnSingleTapListener() {
 			@Override
@@ -950,8 +938,11 @@ private void onSnapTrackWarningResult(int resultCode) {
 			if (Algorithms.isEmpty(pointsSegments)) {
 				onCancelSnapTrackWarning();
 			} else if (mapActivity != null) {
+				GpxApproximationParams params = new GpxApproximationParams();
+				params.setTrackPoints(pointsSegments);
+				params.setAppMode(mode);
 				FragmentManager fragmentManager = mapActivity.getSupportFragmentManager();
-				GpxApproximationFragment.showInstance(fragmentManager, this, pointsSegments, mode);
+				GpxApproximationFragment.showInstance(app, fragmentManager, this, params);
 			}
 		} else if (resultCode == SnapTrackWarningFragment.CONNECT_STRAIGHT_LINE_RESULT_CODE) {
 			MeasurementToolLayer measurementLayer = getMeasurementLayer();
@@ -1749,7 +1740,10 @@ private boolean isCurrentInfoType(@NonNull InfoType type) {
 	}
 
 	private String getSuggestedFileName() {
-		GpxData gpxData = editingCtx.getGpxData();
+		return getSuggestedFileName(app, editingCtx.getGpxData());
+	}
+
+	public static String getSuggestedFileName(@NonNull OsmandApplication app, @Nullable GpxData gpxData) {
 		String displayedName = null;
 		if (gpxData != null) {
 			GPXFile gpxFile = gpxData.getGpxFile();
diff --git a/OsmAnd/src/net/osmand/plus/routing/GpxApproximator.java b/OsmAnd/src/net/osmand/plus/routing/GpxApproximator.java
index 3569b1092ea..151f9a62acb 100644
--- a/OsmAnd/src/net/osmand/plus/routing/GpxApproximator.java
+++ b/OsmAnd/src/net/osmand/plus/routing/GpxApproximator.java
@@ -1,12 +1,14 @@
 package net.osmand.plus.routing;
 
 import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
 
 import net.osmand.LocationsHolder;
 import net.osmand.PlatformUtil;
 import net.osmand.ResultMatcher;
 import net.osmand.data.LatLon;
 import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.measurementtool.GpxApproximationListener;
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.router.RouteCalculationProgress;
 import net.osmand.router.RoutePlannerFrontEnd.GpxPoint;
@@ -36,22 +38,12 @@ public class GpxApproximator {
 	private LatLon start;
 	private LatLon end;
 	private float pointApproximation = 50;
+	private GpxApproximationListener listener;
 	private Runnable approximationTask;
 
 	private static final ThreadPoolExecutor SINGLE_THREAD_EXECUTOR
 			= new ThreadPoolExecutor(1, 1, 0L, TimeUnit.MILLISECONDS, new LinkedBlockingQueue<Runnable>());
 
-	private GpxApproximationProgressCallback approximationProgress;
-
-	public interface GpxApproximationProgressCallback {
-
-		void start(GpxApproximator approximator);
-
-		void updateProgress(GpxApproximator approximator, int progress);
-
-		void finish(GpxApproximator approximator);
-	}
-
 	public GpxApproximator(@NonNull OsmandApplication ctx, @NonNull LocationsHolder locationsHolder) throws IOException {
 		this.ctx = ctx;
 		this.locationsHolder = locationsHolder;
@@ -110,10 +102,6 @@ public void setMode(ApplicationMode mode) throws IOException {
 		}
 	}
 
-	public float getPointApproximation() {
-		return pointApproximation;
-	}
-
 	public void setPointApproximation(float pointApproximation) {
 		this.pointApproximation = pointApproximation;
 	}
@@ -122,12 +110,8 @@ public LocationsHolder getLocationsHolder() {
 		return locationsHolder;
 	}
 
-	public GpxApproximationProgressCallback getApproximationProgress() {
-		return approximationProgress;
-	}
-
-	public void setApproximationProgress(GpxApproximationProgressCallback approximationProgress) {
-		this.approximationProgress = approximationProgress;
+	public void setApproximationListener(@Nullable GpxApproximationListener listener) {
+		this.listener = listener;
 	}
 
 	public boolean isCancelled() {
@@ -146,8 +130,8 @@ public void calculateGpxApproximation(@NonNull ResultMatcher<GpxRouteApproximati
 		}
 		GpxRouteApproximation gctx = getNewGpxApproximationContext();
 		this.gctx = gctx;
-		startProgress();
-		updateProgress(gctx);
+		notifyOnStart();
+		notifyUpdateProgress(gctx);
 		approximationTask = () -> {
 			try {
 				routingHelper.calculateGpxApproximation(env, gctx, getPoints(), resultMatcher);
@@ -160,33 +144,35 @@ public void calculateGpxApproximation(@NonNull ResultMatcher<GpxRouteApproximati
 		SINGLE_THREAD_EXECUTOR.submit(approximationTask);
 	}
 
-	private void startProgress() {
-		GpxApproximationProgressCallback approximationProgress = this.approximationProgress;
-		if (approximationProgress != null) {
-			approximationProgress.start(this);
+	private void notifyOnStart() {
+		if (listener != null) {
+			listener.onSegmentApproximationStarted(this);
+		}
+	}
+
+	private void notifyOnUpdateProgress(float progress) {
+		if (listener != null) {
+			listener.updateApproximationProgress(this, (int) progress);
 		}
 	}
 
-	private void finishProgress() {
-		GpxApproximationProgressCallback approximationProgress = this.approximationProgress;
-		if (approximationProgress != null) {
-			approximationProgress.finish(this);
+	private void notifyOnFinish() {
+		if (listener != null) {
+			listener.onSegmentApproximationFinished(this);
 		}
 	}
 
-	private void updateProgress(@NonNull GpxRouteApproximation gctx) {
-		GpxApproximationProgressCallback approximationProgress = this.approximationProgress;
-		if (approximationProgress != null) {
+	private void notifyUpdateProgress(@NonNull GpxRouteApproximation gctx) {
+		if (listener != null) {
 			ctx.runInUIThread(() -> {
-				RouteCalculationProgress calculationProgress = gctx.ctx.calculationProgress;
+				RouteCalculationProgress progressInfo = gctx.ctx.calculationProgress;
 				if (approximationTask == null && GpxApproximator.this.gctx == gctx) {
-					finishProgress();
+					notifyOnFinish();
 				}
-				if (approximationTask != null && calculationProgress != null && !calculationProgress.isCancelled) {
-					float pr = calculationProgress.getApproximationProgress();
-					approximationProgress.updateProgress(GpxApproximator.this, (int) pr);
+				if (approximationTask != null && progressInfo != null && !progressInfo.isCancelled) {
+					notifyOnUpdateProgress(progressInfo.getApproximationProgress());
 					if (GpxApproximator.this.gctx == gctx) {
-						updateProgress(gctx);
+						notifyUpdateProgress(gctx);
 					}
 				}
 			}, 300);
