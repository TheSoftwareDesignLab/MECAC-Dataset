diff --git a/OsmAnd/res/values/ids.xml b/OsmAnd/res/values/ids.xml
index 19a023ee8ad..6aaeced1aae 100644
--- a/OsmAnd/res/values/ids.xml
+++ b/OsmAnd/res/values/ids.xml
@@ -16,5 +16,8 @@
     <item name="av_notes_widget_state_audio" type="id"/>
     <item name="av_notes_widget_state_video" type="id"/>
     <item name="av_notes_widget_state_photo" type="id"/>
+    <!-- Elevation profile widget ids-->
+    <item name="elevation_widget_show_slopes" type="id"/>
+    <item name="elevation_widget_hide_slopes" type="id"/>
 
 </resources>
\ No newline at end of file
diff --git a/OsmAnd/src/net/osmand/plus/activities/MapActivityLayers.java b/OsmAnd/src/net/osmand/plus/activities/MapActivityLayers.java
index 8c26c705f8f..11d16ffa938 100644
--- a/OsmAnd/src/net/osmand/plus/activities/MapActivityLayers.java
+++ b/OsmAnd/src/net/osmand/plus/activities/MapActivityLayers.java
@@ -100,7 +100,7 @@ public class MapActivityLayers {
 
 	public MapActivityLayers(MapActivity activity) {
 		this.activity = activity;
-		this.mapWidgetRegistry = new MapWidgetRegistry(activity.getMyApplication());
+		this.mapWidgetRegistry = new MapWidgetRegistry(activity);
 	}
 
 	public MapWidgetRegistry getMapWidgetRegistry() {
diff --git a/OsmAnd/src/net/osmand/plus/dashboard/DashboardOnMap.java b/OsmAnd/src/net/osmand/plus/dashboard/DashboardOnMap.java
index e6b761eabda..e8ba1f90ef6 100644
--- a/OsmAnd/src/net/osmand/plus/dashboard/DashboardOnMap.java
+++ b/OsmAnd/src/net/osmand/plus/dashboard/DashboardOnMap.java
@@ -387,7 +387,7 @@ public boolean onMenuItemClick(MenuItem menuItem) {
 						if (mil != null) {
 							mil.recreateControls();
 						}
-						updateListAdapter(registry.getViewConfigureMenuAdapter(mapActivity));
+						updateListAdapter(registry.getViewConfigureMenuAdapter());
 					}
 					return false;
 				}
@@ -705,7 +705,7 @@ private void updateListAdapter() {
 		listView.setEmptyView(null);
 		ContextMenuAdapter cm = null;
 		if (visibleType == DashboardType.CONFIGURE_SCREEN) {
-			cm = mapActivity.getMapLayers().getMapWidgetRegistry().getViewConfigureMenuAdapter(mapActivity);
+			cm = mapActivity.getMapLayers().getMapWidgetRegistry().getViewConfigureMenuAdapter();
 		} else if (visibleType == DashboardType.CONFIGURE_MAP) {
 			cm = new ConfigureMapMenu().createListAdapter(mapActivity);
 		} else if (visibleType == DashboardType.LIST_MENU) {
diff --git a/OsmAnd/src/net/osmand/plus/mapillary/MapillaryPlugin.java b/OsmAnd/src/net/osmand/plus/mapillary/MapillaryPlugin.java
index 4be50700cc8..39264cf6a04 100644
--- a/OsmAnd/src/net/osmand/plus/mapillary/MapillaryPlugin.java
+++ b/OsmAnd/src/net/osmand/plus/mapillary/MapillaryPlugin.java
@@ -37,7 +37,7 @@
 import net.osmand.plus.views.MapTileLayer;
 import net.osmand.plus.views.OsmandMapTileView;
 import net.osmand.plus.views.layers.MapInfoLayer;
-import net.osmand.plus.views.mapwidgets.MapWidgetRegistry.MapWidgetRegInfo;
+import net.osmand.plus.views.mapwidgets.MapWidgetRegInfo;
 import net.osmand.plus.views.mapwidgets.widgets.TextInfoWidget;
 import net.osmand.util.Algorithms;
 
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegInfo.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegInfo.java
new file mode 100644
index 00000000000..83b8e5b7eec
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegInfo.java
@@ -0,0 +1,162 @@
+package net.osmand.plus.views.mapwidgets;
+
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.StringRes;
+
+import net.osmand.plus.settings.backend.ApplicationMode;
+import net.osmand.plus.views.mapwidgets.widgets.TextInfoWidget;
+import net.osmand.plus.views.mapwidgets.widgetstates.WidgetState;
+
+import java.util.Collections;
+import java.util.LinkedHashSet;
+import java.util.Set;
+
+public class MapWidgetRegInfo implements Comparable<MapWidgetRegInfo> {
+	public final TextInfoWidget widget;
+	@DrawableRes
+	private int drawableMenu;
+	@StringRes
+	private int messageId;
+	private String message;
+	private WidgetState widgetState;
+	public final String key;
+	public final boolean left;
+	public final int priorityOrder;
+	private final Set<ApplicationMode> visibleCollapsible = new LinkedHashSet<>();
+	private final Set<ApplicationMode> visibleModes = new LinkedHashSet<>();
+	private Runnable stateChangeListener = null;
+
+	public MapWidgetRegInfo(String key, TextInfoWidget widget, @DrawableRes int drawableMenu,
+	                        @StringRes int messageId, int priorityOrder, boolean left) {
+		this.key = key;
+		this.widget = widget;
+		this.drawableMenu = drawableMenu;
+		this.messageId = messageId;
+		this.priorityOrder = priorityOrder;
+		this.left = left;
+	}
+
+	public MapWidgetRegInfo(String key, TextInfoWidget widget, @DrawableRes int drawableMenu,
+	                        String message, int priorityOrder, boolean left) {
+		this.key = key;
+		this.widget = widget;
+		this.drawableMenu = drawableMenu;
+		this.message = message;
+		this.priorityOrder = priorityOrder;
+		this.left = left;
+	}
+
+	public MapWidgetRegInfo(String key, TextInfoWidget widget, WidgetState widgetState,
+	                        int priorityOrder, boolean left) {
+		this.key = key;
+		this.widget = widget;
+		this.widgetState = widgetState;
+		this.priorityOrder = priorityOrder;
+		this.left = left;
+	}
+
+	public WidgetState getWidgetState() {
+		return widgetState;
+	}
+
+	public int getDrawableMenu() {
+		if (widgetState != null) {
+			return widgetState.getMenuIconId();
+		} else {
+			return drawableMenu;
+		}
+	}
+
+	public String getMessage() {
+		return message;
+	}
+
+	public int getMessageId() {
+		if (widgetState != null) {
+			return widgetState.getMenuTitleId();
+		} else {
+			return messageId;
+		}
+	}
+
+	public boolean isVisibleCollapsed(ApplicationMode mode) {
+		return visibleCollapsible.contains(mode);
+	}
+
+	public boolean isVisible(ApplicationMode mode) {
+		return visibleModes.contains(mode);
+	}
+
+	public void addVisible(ApplicationMode mode) {
+		visibleModes.add(mode);
+	}
+
+	public void addVisibleCollapsible(ApplicationMode mode) {
+		visibleCollapsible.add(mode);
+	}
+
+	public void removeVisible(ApplicationMode mode) {
+		visibleModes.remove(mode);
+	}
+
+	public void removeVisibleCollapsible(ApplicationMode mode) {
+		visibleCollapsible.remove(mode);
+	}
+
+	public MapWidgetRegInfo required(ApplicationMode... modes) {
+		Collections.addAll(visibleModes, modes);
+		return this;
+	}
+
+	public void setStateChangeListener(Runnable stateChangeListener) {
+		this.stateChangeListener = stateChangeListener;
+	}
+
+	public Runnable getStateChangeListener() {
+		return stateChangeListener;
+	}
+
+	@Override
+	public int hashCode() {
+		if (getMessage() != null) {
+			return getMessage().hashCode();
+		}
+		return getMessageId();
+	}
+
+	@Override
+	public boolean equals(Object obj) {
+		if (this == obj) {
+			return true;
+		} else if (obj == null) {
+			return false;
+		} else if (getClass() != obj.getClass()) {
+			return false;
+		}
+		MapWidgetRegInfo other = (MapWidgetRegInfo) obj;
+		if (getMessageId() == 0 && other.getMessageId() == 0) {
+			return key.equals(other.key);
+		}
+		return getMessageId() == other.getMessageId();
+	}
+
+	@Override
+	public int compareTo(@NonNull MapWidgetRegInfo another) {
+		if (getMessageId() == 0 && another.getMessageId() == 0) {
+			if (key.equals(another.key)) {
+				return 0;
+			}
+		} else if (getMessageId() == another.getMessageId()) {
+			return 0;
+		}
+		if (priorityOrder == another.priorityOrder) {
+			if (getMessageId() == 0 && another.getMessageId() == 0) {
+				return key.compareTo(key);
+			} else {
+				return getMessageId() - another.getMessageId();
+			}
+		}
+		return priorityOrder - another.priorityOrder;
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java
index a64fb19f024..153ca955494 100644
--- a/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java
@@ -8,6 +8,7 @@
 
 import androidx.annotation.DrawableRes;
 import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
 import androidx.annotation.StringRes;
 
 import net.osmand.plus.settings.backend.ApplicationMode;
@@ -26,6 +27,7 @@
 import net.osmand.plus.views.layers.MapQuickActionLayer;
 import net.osmand.plus.views.OsmandMapLayer.DrawSettings;
 import net.osmand.plus.views.mapwidgets.widgets.TextInfoWidget;
+import net.osmand.plus.views.mapwidgets.widgetstates.ElevationProfileWidgetState;
 import net.osmand.plus.views.mapwidgets.widgetstates.WidgetState;
 import net.osmand.plus.widgets.popup.PopUpMenuItem;
 import net.osmand.plus.widgets.popup.PopUpMenuHelper;
@@ -73,26 +75,28 @@ public class MapWidgetRegistry {
 	private Set<MapWidgetRegInfo> leftWidgetSet = new TreeSet<>();
 	private Set<MapWidgetRegInfo> rightWidgetSet = new TreeSet<>();
 	private Map<ApplicationMode, Set<String>> visibleElementsFromSettings = new LinkedHashMap<>();
+	private final MapActivity map;
 	private final OsmandApplication app;
 	private final OsmandSettings settings;
 
-	public MapWidgetRegistry(OsmandApplication app) {
-		this.app = app;
+	public MapWidgetRegistry(MapActivity map) {
+		this.map = map;
+		this.app = map.getMyApplication();
 		this.settings = app.getSettings();
 		loadVisibleElementsFromSettings();
 	}
 
 	public void populateStackControl(LinearLayout stack,
-									 ApplicationMode mode, boolean left, boolean expanded) {
+	                                 ApplicationMode mode, boolean left, boolean expanded) {
 		Set<MapWidgetRegInfo> s = left ? this.leftWidgetSet : this.rightWidgetSet;
 		for (MapWidgetRegInfo r : s) {
-			if (r.widget != null && (r.visible(mode) || r.widget.isExplicitlyVisible())) {
+			if (r.widget != null && (r.isVisible(mode) || r.widget.isExplicitlyVisible())) {
 				stack.addView(r.widget.getView());
 			}
 		}
 		if (expanded) {
 			for (MapWidgetRegInfo r : s) {
-				if (r.widget != null && r.visibleCollapsed(mode) && !r.widget.isExplicitlyVisible()) {
+				if (r.widget != null && r.isVisibleCollapsed(mode) && !r.widget.isExplicitlyVisible()) {
 					stack.addView(r.widget.getView());
 				}
 			}
@@ -101,12 +105,12 @@ public void populateStackControl(LinearLayout stack,
 
 	public boolean hasCollapsibles(ApplicationMode mode) {
 		for (MapWidgetRegInfo r : leftWidgetSet) {
-			if (r.visibleCollapsed(mode)) {
+			if (r.isVisibleCollapsed(mode)) {
 				return true;
 			}
 		}
 		for (MapWidgetRegInfo r : rightWidgetSet) {
-			if (r.visibleCollapsed(mode)) {
+			if (r.isVisibleCollapsed(mode)) {
 				return true;
 			}
 		}
@@ -121,7 +125,7 @@ public void updateInfo(ApplicationMode mode, DrawSettings drawSettings, boolean
 
 	private void update(ApplicationMode mode, DrawSettings drawSettings, boolean expanded, Set<MapWidgetRegInfo> l) {
 		for (MapWidgetRegInfo r : l) {
-			if (r.widget != null && (r.visible(mode) || (r.visibleCollapsed(mode) && expanded))) {
+			if (r.widget != null && (r.isVisible(mode) || (r.isVisibleCollapsed(mode) && expanded))) {
 				r.widget.updateInfo(drawSettings);
 			}
 		}
@@ -160,8 +164,8 @@ public <T extends TextInfoWidget> T getSideWidget(Class<T> cl) {
 	}
 
 	public MapWidgetRegInfo registerSideWidgetInternal(TextInfoWidget widget,
-													   WidgetState widgetState,
-													   String key, boolean left, int priorityOrder) {
+	                                                   WidgetState widgetState,
+	                                                   String key, boolean left, int priorityOrder) {
 		MapWidgetRegInfo ii = new MapWidgetRegInfo(key, widget, widgetState, priorityOrder, left);
 		processVisibleModes(key, ii);
 		if (widget != null) {
@@ -176,9 +180,9 @@ public MapWidgetRegInfo registerSideWidgetInternal(TextInfoWidget widget,
 	}
 
 	public MapWidgetRegInfo registerSideWidgetInternal(TextInfoWidget widget,
-													   @DrawableRes int drawableMenu,
-													   String message,
-													   String key, boolean left, int priorityOrder) {
+	                                                   @DrawableRes int drawableMenu,
+	                                                   String message,
+	                                                   String key, boolean left, int priorityOrder) {
 		MapWidgetRegInfo ii = new MapWidgetRegInfo(key, widget, drawableMenu,
 				message, priorityOrder, left);
 		processVisibleModes(key, ii);
@@ -194,9 +198,9 @@ public MapWidgetRegInfo registerSideWidgetInternal(TextInfoWidget widget,
 	}
 
 	public MapWidgetRegInfo registerSideWidgetInternal(TextInfoWidget widget,
-													   @DrawableRes int drawableMenu,
-													   @StringRes int messageId,
-													   String key, boolean left, int priorityOrder) {
+	                                                   @DrawableRes int drawableMenu,
+	                                                   @StringRes int messageId,
+	                                                   String key, boolean left, int priorityOrder) {
 		MapWidgetRegInfo ii = new MapWidgetRegInfo(key, widget, drawableMenu,
 				messageId, priorityOrder, left);
 		processVisibleModes(key, ii);
@@ -229,21 +233,21 @@ private void processVisibleModes(String key, MapWidgetRegInfo ii) {
 				}
 			}
 			if (def) {
-				ii.visibleModes.add(ms);
+				ii.addVisible(ms);
 			} else if (collapse) {
-				ii.visibleCollapsible.add(ms);
+				ii.addVisibleCollapsible(ms);
 			} else {
-				ii.visibleModes.remove(ms);
-				ii.visibleCollapsible.remove(ms);
+				ii.removeVisible(ms);
+				ii.removeVisibleCollapsible(ms);
 			}
 		}
 	}
 
 	private void restoreModes(Set<String> set, Set<MapWidgetRegInfo> mi, ApplicationMode mode) {
 		for (MapWidgetRegInfo m : mi) {
-			if (m.visibleModes.contains(mode)) {
+			if (m.isVisible(mode)) {
 				set.add(m.key);
-			} else if (m.visibleCollapsible != null && m.visibleCollapsible.contains(mode)) {
+			} else if (m.isVisibleCollapsed(mode)) {
 				set.add(COLLAPSED_PREFIX + m.key);
 			} else {
 				set.add(HIDE_PREFIX + m.key);
@@ -257,6 +261,24 @@ public boolean isVisible(String key) {
 		return elements != null && (elements.contains(key) || elements.contains(COLLAPSED_PREFIX + key));
 	}
 
+	private void setVisibility(ArrayAdapter<ContextMenuItem> adapter,
+	                           MapWidgetRegInfo r,
+	                           int position,
+	                           boolean visible,
+	                           boolean collapsed) {
+		setVisibility(r, visible, collapsed);
+		MapInfoLayer mil = map.getMapLayers().getMapInfoLayer();
+		if (mil != null) {
+			mil.recreateControls();
+		}
+
+		ContextMenuItem item = adapter.getItem(position);
+		item.setSelected(visible);
+		item.setColor(app, visible ? R.color.osmand_orange : ContextMenuItem.INVALID_ID);
+		item.setDescription(visible && collapsed ? getString(R.string.shared_string_collapse) : null);
+		adapter.notifyDataSetChanged();
+	}
+
 	public void setVisibility(MapWidgetRegInfo m, boolean visible, boolean collapsed) {
 		ApplicationMode mode = settings.APPLICATION_MODE.get();
 		setVisibility(mode, m, visible, collapsed);
@@ -268,23 +290,23 @@ public void setVisibility(ApplicationMode mode, MapWidgetRegInfo m, boolean visi
 		this.visibleElementsFromSettings.get(mode).remove(m.key);
 		this.visibleElementsFromSettings.get(mode).remove(COLLAPSED_PREFIX + m.key);
 		this.visibleElementsFromSettings.get(mode).remove(HIDE_PREFIX + m.key);
-		m.visibleModes.remove(mode);
-		m.visibleCollapsible.remove(mode);
+		m.removeVisible(mode);
+		m.removeVisibleCollapsible(mode);
 		if (visible && collapsed) {
 			// Set "collapsed" state
-			m.visibleCollapsible.add(mode);
+			m.addVisibleCollapsible(mode);
 			this.visibleElementsFromSettings.get(mode).add(COLLAPSED_PREFIX + m.key);
 		} else if (visible) {
 			// Set "visible" state
-			m.visibleModes.add(mode);
+			m.addVisible(mode);
 			this.visibleElementsFromSettings.get(mode).add(SHOW_PREFIX + m.key);
 		} else {
 			// Set "hidden" state
 			this.visibleElementsFromSettings.get(mode).add(HIDE_PREFIX + m.key);
 		}
 		saveVisibleElementsToSettings(mode);
-		if (m.stateChangeListener != null) {
-			m.stateChangeListener.run();
+		if (m.getStateChangeListener() != null) {
+			m.getStateChangeListener().run();
 		}
 	}
 
@@ -332,13 +354,13 @@ private void saveVisibleElementsToSettings(ApplicationMode mode) {
 
 	private void resetDefault(ApplicationMode mode, Set<MapWidgetRegInfo> set) {
 		for (MapWidgetRegInfo ri : set) {
-			ri.visibleCollapsible.remove(mode);
-			ri.visibleModes.remove(mode);
+			ri.removeVisibleCollapsible(mode);
+			ri.removeVisible(mode);
 			if (mode.isWidgetVisible(ri.key)) {
 				if (mode.isWidgetCollapsible(ri.key)) {
-					ri.visibleCollapsible.add(mode);
+					ri.addVisibleCollapsible(mode);
 				} else {
-					ri.visibleModes.add(mode);
+					ri.addVisible(mode);
 				}
 			}
 		}
@@ -359,44 +381,6 @@ private void resetDefaultAppearance(ApplicationMode appMode) {
 		settings.MAP_MARKERS_MODE.resetToDefault();
 	}
 
-	public void addControlsAppearance(final MapActivity map, final ContextMenuAdapter cm, ApplicationMode mode) {
-		if (mode != ApplicationMode.DEFAULT) {
-			addControlId(map, cm, R.string.map_widget_top_text, settings.SHOW_STREET_NAME);
-		}
-		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.coordinates_widget, map)
-				.setIcon(R.drawable.ic_action_coordinates_widget)
-				.setSelected(settings.SHOW_COORDINATES_WIDGET.get())
-				.setListener(new AppearanceItemClickListener(settings.SHOW_COORDINATES_WIDGET, map))
-				.setLayout(R.layout.list_item_icon_and_switch).createItem());
-
-		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_widget_distance_by_tap, map)
-				.setIcon(R.drawable.ic_action_ruler_line)
-				.setSelected(settings.SHOW_DISTANCE_RULER.get())
-				.setListener(new AppearanceItemClickListener(settings.SHOW_DISTANCE_RULER, map))
-				.setLayout(R.layout.list_item_icon_and_switch).createItem());
-
-		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_markers, map)
-				.setDescription(settings.MAP_MARKERS_MODE.get().toHumanString(map))
-				.setListener(new ContextMenuAdapter.ItemClickListener() {
-					@Override
-					public boolean onContextMenuClick(final ArrayAdapter<ContextMenuItem> adapter, int itemId, final int position, boolean isChecked, int[] viewCoordinates) {
-						DirectionIndicationDialogFragment fragment = new DirectionIndicationDialogFragment();
-						fragment.setListener(new DirectionIndicationDialogFragment.DirectionIndicationFragmentListener() {
-							@Override
-							public void onMapMarkersModeChanged(boolean showDirectionEnabled) {
-								updateMapMarkersMode(map);
-								cm.getItem(position).setDescription(settings.MAP_MARKERS_MODE.get().toHumanString(map));
-								adapter.notifyDataSetChanged();
-							}
-						});
-						fragment.show(map.getSupportFragmentManager(), DirectionIndicationDialogFragment.TAG);
-						return false;
-					}
-				}).setLayout(R.layout.list_item_text_button).createItem());
-		addControlId(map, cm, R.string.map_widget_transparent, settings.TRANSPARENT_MAP_THEME);
-		addControlId(map, cm, R.string.show_lanes, settings.SHOW_LANES);
-	}
-
 	public void updateMapMarkersMode(MapActivity mapActivity) {
 		for (MapWidgetRegInfo info : rightWidgetSet) {
 			if ("map_marker_1st".equals(info.key)) {
@@ -415,8 +399,9 @@ public void updateMapMarkersMode(MapActivity mapActivity) {
 		mapActivity.refreshMap();
 	}
 
-	private void addControlId(final MapActivity map, ContextMenuAdapter cm,
-							  @StringRes int stringId, OsmandPreference<Boolean> pref) {
+	private void addControlId(ContextMenuAdapter cm,
+	                          @StringRes int stringId,
+	                          OsmandPreference<Boolean> pref) {
 		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(stringId, map)
 				.setSelected(pref.get())
 				.setListener(new AppearanceItemClickListener(pref, map)).createItem());
@@ -426,27 +411,11 @@ public static boolean distChanged(int oldDist, int dist) {
 		return !(oldDist != 0 && oldDist - dist < 100 && Math.abs(((float) dist - oldDist) / oldDist) < 0.01);
 	}
 
-	public void addControls(MapActivity map, ContextMenuAdapter cm, ApplicationMode mode) {
-		addQuickActionControl(map, cm, mode);
-		// Right panel
-		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_widget_right, map)
-				.setCategory(true).setLayout(R.layout.list_group_title_with_switch).createItem());
-		addControls(map, cm, rightWidgetSet, mode);
-		// Left panel
-		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_widget_left, map)
-				.setCategory(true).setLayout(R.layout.list_group_title_with_switch).createItem());
-		addControls(map, cm, leftWidgetSet, mode);
-		// Remaining items
-		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_widget_appearance_rem, map)
-				.setCategory(true).setLayout(R.layout.list_group_title_with_switch).createItem());
-		addControlsAppearance(map, cm, mode);
-	}
-
 	public String getText(Context ctx, final ApplicationMode mode, final MapWidgetRegInfo r) {
 		if (r.getMessage() != null) {
-			return (r.visibleCollapsed(mode) ? " + " : "  ") + r.getMessage();
+			return (r.isVisibleCollapsed(mode) ? " + " : "  ") + r.getMessage();
 		}
-		return (r.visibleCollapsed(mode) ? " + " : "  ") + ctx.getString(r.getMessageId());
+		return (r.isVisibleCollapsed(mode) ? " + " : "  ") + ctx.getString(r.getMessageId());
 	}
 
 	public Set<MapWidgetRegInfo> getRightWidgetSet() {
@@ -457,14 +426,32 @@ public Set<MapWidgetRegInfo> getLeftWidgetSet() {
 		return leftWidgetSet;
 	}
 
-	private void addQuickActionControl(final MapActivity mapActivity, final ContextMenuAdapter contextMenuAdapter, ApplicationMode mode) {
+	public void addControls(ContextMenuAdapter cm) {
+		ApplicationMode mode = settings.getApplicationMode();
+		addQuickActionControl(cm);
+		// Right panel
+		addHeader(cm, R.string.map_widget_right);
+		addControls(cm, rightWidgetSet, mode);
+		// Left panel
+		addHeader(cm, R.string.map_widget_left);
+		addControls(cm, leftWidgetSet, mode);
+		// Remaining items
+		addHeader(cm, R.string.map_widget_appearance_rem);
+		addControlsAppearance(cm, mode);
+	}
 
-		contextMenuAdapter.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_widget_right, mapActivity)
+	private void addHeader(ContextMenuAdapter cm, int titleId) {
+		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(titleId, map)
+				.setCategory(true).setLayout(R.layout.list_group_title_with_switch).createItem());
+	}
+
+	private void addQuickActionControl(final ContextMenuAdapter contextMenuAdapter) {
+		contextMenuAdapter.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_widget_right, map)
 				.setCategory(true).setLayout(R.layout.list_group_empty_title_with_switch).createItem());
 
 		boolean selected = app.getQuickActionRegistry().isQuickActionOn();
 		contextMenuAdapter.addItem(new ContextMenuItem.ItemBuilder()
-				.setTitleId(R.string.configure_screen_quick_action, mapActivity)
+				.setTitleId(R.string.configure_screen_quick_action, map)
 				.setIcon(R.drawable.ic_quick_action)
 				.setSelected(selected)
 				.setColor(app, selected ? R.color.osmand_orange : ContextMenuItem.INVALID_ID)
@@ -483,7 +470,7 @@ public boolean onRowItemClick(ArrayAdapter<ContextMenuItem> adapter, View view,
 
 						QuickActionListFragment fragment = new QuickActionListFragment();
 						fragment.setFromDashboard(true);
-						mapActivity.getSupportFragmentManager().beginTransaction()
+						map.getSupportFragmentManager().beginTransaction()
 								.setCustomAnimations(slideInAnim, slideOutAnim, slideInAnim, slideOutAnim)
 								.add(R.id.fragmentContainer, fragment, QuickActionListFragment.TAG)
 								.addToBackStack(QuickActionListFragment.TAG).commitAllowingStateLoss();
@@ -492,12 +479,12 @@ public boolean onRowItemClick(ArrayAdapter<ContextMenuItem> adapter, View view,
 					}
 
 					private void setVisibility(ArrayAdapter<ContextMenuItem> adapter,
-											   int position,
-											   boolean visible) {
+					                           int position,
+					                           boolean visible) {
 
 						app.getQuickActionRegistry().setQuickActionFabState(visible);
 
-						MapQuickActionLayer mil = mapActivity.getMapLayers().getMapQuickActionLayer();
+						MapQuickActionLayer mil = map.getMapLayers().getMapQuickActionLayer();
 						if (mil != null) {
 							mil.refreshLayer();
 						}
@@ -511,319 +498,244 @@ private void setVisibility(ArrayAdapter<ContextMenuItem> adapter,
 				.createItem());
 	}
 
-	private void addControls(final MapActivity mapActivity, final ContextMenuAdapter contextMenuAdapter,
-							 Set<MapWidgetRegInfo> groupTitle, final ApplicationMode mode) {
+	private void addControls(final ContextMenuAdapter contextMenuAdapter,
+	                         Set<MapWidgetRegInfo> groupTitle,
+	                         final ApplicationMode mode) {
 		for (final MapWidgetRegInfo r : groupTitle) {
-			if (!mode.isWidgetAvailable(r.key)) {
-				continue;
-			}
+			if (!mode.isWidgetAvailable(r.key)) continue;
 
-			final boolean selected = r.visibleCollapsed(mode) || r.visible(mode);
-			final String desc = mapActivity.getString(R.string.shared_string_collapse);
-			final boolean nightMode = app.getDaynightHelper().isNightModeForMapControls();
-			final int currentModeColor = mode.getProfileColor(nightMode);
+			boolean selected = r.isVisibleCollapsed(mode) || r.isVisible(mode);
+			String desc = map.getString(R.string.shared_string_collapse);
 			ContextMenuItem.ItemBuilder itemBuilder = new ContextMenuItem.ItemBuilder()
 					.setIcon(r.getDrawableMenu())
 					.setSelected(selected)
 					.setColor(app, selected ? R.color.osmand_orange : ContextMenuItem.INVALID_ID)
 					.setSecondaryIcon(r.widget != null ? R.drawable.ic_action_additional_option : ContextMenuItem.INVALID_ID)
-					.setDescription(r.visibleCollapsed(mode) ? desc : null)
+					.setDescription(r.isVisibleCollapsed(mode) ? desc : null)
 					.setListener(new ContextMenuAdapter.OnRowItemClick() {
 						@Override
 						public boolean onRowItemClick(final ArrayAdapter<ContextMenuItem> adapter,
-													  final View view,
-													  final int itemId,
-													  final int pos) {
+						                              final View view,
+						                              final int itemId,
+						                              final int pos) {
 							if (r.widget == null) {
-								setVisibility(adapter, pos, !r.visible(mode), false);
+								setVisibility(adapter, r, pos, !r.isVisible(mode), false);
 								return false;
 							}
-							View textWrapper = view.findViewById(R.id.text_wrapper);
-							List<PopUpMenuItem> items = new ArrayList<>();
-							UiUtilities ic = app.getUIUtilities();
-
-							final int[] menuIconIds = r.getDrawableMenuIds();
-							final int[] menuTitleIds = r.getMessageIds();
-							final int[] menuItemIds = r.getItemIds();
-							int checkedId = r.getItemId();
-							boolean selected = r.visibleCollapsed(mode) || r.visible(mode);
-							if (menuIconIds != null && menuTitleIds != null && menuItemIds != null
-									&& menuIconIds.length == menuTitleIds.length && menuIconIds.length == menuItemIds.length) {
-								for (int i = 0; i < menuIconIds.length; i++) {
-									int iconId = menuIconIds[i];
-									int titleId = menuTitleIds[i];
-									final int id = menuItemIds[i];
-									boolean isChecked = id == checkedId;
-									String title = app.getString(titleId);
-									Drawable icon = isChecked && selected ? ic.getPaintedIcon(iconId, currentModeColor) : ic.getThemedIcon(iconId);
-									items.add(new PopUpMenuItem.Builder(app)
-											.setTitle(title)
-											.setIcon(icon)
-											.setOnClickListener(new View.OnClickListener() {
-												@Override
-												public void onClick(View v) {
-													r.changeState(id);
-													MapInfoLayer mil = mapActivity.getMapLayers().getMapInfoLayer();
-													if (mil != null) {
-														mil.recreateControls();
-													}
-													ContextMenuItem item = adapter.getItem(pos);
-													item.setIcon(r.getDrawableMenu());
-													if (r.getMessage() != null) {
-														item.setTitle(r.getMessage());
-													} else {
-														item.setTitle(mapActivity.getResources().getString(r.getMessageId()));
-													}
-													adapter.notifyDataSetChanged();
-												}
-											})
-											.showCompoundBtn(currentModeColor)
-											.setSelected(isChecked)
-											.create());
-								}
-							}
-
-							// show
-							items.add(new PopUpMenuItem.Builder(app)
-									.setTitleId(R.string.shared_string_show)
-									.setIcon(ic.getThemedIcon(R.drawable.ic_action_view))
-									.setOnClickListener(new View.OnClickListener() {
-										@Override
-										public void onClick(View v) {
-											setVisibility(adapter, pos, true, false);
-										}
-									})
-									.create());
-
-							// hide
-							items.add(new PopUpMenuItem.Builder(app)
-									.setTitleId(R.string.shared_string_hide)
-									.setIcon(ic.getThemedIcon(R.drawable.ic_action_hide))
-									.setOnClickListener(new View.OnClickListener() {
-										@Override
-										public void onClick(View v) {
-											setVisibility(adapter, pos, false, false);
-										}
-									})
-									.create());
-
-							// collapse
-							items.add(new PopUpMenuItem.Builder(app)
-									.setTitleId(R.string.shared_string_collapse)
-									.setIcon(ic.getThemedIcon(R.drawable.ic_action_widget_collapse))
-									.setOnClickListener(new View.OnClickListener() {
-										@Override
-										public void onClick(View v) {
-											setVisibility(adapter, pos, true, true);
-										}
-									})
-									.create());
-
-							new PopUpMenuHelper.Builder(textWrapper, items, nightMode)
-									.setWidthType(PopUpMenuWidthType.STANDARD)
-									.show();
-
+							boolean selected = r.isVisibleCollapsed(mode) || r.isVisible(mode);
+							showPopUpMenu(view, adapter, r.getWidgetState(), r.getMessage(), mode,
+									getPopupMenuItemListener(adapter, r, pos, true, false),
+									getPopupMenuItemListener(adapter, r, pos, false, false),
+									getPopupMenuItemListener(adapter, r, pos, true, true),
+									selected, pos);
 							return false;
 						}
 
 						@Override
 						public boolean onContextMenuClick(ArrayAdapter<ContextMenuItem> a,
-														  int itemId, int pos, boolean isChecked, int[] viewCoordinates) {
-							setVisibility(a, pos, isChecked, false);
+						                                  int itemId, int pos, boolean isChecked, int[] viewCoordinates) {
+							setVisibility(a, r, pos, isChecked, false);
 							return false;
 						}
 
-						private void setVisibility(ArrayAdapter<ContextMenuItem> adapter,
-												   int position,
-												   boolean visible,
-												   boolean collapsed) {
-							MapWidgetRegistry.this.setVisibility(r, visible, collapsed);
-							MapInfoLayer mil = mapActivity.getMapLayers().getMapInfoLayer();
-							if (mil != null) {
-								mil.recreateControls();
-							}
-							ContextMenuItem item = adapter.getItem(position);
-							item.setSelected(visible);
-							item.setColor(app, visible ? R.color.osmand_orange : ContextMenuItem.INVALID_ID);
-							item.setDescription(visible && collapsed ? desc : null);
-							adapter.notifyDataSetChanged();
-						}
 					});
 			if (r.getMessage() != null) {
 				itemBuilder.setTitle(r.getMessage());
 			} else {
-				itemBuilder.setTitleId(r.getMessageId(), mapActivity);
+				itemBuilder.setTitleId(r.getMessageId(), map);
 			}
 			contextMenuAdapter.addItem(itemBuilder.createItem());
 		}
 	}
 
-
-	public static class MapWidgetRegInfo implements Comparable<MapWidgetRegInfo> {
-		public final TextInfoWidget widget;
-		@DrawableRes
-		private int drawableMenu;
-		@StringRes
-		private int messageId;
-		private String message;
-		private WidgetState widgetState;
-		public final String key;
-		public final boolean left;
-		public final int priorityOrder;
-		private final Set<ApplicationMode> visibleCollapsible = new LinkedHashSet<>();
-		private final Set<ApplicationMode> visibleModes = new LinkedHashSet<>();
-		private Runnable stateChangeListener = null;
-
-		public MapWidgetRegInfo(String key, TextInfoWidget widget, @DrawableRes int drawableMenu,
-								@StringRes int messageId, int priorityOrder, boolean left) {
-			this.key = key;
-			this.widget = widget;
-			this.drawableMenu = drawableMenu;
-			this.messageId = messageId;
-			this.priorityOrder = priorityOrder;
-			this.left = left;
-		}
-
-		public MapWidgetRegInfo(String key, TextInfoWidget widget, @DrawableRes int drawableMenu,
-								String message, int priorityOrder, boolean left) {
-			this.key = key;
-			this.widget = widget;
-			this.drawableMenu = drawableMenu;
-			this.message = message;
-			this.priorityOrder = priorityOrder;
-			this.left = left;
-		}
-
-		public MapWidgetRegInfo(String key, TextInfoWidget widget, WidgetState widgetState,
-								int priorityOrder, boolean left) {
-			this.key = key;
-			this.widget = widget;
-			this.widgetState = widgetState;
-			this.priorityOrder = priorityOrder;
-			this.left = left;
-		}
-
-		public int getDrawableMenu() {
-			if (widgetState != null) {
-				return widgetState.getMenuIconId();
-			} else {
-				return drawableMenu;
-			}
-		}
-
-		public String getMessage() {
-			return message;
-		}
-
-		public int getMessageId() {
-			if (widgetState != null) {
-				return widgetState.getMenuTitleId();
-			} else {
-				return messageId;
+	private View.OnClickListener getPopupMenuItemListener(final ArrayAdapter<ContextMenuItem> adapter,
+	                                                      final MapWidgetRegInfo r,
+	                                                      final int pos,
+	                                                      final boolean visible,
+	                                                      final boolean collapsed) {
+		return new View.OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				setVisibility(adapter, r, pos, visible, collapsed);
 			}
-		}
+		};
+	}
 
-		public int getItemId() {
-			if (widgetState != null) {
-				return widgetState.getMenuItemId();
-			} else {
-				return messageId;
-			}
+	public void addControlsAppearance(final ContextMenuAdapter cm, ApplicationMode mode) {
+		if (mode != ApplicationMode.DEFAULT) {
+			addControlId(cm, R.string.map_widget_top_text, settings.SHOW_STREET_NAME);
 		}
+		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.coordinates_widget, map)
+				.setIcon(R.drawable.ic_action_coordinates_widget)
+				.setSelected(settings.SHOW_COORDINATES_WIDGET.get())
+				.setListener(new AppearanceItemClickListener(settings.SHOW_COORDINATES_WIDGET, map))
+				.setLayout(R.layout.list_item_icon_and_switch).createItem());
 
-		public int[] getDrawableMenuIds() {
-			if (widgetState != null) {
-				return widgetState.getMenuIconIds();
-			} else {
-				return null;
-			}
-		}
+		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_widget_distance_by_tap, map)
+				.setIcon(R.drawable.ic_action_ruler_line)
+				.setSelected(settings.SHOW_DISTANCE_RULER.get())
+				.setListener(new AppearanceItemClickListener(settings.SHOW_DISTANCE_RULER, map))
+				.setLayout(R.layout.list_item_icon_and_switch).createItem());
 
-		public int[] getMessageIds() {
-			if (widgetState != null) {
-				return widgetState.getMenuTitleIds();
-			} else {
-				return null;
-			}
-		}
+		addElevationProfileWidget(cm, mode);
 
-		public int[] getItemIds() {
-			if (widgetState != null) {
-				return widgetState.getMenuItemIds();
-			} else {
-				return null;
-			}
-		}
+		cm.addItem(new ContextMenuItem.ItemBuilder().setTitleId(R.string.map_markers, map)
+				.setDescription(settings.MAP_MARKERS_MODE.get().toHumanString(map))
+				.setListener(new ContextMenuAdapter.ItemClickListener() {
+					@Override
+					public boolean onContextMenuClick(final ArrayAdapter<ContextMenuItem> adapter, int itemId, final int position, boolean isChecked, int[] viewCoordinates) {
+						DirectionIndicationDialogFragment fragment = new DirectionIndicationDialogFragment();
+						fragment.setListener(new DirectionIndicationDialogFragment.DirectionIndicationFragmentListener() {
+							@Override
+							public void onMapMarkersModeChanged(boolean showDirectionEnabled) {
+								updateMapMarkersMode(map);
+								cm.getItem(position).setDescription(settings.MAP_MARKERS_MODE.get().toHumanString(map));
+								adapter.notifyDataSetChanged();
+							}
+						});
+						fragment.show(map.getSupportFragmentManager(), DirectionIndicationDialogFragment.TAG);
+						return false;
+					}
+				}).setLayout(R.layout.list_item_text_button).createItem());
+		addControlId(cm, R.string.map_widget_transparent, settings.TRANSPARENT_MAP_THEME);
+		addControlId(cm, R.string.show_lanes, settings.SHOW_LANES);
+	}
 
-		public void changeState(int stateId) {
-			if (widgetState != null) {
-				widgetState.changeState(stateId);
-			}
-		}
+	public void addElevationProfileWidget(final ContextMenuAdapter cm,
+	                                      final ApplicationMode mode) {
+		final OsmandPreference<Boolean> pref = settings.SHOW_ELEVATION_PROFILE_WIDGET;
 
-		public boolean visibleCollapsed(ApplicationMode mode) {
-			return visibleCollapsible.contains(mode);
-		}
+		final ElevationProfileWidgetState widgetState = new ElevationProfileWidgetState(app);
+		ContextMenuItem.ItemBuilder itemBuilder = new ContextMenuItem.ItemBuilder()
+				.setTitleId(widgetState.getMenuTitleId(), app)
+				.setIcon(R.drawable.ic_action_elevation)
+				.setSelected(pref.get())
+				.setSecondaryIcon(R.drawable.ic_action_additional_option)
+				.setListener(new ContextMenuAdapter.OnRowItemClick() {
+					@Override
+					public boolean onRowItemClick(final ArrayAdapter<ContextMenuItem> adapter,
+					                              final View view,
+					                              final int itemId,
+					                              final int pos) {
+						boolean selected = pref.get();
+						showPopUpMenu(view, adapter, widgetState, null, mode,
+								getElevationPopupMenuItemListener(adapter, pref, pos, true),
+								getElevationPopupMenuItemListener(adapter, pref, pos, false),
+								null, selected, pos);
+						return false;
+					}
 
-		public boolean visible(ApplicationMode mode) {
-			return visibleModes.contains(mode);
-		}
+					@Override
+					public boolean onContextMenuClick(ArrayAdapter<ContextMenuItem> a,
+					                                  int itemId, int pos, boolean isChecked,
+					                                  int[] viewCoordinates) {
+						updateAppearancePref(map, pref, a, !pref.get());
+						return false;
+					}
+				});
+		cm.addItem(itemBuilder.createItem());
+	}
 
-		public MapWidgetRegInfo required(ApplicationMode... modes) {
-			Collections.addAll(visibleModes, modes);
-			return this;
+	public View.OnClickListener getElevationPopupMenuItemListener(final ArrayAdapter<ContextMenuItem> adapter,
+	                                                              final OsmandPreference<Boolean> pref,
+	                                                              final int pos,
+	                                                              final boolean visible) {
+		return new View.OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				adapter.getItem(pos).setSelected(visible);
+				updateAppearancePref(map, pref, adapter, visible);
+			}
+		};
+	}
+
+	public void showPopUpMenu(@NonNull View view,
+	                          @NonNull final ArrayAdapter<ContextMenuItem> adapter,
+	                          @Nullable final WidgetState widgetState,
+	                          @Nullable final String message,
+	                          @NonNull ApplicationMode mode,
+	                          @NonNull View.OnClickListener showBtnListener,
+	                          @NonNull View.OnClickListener hideBtnListener,
+	                          @Nullable View.OnClickListener collapseBtnListener,
+	                          boolean selected,
+	                          final int pos) {
+		final boolean nightMode = app.getDaynightHelper().isNightModeForMapControls();
+		final int currentModeColor = mode.getProfileColor(nightMode);
+		View parentView = view.findViewById(R.id.text_wrapper);
+		List<PopUpMenuItem> items = new ArrayList<>();
+		UiUtilities uiUtilities = app.getUIUtilities();
+
+		if (widgetState != null) {
+			final int[] menuIconIds = widgetState.getMenuIconIds();
+			final int[] menuTitleIds = widgetState.getMenuTitleIds();
+			final int[] menuItemIds = widgetState.getMenuItemIds();
+			if (menuIconIds != null && menuTitleIds != null && menuItemIds != null &&
+					menuIconIds.length == menuTitleIds.length && menuIconIds.length == menuItemIds.length) {
+				for (int i = 0; i < menuIconIds.length; i++) {
+					int iconId = menuIconIds[i];
+					int titleId = menuTitleIds[i];
+					final int id = menuItemIds[i];
+					boolean checkedItem = id == widgetState.getMenuItemId();
+					Drawable icon = checkedItem && selected ?
+							uiUtilities.getPaintedIcon(iconId, currentModeColor) :
+							uiUtilities.getThemedIcon(iconId);
+					items.add(new PopUpMenuItem.Builder(app)
+							.setTitle(getString(titleId))
+							.setIcon(icon)
+							.setOnClickListener(new View.OnClickListener() {
+								@Override
+								public void onClick(View v) {
+									widgetState.changeState(id);
+									MapInfoLayer mil = map.getMapLayers().getMapInfoLayer();
+									if (mil != null) {
+										mil.recreateControls();
+									}
+									ContextMenuItem item = adapter.getItem(pos);
+									item.setIcon(widgetState.getMenuIconId());
+									if (message != null) {
+										item.setTitle(message);
+									} else {
+										item.setTitle(getString(widgetState.getMenuTitleId()));
+									}
+									adapter.notifyDataSetChanged();
+								}
+							})
+							.showCompoundBtn(currentModeColor)
+							.setSelected(checkedItem)
+							.create());
+				}
+			}
 		}
 
+		// show
+		items.add(new PopUpMenuItem.Builder(app)
+				.setTitleId(R.string.shared_string_show)
+				.setIcon(uiUtilities.getThemedIcon(R.drawable.ic_action_view))
+				.setOnClickListener(showBtnListener)
+				.create());
 
-		public void setStateChangeListener(Runnable stateChangeListener) {
-			this.stateChangeListener = stateChangeListener;
-		}
-
-		@Override
-		public int hashCode() {
-			if (getMessage() != null) {
-				return getMessage().hashCode();
-			}
-			return getMessageId();
-		}
+		// hide
+		items.add(new PopUpMenuItem.Builder(app)
+				.setTitleId(R.string.shared_string_hide)
+				.setIcon(uiUtilities.getThemedIcon(R.drawable.ic_action_hide))
+				.setOnClickListener(hideBtnListener)
+				.create());
 
-		@Override
-		public boolean equals(Object obj) {
-			if (this == obj) {
-				return true;
-			} else if (obj == null) {
-				return false;
-			} else if (getClass() != obj.getClass()) {
-				return false;
-			}
-			MapWidgetRegInfo other = (MapWidgetRegInfo) obj;
-			if (getMessageId() == 0 && other.getMessageId() == 0) {
-				return key.equals(other.key);
-			}
-			return getMessageId() == other.getMessageId();
+		// collapse
+		if (collapseBtnListener != null) {
+			items.add(new PopUpMenuItem.Builder(app)
+					.setTitleId(R.string.shared_string_collapse)
+					.setIcon(uiUtilities.getThemedIcon(R.drawable.ic_action_widget_collapse))
+					.setOnClickListener(collapseBtnListener)
+					.create());
 		}
 
-		@Override
-		public int compareTo(@NonNull MapWidgetRegInfo another) {
-			if (getMessageId() == 0 && another.getMessageId() == 0) {
-				if (key.equals(another.key)) {
-					return 0;
-				}
-			} else if (getMessageId() == another.getMessageId()) {
-				return 0;
-			}
-			if (priorityOrder == another.priorityOrder) {
-				if (getMessageId() == 0 && another.getMessageId() == 0) {
-					return key.compareTo(key);
-				} else {
-					return getMessageId() - another.getMessageId();
-				}
-			}
-			return priorityOrder - another.priorityOrder;
-		}
+		new PopUpMenuHelper.Builder(parentView, items, nightMode)
+				.setWidthType(PopUpMenuWidthType.STANDARD)
+				.show();
 	}
 
-	public ContextMenuAdapter getViewConfigureMenuAdapter(final MapActivity map) {
+	public ContextMenuAdapter getViewConfigureMenuAdapter() {
 		final ContextMenuAdapter cm = new ContextMenuAdapter(app);
 		boolean nightMode = app.getDaynightHelper().isNightModeForMapControls();
 		cm.setProfileDependent(true);
@@ -835,30 +747,41 @@ public ContextMenuAdapter getViewConfigureMenuAdapter(final MapActivity map) {
 
 			@Override
 			public void onClick() {
-				map.getDashboard().updateListAdapter(getViewConfigureMenuAdapter(map));
+				map.getDashboard().updateListAdapter(getViewConfigureMenuAdapter());
 			}
 		});
-		final ApplicationMode mode = settings.getApplicationMode();
-		addControls(map, cm, mode);
+		addControls(cm);
 		return cm;
 	}
 
+	private String getString(@StringRes int resId) {
+		return app.getString(resId);
+	}
+
+	private static void updateAppearancePref(MapActivity map,
+	                                         OsmandPreference<Boolean> pref,
+	                                         ArrayAdapter<ContextMenuItem> a,
+	                                         boolean value) {
+		pref.set(value);
+		map.updateApplicationModeSettings();
+		a.notifyDataSetChanged();
+	}
+
 	static class AppearanceItemClickListener implements ContextMenuAdapter.ItemClickListener {
 
-		private MapActivity mapActivity;
-		private OsmandPreference<Boolean> pref;
+		private final MapActivity map;
+		private final OsmandPreference<Boolean> pref;
 
-		public AppearanceItemClickListener(OsmandPreference<Boolean> pref, MapActivity mapActivity) {
+		public AppearanceItemClickListener(OsmandPreference<Boolean> pref, MapActivity map) {
 			this.pref = pref;
-			this.mapActivity = mapActivity;
+			this.map = map;
 		}
 
 		@Override
 		public boolean onContextMenuClick(ArrayAdapter<ContextMenuItem> a,
-										  int itemId, int pos, boolean isChecked, int[] viewCoordinates) {
-			pref.set(!pref.get());
-			mapActivity.updateApplicationModeSettings();
-			a.notifyDataSetChanged();
+		                                  int itemId, int pos, boolean isChecked,
+		                                  int[] viewCoordinates) {
+			updateAppearancePref(map, pref, a, !pref.get());
 			return false;
 		}
 	}
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/widgetstates/ElevationProfileWidgetState.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/widgetstates/ElevationProfileWidgetState.java
new file mode 100644
index 00000000000..b9452675b46
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/widgetstates/ElevationProfileWidgetState.java
@@ -0,0 +1,53 @@
+package net.osmand.plus.views.mapwidgets.widgetstates;
+
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.R;
+import net.osmand.plus.settings.backend.OsmandPreference;
+
+public class ElevationProfileWidgetState extends WidgetState {
+
+	public static final int SHOW_SLOPES_ID = R.id.elevation_widget_show_slopes;
+	public static final int HIDE_SLOPES_ID = R.id.elevation_widget_hide_slopes;
+
+	private final OsmandPreference<Boolean> showSlopes;
+
+	public ElevationProfileWidgetState(OsmandApplication ctx) {
+		super(ctx);
+		this.showSlopes = ctx.getSettings().SHOW_SLOPES_ON_ELEVATION_WIDGET;
+	}
+
+	@Override
+	public int getMenuTitleId() {
+		return R.string.elevation_profile;
+	}
+
+	@Override
+	public int getMenuIconId() {
+		return R.drawable.ic_action_elevation;
+	}
+
+	@Override
+	public int getMenuItemId() {
+		return showSlopes.get() ? SHOW_SLOPES_ID : HIDE_SLOPES_ID;
+	}
+
+	@Override
+	public int[] getMenuTitleIds() {
+		return new int[] {R.string.shared_string_show_slope, R.string.shared_string_hide_slope};
+	}
+
+	@Override
+	public int[] getMenuIconIds() {
+		return new int[] {R.drawable.ic_action_elevation, R.drawable.ic_action_elevation};
+	}
+
+	@Override
+	public int[] getMenuItemIds() {
+		return new int[] {SHOW_SLOPES_ID, HIDE_SLOPES_ID};
+	}
+
+	@Override
+	public void changeState(int stateId) {
+		showSlopes.set(stateId == SHOW_SLOPES_ID);
+	}
+}
