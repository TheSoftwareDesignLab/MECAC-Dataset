diff --git a/DataExtractionOSM/src/net/osmand/ToDoConstants.java b/DataExtractionOSM/src/net/osmand/ToDoConstants.java
index b44780397b2..a4b0049c3d2 100644
--- a/DataExtractionOSM/src/net/osmand/ToDoConstants.java
+++ b/DataExtractionOSM/src/net/osmand/ToDoConstants.java
@@ -1,54 +1,54 @@
-package net.osmand;
-
-
-
-/**
- * This class is designed to put all to do's and link them with code.
- */
-public class ToDoConstants {
-	
-	
-//	    == Osmand application (TODO 127) ==
-
-//		=== Refactoring issues ===
-//	    !|| 125 || Introduce service layer rather than singletons and put all related into new package (services). Review architecture. Split some big classes. ||
-		
-		
-//		=== Common issues ===
-//	    || 104 || Add activity to show current loaded indexes and information about them (Issue 366) ||
-//      || 123 || Improve gpx file showing (very slow for big files) (Issue 412) ||
-//      || 124 || Animated transition using only raster images (?) - skip animations (!) - don not render vectoring for animations (Issue 238) ||
-//      || 122 || Frozen sqlite db images (bug?). When images are loaded into sqlite the whole map is frozen (issue 413) || 	
-//      || 120 || Show icons over poi circle (issue 414) ||
-//      || 110 || Use android voice for pronounce command (could be used in future to pronounce street) (Issue 70) ||
-//      || 119 || Dialog on main screen tips and tricks (Issue 415) ||
-//      || 118 || Config switching between maps on different zoom levels <14 (using raster), > 14 vector (Issue 419) ||
-//		|| 97 || For voice navigation consider current speed of vehicle. Especially when speed > 50 pronounce more than 200 m (Issue 420) ||
-//      || 111 || Investigate showing street name while driving (Issue 286) ||  
-//      || 86 || Allow to add/edit custom tags to POI objects (Issue 44) ||
-//		|| 92 || Support poi index with standard map index and unify POI categories (unify done +, works very slow) (Issue 417) ||
-//		|| 113 || Calculate speed cameras/bumps on the road (announce about them) (Issue 418) ||
-
-
-	
-//		=== Not clear if really needed (Means golden ratio complexity/necessity) ===
-//		|| 66 || Transport routing (show next stop, total distance, show stop get out, voice) ||
-//		|| 85 || Enable on/off screen for bike navigation ||
-//		|| 83 || Add monitoring service to send locations to internet ||
-	
-	
-//		=== Unscheduled (complex) ===
-//		|| 65 || Intermediate points - for better control routing, to avoid traffic jams ...(?) ||
-
-	// 	_19. colors for road trunk and motorway
-	
-	
-	///////////////////////////   DONE //////////////////////////////
-	// DONE ANDROID :
-//	|| 112 || Investigate exiting/minimizing app (Issue 214) ||
-	
-	// DONE SWING
-
-	
-	
-}
+package net.osmand;
+
+
+
+/**
+ * This class is designed to put all to do's and link them with code.
+ */
+public class ToDoConstants {
+	
+	
+//	    == Osmand application (TODO 127) ==
+
+//		=== Refactoring issues ===
+//	    !|| 125 || Introduce service layer rather than singletons and put all related into new package (services). Review architecture. Split some big classes. ||
+		
+		
+//		=== Common issues ===
+//	    || 104 || Add activity to show current loaded indexes and information about them (Issue 366) ||
+//      || 123 || Improve gpx file showing (very slow for big files) (Issue 412) ||
+//      || 124 || Animated transition using only raster images (?) - skip animations (!) - don not render vectoring for animations (Issue 238) ||
+//      || 122 || Frozen sqlite db images (bug?). When images are loaded into sqlite the whole map is frozen (issue 413) || 	
+//      || 120 || Show icons over poi circle (issue 414) ||
+//      || 110 || Use android voice for pronounce command (could be used in future to pronounce street) (Issue 70) ||
+//      || 119 || Dialog on main screen tips and tricks (Issue 415) ||
+//      || 118 || Config switching between maps on different zoom levels <14 (using raster), > 14 vector (Issue 419) ||
+//		|| 97 || For voice navigation consider current speed of vehicle. Especially when speed > 50 pronounce more than 200 m (Issue 420) ||
+//      || 111 || Investigate showing street name while driving (Issue 286) ||  
+//      || 86 || Allow to add/edit custom tags to POI objects (Issue 44) ||
+//		|| 92 || Support poi index with standard map index and unify POI categories (unify done +, works very slow) (Issue 417) ||
+//		|| 113 || Calculate speed cameras/bumps on the road (announce about them) (Issue 418) ||
+
+
+	
+//		=== Not clear if really needed (Means golden ratio complexity/necessity) ===
+//		|| 66 || Transport routing (show next stop, total distance, show stop get out, voice) ||
+//		|| 85 || Enable on/off screen for bike navigation ||
+//		|| 83 || Add monitoring service to send locations to internet ||
+	
+	
+//		=== Unscheduled (complex) ===
+//		|| 65 || Intermediate points - for better control routing, to avoid traffic jams ...(?) ||
+
+	// 	_19. colors for road trunk and motorway
+	
+	
+	///////////////////////////   DONE //////////////////////////////
+	// DONE ANDROID :
+//	|| 112 || Investigate exiting/minimizing app (Issue 214) ||
+	
+	// DONE SWING
+
+	
+	
+}
diff --git a/DataExtractionOSM/src/net/osmand/data/index/batch.xml b/DataExtractionOSM/src/net/osmand/data/index/batch.xml
index 83542dbe39d..a2d24b66484 100644
--- a/DataExtractionOSM/src/net/osmand/data/index/batch.xml
+++ b/DataExtractionOSM/src/net/osmand/data/index/batch.xml
@@ -1,536 +1,536 @@
-<?xml version="1.0" encoding="utf-8"?>
-<batch_process>
-	<!-- These attributes are required  to upload/delete downloads
-	     * cookieHSID - cookie HSID is required for delete index (could be taken from source (!) of page when you are about delete index) 
-	     * cookieSID - cookie SID is required for delete index (could be taken from source (!) of page when you are about delete index)
-	     * pagegen - pagegen attribute is required for delete index (could be taken from source (!) of page when you are about delete index)
-	     * token - token attribute is required for delete index (could be taken from source (!) of page when you are about delete index)
-	     * google_code_user - is required to upload index 
-	     * google_code_password - is required to upload index (is not gmail password!) - could be found in profile 
-	-->
-	<authorization_info cookieHSID=""
-		cookieSID=""
-		pagegen="" token=""
-		google_code_user="" google_code_password="" 
-		osmand_download_user="" osmand_download_password=""/>
-	<!-- There are 3 subprocess : 	
-		 1. Download fresh osm files from servers to 'directory_for_osm_files' (override existings).
-		 2. Generate index files from all files in 'directory_for_osm_files' and put all indexes into 'directory_for_index_files'
-		 3. Upload index files from 'directory_for_index_files' to googlecode.
-		 All these subprocess could be ran independently ! So you can create some files check them and after that try to upload on googlecode,
-		 or you can upload any file you have to googlecode (just put into 'directory_for_index_files')
-	 -->
-	<process directory_for_osm_files="D:/android/batch_gen_osm" directory_for_index_files="D:/android/batch_gen_index"
-		downloadOsmFiles="true" generateIndexes="true" uploadIndexes="true" upload_osmand_download="true"
-		deleteFilesAfterUploading="true" indexPOI="true" indexMap="true"
-		indexTransport="true" indexAddress="true" mapZooms="" renderingTypesFile=""
-		>
-		<!-- Add wget="C:/Program Files/GNUWin32/bin/wget.exe" to process, to use wget for download.
-			 On linux systems if wget is in your path it can be wget="wget" or you can make own script with wget command:
-			 wget="/path/to/script/wget.sh"
-			 Defaultly enabled parameter of wget is: &-&-read-timeout=5 that prevents hanging of download from  cloudmade/geofabrik server  
-		-->
-
-		
-        <!-- Countries to download from osm server -->
-		<!-- EUROPE -->
-		<regions siteToDownload="http://download.geofabrik.de/osm/europe/{0}.osm.pbf" region_prefix="" skip="true" region_suffix="_Europe">
-			<region name="albania" esize="6" />
-			<region name="andorra" esize="1" />
-			<region name="austria" esize="110" />
-			<region name="belarus" esize="45" />
-			<region name="belgium" esize="55" />
-			<region name="bosnia-herzegovina" esize="5" />
-			<region name="bulgaria" esize="15" />
-			<region name="croatia" esize="15" />
-			<region name="cyprus" esize="6" />
-			<region name="denmark" esize="80" />
-			<region name="estonia" esize="38" />
-			<region name="faroe_islands" esize="2" />
-			<region name="finland" esize="85" />
-			<region name="greece" esize="25" />
-			<region name="hungary" esize="20" />
-			<region name="iceland" esize="10" />
-			<region name="ireland" esize="30" />
-			<region name="isle_of_man" esize="1" />
-			<region name="kosovo" esize="10" />
-			<region name="latvia" esize="10" />
-			<region name="liechtenstein" esize="1" />
-			<region name="lithuania" esize="10" />
-			<region name="luxembourg" esize="10" />
-			<region name="macedonia" esize="10" />
-			<region name="malta" esize="1" />
-			<region name="moldova" esize="5" />
-			<region name="monaco" esize="1" />
-			<region name="montenegro" esize="2" />
-			<region name="norway" esize="65" />
-			<region name="poland" esize="90" />
-			<region name="portugal" esize="15" />
-			<region name="romania" esize="30" />
-			<region name="serbia" esize="15" />
-			<region name="slovakia" esize="80" cityAdminLevel="6"/>
-			<region name="slovenia" esize="15" />
-			<region name="spain" esize="150" />
-			<region name="sweden" esize="90" />
-			<region name="switzerland" esize="90" />
-			<region name="turkey" esize="20" />
-			<region name="ukraine" esize="25" />
-
-			<region name="czech_republic" esize="180"/>
-			<region name="netherlands" esize="450" cityAdminLevel="10"/> 
-			<region name="italy" esize="255"/>
-		</regions>
-
-		<!-- GREAT BRITAIN -->
-		<regions siteToDownload="http://download.geofabrik.de/osm/europe/great_britain/{0}.osm.pbf" region_prefix="GB_" skip="true" region_suffix="_Europe">
-			<region name="scotland" esize="23"/>		
-			<region name="wales" esize="10"/>
-			<region name="england" esize="230"/>
-		</regions>
-
-		<!-- FRANCE -->
-		<regions siteToDownload="http://download.geofabrik.de/osm/europe/france/{0}.osm.pbf" region_prefix="France_" 
-			skip="true" region_suffix="_Europe">
-			<region name="alsace" esize="" />
-			<region name="aquitaine" esize="" />
-			<region name="auvergne" esize="" />
-			<region name="basse-normandie" esize="" />
-			<region name="bourgogne" esize="" />
-			<region name="bretagne" esize="" />
-			<region name="centre" esize="" />
-			<region name="champagne-ardenne" esize="" />
-			<region name="corse" esize="" />
-			<region name="franche-comte" esize="" />
-			<region name="haute-normandie" esize="" />
-			<region name="ile-de-france" esize="" />
-			<region name="languedoc-roussillon" esize="" />
-			<region name="limousin" esize="" />
-			<region name="lorraine" esize="" />
-			<region name="midi-pyrenees" esize="" />
-			<region name="nord-pas-de-calais" esize="" />
-			<region name="pays-de-la-loire" esize="" />
-			<region name="picardie" esize="" />
-			<region name="poitou-charentes" esize="" />
-			<region name="provence-alpes-cote-d-azur" esize="" />
-			<region name="rhone-alpes" esize="" />
-		</regions>
-
-		<!-- GERMANY -->
-		<regions siteToDownload="http://download.geofabrik.de/osm/europe/germany/{0}.osm.pbf" region_prefix="Germany_" skip="true" 
-			region_suffix="_Europe">
-			<region name="baden-wuerttemberg" esize="" />
-			<region name="bayern" esize="" />
-			<region name="berlin" esize="" />
-			<region name="brandenburg" esize="" />
-			<region name="bremen" esize="" />
-			<region name="hamburg" esize="" />
-			<region name="hessen" esize="" />
-			<region name="mecklenburg-vorpommern" esize="" />
-			<region name="niedersachsen" esize="" />
-			<region name="nordrhein-westfalen" esize="" />
-			<region name="rheinland-pfalz" esize="" />
-			<region name="saarland" esize="" />
-			<region name="sachsen-anhalt" esize="" />
-			<region name="sachsen" esize="" />
-			<region name="schleswig-holstein" esize="" />
-			<region name="thueringen" esize="" />
-		</regions>
-		
-		<!-- USA -->
-		<regions siteToDownload="http://downloads.cloudmade.com/north_america/united_states/{0}/{0}.osm.bz2" skip="true" region_prefix="US_" region_suffix="_NorthAmerica">
-			<region name="alabama" esize=""/>
-			<region name="alaska" esize=""/>
-			<region name="arizona" esize=""/>
-			<region name="arkansas" esize=""/>
-			<region name="colorado" esize=""/>
-			<region name="connecticut" esize=""/>
-			<region name="delaware" esize=""/>
-			<region name="district_of_columbia" esize=""/>
-			<region name="florida" esize=""/>
-			<region name="georgia" esize=""/>
-			<region name="guantanamo_bay" esize=""/> <!-- ??? -->
-			<region name="hawaii" esize=""/>
-			<region name="idaho" esize=""/>
-			<region name="illinois" esize=""/>
-			<region name="indiana" esize=""/>
-			<region name="iowa" esize=""/>
-			<region name="kansas" esize=""/>
-			<region name="kentucky" esize=""/>
-			<region name="louisiana" esize=""/>
-			<region name="maine" esize=""/>
-			<region name="maryland" esize=""/>
-			<region name="massachusetts" esize=""/>
-			<region name="michigan" esize=""/>
-			<region name="minnesota" esize=""/>
-			<region name="mississippi" esize=""/>
-			<region name="missouri" esize=""/>
-			<region name="montana" esize=""/>
-			<region name="nebraska" esize=""/>
-			<region name="nevada" esize=""/>
-			<region name="new_hampshire" esize=""/>
-			<region name="new_jersey" esize=""/>
-			<region name="new_mexico" esize=""/>
-			<region name="new_york" esize=""/>
-			<region name="north_dakota" esize=""/>
-			<region name="ohio" esize=""/>
-			<region name="oklahoma" esize=""/>
-			<region name="oregon" esize=""/>
-			<region name="pennsylvania" esize=""/>
-			<region name="rhode_island" esize=""/>
-			<region name="south_carolina" esize=""/>
-			<region name="south_dakota" esize=""/>
-			<region name="tennessee" esize=""/>
-			<region name="utah" esize=""/>
-			<region name="vermont" esize=""/>
-			<region name="washington" esize=""/>
-			<region name="west_virginia" esize=""/>
-			<region name="wisconsin" esize=""/>
-			<region name="wyoming" esize=""/>
-			<region name="virginia" esize=""/>
-			<region name="texas" esize=""/>
-			<region name="california" esize=""/>
-			<region name="north_carolina" esize=""/>
-		</regions>
-		
-		<!-- Canada -->
-		<regions siteToDownload="http://downloads.cloudmade.com/north_america/canada/{0}/{0}.osm.bz2" region_prefix="Canada_" skip="true" region_suffix="_NorthAmerica">
-			<region name="alberta" esize="36"/>
-			<region name="british_columbia" esize=""/>
-			<region name="manitoba" esize=""/>
-			<region name="new_brunswick" esize=""/>
-			<region name="newfoundland" esize=""/>
-			<region name="nova_scotia" esize=""/>
-			<region name="nunavut" esize=""/>
-			<region name="nw_territories" esize=""/>
-			<region name="ontario" esize=""/>
-			<region name="pr_edwrd_island" esize=""/>
-			<region name="quebec" esize=""/>
-			<region name="saskatchewan" esize=""/>
-			<region name="yukon" esize=""/>
-		</regions>
-		
-		<!-- Russia -->
-		<regions siteToDownload="http://gis-lab.info/data/osm/{0}/{0}.osm.bz2" region_prefix="Russia_"  skip="true" region_suffix="_Asia">
-			<region name="adygeya" esize=""/>
-			<region name="altay" esize=""/>
-			<region name="altayskiy" esize=""/>
-			<region name="amur" esize=""/>
-			<region name="arkhan" esize=""/>
-			<region name="astrakhan" esize=""/>
-			<region name="bashkir" esize=""/>
-			<region name="belgorod" esize=""/>
-			<region name="bryansk" esize=""/> 
-			<region name="buryat" esize=""/>
-			<region name="chechen" esize=""/>
-			<region name="chel" esize=""/>
-			<region name="chukot" esize=""/>
-			<region name="chuvash" esize=""/>
-			<region name="dagestan" esize=""/>
-			<region name="evrey" esize=""/>
-			<region name="ingush" esize=""/>
-			<region name="irkutsk" esize=""/>
-			<region name="ivanov" esize=""/>
-			<region name="kabardin" esize=""/>
-			<region name="kalinin" esize=""/>
-			<region name="kalmyk" esize=""/>
-			<region name="kaluzh" esize=""/>
-			<region name="kamch" esize=""/>
-			<region name="karach" esize=""/>
-			<region name="karel" esize=""/>
-			<region name="kemerovo" esize=""/>
-			<region name="khabar" esize=""/>
-			<region name="khakas" esize=""/>
-			<region name="khanty" esize=""/>
-			<region name="kirov" esize=""/>
-			<region name="komi" esize=""/>
-			<region name="kostrom" esize=""/>
-			<region name="krasnodar" esize=""/>
-			<region name="krasnoyarsk" esize=""/>
-			<region name="kurgan" esize=""/>
-			<region name="kursk" esize=""/>
-			<region name="leningrad" esize=""/>
-			<region name="lipetsk" esize=""/>
-			<region name="magadan" esize=""/>
-			<region name="mariyel" esize=""/>
-			<region name="mordov" esize=""/>
-			<region name="moscow" esize=""/>
-			<region name="mosobl" esize=""/>
-			<region name="murmansk" esize=""/>
-			<region name="nenec" esize=""/>
-			<region name="nizhegorod" esize=""/>
-			<region name="novgorod" esize=""/>
-			<region name="novosib" esize=""/>
-			<region name="omsk" esize=""/>
-			<region name="orenburg" esize=""/>
-			<region name="orlovsk" esize=""/>
-			<region name="osetiya" esize=""/>
-			<region name="penz" esize=""/>
-			<region name="perm" esize=""/>
-			<region name="prim" esize=""/>
-			<region name="pskov" esize=""/>
-			<region name="rostov" esize=""/>
-			<region name="ryazan" esize=""/>
-			<region name="sakhalin" esize=""/>
-			<region name="samar" esize=""/>
-			<region name="saratov" esize=""/>
-			<region name="smol" esize=""/>
-			<region name="stavrop" esize=""/>
-			<region name="stpeter" esize=""/>
-			<region name="sverdl" esize=""/>
-			<region name="tambov" esize=""/>
-			<region name="tatar" esize=""/>
-			<region name="tomsk" esize=""/>
-			<region name="tul" esize=""/>
-			<region name="tumen" esize=""/>
-			<region name="tver" esize=""/>
-			<region name="tyva" esize=""/>
-			<region name="udmurt" esize=""/>
-			<region name="ulyan" esize=""/>
-			<region name="vladimir" esize=""/>
-			<region name="volgograd" esize=""/>
-			<region name="vologda" esize=""/>
-			<region name="voronezh" esize=""/>
-			<region name="yakut" esize=""/>
-			<region name="yamal" esize=""/>
-			<region name="yarosl" esize=""/>
-			<region name="zabaikal" esize=""/>
-		</regions>
-		
-	    
-		<!-- ASIA -->
-		<regions siteToDownload="http://downloads.cloudmade.com/asia/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Asia" skip="true">
-			<region name="afghanistan" esize="6"/>
-			<region name="bahrain" esize="1"/>
-			<region name="bangladesh" esize="3"/>
-			<region name="bhutan" esize="1"/>
-			<region name="british_indian_ocean_territory" esize="1"/>
-			<region name="brunei" esize="1"/>
-			<region name="cambodia" esize="2"/>
-			<region name="china" esize="67"/>
-			<region name="christmas_island" esize="1"/>
-			<region name="democratic_republic_of_timor-leste" esize="1"/>
-			<region name="gaza_strip" esize="3"/>
-			<region name="india" esize="47"/>  
-			<region name="indonesia" esize="21"/>
-			<region name="iran" esize="11"/>
-			<region name="iraq" esize="3"/>
-			<region name="israel" esize="18"/>
-			<region name="jordan" esize="1"/>
-			<region name="kazakhstan" esize="15"/>
-			<region name="kuwait" esize="1"/>
-			<region name="kyrgyzstan" esize="4"/>
-			<region name="laos" esize="3"/>
-			<region name="lebanon" esize="3"/>
-			<region name="macau" esize="1"/>
-			<region name="malaysia" esize="7"/>
-			<region name="maldives" esize="1"/>
-			<region name="mongolia" esize="3"/>
-			<region name="nepal" esize="2"/>
-			<region name="north_korea" esize="5"/>
-			<region name="oman" esize="2"/>
-			<region name="pakistan" esize="14"/>
-			<region name="paracel_islands" esize="1"/>
-			<region name="philippines" esize="25"/>
-			<region name="qatar" esize="1"/>
-			<region name="saudi_arabia" esize="9"/>
-			<region name="singapore" esize="2"/>
-			<region name="south_korea" esize="25"/>
-			<region name="spratly_islands" esize="1"/>
-			<region name="sri_lanka" esize="2"/>
-			<region name="syria" esize="4"/>
-			<region name="taiwan" esize="4"/>
-			<region name="tajikistan" esize="3"/>
-			<region name="thailand" esize="12"/>
-			<region name="turkmenistan" esize="1"/>
-			<region name="union_of_myanmar" esize="7"/>
-			<region name="united_arab_emirates" esize="2"/>
-			<region name="uzbekistan" esize="3"/>
-			<region name="vietnam" esize=""/>
-			<region name="yemen" esize=""/> 
-		</regions>
-		
-		
-		<!--  CENTRAL AMERICA -->
-		<regions siteToDownload="http://downloads.cloudmade.com/north_america/{0}/{0}.osm.bz2" region_prefix=""  skip="true" region_suffix="_CentralAmerica">
-			<region name="bahamas" esize="1" />
-			<region name="costa_rica" esize="3" />
-			<region name="cuba" esize="3" />
-			<region name="dominica" esize="1" />
-			<region name="dominican_republic" esize="6" />
-			<region name="guatemala" esize="4" />
-			<region name="haiti" esize="21" />
-			<region name="honduras" esize="3" />
-			<region name="jamaica" esize="1" />
-			<region name="mexico" esize="58" />
-			<region name="anguilla" esize=""/>
-			<region name="antigua_and_barbuda" esize=""/>
-			<region name="aruba" esize=""/>
-			<region name="barbados" esize=""/>
-			<region name="belize" esize=""/>
-			<region name="bermuda" esize=""/>
-			<region name="british_virgin_islands" esize=""/>
-			<region name="el_salvador" esize=""/>
-			<region name="federation_of_saint_kitts_and_nevis" esize=""/>
-			<region name="greenland" esize=""/>
-			<region name="grenada" esize=""/>
-			<region name="guadeloupe" esize=""/>
-			<region name="martinique" esize=""/>
-			<region name="netherlands_antilles" esize=""/>
-			<region name="nicaragua" esize=""/>
-			<region name="panama" esize=""/>
-			<region name="puerto_rico" esize=""/>
-			<region name="st_lucia" esize=""/>
-			<region name="st_pierre_and_miquelon" esize=""/>
-			<region name="st_vincent_and_the_grenadines" esize=""/>
-			<region name="trinidad_and_tobago" esize=""/>
-			<region name="virgin_islands" esize=""/>
-		</regions>
-		
-		<!--  SOUTH AMERICA -->
-		<regions siteToDownload="http://downloads.cloudmade.com/south_america/{0}/{0}.osm.bz2" region_prefix="" skip="true"
-			region_suffix="_SouthAmerica">
-			<region name="argentina" esize="22"/>
-			<region name="bolivia" esize="5"/>
-			<region name="brazil" esize="68"/>
-			<region name="chile" esize="30"/>
-			<region name="colombia" esize="30"/>
-			<region name="ecuador" esize="15"/>
-			<region name="falkland_islands" esize="1"/>
-			<region name="french_guiana" esize="3"/>
-			<region name="guyana" esize="2"/>
-			<region name="paraguay" esize="3"/>
-			<region name="peru" esize="10"/>
-			<region name="suriname" esize="1"/>
-			<region name="uruguay" esize="9"/>
-			<region name="venezuela" esize="11"/>
-		</regions>
-		
-		<!-- AFRICA -->
-		<regions siteToDownload="http://downloads.cloudmade.com/africa/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Africa"  skip="true">
-			<region name="algeria" esize=""/>  
-			<region name="egypt" esize=""/>
-			<region name="madagascar" esize=""/>
-			<region name="morocco" esize=""/>
-			<region name="angola" esize=""/>
-		</regions>
-		
-		<!-- South Africa -->
-		<regions siteToDownload="http://download.geofabrik.de/osm/africa/{0}.osm.pbf" region_prefix="" region_suffix="_Africa" skip="true">
-			<region name="south_africa_and_lesotho" esize="21"/> 	
-		</regions>
-		
-		<!-- OCEANIA -->
-		<regions siteToDownload="http://downloads.cloudmade.com/oceania/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Oceania"  skip="true">
-			<region name="new_zealand" esize="23"/>
-		</regions>
-		
-		<!-- BIG countries -->		
-		
-		<regions siteToDownload="http://downloads.cloudmade.com/oceania/australia/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Oceania" skip="true">
-			<region name="australia" esize="150"/>  
-		</regions>
-		
-		<regions siteToDownload="http://downloads.cloudmade.com/asia/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Asia"  skip="true">
-			 <region name="japan" esize="500"/> 
-			 <region name="russian_federation" esize="360"/> 
-		</regions>
-		
-		<regions siteToDownload="http://download.geofabrik.de/osm/{0}.osm.pbf" region_prefix="" region_suffix=""  skip="true">
-			 <region name="africa" esize="101"/> 
-		</regions>
-		
-		
-		
-		<!-- VERY SMALL COUNTRIES TO MAKE (not worth) -->
-		<!-- Oceania -->
-		<regions siteToDownload="http://downloads.cloudmade.com/oceania/{0}/{0}.osm.bz2" region_prefix="" skip="true" region_suffix="_Oceania">
-			<region name="american_samoa" esize=""/>
-			<region name="baker_island" esize=""/>
-			<region name="cocos_keeling_islands" esize=""/>
-			<region name="cook_islands" esize=""/>
-			<region name="federated_states_of_micronesia" esize=""/>
-			<region name="fiji" esize=""/>
-			<region name="french_polynesia" esize=""/>
-			<region name="guam" esize=""/>
-			<region name="howland_island" esize=""/>
-			<region name="independent_state_of_samoa" esize=""/>
-			<region name="jarvis_island" esize=""/>
-			<region name="johnston_atoll" esize=""/>
-			<region name="kiribati" esize=""/>
-			<region name="marshall_islands" esize=""/>
-			<region name="midway_islands" esize=""/>
-			<region name="nauru" esize=""/>
-			<region name="new_caledonia" esize=""/>
-			<region name="niue" esize=""/>
-			<region name="norfolk_island" esize=""/>
-			<region name="northern_mariana_islands" esize=""/>
-			<region name="papua_new_guinea" esize=""/>
-			<region name="pitcairn_islands" esize=""/>
-			<region name="republic_of_palau" esize=""/>
-			<region name="solomon_islands" esize=""/>
-			<region name="tokelau" esize=""/>
-			<region name="tonga" esize=""/>
-			<region name="tuvalu" esize=""/>
-			<region name="vanuatu" esize=""/>
-			<region name="wake_island" esize=""/>
-			<region name="wallis_and_futuna" esize=""/>
-		</regions>
-		
-		<!-- Africa  -->
-		<regions siteToDownload="http://downloads.cloudmade.com/africa/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Africa"  skip="true">
-			<region name="benin" esize=""/>
-			<region name="botswana" esize=""/>
-			<region name="burkina_faso" esize=""/>
-			<region name="burundi" esize=""/>
-			<region name="cameroon" esize=""/>
-			<region name="cape_verde" esize=""/>
-			<region name="central_african_republic" esize=""/>
-			<region name="chad" esize=""/>
-			<region name="comoros" esize=""/>
-			<region name="congo" esize=""/>
-			<region name="democratic_republic_of_the_congo" esize=""/>
-			<region name="djibouti" esize=""/>
-			<region name="equatorial_guinea" esize=""/>
-			<region name="eritrea" esize=""/>
-			<region name="ethiopia" esize=""/>
-			<region name="gabon" esize=""/>
-			<region name="gambia" esize=""/>
-			<region name="ghana" esize=""/>
-			<region name="glorioso_islands" esize=""/>
-			<region name="guinea" esize=""/>
-			<region name="guinea-bissau" esize=""/>
-			<region name="ivory_coast" esize=""/>
-			<region name="juan_de_nova_island" esize=""/>
-			<region name="kenya" esize=""/>
-			<region name="lesotho" esize=""/>
-			<region name="liberia" esize=""/>
-			<region name="libya" esize=""/>
-			<region name="malawi" esize=""/>
-			<region name="mali" esize=""/>
-			<region name="mauritania" esize=""/>
-			<region name="mauritius" esize=""/>
-			<region name="mayotte" esize=""/>
-			<region name="mozambique" esize=""/>
-			<region name="namibia" esize=""/>
-			<region name="niger" esize=""/>
-			<region name="nigeria" esize=""/>
-			<region name="reunion" esize=""/>
-			<region name="rwanda" esize=""/>
-			<region name="sao_tome_and_principe" esize=""/>
-			<region name="senegal" esize=""/>
-			<region name="seychelles" esize=""/>
-			<region name="sierra_leone" esize=""/>
-			<region name="somalia" esize=""/>
-			<region name="st_helena" esize=""/>
-			<region name="sudan" esize=""/>
-			<region name="swaziland" esize=""/>
-			<region name="togo" esize=""/>
-			<region name="tunisia" esize=""/>
-			<region name="uganda" esize=""/>
-			<region name="united_republic_of_tanzania" esize=""/>
-			<region name="western_sahara" esize=""/>
-			<region name="zambia" esize=""/>
-			<region name="zimbabwe" esize=""/>
-		</regions>		
-	</process>
+<?xml version="1.0" encoding="utf-8"?>
+<batch_process>
+	<!-- These attributes are required  to upload/delete downloads
+	     * cookieHSID - cookie HSID is required for delete index (could be taken from source (!) of page when you are about delete index) 
+	     * cookieSID - cookie SID is required for delete index (could be taken from source (!) of page when you are about delete index)
+	     * pagegen - pagegen attribute is required for delete index (could be taken from source (!) of page when you are about delete index)
+	     * token - token attribute is required for delete index (could be taken from source (!) of page when you are about delete index)
+	     * google_code_user - is required to upload index 
+	     * google_code_password - is required to upload index (is not gmail password!) - could be found in profile 
+	-->
+	<authorization_info cookieHSID=""
+		cookieSID=""
+		pagegen="" token=""
+		google_code_user="" google_code_password="" 
+		osmand_download_user="" osmand_download_password=""/>
+	<!-- There are 3 subprocess : 	
+		 1. Download fresh osm files from servers to 'directory_for_osm_files' (override existings).
+		 2. Generate index files from all files in 'directory_for_osm_files' and put all indexes into 'directory_for_index_files'
+		 3. Upload index files from 'directory_for_index_files' to googlecode.
+		 All these subprocess could be ran independently ! So you can create some files check them and after that try to upload on googlecode,
+		 or you can upload any file you have to googlecode (just put into 'directory_for_index_files')
+	 -->
+	<process directory_for_osm_files="D:/android/batch_gen_osm" directory_for_index_files="D:/android/batch_gen_index"
+		downloadOsmFiles="true" generateIndexes="true" uploadIndexes="true" upload_osmand_download="true"
+		deleteFilesAfterUploading="true" indexPOI="true" indexMap="true"
+		indexTransport="true" indexAddress="true" mapZooms="" renderingTypesFile=""
+		>
+		<!-- Add wget="C:/Program Files/GNUWin32/bin/wget.exe" to process, to use wget for download.
+			 On linux systems if wget is in your path it can be wget="wget" or you can make own script with wget command:
+			 wget="/path/to/script/wget.sh"
+			 Defaultly enabled parameter of wget is: &-&-read-timeout=5 that prevents hanging of download from  cloudmade/geofabrik server  
+		-->
+
+		
+        <!-- Countries to download from osm server -->
+		<!-- EUROPE -->
+		<regions siteToDownload="http://download.geofabrik.de/osm/europe/{0}.osm.pbf" region_prefix="" skip="true" region_suffix="_Europe">
+			<region name="albania" esize="6" />
+			<region name="andorra" esize="1" />
+			<region name="austria" esize="110" />
+			<region name="belarus" esize="45" />
+			<region name="belgium" esize="55" />
+			<region name="bosnia-herzegovina" esize="5" />
+			<region name="bulgaria" esize="15" />
+			<region name="croatia" esize="15" />
+			<region name="cyprus" esize="6" />
+			<region name="denmark" esize="80" />
+			<region name="estonia" esize="38" />
+			<region name="faroe_islands" esize="2" />
+			<region name="finland" esize="85" />
+			<region name="greece" esize="25" />
+			<region name="hungary" esize="20" />
+			<region name="iceland" esize="10" />
+			<region name="ireland" esize="30" />
+			<region name="isle_of_man" esize="1" />
+			<region name="kosovo" esize="10" />
+			<region name="latvia" esize="10" />
+			<region name="liechtenstein" esize="1" />
+			<region name="lithuania" esize="10" />
+			<region name="luxembourg" esize="10" />
+			<region name="macedonia" esize="10" />
+			<region name="malta" esize="1" />
+			<region name="moldova" esize="5" />
+			<region name="monaco" esize="1" />
+			<region name="montenegro" esize="2" />
+			<region name="norway" esize="65" />
+			<region name="poland" esize="90" />
+			<region name="portugal" esize="15" />
+			<region name="romania" esize="30" />
+			<region name="serbia" esize="15" />
+			<region name="slovakia" esize="80" cityAdminLevel="6"/>
+			<region name="slovenia" esize="15" />
+			<region name="spain" esize="150" />
+			<region name="sweden" esize="90" />
+			<region name="switzerland" esize="90" />
+			<region name="turkey" esize="20" />
+			<region name="ukraine" esize="25" />
+
+			<region name="czech_republic" esize="180"/>
+			<region name="netherlands" esize="450" cityAdminLevel="10"/> 
+			<region name="italy" esize="255"/>
+		</regions>
+
+		<!-- GREAT BRITAIN -->
+		<regions siteToDownload="http://download.geofabrik.de/osm/europe/great_britain/{0}.osm.pbf" region_prefix="GB_" skip="true" region_suffix="_Europe">
+			<region name="scotland" esize="23"/>		
+			<region name="wales" esize="10"/>
+			<region name="england" esize="230"/>
+		</regions>
+
+		<!-- FRANCE -->
+		<regions siteToDownload="http://download.geofabrik.de/osm/europe/france/{0}.osm.pbf" region_prefix="France_" 
+			skip="true" region_suffix="_Europe">
+			<region name="alsace" esize="" />
+			<region name="aquitaine" esize="" />
+			<region name="auvergne" esize="" />
+			<region name="basse-normandie" esize="" />
+			<region name="bourgogne" esize="" />
+			<region name="bretagne" esize="" />
+			<region name="centre" esize="" />
+			<region name="champagne-ardenne" esize="" />
+			<region name="corse" esize="" />
+			<region name="franche-comte" esize="" />
+			<region name="haute-normandie" esize="" />
+			<region name="ile-de-france" esize="" />
+			<region name="languedoc-roussillon" esize="" />
+			<region name="limousin" esize="" />
+			<region name="lorraine" esize="" />
+			<region name="midi-pyrenees" esize="" />
+			<region name="nord-pas-de-calais" esize="" />
+			<region name="pays-de-la-loire" esize="" />
+			<region name="picardie" esize="" />
+			<region name="poitou-charentes" esize="" />
+			<region name="provence-alpes-cote-d-azur" esize="" />
+			<region name="rhone-alpes" esize="" />
+		</regions>
+
+		<!-- GERMANY -->
+		<regions siteToDownload="http://download.geofabrik.de/osm/europe/germany/{0}.osm.pbf" region_prefix="Germany_" skip="true" 
+			region_suffix="_Europe">
+			<region name="baden-wuerttemberg" esize="" />
+			<region name="bayern" esize="" />
+			<region name="berlin" esize="" />
+			<region name="brandenburg" esize="" />
+			<region name="bremen" esize="" />
+			<region name="hamburg" esize="" />
+			<region name="hessen" esize="" />
+			<region name="mecklenburg-vorpommern" esize="" />
+			<region name="niedersachsen" esize="" />
+			<region name="nordrhein-westfalen" esize="" />
+			<region name="rheinland-pfalz" esize="" />
+			<region name="saarland" esize="" />
+			<region name="sachsen-anhalt" esize="" />
+			<region name="sachsen" esize="" />
+			<region name="schleswig-holstein" esize="" />
+			<region name="thueringen" esize="" />
+		</regions>
+		
+		<!-- USA -->
+		<regions siteToDownload="http://downloads.cloudmade.com/north_america/united_states/{0}/{0}.osm.bz2" skip="true" region_prefix="US_" region_suffix="_NorthAmerica">
+			<region name="alabama" esize=""/>
+			<region name="alaska" esize=""/>
+			<region name="arizona" esize=""/>
+			<region name="arkansas" esize=""/>
+			<region name="colorado" esize=""/>
+			<region name="connecticut" esize=""/>
+			<region name="delaware" esize=""/>
+			<region name="district_of_columbia" esize=""/>
+			<region name="florida" esize=""/>
+			<region name="georgia" esize=""/>
+			<region name="guantanamo_bay" esize=""/> <!-- ??? -->
+			<region name="hawaii" esize=""/>
+			<region name="idaho" esize=""/>
+			<region name="illinois" esize=""/>
+			<region name="indiana" esize=""/>
+			<region name="iowa" esize=""/>
+			<region name="kansas" esize=""/>
+			<region name="kentucky" esize=""/>
+			<region name="louisiana" esize=""/>
+			<region name="maine" esize=""/>
+			<region name="maryland" esize=""/>
+			<region name="massachusetts" esize=""/>
+			<region name="michigan" esize=""/>
+			<region name="minnesota" esize=""/>
+			<region name="mississippi" esize=""/>
+			<region name="missouri" esize=""/>
+			<region name="montana" esize=""/>
+			<region name="nebraska" esize=""/>
+			<region name="nevada" esize=""/>
+			<region name="new_hampshire" esize=""/>
+			<region name="new_jersey" esize=""/>
+			<region name="new_mexico" esize=""/>
+			<region name="new_york" esize=""/>
+			<region name="north_dakota" esize=""/>
+			<region name="ohio" esize=""/>
+			<region name="oklahoma" esize=""/>
+			<region name="oregon" esize=""/>
+			<region name="pennsylvania" esize=""/>
+			<region name="rhode_island" esize=""/>
+			<region name="south_carolina" esize=""/>
+			<region name="south_dakota" esize=""/>
+			<region name="tennessee" esize=""/>
+			<region name="utah" esize=""/>
+			<region name="vermont" esize=""/>
+			<region name="washington" esize=""/>
+			<region name="west_virginia" esize=""/>
+			<region name="wisconsin" esize=""/>
+			<region name="wyoming" esize=""/>
+			<region name="virginia" esize=""/>
+			<region name="texas" esize=""/>
+			<region name="california" esize=""/>
+			<region name="north_carolina" esize=""/>
+		</regions>
+		
+		<!-- Canada -->
+		<regions siteToDownload="http://downloads.cloudmade.com/north_america/canada/{0}/{0}.osm.bz2" region_prefix="Canada_" skip="true" region_suffix="_NorthAmerica">
+			<region name="alberta" esize="36"/>
+			<region name="british_columbia" esize=""/>
+			<region name="manitoba" esize=""/>
+			<region name="new_brunswick" esize=""/>
+			<region name="newfoundland" esize=""/>
+			<region name="nova_scotia" esize=""/>
+			<region name="nunavut" esize=""/>
+			<region name="nw_territories" esize=""/>
+			<region name="ontario" esize=""/>
+			<region name="pr_edwrd_island" esize=""/>
+			<region name="quebec" esize=""/>
+			<region name="saskatchewan" esize=""/>
+			<region name="yukon" esize=""/>
+		</regions>
+		
+		<!-- Russia -->
+		<regions siteToDownload="http://gis-lab.info/data/osm/{0}/{0}.osm.bz2" region_prefix="Russia_"  skip="true" region_suffix="_Asia">
+			<region name="adygeya" esize=""/>
+			<region name="altay" esize=""/>
+			<region name="altayskiy" esize=""/>
+			<region name="amur" esize=""/>
+			<region name="arkhan" esize=""/>
+			<region name="astrakhan" esize=""/>
+			<region name="bashkir" esize=""/>
+			<region name="belgorod" esize=""/>
+			<region name="bryansk" esize=""/> 
+			<region name="buryat" esize=""/>
+			<region name="chechen" esize=""/>
+			<region name="chel" esize=""/>
+			<region name="chukot" esize=""/>
+			<region name="chuvash" esize=""/>
+			<region name="dagestan" esize=""/>
+			<region name="evrey" esize=""/>
+			<region name="ingush" esize=""/>
+			<region name="irkutsk" esize=""/>
+			<region name="ivanov" esize=""/>
+			<region name="kabardin" esize=""/>
+			<region name="kalinin" esize=""/>
+			<region name="kalmyk" esize=""/>
+			<region name="kaluzh" esize=""/>
+			<region name="kamch" esize=""/>
+			<region name="karach" esize=""/>
+			<region name="karel" esize=""/>
+			<region name="kemerovo" esize=""/>
+			<region name="khabar" esize=""/>
+			<region name="khakas" esize=""/>
+			<region name="khanty" esize=""/>
+			<region name="kirov" esize=""/>
+			<region name="komi" esize=""/>
+			<region name="kostrom" esize=""/>
+			<region name="krasnodar" esize=""/>
+			<region name="krasnoyarsk" esize=""/>
+			<region name="kurgan" esize=""/>
+			<region name="kursk" esize=""/>
+			<region name="leningrad" esize=""/>
+			<region name="lipetsk" esize=""/>
+			<region name="magadan" esize=""/>
+			<region name="mariyel" esize=""/>
+			<region name="mordov" esize=""/>
+			<region name="moscow" esize=""/>
+			<region name="mosobl" esize=""/>
+			<region name="murmansk" esize=""/>
+			<region name="nenec" esize=""/>
+			<region name="nizhegorod" esize=""/>
+			<region name="novgorod" esize=""/>
+			<region name="novosib" esize=""/>
+			<region name="omsk" esize=""/>
+			<region name="orenburg" esize=""/>
+			<region name="orlovsk" esize=""/>
+			<region name="osetiya" esize=""/>
+			<region name="penz" esize=""/>
+			<region name="perm" esize=""/>
+			<region name="prim" esize=""/>
+			<region name="pskov" esize=""/>
+			<region name="rostov" esize=""/>
+			<region name="ryazan" esize=""/>
+			<region name="sakhalin" esize=""/>
+			<region name="samar" esize=""/>
+			<region name="saratov" esize=""/>
+			<region name="smol" esize=""/>
+			<region name="stavrop" esize=""/>
+			<region name="stpeter" esize=""/>
+			<region name="sverdl" esize=""/>
+			<region name="tambov" esize=""/>
+			<region name="tatar" esize=""/>
+			<region name="tomsk" esize=""/>
+			<region name="tul" esize=""/>
+			<region name="tumen" esize=""/>
+			<region name="tver" esize=""/>
+			<region name="tyva" esize=""/>
+			<region name="udmurt" esize=""/>
+			<region name="ulyan" esize=""/>
+			<region name="vladimir" esize=""/>
+			<region name="volgograd" esize=""/>
+			<region name="vologda" esize=""/>
+			<region name="voronezh" esize=""/>
+			<region name="yakut" esize=""/>
+			<region name="yamal" esize=""/>
+			<region name="yarosl" esize=""/>
+			<region name="zabaikal" esize=""/>
+		</regions>
+		
+	    
+		<!-- ASIA -->
+		<regions siteToDownload="http://downloads.cloudmade.com/asia/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Asia" skip="true">
+			<region name="afghanistan" esize="6"/>
+			<region name="bahrain" esize="1"/>
+			<region name="bangladesh" esize="3"/>
+			<region name="bhutan" esize="1"/>
+			<region name="british_indian_ocean_territory" esize="1"/>
+			<region name="brunei" esize="1"/>
+			<region name="cambodia" esize="2"/>
+			<region name="china" esize="67"/>
+			<region name="christmas_island" esize="1"/>
+			<region name="democratic_republic_of_timor-leste" esize="1"/>
+			<region name="gaza_strip" esize="3"/>
+			<region name="india" esize="47"/>  
+			<region name="indonesia" esize="21"/>
+			<region name="iran" esize="11"/>
+			<region name="iraq" esize="3"/>
+			<region name="israel" esize="18"/>
+			<region name="jordan" esize="1"/>
+			<region name="kazakhstan" esize="15"/>
+			<region name="kuwait" esize="1"/>
+			<region name="kyrgyzstan" esize="4"/>
+			<region name="laos" esize="3"/>
+			<region name="lebanon" esize="3"/>
+			<region name="macau" esize="1"/>
+			<region name="malaysia" esize="7"/>
+			<region name="maldives" esize="1"/>
+			<region name="mongolia" esize="3"/>
+			<region name="nepal" esize="2"/>
+			<region name="north_korea" esize="5"/>
+			<region name="oman" esize="2"/>
+			<region name="pakistan" esize="14"/>
+			<region name="paracel_islands" esize="1"/>
+			<region name="philippines" esize="25"/>
+			<region name="qatar" esize="1"/>
+			<region name="saudi_arabia" esize="9"/>
+			<region name="singapore" esize="2"/>
+			<region name="south_korea" esize="25"/>
+			<region name="spratly_islands" esize="1"/>
+			<region name="sri_lanka" esize="2"/>
+			<region name="syria" esize="4"/>
+			<region name="taiwan" esize="4"/>
+			<region name="tajikistan" esize="3"/>
+			<region name="thailand" esize="12"/>
+			<region name="turkmenistan" esize="1"/>
+			<region name="union_of_myanmar" esize="7"/>
+			<region name="united_arab_emirates" esize="2"/>
+			<region name="uzbekistan" esize="3"/>
+			<region name="vietnam" esize=""/>
+			<region name="yemen" esize=""/> 
+		</regions>
+		
+		
+		<!--  CENTRAL AMERICA -->
+		<regions siteToDownload="http://downloads.cloudmade.com/north_america/{0}/{0}.osm.bz2" region_prefix=""  skip="true" region_suffix="_CentralAmerica">
+			<region name="bahamas" esize="1" />
+			<region name="costa_rica" esize="3" />
+			<region name="cuba" esize="3" />
+			<region name="dominica" esize="1" />
+			<region name="dominican_republic" esize="6" />
+			<region name="guatemala" esize="4" />
+			<region name="haiti" esize="21" />
+			<region name="honduras" esize="3" />
+			<region name="jamaica" esize="1" />
+			<region name="mexico" esize="58" />
+			<region name="anguilla" esize=""/>
+			<region name="antigua_and_barbuda" esize=""/>
+			<region name="aruba" esize=""/>
+			<region name="barbados" esize=""/>
+			<region name="belize" esize=""/>
+			<region name="bermuda" esize=""/>
+			<region name="british_virgin_islands" esize=""/>
+			<region name="el_salvador" esize=""/>
+			<region name="federation_of_saint_kitts_and_nevis" esize=""/>
+			<region name="greenland" esize=""/>
+			<region name="grenada" esize=""/>
+			<region name="guadeloupe" esize=""/>
+			<region name="martinique" esize=""/>
+			<region name="netherlands_antilles" esize=""/>
+			<region name="nicaragua" esize=""/>
+			<region name="panama" esize=""/>
+			<region name="puerto_rico" esize=""/>
+			<region name="st_lucia" esize=""/>
+			<region name="st_pierre_and_miquelon" esize=""/>
+			<region name="st_vincent_and_the_grenadines" esize=""/>
+			<region name="trinidad_and_tobago" esize=""/>
+			<region name="virgin_islands" esize=""/>
+		</regions>
+		
+		<!--  SOUTH AMERICA -->
+		<regions siteToDownload="http://downloads.cloudmade.com/south_america/{0}/{0}.osm.bz2" region_prefix="" skip="true"
+			region_suffix="_SouthAmerica">
+			<region name="argentina" esize="22"/>
+			<region name="bolivia" esize="5"/>
+			<region name="brazil" esize="68"/>
+			<region name="chile" esize="30"/>
+			<region name="colombia" esize="30"/>
+			<region name="ecuador" esize="15"/>
+			<region name="falkland_islands" esize="1"/>
+			<region name="french_guiana" esize="3"/>
+			<region name="guyana" esize="2"/>
+			<region name="paraguay" esize="3"/>
+			<region name="peru" esize="10"/>
+			<region name="suriname" esize="1"/>
+			<region name="uruguay" esize="9"/>
+			<region name="venezuela" esize="11"/>
+		</regions>
+		
+		<!-- AFRICA -->
+		<regions siteToDownload="http://downloads.cloudmade.com/africa/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Africa"  skip="true">
+			<region name="algeria" esize=""/>  
+			<region name="egypt" esize=""/>
+			<region name="madagascar" esize=""/>
+			<region name="morocco" esize=""/>
+			<region name="angola" esize=""/>
+		</regions>
+		
+		<!-- South Africa -->
+		<regions siteToDownload="http://download.geofabrik.de/osm/africa/{0}.osm.pbf" region_prefix="" region_suffix="_Africa" skip="true">
+			<region name="south_africa_and_lesotho" esize="21"/> 	
+		</regions>
+		
+		<!-- OCEANIA -->
+		<regions siteToDownload="http://downloads.cloudmade.com/oceania/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Oceania"  skip="true">
+			<region name="new_zealand" esize="23"/>
+		</regions>
+		
+		<!-- BIG countries -->		
+		
+		<regions siteToDownload="http://downloads.cloudmade.com/oceania/australia/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Oceania" skip="true">
+			<region name="australia" esize="150"/>  
+		</regions>
+		
+		<regions siteToDownload="http://downloads.cloudmade.com/asia/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Asia"  skip="true">
+			 <region name="japan" esize="500"/> 
+			 <region name="russian_federation" esize="360"/> 
+		</regions>
+		
+		<regions siteToDownload="http://download.geofabrik.de/osm/{0}.osm.pbf" region_prefix="" region_suffix=""  skip="true">
+			 <region name="africa" esize="101"/> 
+		</regions>
+		
+		
+		
+		<!-- VERY SMALL COUNTRIES TO MAKE (not worth) -->
+		<!-- Oceania -->
+		<regions siteToDownload="http://downloads.cloudmade.com/oceania/{0}/{0}.osm.bz2" region_prefix="" skip="true" region_suffix="_Oceania">
+			<region name="american_samoa" esize=""/>
+			<region name="baker_island" esize=""/>
+			<region name="cocos_keeling_islands" esize=""/>
+			<region name="cook_islands" esize=""/>
+			<region name="federated_states_of_micronesia" esize=""/>
+			<region name="fiji" esize=""/>
+			<region name="french_polynesia" esize=""/>
+			<region name="guam" esize=""/>
+			<region name="howland_island" esize=""/>
+			<region name="independent_state_of_samoa" esize=""/>
+			<region name="jarvis_island" esize=""/>
+			<region name="johnston_atoll" esize=""/>
+			<region name="kiribati" esize=""/>
+			<region name="marshall_islands" esize=""/>
+			<region name="midway_islands" esize=""/>
+			<region name="nauru" esize=""/>
+			<region name="new_caledonia" esize=""/>
+			<region name="niue" esize=""/>
+			<region name="norfolk_island" esize=""/>
+			<region name="northern_mariana_islands" esize=""/>
+			<region name="papua_new_guinea" esize=""/>
+			<region name="pitcairn_islands" esize=""/>
+			<region name="republic_of_palau" esize=""/>
+			<region name="solomon_islands" esize=""/>
+			<region name="tokelau" esize=""/>
+			<region name="tonga" esize=""/>
+			<region name="tuvalu" esize=""/>
+			<region name="vanuatu" esize=""/>
+			<region name="wake_island" esize=""/>
+			<region name="wallis_and_futuna" esize=""/>
+		</regions>
+		
+		<!-- Africa  -->
+		<regions siteToDownload="http://downloads.cloudmade.com/africa/{0}/{0}.osm.bz2" region_prefix="" region_suffix="_Africa"  skip="true">
+			<region name="benin" esize=""/>
+			<region name="botswana" esize=""/>
+			<region name="burkina_faso" esize=""/>
+			<region name="burundi" esize=""/>
+			<region name="cameroon" esize=""/>
+			<region name="cape_verde" esize=""/>
+			<region name="central_african_republic" esize=""/>
+			<region name="chad" esize=""/>
+			<region name="comoros" esize=""/>
+			<region name="congo" esize=""/>
+			<region name="democratic_republic_of_the_congo" esize=""/>
+			<region name="djibouti" esize=""/>
+			<region name="equatorial_guinea" esize=""/>
+			<region name="eritrea" esize=""/>
+			<region name="ethiopia" esize=""/>
+			<region name="gabon" esize=""/>
+			<region name="gambia" esize=""/>
+			<region name="ghana" esize=""/>
+			<region name="glorioso_islands" esize=""/>
+			<region name="guinea" esize=""/>
+			<region name="guinea-bissau" esize=""/>
+			<region name="ivory_coast" esize=""/>
+			<region name="juan_de_nova_island" esize=""/>
+			<region name="kenya" esize=""/>
+			<region name="lesotho" esize=""/>
+			<region name="liberia" esize=""/>
+			<region name="libya" esize=""/>
+			<region name="malawi" esize=""/>
+			<region name="mali" esize=""/>
+			<region name="mauritania" esize=""/>
+			<region name="mauritius" esize=""/>
+			<region name="mayotte" esize=""/>
+			<region name="mozambique" esize=""/>
+			<region name="namibia" esize=""/>
+			<region name="niger" esize=""/>
+			<region name="nigeria" esize=""/>
+			<region name="reunion" esize=""/>
+			<region name="rwanda" esize=""/>
+			<region name="sao_tome_and_principe" esize=""/>
+			<region name="senegal" esize=""/>
+			<region name="seychelles" esize=""/>
+			<region name="sierra_leone" esize=""/>
+			<region name="somalia" esize=""/>
+			<region name="st_helena" esize=""/>
+			<region name="sudan" esize=""/>
+			<region name="swaziland" esize=""/>
+			<region name="togo" esize=""/>
+			<region name="tunisia" esize=""/>
+			<region name="uganda" esize=""/>
+			<region name="united_republic_of_tanzania" esize=""/>
+			<region name="western_sahara" esize=""/>
+			<region name="zambia" esize=""/>
+			<region name="zimbabwe" esize=""/>
+		</regions>		
+	</process>
 </batch_process> 
\ No newline at end of file
diff --git a/DataExtractionOSM/src/net/osmand/swing/DataExtractionSettings.java b/DataExtractionOSM/src/net/osmand/swing/DataExtractionSettings.java
index b96ace153a7..066325000ae 100644
--- a/DataExtractionOSM/src/net/osmand/swing/DataExtractionSettings.java
+++ b/DataExtractionOSM/src/net/osmand/swing/DataExtractionSettings.java
@@ -1,235 +1,243 @@
-package net.osmand.swing;
-
-import java.awt.Rectangle;
-import java.io.File;
-import java.util.ArrayList;
-import java.util.List;
-import java.util.prefs.Preferences;
-
-import net.osmand.data.preparation.MapZooms;
-import net.osmand.osm.LatLon;
-
-
-public class DataExtractionSettings {
-
-	private static DataExtractionSettings settings = null;
-	public static DataExtractionSettings getSettings(){
-		if(settings == null){
-			settings = new DataExtractionSettings();
-		}
-		return settings;
-		
-	}
-	
-	Preferences preferences = Preferences.userRoot();
-
-	
-	public File getTilesDirectory(){
-		return new File(getDefaultWorkingDir(), "tiles");
-	}
-
-	public File getDefaultWorkingDir(){
-		String workingDir = preferences.get("working_dir", System.getProperty("user.home"));
-		if(workingDir.equals(System.getProperty("user.home"))){
-			workingDir += "/osmand";
-			new File(workingDir).mkdir();
-		}
-		return new File(workingDir);
-	}
-	
-	public void saveDefaultWorkingDir(File path){
-		preferences.put("working_dir", path.getAbsolutePath());
-	}
-	
-	
-	public File[] getDefaultRoutingFile(){
-		String routingFile = preferences.get("routing_file", null);
-		if(routingFile == null){
-			return null;
-		}
-		String[] files = routingFile.split(",");
-		List<File> fs = new ArrayList<File>();
-		for(String f : files){
-			if(new File(f.trim()).exists()){
-				fs.add(new File(f.trim()));
-			}
-		}
-		
-		return fs.toArray(new File[fs.size()]);
-	}
-	
-    public String getDefaultRoutingFilePath(){
-    	File[] file = getDefaultRoutingFile();
-		String path = "";
-		if (file != null) {
-			for (int i = 0; i < file.length; i++) {
-				if (i > 0) {
-					path += ", ";
-				}
-				path += file[i].getAbsolutePath();
-			}
-		}
-		return path;
-    }
-	
-	public void setDefaultRoutingPath(String path){
-		preferences.put("routing_file", path);
-	}
-	
-	public LatLon getDefaultLocation(){
-		double lat = preferences.getDouble("default_lat",  53.9);
-		double lon = preferences.getDouble("default_lon",  27.56);
-		return new LatLon(lat, lon);
-	}
-	
-	public void saveDefaultLocation(double lat, double lon){
-		preferences.putDouble("default_lat",  lat);
-		preferences.putDouble("default_lon",  lon);
-	}
-	
-	public MapZooms getMapZooms(){
-		String value = preferences.get("map_zooms", MapZooms.MAP_ZOOMS_DEFAULT);
-		return MapZooms.parseZooms(value);
-	}
-	
-	public String getMapZoomsValue(){
-		return preferences.get("map_zooms", MapZooms.MAP_ZOOMS_DEFAULT);
-	}
-	
-	public void setMapZooms(String zooms){
-		// check string
-		MapZooms.parseZooms(zooms);
-		preferences.put("map_zooms", zooms);
-	}
-	
-	
-	public String getMapRenderingTypesFile(){
-		return preferences.get("rendering_types_file", "");
-	}
-	
-	
-	public void setMapRenderingTypesFile(String fileName){
-		preferences.put("rendering_types_file", fileName);
-	}
-	public int getDefaultZoom(){
-		return preferences.getInt("default_zoom",  5);
-	}
-	
-	public void saveDefaultZoom(int zoom){
-		preferences.putInt("default_zoom",  zoom);
-	}
-	
-	public boolean getLoadEntityInfo(){
-		return preferences.getBoolean("load_entity_info",  true);
-	}
-	
-	public void setLoadEntityInfo(boolean loadEntityInfo){
-		preferences.putBoolean("load_entity_info",  loadEntityInfo);
-	}
-	
-	public Rectangle getWindowBounds(){
-		Rectangle r = new Rectangle();
-		r.x = preferences.getInt("window_x",  0);
-		r.y = preferences.getInt("window_y",  0);
-		r.width = preferences.getInt("window_width",  800);
-		r.height = preferences.getInt("window_height",  600);
-		return r;
-	}
-	
-	public void saveWindowBounds(Rectangle r) {
-		preferences.putInt("window_x", r.x);
-		preferences.putInt("window_y", r.y);
-		preferences.putInt("window_width", r.width);
-		preferences.putInt("window_height", r.height);
-	}
-	
-	
-	
-	public boolean useInternetToLoadImages(){
-		return preferences.getBoolean("use_internet", true);
-	}
-	
-	public void setUseInterentToLoadImages(boolean b){
-		preferences.putBoolean("use_internet", b);
-	}
-	
-	public boolean isSupressWarningsForDuplicatedId(){
-		return preferences.getBoolean("supress_duplicated_id", true);
-	}
-	
-	public void setSupressWarningsForDuplicatedId(boolean b){
-		preferences.putBoolean("supress_duplicated_id", b);
-	}
-	
-	
-	String[] SUFFIXES = new String[] {"av.", "avenue", ".", ".", ".",".", "", ".", ".", "", ""};
-	String[] DEFAUTL_SUFFIXES = new String[] {"str.", "street", "", "."};
-	public String[] getSuffixesToNormalizeStreets(){
-		String s = preferences.get("suffixes_normalize_streets", null);
-		if(s == null){
-			return SUFFIXES;
-		}
-		List<String> l = new ArrayList<String>();
-		int i = 0;
-		int nextI = 0;
-		while((nextI=s.indexOf(',',i)) >= 0){
-			String t = s.substring(i, nextI).trim();
-			if(t.length() > 0){
-				l.add(t);
-			}
-			i = nextI + 1;
-		}
-		return l.toArray(new String[l.size()]);
-	}
-	
-	public String[] getDefaultSuffixesToNormalizeStreets(){
-		String s = preferences.get("default_suffixes_normalize_streets", null);
-		if(s == null){
-			return DEFAUTL_SUFFIXES;
-		}
-		List<String> l = new ArrayList<String>();
-		int i = 0;
-		int nextI = 0;
-		while((nextI=s.indexOf(',',i)) >= 0){
-			String t = s.substring(i, nextI).trim();
-			if(t.length() > 0){
-				l.add(t);
-			}
-			i = nextI + 1;
-		}
-		return l.toArray(new String[l.size()]);
-	}
-	
-	public String getSuffixesToNormalizeStreetsString(){
-		String s = preferences.get("suffixes_normalize_streets", null);
-		if(s == null){
-			StringBuilder b = new StringBuilder();
-			for(String st : SUFFIXES){
-				b.append(st).append(", ");
-			}
-			return b.toString();
-		}
-		return s;
-	}
-	
-	public String getDefaultSuffixesToNormalizeStreetsString(){
-		String s = preferences.get("default_suffixes_normalize_streets", null);
-		if(s == null){
-			StringBuilder b = new StringBuilder();
-			for(String st : DEFAUTL_SUFFIXES){
-				b.append(st).append(", ");
-			}
-			return b.toString();
-		}
-		return s;
-	}
-	
-	public void setDefaultSuffixesToNormalizeStreets(String s){
-		preferences.put("default_suffixes_normalize_streets", s);
-	}
-	
-	public void setSuffixesToNormalizeStreets(String s){
-		preferences.put("suffixes_normalize_streets", s);
-	}
-	
-}
+package net.osmand.swing;
+
+import java.awt.Rectangle;
+import java.io.File;
+import java.util.ArrayList;
+import java.util.List;
+import java.util.prefs.Preferences;
+
+import net.osmand.data.preparation.MapZooms;
+import net.osmand.osm.LatLon;
+
+
+public class DataExtractionSettings {
+
+	private static DataExtractionSettings settings = null;
+	public static DataExtractionSettings getSettings(){
+		if(settings == null){
+			settings = new DataExtractionSettings();
+		}
+		return settings;
+		
+	}
+	
+	Preferences preferences = Preferences.userRoot();
+
+	
+	public File getTilesDirectory(){
+		return new File(getDefaultWorkingDir(), "tiles");
+	}
+
+	public File getDefaultWorkingDir(){
+		String workingDir = preferences.get("working_dir", System.getProperty("user.home"));
+		if(workingDir.equals(System.getProperty("user.home"))){
+			workingDir += "/osmand";
+			new File(workingDir).mkdir();
+		}
+		return new File(workingDir);
+	}
+	
+	public void saveDefaultWorkingDir(File path){
+		preferences.put("working_dir", path.getAbsolutePath());
+	}
+	
+	
+	public File[] getDefaultRoutingFile(){
+		String routingFile = preferences.get("routing_file", null);
+		if(routingFile == null){
+			return null;
+		}
+		String[] files = routingFile.split(",");
+		List<File> fs = new ArrayList<File>();
+		for(String f : files){
+			if(new File(f.trim()).exists()){
+				fs.add(new File(f.trim()));
+			}
+		}
+		
+		return fs.toArray(new File[fs.size()]);
+	}
+	
+    public String getDefaultRoutingFilePath(){
+    	File[] file = getDefaultRoutingFile();
+		String path = "";
+		if (file != null) {
+			for (int i = 0; i < file.length; i++) {
+				if (i > 0) {
+					path += ", ";
+				}
+				path += file[i].getAbsolutePath();
+			}
+		}
+		return path;
+    }
+	
+	public void setDefaultRoutingPath(String path){
+		preferences.put("routing_file", path);
+	}
+	
+	public LatLon getDefaultLocation(){
+		double lat = preferences.getDouble("default_lat",  53.9);
+		double lon = preferences.getDouble("default_lon",  27.56);
+		return new LatLon(lat, lon);
+	}
+	
+	public void saveDefaultLocation(double lat, double lon){
+		preferences.putDouble("default_lat",  lat);
+		preferences.putDouble("default_lon",  lon);
+	}
+	
+	public MapZooms getMapZooms(){
+		String value = preferences.get("map_zooms", MapZooms.MAP_ZOOMS_DEFAULT);
+		return MapZooms.parseZooms(value);
+	}
+	
+	public String getMapZoomsValue(){
+		return preferences.get("map_zooms", MapZooms.MAP_ZOOMS_DEFAULT);
+	}
+	
+	public void setMapZooms(String zooms){
+		// check string
+		MapZooms.parseZooms(zooms);
+		preferences.put("map_zooms", zooms);
+	}
+	
+	
+	public String getMapRenderingTypesFile(){
+		return preferences.get("rendering_types_file", "");
+	}
+	
+	
+	public void setMapRenderingTypesFile(String fileName){
+		preferences.put("rendering_types_file", fileName);
+	}
+	public int getDefaultZoom(){
+		return preferences.getInt("default_zoom",  5);
+	}
+	
+	public void saveDefaultZoom(int zoom){
+		preferences.putInt("default_zoom",  zoom);
+	}
+	
+	public boolean getLoadEntityInfo(){
+		return preferences.getBoolean("load_entity_info",  true);
+	}
+	
+	public void setLoadEntityInfo(boolean loadEntityInfo){
+		preferences.putBoolean("load_entity_info",  loadEntityInfo);
+	}
+	
+	public Rectangle getWindowBounds(){
+		Rectangle r = new Rectangle();
+		r.x = preferences.getInt("window_x",  0);
+		r.y = preferences.getInt("window_y",  0);
+		r.width = preferences.getInt("window_width",  800);
+		r.height = preferences.getInt("window_height",  600);
+		return r;
+	}
+	
+	public void saveWindowBounds(Rectangle r) {
+		preferences.putInt("window_x", r.x);
+		preferences.putInt("window_y", r.y);
+		preferences.putInt("window_width", r.width);
+		preferences.putInt("window_height", r.height);
+	}
+	
+	
+	
+	public boolean useInternetToLoadImages(){
+		return preferences.getBoolean("use_internet", true);
+	}
+	
+	public void setUseInterentToLoadImages(boolean b){
+		preferences.putBoolean("use_internet", b);
+	}
+	
+	public String getCityAdminLevel(){
+		return preferences.getString("cityAdminLevel", "8");
+	}
+	
+	public void setCityAdminLevel(String s){
+		preferences.putString("cityAdminLevel", s);
+	}
+	
+	public boolean isSupressWarningsForDuplicatedId(){
+		return preferences.getBoolean("supress_duplicated_id", true);
+	}
+	
+	public void setSupressWarningsForDuplicatedId(boolean b){
+		preferences.putBoolean("supress_duplicated_id", b);
+	}
+	
+	
+	String[] SUFFIXES = new String[] {"av.", "avenue", ".", ".", ".",".", "", ".", ".", "", ""};
+	String[] DEFAUTL_SUFFIXES = new String[] {"str.", "street", "", "."};
+	public String[] getSuffixesToNormalizeStreets(){
+		String s = preferences.get("suffixes_normalize_streets", null);
+		if(s == null){
+			return SUFFIXES;
+		}
+		List<String> l = new ArrayList<String>();
+		int i = 0;
+		int nextI = 0;
+		while((nextI=s.indexOf(',',i)) >= 0){
+			String t = s.substring(i, nextI).trim();
+			if(t.length() > 0){
+				l.add(t);
+			}
+			i = nextI + 1;
+		}
+		return l.toArray(new String[l.size()]);
+	}
+	
+	public String[] getDefaultSuffixesToNormalizeStreets(){
+		String s = preferences.get("default_suffixes_normalize_streets", null);
+		if(s == null){
+			return DEFAUTL_SUFFIXES;
+		}
+		List<String> l = new ArrayList<String>();
+		int i = 0;
+		int nextI = 0;
+		while((nextI=s.indexOf(',',i)) >= 0){
+			String t = s.substring(i, nextI).trim();
+			if(t.length() > 0){
+				l.add(t);
+			}
+			i = nextI + 1;
+		}
+		return l.toArray(new String[l.size()]);
+	}
+	
+	public String getSuffixesToNormalizeStreetsString(){
+		String s = preferences.get("suffixes_normalize_streets", null);
+		if(s == null){
+			StringBuilder b = new StringBuilder();
+			for(String st : SUFFIXES){
+				b.append(st).append(", ");
+			}
+			return b.toString();
+		}
+		return s;
+	}
+	
+	public String getDefaultSuffixesToNormalizeStreetsString(){
+		String s = preferences.get("default_suffixes_normalize_streets", null);
+		if(s == null){
+			StringBuilder b = new StringBuilder();
+			for(String st : DEFAUTL_SUFFIXES){
+				b.append(st).append(", ");
+			}
+			return b.toString();
+		}
+		return s;
+	}
+	
+	public void setDefaultSuffixesToNormalizeStreets(String s){
+		preferences.put("default_suffixes_normalize_streets", s);
+	}
+	
+	public void setSuffixesToNormalizeStreets(String s){
+		preferences.put("suffixes_normalize_streets", s);
+	}
+	
+}
diff --git a/DataExtractionOSM/src/net/osmand/swing/OsmExtractionPreferencesDialog.java b/DataExtractionOSM/src/net/osmand/swing/OsmExtractionPreferencesDialog.java
index 7f1f7301e3b..42298602715 100644
--- a/DataExtractionOSM/src/net/osmand/swing/OsmExtractionPreferencesDialog.java
+++ b/DataExtractionOSM/src/net/osmand/swing/OsmExtractionPreferencesDialog.java
@@ -1,277 +1,303 @@
-package net.osmand.swing;
-
-import java.awt.Component;
-import java.awt.Dimension;
-import java.awt.FlowLayout;
-import java.awt.GridBagConstraints;
-import java.awt.GridBagLayout;
-import java.awt.event.ActionEvent;
-import java.awt.event.ActionListener;
-
-import javax.swing.BorderFactory;
-import javax.swing.Box;
-import javax.swing.BoxLayout;
-import javax.swing.JButton;
-import javax.swing.JCheckBox;
-import javax.swing.JDialog;
-import javax.swing.JLabel;
-import javax.swing.JOptionPane;
-import javax.swing.JPanel;
-import javax.swing.JTextField;
-
-public class OsmExtractionPreferencesDialog extends JDialog {
-	
-	private static final long serialVersionUID = -4862884032977071296L;
-	
-	private JButton okButton;
-	private JButton cancelButton;
-
-	private JTextField streetSuffixes;
-	private JTextField streetDefaultSuffixes;
-	private JTextField mapZooms;
-	private JTextField renderingTypesFile;
-	private JTextField pathToObfRoutingFile;
-
-	private JCheckBox useInternet;
-
-	
-//	private JCheckBox supressWarning;
-//	private JCheckBox loadWholeOsmInfo;
-
-	public OsmExtractionPreferencesDialog(Component parent){
-    	super(JOptionPane.getFrameForComponent(parent), true);
-    	setTitle(Messages.getString("OsmExtractionPreferencesDialog.PREFERENCES")); //$NON-NLS-1$
-        initDialog();
-        
-    }
-	
-	public void showDialog(){
-		setSize(600, 280);
-        double x = getParent().getBounds().getCenterX();
-        double y = getParent().getBounds().getCenterY();
-        setLocation((int) x - getWidth() / 2, (int) y - getHeight() / 2);
-        setVisible(true);
-	}
-	
-	private void initDialog() {
-		JPanel pane = new JPanel();
-		pane.setLayout(new BoxLayout(pane, BoxLayout.Y_AXIS));
-        pane.setBorder(BorderFactory.createEmptyBorder(10, 10, 5, 10));
-        add(pane);
-        
-        
-        createGeneralSection(pane);
-        createNormalizingStreetSection(pane);
-        pane.add(Box.createVerticalGlue());	
-        
-        FlowLayout l = new FlowLayout(FlowLayout.RIGHT);
-        JPanel buttonsPane = new JPanel(l);
-        okButton = new JButton(Messages.getString("OsmExtractionPreferencesDialog.OK")); //$NON-NLS-1$
-        buttonsPane.add(okButton);
-        cancelButton = new JButton(Messages.getString("OsmExtractionPreferencesDialog.CANCEL")); //$NON-NLS-1$
-        buttonsPane.add(cancelButton);
-        
-        buttonsPane.setMaximumSize(new Dimension(Short.MAX_VALUE, (int) l.preferredLayoutSize(buttonsPane).getHeight()));
-        pane.add(buttonsPane);
-        
-        addListeners();
-	}
-	
-	private void createGeneralSection(JPanel root) {
-		JPanel panel = new JPanel();
-//		panel.setLayout(new GridLayout(3, 1, 5, 5));
-		GridBagLayout l = new GridBagLayout();
-		panel.setLayout(l);
-		panel.setBorder(BorderFactory.createTitledBorder(Messages.getString("OsmExtractionPreferencesDialog.GENERAL"))); //$NON-NLS-1$
-		root.add(panel);
-		
-		useInternet = new JCheckBox();
-		useInternet.setText(Messages.getString("OsmExtractionPreferencesDialog.INTERNET.TO.DOWNLOAD.FILES")); //$NON-NLS-1$
-		useInternet.setSelected(DataExtractionSettings.getSettings().useInternetToLoadImages());
-		panel.add(useInternet);
-		GridBagConstraints constr = new GridBagConstraints();
-		constr.ipadx = 5;
-		constr.gridx = 0;
-		constr.gridy = 0;
-		constr.gridwidth = 2;
-		constr.anchor = GridBagConstraints.WEST;
-		l.setConstraints(useInternet, constr);
-		
-		JLabel label = new JLabel("Path to obf file (test routing purpose) : ");
-		panel.add(label);
-		constr = new GridBagConstraints();
-		constr.ipadx = 5;
-		constr.gridx = 0;
-		constr.gridy = 1;
-		constr.anchor = GridBagConstraints.WEST;
-		l.setConstraints(label, constr);
-		
-		pathToObfRoutingFile = new JTextField();
-		
-		pathToObfRoutingFile.setText(DataExtractionSettings.getSettings().getDefaultRoutingFilePath());
-		panel.add(pathToObfRoutingFile);
-		constr = new GridBagConstraints();
-		constr.weightx = 1;
-		constr.fill = GridBagConstraints.HORIZONTAL;
-		constr.ipadx = 5;
-		constr.gridx = 1;
-		constr.gridy = 1;
-		l.setConstraints(pathToObfRoutingFile, constr);
-		
-//		supressWarning = new JCheckBox();
-//		supressWarning.setText(Messages.getString("OsmExtractionPreferencesDialog.DUPLICATED.ID")); //$NON-NLS-1$
-//		supressWarning.setSelected(DataExtractionSettings.getSettings().isSupressWarningsForDuplicatedId());
-//		panel.add(supressWarning);
-//		
-//		loadWholeOsmInfo = new JCheckBox();
-//		loadWholeOsmInfo.setText(Messages.getString("OsmExtractionPreferencesDialog.LOAD.WHOLE.OSM")); //$NON-NLS-1$
-//		loadWholeOsmInfo.setSelected(DataExtractionSettings.getSettings().getLoadEntityInfo());
-//		panel.add(loadWholeOsmInfo);
-		
-		panel.setMaximumSize(new Dimension(Short.MAX_VALUE, panel.getPreferredSize().height));
-		
-	}
-
-	private void createNormalizingStreetSection(JPanel root) {
-		JPanel panel = new JPanel();
-		GridBagLayout l = new GridBagLayout();
-		panel.setLayout(l);
-		panel.setBorder(BorderFactory.createTitledBorder("Map creation parameters"));
-		root.add(panel);
-
-		JLabel label = new JLabel(Messages.getString("OsmExtractionPreferencesDialog.NAME.SUFFIXES")); //$NON-NLS-1$
-		panel.add(label);
-		GridBagConstraints constr = new GridBagConstraints();
-		constr.anchor = GridBagConstraints.WEST;
-		constr.ipadx = 5;
-		constr.gridx = 0;
-		constr.gridy = 0;
-		l.setConstraints(label, constr);
-		
-		streetSuffixes = new JTextField();
-		streetSuffixes.setText(DataExtractionSettings.getSettings().getSuffixesToNormalizeStreetsString());
-		panel.add(streetSuffixes);
-		constr = new GridBagConstraints();
-		constr.fill = GridBagConstraints.HORIZONTAL;
-		constr.ipadx = 5;
-		constr.gridx = 1;
-		constr.gridy = 0;
-		l.setConstraints(streetSuffixes, constr);
-		
-		label = new JLabel(Messages.getString("OsmExtractionPreferencesDialog.DEFAULT.SUFFIXES")); //$NON-NLS-1$
-		panel.add(label);
-		constr = new GridBagConstraints();
-		constr.ipadx = 5;
-		constr.gridx = 0;
-		constr.gridy = 1;
-		constr.anchor = GridBagConstraints.WEST;
-		l.setConstraints(label, constr);
-		
-		streetDefaultSuffixes = new JTextField();
-		streetDefaultSuffixes.setText(DataExtractionSettings.getSettings().getDefaultSuffixesToNormalizeStreetsString());
-		panel.add(streetDefaultSuffixes);
-		constr = new GridBagConstraints();
-		constr.weightx = 1;
-		constr.fill = GridBagConstraints.HORIZONTAL;
-		constr.ipadx = 5;
-		constr.gridx = 1;
-		constr.gridy = 1;
-		l.setConstraints(streetDefaultSuffixes, constr);
-		
-		label = new JLabel("Map zooms (specify zoom levels in binary map <= 4)"); 
-		panel.add(label);
-		constr = new GridBagConstraints();
-		constr.ipadx = 5;
-		constr.gridx = 0;
-		constr.gridy = 2;
-		constr.anchor = GridBagConstraints.WEST;
-		l.setConstraints(label, constr);
-		
-		mapZooms = new JTextField();
-		mapZooms.setText(DataExtractionSettings.getSettings().getMapZoomsValue());
-		panel.add(mapZooms);
-		constr = new GridBagConstraints();
-		constr.weightx = 1;
-		constr.fill = GridBagConstraints.HORIZONTAL;
-		constr.ipadx = 5;
-		constr.gridx = 1;
-		constr.gridy = 2;
-		l.setConstraints(mapZooms, constr);
-		
-		
-		label = new JLabel("Rendering types (xml config to extract osm data) file path"); 
-		panel.add(label);
-		constr = new GridBagConstraints();
-		constr.ipadx = 5;
-		constr.gridx = 0;
-		constr.gridy = 3;
-		constr.anchor = GridBagConstraints.WEST;
-		l.setConstraints(label, constr);
-		
-		renderingTypesFile = new JTextField();
-		renderingTypesFile.setText(DataExtractionSettings.getSettings().getMapRenderingTypesFile());
-		panel.add(renderingTypesFile);
-		constr = new GridBagConstraints();
-		constr.weightx = 1;
-		constr.fill = GridBagConstraints.HORIZONTAL;
-		constr.ipadx = 5;
-		constr.gridx = 1;
-		constr.gridy = 3;
-		l.setConstraints(renderingTypesFile, constr);
-		
-		panel.setMaximumSize(new Dimension(Short.MAX_VALUE, panel.getPreferredSize().height));
-	}
-
-	private void addListeners(){
-		okButton.addActionListener(new ActionListener(){
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				saveProperties();
-				setVisible(false);
-			}
-			
-		});
-		cancelButton.addActionListener(new ActionListener(){
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				setVisible(false);
-			}
-		});
-				
-	}
-	
-	
-	public void saveProperties(){
-		DataExtractionSettings settings = DataExtractionSettings.getSettings();
-		if(!settings.getSuffixesToNormalizeStreetsString().equals(streetSuffixes.getText())){
-			settings.setSuffixesToNormalizeStreets(streetSuffixes.getText());
-		}
-		if(!settings.getDefaultSuffixesToNormalizeStreetsString().equals(streetDefaultSuffixes.getText())){
-			settings.setDefaultSuffixesToNormalizeStreets(streetDefaultSuffixes.getText());
-		}
-		if(settings.useInternetToLoadImages() != useInternet.isSelected()){
-			settings.setUseInterentToLoadImages(useInternet.isSelected());
-		}
-		
-		if(!settings.getMapZoomsValue().equals(mapZooms.getText())){
-			settings.setMapZooms(mapZooms.getText());
-		}
-		if(!settings.getMapRenderingTypesFile().equals(renderingTypesFile.getText())){
-			settings.setMapRenderingTypesFile(renderingTypesFile.getText());
-		}
-		if(!settings.getDefaultRoutingFilePath().equals(pathToObfRoutingFile.getText())){
-			settings.setDefaultRoutingPath(pathToObfRoutingFile.getText());
-		}
-//		if(settings.isSupressWarningsForDuplicatedId() != supressWarning.isSelected()){
-//			settings.setSupressWarningsForDuplicatedId	(supressWarning.isSelected());
-//		}
-//		if(settings.getLoadEntityInfo() != loadWholeOsmInfo.isSelected()){
-//			settings.setLoadEntityInfo(loadWholeOsmInfo.isSelected());
-//		}
-		
-	}
-	
-
-
-}
-
+package net.osmand.swing;
+
+import java.awt.Component;
+import java.awt.Dimension;
+import java.awt.FlowLayout;
+import java.awt.GridBagConstraints;
+import java.awt.GridBagLayout;
+import java.awt.event.ActionEvent;
+import java.awt.event.ActionListener;
+
+import javax.swing.BorderFactory;
+import javax.swing.Box;
+import javax.swing.BoxLayout;
+import javax.swing.JButton;
+import javax.swing.JCheckBox;
+import javax.swing.JDialog;
+import javax.swing.JLabel;
+import javax.swing.JOptionPane;
+import javax.swing.JPanel;
+import javax.swing.JTextField;
+
+public class OsmExtractionPreferencesDialog extends JDialog {
+	
+	private static final long serialVersionUID = -4862884032977071296L;
+	
+	private JButton okButton;
+	private JButton cancelButton;
+
+	private JTextField streetSuffixes;
+	private JTextField streetDefaultSuffixes;
+	private JTextField mapZooms;
+	private JTextField cityAdminLevel;
+	private JTextField renderingTypesFile;
+	private JTextField pathToObfRoutingFile;
+
+	private JCheckBox useInternet;
+
+	
+//	private JCheckBox supressWarning;
+//	private JCheckBox loadWholeOsmInfo;
+
+	public OsmExtractionPreferencesDialog(Component parent){
+    	super(JOptionPane.getFrameForComponent(parent), true);
+    	setTitle(Messages.getString("OsmExtractionPreferencesDialog.PREFERENCES")); //$NON-NLS-1$
+        initDialog();
+        
+    }
+	
+	public void showDialog(){
+		setSize(600, 380);
+        double x = getParent().getBounds().getCenterX();
+        double y = getParent().getBounds().getCenterY();
+        setLocation((int) x - getWidth() / 2, (int) y - getHeight() / 2);
+        setVisible(true);
+	}
+	
+	private void initDialog() {
+		JPanel pane = new JPanel();
+		pane.setLayout(new BoxLayout(pane, BoxLayout.Y_AXIS));
+        pane.setBorder(BorderFactory.createEmptyBorder(10, 10, 5, 10));
+        add(pane);
+        
+        
+        createGeneralSection(pane);
+        createNormalizingStreetSection(pane);
+        pane.add(Box.createVerticalGlue());	
+        
+        FlowLayout l = new FlowLayout(FlowLayout.RIGHT);
+        JPanel buttonsPane = new JPanel(l);
+        okButton = new JButton(Messages.getString("OsmExtractionPreferencesDialog.OK")); //$NON-NLS-1$
+        buttonsPane.add(okButton);
+        cancelButton = new JButton(Messages.getString("OsmExtractionPreferencesDialog.CANCEL")); //$NON-NLS-1$
+        buttonsPane.add(cancelButton);
+        
+        buttonsPane.setMaximumSize(new Dimension(Short.MAX_VALUE, (int) l.preferredLayoutSize(buttonsPane).getHeight()));
+        pane.add(buttonsPane);
+        
+        addListeners();
+	}
+	
+	private void createGeneralSection(JPanel root) {
+		JPanel panel = new JPanel();
+//		panel.setLayout(new GridLayout(3, 1, 5, 5));
+		GridBagLayout l = new GridBagLayout();
+		panel.setLayout(l);
+		panel.setBorder(BorderFactory.createTitledBorder(Messages.getString("OsmExtractionPreferencesDialog.GENERAL"))); //$NON-NLS-1$
+		root.add(panel);
+		
+		useInternet = new JCheckBox();
+		useInternet.setText(Messages.getString("OsmExtractionPreferencesDialog.INTERNET.TO.DOWNLOAD.FILES")); //$NON-NLS-1$
+		useInternet.setSelected(DataExtractionSettings.getSettings().useInternetToLoadImages());
+		panel.add(useInternet);
+		GridBagConstraints constr = new GridBagConstraints();
+		constr.ipadx = 5;
+		constr.gridx = 0;
+		constr.gridy = 0;
+		constr.gridwidth = 2;
+		constr.anchor = GridBagConstraints.WEST;
+		l.setConstraints(useInternet, constr);
+		
+		JLabel label = new JLabel("Path to obf file (test routing purpose) : ");
+		panel.add(label);
+		constr = new GridBagConstraints();
+		constr.ipadx = 5;
+		constr.gridx = 0;
+		constr.gridy = 1;
+		constr.anchor = GridBagConstraints.WEST;
+		l.setConstraints(label, constr);
+		
+		pathToObfRoutingFile = new JTextField();
+		
+		pathToObfRoutingFile.setText(DataExtractionSettings.getSettings().getDefaultRoutingFilePath());
+		panel.add(pathToObfRoutingFile);
+		constr = new GridBagConstraints();
+		constr.weightx = 1;
+		constr.fill = GridBagConstraints.HORIZONTAL;
+		constr.ipadx = 5;
+		constr.gridx = 1;
+		constr.gridy = 1;
+		l.setConstraints(pathToObfRoutingFile, constr);
+		
+		
+		label = new JLabel("City admin level : ");
+        panel.add(label);
+        constr = new GridBagConstraints();
+        constr.ipadx = 6;
+        constr.gridx = 0;
+        constr.gridy = 1;
+        constr.anchor = GridBagConstraints.WEST;
+        l.setConstraints(label, constr);
+        
+        cityAdminLevel = new JTextField();
+        
+        cityAdminLevel.setText(DataExtractionSettings.getSettings().getCityAdminLevel());
+        panel.add(cityAdminLevel);
+        constr = new GridBagConstraints();
+        constr.weightx = 1;
+        constr.fill = GridBagConstraints.HORIZONTAL;
+        constr.ipadx = 6;
+        constr.gridx = 1;
+        constr.gridy = 1;
+        l.setConstraints(cityAdminLevel, constr);
+		
+//		supressWarning = new JCheckBox();
+//		supressWarning.setText(Messages.getString("OsmExtractionPreferencesDialog.DUPLICATED.ID")); //$NON-NLS-1$
+//		supressWarning.setSelected(DataExtractionSettings.getSettings().isSupressWarningsForDuplicatedId());
+//		panel.add(supressWarning);
+//		
+//		loadWholeOsmInfo = new JCheckBox();
+//		loadWholeOsmInfo.setText(Messages.getString("OsmExtractionPreferencesDialog.LOAD.WHOLE.OSM")); //$NON-NLS-1$
+//		loadWholeOsmInfo.setSelected(DataExtractionSettings.getSettings().getLoadEntityInfo());
+//		panel.add(loadWholeOsmInfo);
+		
+		panel.setMaximumSize(new Dimension(Short.MAX_VALUE, panel.getPreferredSize().height));
+		
+	}
+
+	private void createNormalizingStreetSection(JPanel root) {
+		JPanel panel = new JPanel();
+		GridBagLayout l = new GridBagLayout();
+		panel.setLayout(l);
+		panel.setBorder(BorderFactory.createTitledBorder("Map creation parameters"));
+		root.add(panel);
+
+		JLabel label = new JLabel(Messages.getString("OsmExtractionPreferencesDialog.NAME.SUFFIXES")); //$NON-NLS-1$
+		panel.add(label);
+		GridBagConstraints constr = new GridBagConstraints();
+		constr.anchor = GridBagConstraints.WEST;
+		constr.ipadx = 5;
+		constr.gridx = 0;
+		constr.gridy = 0;
+		l.setConstraints(label, constr);
+		
+		streetSuffixes = new JTextField();
+		streetSuffixes.setText(DataExtractionSettings.getSettings().getSuffixesToNormalizeStreetsString());
+		panel.add(streetSuffixes);
+		constr = new GridBagConstraints();
+		constr.fill = GridBagConstraints.HORIZONTAL;
+		constr.ipadx = 5;
+		constr.gridx = 1;
+		constr.gridy = 0;
+		l.setConstraints(streetSuffixes, constr);
+		
+		label = new JLabel(Messages.getString("OsmExtractionPreferencesDialog.DEFAULT.SUFFIXES")); //$NON-NLS-1$
+		panel.add(label);
+		constr = new GridBagConstraints();
+		constr.ipadx = 5;
+		constr.gridx = 0;
+		constr.gridy = 1;
+		constr.anchor = GridBagConstraints.WEST;
+		l.setConstraints(label, constr);
+		
+		streetDefaultSuffixes = new JTextField();
+		streetDefaultSuffixes.setText(DataExtractionSettings.getSettings().getDefaultSuffixesToNormalizeStreetsString());
+		panel.add(streetDefaultSuffixes);
+		constr = new GridBagConstraints();
+		constr.weightx = 1;
+		constr.fill = GridBagConstraints.HORIZONTAL;
+		constr.ipadx = 5;
+		constr.gridx = 1;
+		constr.gridy = 1;
+		l.setConstraints(streetDefaultSuffixes, constr);
+		
+		label = new JLabel("Map zooms (specify zoom levels in binary map <= 4)"); 
+		panel.add(label);
+		constr = new GridBagConstraints();
+		constr.ipadx = 5;
+		constr.gridx = 0;
+		constr.gridy = 2;
+		constr.anchor = GridBagConstraints.WEST;
+		l.setConstraints(label, constr);
+		
+		mapZooms = new JTextField();
+		mapZooms.setText(DataExtractionSettings.getSettings().getMapZoomsValue());
+		panel.add(mapZooms);
+		constr = new GridBagConstraints();
+		constr.weightx = 1;
+		constr.fill = GridBagConstraints.HORIZONTAL;
+		constr.ipadx = 5;
+		constr.gridx = 1;
+		constr.gridy = 2;
+		l.setConstraints(mapZooms, constr);
+		
+		
+		label = new JLabel("Rendering types (xml config to extract osm data) file path"); 
+		panel.add(label);
+		constr = new GridBagConstraints();
+		constr.ipadx = 5;
+		constr.gridx = 0;
+		constr.gridy = 3;
+		constr.anchor = GridBagConstraints.WEST;
+		l.setConstraints(label, constr);
+		
+		renderingTypesFile = new JTextField();
+		renderingTypesFile.setText(DataExtractionSettings.getSettings().getMapRenderingTypesFile());
+		panel.add(renderingTypesFile);
+		constr = new GridBagConstraints();
+		constr.weightx = 1;
+		constr.fill = GridBagConstraints.HORIZONTAL;
+		constr.ipadx = 5;
+		constr.gridx = 1;
+		constr.gridy = 3;
+		l.setConstraints(renderingTypesFile, constr);
+		
+		panel.setMaximumSize(new Dimension(Short.MAX_VALUE, panel.getPreferredSize().height));
+	}
+
+	private void addListeners(){
+		okButton.addActionListener(new ActionListener(){
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				saveProperties();
+				setVisible(false);
+			}
+			
+		});
+		cancelButton.addActionListener(new ActionListener(){
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				setVisible(false);
+			}
+		});
+				
+	}
+	
+	
+	public void saveProperties(){
+		DataExtractionSettings settings = DataExtractionSettings.getSettings();
+		if(!settings.getSuffixesToNormalizeStreetsString().equals(streetSuffixes.getText())){
+			settings.setSuffixesToNormalizeStreets(streetSuffixes.getText());
+		}
+		if(!settings.getDefaultSuffixesToNormalizeStreetsString().equals(streetDefaultSuffixes.getText())){
+			settings.setDefaultSuffixesToNormalizeStreets(streetDefaultSuffixes.getText());
+		}
+		if(settings.useInternetToLoadImages() != useInternet.isSelected()){
+			settings.setUseInterentToLoadImages(useInternet.isSelected());
+		}
+		
+		if(!settings.getMapZoomsValue().equals(mapZooms.getText())){
+			settings.setMapZooms(mapZooms.getText());
+		}
+		if(!settings.getMapRenderingTypesFile().equals(renderingTypesFile.getText())){
+			settings.setMapRenderingTypesFile(renderingTypesFile.getText());
+		}
+		if(!settings.getDefaultRoutingFilePath().equals(pathToObfRoutingFile.getText())){
+			settings.setDefaultRoutingPath(pathToObfRoutingFile.getText());
+		}
+		if(!settings.getCityAdminLevel().equals(cityAdminLevel.getText())){
+            settings.setCityAdminLevel(cityAdminLevel.getText());
+        }
+//		if(settings.isSupressWarningsForDuplicatedId() != supressWarning.isSelected()){
+//			settings.setSupressWarningsForDuplicatedId	(supressWarning.isSelected());
+//		}
+//		if(settings.getLoadEntityInfo() != loadWholeOsmInfo.isSelected()){
+//			settings.setLoadEntityInfo(loadWholeOsmInfo.isSelected());
+//		}
+		
+	}
+	
+
+
+}
+
diff --git a/DataExtractionOSM/src/net/osmand/swing/OsmExtractionUI.java b/DataExtractionOSM/src/net/osmand/swing/OsmExtractionUI.java
index 5add3337efe..3592c5ec0a1 100644
--- a/DataExtractionOSM/src/net/osmand/swing/OsmExtractionUI.java
+++ b/DataExtractionOSM/src/net/osmand/swing/OsmExtractionUI.java
@@ -1,888 +1,889 @@
-package net.osmand.swing;
-
-import java.awt.BorderLayout;
-import java.awt.Container;
-import java.awt.FlowLayout;
-import java.awt.event.ActionEvent;
-import java.awt.event.ActionListener;
-import java.awt.event.WindowAdapter;
-import java.awt.event.WindowEvent;
-import java.io.File;
-import java.io.FileOutputStream;
-import java.io.IOException;
-import java.io.OutputStream;
-import java.lang.Thread.UncaughtExceptionHandler;
-import java.lang.reflect.InvocationTargetException;
-import java.sql.SQLException;
-import java.text.MessageFormat;
-
-import javax.swing.AbstractAction;
-import javax.swing.JCheckBox;
-import javax.swing.JDialog;
-import javax.swing.JFileChooser;
-import javax.swing.JFrame;
-import javax.swing.JLabel;
-import javax.swing.JMenu;
-import javax.swing.JMenuBar;
-import javax.swing.JMenuItem;
-import javax.swing.JOptionPane;
-import javax.swing.JPanel;
-import javax.swing.JScrollPane;
-import javax.swing.JSplitPane;
-import javax.swing.JTree;
-import javax.swing.UIManager;
-import javax.swing.filechooser.FileFilter;
-import javax.swing.tree.DefaultMutableTreeNode;
-import javax.swing.tree.DefaultTreeModel;
-import javax.xml.stream.XMLStreamException;
-
-import net.osmand.ExceptionHandler;
-import net.osmand.Version;
-import net.osmand.data.preparation.IndexCreator;
-import net.osmand.map.IMapLocationListener;
-import net.osmand.map.ITileSource;
-import net.osmand.osm.MapRenderingTypes;
-import net.osmand.osm.io.IOsmStorageFilter;
-import net.osmand.osm.io.OsmBaseStorage;
-import net.osmand.osm.io.OsmBoundsFilter;
-import net.osmand.osm.io.OsmStorageWriter;
-import net.osmand.swing.MapPanel.MapSelectionArea;
-
-import org.apache.commons.logging.Log;
-import org.apache.commons.logging.LogFactory;
-import org.apache.tools.bzip2.CBZip2OutputStream;
-import org.xml.sax.SAXException;
-
-import rtree.RTree;
-
-
-public class OsmExtractionUI implements IMapLocationListener {
-
-	private static final Log log = LogFactory.getLog(OsmExtractionUI.class);
-	public static final String LOG_PATH  = getUserLogDirectoryPath() + "/Osmand/osmand.log"; //$NON-NLS-1$ //$NON-NLS-2$
-	public static OsmExtractionUI MAIN_APP;
-
-	public static String getUserLogDirectoryPath() {
-		String path = null;
-		if (System.getProperty("os.name").startsWith("Windows")) {
-			path = System.getenv("APPDATA").replaceAll("\\\\", "/");
-		} else if (System.getProperty("os.name").startsWith("Mac")) {
-			path = System.getProperty("user.home") + "/Library/Logs";
-		} else if (System.getenv("XDG_CACHE_HOME") != null) {
-			path = System.getenv("XDG_CACHE_HOME");
-		} else {
-			path = System.getProperty("user.home") + "/.cache";
-		}
-		return path;
-	}
-	
-	public static void main(String[] args) {
-		// first of all config log
-		new File(LOG_PATH).getParentFile().mkdirs();
-		final UncaughtExceptionHandler defaultHandler = Thread.getDefaultUncaughtExceptionHandler();
-		Thread.setDefaultUncaughtExceptionHandler(new UncaughtExceptionHandler(){
-			@Override
-			public void uncaughtException(Thread t, Throwable e) {
-				if(!(e instanceof ThreadDeath)){
-					ExceptionHandler.handle("Error in thread " + t.getName(), e); //$NON-NLS-1$
-				}
-				defaultHandler.uncaughtException(t, e);
-			}
-		});
-		
-        MAIN_APP = new OsmExtractionUI();
-        MAIN_APP.frame.setBounds(DataExtractionSettings.getSettings().getWindowBounds());
-        MAIN_APP.frame.setVisible(true);
-	}
-	
-	
-	
-	
-	private JTree treePlaces;
-//	private DataExtractionTreeNode amenitiesTree;
-//	private TreeModelListener treeModelListener;
-	
-	
-	private MapPanel mapPanel;
-	private JFrame frame;
-	private JLabel statusBarLabel;
-	
-
-	private JCheckBox buildPoiIndex;
-	private JCheckBox buildAddressIndex;
-	private JCheckBox buildMapIndex;
-	private JCheckBox buildTransportIndex;
-	private JCheckBox normalizingStreets;
-
-	private String regionName;
-		
-	
-	
-	public OsmExtractionUI(){
-		createUI();
-	}
-
-	
-        
-	
-	
-	public void createUI(){
-		frame = new JFrame(Messages.getString("OsmExtractionUI.OSMAND_MAP_CREATOR")); //$NON-NLS-1$
-	    try {
-			UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
-		} catch (Exception e) {
-			log.error("Can't set look and feel", e); //$NON-NLS-1$
-		}
-		
-		
-	    frame.addWindowListener(new ExitListener());
-	    Container content = frame.getContentPane();
-	    frame.setFocusable(true);
-	    
-	    mapPanel = new MapPanel(DataExtractionSettings.getSettings().getTilesDirectory());
-	    mapPanel.setFocusable(true);
-	    mapPanel.addMapLocationListener(this);
-	    
-	    statusBarLabel = new JLabel();
-	    content.add(statusBarLabel, BorderLayout.SOUTH);
-	    File workingDir = DataExtractionSettings.getSettings().getDefaultWorkingDir();
-	    statusBarLabel.setText(workingDir == null ? Messages.getString("OsmExtractionUI.WORKING_DIR_UNSPECIFIED") : Messages.getString("OsmExtractionUI.WORKING_DIRECTORY") + workingDir.getAbsolutePath()); //$NON-NLS-1$ //$NON-NLS-2$
-	    
-	   
-	    treePlaces = new JTree();
-		treePlaces.setModel(new DefaultTreeModel(new DefaultMutableTreeNode(Messages.getString("OsmExtractionUI.REGION")), false)); 	     //$NON-NLS-1$
-	    JSplitPane panelForTreeAndMap = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, new JScrollPane(treePlaces), mapPanel);
-	    panelForTreeAndMap.setResizeWeight(0.2);
-	    content.add(panelForTreeAndMap, BorderLayout.CENTER);
-	    
-	    createButtonsBar(content);
-	   
-	    JMenuBar bar = new JMenuBar();
-	    fillMenuWithActions(bar);
-
-	    frame.setJMenuBar(bar);
-	}
-	
-	
-	
-	
-	public void createButtonsBar(Container content){
-		JPanel panel = new JPanel(new FlowLayout(FlowLayout.LEFT));
-		content.add(panel, BorderLayout.NORTH);
-		
-		buildMapIndex = new JCheckBox();
-		buildMapIndex.setText(Messages.getString("OsmExtractionUI.BUILD_MAP")); //$NON-NLS-1$
-		panel.add(buildMapIndex);
-		buildMapIndex.setSelected(true);
-		
-		buildPoiIndex = new JCheckBox();
-		buildPoiIndex.setText(Messages.getString("OsmExtractionUI.BUILD_POI")); //$NON-NLS-1$
-		panel.add(buildPoiIndex);
-		buildPoiIndex.setSelected(true);
-		
-		buildAddressIndex = new JCheckBox();
-		buildAddressIndex.setText(Messages.getString("OsmExtractionUI.BUILD_ADDRESS")); //$NON-NLS-1$
-		panel.add(buildAddressIndex);
-		buildAddressIndex.setSelected(true);
-		
-		normalizingStreets = new JCheckBox();
-		normalizingStreets.setText(Messages.getString("OsmExtractionUI.NORMALIZE_STREETS")); //$NON-NLS-1$
-		panel.add(normalizingStreets);
-		normalizingStreets.setSelected(true);
-		
-		buildTransportIndex = new JCheckBox();
-		buildTransportIndex.setText(Messages.getString("OsmExtractionUI.BUILD_TRANSPORT")); //$NON-NLS-1$
-		panel.add(buildTransportIndex);
-		buildTransportIndex.setSelected(true);
-
-		
-		
-	}
-	
-	public void fillMenuWithActions(final JMenuBar bar){
-		JMenu menu = new JMenu(Messages.getString("OsmExtractionUI.MENU_FILE")); //$NON-NLS-1$
-		bar.add(menu);
-		JMenuItem loadFile = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_SELECT_FILE")); //$NON-NLS-1$
-		menu.add(loadFile);
-		JMenuItem loadSpecifiedAreaFile = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_SELECT_OSM_FILE_AREA")); //$NON-NLS-1$
-		menu.add(loadSpecifiedAreaFile);
-		JMenuItem specifyWorkingDir = new JMenuItem(Messages.getString("OsmExtractionUI.SPECIFY_WORKING_DIR")); //$NON-NLS-1$
-		menu.add(specifyWorkingDir);
-		menu.addSeparator();
-		JMenuItem exitMenu= new JMenuItem(Messages.getString("OsmExtractionUI.MENU_EXIT")); //$NON-NLS-1$
-		menu.add(exitMenu);
-		
-		JMenu tileSource = MapPanel.getMenuToChooseSource(mapPanel);
-		final JMenuItem sqliteDB = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_CREATE_SQLITE")); //$NON-NLS-1$
-		tileSource.addSeparator();
-		tileSource.add(sqliteDB);
-		bar.add(tileSource);
-		
-		menu = new JMenu(Messages.getString("OsmExtractionUI.MENU_WINDOW")); //$NON-NLS-1$
-		bar.add(menu);
-		JMenuItem settings = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_SETTINGS")); //$NON-NLS-1$
-		menu.add(settings);
-		menu.addSeparator();
-		JMenuItem openLogFile = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_OPEN_LOG")); //$NON-NLS-1$
-		menu.add(openLogFile);
-		
-		menu = new JMenu(Messages.getString("OsmExtractionUI.MENU_ABOUT")); //$NON-NLS-1$
-		bar.add(menu);
-		JMenuItem aboutApplication = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_ABOUT_2")); //$NON-NLS-1$
-		menu.add(aboutApplication);
-		
-		
-		aboutApplication.addActionListener(new ActionListener() {
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				JOptionPane.showMessageDialog(frame, Version.APP_MAP_CREATOR_FULL_NAME);
-			}
-		});
-
-		openLogFile.addActionListener(new ActionListener() {
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				File file = new File(OsmExtractionUI.LOG_PATH);
-				if (file != null && file.exists()) {
-					if (System.getProperty("os.name").startsWith("Windows")) { //$NON-NLS-1$ //$NON-NLS-2$
-						try {
-							Runtime.getRuntime().exec(new String[] { "notepad.exe", file.getAbsolutePath() }); //$NON-NLS-1$
-						} catch (IOException es) {
-							ExceptionHandler.handle(Messages.getString("OsmExtractionUI.UNABLE_OPEN_FILE"), es); //$NON-NLS-1$
-						}
-					} else {
-						JOptionPane.showMessageDialog(frame, Messages.getString("OsmExtractionUI.OPEN_LOG_FILE_MANUALLY") + LOG_PATH); //$NON-NLS-1$
-					}
-
-				} else {
-					ExceptionHandler.handle(Messages.getString("OsmExtractionUI.LOG_FILE_NOT_FOUND")); //$NON-NLS-1$
-				}
-			}
-		});
-		
-		sqliteDB.addActionListener(new ActionListener(){
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				final String regionName = OsmExtractionUI.this.regionName == null ? Messages.getString("OsmExtractionUI.REGION") : OsmExtractionUI.this.regionName; //$NON-NLS-1$
-				final ITileSource map = mapPanel.getMap();
-				if(map != null){
-					try {
-			    		final ProgressDialog dlg = new ProgressDialog(frame, Messages.getString("OsmExtractionUI.CREATING_INDEX")); //$NON-NLS-1$
-			    		dlg.setRunnable(new Runnable(){
-
-							@Override
-							public void run() {
-								try {
-									SQLiteBigPlanetIndex.createSQLiteDatabase(DataExtractionSettings.getSettings().getTilesDirectory(), regionName, map);
-								} catch (SQLException e1) {
-									throw new IllegalArgumentException(e1);
-								} catch (IOException e1) {
-									throw new IllegalArgumentException(e1);
-								}
-							}
-			    		});
-			    		dlg.run();
-					} catch (InterruptedException e1) {
-						log.error("Interrupted", e1);  //$NON-NLS-1$
-					} catch (InvocationTargetException e1) {
-						ExceptionHandler.handle("Can't create big planet sqlite index", (Exception) e1.getCause()); //$NON-NLS-1$
-					}
-					
-					
-				}
-			}
-		});
-
-		
-		exitMenu.addActionListener(new ActionListener(){
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				frame.setVisible(false);
-				exit();
-			}
-		});
-		settings.addActionListener(new ActionListener(){
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				OsmExtractionPreferencesDialog dlg = new OsmExtractionPreferencesDialog(frame);
-				dlg.showDialog();
-			}
-			
-		});
-		specifyWorkingDir.addActionListener(new ActionListener(){
-
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				JFileChooser fc = new JFileChooser();
-		        fc.setDialogTitle(Messages.getString("OsmExtractionUI.CHOOSE_WORKING_DIR")); //$NON-NLS-1$
-		        fc.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
-		        File workingDir = DataExtractionSettings.getSettings().getDefaultWorkingDir();
-		        if(workingDir != null){
-		        	fc.setCurrentDirectory(workingDir);
-		        }
-		        if(fc.showOpenDialog(frame) == JFileChooser.APPROVE_OPTION && fc.getSelectedFile() != null && 
-		        		fc.getSelectedFile().isDirectory()){
-		        	DataExtractionSettings.getSettings().saveDefaultWorkingDir(fc.getSelectedFile());
-		        	mapPanel.setTilesLocation(DataExtractionSettings.getSettings().getTilesDirectory());
-		        	statusBarLabel.setText(Messages.getString("OsmExtractionUI.WORKING_DIR") + fc.getSelectedFile().getAbsolutePath()); //$NON-NLS-1$
-		        	JMenu tileSource = MapPanel.getMenuToChooseSource(mapPanel);
-		    		tileSource.add(sqliteDB);
-		    		bar.remove(1);
-		    		bar.add(tileSource, 1);
-		        }
-			}
-			
-		});
-		loadSpecifiedAreaFile.addActionListener(new ActionListener(){
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				JFileChooser fc = getOsmFileChooser();
-		        int answer = fc.showOpenDialog(frame) ;
-		        if (answer == JFileChooser.APPROVE_OPTION && fc.getSelectedFile() != null){
-		        	final JDialog dlg = new JDialog(frame, true);
-		        	dlg.setTitle(Messages.getString("OsmExtractionUI.SELECT_AREA_TO_FILTER")); //$NON-NLS-1$
-		        	MapPanel panel = new MapPanel(DataExtractionSettings.getSettings().getTilesDirectory());
-		        	panel.setLatLon(mapPanel.getLatitude(), mapPanel.getLongitude());
-		        	panel.setZoom(mapPanel.getZoom());
-		        	final StringBuilder res = new StringBuilder();
-		        	panel.getLayer(MapInformationLayer.class).setAreaActionHandler(new AbstractAction(Messages.getString("OsmExtractionUI.SELECT_AREA")){ //$NON-NLS-1$
-						private static final long serialVersionUID = -3452957517341961969L;
-						@Override
-						public void actionPerformed(ActionEvent e) {
-							res.append(true);
-							dlg.setVisible(false);
-						}
-		        		
-		        	});
-		        	dlg.add(panel);
-		        	
-		        	
-		        	JMenuBar bar = new JMenuBar();
-		    	    bar.add(MapPanel.getMenuToChooseSource(panel));
-		    	    dlg.setJMenuBar(bar);
-		    	    dlg.setSize(512, 512);
-		    	    double x = frame.getBounds().getCenterX();
-		    	    double y = frame.getBounds().getCenterY();
-		    	    dlg.setLocation((int) x - dlg.getWidth() / 2, (int) y - dlg.getHeight() / 2);
-		        	
-		    	    dlg.setVisible(true);
-		    		if(res.length() > 0 && panel.getSelectionArea().isVisible()){
-		    			MapSelectionArea area = panel.getSelectionArea();
-		    			IOsmStorageFilter filter = new OsmBoundsFilter(area.getLat1(), area.getLon1(), area.getLat2(), area.getLon2());
-		    			loadCountry(fc.getSelectedFile(), filter);
-		    		}
-		        }
-			}
-			
-		});
-		loadFile.addActionListener(new ActionListener(){
-
-			@Override
-			public void actionPerformed(ActionEvent e) {
-				JFileChooser fc = getOsmFileChooser();
-		        int answer = fc.showOpenDialog(frame) ;
-		        if (answer == JFileChooser.APPROVE_OPTION && fc.getSelectedFile() != null){
-		        	loadCountry(fc.getSelectedFile(), null);
-		        }
-			}
-			
-		});
-
-	}
-	
-	public JFileChooser getOsmFileChooser(){
-		JFileChooser fc = new JFileChooser();
-        fc.setDialogTitle(Messages.getString("OsmExtractionUI.CHOOSE_OSM_FILE")); //$NON-NLS-1$
-        fc.setFileSelectionMode(JFileChooser.FILES_ONLY);
-        fc.setAcceptAllFileFilterUsed(true);
-        fc.setCurrentDirectory(DataExtractionSettings.getSettings().getDefaultWorkingDir().getParentFile());
-        fc.setFileFilter(new FileFilter(){
-
-			@Override
-			public boolean accept(File f) {
-				return f.isDirectory() || f.getName().endsWith(".bz2") || f.getName().endsWith(".osm") || f.getName().endsWith(".pbf"); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
-			}
-
-			@Override
-			public String getDescription() {
-				return Messages.getString("OsmExtractionUI.OSM_FILES"); //$NON-NLS-1$
-			}
-        });
-        return fc;
-	}
-	
-	public JFrame getFrame() {
-		return frame;
-	}
-	
-	public void loadCountry(final File f, final IOsmStorageFilter filter){
-		try {
-    		final ProgressDialog dlg = new ProgressDialog(frame, Messages.getString("OsmExtractionUI.LOADING_OSM_FILE")); //$NON-NLS-1$
-    		dlg.setRunnable(new Runnable(){
-
-				@Override
-				public void run() {
-					File dir = DataExtractionSettings.getSettings().getDefaultWorkingDir();
-					IndexCreator creator = new IndexCreator(dir);
-					try {
-						creator.setIndexAddress(buildAddressIndex.isSelected());
-						creator.setIndexPOI(buildPoiIndex.isSelected());
-						creator.setNormalizeStreets(normalizingStreets.isSelected());
-						creator.setIndexTransport(buildTransportIndex.isSelected());
-						creator.setIndexMap(buildMapIndex.isSelected());
-						String fn = DataExtractionSettings.getSettings().getMapRenderingTypesFile();
-						MapRenderingTypes types;
-						if(fn == null || fn.length() == 0){
-							types = MapRenderingTypes.getDefault();
-						} else {
-							types = new MapRenderingTypes(fn);
-						}
-						RTree.clearCache();
-						creator.generateIndexes(f, dlg, filter, DataExtractionSettings.getSettings().getMapZooms(), types);
-					} catch (IOException e) {
-						throw new IllegalArgumentException(e);
-					} catch (SAXException e) {
-						throw new IllegalStateException(e);
-					} catch (SQLException e) {
-						throw new IllegalStateException(e);
-					}
-					regionName = creator.getRegionName();
-					StringBuilder msg = new StringBuilder();
-					msg.append(Messages.getString("OsmExtractionUI.INDEXES_FOR")).append(regionName).append(" : "); //$NON-NLS-1$ //$NON-NLS-2$
-					boolean comma = false;
-					if (buildMapIndex.isSelected()) {
-						if(comma) msg.append(", "); //$NON-NLS-1$
-						comma = true;
-						msg.append(Messages.getString("OsmExtractionUI.MAP")); //$NON-NLS-1$
-					}
-					if (buildPoiIndex.isSelected()) {
-						if(comma) msg.append(", "); //$NON-NLS-1$
-						comma = true;
-						msg.append(Messages.getString("OsmExtractionUI.POI")); //$NON-NLS-1$
-					}
-					if (buildAddressIndex.isSelected()) {
-						if(comma) msg.append(", "); //$NON-NLS-1$
-						comma = true;
-						msg.append(Messages.getString("OsmExtractionUI.ADDRESS")); //$NON-NLS-1$
-					}
-					if (buildTransportIndex.isSelected()) {
-						if(comma) msg.append(", "); //$NON-NLS-1$
-						comma = true;
-						msg.append(Messages.getString("OsmExtractionUI.TRANSPORT")); //$NON-NLS-1$
-					}
-					msg.append(MessageFormat.format(Messages.getString("OsmExtractionUI.WERE_SUCCESFULLY_CREATED"), dir.getAbsolutePath())); //$NON-NLS-1$
-					JOptionPane pane = new JOptionPane(msg);
-					JDialog dialog = pane.createDialog(frame, Messages.getString("OsmExtractionUI.GENERATION_DATA")); //$NON-NLS-1$
-					dialog.setVisible(true);
-				}
-    		});
-    		
-			dlg.run();
-			frame.setTitle(Messages.getString("OsmExtractionUI.OSMAND_MAP_CREATOR_FILE") + f.getName()); //$NON-NLS-1$
-		} catch (InterruptedException e1) {
-			log.error("Interrupted", e1);  //$NON-NLS-1$
-		} catch (InvocationTargetException e1) {
-			ExceptionHandler.handle("Exception during operation", e1.getCause()); //$NON-NLS-1$
-		}
-	}
-	
-	public void saveCountry(final File f, final OsmBaseStorage storage){
-		final OsmStorageWriter writer = new OsmStorageWriter();
-		try {
-    		final ProgressDialog dlg = new ProgressDialog(frame, Messages.getString("OsmExtractionUI.SAVING_OSM_FILE")); //$NON-NLS-1$
-    		dlg.setRunnable(new Runnable() {
-				@Override
-				public void run() {
-					try {
-						OutputStream output = new FileOutputStream(f);
-						try {
-							if (f.getName().endsWith(".bz2")) { //$NON-NLS-1$
-								output.write('B');
-								output.write('Z');
-								output = new CBZip2OutputStream(output);
-							}
-							writer.saveStorage(output, storage, null, false);
-						} finally {
-							output.close();
-						}
-					} catch (IOException e) {
-						throw new IllegalArgumentException(e);
-					} catch (XMLStreamException e) {
-						throw new IllegalArgumentException(e);
-					}
-				}
-			});
-    		dlg.run();
-		} catch (InterruptedException e1) {
-			log.error("Interrupted", e1);  //$NON-NLS-1$
-		} catch (InvocationTargetException e1) {
-			ExceptionHandler.handle("Log file is not found", e1.getCause()); //$NON-NLS-1$
-		}
-	}
-	
-	@Override
-	public void locationChanged(final double newLatitude, final double newLongitude, Object source){
-//		recalculateAmenities(newLatitude, newLongitude);
-	}
-
-
-
-	
-	public class ExitListener extends WindowAdapter {
-		public void windowClosing(WindowEvent event) {
-			exit();
-		}
-	}
-	
-	public void exit(){
-		// save preferences
-		DataExtractionSettings settings = DataExtractionSettings.getSettings();
-		settings.saveDefaultLocation(mapPanel.getLatitude(), mapPanel.getLongitude());
-		settings.saveDefaultZoom(mapPanel.getZoom());
-		settings.saveWindowBounds(frame.getBounds());
-		System.exit(0);
-	}
-	
-
-
-	
-	
-	// OLD CODE
-/*
-
-	public JTree createTree(Container content) {		
-		treePlaces.setEditable(true);
-		treePlaces.setCellEditor(new RegionCellEditor(treePlaces, (DefaultTreeCellRenderer) treePlaces.getCellRenderer()));
-		treePlaces.addTreeSelectionListener(new TreeSelectionListener() {
-			@Override
-			public void valueChanged(TreeSelectionEvent e) {
-				if (e.getPath() != null) {
-					if (e.getPath().getLastPathComponent() instanceof DataExtractionTreeNode) {
-						Object o = ((DataExtractionTreeNode) e.getPath().getLastPathComponent()).getModelObject();
-
-						if (o instanceof MapObject) {
-							MapObject c = (MapObject) o;
-							LatLon location = c.getLocation();
-							if (location != null) {
-								if (o instanceof Street) {
-									DataTileManager<Way> ways = new DataTileManager<Way>();
-									for (Way w : ((Street) o).getWayNodes()) {
-										LatLon l = w.getLatLon();
-										ways.registerObject(l.getLatitude(), l.getLongitude(), w);
-									}
-									mapPanel.setPoints(ways);
-									mapPanel.requestFocus();
-								}
-								mapPanel.setLatLon(location.getLatitude(), location.getLongitude());
-								mapPanel.requestFocus();
-							}
-							if (o instanceof TransportRoute) {
-								DataTileManager<Entity> ways = new DataTileManager<Entity>();
-								for (Way w : ((TransportRoute) o).getWays()) {
-									LatLon l = w.getLatLon();
-									ways.registerObject(l.getLatitude(), l.getLongitude(), w);
-								}
-								for (TransportStop w : ((TransportRoute) o).getBackwardStops()) {
-									LatLon l = w.getLocation();
-									ways.registerObject(l.getLatitude(), l.getLongitude(), new Node(l.getLatitude(), l.getLongitude(), w
-											.getId()));
-								}
-								for (TransportStop w : ((TransportRoute) o).getForwardStops()) {
-									LatLon l = w.getLocation();
-									ways.registerObject(l.getLatitude(), l.getLongitude(), new Node(l.getLatitude(), l.getLongitude(), w
-											.getId()));
-								}
-								mapPanel.setPoints(ways);
-								mapPanel.requestFocus();
-							}
-
-						} else if (o instanceof Entity) {
-							Entity c = (Entity) o;
-							LatLon latLon = c.getLatLon();
-							if (latLon != null) {
-								mapPanel.setLatLon(latLon.getLatitude(), latLon.getLongitude());
-								mapPanel.requestFocus();
-							}
-						}
-					}
-				}
-
-			}
-		});
-
-		treeModelListener = new TreeModelListener() {
-			public void treeNodesChanged(TreeModelEvent e) {
-				Object node = e.getTreePath().getLastPathComponent();
-				if (e.getChildren() != null && e.getChildren().length > 0) {
-					node = e.getChildren()[0];
-				}
-				if (node instanceof DataExtractionTreeNode) {
-					DataExtractionTreeNode n = ((DataExtractionTreeNode) node);
-					if (n.getModelObject() instanceof MapObject) {
-						MapObject r = (MapObject) n.getModelObject();
-						String newName = n.getUserObject().toString();
-						if (!r.getName().equals(newName)) {
-							r.setName(n.getUserObject().toString());
-						}
-						if (r instanceof Street && !((Street) r).isRegisteredInCity()) {
-							DefaultMutableTreeNode parent = ((DefaultMutableTreeNode) n.getParent());
-							parent.remove(n);
-							((DefaultTreeModel) treePlaces.getModel()).nodeStructureChanged(parent);
-						}
-					}
-				}
-			}
-
-			public void treeNodesInserted(TreeModelEvent e) {
-			}
-
-			public void treeNodesRemoved(TreeModelEvent e) {
-			}
-
-			public void treeStructureChanged(TreeModelEvent e) {
-			}
-		};
-		treePlaces.getModel().addTreeModelListener(treeModelListener);
-		return treePlaces;
-	}
-
-	public void fillPopupMenuWithActions(JPopupMenu menu) {
-		Action delete = new AbstractAction("Delete") {
-			private static final long serialVersionUID = 7476603434847164396L;
-
-			public void actionPerformed(ActionEvent e) {
-				TreePath[] p = treePlaces.getSelectionPaths();
-				if(p != null && 
-						JOptionPane.OK_OPTION == 
-							JOptionPane.showConfirmDialog(frame, "Are you sure about deleting " +p.length + " resources ? ")){
-				for(TreePath path : treePlaces.getSelectionPaths()){
-					Object node = path.getLastPathComponent();
-					if (node instanceof DataExtractionTreeNode) {
-						DataExtractionTreeNode n = ((DataExtractionTreeNode) node);
-						if(n.getParent() instanceof DataExtractionTreeNode){
-							DataExtractionTreeNode parent = ((DataExtractionTreeNode) n.getParent());
-							boolean remove = false;
-							if (n.getModelObject() instanceof Street) {
-								((City)parent.getModelObject()).unregisterStreet(((Street)n.getModelObject()).getName());
-								remove = true;
-							} else if (n.getModelObject() instanceof Building) {
-								((Street)parent.getModelObject()).getBuildings().remove(n.getModelObject());
-								remove = true;
-							} else if (n.getModelObject() instanceof City) {
-								Region r = (Region) ((DataExtractionTreeNode)parent.getParent()).getModelObject();
-								r.unregisterCity((City) n.getModelObject());
-								remove = true;
-							} else if (n.getModelObject() instanceof Amenity) {
-								Region r = (Region) ((DataExtractionTreeNode)parent.getParent().getParent()).getModelObject();
-								Amenity am = (Amenity) n.getModelObject();
-								r.getAmenityManager().unregisterObject(am.getLocation().getLatitude(), am.getLocation().getLongitude(), am);
-								remove = true;
-							}
-							if(remove){
-								parent.remove(n);
-								((DefaultTreeModel) treePlaces.getModel()).nodeStructureChanged(parent);
-							}
-						}
-					}
-				}
-				
-				}
-			}
-		};
-		menu.add(delete);
-		Action rename= new AbstractAction("Rename") {
-			private static final long serialVersionUID = -8257594433235073767L;
-
-			public void actionPerformed(ActionEvent e) {
-				TreePath path = treePlaces.getSelectionPath();
-				if(path != null){
-					treePlaces.startEditingAtPath(path);
-				}
-			}
-		};
-		menu.add(rename);
-	}
-	
-	
-	public void setRegion(Region region, String name){
-		if (this.region == region) {
-			return;
-		}
-		this.region = region;
-		DefaultMutableTreeNode root = new DataExtractionTreeNode(name, region);
-		if (region != null) {
-			amenitiesTree = new DataExtractionTreeNode("Amenities", region);
-			amenitiesTree.add(new DataExtractionTreeNode("First 15", region));
-			for (AmenityType type : AmenityType.values()) {
-				amenitiesTree.add(new DataExtractionTreeNode(Algoritms.capitalizeFirstLetterAndLowercase(type.toString()), type));
-			}
-			root.add(amenitiesTree);
-			
-			DataExtractionTreeNode transport = new DataExtractionTreeNode("Transport", region);
-			root.add(transport);
-			for(String s : region.getTransportRoutes().keySet()){
-				DataExtractionTreeNode trRoute = new DataExtractionTreeNode(s, s);
-				transport.add(trRoute);
-				List<TransportRoute> list = region.getTransportRoutes().get(s);
-				for(TransportRoute r : list){
-					DataExtractionTreeNode route = new DataExtractionTreeNode(r.getRef(), r);
-					trRoute.add(route);
-				}
-				
-			}
-
-			for (CityType t : CityType.values()) {
-				DefaultMutableTreeNode cityTree = new DataExtractionTreeNode(Algoritms.capitalizeFirstLetterAndLowercase(t.toString()), t);
-				root.add(cityTree);
-				for (City ct : region.getCitiesByType(t)) {
-					DefaultMutableTreeNode cityNodeTree = new DataExtractionTreeNode(ct.getName(), ct);
-					cityTree.add(cityNodeTree);
-
-					for (Street str : ct.getStreets()) {
-						DefaultMutableTreeNode strTree = new DataExtractionTreeNode(str.getName(), str);
-						cityNodeTree.add(strTree);
-						for (Building b : str.getBuildings()) {
-							DefaultMutableTreeNode building = new DataExtractionTreeNode(b.getName(), b);
-							strTree.add(building);
-						}
-					}
-				}
-			}
-		}
-		
-	    if (searchList != null) {
-			updateListCities(region, searchTextField.getText(), searchList);
-		}
-		mapPanel.repaint();
-		DefaultTreeModel newModel = new DefaultTreeModel(root, false);
-		newModel.addTreeModelListener(treeModelListener);
-		treePlaces.setModel(newModel);
-		
-		updateButtonsBar();
-		locationChanged(mapPanel.getLatitude(), mapPanel.getLongitude(), this);
-	}
-	
-	public static class DataExtractionTreeNode extends DefaultMutableTreeNode {
-		private static final long serialVersionUID = 1L;
-		private final Object modelObject;
-
-		public DataExtractionTreeNode(String name, Object modelObject){
-			super(name);
-			this.modelObject = modelObject;
-		}
-		
-		public Object getModelObject(){
-			return modelObject;
-		}
-		
-	}
-	
-	private void recalculateAmenities(final double newLatitude, final double newLongitude) {
-		if (amenitiesTree != null) {
-			Region reg = (Region) amenitiesTree.getModelObject();
-			List<Amenity> closestAmenities = reg.getAmenityManager().getClosestObjects(newLatitude, newLongitude, 0, 5);
-			MapUtils.sortListOfMapObject(closestAmenities, newLatitude, newLongitude);
-			
-
-			Map<AmenityType, List<Amenity>> filter = new HashMap<AmenityType, List<Amenity>>();
-			for (Amenity n : closestAmenities) {
-				AmenityType type = n.getType();
-				if (!filter.containsKey(type)) {
-					filter.put(type, new ArrayList<Amenity>());
-				}
-				filter.get(type).add(n);
-			}
-			
-			
-			for (int i = 1; i < amenitiesTree.getChildCount(); i++) {
-				AmenityType type = (AmenityType) ((DataExtractionTreeNode) amenitiesTree.getChildAt(i)).getModelObject();
-				((DefaultMutableTreeNode) amenitiesTree.getChildAt(i)).removeAllChildren();
-				if (filter.get(type) != null) {
-					for (Amenity n : filter.get(type)) {
-						int dist = (int) (MapUtils.getDistance(n.getLocation(), newLatitude, newLongitude));
-						String str = n.getStringWithoutType(false) + " [" + dist + " m ]";
-						DataExtractionTreeNode node = new DataExtractionTreeNode(str, n);
-						((DefaultMutableTreeNode) amenitiesTree.getChildAt(i)).add(node);
-					}
-				}
-				((DefaultTreeModel)treePlaces.getModel()).nodeStructureChanged(amenitiesTree.getChildAt(i));
-			}
-			((DefaultMutableTreeNode) amenitiesTree.getChildAt(0)).removeAllChildren();
-
-			for (int i = 0; i < 15 && i < closestAmenities.size(); i++) {
-				Amenity n = closestAmenities.get(i);
-				int dist = (int) (MapUtils.getDistance(n.getLocation(), newLatitude, newLongitude));
-				String str = n.getSimpleFormat(false) + " [" + dist + " m ]";
-				((DefaultMutableTreeNode) amenitiesTree.getChildAt(0)).add(new DataExtractionTreeNode(str, n));
-				((DefaultTreeModel)treePlaces.getModel()).nodeStructureChanged(amenitiesTree.getChildAt(0));
-			}
-		}
-	}
-	
-	public void updateListCities(Region r, String text, JList jList) {
-		Collection<City> city;
-		if (r == null) {
-			city = Collections.emptyList();
-		} else {
-			city = r.getSuggestedCities(text, 100);
-		}
-		City[] names = new City[city.size()];
-		int i = 0;
-		for (City c : city) {
-			names[i++] = c;
-		}
-		jList.setListData(names);
-	}
-
-	public static class RegionCellEditor extends DefaultTreeCellEditor {
-
-		public RegionCellEditor(JTree tree, DefaultTreeCellRenderer renderer) {
-			super(tree, renderer);
-		}
-
-		public RegionCellEditor(JTree tree, DefaultTreeCellRenderer renderer, TreeCellEditor editor) {
-			super(tree, renderer, editor);
-		}
-
-		public boolean isCellEditable(EventObject event) {
-			boolean returnValue = super.isCellEditable(event);
-			if (returnValue) {
-				Object node = tree.getLastSelectedPathComponent();
-				if (node instanceof DataExtractionTreeNode) {
-					DataExtractionTreeNode treeNode = (DataExtractionTreeNode) node;
-					if (treeNode.getModelObject() instanceof Region || treeNode.getModelObject() instanceof MapObject) {
-						return true;
-					}
-				}
-			}
-			return returnValue;
-		}
-		
-	}
-	private class PopupTrigger extends MouseAdapter {
-		
-		private final JPopupMenu popupMenu;
-		
-	    public PopupTrigger(JPopupMenu popupMenu) {
-			this.popupMenu = popupMenu;
-		}
-		public void mouseReleased(MouseEvent e)
-	    {
-	      if (e.isPopupTrigger())
-	      {
-	        int x = e.getX();
-	        int y = e.getY();
-	        TreePath path = treePlaces.getPathForLocation(x, y);
-	        if (path != null) {
-	        	if(!treePlaces.getSelectionModel().isPathSelected(path)){
-	        		treePlaces.setSelectionPath(path);
-	        	}
-	        	popupMenu.show(treePlaces, x, y);
-	        }
-	      }
-	    }
-	  }
-*/
-
-
-}
+package net.osmand.swing;
+
+import java.awt.BorderLayout;
+import java.awt.Container;
+import java.awt.FlowLayout;
+import java.awt.event.ActionEvent;
+import java.awt.event.ActionListener;
+import java.awt.event.WindowAdapter;
+import java.awt.event.WindowEvent;
+import java.io.File;
+import java.io.FileOutputStream;
+import java.io.IOException;
+import java.io.OutputStream;
+import java.lang.Thread.UncaughtExceptionHandler;
+import java.lang.reflect.InvocationTargetException;
+import java.sql.SQLException;
+import java.text.MessageFormat;
+
+import javax.swing.AbstractAction;
+import javax.swing.JCheckBox;
+import javax.swing.JDialog;
+import javax.swing.JFileChooser;
+import javax.swing.JFrame;
+import javax.swing.JLabel;
+import javax.swing.JMenu;
+import javax.swing.JMenuBar;
+import javax.swing.JMenuItem;
+import javax.swing.JOptionPane;
+import javax.swing.JPanel;
+import javax.swing.JScrollPane;
+import javax.swing.JSplitPane;
+import javax.swing.JTree;
+import javax.swing.UIManager;
+import javax.swing.filechooser.FileFilter;
+import javax.swing.tree.DefaultMutableTreeNode;
+import javax.swing.tree.DefaultTreeModel;
+import javax.xml.stream.XMLStreamException;
+
+import net.osmand.ExceptionHandler;
+import net.osmand.Version;
+import net.osmand.data.preparation.IndexCreator;
+import net.osmand.map.IMapLocationListener;
+import net.osmand.map.ITileSource;
+import net.osmand.osm.MapRenderingTypes;
+import net.osmand.osm.io.IOsmStorageFilter;
+import net.osmand.osm.io.OsmBaseStorage;
+import net.osmand.osm.io.OsmBoundsFilter;
+import net.osmand.osm.io.OsmStorageWriter;
+import net.osmand.swing.MapPanel.MapSelectionArea;
+
+import org.apache.commons.logging.Log;
+import org.apache.commons.logging.LogFactory;
+import org.apache.tools.bzip2.CBZip2OutputStream;
+import org.xml.sax.SAXException;
+
+import rtree.RTree;
+
+
+public class OsmExtractionUI implements IMapLocationListener {
+
+	private static final Log log = LogFactory.getLog(OsmExtractionUI.class);
+	public static final String LOG_PATH  = getUserLogDirectoryPath() + "/Osmand/osmand.log"; //$NON-NLS-1$ //$NON-NLS-2$
+	public static OsmExtractionUI MAIN_APP;
+
+	public static String getUserLogDirectoryPath() {
+		String path = null;
+		if (System.getProperty("os.name").startsWith("Windows")) {
+			path = System.getenv("APPDATA").replaceAll("\\\\", "/");
+		} else if (System.getProperty("os.name").startsWith("Mac")) {
+			path = System.getProperty("user.home") + "/Library/Logs";
+		} else if (System.getenv("XDG_CACHE_HOME") != null) {
+			path = System.getenv("XDG_CACHE_HOME");
+		} else {
+			path = System.getProperty("user.home") + "/.cache";
+		}
+		return path;
+	}
+	
+	public static void main(String[] args) {
+		// first of all config log
+		new File(LOG_PATH).getParentFile().mkdirs();
+		final UncaughtExceptionHandler defaultHandler = Thread.getDefaultUncaughtExceptionHandler();
+		Thread.setDefaultUncaughtExceptionHandler(new UncaughtExceptionHandler(){
+			@Override
+			public void uncaughtException(Thread t, Throwable e) {
+				if(!(e instanceof ThreadDeath)){
+					ExceptionHandler.handle("Error in thread " + t.getName(), e); //$NON-NLS-1$
+				}
+				defaultHandler.uncaughtException(t, e);
+			}
+		});
+		
+        MAIN_APP = new OsmExtractionUI();
+        MAIN_APP.frame.setBounds(DataExtractionSettings.getSettings().getWindowBounds());
+        MAIN_APP.frame.setVisible(true);
+	}
+	
+	
+	
+	
+	private JTree treePlaces;
+//	private DataExtractionTreeNode amenitiesTree;
+//	private TreeModelListener treeModelListener;
+	
+	
+	private MapPanel mapPanel;
+	private JFrame frame;
+	private JLabel statusBarLabel;
+	
+
+	private JCheckBox buildPoiIndex;
+	private JCheckBox buildAddressIndex;
+	private JCheckBox buildMapIndex;
+	private JCheckBox buildTransportIndex;
+	private JCheckBox normalizingStreets;
+
+	private String regionName;
+		
+	
+	
+	public OsmExtractionUI(){
+		createUI();
+	}
+
+	
+        
+	
+	
+	public void createUI(){
+		frame = new JFrame(Messages.getString("OsmExtractionUI.OSMAND_MAP_CREATOR")); //$NON-NLS-1$
+	    try {
+			UIManager.setLookAndFeel(UIManager.getSystemLookAndFeelClassName());
+		} catch (Exception e) {
+			log.error("Can't set look and feel", e); //$NON-NLS-1$
+		}
+		
+		
+	    frame.addWindowListener(new ExitListener());
+	    Container content = frame.getContentPane();
+	    frame.setFocusable(true);
+	    
+	    mapPanel = new MapPanel(DataExtractionSettings.getSettings().getTilesDirectory());
+	    mapPanel.setFocusable(true);
+	    mapPanel.addMapLocationListener(this);
+	    
+	    statusBarLabel = new JLabel();
+	    content.add(statusBarLabel, BorderLayout.SOUTH);
+	    File workingDir = DataExtractionSettings.getSettings().getDefaultWorkingDir();
+	    statusBarLabel.setText(workingDir == null ? Messages.getString("OsmExtractionUI.WORKING_DIR_UNSPECIFIED") : Messages.getString("OsmExtractionUI.WORKING_DIRECTORY") + workingDir.getAbsolutePath()); //$NON-NLS-1$ //$NON-NLS-2$
+	    
+	   
+	    treePlaces = new JTree();
+		treePlaces.setModel(new DefaultTreeModel(new DefaultMutableTreeNode(Messages.getString("OsmExtractionUI.REGION")), false)); 	     //$NON-NLS-1$
+	    JSplitPane panelForTreeAndMap = new JSplitPane(JSplitPane.HORIZONTAL_SPLIT, new JScrollPane(treePlaces), mapPanel);
+	    panelForTreeAndMap.setResizeWeight(0.2);
+	    content.add(panelForTreeAndMap, BorderLayout.CENTER);
+	    
+	    createButtonsBar(content);
+	   
+	    JMenuBar bar = new JMenuBar();
+	    fillMenuWithActions(bar);
+
+	    frame.setJMenuBar(bar);
+	}
+	
+	
+	
+	
+	public void createButtonsBar(Container content){
+		JPanel panel = new JPanel(new FlowLayout(FlowLayout.LEFT));
+		content.add(panel, BorderLayout.NORTH);
+		
+		buildMapIndex = new JCheckBox();
+		buildMapIndex.setText(Messages.getString("OsmExtractionUI.BUILD_MAP")); //$NON-NLS-1$
+		panel.add(buildMapIndex);
+		buildMapIndex.setSelected(true);
+		
+		buildPoiIndex = new JCheckBox();
+		buildPoiIndex.setText(Messages.getString("OsmExtractionUI.BUILD_POI")); //$NON-NLS-1$
+		panel.add(buildPoiIndex);
+		buildPoiIndex.setSelected(true);
+		
+		buildAddressIndex = new JCheckBox();
+		buildAddressIndex.setText(Messages.getString("OsmExtractionUI.BUILD_ADDRESS")); //$NON-NLS-1$
+		panel.add(buildAddressIndex);
+		buildAddressIndex.setSelected(true);
+		
+		normalizingStreets = new JCheckBox();
+		normalizingStreets.setText(Messages.getString("OsmExtractionUI.NORMALIZE_STREETS")); //$NON-NLS-1$
+		panel.add(normalizingStreets);
+		normalizingStreets.setSelected(true);
+		
+		buildTransportIndex = new JCheckBox();
+		buildTransportIndex.setText(Messages.getString("OsmExtractionUI.BUILD_TRANSPORT")); //$NON-NLS-1$
+		panel.add(buildTransportIndex);
+		buildTransportIndex.setSelected(true);
+
+		
+		
+	}
+	
+	public void fillMenuWithActions(final JMenuBar bar){
+		JMenu menu = new JMenu(Messages.getString("OsmExtractionUI.MENU_FILE")); //$NON-NLS-1$
+		bar.add(menu);
+		JMenuItem loadFile = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_SELECT_FILE")); //$NON-NLS-1$
+		menu.add(loadFile);
+		JMenuItem loadSpecifiedAreaFile = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_SELECT_OSM_FILE_AREA")); //$NON-NLS-1$
+		menu.add(loadSpecifiedAreaFile);
+		JMenuItem specifyWorkingDir = new JMenuItem(Messages.getString("OsmExtractionUI.SPECIFY_WORKING_DIR")); //$NON-NLS-1$
+		menu.add(specifyWorkingDir);
+		menu.addSeparator();
+		JMenuItem exitMenu= new JMenuItem(Messages.getString("OsmExtractionUI.MENU_EXIT")); //$NON-NLS-1$
+		menu.add(exitMenu);
+		
+		JMenu tileSource = MapPanel.getMenuToChooseSource(mapPanel);
+		final JMenuItem sqliteDB = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_CREATE_SQLITE")); //$NON-NLS-1$
+		tileSource.addSeparator();
+		tileSource.add(sqliteDB);
+		bar.add(tileSource);
+		
+		menu = new JMenu(Messages.getString("OsmExtractionUI.MENU_WINDOW")); //$NON-NLS-1$
+		bar.add(menu);
+		JMenuItem settings = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_SETTINGS")); //$NON-NLS-1$
+		menu.add(settings);
+		menu.addSeparator();
+		JMenuItem openLogFile = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_OPEN_LOG")); //$NON-NLS-1$
+		menu.add(openLogFile);
+		
+		menu = new JMenu(Messages.getString("OsmExtractionUI.MENU_ABOUT")); //$NON-NLS-1$
+		bar.add(menu);
+		JMenuItem aboutApplication = new JMenuItem(Messages.getString("OsmExtractionUI.MENU_ABOUT_2")); //$NON-NLS-1$
+		menu.add(aboutApplication);
+		
+		
+		aboutApplication.addActionListener(new ActionListener() {
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				JOptionPane.showMessageDialog(frame, Version.APP_MAP_CREATOR_FULL_NAME);
+			}
+		});
+
+		openLogFile.addActionListener(new ActionListener() {
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				File file = new File(OsmExtractionUI.LOG_PATH);
+				if (file != null && file.exists()) {
+					if (System.getProperty("os.name").startsWith("Windows")) { //$NON-NLS-1$ //$NON-NLS-2$
+						try {
+							Runtime.getRuntime().exec(new String[] { "notepad.exe", file.getAbsolutePath() }); //$NON-NLS-1$
+						} catch (IOException es) {
+							ExceptionHandler.handle(Messages.getString("OsmExtractionUI.UNABLE_OPEN_FILE"), es); //$NON-NLS-1$
+						}
+					} else {
+						JOptionPane.showMessageDialog(frame, Messages.getString("OsmExtractionUI.OPEN_LOG_FILE_MANUALLY") + LOG_PATH); //$NON-NLS-1$
+					}
+
+				} else {
+					ExceptionHandler.handle(Messages.getString("OsmExtractionUI.LOG_FILE_NOT_FOUND")); //$NON-NLS-1$
+				}
+			}
+		});
+		
+		sqliteDB.addActionListener(new ActionListener(){
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				final String regionName = OsmExtractionUI.this.regionName == null ? Messages.getString("OsmExtractionUI.REGION") : OsmExtractionUI.this.regionName; //$NON-NLS-1$
+				final ITileSource map = mapPanel.getMap();
+				if(map != null){
+					try {
+			    		final ProgressDialog dlg = new ProgressDialog(frame, Messages.getString("OsmExtractionUI.CREATING_INDEX")); //$NON-NLS-1$
+			    		dlg.setRunnable(new Runnable(){
+
+							@Override
+							public void run() {
+								try {
+									SQLiteBigPlanetIndex.createSQLiteDatabase(DataExtractionSettings.getSettings().getTilesDirectory(), regionName, map);
+								} catch (SQLException e1) {
+									throw new IllegalArgumentException(e1);
+								} catch (IOException e1) {
+									throw new IllegalArgumentException(e1);
+								}
+							}
+			    		});
+			    		dlg.run();
+					} catch (InterruptedException e1) {
+						log.error("Interrupted", e1);  //$NON-NLS-1$
+					} catch (InvocationTargetException e1) {
+						ExceptionHandler.handle("Can't create big planet sqlite index", (Exception) e1.getCause()); //$NON-NLS-1$
+					}
+					
+					
+				}
+			}
+		});
+
+		
+		exitMenu.addActionListener(new ActionListener(){
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				frame.setVisible(false);
+				exit();
+			}
+		});
+		settings.addActionListener(new ActionListener(){
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				OsmExtractionPreferencesDialog dlg = new OsmExtractionPreferencesDialog(frame);
+				dlg.showDialog();
+			}
+			
+		});
+		specifyWorkingDir.addActionListener(new ActionListener(){
+
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				JFileChooser fc = new JFileChooser();
+		        fc.setDialogTitle(Messages.getString("OsmExtractionUI.CHOOSE_WORKING_DIR")); //$NON-NLS-1$
+		        fc.setFileSelectionMode(JFileChooser.DIRECTORIES_ONLY);
+		        File workingDir = DataExtractionSettings.getSettings().getDefaultWorkingDir();
+		        if(workingDir != null){
+		        	fc.setCurrentDirectory(workingDir);
+		        }
+		        if(fc.showOpenDialog(frame) == JFileChooser.APPROVE_OPTION && fc.getSelectedFile() != null && 
+		        		fc.getSelectedFile().isDirectory()){
+		        	DataExtractionSettings.getSettings().saveDefaultWorkingDir(fc.getSelectedFile());
+		        	mapPanel.setTilesLocation(DataExtractionSettings.getSettings().getTilesDirectory());
+		        	statusBarLabel.setText(Messages.getString("OsmExtractionUI.WORKING_DIR") + fc.getSelectedFile().getAbsolutePath()); //$NON-NLS-1$
+		        	JMenu tileSource = MapPanel.getMenuToChooseSource(mapPanel);
+		    		tileSource.add(sqliteDB);
+		    		bar.remove(1);
+		    		bar.add(tileSource, 1);
+		        }
+			}
+			
+		});
+		loadSpecifiedAreaFile.addActionListener(new ActionListener(){
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				JFileChooser fc = getOsmFileChooser();
+		        int answer = fc.showOpenDialog(frame) ;
+		        if (answer == JFileChooser.APPROVE_OPTION && fc.getSelectedFile() != null){
+		        	final JDialog dlg = new JDialog(frame, true);
+		        	dlg.setTitle(Messages.getString("OsmExtractionUI.SELECT_AREA_TO_FILTER")); //$NON-NLS-1$
+		        	MapPanel panel = new MapPanel(DataExtractionSettings.getSettings().getTilesDirectory());
+		        	panel.setLatLon(mapPanel.getLatitude(), mapPanel.getLongitude());
+		        	panel.setZoom(mapPanel.getZoom());
+		        	final StringBuilder res = new StringBuilder();
+		        	panel.getLayer(MapInformationLayer.class).setAreaActionHandler(new AbstractAction(Messages.getString("OsmExtractionUI.SELECT_AREA")){ //$NON-NLS-1$
+						private static final long serialVersionUID = -3452957517341961969L;
+						@Override
+						public void actionPerformed(ActionEvent e) {
+							res.append(true);
+							dlg.setVisible(false);
+						}
+		        		
+		        	});
+		        	dlg.add(panel);
+		        	
+		        	
+		        	JMenuBar bar = new JMenuBar();
+		    	    bar.add(MapPanel.getMenuToChooseSource(panel));
+		    	    dlg.setJMenuBar(bar);
+		    	    dlg.setSize(512, 512);
+		    	    double x = frame.getBounds().getCenterX();
+		    	    double y = frame.getBounds().getCenterY();
+		    	    dlg.setLocation((int) x - dlg.getWidth() / 2, (int) y - dlg.getHeight() / 2);
+		        	
+		    	    dlg.setVisible(true);
+		    		if(res.length() > 0 && panel.getSelectionArea().isVisible()){
+		    			MapSelectionArea area = panel.getSelectionArea();
+		    			IOsmStorageFilter filter = new OsmBoundsFilter(area.getLat1(), area.getLon1(), area.getLat2(), area.getLon2());
+		    			loadCountry(fc.getSelectedFile(), filter);
+		    		}
+		        }
+			}
+			
+		});
+		loadFile.addActionListener(new ActionListener(){
+
+			@Override
+			public void actionPerformed(ActionEvent e) {
+				JFileChooser fc = getOsmFileChooser();
+		        int answer = fc.showOpenDialog(frame) ;
+		        if (answer == JFileChooser.APPROVE_OPTION && fc.getSelectedFile() != null){
+		        	loadCountry(fc.getSelectedFile(), null);
+		        }
+			}
+			
+		});
+
+	}
+	
+	public JFileChooser getOsmFileChooser(){
+		JFileChooser fc = new JFileChooser();
+        fc.setDialogTitle(Messages.getString("OsmExtractionUI.CHOOSE_OSM_FILE")); //$NON-NLS-1$
+        fc.setFileSelectionMode(JFileChooser.FILES_ONLY);
+        fc.setAcceptAllFileFilterUsed(true);
+        fc.setCurrentDirectory(DataExtractionSettings.getSettings().getDefaultWorkingDir().getParentFile());
+        fc.setFileFilter(new FileFilter(){
+
+			@Override
+			public boolean accept(File f) {
+				return f.isDirectory() || f.getName().endsWith(".bz2") || f.getName().endsWith(".osm") || f.getName().endsWith(".pbf"); //$NON-NLS-1$ //$NON-NLS-2$ //$NON-NLS-3$
+			}
+
+			@Override
+			public String getDescription() {
+				return Messages.getString("OsmExtractionUI.OSM_FILES"); //$NON-NLS-1$
+			}
+        });
+        return fc;
+	}
+	
+	public JFrame getFrame() {
+		return frame;
+	}
+	
+	public void loadCountry(final File f, final IOsmStorageFilter filter){
+		try {
+    		final ProgressDialog dlg = new ProgressDialog(frame, Messages.getString("OsmExtractionUI.LOADING_OSM_FILE")); //$NON-NLS-1$
+    		dlg.setRunnable(new Runnable(){
+
+				@Override
+				public void run() {
+					File dir = DataExtractionSettings.getSettings().getDefaultWorkingDir();
+					IndexCreator creator = new IndexCreator(dir);
+					try {
+						creator.setIndexAddress(buildAddressIndex.isSelected());
+						creator.setIndexPOI(buildPoiIndex.isSelected());
+						creator.setNormalizeStreets(normalizingStreets.isSelected());
+						creator.setIndexTransport(buildTransportIndex.isSelected());
+						creator.setIndexMap(buildMapIndex.isSelected());
+						creator.setCityAdminLevel(DataExtractionSettings.getSettings().getCityAdminLevel());
+						String fn = DataExtractionSettings.getSettings().getMapRenderingTypesFile();
+						MapRenderingTypes types;
+						if(fn == null || fn.length() == 0){
+							types = MapRenderingTypes.getDefault();
+						} else {
+							types = new MapRenderingTypes(fn);
+						}
+						RTree.clearCache();
+						creator.generateIndexes(f, dlg, filter, DataExtractionSettings.getSettings().getMapZooms(), types);
+					} catch (IOException e) {
+						throw new IllegalArgumentException(e);
+					} catch (SAXException e) {
+						throw new IllegalStateException(e);
+					} catch (SQLException e) {
+						throw new IllegalStateException(e);
+					}
+					regionName = creator.getRegionName();
+					StringBuilder msg = new StringBuilder();
+					msg.append(Messages.getString("OsmExtractionUI.INDEXES_FOR")).append(regionName).append(" : "); //$NON-NLS-1$ //$NON-NLS-2$
+					boolean comma = false;
+					if (buildMapIndex.isSelected()) {
+						if(comma) msg.append(", "); //$NON-NLS-1$
+						comma = true;
+						msg.append(Messages.getString("OsmExtractionUI.MAP")); //$NON-NLS-1$
+					}
+					if (buildPoiIndex.isSelected()) {
+						if(comma) msg.append(", "); //$NON-NLS-1$
+						comma = true;
+						msg.append(Messages.getString("OsmExtractionUI.POI")); //$NON-NLS-1$
+					}
+					if (buildAddressIndex.isSelected()) {
+						if(comma) msg.append(", "); //$NON-NLS-1$
+						comma = true;
+						msg.append(Messages.getString("OsmExtractionUI.ADDRESS")); //$NON-NLS-1$
+					}
+					if (buildTransportIndex.isSelected()) {
+						if(comma) msg.append(", "); //$NON-NLS-1$
+						comma = true;
+						msg.append(Messages.getString("OsmExtractionUI.TRANSPORT")); //$NON-NLS-1$
+					}
+					msg.append(MessageFormat.format(Messages.getString("OsmExtractionUI.WERE_SUCCESFULLY_CREATED"), dir.getAbsolutePath())); //$NON-NLS-1$
+					JOptionPane pane = new JOptionPane(msg);
+					JDialog dialog = pane.createDialog(frame, Messages.getString("OsmExtractionUI.GENERATION_DATA")); //$NON-NLS-1$
+					dialog.setVisible(true);
+				}
+    		});
+    		
+			dlg.run();
+			frame.setTitle(Messages.getString("OsmExtractionUI.OSMAND_MAP_CREATOR_FILE") + f.getName()); //$NON-NLS-1$
+		} catch (InterruptedException e1) {
+			log.error("Interrupted", e1);  //$NON-NLS-1$
+		} catch (InvocationTargetException e1) {
+			ExceptionHandler.handle("Exception during operation", e1.getCause()); //$NON-NLS-1$
+		}
+	}
+	
+	public void saveCountry(final File f, final OsmBaseStorage storage){
+		final OsmStorageWriter writer = new OsmStorageWriter();
+		try {
+    		final ProgressDialog dlg = new ProgressDialog(frame, Messages.getString("OsmExtractionUI.SAVING_OSM_FILE")); //$NON-NLS-1$
+    		dlg.setRunnable(new Runnable() {
+				@Override
+				public void run() {
+					try {
+						OutputStream output = new FileOutputStream(f);
+						try {
+							if (f.getName().endsWith(".bz2")) { //$NON-NLS-1$
+								output.write('B');
+								output.write('Z');
+								output = new CBZip2OutputStream(output);
+							}
+							writer.saveStorage(output, storage, null, false);
+						} finally {
+							output.close();
+						}
+					} catch (IOException e) {
+						throw new IllegalArgumentException(e);
+					} catch (XMLStreamException e) {
+						throw new IllegalArgumentException(e);
+					}
+				}
+			});
+    		dlg.run();
+		} catch (InterruptedException e1) {
+			log.error("Interrupted", e1);  //$NON-NLS-1$
+		} catch (InvocationTargetException e1) {
+			ExceptionHandler.handle("Log file is not found", e1.getCause()); //$NON-NLS-1$
+		}
+	}
+	
+	@Override
+	public void locationChanged(final double newLatitude, final double newLongitude, Object source){
+//		recalculateAmenities(newLatitude, newLongitude);
+	}
+
+
+
+	
+	public class ExitListener extends WindowAdapter {
+		public void windowClosing(WindowEvent event) {
+			exit();
+		}
+	}
+	
+	public void exit(){
+		// save preferences
+		DataExtractionSettings settings = DataExtractionSettings.getSettings();
+		settings.saveDefaultLocation(mapPanel.getLatitude(), mapPanel.getLongitude());
+		settings.saveDefaultZoom(mapPanel.getZoom());
+		settings.saveWindowBounds(frame.getBounds());
+		System.exit(0);
+	}
+	
+
+
+	
+	
+	// OLD CODE
+/*
+
+	public JTree createTree(Container content) {		
+		treePlaces.setEditable(true);
+		treePlaces.setCellEditor(new RegionCellEditor(treePlaces, (DefaultTreeCellRenderer) treePlaces.getCellRenderer()));
+		treePlaces.addTreeSelectionListener(new TreeSelectionListener() {
+			@Override
+			public void valueChanged(TreeSelectionEvent e) {
+				if (e.getPath() != null) {
+					if (e.getPath().getLastPathComponent() instanceof DataExtractionTreeNode) {
+						Object o = ((DataExtractionTreeNode) e.getPath().getLastPathComponent()).getModelObject();
+
+						if (o instanceof MapObject) {
+							MapObject c = (MapObject) o;
+							LatLon location = c.getLocation();
+							if (location != null) {
+								if (o instanceof Street) {
+									DataTileManager<Way> ways = new DataTileManager<Way>();
+									for (Way w : ((Street) o).getWayNodes()) {
+										LatLon l = w.getLatLon();
+										ways.registerObject(l.getLatitude(), l.getLongitude(), w);
+									}
+									mapPanel.setPoints(ways);
+									mapPanel.requestFocus();
+								}
+								mapPanel.setLatLon(location.getLatitude(), location.getLongitude());
+								mapPanel.requestFocus();
+							}
+							if (o instanceof TransportRoute) {
+								DataTileManager<Entity> ways = new DataTileManager<Entity>();
+								for (Way w : ((TransportRoute) o).getWays()) {
+									LatLon l = w.getLatLon();
+									ways.registerObject(l.getLatitude(), l.getLongitude(), w);
+								}
+								for (TransportStop w : ((TransportRoute) o).getBackwardStops()) {
+									LatLon l = w.getLocation();
+									ways.registerObject(l.getLatitude(), l.getLongitude(), new Node(l.getLatitude(), l.getLongitude(), w
+											.getId()));
+								}
+								for (TransportStop w : ((TransportRoute) o).getForwardStops()) {
+									LatLon l = w.getLocation();
+									ways.registerObject(l.getLatitude(), l.getLongitude(), new Node(l.getLatitude(), l.getLongitude(), w
+											.getId()));
+								}
+								mapPanel.setPoints(ways);
+								mapPanel.requestFocus();
+							}
+
+						} else if (o instanceof Entity) {
+							Entity c = (Entity) o;
+							LatLon latLon = c.getLatLon();
+							if (latLon != null) {
+								mapPanel.setLatLon(latLon.getLatitude(), latLon.getLongitude());
+								mapPanel.requestFocus();
+							}
+						}
+					}
+				}
+
+			}
+		});
+
+		treeModelListener = new TreeModelListener() {
+			public void treeNodesChanged(TreeModelEvent e) {
+				Object node = e.getTreePath().getLastPathComponent();
+				if (e.getChildren() != null && e.getChildren().length > 0) {
+					node = e.getChildren()[0];
+				}
+				if (node instanceof DataExtractionTreeNode) {
+					DataExtractionTreeNode n = ((DataExtractionTreeNode) node);
+					if (n.getModelObject() instanceof MapObject) {
+						MapObject r = (MapObject) n.getModelObject();
+						String newName = n.getUserObject().toString();
+						if (!r.getName().equals(newName)) {
+							r.setName(n.getUserObject().toString());
+						}
+						if (r instanceof Street && !((Street) r).isRegisteredInCity()) {
+							DefaultMutableTreeNode parent = ((DefaultMutableTreeNode) n.getParent());
+							parent.remove(n);
+							((DefaultTreeModel) treePlaces.getModel()).nodeStructureChanged(parent);
+						}
+					}
+				}
+			}
+
+			public void treeNodesInserted(TreeModelEvent e) {
+			}
+
+			public void treeNodesRemoved(TreeModelEvent e) {
+			}
+
+			public void treeStructureChanged(TreeModelEvent e) {
+			}
+		};
+		treePlaces.getModel().addTreeModelListener(treeModelListener);
+		return treePlaces;
+	}
+
+	public void fillPopupMenuWithActions(JPopupMenu menu) {
+		Action delete = new AbstractAction("Delete") {
+			private static final long serialVersionUID = 7476603434847164396L;
+
+			public void actionPerformed(ActionEvent e) {
+				TreePath[] p = treePlaces.getSelectionPaths();
+				if(p != null && 
+						JOptionPane.OK_OPTION == 
+							JOptionPane.showConfirmDialog(frame, "Are you sure about deleting " +p.length + " resources ? ")){
+				for(TreePath path : treePlaces.getSelectionPaths()){
+					Object node = path.getLastPathComponent();
+					if (node instanceof DataExtractionTreeNode) {
+						DataExtractionTreeNode n = ((DataExtractionTreeNode) node);
+						if(n.getParent() instanceof DataExtractionTreeNode){
+							DataExtractionTreeNode parent = ((DataExtractionTreeNode) n.getParent());
+							boolean remove = false;
+							if (n.getModelObject() instanceof Street) {
+								((City)parent.getModelObject()).unregisterStreet(((Street)n.getModelObject()).getName());
+								remove = true;
+							} else if (n.getModelObject() instanceof Building) {
+								((Street)parent.getModelObject()).getBuildings().remove(n.getModelObject());
+								remove = true;
+							} else if (n.getModelObject() instanceof City) {
+								Region r = (Region) ((DataExtractionTreeNode)parent.getParent()).getModelObject();
+								r.unregisterCity((City) n.getModelObject());
+								remove = true;
+							} else if (n.getModelObject() instanceof Amenity) {
+								Region r = (Region) ((DataExtractionTreeNode)parent.getParent().getParent()).getModelObject();
+								Amenity am = (Amenity) n.getModelObject();
+								r.getAmenityManager().unregisterObject(am.getLocation().getLatitude(), am.getLocation().getLongitude(), am);
+								remove = true;
+							}
+							if(remove){
+								parent.remove(n);
+								((DefaultTreeModel) treePlaces.getModel()).nodeStructureChanged(parent);
+							}
+						}
+					}
+				}
+				
+				}
+			}
+		};
+		menu.add(delete);
+		Action rename= new AbstractAction("Rename") {
+			private static final long serialVersionUID = -8257594433235073767L;
+
+			public void actionPerformed(ActionEvent e) {
+				TreePath path = treePlaces.getSelectionPath();
+				if(path != null){
+					treePlaces.startEditingAtPath(path);
+				}
+			}
+		};
+		menu.add(rename);
+	}
+	
+	
+	public void setRegion(Region region, String name){
+		if (this.region == region) {
+			return;
+		}
+		this.region = region;
+		DefaultMutableTreeNode root = new DataExtractionTreeNode(name, region);
+		if (region != null) {
+			amenitiesTree = new DataExtractionTreeNode("Amenities", region);
+			amenitiesTree.add(new DataExtractionTreeNode("First 15", region));
+			for (AmenityType type : AmenityType.values()) {
+				amenitiesTree.add(new DataExtractionTreeNode(Algoritms.capitalizeFirstLetterAndLowercase(type.toString()), type));
+			}
+			root.add(amenitiesTree);
+			
+			DataExtractionTreeNode transport = new DataExtractionTreeNode("Transport", region);
+			root.add(transport);
+			for(String s : region.getTransportRoutes().keySet()){
+				DataExtractionTreeNode trRoute = new DataExtractionTreeNode(s, s);
+				transport.add(trRoute);
+				List<TransportRoute> list = region.getTransportRoutes().get(s);
+				for(TransportRoute r : list){
+					DataExtractionTreeNode route = new DataExtractionTreeNode(r.getRef(), r);
+					trRoute.add(route);
+				}
+				
+			}
+
+			for (CityType t : CityType.values()) {
+				DefaultMutableTreeNode cityTree = new DataExtractionTreeNode(Algoritms.capitalizeFirstLetterAndLowercase(t.toString()), t);
+				root.add(cityTree);
+				for (City ct : region.getCitiesByType(t)) {
+					DefaultMutableTreeNode cityNodeTree = new DataExtractionTreeNode(ct.getName(), ct);
+					cityTree.add(cityNodeTree);
+
+					for (Street str : ct.getStreets()) {
+						DefaultMutableTreeNode strTree = new DataExtractionTreeNode(str.getName(), str);
+						cityNodeTree.add(strTree);
+						for (Building b : str.getBuildings()) {
+							DefaultMutableTreeNode building = new DataExtractionTreeNode(b.getName(), b);
+							strTree.add(building);
+						}
+					}
+				}
+			}
+		}
+		
+	    if (searchList != null) {
+			updateListCities(region, searchTextField.getText(), searchList);
+		}
+		mapPanel.repaint();
+		DefaultTreeModel newModel = new DefaultTreeModel(root, false);
+		newModel.addTreeModelListener(treeModelListener);
+		treePlaces.setModel(newModel);
+		
+		updateButtonsBar();
+		locationChanged(mapPanel.getLatitude(), mapPanel.getLongitude(), this);
+	}
+	
+	public static class DataExtractionTreeNode extends DefaultMutableTreeNode {
+		private static final long serialVersionUID = 1L;
+		private final Object modelObject;
+
+		public DataExtractionTreeNode(String name, Object modelObject){
+			super(name);
+			this.modelObject = modelObject;
+		}
+		
+		public Object getModelObject(){
+			return modelObject;
+		}
+		
+	}
+	
+	private void recalculateAmenities(final double newLatitude, final double newLongitude) {
+		if (amenitiesTree != null) {
+			Region reg = (Region) amenitiesTree.getModelObject();
+			List<Amenity> closestAmenities = reg.getAmenityManager().getClosestObjects(newLatitude, newLongitude, 0, 5);
+			MapUtils.sortListOfMapObject(closestAmenities, newLatitude, newLongitude);
+			
+
+			Map<AmenityType, List<Amenity>> filter = new HashMap<AmenityType, List<Amenity>>();
+			for (Amenity n : closestAmenities) {
+				AmenityType type = n.getType();
+				if (!filter.containsKey(type)) {
+					filter.put(type, new ArrayList<Amenity>());
+				}
+				filter.get(type).add(n);
+			}
+			
+			
+			for (int i = 1; i < amenitiesTree.getChildCount(); i++) {
+				AmenityType type = (AmenityType) ((DataExtractionTreeNode) amenitiesTree.getChildAt(i)).getModelObject();
+				((DefaultMutableTreeNode) amenitiesTree.getChildAt(i)).removeAllChildren();
+				if (filter.get(type) != null) {
+					for (Amenity n : filter.get(type)) {
+						int dist = (int) (MapUtils.getDistance(n.getLocation(), newLatitude, newLongitude));
+						String str = n.getStringWithoutType(false) + " [" + dist + " m ]";
+						DataExtractionTreeNode node = new DataExtractionTreeNode(str, n);
+						((DefaultMutableTreeNode) amenitiesTree.getChildAt(i)).add(node);
+					}
+				}
+				((DefaultTreeModel)treePlaces.getModel()).nodeStructureChanged(amenitiesTree.getChildAt(i));
+			}
+			((DefaultMutableTreeNode) amenitiesTree.getChildAt(0)).removeAllChildren();
+
+			for (int i = 0; i < 15 && i < closestAmenities.size(); i++) {
+				Amenity n = closestAmenities.get(i);
+				int dist = (int) (MapUtils.getDistance(n.getLocation(), newLatitude, newLongitude));
+				String str = n.getSimpleFormat(false) + " [" + dist + " m ]";
+				((DefaultMutableTreeNode) amenitiesTree.getChildAt(0)).add(new DataExtractionTreeNode(str, n));
+				((DefaultTreeModel)treePlaces.getModel()).nodeStructureChanged(amenitiesTree.getChildAt(0));
+			}
+		}
+	}
+	
+	public void updateListCities(Region r, String text, JList jList) {
+		Collection<City> city;
+		if (r == null) {
+			city = Collections.emptyList();
+		} else {
+			city = r.getSuggestedCities(text, 100);
+		}
+		City[] names = new City[city.size()];
+		int i = 0;
+		for (City c : city) {
+			names[i++] = c;
+		}
+		jList.setListData(names);
+	}
+
+	public static class RegionCellEditor extends DefaultTreeCellEditor {
+
+		public RegionCellEditor(JTree tree, DefaultTreeCellRenderer renderer) {
+			super(tree, renderer);
+		}
+
+		public RegionCellEditor(JTree tree, DefaultTreeCellRenderer renderer, TreeCellEditor editor) {
+			super(tree, renderer, editor);
+		}
+
+		public boolean isCellEditable(EventObject event) {
+			boolean returnValue = super.isCellEditable(event);
+			if (returnValue) {
+				Object node = tree.getLastSelectedPathComponent();
+				if (node instanceof DataExtractionTreeNode) {
+					DataExtractionTreeNode treeNode = (DataExtractionTreeNode) node;
+					if (treeNode.getModelObject() instanceof Region || treeNode.getModelObject() instanceof MapObject) {
+						return true;
+					}
+				}
+			}
+			return returnValue;
+		}
+		
+	}
+	private class PopupTrigger extends MouseAdapter {
+		
+		private final JPopupMenu popupMenu;
+		
+	    public PopupTrigger(JPopupMenu popupMenu) {
+			this.popupMenu = popupMenu;
+		}
+		public void mouseReleased(MouseEvent e)
+	    {
+	      if (e.isPopupTrigger())
+	      {
+	        int x = e.getX();
+	        int y = e.getY();
+	        TreePath path = treePlaces.getPathForLocation(x, y);
+	        if (path != null) {
+	        	if(!treePlaces.getSelectionModel().isPathSelected(path)){
+	        		treePlaces.setSelectionPath(path);
+	        	}
+	        	popupMenu.show(treePlaces, x, y);
+	        }
+	      }
+	    }
+	  }
+*/
+
+
+}
diff --git a/OsmAnd/AndroidManifest.xml b/OsmAnd/AndroidManifest.xml
index 7a8595309f3..780e3432f0f 100644
--- a/OsmAnd/AndroidManifest.xml
+++ b/OsmAnd/AndroidManifest.xml
@@ -1,62 +1,62 @@
-<?xml version="1.0" encoding="utf-8"?>
-<manifest xmlns:android="http://schemas.android.com/apk/res/android"
-	package="net.osmand.plus" android:installLocation="auto" android:versionName="0.6.2" android:versionCode="31">
-	<application android:icon="@drawable/icon" android:label="@string/app_name"
-		android:debuggable="true" android:name=".activities.OsmandApplication" android:description="@string/app_description">
-		<activity android:name=".activities.MainMenuActivity"
-			android:label="@string/app_name">
-			<intent-filter>
-				<action android:name="android.intent.action.MAIN" />
-				<category android:name="android.intent.category.LAUNCHER" />
-			</intent-filter>
-		</activity>
-		<activity android:name=".activities.MapActivity" android:label="@string/app_name" android:screenOrientation="portrait">
-			<intent-filter>
-    			<data android:scheme="http" android:host="download.osmand.net" path="go"/>
-    			<action android:name="android.intent.action.VIEW" />
-    			<category android:name="android.intent.category.DEFAULT"/>
-				<category android:name="android.intent.category.BROWSABLE"/>
-			</intent-filter>
-		</activity>
-		<activity android:name=".activities.SettingsActivity" android:label="@string/settings_activity" android:configChanges="keyboardHidden|orientation"></activity>
-		<activity android:name=".activities.search.SearchActivity" android:label="@string/search_activity" ></activity>
-        <activity android:name=".activities.NavigatePointActivity"></activity>
-        <activity android:name=".activities.DownloadIndexActivity" android:configChanges="keyboardHidden|orientation"></activity>
-        <activity android:name=".activities.ShowRouteInfoActivity"></activity>
-        <activity android:name=".activities.FavouritesActivity" android:label="@string/favourites_activity"></activity>
-        <activity android:name=".activities.ContributionVersionActivity" android:label="@string/contribution_activity"></activity>
-        
-        
-        <activity android:name=".activities.search.SearchPOIActivity" android:label="@string/searchpoi_activity"></activity>
-        <activity android:name=".activities.search.SearchPoiFilterActivity"></activity>
-        <activity android:name=".activities.search.SearchAddressOnlineActivity"></activity>
-        <activity android:name=".activities.search.SearchAddressActivity"></activity>
-        <activity android:name=".activities.search.SearchTransportActivity"></activity>
-        <activity android:name=".activities.search.SearchHistoryActivity"></activity>
-        <activity android:name=".activities.search.SearchCityByNameActivity"></activity>
-        <activity android:name=".activities.search.SearchRegionByNameActivity"></activity>
-        <activity android:name=".activities.search.SearchStreetByNameActivity"></activity>
-        <activity android:name=".activities.search.SearchStreet2ByNameActivity"></activity>
-        <activity android:name=".activities.search.SearchBuildingByNameActivity"></activity>
-		<activity android:name=".activities.EditPOIFilterActivity"></activity>
-		<service android:process="net.osmand.plus" android:label="@string/process_navigation_service" android:name=".NavigationService">
-			<intent-filter><action android:name="net.osmand.plus.NavigationService"></action></intent-filter>
-		</service>
-		<receiver android:name=".OnNavigationServiceAlarmReceiver"/>
-</application>
-
-
-<!--  comment change build properties for release & set targetSdkVersion="7", build and  reverse changes-->
-<!--  <uses-sdk android:minSdkVersion="3"/> -->
-<!--   uncomment it to allow different screen supports (large/small)-->
-<uses-sdk android:minSdkVersion="3" android:targetSdkVersion="4"/>  
-
-
-<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"></uses-permission>
-<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"></uses-permission>
-<uses-permission android:name="android.permission.ACCESS_MOCK_LOCATION"></uses-permission>
-<uses-permission android:name="android.permission.INTERNET"></uses-permission>
-<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"></uses-permission>
-<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"></uses-permission>
-<uses-permission android:name="android.permission.WAKE_LOCK"></uses-permission>
-</manifest> 
+<?xml version="1.0" encoding="utf-8"?>
+<manifest xmlns:android="http://schemas.android.com/apk/res/android"
+	package="net.osmand.plus" android:installLocation="auto" android:versionName="0.6.2" android:versionCode="31">
+	<application android:icon="@drawable/icon" android:label="@string/app_name"
+		android:debuggable="true" android:name=".activities.OsmandApplication" android:description="@string/app_description">
+		<activity android:name=".activities.MainMenuActivity"
+			android:label="@string/app_name">
+			<intent-filter>
+				<action android:name="android.intent.action.MAIN" />
+				<category android:name="android.intent.category.LAUNCHER" />
+			</intent-filter>
+		</activity>
+		<activity android:name=".activities.MapActivity" android:label="@string/app_name" android:screenOrientation="portrait">
+			<intent-filter>
+    			<data android:scheme="http" android:host="download.osmand.net" path="go"/>
+    			<action android:name="android.intent.action.VIEW" />
+    			<category android:name="android.intent.category.DEFAULT"/>
+				<category android:name="android.intent.category.BROWSABLE"/>
+			</intent-filter>
+		</activity>
+		<activity android:name=".activities.SettingsActivity" android:label="@string/settings_activity" android:configChanges="keyboardHidden|orientation"></activity>
+		<activity android:name=".activities.search.SearchActivity" android:label="@string/search_activity" ></activity>
+        <activity android:name=".activities.NavigatePointActivity"></activity>
+        <activity android:name=".activities.DownloadIndexActivity" android:configChanges="keyboardHidden|orientation"></activity>
+        <activity android:name=".activities.ShowRouteInfoActivity"></activity>
+        <activity android:name=".activities.FavouritesActivity" android:label="@string/favourites_activity"></activity>
+        <activity android:name=".activities.ContributionVersionActivity" android:label="@string/contribution_activity"></activity>
+        
+        
+        <activity android:name=".activities.search.SearchPOIActivity" android:label="@string/searchpoi_activity"></activity>
+        <activity android:name=".activities.search.SearchPoiFilterActivity"></activity>
+        <activity android:name=".activities.search.SearchAddressOnlineActivity"></activity>
+        <activity android:name=".activities.search.SearchAddressActivity"></activity>
+        <activity android:name=".activities.search.SearchTransportActivity"></activity>
+        <activity android:name=".activities.search.SearchHistoryActivity"></activity>
+        <activity android:name=".activities.search.SearchCityByNameActivity"></activity>
+        <activity android:name=".activities.search.SearchRegionByNameActivity"></activity>
+        <activity android:name=".activities.search.SearchStreetByNameActivity"></activity>
+        <activity android:name=".activities.search.SearchStreet2ByNameActivity"></activity>
+        <activity android:name=".activities.search.SearchBuildingByNameActivity"></activity>
+		<activity android:name=".activities.EditPOIFilterActivity"></activity>
+		<service android:process="net.osmand.plus" android:label="@string/process_navigation_service" android:name=".NavigationService">
+			<intent-filter><action android:name="net.osmand.plus.NavigationService"></action></intent-filter>
+		</service>
+		<receiver android:name=".OnNavigationServiceAlarmReceiver"/>
+</application>
+
+
+<!--  comment change build properties for release & set targetSdkVersion="7", build and  reverse changes-->
+<!--  <uses-sdk android:minSdkVersion="3"/> -->
+<!--   uncomment it to allow different screen supports (large/small)-->
+<uses-sdk android:minSdkVersion="3" android:targetSdkVersion="4"/>  
+
+
+<uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"></uses-permission>
+<uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"></uses-permission>
+<uses-permission android:name="android.permission.ACCESS_MOCK_LOCATION"></uses-permission>
+<uses-permission android:name="android.permission.INTERNET"></uses-permission>
+<uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"></uses-permission>
+<uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"></uses-permission>
+<uses-permission android:name="android.permission.WAKE_LOCK"></uses-permission>
+</manifest> 
diff --git a/OsmAnd/res/values/strings.xml b/OsmAnd/res/values/strings.xml
index 200d204ae1c..fcf6397cc5f 100644
--- a/OsmAnd/res/values/strings.xml
+++ b/OsmAnd/res/values/strings.xml
@@ -1,521 +1,521 @@
-<?xml version="1.0" encoding="utf-8" standalone="no"?>
-<resources>
-	<string name="unit_of_length_descr">Change unit of length and speed</string>
-	<string name="unit_of_length">Unit of length</string>
-	<string name="si_mi_foots">Miles/foots</string>
-	<string name="si_mi_yard">Miles/yards</string>
-	<string name="si_km_m">Kilometers/meters</string>
-	<string name="yard">yd</string>
-	<string name="foot">ft</string>
-	<string name="mile_per_hour">mph</string>
-	<string name="mile">mi</string>
-	<string name="send_location_way_choose_title">Share location using</string>
-	<string name="send_location_sms_pattern">I\'m here : {0}\n{1}</string>
-	<string name="send_location_email_pattern">To see location follow the web browser link {0} or android intent link {1}</string>
-	<string name="send_location">Send location</string>
-	<string name="context_menu_item_share_location">Share location</string>
-	<string name="add_waypoint_dialog_added">Waypoint \'\'{0}\'\' was successfully added</string>
-	<string name="add_waypoint_dialog_title">Add waypoint to recorded GPX track</string>
-	<string name="context_menu_item_add_waypoint">Add Gpx waypoint</string>
-	<string name="amenity_type_administrative">Administrative</string>
-	<string name="amenity_type_barrier">Barrier</string>
-	<string name="amenity_type_education">Education</string>
-	<string name="amenity_type_emergency">Emergency</string>
-	<string name="amenity_type_entertainment">Entertainment</string>
-	<string name="amenity_type_finance">Finance</string>
-	<string name="amenity_type_geocache">Geocache</string>
-	<string name="amenity_type_healthcare">Healthcare</string>
-	<string name="amenity_type_historic">Historic</string>
-	<string name="amenity_type_landuse">Landuse</string>
-	<string name="amenity_type_leisure">Leisure</string>
-	<string name="amenity_type_manmade">Man made</string>
-	<string name="amenity_type_military">Military</string>
-	<string name="amenity_type_natural">Natural</string>
-	<string name="amenity_type_office">Office</string>
-	<string name="amenity_type_other">Other</string>
-	<string name="amenity_type_shop">Shop</string>
-	<string name="amenity_type_sport">Sport</string>
-	<string name="amenity_type_sustenance">Sustenance</string>
-	<string name="amenity_type_tourism">Tourism</string>
-	<string name="amenity_type_transportation">Transportation</string>
-	<string name="indexing_address">Indexing address</string>
-	<string name="indexing_map">Indexing map</string>
-	<string name="indexing_poi">Indexing POI</string>
-	<string name="indexing_transport">Indexing transport</string>
-	<string name="input_output_error">Input output error occurred</string>
-	<string name="km">km</string>
-	<string name="km_h">km/h</string>
-	<string name="m">m</string>
-	<string name="old_map_index_is_not_supported">Deprecated format map data \'\'{0}\'\' is not supported</string>
-	<string name="poi_filter_car_aid">Car aid</string>
-	<string name="poi_filter_closest_poi">Closest poi</string>
-	<string name="poi_filter_custom_filter">Custom filter</string>
-	<string name="poi_filter_food_shop">Food shop</string>
-	<string name="poi_filter_for_tourists">For tourists</string>
-	<string name="poi_filter_fuel">Fuel</string>
-	<string name="poi_filter_namefinder">Online NameFinder</string>
-	<string name="reading_cached_tiles">Reading cached tiles...</string>
-	<string name="version_index_is_big_for_memory">The index \'\'{0}\'\' did not fit into memory</string>
-	<string name="version_index_is_not_supported">The version of index \'\'{0}\'\' is not supported</string>
-					
-	<string name="use_osmand_routing_service">OsmAnd routing</string>
-	<string name="use_osmand_routing_service_descr">Use offline routing for long distances (experimental)</string>
-	<string name="osmand_routing_experimental">OsmAnd offline routing is experimental feature and it doesn\'t work for distance more than 20 km.\n Routing service is automatically switched to online Cloudmade.</string>
-	<string name="specified_dir_doesnt_exist">Can not find specified directory.</string>
-	<string name="application_dir">Storage directory</string>
-	<string name="application_dir_change_warning">Changing storage directory will not move or delete the data. You must do it yourself! Do it at your own risk! Continue anyway?</string>
+<?xml version="1.0" encoding="utf-8" standalone="no"?>
+<resources>
+	<string name="unit_of_length_descr">Change unit of length and speed</string>
+	<string name="unit_of_length">Unit of length</string>
+	<string name="si_mi_foots">Miles/foots</string>
+	<string name="si_mi_yard">Miles/yards</string>
+	<string name="si_km_m">Kilometers/meters</string>
+	<string name="yard">yd</string>
+	<string name="foot">ft</string>
+	<string name="mile_per_hour">mph</string>
+	<string name="mile">mi</string>
+	<string name="send_location_way_choose_title">Share location using</string>
+	<string name="send_location_sms_pattern">I\'m here : {0}\n{1}</string>
+	<string name="send_location_email_pattern">To see location follow the web browser link {0} or android intent link {1}</string>
+	<string name="send_location">Send location</string>
+	<string name="context_menu_item_share_location">Share location</string>
+	<string name="add_waypoint_dialog_added">Waypoint \'\'{0}\'\' was successfully added</string>
+	<string name="add_waypoint_dialog_title">Add waypoint to recorded GPX track</string>
+	<string name="context_menu_item_add_waypoint">Add Gpx waypoint</string>
+	<string name="amenity_type_administrative">Administrative</string>
+	<string name="amenity_type_barrier">Barrier</string>
+	<string name="amenity_type_education">Education</string>
+	<string name="amenity_type_emergency">Emergency</string>
+	<string name="amenity_type_entertainment">Entertainment</string>
+	<string name="amenity_type_finance">Finance</string>
+	<string name="amenity_type_geocache">Geocache</string>
+	<string name="amenity_type_healthcare">Healthcare</string>
+	<string name="amenity_type_historic">Historic</string>
+	<string name="amenity_type_landuse">Landuse</string>
+	<string name="amenity_type_leisure">Leisure</string>
+	<string name="amenity_type_manmade">Man made</string>
+	<string name="amenity_type_military">Military</string>
+	<string name="amenity_type_natural">Natural</string>
+	<string name="amenity_type_office">Office</string>
+	<string name="amenity_type_other">Other</string>
+	<string name="amenity_type_shop">Shop</string>
+	<string name="amenity_type_sport">Sport</string>
+	<string name="amenity_type_sustenance">Sustenance</string>
+	<string name="amenity_type_tourism">Tourism</string>
+	<string name="amenity_type_transportation">Transportation</string>
+	<string name="indexing_address">Indexing address</string>
+	<string name="indexing_map">Indexing map</string>
+	<string name="indexing_poi">Indexing POI</string>
+	<string name="indexing_transport">Indexing transport</string>
+	<string name="input_output_error">Input output error occurred</string>
+	<string name="km">km</string>
+	<string name="km_h">km/h</string>
+	<string name="m">m</string>
+	<string name="old_map_index_is_not_supported">Deprecated format map data \'\'{0}\'\' is not supported</string>
+	<string name="poi_filter_car_aid">Car aid</string>
+	<string name="poi_filter_closest_poi">Closest poi</string>
+	<string name="poi_filter_custom_filter">Custom filter</string>
+	<string name="poi_filter_food_shop">Food shop</string>
+	<string name="poi_filter_for_tourists">For tourists</string>
+	<string name="poi_filter_fuel">Fuel</string>
+	<string name="poi_filter_namefinder">Online NameFinder</string>
+	<string name="reading_cached_tiles">Reading cached tiles...</string>
+	<string name="version_index_is_big_for_memory">The index \'\'{0}\'\' did not fit into memory</string>
+	<string name="version_index_is_not_supported">The version of index \'\'{0}\'\' is not supported</string>
+					
+	<string name="use_osmand_routing_service">OsmAnd routing</string>
+	<string name="use_osmand_routing_service_descr">Use offline routing for long distances (experimental)</string>
+	<string name="osmand_routing_experimental">OsmAnd offline routing is experimental feature and it doesn\'t work for distance more than 20 km.\n Routing service is automatically switched to online Cloudmade.</string>
+	<string name="specified_dir_doesnt_exist">Can not find specified directory.</string>
+	<string name="application_dir">Storage directory</string>
+	<string name="application_dir_change_warning">Changing storage directory will not move or delete the data. You must do it yourself! Do it at your own risk! Continue anyway?</string>
 
-	<string name="osmand_net_previously_installed">You have installed previous OsmAnd version. All offline data will be supported by new application. Favorite points should be exported in old application and imported.</string>
-	<string name="build_installed">Build {0} successfully installed ({1}).</string>
-	<string name="downloading_build">Downloading build...</string>
-	<string name="install_selected_build">Are you sure to install OsmAnd - {0} from {1} {2} MB.</string>
-	<string name="loading_builds_failed">Retrieving list of OsmAnd builds was failed </string>
-	<string name="loading_builds">Loading OsmAnd builds...</string>
-	<string name="select_build_to_install">Select one of the OsmAnd build to install</string>
-	<string name="contribution_activity">Special activity for contribution version</string>
-	
-	<string name="gps_status_app_not_found">GPS status application not installed. Search in Market?</string>
-	
+	<string name="osmand_net_previously_installed">You have installed previous OsmAnd version. All offline data will be supported by new application. Favorite points should be exported in old application and imported.</string>
+	<string name="build_installed">Build {0} successfully installed ({1}).</string>
+	<string name="downloading_build">Downloading build...</string>
+	<string name="install_selected_build">Are you sure to install OsmAnd - {0} from {1} {2} MB.</string>
+	<string name="loading_builds_failed">Retrieving list of OsmAnd builds was failed </string>
+	<string name="loading_builds">Loading OsmAnd builds...</string>
+	<string name="select_build_to_install">Select one of the OsmAnd build to install</string>
+	<string name="contribution_activity">Special activity for contribution version</string>
+	
+	<string name="gps_status_app_not_found">GPS status application not installed. Search in Market?</string>
+	
 	<string name="voice_is_not_available_msg">Voice guidance is not available. Please go to settings, choose preferrable voice data or download it.</string>
 	<string name="voice_is_not_available_title">Voice data is not specified</string>
-	<string name="trace_rendering_descr">Use this flag to check rendering performance</string>
-    <string name="trace_rendering">Trace rendering</string>
-	<string name="daynight_mode_day">Day</string>
-	<string name="daynight_mode_night">Night</string>
-	<string name="daynight_mode_auto">Sunrise/Sunset</string>
-	<string name="daynight_mode_sensor">Light sensor</string>
-	<string name="daynight_descr">Choose day/night mode switching rule</string>
-	<string name="daynight">Day/night mode</string>
-
-	<string name="download_files_question">Download {0} files ({1} MB)?</string>
-	<string name="items_were_selected">{0} items were selected</string>
-	<string name="filter_existing_indexes">Filter downloaded</string>
-	<string name="deselect_all">Deselect all</string>
-	<string name="select_all">Select all</string>
-	<string name="reload">Reload</string>
-	
-	<string name="general_settings_descr">Config internet usage, map rotation, screen orientation and other</string>
-    <string name="general_settings">General</string>
-	<string name="rendering_settings_descr">Config map source and appearance</string>
-    <string name="rendering_settings">Map appearance</string>
-    <string name="index_settings_descr">Get/update data for offline usage</string>
-    <string name="index_settings">Data for offline usage</string>
-	<string name="osmand_service">Background service</string>
-	<string name="osmand_service_descr">Run background service to use OsmAnd while screen off</string>
-	<string name="fast_route_mode">Fastest route</string>
-	<string name="fast_route_mode_descr">Enable for calculate fastest route or disable for shortest route </string>
-	<string name="tiles_to_download_estimated_size">At zoom {0} download {1} tiles ({2} Mb )</string>
-	<string name="context_menu_item_download_map">Download map</string>
-	<string name="select_max_zoom_preload_area">Select max zoom to preload visible area</string>
-	<string name="maps_could_not_be_downloaded">This map could not be downloaded</string>
-	
-	<string name="continuous_rendering">Continuous rendering</string>
-	<string name="continuous_rendering_descr">Choose show continuous rendering or whole image</string>
-	<string name="rendering_exception">Error occurred while rendering selected area</string>
-	<string name="rendering_out_of_memory">Not enough memory to display selected area</string>
-	<string name="show_point_options">Point options</string>
-	<string name="renderer_load_sucess">Renderer was sucessfully loaded</string>
-	<string name="renderer_load_exception">Exception occured: renderer was not loaded</string>
-	<string name="renderers">Vector renderer</string>
-	<string name="renderers_descr">Choose vector rendering style</string>
-
-	
-	<string name="poi_context_menu_website">See POI website</string>
-	<string name="poi_context_menu_call">Show POI phone</string>
-	<string name="website">web site</string>
-	<string name="phone">phone</string>
-	<string name="download_type_to_filter">type to filter</string>
-	<string name="use_high_res_maps">High resolution map</string>
-	<string name="use_high_res_maps_descr">Use high resolution map for high density devices</string>
-	<string name="unknown_location">Location unknown yet</string>
-	<string name="download_files">Download</string>
-	<string name="context_menu_item_search_transport">Search transport</string>
-	<string name="transport_searching_transport">Searching transport (no target)</string>
-	<string name="transport_searching_route">Searching transport ({0} for target)</string>
-	<string name="transport_search_none">none</string>
-	<string name="transport_search_again">Transport search again</string>
-
-	<string name="map_index">Map</string>
-	<string name="voice">Voice</string>
-	<string name="no_vector_map_loaded">Vector maps were not loaded</string>
-	<string name="gpx_reverse_route">Reverse route</string>
-	<string name="gpx_direct_route">Direct route</string>
-	<string name="map_route_by_gpx">Route using GPX</string>
-	<string name="gpx_files_not_found">GPX files were not found in /osmand/tracks directory</string>
-	<string name="layer_gpx_layer">GPX tracks...</string>
-	<string name="error_reading_gpx">Error reading GPX data</string>
-
-	<string name="vector_data">Vector OSM maps</string>
-	<string name="transport_context_menu">Search transport at stop</string>
-	<string name="point_on_map">Point on map\n Lat {0,number,#.####} Lon {1,number,#.####}</string>
-	<string name="osb_bug_name">Bug</string>
-	<string name="poi_context_menu_modify">Modify POI</string>
-	<string name="poi_context_menu_delete">Delete POI</string>
-	<string name="rotate_map_compass_opt">To compass</string>
-	<string name="rotate_map_bearing_opt">To direction of movement</string>
-    <string name="rotate_map_none_opt">Don\'t rotate</string>
-	<string name="rotate_map_to_bearing_descr">Select how to rotate map</string>
-    <string name="rotate_map_to_bearing">Rotate map</string>
-	<string name="show_route">Show route</string>
-	<string name="fav_imported_sucessfully">Favorites succesfully imported</string>
-	<string name="fav_file_to_load_not_found">GPX file containing favorites is not found at {0}</string>
-	<string name="fav_saved_sucessfully">Favorites succesfully saved to {0}</string>
-	<string name="no_fav_to_save">No favorite points to save</string>
-	<string name="import_fav">Import</string>
-	<string name="export_fav">Export</string>
-	<string name="error_occurred_loading_gpx">Error occurred while loading GPX</string>
-	<string name="send_report">Send report</string>
-	<string name="none_region_found">No regions found on SD card. Try to download regions from the Internet.</string>
-	<string name="poi_namefinder_query_empty">Input search query to find POI</string>
-	<string name="any_poi">Any</string>
-	
-	<string name="layer_transport_route">Transport route</string>
-	<string name="thanks_yandex_traffic">Thanks to Yandex for traffic information.</string>
-	<string name="layer_yandex_traffic">Yandex traffic</string>
-	<string name="layer_route">Route</string>
-	<string name="layer_favorites">Favorites</string>
-	<string name="layer_osm_bugs">OSM bugs</string>
-	<string name="layer_transport">Transport stops</string>
-	<string name="layer_poi">POI...</string>
-	<string name="layer_map">Map source...</string>
-	<string name="menu_layers">Layers</string>
-	<string name="continue_follow_previous_route">Previous route was unfinished. Continue following it?</string>
-	<string name="context_menu_item_search_poi">Search POI</string>
-	<string name="context_menu_item_show_route">Route from</string>
-	<string name="use_trackball_descr">Use trackball to move map</string>
-	<string name="use_trackball">Use trackball</string>
-	<string name="background_service_wait_int_descr">Choose wait interval for determining location</string>
-	<string name="background_service_wait_int">Wait interval</string>
-	<string name="service_stop_background_service">Switch off background navigation service</string>
-	<string name="where_am_i">Where am I?</string>
-	<string name="process_navigation_service">OsmAnd navigation service</string>
-	<string name="network_provider">Network</string>
-	<string name="gps_provider">GPS</string>
-	<string name="int_seconds">seconds</string>
-	<string name="int_min">min.</string>
-	<string name="background_service_int_descr">Choose interval to determine location for background service</string>
-	<string name="background_service_int">Positioning interval</string>
-	<string name="background_service_provider_descr">Choose location provider for background service</string>
-	<string name="background_service_provider">Location provider</string>
-	<string name="background_router_service_descr">Enable background service to track position in long time periods</string>
-	<string name="background_router_service">Router service</string>
-	<string name="off_router_service_no_gps_available">The background routing service requires a location source to be turned on.</string>
-	<string name="routing_settings_descr">Specify routing options</string>
-	<string name="routing_settings">Routing</string>
-	<string name="hide_poi_filter">Hide filter</string>
-	<string name="show_poi_filter">Show filter</string>
-	<string name="search_poi_filter">Filter</string>
-	<string name="menu_mute_off">Sound is on</string>
-	<string name="menu_mute_on">Sound is off</string>
-	<string name="voice_not_use">None</string>
-	<string name="voice_provider_descr">Choose voice data for routing</string>
-	<string name="voice_provider">Voice data</string>
-	<string name="voice_data_initializing">Initializing voice data...</string>
-	<string name="voice_data_not_supported">Unsupported version of voice data</string>
-	<string name="voice_data_corrupted">Specified voice data is corrupted</string>
-	<string name="voice_data_unavailable">Current voice data is not available</string>
-	<string name="stop_routing">Stop routing</string>
-	<string name="sd_unmounted">SD card is not accessible.\nYou won\'t be able to see the map or find anything.</string>
-	<string name="sd_mounted_ro">SD card is read-only.\nYou can only see the preloaded map and can\'t download from the Internet.</string>
-	<string name="unzipping_file">Unzipping file...</string>
-	<string name="route_tr">Turn right and go</string>
-	<string name="route_tshr">Turn sharply right and go</string>
-	<string name="route_tslr">Turn slightly right and go</string>
-	<string name="route_tl">Turn left and go</string>
-	<string name="route_tshl">Turn sharply left and go</string>
-	<string name="route_tsll">Turn slightly left and go</string>
-	<string name="route_tu">Make U-turn and go</string>
-	<string name="route_head">Head</string>
-	<string name="first_time_continue">Continue</string>
-	<string name="first_time_download">Download regions</string>
-	<string name="first_time_msg">Thank you for choosing OsmAnd. \nTo use all features of the application you need index files, which you can download (Settings -&gt; Data) or prepare yourself. Afterwards, you will be able to search by address, search for POIs, and search for public transport.</string>
-	<string name="search_poi_location">Searching signal...</string>
-	<string name="search_near_map">Search near last map location</string>
-	<string name="search_nearby">Search nearby</string>
-	<string name="map_orientation_default">Same as device</string>
-	<string name="map_orientation_portrait">Portrait</string>
-	<string name="map_orientation_landscape">Landscape</string>
-	<string name="map_screen_orientation">Map screen orientation</string>
-	<string name="map_screen_orientation_descr">Choose screen orientation</string>
-	<string name="opening_hours_not_supported">Opening hours format is not supported for editing</string>
-	<string name="add_new_rule">Add new rule</string>
-	<string name="transport_Routes">Routes</string>
-	<string name="transport_Stop">Stop</string>
-	<string name="transport_stops">stops</string>
-	
-	<string name="transport_search_after">Search route after</string>	
-	<string name="transport_search_before">Search route before</string>
-	<string name="transport_finish_search">Finish search</string>
-	<string name="transport_stop_to_go_out">Choose stop to go out</string>
-	<string name="transport_to_go_after">to go after</string>
-	<string name="transport_to_go_before">to go before</string>
-	<string name="transport_stops_to_pass">stops to pass</string>
-	<string name="transport_route_distance">Route distance</string>
-	<string name="transport">Transport</string>
-	<string name="default_buttons_ok">OK</string>
-	<string name="show_transport_over_map_description">Show public transport stops on map</string>
-	<string name="show_transport_over_map">Show transport stops</string>
-	<string name="hello">Navigation application OsmAnd</string>
-	<string name="update_poi_success">POI data was updated successfully ({0} were loaded)</string>
-	<string name="update_poi_error_local">Error updating local indexes</string>
-	<string name="update_poi_error_loading">Error while loading data from server</string>
-	<string name="update_poi_no_offline_poi_index">No offline POI indexes available for this area</string>
-	<string name="update_poi_is_not_available_for_zoom">Updating POIs is not available for small zoom levels</string>
-	<string name="context_menu_item_update_poi">Update POI</string>
-	<string name="context_menu_item_update_map_confirm">Are you sure about updating local data from the Internet?</string>
-	<string name="search_history_city">City: {0}</string>
-	<string name="search_history_street">Street: {0}, {1}</string>
-	<string name="search_history_int_streets">Intersection streets: {0} x {1} in {2}</string>
-	<string name="search_history_building">Building: {0}, {1}, {2}</string>
-	<string name="search_history_navigate_to">Navigate to lat = {0}, lon = {1}</string>
-	<string name="favorite">Favorite</string>
-	<string name="clear_all">Clear all</string>
-	<string name="history">History</string>
-	<string name="uploading_data">Uploading data...</string>
-	<string name="uploading">Uploading</string>
-	<string name="search_nothing_found">Nothing was found</string>
-	<string name="searching">Searching</string>
-	<string name="searching_address">Searching address...</string>
-	<string name="search_osm_nominatim">Search address using OSM Nominatim</string>
-	<string name="hint_search_online">House number, street, city</string>
-	<string name="search_offline_address">Offline</string>
-	<string name="search_online_address">Internet</string>
-	<string name="max_level_download_tile">Max zoom level</string>
-	<string name="max_level_download_tile_descr">Choose max zoom level to download</string>
-	<string name="route_about">About route</string>
-	<string name="route_general_information">Total distance {0}, travelling time {1} h {2} m.</string>
-	<string name="router_service_descr">Choose routing service</string>
-	<string name="router_service">Routing</string>
-	<string name="sd_dir_not_accessible">Directory on SD card to save is not accessible</string>
-	<string name="download_question">Download {0} - {1} ?</string>
-	<string name="download_question_exist">Offline data for {0} already exists ({1}). Do you want to update it ({2}) ?</string>
-	<string name="address">Address</string>
-	<string name="download_index_success">Download successful</string>
-	<string name="error_io_error">Input/output error occured</string>
-	<string name="downloading_file">Downloading file...</string>
-	<string name="downloading">Downloading...</string>
-	<string name="downloading_list_indexes">Downloading list of available regions</string>
-	<string name="list_index_files_was_not_loaded">The list of regions was not retrieved from osmand.googlecode.com.</string>
-    <string name="select_index_file_to_download">If you can\'t find your region, you can make it yourself. See osmand.net</string>
-	<string name="show_poi_on_map">Show on map</string>
-	<string name="fav_points_edited">Favorite point was edited</string>
-	<string name="fav_points_not_exist">None of favorite points exist</string>
-	<string name="update_existing">Replace</string>
-	<string name="only_show">Only show</string>
-	<string name="follow">Follow</string>
-	<string name="recalculate_route_to_your_location">Recalculate route according to your location</string>
-	<string name="follow_route">Follow to the route</string>
-	<string name="mark_final_location_first">Please select destination first</string>
-	<string name="get_directions">Directions</string>
-    <string name="show_gps_status">Show GPS status</string>
-	<string name="opening_hours">Opening hours</string>
-	<string name="opening_changeset">Openging changeset...</string>
-	<string name="closing_changeset">Closing changeset...</string>
-	<string name="commiting_node">Committing node...</string>
-	<string name="loading_poi_obj">Loading POI...</string>
-	<string name="auth_failed">Authorization failed</string>
-	<string name="failed_op">failed</string>
-	<string name="converting_names">Converting native/English names...</string>
-	<string name="loading_streets_buildings">Loading streets/buildings...</string>
-	<string name="loading_postcodes">Loading postcodes...</string>
-	<string name="loading_streets">Loading streets...</string>
-	<string name="loading_cities">Loading cities...</string>
-	<string name="loading">Loading</string>
-	<string name="poi">POI</string>
-	<string name="error_occurred_saving_gpx">Error while saving GPX</string>
-	<string name="error_calculating_route">Error calculating route</string>
-	<string name="error_calculating_route_occured">Error occurred while calculating route</string>
-	<string name="empty_route_calculated">Empty route is calculated</string>									
-	<string name="new_route_calculated_dist">New route is calculated, distance</string>
-	<string name="arrived_at_destination">You arrived at the destination point</string>
-	<string name="invalid_locations">Locations are invalid</string>
-	<string name="go_back_to_osmand">Go back to OsmAnd map</string>
-	<string name="close">Close</string>
-	<string name="loading_data">Loading data</string>
-	<string name="reading_indexes">Reading indices...</string>
-	<string name="previous_run_crashed">Previous application run was crashed. Log file is at {0}. Please raise the issue and attach log file.</string>
-	<string name="saving_gpx_tracks">Saving GPX tracks to SD...</string>
-	<string name="finished_task">Finished</string>
-    <string name="reload_indexes_descr">Reload offline data from SD card</string>
-    <string name="reload_indexes">Reload offline data</string>
-    <string name="download_indexes_descr">Download data for offline usage from the Internet</string>
-    <string name="download_indexes">Download offline data</string>
-    <string name="use_online_routing_descr">Use Internet to calculate route</string>
-    <string name="use_online_routing">Use online routing</string>
-    <string name="user_password_descr">Your OSM password</string>
-    <string name="user_password">User password</string>
-    <string name="osm_settings_descr">Specify OSM settings: OSM login</string>
-    <string name="monitor_preferences_descr">Specify monitoring settings</string>
-    <string name="data_settings_descr">Specify language, download/reload data</string>
-    <string name="data_settings">Data</string>
-    <string name="map_preferences_descr">Specify map settings: map source, rotation, center position, screen orientation</string>
-    <string name="osm_settings">OSM</string>
-    <string name="auto_zoom_map_descr">Auto zoom map according to your speed</string>
-    <string name="auto_zoom_map">Auto zoom map</string>
-    <string name="additional_settings">Additional settings</string>
-    <string name="settings_preset_descr">Select predefined settings</string>
-    <string name="settings_preset">Application mode</string>
-    <string name="settings">Settings</string>
-    <string name="save_current_track_descr">Save current track to SD</string>
-    <string name="save_current_track">Save current track</string>
-    <string name="save_track_interval_descr">Choose time interval to save track</string>
-    <string name="save_track_interval">Save track interval</string>
-    <string name="monitor_preferences">Monitoring</string>
-    <string name="save_track_to_gpx_descrp">Tracks will be saved to track directory grouped by days</string>
-    <string name="save_track_to_gpx">Save track to GPX</string>
-    <string name="navigate_to">Navigate to</string>
-    <string name="update_tile">Update map</string>
-    <string name="reload_tile">Reload tile</string>
-    <string name="user_name_descr">Your OSM user name</string>
-    <string name="user_name">User name</string>
-    <string name="mark_point">Target</string>
-    <string name="show_osm_bugs_descr">Show OpenStreetBugs on map</string>
-    <string name="show_osm_bugs">Show OpenStreetBugs</string>
-    <string name="favourites_activity">List of favorite points</string>
-    <string name="add_to_favourite">Add to Favorites</string>
-    <string name="use_english_names_descr">Select between native and English names</string>
-    <string name="use_english_names">Use english names</string>
-    <string name="app_settings">Application settings</string>
-    <string name="search_address">Search address</string>
-    <string name="choose_building">Choose building</string>
-    <string name="choose_street">Choose street</string>
-    <string name="choose_city">Choose city</string>
-    <string name="ChooseCountry">Choose country</string>
-    <string name="position_on_map_descr">Choose position on the map</string>
-    <string name="position_on_map">Position on the map</string>
-    <string name="map_specify_point">Specify point</string>
-    <string name="show_view_angle_descr">Show aspect of view based on compass</string>
-    <string name="show_view_angle">Show aspect of view</string>
-    <string name="stop_navigation">Clear point</string>
-    <string name="navigate_to_point">Mark point</string>
-    <string name="map_view_3d_descr">Enable 3D view of the map</string>
-    <string name="map_view_3d">Map View 3D</string>
-    
-    <string name="show_poi_over_map_description">Show POI over map (use last chosen filter)</string>
-    <string name="show_poi_over_map">Show POI</string>
-    <string name="map_tile_source_descr">Choose the source of tiles: </string>
-    <string name="map_tile_source">Map tile source</string>
-    <string name="map_source">Map source</string>
-    <string name="use_internet">Use Internet</string>
-    <string name="show_location">Show location</string>
-    <string name="map_preferences">Map</string>
-    <string name="settings_activity">Settings</string>
-    <string name="show_gps_coordinates_text">Show GPS coordinates on map</string>
-    <string name="use_internet_to_download_tile">Use Internet to download missing tiles</string>
-    <string name="app_name">OsmAnd</string>
-    <string name="app_description">Navigation application</string>
-
-<string name="exit_Button">Exit</string>
-<string name="map_Button">Map</string>
-<string name="settings_Button">Settings</string>
-<string name="favorites_Button">Favorites</string>
-<string name="search_button">Search</string>
-<color name="menu_background">#FF9030</color>
-<string name="search_activity">Search</string>
-<color name="color_white">#FFFFFF</color>
-<color name="color_red">#FF0000</color>
-<string name="searchpoi_activity">Choose POI</string>
-<string name="search_POI_level_btn">Find more</string>
-<string name="incremental_search_city">Search city incrementally. To find towns/postcodes, enter the first 3 or more characters.</string>
-<string name="incremental_search_street">Search street incrementally</string>
-<string name="incremental_search_building">Search building incrementally</string>
-<string name="choose_available_region">Choose region from list</string>
-<string name="choose_intersected_street">Choose intersected street</string>
-<string name="Closest_Amenities">Closest amenities</string>
-<string name="app_mode_default">Default</string>
-<string name="app_mode_car">Car</string>
-<string name="app_mode_bicycle">Bicycle</string>
-<string name="app_mode_pedestrian">Pedestrian</string>
-<string name="position_on_map_center">Center</string>
-<string name="position_on_map_bottom">Bottom</string>
-<string name="navigate_point_top_text">Input latitude &amp; longitude in the selected format (D - degrees, M - minutes, S - seconds)</string>
-<string name="navigate_point_latitude">Latitude</string>
-<string name="navigate_point_longitude">Longitude</string>
-<string name="navigate_point_format_D">DDD.DDDDD</string>
-<string name="navigate_point_format_DM">DDD MM.MMMMM</string>
-<string name="navigate_point_format_DMS">DDD MM SS.SSSSS</string>
-<string name="search_shown_on_map">Show on map</string>
-<string name="navigate_point_cancel">Cancel</string>
-<string name="search_address_top_text">Select address</string>
-<string name="search_address_region">Region</string>
-<string name="search_address_city">City</string>
-<string name="search_address_street">Street</string>
-<string name="search_address_building">Building</string>
-<string name="search_address_building_option">Building</string>
-<string name="search_address_street_option">Intersected street</string>
-
-<string name="search_tabs_location">Location</string>
-
-<string name="context_menu_item_navigate_point">Navigate to point</string>
-<string name="context_menu_item_add_favorite">Add to favorites</string>
-<string name="context_menu_item_update_map">Update map</string>
-<string name="context_menu_item_open_bug">Open OSM bug</string>
-<string name="context_menu_item_create_poi">Create POI</string>
-
-<string name="default_buttons_yes">Yes</string>
-<string name="default_buttons_cancel">Cancel</string>
-<string name="default_buttons_apply">Apply</string>
-<string name="default_buttons_add">Add</string>
-<string name="default_buttons_no">No</string>
-<string name="add_favorite_dialog_top_text">Enter favorite name</string>
-<string name="add_favorite_dialog_default_favourite_name">Favorite</string>
-<string name="add_favorite_dialog_favourite_added_template">Favorite point \'\'{0}\'\' was added successfully.</string>
-
-<string name="favourites_context_menu_title">Context menu</string>
-<string name="favourites_context_menu_navigate">Navigate to</string>
-<string name="favourites_context_menu_edit">Edit favorite</string>
-<string name="favourites_context_menu_delete">Delete favorite</string>
-<string name="favourites_edit_dialog_title">Rename favorite</string>
-
-<string name="favourites_remove_dialog_title">Are you sure about removing favourite point?</string>
-<string name="favourites_remove_dialog_success">Favourite point {0} was succesfully deleted.</string>
-
-<string name="osb_add_dialog_title">Enter bug text</string>
-<string name="osb_add_dialog_success">Bug successfully created</string>
-<string name="osb_add_dialog_error">Exception occured: bug was not created</string>
-
-<string name="osb_comment_menu_item">Add comment</string>
-<string name="osb_comment_dialog_message">Message</string>
-<string name="osb_comment_dialog_author">Author name</string>
-<string name="osb_comment_dialog_title">Adding comment to bug</string>
-<string name="osb_comment_dialog_add_button">Add comment</string>
-<string name="osb_comment_dialog_success">Comment was successfully added</string>
-<string name="osb_comment_dialog_error">Exception occured: comment was not added</string>
-
-<string name="osb_close_menu_item">Close bug</string>
-<string name="osb_close_dialog_title">Closing bug</string>
-<string name="osb_close_dialog_close_button">Close bug</string>
-<string name="osb_close_dialog_success">Bug was successfully closed</string>
-<string name="osb_close_dialog_error">Exception occured : bug was not closed</string>
-
-<string name="poi_edit_title">Edit POI</string>
-<string name="poi_create_title">Create POI</string>
-<string name="poi_error_poi_not_found">Node can not be found or amenity is not a single node</string>
-<string name="poi_remove_confirm_template">Delete {0} (enter comment) ?</string>
-<string name="poi_remove_title">Delete POI</string>
-<string name="default_buttons_delete">Delete</string>
-<string name="poi_remove_success">POI was successfully deleted</string>
-<string name="poi_action_add">add</string>
-<string name="poi_action_change">change</string>
-<string name="poi_action_succeded_template">Action {0} completed successfully.</string>
-<string name="poi_error_unexpected_template">Unexpected error occured while performing action {0}.</string>
-<string name="poi_error_io_error_template">Input/output error occured while performing action {0}.</string>
-
-<string name="poi_error_info_not_loaded">Info about node was not loaded</string>
-
-<string name="poi_dialog_name">Name</string>
-<string name="poi_dialog_opening_hours">Opened</string>
-<string name="poi_dialog_comment">Comment</string>
-<string name="poi_dialog_comment_default">POI changing</string>
-<string name="poi_dialog_other_tags_message">All other tags are preserved</string>
-<string name="default_buttons_commit">Commit</string>
-<string name="default_buttons_reset">Reset</string>
-<string name="filter_current_poiButton">Filter</string>
-<string name="edit_filter_delete_menu_item">Delete</string>
-<string name="edit_filter_save_as_menu_item">Save As</string>
-<string name="edit_filter_delete_dialog_title">Delete selected filter?</string>
-<string name="edit_filter_delete_message">Filter {0} has been deleted</string>
-<string name="edit_filter_create_message">Filter {0} has been created</string>
-<string name="default_buttons_selectall">Select All</string>
-
+	<string name="trace_rendering_descr">Use this flag to check rendering performance</string>
+    <string name="trace_rendering">Trace rendering</string>
+	<string name="daynight_mode_day">Day</string>
+	<string name="daynight_mode_night">Night</string>
+	<string name="daynight_mode_auto">Sunrise/Sunset</string>
+	<string name="daynight_mode_sensor">Light sensor</string>
+	<string name="daynight_descr">Choose day/night mode switching rule</string>
+	<string name="daynight">Day/night mode</string>
+
+	<string name="download_files_question">Download {0} files ({1} MB)?</string>
+	<string name="items_were_selected">{0} items were selected</string>
+	<string name="filter_existing_indexes">Filter downloaded</string>
+	<string name="deselect_all">Deselect all</string>
+	<string name="select_all">Select all</string>
+	<string name="reload">Reload</string>
+	
+	<string name="general_settings_descr">Config internet usage, map rotation, screen orientation and other</string>
+    <string name="general_settings">General</string>
+	<string name="rendering_settings_descr">Config map source and appearance</string>
+    <string name="rendering_settings">Map appearance</string>
+    <string name="index_settings_descr">Get/update data for offline usage</string>
+    <string name="index_settings">Data for offline usage</string>
+	<string name="osmand_service">Background service</string>
+	<string name="osmand_service_descr">Run background service to use OsmAnd while screen off</string>
+	<string name="fast_route_mode">Fastest route</string>
+	<string name="fast_route_mode_descr">Enable for calculate fastest route or disable for shortest route </string>
+	<string name="tiles_to_download_estimated_size">At zoom {0} download {1} tiles ({2} Mb )</string>
+	<string name="context_menu_item_download_map">Download map</string>
+	<string name="select_max_zoom_preload_area">Select max zoom to preload visible area</string>
+	<string name="maps_could_not_be_downloaded">This map could not be downloaded</string>
+	
+	<string name="continuous_rendering">Continuous rendering</string>
+	<string name="continuous_rendering_descr">Choose show continuous rendering or whole image</string>
+	<string name="rendering_exception">Error occurred while rendering selected area</string>
+	<string name="rendering_out_of_memory">Not enough memory to display selected area</string>
+	<string name="show_point_options">Point options</string>
+	<string name="renderer_load_sucess">Renderer was sucessfully loaded</string>
+	<string name="renderer_load_exception">Exception occured: renderer was not loaded</string>
+	<string name="renderers">Vector renderer</string>
+	<string name="renderers_descr">Choose vector rendering style</string>
+
+	
+	<string name="poi_context_menu_website">See POI website</string>
+	<string name="poi_context_menu_call">Show POI phone</string>
+	<string name="website">web site</string>
+	<string name="phone">phone</string>
+	<string name="download_type_to_filter">type to filter</string>
+	<string name="use_high_res_maps">High resolution map</string>
+	<string name="use_high_res_maps_descr">Use high resolution map for high density devices</string>
+	<string name="unknown_location">Location unknown yet</string>
+	<string name="download_files">Download</string>
+	<string name="context_menu_item_search_transport">Search transport</string>
+	<string name="transport_searching_transport">Searching transport (no target)</string>
+	<string name="transport_searching_route">Searching transport ({0} for target)</string>
+	<string name="transport_search_none">none</string>
+	<string name="transport_search_again">Transport search again</string>
+
+	<string name="map_index">Map</string>
+	<string name="voice">Voice</string>
+	<string name="no_vector_map_loaded">Vector maps were not loaded</string>
+	<string name="gpx_reverse_route">Reverse route</string>
+	<string name="gpx_direct_route">Direct route</string>
+	<string name="map_route_by_gpx">Route using GPX</string>
+	<string name="gpx_files_not_found">GPX files were not found in /osmand/tracks directory</string>
+	<string name="layer_gpx_layer">GPX tracks...</string>
+	<string name="error_reading_gpx">Error reading GPX data</string>
+
+	<string name="vector_data">Vector OSM maps</string>
+	<string name="transport_context_menu">Search transport at stop</string>
+	<string name="point_on_map">Point on map\n Lat {0,number,#.####} Lon {1,number,#.####}</string>
+	<string name="osb_bug_name">Bug</string>
+	<string name="poi_context_menu_modify">Modify POI</string>
+	<string name="poi_context_menu_delete">Delete POI</string>
+	<string name="rotate_map_compass_opt">To compass</string>
+	<string name="rotate_map_bearing_opt">To direction of movement</string>
+    <string name="rotate_map_none_opt">Don\'t rotate</string>
+	<string name="rotate_map_to_bearing_descr">Select how to rotate map</string>
+    <string name="rotate_map_to_bearing">Rotate map</string>
+	<string name="show_route">Show route</string>
+	<string name="fav_imported_sucessfully">Favorites succesfully imported</string>
+	<string name="fav_file_to_load_not_found">GPX file containing favorites is not found at {0}</string>
+	<string name="fav_saved_sucessfully">Favorites succesfully saved to {0}</string>
+	<string name="no_fav_to_save">No favorite points to save</string>
+	<string name="import_fav">Import</string>
+	<string name="export_fav">Export</string>
+	<string name="error_occurred_loading_gpx">Error occurred while loading GPX</string>
+	<string name="send_report">Send report</string>
+	<string name="none_region_found">No regions found on SD card. Try to download regions from the Internet.</string>
+	<string name="poi_namefinder_query_empty">Input search query to find POI</string>
+	<string name="any_poi">Any</string>
+	
+	<string name="layer_transport_route">Transport route</string>
+	<string name="thanks_yandex_traffic">Thanks to Yandex for traffic information.</string>
+	<string name="layer_yandex_traffic">Yandex traffic</string>
+	<string name="layer_route">Route</string>
+	<string name="layer_favorites">Favorites</string>
+	<string name="layer_osm_bugs">OSM bugs</string>
+	<string name="layer_transport">Transport stops</string>
+	<string name="layer_poi">POI...</string>
+	<string name="layer_map">Map source...</string>
+	<string name="menu_layers">Layers</string>
+	<string name="continue_follow_previous_route">Previous route was unfinished. Continue following it?</string>
+	<string name="context_menu_item_search_poi">Search POI</string>
+	<string name="context_menu_item_show_route">Route from</string>
+	<string name="use_trackball_descr">Use trackball to move map</string>
+	<string name="use_trackball">Use trackball</string>
+	<string name="background_service_wait_int_descr">Choose wait interval for determining location</string>
+	<string name="background_service_wait_int">Wait interval</string>
+	<string name="service_stop_background_service">Switch off background navigation service</string>
+	<string name="where_am_i">Where am I?</string>
+	<string name="process_navigation_service">OsmAnd navigation service</string>
+	<string name="network_provider">Network</string>
+	<string name="gps_provider">GPS</string>
+	<string name="int_seconds">seconds</string>
+	<string name="int_min">min.</string>
+	<string name="background_service_int_descr">Choose interval to determine location for background service</string>
+	<string name="background_service_int">Positioning interval</string>
+	<string name="background_service_provider_descr">Choose location provider for background service</string>
+	<string name="background_service_provider">Location provider</string>
+	<string name="background_router_service_descr">Enable background service to track position in long time periods</string>
+	<string name="background_router_service">Router service</string>
+	<string name="off_router_service_no_gps_available">The background routing service requires a location source to be turned on.</string>
+	<string name="routing_settings_descr">Specify routing options</string>
+	<string name="routing_settings">Routing</string>
+	<string name="hide_poi_filter">Hide filter</string>
+	<string name="show_poi_filter">Show filter</string>
+	<string name="search_poi_filter">Filter</string>
+	<string name="menu_mute_off">Sound is on</string>
+	<string name="menu_mute_on">Sound is off</string>
+	<string name="voice_not_use">None</string>
+	<string name="voice_provider_descr">Choose voice data for routing</string>
+	<string name="voice_provider">Voice data</string>
+	<string name="voice_data_initializing">Initializing voice data...</string>
+	<string name="voice_data_not_supported">Unsupported version of voice data</string>
+	<string name="voice_data_corrupted">Specified voice data is corrupted</string>
+	<string name="voice_data_unavailable">Current voice data is not available</string>
+	<string name="stop_routing">Stop routing</string>
+	<string name="sd_unmounted">SD card is not accessible.\nYou won\'t be able to see the map or find anything.</string>
+	<string name="sd_mounted_ro">SD card is read-only.\nYou can only see the preloaded map and can\'t download from the Internet.</string>
+	<string name="unzipping_file">Unzipping file...</string>
+	<string name="route_tr">Turn right and go</string>
+	<string name="route_tshr">Turn sharply right and go</string>
+	<string name="route_tslr">Turn slightly right and go</string>
+	<string name="route_tl">Turn left and go</string>
+	<string name="route_tshl">Turn sharply left and go</string>
+	<string name="route_tsll">Turn slightly left and go</string>
+	<string name="route_tu">Make U-turn and go</string>
+	<string name="route_head">Head</string>
+	<string name="first_time_continue">Continue</string>
+	<string name="first_time_download">Download regions</string>
+	<string name="first_time_msg">Thank you for choosing OsmAnd. \nTo use all features of the application you need index files, which you can download (Settings -&gt; Data) or prepare yourself. Afterwards, you will be able to search by address, search for POIs, and search for public transport.</string>
+	<string name="search_poi_location">Searching signal...</string>
+	<string name="search_near_map">Search near last map location</string>
+	<string name="search_nearby">Search nearby</string>
+	<string name="map_orientation_default">Same as device</string>
+	<string name="map_orientation_portrait">Portrait</string>
+	<string name="map_orientation_landscape">Landscape</string>
+	<string name="map_screen_orientation">Map screen orientation</string>
+	<string name="map_screen_orientation_descr">Choose screen orientation</string>
+	<string name="opening_hours_not_supported">Opening hours format is not supported for editing</string>
+	<string name="add_new_rule">Add new rule</string>
+	<string name="transport_Routes">Routes</string>
+	<string name="transport_Stop">Stop</string>
+	<string name="transport_stops">stops</string>
+	
+	<string name="transport_search_after">Search route after</string>	
+	<string name="transport_search_before">Search route before</string>
+	<string name="transport_finish_search">Finish search</string>
+	<string name="transport_stop_to_go_out">Choose stop to go out</string>
+	<string name="transport_to_go_after">to go after</string>
+	<string name="transport_to_go_before">to go before</string>
+	<string name="transport_stops_to_pass">stops to pass</string>
+	<string name="transport_route_distance">Route distance</string>
+	<string name="transport">Transport</string>
+	<string name="default_buttons_ok">OK</string>
+	<string name="show_transport_over_map_description">Show public transport stops on map</string>
+	<string name="show_transport_over_map">Show transport stops</string>
+	<string name="hello">Navigation application OsmAnd</string>
+	<string name="update_poi_success">POI data was updated successfully ({0} were loaded)</string>
+	<string name="update_poi_error_local">Error updating local indexes</string>
+	<string name="update_poi_error_loading">Error while loading data from server</string>
+	<string name="update_poi_no_offline_poi_index">No offline POI indexes available for this area</string>
+	<string name="update_poi_is_not_available_for_zoom">Updating POIs is not available for small zoom levels</string>
+	<string name="context_menu_item_update_poi">Update POI</string>
+	<string name="context_menu_item_update_map_confirm">Are you sure about updating local data from the Internet?</string>
+	<string name="search_history_city">City: {0}</string>
+	<string name="search_history_street">Street: {0}, {1}</string>
+	<string name="search_history_int_streets">Intersection streets: {0} x {1} in {2}</string>
+	<string name="search_history_building">Building: {0}, {1}, {2}</string>
+	<string name="search_history_navigate_to">Navigate to lat = {0}, lon = {1}</string>
+	<string name="favorite">Favorite</string>
+	<string name="clear_all">Clear all</string>
+	<string name="history">History</string>
+	<string name="uploading_data">Uploading data...</string>
+	<string name="uploading">Uploading</string>
+	<string name="search_nothing_found">Nothing was found</string>
+	<string name="searching">Searching</string>
+	<string name="searching_address">Searching address...</string>
+	<string name="search_osm_nominatim">Search address using OSM Nominatim</string>
+	<string name="hint_search_online">House number, street, city</string>
+	<string name="search_offline_address">Offline</string>
+	<string name="search_online_address">Internet</string>
+	<string name="max_level_download_tile">Max zoom level</string>
+	<string name="max_level_download_tile_descr">Choose max zoom level to download</string>
+	<string name="route_about">About route</string>
+	<string name="route_general_information">Total distance {0}, travelling time {1} h {2} m.</string>
+	<string name="router_service_descr">Choose routing service</string>
+	<string name="router_service">Routing</string>
+	<string name="sd_dir_not_accessible">Directory on SD card to save is not accessible</string>
+	<string name="download_question">Download {0} - {1} ?</string>
+	<string name="download_question_exist">Offline data for {0} already exists ({1}). Do you want to update it ({2}) ?</string>
+	<string name="address">Address</string>
+	<string name="download_index_success">Download successful</string>
+	<string name="error_io_error">Input/output error occured</string>
+	<string name="downloading_file">Downloading file...</string>
+	<string name="downloading">Downloading...</string>
+	<string name="downloading_list_indexes">Downloading list of available regions</string>
+	<string name="list_index_files_was_not_loaded">The list of regions was not retrieved from osmand.googlecode.com.</string>
+    <string name="select_index_file_to_download">If you can\'t find your region, you can make it yourself. See osmand.net</string>
+	<string name="show_poi_on_map">Show on map</string>
+	<string name="fav_points_edited">Favorite point was edited</string>
+	<string name="fav_points_not_exist">None of favorite points exist</string>
+	<string name="update_existing">Replace</string>
+	<string name="only_show">Only show</string>
+	<string name="follow">Follow</string>
+	<string name="recalculate_route_to_your_location">Recalculate route according to your location</string>
+	<string name="follow_route">Follow to the route</string>
+	<string name="mark_final_location_first">Please select destination first</string>
+	<string name="get_directions">Directions</string>
+    <string name="show_gps_status">Show GPS status</string>
+	<string name="opening_hours">Opening hours</string>
+	<string name="opening_changeset">Openging changeset...</string>
+	<string name="closing_changeset">Closing changeset...</string>
+	<string name="commiting_node">Committing node...</string>
+	<string name="loading_poi_obj">Loading POI...</string>
+	<string name="auth_failed">Authorization failed</string>
+	<string name="failed_op">failed</string>
+	<string name="converting_names">Converting native/English names...</string>
+	<string name="loading_streets_buildings">Loading streets/buildings...</string>
+	<string name="loading_postcodes">Loading postcodes...</string>
+	<string name="loading_streets">Loading streets...</string>
+	<string name="loading_cities">Loading cities...</string>
+	<string name="loading">Loading</string>
+	<string name="poi">POI</string>
+	<string name="error_occurred_saving_gpx">Error while saving GPX</string>
+	<string name="error_calculating_route">Error calculating route</string>
+	<string name="error_calculating_route_occured">Error occurred while calculating route</string>
+	<string name="empty_route_calculated">Empty route is calculated</string>									
+	<string name="new_route_calculated_dist">New route is calculated, distance</string>
+	<string name="arrived_at_destination">You arrived at the destination point</string>
+	<string name="invalid_locations">Locations are invalid</string>
+	<string name="go_back_to_osmand">Go back to OsmAnd map</string>
+	<string name="close">Close</string>
+	<string name="loading_data">Loading data</string>
+	<string name="reading_indexes">Reading indices...</string>
+	<string name="previous_run_crashed">Previous application run was crashed. Log file is at {0}. Please raise the issue and attach log file.</string>
+	<string name="saving_gpx_tracks">Saving GPX tracks to SD...</string>
+	<string name="finished_task">Finished</string>
+    <string name="reload_indexes_descr">Reload offline data from SD card</string>
+    <string name="reload_indexes">Reload offline data</string>
+    <string name="download_indexes_descr">Download data for offline usage from the Internet</string>
+    <string name="download_indexes">Download offline data</string>
+    <string name="use_online_routing_descr">Use Internet to calculate route</string>
+    <string name="use_online_routing">Use online routing</string>
+    <string name="user_password_descr">Your OSM password</string>
+    <string name="user_password">User password</string>
+    <string name="osm_settings_descr">Specify OSM settings: OSM login</string>
+    <string name="monitor_preferences_descr">Specify monitoring settings</string>
+    <string name="data_settings_descr">Specify language, download/reload data</string>
+    <string name="data_settings">Data</string>
+    <string name="map_preferences_descr">Specify map settings: map source, rotation, center position, screen orientation</string>
+    <string name="osm_settings">OSM</string>
+    <string name="auto_zoom_map_descr">Auto zoom map according to your speed</string>
+    <string name="auto_zoom_map">Auto zoom map</string>
+    <string name="additional_settings">Additional settings</string>
+    <string name="settings_preset_descr">Select predefined settings</string>
+    <string name="settings_preset">Application mode</string>
+    <string name="settings">Settings</string>
+    <string name="save_current_track_descr">Save current track to SD</string>
+    <string name="save_current_track">Save current track</string>
+    <string name="save_track_interval_descr">Choose time interval to save track</string>
+    <string name="save_track_interval">Save track interval</string>
+    <string name="monitor_preferences">Monitoring</string>
+    <string name="save_track_to_gpx_descrp">Tracks will be saved to track directory grouped by days</string>
+    <string name="save_track_to_gpx">Save track to GPX</string>
+    <string name="navigate_to">Navigate to</string>
+    <string name="update_tile">Update map</string>
+    <string name="reload_tile">Reload tile</string>
+    <string name="user_name_descr">Your OSM user name</string>
+    <string name="user_name">User name</string>
+    <string name="mark_point">Target</string>
+    <string name="show_osm_bugs_descr">Show OpenStreetBugs on map</string>
+    <string name="show_osm_bugs">Show OpenStreetBugs</string>
+    <string name="favourites_activity">List of favorite points</string>
+    <string name="add_to_favourite">Add to Favorites</string>
+    <string name="use_english_names_descr">Select between native and English names</string>
+    <string name="use_english_names">Use english names</string>
+    <string name="app_settings">Application settings</string>
+    <string name="search_address">Search address</string>
+    <string name="choose_building">Choose building</string>
+    <string name="choose_street">Choose street</string>
+    <string name="choose_city">Choose city</string>
+    <string name="ChooseCountry">Choose country</string>
+    <string name="position_on_map_descr">Choose position on the map</string>
+    <string name="position_on_map">Position on the map</string>
+    <string name="map_specify_point">Specify point</string>
+    <string name="show_view_angle_descr">Show aspect of view based on compass</string>
+    <string name="show_view_angle">Show aspect of view</string>
+    <string name="stop_navigation">Clear point</string>
+    <string name="navigate_to_point">Mark point</string>
+    <string name="map_view_3d_descr">Enable 3D view of the map</string>
+    <string name="map_view_3d">Map View 3D</string>
+    
+    <string name="show_poi_over_map_description">Show POI over map (use last chosen filter)</string>
+    <string name="show_poi_over_map">Show POI</string>
+    <string name="map_tile_source_descr">Choose the source of tiles: </string>
+    <string name="map_tile_source">Map tile source</string>
+    <string name="map_source">Map source</string>
+    <string name="use_internet">Use Internet</string>
+    <string name="show_location">Show location</string>
+    <string name="map_preferences">Map</string>
+    <string name="settings_activity">Settings</string>
+    <string name="show_gps_coordinates_text">Show GPS coordinates on map</string>
+    <string name="use_internet_to_download_tile">Use Internet to download missing tiles</string>
+    <string name="app_name">OsmAnd</string>
+    <string name="app_description">Navigation application</string>
+
+<string name="exit_Button">Exit</string>
+<string name="map_Button">Map</string>
+<string name="settings_Button">Settings</string>
+<string name="favorites_Button">Favorites</string>
+<string name="search_button">Search</string>
+<color name="menu_background">#FF9030</color>
+<string name="search_activity">Search</string>
+<color name="color_white">#FFFFFF</color>
+<color name="color_red">#FF0000</color>
+<string name="searchpoi_activity">Choose POI</string>
+<string name="search_POI_level_btn">Find more</string>
+<string name="incremental_search_city">Search city incrementally. To find towns/postcodes, enter the first 3 or more characters.</string>
+<string name="incremental_search_street">Search street incrementally</string>
+<string name="incremental_search_building">Search building incrementally</string>
+<string name="choose_available_region">Choose region from list</string>
+<string name="choose_intersected_street">Choose intersected street</string>
+<string name="Closest_Amenities">Closest amenities</string>
+<string name="app_mode_default">Default</string>
+<string name="app_mode_car">Car</string>
+<string name="app_mode_bicycle">Bicycle</string>
+<string name="app_mode_pedestrian">Pedestrian</string>
+<string name="position_on_map_center">Center</string>
+<string name="position_on_map_bottom">Bottom</string>
+<string name="navigate_point_top_text">Input latitude &amp; longitude in the selected format (D - degrees, M - minutes, S - seconds)</string>
+<string name="navigate_point_latitude">Latitude</string>
+<string name="navigate_point_longitude">Longitude</string>
+<string name="navigate_point_format_D">DDD.DDDDD</string>
+<string name="navigate_point_format_DM">DDD MM.MMMMM</string>
+<string name="navigate_point_format_DMS">DDD MM SS.SSSSS</string>
+<string name="search_shown_on_map">Show on map</string>
+<string name="navigate_point_cancel">Cancel</string>
+<string name="search_address_top_text">Select address</string>
+<string name="search_address_region">Region</string>
+<string name="search_address_city">City</string>
+<string name="search_address_street">Street</string>
+<string name="search_address_building">Building</string>
+<string name="search_address_building_option">Building</string>
+<string name="search_address_street_option">Intersected street</string>
+
+<string name="search_tabs_location">Location</string>
+
+<string name="context_menu_item_navigate_point">Navigate to point</string>
+<string name="context_menu_item_add_favorite">Add to favorites</string>
+<string name="context_menu_item_update_map">Update map</string>
+<string name="context_menu_item_open_bug">Open OSM bug</string>
+<string name="context_menu_item_create_poi">Create POI</string>
+
+<string name="default_buttons_yes">Yes</string>
+<string name="default_buttons_cancel">Cancel</string>
+<string name="default_buttons_apply">Apply</string>
+<string name="default_buttons_add">Add</string>
+<string name="default_buttons_no">No</string>
+<string name="add_favorite_dialog_top_text">Enter favorite name</string>
+<string name="add_favorite_dialog_default_favourite_name">Favorite</string>
+<string name="add_favorite_dialog_favourite_added_template">Favorite point \'\'{0}\'\' was added successfully.</string>
+
+<string name="favourites_context_menu_title">Context menu</string>
+<string name="favourites_context_menu_navigate">Navigate to</string>
+<string name="favourites_context_menu_edit">Edit favorite</string>
+<string name="favourites_context_menu_delete">Delete favorite</string>
+<string name="favourites_edit_dialog_title">Rename favorite</string>
+
+<string name="favourites_remove_dialog_title">Are you sure about removing favourite point?</string>
+<string name="favourites_remove_dialog_success">Favourite point {0} was succesfully deleted.</string>
+
+<string name="osb_add_dialog_title">Enter bug text</string>
+<string name="osb_add_dialog_success">Bug successfully created</string>
+<string name="osb_add_dialog_error">Exception occured: bug was not created</string>
+
+<string name="osb_comment_menu_item">Add comment</string>
+<string name="osb_comment_dialog_message">Message</string>
+<string name="osb_comment_dialog_author">Author name</string>
+<string name="osb_comment_dialog_title">Adding comment to bug</string>
+<string name="osb_comment_dialog_add_button">Add comment</string>
+<string name="osb_comment_dialog_success">Comment was successfully added</string>
+<string name="osb_comment_dialog_error">Exception occured: comment was not added</string>
+
+<string name="osb_close_menu_item">Close bug</string>
+<string name="osb_close_dialog_title">Closing bug</string>
+<string name="osb_close_dialog_close_button">Close bug</string>
+<string name="osb_close_dialog_success">Bug was successfully closed</string>
+<string name="osb_close_dialog_error">Exception occured : bug was not closed</string>
+
+<string name="poi_edit_title">Edit POI</string>
+<string name="poi_create_title">Create POI</string>
+<string name="poi_error_poi_not_found">Node can not be found or amenity is not a single node</string>
+<string name="poi_remove_confirm_template">Delete {0} (enter comment) ?</string>
+<string name="poi_remove_title">Delete POI</string>
+<string name="default_buttons_delete">Delete</string>
+<string name="poi_remove_success">POI was successfully deleted</string>
+<string name="poi_action_add">add</string>
+<string name="poi_action_change">change</string>
+<string name="poi_action_succeded_template">Action {0} completed successfully.</string>
+<string name="poi_error_unexpected_template">Unexpected error occured while performing action {0}.</string>
+<string name="poi_error_io_error_template">Input/output error occured while performing action {0}.</string>
+
+<string name="poi_error_info_not_loaded">Info about node was not loaded</string>
+
+<string name="poi_dialog_name">Name</string>
+<string name="poi_dialog_opening_hours">Opened</string>
+<string name="poi_dialog_comment">Comment</string>
+<string name="poi_dialog_comment_default">POI changing</string>
+<string name="poi_dialog_other_tags_message">All other tags are preserved</string>
+<string name="default_buttons_commit">Commit</string>
+<string name="default_buttons_reset">Reset</string>
+<string name="filter_current_poiButton">Filter</string>
+<string name="edit_filter_delete_menu_item">Delete</string>
+<string name="edit_filter_save_as_menu_item">Save As</string>
+<string name="edit_filter_delete_dialog_title">Delete selected filter?</string>
+<string name="edit_filter_delete_message">Filter {0} has been deleted</string>
+<string name="edit_filter_create_message">Filter {0} has been created</string>
+<string name="default_buttons_selectall">Select All</string>
+
 </resources>
\ No newline at end of file
diff --git a/OsmAnd/src/net/osmand/plus/activities/MainMenuActivity.java b/OsmAnd/src/net/osmand/plus/activities/MainMenuActivity.java
index 9ad3f4283b4..1b2094111ef 100644
--- a/OsmAnd/src/net/osmand/plus/activities/MainMenuActivity.java
+++ b/OsmAnd/src/net/osmand/plus/activities/MainMenuActivity.java
@@ -1,245 +1,245 @@
-package net.osmand.plus.activities;
-
-import java.io.File;
-import java.text.MessageFormat;
-
-import net.osmand.Version;
-import net.osmand.plus.OsmandSettings;
-import net.osmand.plus.R;
-import net.osmand.plus.ResourceManager;
-import net.osmand.plus.activities.search.SearchActivity;
-import android.app.Activity;
-import android.app.AlertDialog;
-import android.app.AlertDialog.Builder;
-import android.content.DialogInterface;
-import android.content.Intent;
-import android.content.SharedPreferences;
-import android.content.pm.ApplicationInfo;
-import android.content.pm.PackageInfo;
-import android.content.pm.PackageManager;
-import android.content.pm.PackageManager.NameNotFoundException;
-import android.net.Uri;
-import android.os.Build;
-import android.os.Bundle;
-import android.text.SpannableString;
-import android.text.method.LinkMovementMethod;
-import android.text.style.ClickableSpan;
-import android.view.KeyEvent;
-import android.view.View;
-import android.view.Window;
-import android.view.View.OnClickListener;
-import android.view.animation.AccelerateInterpolator;
-import android.view.animation.Animation;
-import android.view.animation.TranslateAnimation;
-import android.widget.TextView;
-
-public class MainMenuActivity extends Activity {
-
-	private static final String FIRST_TIME_APP_RUN = "FIRST_TIME_APP_RUN"; //$NON-NLS-1$
-	private static final String EXCEPTION_FILE_SIZE = ResourceManager.APP_DIR + "exception.log"; //$NON-NLS-1$
-	
-	private View showMap;
-	private View settingsButton;
-	private View searchButton;
-	private View favouritesButton;
-	private View closeButton;
-	
-	private static final String CONTRIBUTION_VERSION_FLAG = "CONTRIBUTION_VERSION_FLAG";
-
-	
-	public void checkPreviousRunsForExceptions(boolean firstTime) {
-		long size = getPreferences(MODE_WORLD_READABLE).getLong(EXCEPTION_FILE_SIZE, 0);
-		final File file = OsmandSettings.extendOsmandPath(getApplicationContext(), OsmandApplication.EXCEPTION_PATH);
-		if (file.exists() && file.length() > 0) {
-			if (size != file.length() && !firstTime) {
-				String msg = MessageFormat.format(getString(R.string.previous_run_crashed), OsmandApplication.EXCEPTION_PATH);
-				Builder builder = new AlertDialog.Builder(MainMenuActivity.this);
-				builder.setMessage(msg).setNeutralButton(getString(R.string.close), null);
-				builder.setPositiveButton(R.string.send_report, new DialogInterface.OnClickListener() {
-					@Override
-					public void onClick(DialogInterface dialog, int which) {
-						Intent intent = new Intent(Intent.ACTION_SEND);
-						intent.putExtra(Intent.EXTRA_EMAIL, new String[] { "osmand.app@gmail.com" }); //$NON-NLS-1$
-						intent.putExtra(Intent.EXTRA_STREAM, Uri.fromFile(file));
-						intent.setType("vnd.android.cursor.dir/email"); //$NON-NLS-1$
-						intent.putExtra(Intent.EXTRA_SUBJECT, "OsmAnd bug"); //$NON-NLS-1$
-						StringBuilder text = new StringBuilder();
-						text.append("\nDevice : ").append(Build.DEVICE); //$NON-NLS-1$
-						text.append("\nBrand : ").append(Build.BRAND); //$NON-NLS-1$
-						text.append("\nModel : ").append(Build.MODEL); //$NON-NLS-1$
-						text.append("\nProduct : ").append(Build.PRODUCT); //$NON-NLS-1$
-						text.append("\nBuild : ").append(Build.DISPLAY); //$NON-NLS-1$
-						text.append("\nVersion : ").append(Build.VERSION.RELEASE); //$NON-NLS-1$
-						text.append("\nApp Version : ").append(Version.APP_NAME_VERSION); //$NON-NLS-1$
-						try {
-							PackageInfo info = getPackageManager().getPackageInfo(getPackageName(), 0);
-							if (info != null) {
-								text.append("\nApk Version : ").append(info.versionName).append(" ").append(info.versionCode); //$NON-NLS-1$ //$NON-NLS-2$
-							}
-						} catch (NameNotFoundException e) {
-						}
-						intent.putExtra(Intent.EXTRA_TEXT, text.toString());
-						startActivity(Intent.createChooser(intent, getString(R.string.send_report)));
-					}
-
-				});
-				builder.show();
-			}
-			getPreferences(MODE_WORLD_READABLE).edit().putLong(EXCEPTION_FILE_SIZE, file.length()).commit();
-		} else {
-			if (size > 0) {
-				getPreferences(MODE_WORLD_READABLE).edit().putLong(EXCEPTION_FILE_SIZE, 0).commit();
-			}
-		}
-	}
-	
-	public Animation getAnimation(int left, int top){
-		Animation anim = new TranslateAnimation(TranslateAnimation.RELATIVE_TO_SELF, left, 
-				TranslateAnimation.RELATIVE_TO_SELF, 0, TranslateAnimation.RELATIVE_TO_SELF, top, TranslateAnimation.RELATIVE_TO_SELF, 0);
-		anim.setDuration(700);
-		anim.setInterpolator(new AccelerateInterpolator());
-		return anim;
-	}
-	
-	@Override
-	protected void onCreate(Bundle savedInstanceState) {
-		super.onCreate(savedInstanceState);
-
-		requestWindowFeature(Window.FEATURE_NO_TITLE);
-		setContentView(R.layout.menu);
-		View head = (View) findViewById(R.id.Headliner);
-		head.startAnimation(getAnimation(0, -1));
-		
-		View leftview = (View) findViewById(R.id.MapButton);
-		leftview.startAnimation(getAnimation(-1, 0));
-		leftview = (View) findViewById(R.id.FavoritesButton);
-		leftview.startAnimation(getAnimation(-1, 0));
-		
-		View rightview = (View) findViewById(R.id.SettingsButton);
-		rightview.startAnimation(getAnimation(1, 0));
-		rightview = (View) findViewById(R.id.SearchButton);
-		rightview.startAnimation(getAnimation(1, 0));
-		
-		String textVersion = Version.APP_VERSION+ " "+ Version.APP_DESCRIPTION;
-		final TextView textVersionView = (TextView) findViewById(R.id.TextVersion);
-		textVersionView.setText(textVersion);
-		SharedPreferences prefs = OsmandSettings.getPrefs(this);
-		
-		// only one commit should be with contribution version flag
-		// prefs.edit().putBoolean(CONTRIBUTION_VERSION_FLAG, true).commit();
-		if (prefs.contains(CONTRIBUTION_VERSION_FLAG)) {
-			final TextView appName = (TextView) findViewById(R.id.AppName);
-			appName.setText("OsmAnd!");
-			SpannableString content = new SpannableString(textVersion);
-			content.setSpan(new ClickableSpan() {
-				
-				@Override
-				public void onClick(View widget) {
-					final Intent mapIndent = new Intent(MainMenuActivity.this, ContributionVersionActivity.class);
-					startActivityForResult(mapIndent, 0);					
-				}
-			}, 0, content.length(), 0);
-			textVersionView.setText(content);
-			textVersionView.setMovementMethod(LinkMovementMethod.getInstance());
-		}
-		
-
-		showMap = findViewById(R.id.MapButton);
-		showMap.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				final Intent mapIndent = new Intent(MainMenuActivity.this, MapActivity.class);
-				startActivityForResult(mapIndent, 0);
-			}
-		});
-		settingsButton = findViewById(R.id.SettingsButton);
-		settingsButton.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				final Intent settings = new Intent(MainMenuActivity.this, SettingsActivity.class);
-				startActivity(settings);
-			}
-		});
-		
-		favouritesButton = findViewById(R.id.FavoritesButton);
-		favouritesButton.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				final Intent settings = new Intent(MainMenuActivity.this, FavouritesActivity.class);
-				startActivity(settings);
-			}
-		});
-		
-		closeButton = findViewById(R.id.CloseButton);
-		closeButton.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				((OsmandApplication) getApplication()).closeApplication();
-				finish();
-			}
-		});
-		
-		searchButton = findViewById(R.id.SearchButton);
-		searchButton.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				final Intent search = new Intent(MainMenuActivity.this, SearchActivity.class);
-				startActivity(search);
-			}
-		});
-		
-		
-		((OsmandApplication)getApplication()).checkApplicationIsBeingInitialized(this);
-		
-		
-		SharedPreferences pref = getPreferences(MODE_WORLD_WRITEABLE);
-		boolean firstTime = false;
-		if(!pref.contains(FIRST_TIME_APP_RUN)){
-			firstTime = true;
-			pref.edit().putBoolean(FIRST_TIME_APP_RUN, true).commit();
-			
-			boolean netOsmandWasInstalled = false;
-			try {
-				ApplicationInfo applicationInfo = getPackageManager().getApplicationInfo("net.osmand", PackageManager.GET_META_DATA);
-				netOsmandWasInstalled = applicationInfo != null;
-			} catch (NameNotFoundException e) {
-				netOsmandWasInstalled = false;
-			}
-			
-			if(netOsmandWasInstalled){
-				Builder builder = new AlertDialog.Builder(this);
-				builder.setMessage(R.string.osmand_net_previously_installed);
-				builder.setPositiveButton(R.string.default_buttons_ok, null);
-				builder.show();
-			} else {
-				Builder builder = new AlertDialog.Builder(this);
-				builder.setMessage(R.string.first_time_msg);
-				builder.setPositiveButton(R.string.first_time_download, new DialogInterface.OnClickListener() {
-
-					@Override
-					public void onClick(DialogInterface dialog, int which) {
-						startActivity(new Intent(MainMenuActivity.this, DownloadIndexActivity.class));
-					}
-
-				});
-				builder.setNegativeButton(R.string.first_time_continue, null);
-				builder.show();
-			}
-		}
-		checkPreviousRunsForExceptions(firstTime);
-	}
-	
-
-    @Override
-    public boolean onKeyDown(int keyCode, KeyEvent event) {
-        if (keyCode == KeyEvent.KEYCODE_SEARCH
-                && event.getRepeatCount() == 0) {
-			final Intent search = new Intent(MainMenuActivity.this, SearchActivity.class);
-			startActivity(search);
-            return true;
-        }
-        return super.onKeyDown(keyCode, event);
-    }
-	
-	
-}
+package net.osmand.plus.activities;
+
+import java.io.File;
+import java.text.MessageFormat;
+
+import net.osmand.Version;
+import net.osmand.plus.OsmandSettings;
+import net.osmand.plus.R;
+import net.osmand.plus.ResourceManager;
+import net.osmand.plus.activities.search.SearchActivity;
+import android.app.Activity;
+import android.app.AlertDialog;
+import android.app.AlertDialog.Builder;
+import android.content.DialogInterface;
+import android.content.Intent;
+import android.content.SharedPreferences;
+import android.content.pm.ApplicationInfo;
+import android.content.pm.PackageInfo;
+import android.content.pm.PackageManager;
+import android.content.pm.PackageManager.NameNotFoundException;
+import android.net.Uri;
+import android.os.Build;
+import android.os.Bundle;
+import android.text.SpannableString;
+import android.text.method.LinkMovementMethod;
+import android.text.style.ClickableSpan;
+import android.view.KeyEvent;
+import android.view.View;
+import android.view.Window;
+import android.view.View.OnClickListener;
+import android.view.animation.AccelerateInterpolator;
+import android.view.animation.Animation;
+import android.view.animation.TranslateAnimation;
+import android.widget.TextView;
+
+public class MainMenuActivity extends Activity {
+
+	private static final String FIRST_TIME_APP_RUN = "FIRST_TIME_APP_RUN"; //$NON-NLS-1$
+	private static final String EXCEPTION_FILE_SIZE = ResourceManager.APP_DIR + "exception.log"; //$NON-NLS-1$
+	
+	private View showMap;
+	private View settingsButton;
+	private View searchButton;
+	private View favouritesButton;
+	private View closeButton;
+	
+	private static final String CONTRIBUTION_VERSION_FLAG = "CONTRIBUTION_VERSION_FLAG";
+
+	
+	public void checkPreviousRunsForExceptions(boolean firstTime) {
+		long size = getPreferences(MODE_WORLD_READABLE).getLong(EXCEPTION_FILE_SIZE, 0);
+		final File file = OsmandSettings.extendOsmandPath(getApplicationContext(), OsmandApplication.EXCEPTION_PATH);
+		if (file.exists() && file.length() > 0) {
+			if (size != file.length() && !firstTime) {
+				String msg = MessageFormat.format(getString(R.string.previous_run_crashed), OsmandApplication.EXCEPTION_PATH);
+				Builder builder = new AlertDialog.Builder(MainMenuActivity.this);
+				builder.setMessage(msg).setNeutralButton(getString(R.string.close), null);
+				builder.setPositiveButton(R.string.send_report, new DialogInterface.OnClickListener() {
+					@Override
+					public void onClick(DialogInterface dialog, int which) {
+						Intent intent = new Intent(Intent.ACTION_SEND);
+						intent.putExtra(Intent.EXTRA_EMAIL, new String[] { "osmand.app@gmail.com" }); //$NON-NLS-1$
+						intent.putExtra(Intent.EXTRA_STREAM, Uri.fromFile(file));
+						intent.setType("vnd.android.cursor.dir/email"); //$NON-NLS-1$
+						intent.putExtra(Intent.EXTRA_SUBJECT, "OsmAnd bug"); //$NON-NLS-1$
+						StringBuilder text = new StringBuilder();
+						text.append("\nDevice : ").append(Build.DEVICE); //$NON-NLS-1$
+						text.append("\nBrand : ").append(Build.BRAND); //$NON-NLS-1$
+						text.append("\nModel : ").append(Build.MODEL); //$NON-NLS-1$
+						text.append("\nProduct : ").append(Build.PRODUCT); //$NON-NLS-1$
+						text.append("\nBuild : ").append(Build.DISPLAY); //$NON-NLS-1$
+						text.append("\nVersion : ").append(Build.VERSION.RELEASE); //$NON-NLS-1$
+						text.append("\nApp Version : ").append(Version.APP_NAME_VERSION); //$NON-NLS-1$
+						try {
+							PackageInfo info = getPackageManager().getPackageInfo(getPackageName(), 0);
+							if (info != null) {
+								text.append("\nApk Version : ").append(info.versionName).append(" ").append(info.versionCode); //$NON-NLS-1$ //$NON-NLS-2$
+							}
+						} catch (NameNotFoundException e) {
+						}
+						intent.putExtra(Intent.EXTRA_TEXT, text.toString());
+						startActivity(Intent.createChooser(intent, getString(R.string.send_report)));
+					}
+
+				});
+				builder.show();
+			}
+			getPreferences(MODE_WORLD_READABLE).edit().putLong(EXCEPTION_FILE_SIZE, file.length()).commit();
+		} else {
+			if (size > 0) {
+				getPreferences(MODE_WORLD_READABLE).edit().putLong(EXCEPTION_FILE_SIZE, 0).commit();
+			}
+		}
+	}
+	
+	public Animation getAnimation(int left, int top){
+		Animation anim = new TranslateAnimation(TranslateAnimation.RELATIVE_TO_SELF, left, 
+				TranslateAnimation.RELATIVE_TO_SELF, 0, TranslateAnimation.RELATIVE_TO_SELF, top, TranslateAnimation.RELATIVE_TO_SELF, 0);
+		anim.setDuration(700);
+		anim.setInterpolator(new AccelerateInterpolator());
+		return anim;
+	}
+	
+	@Override
+	protected void onCreate(Bundle savedInstanceState) {
+		super.onCreate(savedInstanceState);
+
+		requestWindowFeature(Window.FEATURE_NO_TITLE);
+		setContentView(R.layout.menu);
+		View head = (View) findViewById(R.id.Headliner);
+		head.startAnimation(getAnimation(0, -1));
+		
+		View leftview = (View) findViewById(R.id.MapButton);
+		leftview.startAnimation(getAnimation(-1, 0));
+		leftview = (View) findViewById(R.id.FavoritesButton);
+		leftview.startAnimation(getAnimation(-1, 0));
+		
+		View rightview = (View) findViewById(R.id.SettingsButton);
+		rightview.startAnimation(getAnimation(1, 0));
+		rightview = (View) findViewById(R.id.SearchButton);
+		rightview.startAnimation(getAnimation(1, 0));
+		
+		String textVersion = Version.APP_VERSION+ " "+ Version.APP_DESCRIPTION;
+		final TextView textVersionView = (TextView) findViewById(R.id.TextVersion);
+		textVersionView.setText(textVersion);
+		SharedPreferences prefs = OsmandSettings.getPrefs(this);
+		
+		// only one commit should be with contribution version flag
+		// prefs.edit().putBoolean(CONTRIBUTION_VERSION_FLAG, true).commit();
+		if (prefs.contains(CONTRIBUTION_VERSION_FLAG)) {
+			final TextView appName = (TextView) findViewById(R.id.AppName);
+			appName.setText("OsmAnd!");
+			SpannableString content = new SpannableString(textVersion);
+			content.setSpan(new ClickableSpan() {
+				
+				@Override
+				public void onClick(View widget) {
+					final Intent mapIndent = new Intent(MainMenuActivity.this, ContributionVersionActivity.class);
+					startActivityForResult(mapIndent, 0);					
+				}
+			}, 0, content.length(), 0);
+			textVersionView.setText(content);
+			textVersionView.setMovementMethod(LinkMovementMethod.getInstance());
+		}
+		
+
+		showMap = findViewById(R.id.MapButton);
+		showMap.setOnClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				final Intent mapIndent = new Intent(MainMenuActivity.this, MapActivity.class);
+				startActivityForResult(mapIndent, 0);
+			}
+		});
+		settingsButton = findViewById(R.id.SettingsButton);
+		settingsButton.setOnClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				final Intent settings = new Intent(MainMenuActivity.this, SettingsActivity.class);
+				startActivity(settings);
+			}
+		});
+		
+		favouritesButton = findViewById(R.id.FavoritesButton);
+		favouritesButton.setOnClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				final Intent settings = new Intent(MainMenuActivity.this, FavouritesActivity.class);
+				startActivity(settings);
+			}
+		});
+		
+		closeButton = findViewById(R.id.CloseButton);
+		closeButton.setOnClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				((OsmandApplication) getApplication()).closeApplication();
+				finish();
+			}
+		});
+		
+		searchButton = findViewById(R.id.SearchButton);
+		searchButton.setOnClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				final Intent search = new Intent(MainMenuActivity.this, SearchActivity.class);
+				startActivity(search);
+			}
+		});
+		
+		
+		((OsmandApplication)getApplication()).checkApplicationIsBeingInitialized(this);
+		
+		
+		SharedPreferences pref = getPreferences(MODE_WORLD_WRITEABLE);
+		boolean firstTime = false;
+		if(!pref.contains(FIRST_TIME_APP_RUN)){
+			firstTime = true;
+			pref.edit().putBoolean(FIRST_TIME_APP_RUN, true).commit();
+			
+			boolean netOsmandWasInstalled = false;
+			try {
+				ApplicationInfo applicationInfo = getPackageManager().getApplicationInfo("net.osmand", PackageManager.GET_META_DATA);
+				netOsmandWasInstalled = applicationInfo != null;
+			} catch (NameNotFoundException e) {
+				netOsmandWasInstalled = false;
+			}
+			
+			if(netOsmandWasInstalled){
+				Builder builder = new AlertDialog.Builder(this);
+				builder.setMessage(R.string.osmand_net_previously_installed);
+				builder.setPositiveButton(R.string.default_buttons_ok, null);
+				builder.show();
+			} else {
+				Builder builder = new AlertDialog.Builder(this);
+				builder.setMessage(R.string.first_time_msg);
+				builder.setPositiveButton(R.string.first_time_download, new DialogInterface.OnClickListener() {
+
+					@Override
+					public void onClick(DialogInterface dialog, int which) {
+						startActivity(new Intent(MainMenuActivity.this, DownloadIndexActivity.class));
+					}
+
+				});
+				builder.setNegativeButton(R.string.first_time_continue, null);
+				builder.show();
+			}
+		}
+		checkPreviousRunsForExceptions(firstTime);
+	}
+	
+
+    @Override
+    public boolean onKeyDown(int keyCode, KeyEvent event) {
+        if (keyCode == KeyEvent.KEYCODE_SEARCH
+                && event.getRepeatCount() == 0) {
+			final Intent search = new Intent(MainMenuActivity.this, SearchActivity.class);
+			startActivity(search);
+            return true;
+        }
+        return super.onKeyDown(keyCode, event);
+    }
+	
+	
+}
diff --git a/OsmAnd/src/net/osmand/plus/activities/MapActivity.java b/OsmAnd/src/net/osmand/plus/activities/MapActivity.java
index 81ff71025bb..20a9fe40e34 100644
--- a/OsmAnd/src/net/osmand/plus/activities/MapActivity.java
+++ b/OsmAnd/src/net/osmand/plus/activities/MapActivity.java
@@ -1,1636 +1,1636 @@
-package net.osmand.plus.activities;
-
-import java.io.File;
-import java.text.MessageFormat;
-import java.util.ArrayList;
-import java.util.Arrays;
-import java.util.Collection;
-import java.util.Collections;
-import java.util.Comparator;
-import java.util.Iterator;
-import java.util.List;
-import java.util.Map;
-
-import net.osmand.Algoritms;
-import net.osmand.FavouritePoint;
-import net.osmand.GPXUtilities;
-import net.osmand.LogUtil;
-import net.osmand.OsmAndFormatter;
-import net.osmand.Version;
-import net.osmand.GPXUtilities.GPXFileResult;
-import net.osmand.GPXUtilities.WptPt;
-import net.osmand.data.Amenity;
-import net.osmand.data.AmenityType;
-import net.osmand.data.preparation.MapTileDownloader;
-import net.osmand.data.preparation.MapTileDownloader.DownloadRequest;
-import net.osmand.data.preparation.MapTileDownloader.IMapDownloaderCallback;
-import net.osmand.map.IMapLocationListener;
-import net.osmand.map.ITileSource;
-import net.osmand.osm.LatLon;
-import net.osmand.osm.MapUtils;
-import net.osmand.plus.AmenityIndexRepository;
-import net.osmand.plus.AmenityIndexRepositoryOdb;
-import net.osmand.plus.BusyIndicator;
-import net.osmand.plus.FavouritesDbHelper;
-import net.osmand.plus.OsmandSettings;
-import net.osmand.plus.PoiFilter;
-import net.osmand.plus.PoiFiltersHelper;
-import net.osmand.plus.R;
-import net.osmand.plus.ResourceManager;
-import net.osmand.plus.SQLiteTileSource;
-import net.osmand.plus.OsmandSettings.ApplicationMode;
-import net.osmand.plus.activities.search.SearchActivity;
-import net.osmand.plus.activities.search.SearchPoiFilterActivity;
-import net.osmand.plus.activities.search.SearchTransportActivity;
-import net.osmand.plus.render.MapRenderRepositories;
-import net.osmand.plus.render.RendererLayer;
-import net.osmand.plus.views.AnimateDraggingMapThread;
-import net.osmand.plus.views.ContextMenuLayer;
-import net.osmand.plus.views.FavoritesLayer;
-import net.osmand.plus.views.GPXLayer;
-import net.osmand.plus.views.MapInfoLayer;
-import net.osmand.plus.views.OsmBugsLayer;
-import net.osmand.plus.views.OsmandMapTileView;
-import net.osmand.plus.views.POIMapLayer;
-import net.osmand.plus.views.PointLocationLayer;
-import net.osmand.plus.views.PointNavigationLayer;
-import net.osmand.plus.views.RouteInfoLayer;
-import net.osmand.plus.views.RouteLayer;
-import net.osmand.plus.views.TransportInfoLayer;
-import net.osmand.plus.views.TransportStopsLayer;
-import net.osmand.plus.views.YandexTrafficLayer;
-import android.app.Activity;
-import android.app.AlertDialog;
-import android.app.Dialog;
-import android.app.Notification;
-import android.app.NotificationManager;
-import android.app.PendingIntent;
-import android.app.ProgressDialog;
-import android.app.AlertDialog.Builder;
-import android.content.ActivityNotFoundException;
-import android.content.ComponentName;
-import android.content.DialogInterface;
-import android.content.Intent;
-import android.content.SharedPreferences;
-import android.content.SharedPreferences.Editor;
-import android.content.pm.PackageManager;
-import android.content.pm.ResolveInfo;
-import android.content.res.Resources;
-import android.graphics.Rect;
-import android.graphics.RectF;
-import android.hardware.Sensor;
-import android.hardware.SensorEvent;
-import android.hardware.SensorEventListener;
-import android.hardware.SensorManager;
-import android.location.Location;
-import android.location.LocationListener;
-import android.location.LocationManager;
-import android.location.LocationProvider;
-import android.media.AudioManager;
-import android.net.Uri;
-import android.os.Build;
-import android.os.Bundle;
-import android.os.Environment;
-import android.os.Handler;
-import android.os.Looper;
-import android.os.Message;
-import android.os.PowerManager;
-import android.os.PowerManager.WakeLock;
-import android.text.ClipboardManager;
-import android.text.Html;
-import android.util.FloatMath;
-import android.util.Log;
-import android.view.KeyEvent;
-import android.view.Menu;
-import android.view.MenuInflater;
-import android.view.MenuItem;
-import android.view.MotionEvent;
-import android.view.View;
-import android.view.Window;
-import android.view.View.OnClickListener;
-import android.widget.CompoundButton;
-import android.widget.EditText;
-import android.widget.ImageButton;
-import android.widget.LinearLayout;
-import android.widget.Toast;
-import android.widget.ToggleButton;
-import android.widget.ZoomControls;
-
-public class MapActivity extends Activity implements IMapLocationListener, SensorEventListener {
-
-	private static final String GPS_STATUS_ACTIVITY = "com.eclipsim.gpsstatus2.GPSStatus"; //$NON-NLS-1$
-	private static final String GPS_STATUS_COMPONENT = "com.eclipsim.gpsstatus2"; //$NON-NLS-1$
-	
-	// stupid error but anyway hero 2.1 : always lost gps signal (temporarily unavailable) for timeout = 2000
-	private static final int GPS_TIMEOUT_REQUEST = 1000;
-	private static final int GPS_DIST_REQUEST = 5;
-	// use only gps (not network) for 12 seconds 
-	private static final int USE_ONLY_GPS_INTERVAL = 12000; 
-	
-	private boolean providerSupportsBearing = false;
-	@SuppressWarnings("unused")
-	private boolean providerSupportsSpeed = false;
-	private String currentLocationProvider = null;
-	private long lastTimeAutoZooming = 0;
-	private long lastTimeGPXLocationFixed = 0;
-	
-    /** Called when the activity is first created. */
-	private OsmandMapTileView mapView;
-	private MapActivityActions mapActions = new MapActivityActions(this);
-	
-	private ImageButton backToLocation;
-	private ImageButton backToMenu;
-	
-	// the order of layer should be preserved ! when you are inserting new layer
-	private RendererLayer rendererLayer;
-	private GPXLayer gpxLayer;
-	private RouteLayer routeLayer;
-	private YandexTrafficLayer trafficLayer;
-	private OsmBugsLayer osmBugsLayer;
-	private POIMapLayer poiMapLayer;
-	private FavoritesLayer favoritesLayer;
-	private TransportStopsLayer transportStopsLayer;
-	private TransportInfoLayer transportInfoLayer;
-	private PointLocationLayer locationLayer;
-	private PointNavigationLayer navigationLayer;
-	private MapInfoLayer mapInfoLayer;
-	private ContextMenuLayer contextMenuLayer;
-	private RouteInfoLayer routeInfoLayer;
-	
-	private SavingTrackHelper savingTrackHelper;
-	private RoutingHelper routingHelper;
-	
-	
-	private WakeLock wakeLock;
-	private boolean sensorRegistered = false;
-
-	private NotificationManager mNotificationManager;
-	private Handler mapPositionHandler = null;
-	private int APP_NOTIFICATION_ID;
-	private int currentScreenOrientation;
-	private int currentMapRotation;
-	private boolean currentShowingAngle;
-	
-	private Dialog progressDlg = null;
-	private SharedPreferences settings;
-	
-	private boolean isMapLinkedToLocation(){
-		return OsmandSettings.isMapSyncToGpsLocation(settings);
-	}
-	
-	private Notification getNotification(){
-		Intent notificationIndent = new Intent(this, MapActivity.class);
-		notificationIndent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK);
-		Notification notification = new Notification(R.drawable.icon, "", //$NON-NLS-1$
-				System.currentTimeMillis());
-		notification.setLatestEventInfo(this, Version.APP_NAME,
-				getString(R.string.go_back_to_osmand), PendingIntent.getActivity(
-						this, 0, notificationIndent,
-						PendingIntent.FLAG_UPDATE_CURRENT));
-		return notification;
-	}
-	
-    @Override
-    public void onCreate(Bundle savedInstanceState) {
-		super.onCreate(savedInstanceState);
-		settings = OsmandSettings.getPrefs(this);		
-		// for voice navigation
-		setVolumeControlStream(AudioManager.STREAM_MUSIC);
-		requestWindowFeature(Window.FEATURE_NO_TITLE); 
-		// Full screen is not used here
-//	     getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);
-		setContentView(R.layout.main);
-		ProgressDialog dlg = ((OsmandApplication)getApplication()).checkApplicationIsBeingInitialized(this);
-		if(dlg != null){
-			// Do some action on close
-			dlg.setOnDismissListener(new DialogInterface.OnDismissListener(){
-				@Override
-				public void onDismiss(DialogInterface dialog) {
-					OsmandApplication app = ((OsmandApplication)getApplication());
-					if(OsmandSettings.isUsingMapVectorData(settings) && app.getResourceManager().getRenderer().isEmpty()){
-						Toast.makeText(MapActivity.this, getString(R.string.no_vector_map_loaded), Toast.LENGTH_LONG).show();
-					}
-				}
-			});
-		}
-		parseLaunchIntentLocation();
-		
-		mapView = (OsmandMapTileView) findViewById(R.id.MapView);
-		mapView.setTrackBallDelegate(new OsmandMapTileView.OnTrackBallListener(){
-			@Override
-			public boolean onTrackBallEvent(MotionEvent e) {
-				showAndHideMapPosition();
-				return MapActivity.this.onTrackballEvent(e);
-			}
-
-		});
-		MapTileDownloader.getInstance().addDownloaderCallback(new IMapDownloaderCallback(){
-			@Override
-			public void tileDownloaded(DownloadRequest request) {
-				if(request != null && !request.error && request.fileToSave != null){
-					ResourceManager mgr = ((OsmandApplication)getApplication()).getResourceManager();
-					mgr.tileDownloaded(request);
-				}
-				mapView.tileDownloaded(request);
-				
-			}
-		});
-		
-		mapView.setMapLocationListener(this);
-		routingHelper = ((OsmandApplication) getApplication()).getRoutingHelper();
-		
-		// 0.5 layer
-		rendererLayer = new RendererLayer();
-		mapView.addLayer(rendererLayer, 0.5f);
-		
-		// 0.6 gpx layer
-		gpxLayer = new GPXLayer();
-		mapView.addLayer(gpxLayer, 0.6f);
-		
-		// 1. route layer
-		routeLayer = new RouteLayer(routingHelper);
-		mapView.addLayer(routeLayer, 1);
-		
-		// 1.5. traffic layer
-		trafficLayer = new YandexTrafficLayer();
-		mapView.addLayer(trafficLayer, 1.5f);
-		
-		
-		// 2. osm bugs layer
-		osmBugsLayer = new OsmBugsLayer(this);
-		// 3. poi layer
-		poiMapLayer = new POIMapLayer();
-		// 4. favorites layer
-		favoritesLayer = new FavoritesLayer();
-		// 5. transport layer
-		transportStopsLayer = new TransportStopsLayer();
-		// 5.5 transport info layer 
-		transportInfoLayer = new TransportInfoLayer(TransportRouteHelper.getInstance());
-		mapView.addLayer(transportInfoLayer, 5.5f);
-		// 6. point navigation layer
-		navigationLayer = new PointNavigationLayer();
-		mapView.addLayer(navigationLayer, 6);
-		// 7. point location layer 
-		locationLayer = new PointLocationLayer();
-		mapView.addLayer(locationLayer, 7);
-		// 8. map info layer
-		mapInfoLayer = new MapInfoLayer(this, routeLayer);
-		mapView.addLayer(mapInfoLayer, 8);
-		// 9. context menu layer 
-		contextMenuLayer = new ContextMenuLayer(this);
-		mapView.addLayer(contextMenuLayer, 9);
-		// 10. route info layer
-		routeInfoLayer = new RouteInfoLayer(routingHelper, (LinearLayout) findViewById(R.id.RouteLayout));
-		mapView.addLayer(routeInfoLayer, 10);
-		
-
-		
-		savingTrackHelper = new SavingTrackHelper(this);
-		
-		LatLon pointToNavigate = OsmandSettings.getPointToNavigate(settings);
-		
+package net.osmand.plus.activities;
+
+import java.io.File;
+import java.text.MessageFormat;
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.Collection;
+import java.util.Collections;
+import java.util.Comparator;
+import java.util.Iterator;
+import java.util.List;
+import java.util.Map;
+
+import net.osmand.Algoritms;
+import net.osmand.FavouritePoint;
+import net.osmand.GPXUtilities;
+import net.osmand.LogUtil;
+import net.osmand.OsmAndFormatter;
+import net.osmand.Version;
+import net.osmand.GPXUtilities.GPXFileResult;
+import net.osmand.GPXUtilities.WptPt;
+import net.osmand.data.Amenity;
+import net.osmand.data.AmenityType;
+import net.osmand.data.preparation.MapTileDownloader;
+import net.osmand.data.preparation.MapTileDownloader.DownloadRequest;
+import net.osmand.data.preparation.MapTileDownloader.IMapDownloaderCallback;
+import net.osmand.map.IMapLocationListener;
+import net.osmand.map.ITileSource;
+import net.osmand.osm.LatLon;
+import net.osmand.osm.MapUtils;
+import net.osmand.plus.AmenityIndexRepository;
+import net.osmand.plus.AmenityIndexRepositoryOdb;
+import net.osmand.plus.BusyIndicator;
+import net.osmand.plus.FavouritesDbHelper;
+import net.osmand.plus.OsmandSettings;
+import net.osmand.plus.PoiFilter;
+import net.osmand.plus.PoiFiltersHelper;
+import net.osmand.plus.R;
+import net.osmand.plus.ResourceManager;
+import net.osmand.plus.SQLiteTileSource;
+import net.osmand.plus.OsmandSettings.ApplicationMode;
+import net.osmand.plus.activities.search.SearchActivity;
+import net.osmand.plus.activities.search.SearchPoiFilterActivity;
+import net.osmand.plus.activities.search.SearchTransportActivity;
+import net.osmand.plus.render.MapRenderRepositories;
+import net.osmand.plus.render.RendererLayer;
+import net.osmand.plus.views.AnimateDraggingMapThread;
+import net.osmand.plus.views.ContextMenuLayer;
+import net.osmand.plus.views.FavoritesLayer;
+import net.osmand.plus.views.GPXLayer;
+import net.osmand.plus.views.MapInfoLayer;
+import net.osmand.plus.views.OsmBugsLayer;
+import net.osmand.plus.views.OsmandMapTileView;
+import net.osmand.plus.views.POIMapLayer;
+import net.osmand.plus.views.PointLocationLayer;
+import net.osmand.plus.views.PointNavigationLayer;
+import net.osmand.plus.views.RouteInfoLayer;
+import net.osmand.plus.views.RouteLayer;
+import net.osmand.plus.views.TransportInfoLayer;
+import net.osmand.plus.views.TransportStopsLayer;
+import net.osmand.plus.views.YandexTrafficLayer;
+import android.app.Activity;
+import android.app.AlertDialog;
+import android.app.Dialog;
+import android.app.Notification;
+import android.app.NotificationManager;
+import android.app.PendingIntent;
+import android.app.ProgressDialog;
+import android.app.AlertDialog.Builder;
+import android.content.ActivityNotFoundException;
+import android.content.ComponentName;
+import android.content.DialogInterface;
+import android.content.Intent;
+import android.content.SharedPreferences;
+import android.content.SharedPreferences.Editor;
+import android.content.pm.PackageManager;
+import android.content.pm.ResolveInfo;
+import android.content.res.Resources;
+import android.graphics.Rect;
+import android.graphics.RectF;
+import android.hardware.Sensor;
+import android.hardware.SensorEvent;
+import android.hardware.SensorEventListener;
+import android.hardware.SensorManager;
+import android.location.Location;
+import android.location.LocationListener;
+import android.location.LocationManager;
+import android.location.LocationProvider;
+import android.media.AudioManager;
+import android.net.Uri;
+import android.os.Build;
+import android.os.Bundle;
+import android.os.Environment;
+import android.os.Handler;
+import android.os.Looper;
+import android.os.Message;
+import android.os.PowerManager;
+import android.os.PowerManager.WakeLock;
+import android.text.ClipboardManager;
+import android.text.Html;
+import android.util.FloatMath;
+import android.util.Log;
+import android.view.KeyEvent;
+import android.view.Menu;
+import android.view.MenuInflater;
+import android.view.MenuItem;
+import android.view.MotionEvent;
+import android.view.View;
+import android.view.Window;
+import android.view.View.OnClickListener;
+import android.widget.CompoundButton;
+import android.widget.EditText;
+import android.widget.ImageButton;
+import android.widget.LinearLayout;
+import android.widget.Toast;
+import android.widget.ToggleButton;
+import android.widget.ZoomControls;
+
+public class MapActivity extends Activity implements IMapLocationListener, SensorEventListener {
+
+	private static final String GPS_STATUS_ACTIVITY = "com.eclipsim.gpsstatus2.GPSStatus"; //$NON-NLS-1$
+	private static final String GPS_STATUS_COMPONENT = "com.eclipsim.gpsstatus2"; //$NON-NLS-1$
+	
+	// stupid error but anyway hero 2.1 : always lost gps signal (temporarily unavailable) for timeout = 2000
+	private static final int GPS_TIMEOUT_REQUEST = 1000;
+	private static final int GPS_DIST_REQUEST = 5;
+	// use only gps (not network) for 12 seconds 
+	private static final int USE_ONLY_GPS_INTERVAL = 12000; 
+	
+	private boolean providerSupportsBearing = false;
+	@SuppressWarnings("unused")
+	private boolean providerSupportsSpeed = false;
+	private String currentLocationProvider = null;
+	private long lastTimeAutoZooming = 0;
+	private long lastTimeGPXLocationFixed = 0;
+	
+    /** Called when the activity is first created. */
+	private OsmandMapTileView mapView;
+	private MapActivityActions mapActions = new MapActivityActions(this);
+	
+	private ImageButton backToLocation;
+	private ImageButton backToMenu;
+	
+	// the order of layer should be preserved ! when you are inserting new layer
+	private RendererLayer rendererLayer;
+	private GPXLayer gpxLayer;
+	private RouteLayer routeLayer;
+	private YandexTrafficLayer trafficLayer;
+	private OsmBugsLayer osmBugsLayer;
+	private POIMapLayer poiMapLayer;
+	private FavoritesLayer favoritesLayer;
+	private TransportStopsLayer transportStopsLayer;
+	private TransportInfoLayer transportInfoLayer;
+	private PointLocationLayer locationLayer;
+	private PointNavigationLayer navigationLayer;
+	private MapInfoLayer mapInfoLayer;
+	private ContextMenuLayer contextMenuLayer;
+	private RouteInfoLayer routeInfoLayer;
+	
+	private SavingTrackHelper savingTrackHelper;
+	private RoutingHelper routingHelper;
+	
+	
+	private WakeLock wakeLock;
+	private boolean sensorRegistered = false;
+
+	private NotificationManager mNotificationManager;
+	private Handler mapPositionHandler = null;
+	private int APP_NOTIFICATION_ID;
+	private int currentScreenOrientation;
+	private int currentMapRotation;
+	private boolean currentShowingAngle;
+	
+	private Dialog progressDlg = null;
+	private SharedPreferences settings;
+	
+	private boolean isMapLinkedToLocation(){
+		return OsmandSettings.isMapSyncToGpsLocation(settings);
+	}
+	
+	private Notification getNotification(){
+		Intent notificationIndent = new Intent(this, MapActivity.class);
+		notificationIndent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP | Intent.FLAG_ACTIVITY_NEW_TASK);
+		Notification notification = new Notification(R.drawable.icon, "", //$NON-NLS-1$
+				System.currentTimeMillis());
+		notification.setLatestEventInfo(this, Version.APP_NAME,
+				getString(R.string.go_back_to_osmand), PendingIntent.getActivity(
+						this, 0, notificationIndent,
+						PendingIntent.FLAG_UPDATE_CURRENT));
+		return notification;
+	}
+	
+    @Override
+    public void onCreate(Bundle savedInstanceState) {
+		super.onCreate(savedInstanceState);
+		settings = OsmandSettings.getPrefs(this);		
+		// for voice navigation
+		setVolumeControlStream(AudioManager.STREAM_MUSIC);
+		requestWindowFeature(Window.FEATURE_NO_TITLE); 
+		// Full screen is not used here
+//	     getWindow().setFlags(WindowManager.LayoutParams.FLAG_FULLSCREEN, WindowManager.LayoutParams.FLAG_FULLSCREEN);
+		setContentView(R.layout.main);
+		ProgressDialog dlg = ((OsmandApplication)getApplication()).checkApplicationIsBeingInitialized(this);
+		if(dlg != null){
+			// Do some action on close
+			dlg.setOnDismissListener(new DialogInterface.OnDismissListener(){
+				@Override
+				public void onDismiss(DialogInterface dialog) {
+					OsmandApplication app = ((OsmandApplication)getApplication());
+					if(OsmandSettings.isUsingMapVectorData(settings) && app.getResourceManager().getRenderer().isEmpty()){
+						Toast.makeText(MapActivity.this, getString(R.string.no_vector_map_loaded), Toast.LENGTH_LONG).show();
+					}
+				}
+			});
+		}
+		parseLaunchIntentLocation();
+		
+		mapView = (OsmandMapTileView) findViewById(R.id.MapView);
+		mapView.setTrackBallDelegate(new OsmandMapTileView.OnTrackBallListener(){
+			@Override
+			public boolean onTrackBallEvent(MotionEvent e) {
+				showAndHideMapPosition();
+				return MapActivity.this.onTrackballEvent(e);
+			}
+
+		});
+		MapTileDownloader.getInstance().addDownloaderCallback(new IMapDownloaderCallback(){
+			@Override
+			public void tileDownloaded(DownloadRequest request) {
+				if(request != null && !request.error && request.fileToSave != null){
+					ResourceManager mgr = ((OsmandApplication)getApplication()).getResourceManager();
+					mgr.tileDownloaded(request);
+				}
+				mapView.tileDownloaded(request);
+				
+			}
+		});
+		
+		mapView.setMapLocationListener(this);
+		routingHelper = ((OsmandApplication) getApplication()).getRoutingHelper();
+		
+		// 0.5 layer
+		rendererLayer = new RendererLayer();
+		mapView.addLayer(rendererLayer, 0.5f);
+		
+		// 0.6 gpx layer
+		gpxLayer = new GPXLayer();
+		mapView.addLayer(gpxLayer, 0.6f);
+		
+		// 1. route layer
+		routeLayer = new RouteLayer(routingHelper);
+		mapView.addLayer(routeLayer, 1);
+		
+		// 1.5. traffic layer
+		trafficLayer = new YandexTrafficLayer();
+		mapView.addLayer(trafficLayer, 1.5f);
+		
+		
+		// 2. osm bugs layer
+		osmBugsLayer = new OsmBugsLayer(this);
+		// 3. poi layer
+		poiMapLayer = new POIMapLayer();
+		// 4. favorites layer
+		favoritesLayer = new FavoritesLayer();
+		// 5. transport layer
+		transportStopsLayer = new TransportStopsLayer();
+		// 5.5 transport info layer 
+		transportInfoLayer = new TransportInfoLayer(TransportRouteHelper.getInstance());
+		mapView.addLayer(transportInfoLayer, 5.5f);
+		// 6. point navigation layer
+		navigationLayer = new PointNavigationLayer();
+		mapView.addLayer(navigationLayer, 6);
+		// 7. point location layer 
+		locationLayer = new PointLocationLayer();
+		mapView.addLayer(locationLayer, 7);
+		// 8. map info layer
+		mapInfoLayer = new MapInfoLayer(this, routeLayer);
+		mapView.addLayer(mapInfoLayer, 8);
+		// 9. context menu layer 
+		contextMenuLayer = new ContextMenuLayer(this);
+		mapView.addLayer(contextMenuLayer, 9);
+		// 10. route info layer
+		routeInfoLayer = new RouteInfoLayer(routingHelper, (LinearLayout) findViewById(R.id.RouteLayout));
+		mapView.addLayer(routeInfoLayer, 10);
+		
+
+		
+		savingTrackHelper = new SavingTrackHelper(this);
+		
+		LatLon pointToNavigate = OsmandSettings.getPointToNavigate(settings);
+		
 		// This situtation could be when navigation suddenly crashed and after restarting
 		// it tries to continue the last route
-		if(!Algoritms.objectEquals(routingHelper.getFinalLocation(), pointToNavigate)){
-			routingHelper.setFollowingMode(false);
-			routingHelper.setFinalAndCurrentLocation(pointToNavigate, null);
-
-		}
-		if(OsmandSettings.isFollowingByRoute(settings)){
-			if(pointToNavigate == null){
-				OsmandSettings.setFollowingByRoute(this, false);
-			} else if(!routingHelper.isRouteCalculated()){
-				Builder builder = new AlertDialog.Builder(this);
-				builder.setMessage(R.string.continue_follow_previous_route);
-				builder.setPositiveButton(R.string.default_buttons_yes, new DialogInterface.OnClickListener(){
-					@Override
-					public void onClick(DialogInterface dialog, int which) {
-						routingHelper.setFollowingMode(true);
+		if(!Algoritms.objectEquals(routingHelper.getFinalLocation(), pointToNavigate)){
+			routingHelper.setFollowingMode(false);
+			routingHelper.setFinalAndCurrentLocation(pointToNavigate, null);
+
+		}
+		if(OsmandSettings.isFollowingByRoute(settings)){
+			if(pointToNavigate == null){
+				OsmandSettings.setFollowingByRoute(this, false);
+			} else if(!routingHelper.isRouteCalculated()){
+				Builder builder = new AlertDialog.Builder(this);
+				builder.setMessage(R.string.continue_follow_previous_route);
+				builder.setPositiveButton(R.string.default_buttons_yes, new DialogInterface.OnClickListener(){
+					@Override
+					public void onClick(DialogInterface dialog, int which) {
+						routingHelper.setFollowingMode(true);
 						((OsmandApplication)getApplication()).showDialogInitializingCommandPlayer(MapActivity.this);
-					}
-				});
-				builder.setNegativeButton(R.string.default_buttons_no, new DialogInterface.OnClickListener(){
-					@Override
-					public void onClick(DialogInterface dialog, int which) {
-						OsmandSettings.setFollowingByRoute(MapActivity.this, false);
-						routingHelper.setFinalLocation(null);
-						mapView.refreshMap();
-					}
-				});
-				builder.show();
-			}
-		}
-		
-		navigationLayer.setPointToNavigate(pointToNavigate);
-		
-		SharedPreferences prefs = getSharedPreferences(OsmandSettings.SHARED_PREFERENCES_NAME, MODE_WORLD_READABLE);
-		if(prefs == null || !prefs.contains(OsmandSettings.LAST_KNOWN_MAP_LAT)){
-			LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
-			Location location = null;
-			try {
-				location = service.getLastKnownLocation(LocationManager.GPS_PROVIDER);
-			}
-			catch(IllegalArgumentException e) {
-				Log.d(LogUtil.TAG, "GPS location provider not available"); //$NON-NLS-1$
-			}
-
-			if(location == null){
-				try {
-					location = service.getLastKnownLocation(LocationManager.NETWORK_PROVIDER);
-				} catch(IllegalArgumentException e) {
-					Log.d(LogUtil.TAG, "Network location provider not available"); //$NON-NLS-1$
-				}
-			}
-			if(location != null){
-				mapView.setLatLon(location.getLatitude(), location.getLongitude());
-				mapView.setZoom(14);
-			}
-		}
-		
-		
-		
-		final ZoomControls zoomControls = (ZoomControls) findViewById(R.id.ZoomControls);
-		updateZoomControls(zoomControls, mapView.getZoom());
-		zoomControls.setOnZoomInClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				updateZoomControls(zoomControls, mapView.getZoom() + 1);
-				mapView.getAnimatedDraggingThread().stopAnimatingSync();
-				mapView.getAnimatedDraggingThread().startZooming(mapView.getZoom(), mapView.getZoom() + 1);
-				showAndHideMapPosition();
-				// user can preview map manually switch off auto zoom while user don't press back to location
-				if(OsmandSettings.isAutoZoomEnabled(settings)){
-					locationChanged(mapView.getLatitude(), mapView.getLongitude(), null);
-				}
-			}
-		});
-		zoomControls.setOnZoomOutClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				updateZoomControls(zoomControls, mapView.getZoom() - 1);
-				mapView.getAnimatedDraggingThread().stopAnimatingSync();
-				mapView.getAnimatedDraggingThread().startZooming(mapView.getZoom(), mapView.getZoom() - 1);
-				showAndHideMapPosition();
-				// user can preview map manually switch off auto zoom while user don't press back to location
-				if(OsmandSettings.isAutoZoomEnabled(settings)){
-					locationChanged(mapView.getLatitude(), mapView.getLongitude(), null);
-				}
-			}
-		});
-		backToLocation = (ImageButton)findViewById(R.id.BackToLocation);
-		backToLocation.setOnClickListener(new OnClickListener(){
-			@Override
-			public void onClick(View v) {
-				backToLocationImpl();
-			}
-			
-		});
-		
-		
-		
-		backToMenu = (ImageButton)findViewById(R.id.BackToMenu);
-		backToMenu.setOnClickListener(new OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				Intent newIntent = new Intent(MapActivity.this, MainMenuActivity.class);
-				newIntent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
-				startActivity(newIntent);
-			}
-		});
-		
-		// Possibly use that method instead of 
-		/*mapView.setOnLongClickListener(new OsmandMapTileView.OnLongClickListener(){
-			@Override
-			public boolean onLongPressEvent(PointF point) {
-				LatLon l = mapView.getLatLonFromScreenPoint(point.x, point.y);
-				return true;
-			}
-		});*/
-		
-	}
-    
-    private void updateZoomControls(ZoomControls zoomControls, int zoom){
-    	zoomControls.setIsZoomInEnabled(zoom < mapView.getMaximumShownMapZoom());
-		zoomControls.setIsZoomOutEnabled(zoom > mapView.getMinimumShownMapZoom());
-    }
- 
-    @Override
-    public boolean onKeyDown(int keyCode, KeyEvent event) {
-        if (keyCode == KeyEvent.KEYCODE_SEARCH && event.getRepeatCount() == 0) {
-			Intent newIntent = new Intent(MapActivity.this, SearchActivity.class);
-			startActivity(newIntent);
-            return true;
-        }
-        return super.onKeyDown(keyCode, event);
-    }
-    @Override
-    public boolean onTrackballEvent(MotionEvent event) {
-    	if(event.getAction() == MotionEvent.ACTION_MOVE && OsmandSettings.isUsingTrackBall(settings)){
-    		float x = event.getX();
-    		float y = event.getY();
-    		LatLon l = mapView.getLatLonFromScreenPoint(mapView.getCenterPointX() + x * 15, mapView.getCenterPointY() + y * 15);
-    		setMapLocation(l.getLatitude(), l.getLongitude());
-    		return true;
-    	} 
-    	return super.onTrackballEvent(event);
-    }
-    
-    @Override
-    protected void onStart() {
-    	super.onStart();
-    }
-    
-    protected void setProgressDlg(Dialog progressDlg) {
-		this.progressDlg = progressDlg;
-	}
-    
-    protected Dialog getProgressDlg() {
-		return progressDlg;
-	}
-    
-    @Override
-    protected void onStop() {
-    	// TODO keep this check?
-    	if(routingHelper.isFollowingMode()){
-    		mNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
-    		mNotificationManager.notify(APP_NOTIFICATION_ID, getNotification());
-    	}
-		if(progressDlg != null){
-			progressDlg.dismiss();
-			progressDlg = null;
-		}
-    	super.onStop();
-    }
-    
-    @Override
-    protected void onDestroy() {
-    	super.onDestroy();
-    	savingTrackHelper.close();
-    	if(mNotificationManager != null){
-    		mNotificationManager.cancel(APP_NOTIFICATION_ID);
-    	}
-    	MapTileDownloader.getInstance().removeDownloaderCallback(mapView);
-    }
-    
-    
-    
-    private void registerUnregisterSensor(Location location){
-    	boolean show = (currentShowingAngle && location != null) || currentMapRotation == OsmandSettings.ROTATE_MAP_COMPASS;
-    	// show point view only if gps enabled
-		if (sensorRegistered && !show) {
-			Log.d(LogUtil.TAG, "Disable sensor"); //$NON-NLS-1$
-			((SensorManager) getSystemService(SENSOR_SERVICE)).unregisterListener(this);
-			sensorRegistered = false;
-			locationLayer.setHeading(null);
-		} else if (!sensorRegistered && show) {
-			Log.d(LogUtil.TAG, "Enable sensor"); //$NON-NLS-1$
-			SensorManager sensorMgr = (SensorManager) getSystemService(SENSOR_SERVICE);
-			Sensor s = sensorMgr.getDefaultSensor(Sensor.TYPE_ORIENTATION);
-			if (s != null) {
-				sensorMgr.registerListener(this, s, SensorManager.SENSOR_DELAY_UI);
-			}
-			sensorRegistered = true;
-		}
-    }
-    
-    protected void backToLocationImpl() {
-		backToLocation.setVisibility(View.INVISIBLE);
-		if(!isMapLinkedToLocation()){
-			OsmandSettings.setSyncMapToGpsLocation(MapActivity.this, true);
-			if(locationLayer.getLastKnownLocation() != null){
-				Location lastKnownLocation = locationLayer.getLastKnownLocation();
-				AnimateDraggingMapThread thread = mapView.getAnimatedDraggingThread();
-				int fZoom = mapView.getZoom() < 15 ? 15 : mapView.getZoom();
-				thread.startMoving(mapView.getLatitude(), mapView.getLongitude(), 
-						lastKnownLocation.getLatitude(), lastKnownLocation.getLongitude(), mapView.getZoom(), fZoom, 
-						mapView.getSourceTileSize(), mapView.getRotate(), false);
-			}
-		}
-		if(locationLayer.getLastKnownLocation() == null){
-			Toast.makeText(this, R.string.unknown_location, Toast.LENGTH_LONG).show();
-		}
-	}
-    
-    private void updateSpeedBearing(Location location) {
-		// For network/gps it's bad way (not accurate). It's widely used for testing purposes
-    	// possibly keep using only for emulator case
-//		if (!providerSupportsSpeed
-    	if (isRunningOnEmulator()
-    			&& locationLayer.getLastKnownLocation() != null && location != null) {
-			if (locationLayer.getLastKnownLocation().distanceTo(location) > 3) {
-				float d = location.distanceTo(locationLayer.getLastKnownLocation());
-				long time = location.getTime() - locationLayer.getLastKnownLocation().getTime();
-				float speed;
-				if (time == 0) {
-					speed = 0;
-				} else {
-					speed = ((float) d * 1000) / time ;
-				}
-				// incorrect in case of airplane
-				if (speed > 100) {
-					speed = 100;
-				}
-				location.setSpeed(speed);
-			}
-		}
-    	if(!providerSupportsBearing && locationLayer.getLastKnownLocation() != null && location != null){
-    		if(locationLayer.getLastKnownLocation().distanceTo(location) > 10){
-    			location.setBearing(locationLayer.getLastKnownLocation().bearingTo(location));
-    		}
-    	}
-	}
-    
-    public void setLocation(Location location){
-    	if(Log.isLoggable(LogUtil.TAG, Log.DEBUG)){
-    		Log.d(LogUtil.TAG, "Location changed " + location.getProvider()); //$NON-NLS-1$
-    	}
-    	if(location != null && OsmandSettings.isSavingTrackToGpx(this)){
-			savingTrackHelper.insertData(location.getLatitude(), location.getLongitude(), 
-					location.getAltitude(), location.getSpeed(), location.getTime(), settings);
-		}
-    	registerUnregisterSensor(location);
-    	updateSpeedBearing(location);
-    	
-    	locationLayer.setLastKnownLocation(location);
-    	if(routingHelper.isFollowingMode()){
-    		routingHelper.setCurrentLocation(location);
-    	}
-    	if (location != null) {
-			if (isMapLinkedToLocation()) {
-				if(OsmandSettings.isAutoZoomEnabled(settings) && location.hasSpeed()){
-	    			int z = defineZoomFromSpeed(location.getSpeed(), mapView.getZoom());
-	    			if(mapView.getZoom() != z && !mapView.mapIsAnimating()){
-	    				long now = System.currentTimeMillis();
-	    				// prevent ui hysterisis (check time interval for autozoom)
-	    				if(Math.abs(mapView.getZoom() - z) > 1 || (lastTimeAutoZooming - now) > 6500){
-	    					lastTimeAutoZooming = now;
-	    					mapView.setZoom(z);
-	    				}
-	    			}
-	    		}
-				if (location.hasBearing() && currentMapRotation == OsmandSettings.ROTATE_MAP_BEARING) {
-					mapView.setRotate(-location.getBearing());
-				}
-				mapView.setLatLon(location.getLatitude(), location.getLongitude());
-			} else {
-				if(backToLocation.getVisibility() != View.VISIBLE){
-					backToLocation.setVisibility(View.VISIBLE);
-				}
-			}
-		} else {
-			if(backToLocation.getVisibility() != View.INVISIBLE){
-				backToLocation.setVisibility(View.INVISIBLE);
-			}
-		}
-    }
-    
-    public int defineZoomFromSpeed(float speed, int currentZoom){
-    	speed *= 3.6;
-    	if(speed < 4){
-    		return currentZoom;
-    	} else if(speed < 33){
-    		// less than 33 - show 17 
-    		return 17;
-    	} else if(speed < 53){
-    		return 16;
-    	} else if(speed < 83){
-    		return 15;
-    	}
-    	// more than 80 - show 14 (it is slow)
-    	return 14;
-    }
-
-	public void navigateToPoint(LatLon point){
-		if(point != null){
-			OsmandSettings.setPointToNavigate(this, point.getLatitude(), point.getLongitude());
-		} else {
-			OsmandSettings.clearPointToNavigate(settings);
-		}
-		routingHelper.setFinalAndCurrentLocation(point, null, routingHelper.getCurrentGPXRoute());
-		if(point == null){
-			routingHelper.setFollowingMode(false);
-			OsmandSettings.setFollowingByRoute(MapActivity.this, false);
-		}
-		navigationLayer.setPointToNavigate(point);
-	}
-	
-	public Location getLastKnownLocation(){
-		return locationLayer.getLastKnownLocation();
-	}
-	
-	public LatLon getMapLocation(){
-		return new LatLon(mapView.getLatitude(), mapView.getLongitude());
-	}
-	
-	public LatLon getPointToNavigate(){
-		return navigationLayer.getPointToNavigate();
-	}
-	
-	public RoutingHelper getRoutingHelper() {
-		return routingHelper;
-	}
-	
-	private boolean isRunningOnEmulator(){
-		if (Build.DEVICE.equals("generic")) { //$NON-NLS-1$ 
-			return true;
-		}  
-		return false;
-	}
-	
-	private boolean useOnlyGPS() {
-		return (routingHelper != null && routingHelper.isFollowingMode())
-				|| (System.currentTimeMillis() - lastTimeGPXLocationFixed) < USE_ONLY_GPS_INTERVAL || isRunningOnEmulator();
-	}
-    
-
-	// Working with location listeners
-	private LocationListener networkListener = new LocationListener(){
-		
-		@Override
-		public void onLocationChanged(Location location) {
-			// double check about use only gps
-			// that strange situation but it could happen?
-			if(!Algoritms.objectEquals(currentLocationProvider, LocationManager.GPS_PROVIDER) &&  
-					!useOnlyGPS()){
-				setLocation(location);
-			}
-		}
-
-		@Override
-		public void onProviderDisabled(String provider) {
-			if(!useOnlyGPS()){
-				setLocation(null);
-			}
-		}
-
-		@Override
-		public void onProviderEnabled(String provider) {
-		}
-
-		@Override
-		public void onStatusChanged(String provider, int status, Bundle extras) {
-			if(LocationProvider.OUT_OF_SERVICE == status && !useOnlyGPS()){
-				setLocation(null);
-			}
-		}
-	};
-	private LocationListener gpsListener = new LocationListener(){
-		@Override
-		public void onLocationChanged(Location location) {
-			if (location != null) {
-				lastTimeGPXLocationFixed = location.getTime();
-			}
-			setLocation(location);
-		}
-
-		@Override
-		public void onProviderDisabled(String provider) {
-			setLocation(null);
-		}
-
-		@Override
-		public void onProviderEnabled(String provider) {
-		}
-
-		@Override
-		public void onStatusChanged(String provider, int status, Bundle extras) {
-			LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
-			LocationProvider prov = service.getProvider(LocationManager.NETWORK_PROVIDER);
-			// do not change provider for temporarily unavailable (possible bug for htc hero 2.1 ?)
-			if (LocationProvider.OUT_OF_SERVICE == status /*|| LocationProvider.TEMPORARILY_UNAVAILABLE == status*/) {
-				if(LocationProvider.OUT_OF_SERVICE == status){
-					setLocation(null);
-				}
-				// do not use it in routing
-				if (!useOnlyGPS() &&  
-						service.isProviderEnabled(LocationManager.NETWORK_PROVIDER)) {
-					if (!Algoritms.objectEquals(currentLocationProvider, LocationManager.NETWORK_PROVIDER)) {
-						currentLocationProvider = LocationManager.NETWORK_PROVIDER;
-						service.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, GPS_TIMEOUT_REQUEST, GPS_DIST_REQUEST, this);
-						providerSupportsBearing = prov == null ? false : prov.supportsBearing() && !isRunningOnEmulator();
-						providerSupportsSpeed = prov == null ? false : prov.supportsSpeed() && !isRunningOnEmulator();
-					}
-				}
-			} else if (LocationProvider.AVAILABLE == status) {
-				if (!Algoritms.objectEquals(currentLocationProvider, LocationManager.GPS_PROVIDER)) {
-					currentLocationProvider = LocationManager.GPS_PROVIDER;
-					service.removeUpdates(networkListener);
-					prov = service.getProvider(LocationManager.GPS_PROVIDER);
-					providerSupportsBearing = prov == null ? false : prov.supportsBearing() && !isRunningOnEmulator();
-					providerSupportsSpeed = prov == null ? false : prov.supportsSpeed() && !isRunningOnEmulator();
-				}
-			}
-
-		}
-	};
-	
-	
-
-	
-	@Override
-	protected void onPause() {
-		super.onPause();
-		LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
-		service.removeUpdates(gpsListener);
-		service.removeUpdates(networkListener);
-		
-		SensorManager sensorMgr = (SensorManager) getSystemService(SENSOR_SERVICE);
-		sensorMgr.unregisterListener(this);
-		sensorRegistered = false;
-		currentLocationProvider = null;
-		routingHelper.setUiActivity(null);
-		
-		((OsmandApplication)getApplication()).getDaynightHelper().onMapPause();
-		
-		OsmandSettings.setLastKnownMapLocation(this, (float) mapView.getLatitude(), (float) mapView.getLongitude());
-		AnimateDraggingMapThread animatedThread = mapView.getAnimatedDraggingThread();
-		if(animatedThread.isAnimating() && animatedThread.getTargetZoom() != 0){
-			OsmandSettings.setMapLocationToShow(this, animatedThread.getTargetLatitude(), animatedThread.getTargetLongitude(), 
-					animatedThread.getTargetZoom());
-		}
-		
-		OsmandSettings.setLastKnownMapZoom(this, mapView.getZoom());
-		if (wakeLock != null) {
-			wakeLock.release();
-			wakeLock = null;
-		}
-		OsmandSettings.setMapActivityEnabled(this, false);
-		((OsmandApplication)getApplication()).getResourceManager().interruptRendering();
-		((OsmandApplication)getApplication()).getResourceManager().setBusyIndicator(null);
-	}
-	
-	private void updateApplicationModeSettings(){
-		currentMapRotation = OsmandSettings.getRotateMap(settings);
-		currentShowingAngle = OsmandSettings.isShowingViewAngle(settings);
-		if(currentMapRotation == OsmandSettings.ROTATE_MAP_NONE){
-			mapView.setRotate(0);
-		}
-		if(!currentShowingAngle){
-			locationLayer.setHeading(null);
-		}
-		locationLayer.setAppMode(OsmandSettings.getApplicationMode(settings));
-		routingHelper.setAppMode(OsmandSettings.getApplicationMode(settings));
-		mapView.setMapPosition(OsmandSettings.getPositionOnMap(settings));
-		registerUnregisterSensor(getLastKnownLocation());
-		updateLayers();
-	}
-	
-	private void updateLayers(){
-		if(mapView.getLayers().contains(transportStopsLayer) != OsmandSettings.isShowingTransportOverMap(settings)){
-			if(OsmandSettings.isShowingTransportOverMap(settings)){
-				mapView.addLayer(transportStopsLayer, 5);
-			} else {
-				mapView.removeLayer(transportStopsLayer);
-			}
-		}
-		if(mapView.getLayers().contains(osmBugsLayer) != OsmandSettings.isShowingOsmBugs(settings)){
-			if(OsmandSettings.isShowingOsmBugs(settings)){
-				mapView.addLayer(osmBugsLayer, 2);
-			} else {
-				mapView.removeLayer(osmBugsLayer);
-			}
-		}
-
-		if(mapView.getLayers().contains(poiMapLayer) != OsmandSettings.isShowingPoiOverMap(settings)){
-			if(OsmandSettings.isShowingPoiOverMap(settings)){
-				mapView.addLayer(poiMapLayer, 3);
-			} else {
-				mapView.removeLayer(poiMapLayer);
-			}
-		}
-		
-		if(mapView.getLayers().contains(favoritesLayer) != OsmandSettings.isShowingFavorites(settings)){
-			if(OsmandSettings.isShowingFavorites(settings)){
-				mapView.addLayer(favoritesLayer, 4);
-			} else {
-				mapView.removeLayer(favoritesLayer);
-			}
-		}
-		trafficLayer.setVisible(OsmandSettings.isShowingYandexTraffic(settings));
-	}
-	
-	private void updateMapSource(){
-		boolean vectorData = OsmandSettings.isUsingMapVectorData(settings);
-		OsmandApplication app = ((OsmandApplication)getApplication());
-		ResourceManager rm = app.getResourceManager();
-		if(vectorData && !app.isApplicationInitializing()){
-			if(rm.getRenderer().isEmpty()){
-				Toast.makeText(MapActivity.this, getString(R.string.no_vector_map_loaded), Toast.LENGTH_LONG).show();
-				vectorData = false;
-			}
-		}
-		ITileSource newSource = OsmandSettings.getMapTileSource(settings);
-		if(mapView.getMap() instanceof SQLiteTileSource){
-			((SQLiteTileSource)mapView.getMap()).closeDB();
-		}
-		rm.updateMapSource(vectorData, newSource);
-		
-		mapView.setMap(vectorData ? null : newSource);
-		ZoomControls zoomControls = (ZoomControls) findViewById(R.id.ZoomControls);
-		zoomControls.setIsZoomInEnabled(mapView.getZoom() + 1 < mapView.getMaximumShownMapZoom());
-		zoomControls.setIsZoomOutEnabled(mapView.getZoom() + 1 > mapView.getMinimumShownMapZoom());
-		rendererLayer.setVisible(vectorData);
-	}
-	
-	@Override
-	protected void onResume() {
-		super.onResume();
-		if(OsmandSettings.getMapOrientation(settings) != getRequestedOrientation()){
-			setRequestedOrientation(OsmandSettings.getMapOrientation(settings));
-			// can't return from this method we are not sure if activity will be recreated or not
-		}
-		currentScreenOrientation = getWindow().getWindowManager().getDefaultDisplay().getOrientation();
-		
-		boolean showTiles = !OsmandSettings.isUsingMapVectorData(settings);
-		ITileSource source = showTiles ? OsmandSettings.getMapTileSource(settings) : null;
-		if (showTiles != !rendererLayer.isVisible() || !Algoritms.objectEquals(mapView.getMap(), source)) {
-			updateMapSource();
-		}
-		
-		updateApplicationModeSettings();
-		
-
-		poiMapLayer.setFilter(OsmandSettings.getPoiFilterForMap(this, (OsmandApplication) getApplication()));
-		backToLocation.setVisibility(View.INVISIBLE);
-		
-		routingHelper.setUiActivity(this);
-
-		
-		LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
-		try {
-			service.requestLocationUpdates(LocationManager.GPS_PROVIDER, GPS_TIMEOUT_REQUEST, GPS_DIST_REQUEST, gpsListener);
-			currentLocationProvider = LocationManager.GPS_PROVIDER;
-		} catch (IllegalArgumentException e) {
-			Log.d(LogUtil.TAG, "GPS location provider not available"); //$NON-NLS-1$
-		}
-		if(!useOnlyGPS()){
-			// try to always  ask for network provide : it is faster way to find location
-			try {
-				service.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, GPS_TIMEOUT_REQUEST, GPS_DIST_REQUEST, networkListener);
-				currentLocationProvider = LocationManager.NETWORK_PROVIDER;
-			} catch(IllegalArgumentException e) {
-				Log.d(LogUtil.TAG, "Network location provider not available"); //$NON-NLS-1$
-			}
-		}
-		
-		LocationProvider  prov = service.getProvider(currentLocationProvider); 
-		providerSupportsBearing = prov == null ? false : prov.supportsBearing() && !isRunningOnEmulator();
-		providerSupportsSpeed = prov == null ? false : prov.supportsSpeed() && !isRunningOnEmulator();
-		
-		if(settings != null && settings.contains(OsmandSettings.LAST_KNOWN_MAP_LAT)){
-			LatLon l = OsmandSettings.getLastKnownMapLocation(settings);
-			mapView.setLatLon(l.getLatitude(), l.getLongitude());
-			mapView.setZoom(OsmandSettings.getLastKnownMapZoom(settings));
-		}
-		
-		
-		if (wakeLock == null) {
-			PowerManager powerManager = (PowerManager) getSystemService(POWER_SERVICE);
-			wakeLock = powerManager.newWakeLock(PowerManager.SCREEN_BRIGHT_WAKE_LOCK, "net.osmand.map"); //$NON-NLS-1$
-			wakeLock.acquire();
-		}
-		
-		OsmandSettings.setMapActivityEnabled(this, true);
-		checkExternalStorage();
-		showAndHideMapPosition();
-		
-		LatLon latLon = OsmandSettings.getAndClearMapLocationToShow(settings);
-		LatLon cur = new LatLon(mapView.getLatitude(), mapView.getLongitude());
-		if (latLon != null && !latLon.equals(cur)) {
-			mapView.getAnimatedDraggingThread().startMoving(cur.getLatitude(), cur.getLongitude(), latLon.getLatitude(),
-					latLon.getLongitude(), mapView.getZoom(), OsmandSettings.getMapZoomToShow(settings), mapView.getSourceTileSize(),
-					mapView.getRotate(), true);
-		}
-		
-		
-		View progress = findViewById(R.id.ProgressBar);
-		if(progress != null){
-			((OsmandApplication) getApplication()).getResourceManager().setBusyIndicator(new BusyIndicator(this, progress));
-		}
-		
-		((OsmandApplication)getApplication()).getDaynightHelper().onMapResume();
-	}
-	
-	
-	@Override
-	public boolean onKeyUp(int keyCode, KeyEvent event) {
-		if (keyCode == KeyEvent.KEYCODE_DPAD_CENTER) {
-			contextMenuPoint(mapView.getLatitude(), mapView.getLongitude());
-	    	return true;
-		}
-		return false;
-	}
-	
-	public void checkExternalStorage(){
-		String state = Environment.getExternalStorageState();
-		if(Environment.MEDIA_MOUNTED.equals(state)){
-			// ok
-		} else if(Environment.MEDIA_MOUNTED_READ_ONLY.equals(state)){
-			Toast.makeText(this, R.string.sd_mounted_ro, Toast.LENGTH_LONG).show();
-		} else {
-			Toast.makeText(this, R.string.sd_unmounted, Toast.LENGTH_LONG).show();
-		}
-	}
-	
-	
-	public void showAndHideMapPosition(){
-		mapView.setShowMapPosition(true);
-		if(mapPositionHandler == null){
-			mapPositionHandler = new Handler();
-		}
-		Message msg = Message.obtain(mapPositionHandler, new Runnable(){
-			@Override
-			public void run() {
-				if(mapView.isShowMapPosition()){
-					mapView.setShowMapPosition(false);
-					mapView.refreshMap();
-				}
-			}
-			
-		});
-		msg.what = 7;
-		mapPositionHandler.removeMessages(7);
-		mapPositionHandler.sendMessageDelayed(msg, 2500);
-		
-	}
-	
-	
-
-	@Override
-	public void locationChanged(double newLatitude, double newLongitude, Object source) {
-		// when user start dragging 
-		if(locationLayer.getLastKnownLocation() != null){
-			if(isMapLinkedToLocation()){
-				OsmandSettings.setSyncMapToGpsLocation(MapActivity.this, false);
-			}
-			if (backToLocation.getVisibility() != View.VISIBLE) {
-				runOnUiThread(new Runnable() {
-					@Override
-					public void run() {
-						backToLocation.setVisibility(View.VISIBLE);
-					}
-				});
-			}
-		}
-	}
-	
-	public void setMapLocation(double lat, double lon){
-		mapView.setLatLon(lat, lon);
-		locationChanged(lat, lon, this);
-	}
-	
-	public OsmandMapTileView getMapView() {
-		return mapView;
-	}
-	
-	@Override
-	public void onSensorChanged(SensorEvent event) {
-		// Attention : sensor produces a lot of events & can hang the system
-		float val = event.values[0];
-		if(currentScreenOrientation == 1){
-			val += 90;
-		}
-		if (currentMapRotation == OsmandSettings.ROTATE_MAP_COMPASS) {
-			mapView.setRotate(-val);
-		}
-		if(currentShowingAngle){
-			if(locationLayer.getHeading() == null || Math.abs(locationLayer.getHeading() - val) > 10){
-				locationLayer.setHeading(val);
-			}
-		}
-		
-	}
-	
-	public boolean onCreateOptionsMenu(Menu menu) {
-		MenuInflater inflater = getMenuInflater();
-		inflater.inflate(R.menu.map_menu, menu);
-		return true;
-	}
-	
-	@Override
-	public boolean onPrepareOptionsMenu(Menu menu) {
-		boolean val = super.onPrepareOptionsMenu(menu);
-		MenuItem navigateToPointMenu = menu.findItem(R.id.map_navigate_to_point);
-		if (navigateToPointMenu != null) {
-			navigateToPointMenu.setTitle(routingHelper.isRouteCalculated() ? R.string.stop_routing : R.string.stop_navigation);
-			if (OsmandSettings.getPointToNavigate(settings) != null) {
-				navigateToPointMenu.setVisible(true);
-			} else {
-				navigateToPointMenu.setVisible(false);
-			}
-		}
-		MenuItem muteMenu = menu.findItem(R.id.map_mute); 
-		if(muteMenu != null){
-			muteMenu.setTitle(routingHelper.getVoiceRouter().isMute() ? R.string.menu_mute_on : R.string.menu_mute_off);
-			if (routingHelper.getFinalLocation() != null && routingHelper.isFollowingMode()) {
-				muteMenu.setVisible(true);
-			} else {
-				muteMenu.setVisible(false);
-			}
-		}
-		
-		return val;
-	}
-	
-    @Override
-    public boolean onOptionsItemSelected(MenuItem item) {
-		if (item.getItemId() == R.id.map_show_settings) {
-    		final Intent settings = new Intent(MapActivity.this, SettingsActivity.class);
-			startActivity(settings);
-    		return true;
-		} else if (item.getItemId() == R.id.map_where_am_i) {
-			backToLocationImpl();
-        	return true;
-		} else if (item.getItemId() == R.id.map_show_gps_status) {
-			Intent intent = new Intent();
-			intent.setComponent(new ComponentName(GPS_STATUS_COMPONENT, GPS_STATUS_ACTIVITY));
-			ResolveInfo resolved = getPackageManager().resolveActivity(intent, PackageManager.MATCH_DEFAULT_ONLY);
-			if(resolved != null){
-				startActivity(intent);
-			} else {
-				AlertDialog.Builder builder = new AlertDialog.Builder(this);
-				builder.setMessage(getString(R.string.gps_status_app_not_found));
-				builder.setPositiveButton(getString(R.string.default_buttons_yes),
-						new DialogInterface.OnClickListener() {
-							@Override
-							public void onClick(DialogInterface dialog, int which) {
-								Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse("market://search?q=pname:" + GPS_STATUS_COMPONENT));
-								try {
-									startActivity(intent);
-								} catch (ActivityNotFoundException e) {
-								}
-							}
-						});
-				builder.setNegativeButton(getString(R.string.default_buttons_no), null);
-				builder.show();
-			}
-			return true;
-//		} else if (item.getItemId() == R.id.map_mark_point) {
-//			contextMenuPoint(mapView.getLatitude(), mapView.getLongitude());
-//			return true;
-		} else if (item.getItemId() == R.id.map_get_directions) {
-			getDirections(mapView.getLatitude(), mapView.getLongitude(), true);
-			return true;
-		} else if (item.getItemId() == R.id.map_layers) {
-			openLayerSelectionDialog();
-			return true;
-		} else if (item.getItemId() == R.id.map_specify_point) {
-			NavigatePointActivity dlg = new NavigatePointActivity(this);
-			dlg.showDialog();
-			return true;
-		} else if (item.getItemId() == R.id.map_mute) {
-			routingHelper.getVoiceRouter().setMute(!routingHelper.getVoiceRouter().isMute());
-			return true;
-    	}  else if (item.getItemId() == R.id.map_navigate_to_point) {
-    		if(navigationLayer.getPointToNavigate() != null){
-    			if(routingHelper.isRouteCalculated()){
-    				routingHelper.setFinalAndCurrentLocation(null, null);
-    				OsmandSettings.setFollowingByRoute(MapActivity.this, false);
-    				routingHelper.setFollowingMode(false);
-    			} else {
-    				navigateToPoint(null);
-    			}
-    		} else {
-    			navigateToPoint(new LatLon(mapView.getLatitude(), mapView.getLongitude()));
-    		}
-			mapView.refreshMap();
-    	} else if (item.getItemId() == R.id.map_gpx_routing) {
-			useGPXFileLayer(true, navigationLayer.getPointToNavigate());
-			return true;
-    	} else if (item.getItemId() == R.id.map_show_point_options) {
-			contextMenuPoint(mapView.getLatitude(), mapView.getLongitude());
-    		return true;
-    	}
-    	return super.onOptionsItemSelected(item);
-    }
-    
-    private ApplicationMode getAppMode(ToggleButton[] buttons){
-    	for(int i=0; i<buttons.length; i++){
-    		if(buttons[i] != null && buttons[i].isChecked() && i < ApplicationMode.values().length){
-    			return ApplicationMode.values()[i];
-    		}
-    	}
-    	return OsmandSettings.getApplicationMode(settings);
-    }
-    
-    
-    protected void getDirections(final double lat, final double lon, boolean followEnabled){
-    	if(navigationLayer.getPointToNavigate() == null){
-			Toast.makeText(this, R.string.mark_final_location_first, Toast.LENGTH_LONG).show();
-			return;
-		}
-    	Builder builder = new AlertDialog.Builder(this);
-    	
-    	View view = getLayoutInflater().inflate(R.layout.calculate_route, null);
-    	final ToggleButton[] buttons = new ToggleButton[ApplicationMode.values().length];
-    	buttons[ApplicationMode.CAR.ordinal()] = (ToggleButton) view.findViewById(R.id.CarButton);
-    	buttons[ApplicationMode.BICYCLE.ordinal()] = (ToggleButton) view.findViewById(R.id.BicycleButton);
-    	buttons[ApplicationMode.PEDESTRIAN.ordinal()] = (ToggleButton) view.findViewById(R.id.PedestrianButton);
-    	ApplicationMode appMode = OsmandSettings.getApplicationMode(settings);
-    	for(int i=0; i< buttons.length; i++){
-    		if(buttons[i] != null){
-    			final int ind = i;
-    			ToggleButton b = buttons[i];
-    			b.setChecked(appMode == ApplicationMode.values()[i]);
-    			b.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener(){
-					@Override
-					public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
-						if(isChecked){
-							for (int j = 0; j < buttons.length; j++) {
-								if (buttons[j] != null) {
-									if(buttons[j].isChecked() != (ind == j)){
-										buttons[j].setChecked(ind == j);
-									}
-								}
-							}
-						} else {
-							// revert state
-							boolean revert = true;
-							for (int j = 0; j < buttons.length; j++) {
-								if (buttons[j] != null) {
-									if(buttons[j].isChecked()){
-										revert = false;
-										break;
-									}
-								}
-							}
-							if (revert){ 
-								buttons[ind].setChecked(true);
-							}
-						}
-					}
-    			});
-    		}
-    	}
-    	
-    	DialogInterface.OnClickListener onlyShowCall = new DialogInterface.OnClickListener(){
-
-			@Override
-			public void onClick(DialogInterface dialog, int which) {
-				ApplicationMode mode = getAppMode(buttons);
-				Location map = new Location("map"); //$NON-NLS-1$
-				map.setLatitude(lat);
-				map.setLongitude(lon);
-				routingHelper.setAppMode(mode);
-				OsmandSettings.setFollowingByRoute(MapActivity.this, false);
-				routingHelper.setFollowingMode(false);
-				routingHelper.setFinalAndCurrentLocation(navigationLayer.getPointToNavigate(), map);
-			}
-    	};
-    	
-    	DialogInterface.OnClickListener followCall = new DialogInterface.OnClickListener(){
-			@Override
-			public void onClick(DialogInterface dialog, int which) {
-				ApplicationMode mode = getAppMode(buttons);
-				// change global settings
-				ApplicationMode old = OsmandSettings.getApplicationMode(settings);
-				if (old != mode) {
-					Editor edit = getSharedPreferences(OsmandSettings.SHARED_PREFERENCES_NAME, MODE_WORLD_WRITEABLE).edit();
-					edit.putString(OsmandSettings.APPLICATION_MODE, mode.name());
-					SettingsActivity.setAppMode(mode, edit, (OsmandApplication) getApplication(), old);
-					edit.commit();
-					updateApplicationModeSettings();	
-					mapView.refreshMap();
-				}
-				
-				Location location = locationLayer.getLastKnownLocation();
-				if(location == null){
-					location = new Location("map"); //$NON-NLS-1$
-					location.setLatitude(lat);
-					location.setLongitude(lon);
-				} 
-				routingHelper.setAppMode(mode);
-				OsmandSettings.setFollowingByRoute(MapActivity.this, true);
-				routingHelper.setFollowingMode(true);
-				routingHelper.setFinalAndCurrentLocation(navigationLayer.getPointToNavigate(), location);
-				
+					}
+				});
+				builder.setNegativeButton(R.string.default_buttons_no, new DialogInterface.OnClickListener(){
+					@Override
+					public void onClick(DialogInterface dialog, int which) {
+						OsmandSettings.setFollowingByRoute(MapActivity.this, false);
+						routingHelper.setFinalLocation(null);
+						mapView.refreshMap();
+					}
+				});
+				builder.show();
+			}
+		}
+		
+		navigationLayer.setPointToNavigate(pointToNavigate);
+		
+		SharedPreferences prefs = getSharedPreferences(OsmandSettings.SHARED_PREFERENCES_NAME, MODE_WORLD_READABLE);
+		if(prefs == null || !prefs.contains(OsmandSettings.LAST_KNOWN_MAP_LAT)){
+			LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
+			Location location = null;
+			try {
+				location = service.getLastKnownLocation(LocationManager.GPS_PROVIDER);
+			}
+			catch(IllegalArgumentException e) {
+				Log.d(LogUtil.TAG, "GPS location provider not available"); //$NON-NLS-1$
+			}
+
+			if(location == null){
+				try {
+					location = service.getLastKnownLocation(LocationManager.NETWORK_PROVIDER);
+				} catch(IllegalArgumentException e) {
+					Log.d(LogUtil.TAG, "Network location provider not available"); //$NON-NLS-1$
+				}
+			}
+			if(location != null){
+				mapView.setLatLon(location.getLatitude(), location.getLongitude());
+				mapView.setZoom(14);
+			}
+		}
+		
+		
+		
+		final ZoomControls zoomControls = (ZoomControls) findViewById(R.id.ZoomControls);
+		updateZoomControls(zoomControls, mapView.getZoom());
+		zoomControls.setOnZoomInClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				updateZoomControls(zoomControls, mapView.getZoom() + 1);
+				mapView.getAnimatedDraggingThread().stopAnimatingSync();
+				mapView.getAnimatedDraggingThread().startZooming(mapView.getZoom(), mapView.getZoom() + 1);
+				showAndHideMapPosition();
+				// user can preview map manually switch off auto zoom while user don't press back to location
+				if(OsmandSettings.isAutoZoomEnabled(settings)){
+					locationChanged(mapView.getLatitude(), mapView.getLongitude(), null);
+				}
+			}
+		});
+		zoomControls.setOnZoomOutClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				updateZoomControls(zoomControls, mapView.getZoom() - 1);
+				mapView.getAnimatedDraggingThread().stopAnimatingSync();
+				mapView.getAnimatedDraggingThread().startZooming(mapView.getZoom(), mapView.getZoom() - 1);
+				showAndHideMapPosition();
+				// user can preview map manually switch off auto zoom while user don't press back to location
+				if(OsmandSettings.isAutoZoomEnabled(settings)){
+					locationChanged(mapView.getLatitude(), mapView.getLongitude(), null);
+				}
+			}
+		});
+		backToLocation = (ImageButton)findViewById(R.id.BackToLocation);
+		backToLocation.setOnClickListener(new OnClickListener(){
+			@Override
+			public void onClick(View v) {
+				backToLocationImpl();
+			}
+			
+		});
+		
+		
+		
+		backToMenu = (ImageButton)findViewById(R.id.BackToMenu);
+		backToMenu.setOnClickListener(new OnClickListener() {
+			@Override
+			public void onClick(View v) {
+				Intent newIntent = new Intent(MapActivity.this, MainMenuActivity.class);
+				newIntent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
+				startActivity(newIntent);
+			}
+		});
+		
+		// Possibly use that method instead of 
+		/*mapView.setOnLongClickListener(new OsmandMapTileView.OnLongClickListener(){
+			@Override
+			public boolean onLongPressEvent(PointF point) {
+				LatLon l = mapView.getLatLonFromScreenPoint(point.x, point.y);
+				return true;
+			}
+		});*/
+		
+	}
+    
+    private void updateZoomControls(ZoomControls zoomControls, int zoom){
+    	zoomControls.setIsZoomInEnabled(zoom < mapView.getMaximumShownMapZoom());
+		zoomControls.setIsZoomOutEnabled(zoom > mapView.getMinimumShownMapZoom());
+    }
+ 
+    @Override
+    public boolean onKeyDown(int keyCode, KeyEvent event) {
+        if (keyCode == KeyEvent.KEYCODE_SEARCH && event.getRepeatCount() == 0) {
+			Intent newIntent = new Intent(MapActivity.this, SearchActivity.class);
+			startActivity(newIntent);
+            return true;
+        }
+        return super.onKeyDown(keyCode, event);
+    }
+    @Override
+    public boolean onTrackballEvent(MotionEvent event) {
+    	if(event.getAction() == MotionEvent.ACTION_MOVE && OsmandSettings.isUsingTrackBall(settings)){
+    		float x = event.getX();
+    		float y = event.getY();
+    		LatLon l = mapView.getLatLonFromScreenPoint(mapView.getCenterPointX() + x * 15, mapView.getCenterPointY() + y * 15);
+    		setMapLocation(l.getLatitude(), l.getLongitude());
+    		return true;
+    	} 
+    	return super.onTrackballEvent(event);
+    }
+    
+    @Override
+    protected void onStart() {
+    	super.onStart();
+    }
+    
+    protected void setProgressDlg(Dialog progressDlg) {
+		this.progressDlg = progressDlg;
+	}
+    
+    protected Dialog getProgressDlg() {
+		return progressDlg;
+	}
+    
+    @Override
+    protected void onStop() {
+    	// TODO keep this check?
+    	if(routingHelper.isFollowingMode()){
+    		mNotificationManager = (NotificationManager) getSystemService(NOTIFICATION_SERVICE);
+    		mNotificationManager.notify(APP_NOTIFICATION_ID, getNotification());
+    	}
+		if(progressDlg != null){
+			progressDlg.dismiss();
+			progressDlg = null;
+		}
+    	super.onStop();
+    }
+    
+    @Override
+    protected void onDestroy() {
+    	super.onDestroy();
+    	savingTrackHelper.close();
+    	if(mNotificationManager != null){
+    		mNotificationManager.cancel(APP_NOTIFICATION_ID);
+    	}
+    	MapTileDownloader.getInstance().removeDownloaderCallback(mapView);
+    }
+    
+    
+    
+    private void registerUnregisterSensor(Location location){
+    	boolean show = (currentShowingAngle && location != null) || currentMapRotation == OsmandSettings.ROTATE_MAP_COMPASS;
+    	// show point view only if gps enabled
+		if (sensorRegistered && !show) {
+			Log.d(LogUtil.TAG, "Disable sensor"); //$NON-NLS-1$
+			((SensorManager) getSystemService(SENSOR_SERVICE)).unregisterListener(this);
+			sensorRegistered = false;
+			locationLayer.setHeading(null);
+		} else if (!sensorRegistered && show) {
+			Log.d(LogUtil.TAG, "Enable sensor"); //$NON-NLS-1$
+			SensorManager sensorMgr = (SensorManager) getSystemService(SENSOR_SERVICE);
+			Sensor s = sensorMgr.getDefaultSensor(Sensor.TYPE_ORIENTATION);
+			if (s != null) {
+				sensorMgr.registerListener(this, s, SensorManager.SENSOR_DELAY_UI);
+			}
+			sensorRegistered = true;
+		}
+    }
+    
+    protected void backToLocationImpl() {
+		backToLocation.setVisibility(View.INVISIBLE);
+		if(!isMapLinkedToLocation()){
+			OsmandSettings.setSyncMapToGpsLocation(MapActivity.this, true);
+			if(locationLayer.getLastKnownLocation() != null){
+				Location lastKnownLocation = locationLayer.getLastKnownLocation();
+				AnimateDraggingMapThread thread = mapView.getAnimatedDraggingThread();
+				int fZoom = mapView.getZoom() < 15 ? 15 : mapView.getZoom();
+				thread.startMoving(mapView.getLatitude(), mapView.getLongitude(), 
+						lastKnownLocation.getLatitude(), lastKnownLocation.getLongitude(), mapView.getZoom(), fZoom, 
+						mapView.getSourceTileSize(), mapView.getRotate(), false);
+			}
+		}
+		if(locationLayer.getLastKnownLocation() == null){
+			Toast.makeText(this, R.string.unknown_location, Toast.LENGTH_LONG).show();
+		}
+	}
+    
+    private void updateSpeedBearing(Location location) {
+		// For network/gps it's bad way (not accurate). It's widely used for testing purposes
+    	// possibly keep using only for emulator case
+//		if (!providerSupportsSpeed
+    	if (isRunningOnEmulator()
+    			&& locationLayer.getLastKnownLocation() != null && location != null) {
+			if (locationLayer.getLastKnownLocation().distanceTo(location) > 3) {
+				float d = location.distanceTo(locationLayer.getLastKnownLocation());
+				long time = location.getTime() - locationLayer.getLastKnownLocation().getTime();
+				float speed;
+				if (time == 0) {
+					speed = 0;
+				} else {
+					speed = ((float) d * 1000) / time ;
+				}
+				// incorrect in case of airplane
+				if (speed > 100) {
+					speed = 100;
+				}
+				location.setSpeed(speed);
+			}
+		}
+    	if(!providerSupportsBearing && locationLayer.getLastKnownLocation() != null && location != null){
+    		if(locationLayer.getLastKnownLocation().distanceTo(location) > 10){
+    			location.setBearing(locationLayer.getLastKnownLocation().bearingTo(location));
+    		}
+    	}
+	}
+    
+    public void setLocation(Location location){
+    	if(Log.isLoggable(LogUtil.TAG, Log.DEBUG)){
+    		Log.d(LogUtil.TAG, "Location changed " + location.getProvider()); //$NON-NLS-1$
+    	}
+    	if(location != null && OsmandSettings.isSavingTrackToGpx(this)){
+			savingTrackHelper.insertData(location.getLatitude(), location.getLongitude(), 
+					location.getAltitude(), location.getSpeed(), location.getTime(), settings);
+		}
+    	registerUnregisterSensor(location);
+    	updateSpeedBearing(location);
+    	
+    	locationLayer.setLastKnownLocation(location);
+    	if(routingHelper.isFollowingMode()){
+    		routingHelper.setCurrentLocation(location);
+    	}
+    	if (location != null) {
+			if (isMapLinkedToLocation()) {
+				if(OsmandSettings.isAutoZoomEnabled(settings) && location.hasSpeed()){
+	    			int z = defineZoomFromSpeed(location.getSpeed(), mapView.getZoom());
+	    			if(mapView.getZoom() != z && !mapView.mapIsAnimating()){
+	    				long now = System.currentTimeMillis();
+	    				// prevent ui hysterisis (check time interval for autozoom)
+	    				if(Math.abs(mapView.getZoom() - z) > 1 || (lastTimeAutoZooming - now) > 6500){
+	    					lastTimeAutoZooming = now;
+	    					mapView.setZoom(z);
+	    				}
+	    			}
+	    		}
+				if (location.hasBearing() && currentMapRotation == OsmandSettings.ROTATE_MAP_BEARING) {
+					mapView.setRotate(-location.getBearing());
+				}
+				mapView.setLatLon(location.getLatitude(), location.getLongitude());
+			} else {
+				if(backToLocation.getVisibility() != View.VISIBLE){
+					backToLocation.setVisibility(View.VISIBLE);
+				}
+			}
+		} else {
+			if(backToLocation.getVisibility() != View.INVISIBLE){
+				backToLocation.setVisibility(View.INVISIBLE);
+			}
+		}
+    }
+    
+    public int defineZoomFromSpeed(float speed, int currentZoom){
+    	speed *= 3.6;
+    	if(speed < 4){
+    		return currentZoom;
+    	} else if(speed < 33){
+    		// less than 33 - show 17 
+    		return 17;
+    	} else if(speed < 53){
+    		return 16;
+    	} else if(speed < 83){
+    		return 15;
+    	}
+    	// more than 80 - show 14 (it is slow)
+    	return 14;
+    }
+
+	public void navigateToPoint(LatLon point){
+		if(point != null){
+			OsmandSettings.setPointToNavigate(this, point.getLatitude(), point.getLongitude());
+		} else {
+			OsmandSettings.clearPointToNavigate(settings);
+		}
+		routingHelper.setFinalAndCurrentLocation(point, null, routingHelper.getCurrentGPXRoute());
+		if(point == null){
+			routingHelper.setFollowingMode(false);
+			OsmandSettings.setFollowingByRoute(MapActivity.this, false);
+		}
+		navigationLayer.setPointToNavigate(point);
+	}
+	
+	public Location getLastKnownLocation(){
+		return locationLayer.getLastKnownLocation();
+	}
+	
+	public LatLon getMapLocation(){
+		return new LatLon(mapView.getLatitude(), mapView.getLongitude());
+	}
+	
+	public LatLon getPointToNavigate(){
+		return navigationLayer.getPointToNavigate();
+	}
+	
+	public RoutingHelper getRoutingHelper() {
+		return routingHelper;
+	}
+	
+	private boolean isRunningOnEmulator(){
+		if (Build.DEVICE.equals("generic")) { //$NON-NLS-1$ 
+			return true;
+		}  
+		return false;
+	}
+	
+	private boolean useOnlyGPS() {
+		return (routingHelper != null && routingHelper.isFollowingMode())
+				|| (System.currentTimeMillis() - lastTimeGPXLocationFixed) < USE_ONLY_GPS_INTERVAL || isRunningOnEmulator();
+	}
+    
+
+	// Working with location listeners
+	private LocationListener networkListener = new LocationListener(){
+		
+		@Override
+		public void onLocationChanged(Location location) {
+			// double check about use only gps
+			// that strange situation but it could happen?
+			if(!Algoritms.objectEquals(currentLocationProvider, LocationManager.GPS_PROVIDER) &&  
+					!useOnlyGPS()){
+				setLocation(location);
+			}
+		}
+
+		@Override
+		public void onProviderDisabled(String provider) {
+			if(!useOnlyGPS()){
+				setLocation(null);
+			}
+		}
+
+		@Override
+		public void onProviderEnabled(String provider) {
+		}
+
+		@Override
+		public void onStatusChanged(String provider, int status, Bundle extras) {
+			if(LocationProvider.OUT_OF_SERVICE == status && !useOnlyGPS()){
+				setLocation(null);
+			}
+		}
+	};
+	private LocationListener gpsListener = new LocationListener(){
+		@Override
+		public void onLocationChanged(Location location) {
+			if (location != null) {
+				lastTimeGPXLocationFixed = location.getTime();
+			}
+			setLocation(location);
+		}
+
+		@Override
+		public void onProviderDisabled(String provider) {
+			setLocation(null);
+		}
+
+		@Override
+		public void onProviderEnabled(String provider) {
+		}
+
+		@Override
+		public void onStatusChanged(String provider, int status, Bundle extras) {
+			LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
+			LocationProvider prov = service.getProvider(LocationManager.NETWORK_PROVIDER);
+			// do not change provider for temporarily unavailable (possible bug for htc hero 2.1 ?)
+			if (LocationProvider.OUT_OF_SERVICE == status /*|| LocationProvider.TEMPORARILY_UNAVAILABLE == status*/) {
+				if(LocationProvider.OUT_OF_SERVICE == status){
+					setLocation(null);
+				}
+				// do not use it in routing
+				if (!useOnlyGPS() &&  
+						service.isProviderEnabled(LocationManager.NETWORK_PROVIDER)) {
+					if (!Algoritms.objectEquals(currentLocationProvider, LocationManager.NETWORK_PROVIDER)) {
+						currentLocationProvider = LocationManager.NETWORK_PROVIDER;
+						service.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, GPS_TIMEOUT_REQUEST, GPS_DIST_REQUEST, this);
+						providerSupportsBearing = prov == null ? false : prov.supportsBearing() && !isRunningOnEmulator();
+						providerSupportsSpeed = prov == null ? false : prov.supportsSpeed() && !isRunningOnEmulator();
+					}
+				}
+			} else if (LocationProvider.AVAILABLE == status) {
+				if (!Algoritms.objectEquals(currentLocationProvider, LocationManager.GPS_PROVIDER)) {
+					currentLocationProvider = LocationManager.GPS_PROVIDER;
+					service.removeUpdates(networkListener);
+					prov = service.getProvider(LocationManager.GPS_PROVIDER);
+					providerSupportsBearing = prov == null ? false : prov.supportsBearing() && !isRunningOnEmulator();
+					providerSupportsSpeed = prov == null ? false : prov.supportsSpeed() && !isRunningOnEmulator();
+				}
+			}
+
+		}
+	};
+	
+	
+
+	
+	@Override
+	protected void onPause() {
+		super.onPause();
+		LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
+		service.removeUpdates(gpsListener);
+		service.removeUpdates(networkListener);
+		
+		SensorManager sensorMgr = (SensorManager) getSystemService(SENSOR_SERVICE);
+		sensorMgr.unregisterListener(this);
+		sensorRegistered = false;
+		currentLocationProvider = null;
+		routingHelper.setUiActivity(null);
+		
+		((OsmandApplication)getApplication()).getDaynightHelper().onMapPause();
+		
+		OsmandSettings.setLastKnownMapLocation(this, (float) mapView.getLatitude(), (float) mapView.getLongitude());
+		AnimateDraggingMapThread animatedThread = mapView.getAnimatedDraggingThread();
+		if(animatedThread.isAnimating() && animatedThread.getTargetZoom() != 0){
+			OsmandSettings.setMapLocationToShow(this, animatedThread.getTargetLatitude(), animatedThread.getTargetLongitude(), 
+					animatedThread.getTargetZoom());
+		}
+		
+		OsmandSettings.setLastKnownMapZoom(this, mapView.getZoom());
+		if (wakeLock != null) {
+			wakeLock.release();
+			wakeLock = null;
+		}
+		OsmandSettings.setMapActivityEnabled(this, false);
+		((OsmandApplication)getApplication()).getResourceManager().interruptRendering();
+		((OsmandApplication)getApplication()).getResourceManager().setBusyIndicator(null);
+	}
+	
+	private void updateApplicationModeSettings(){
+		currentMapRotation = OsmandSettings.getRotateMap(settings);
+		currentShowingAngle = OsmandSettings.isShowingViewAngle(settings);
+		if(currentMapRotation == OsmandSettings.ROTATE_MAP_NONE){
+			mapView.setRotate(0);
+		}
+		if(!currentShowingAngle){
+			locationLayer.setHeading(null);
+		}
+		locationLayer.setAppMode(OsmandSettings.getApplicationMode(settings));
+		routingHelper.setAppMode(OsmandSettings.getApplicationMode(settings));
+		mapView.setMapPosition(OsmandSettings.getPositionOnMap(settings));
+		registerUnregisterSensor(getLastKnownLocation());
+		updateLayers();
+	}
+	
+	private void updateLayers(){
+		if(mapView.getLayers().contains(transportStopsLayer) != OsmandSettings.isShowingTransportOverMap(settings)){
+			if(OsmandSettings.isShowingTransportOverMap(settings)){
+				mapView.addLayer(transportStopsLayer, 5);
+			} else {
+				mapView.removeLayer(transportStopsLayer);
+			}
+		}
+		if(mapView.getLayers().contains(osmBugsLayer) != OsmandSettings.isShowingOsmBugs(settings)){
+			if(OsmandSettings.isShowingOsmBugs(settings)){
+				mapView.addLayer(osmBugsLayer, 2);
+			} else {
+				mapView.removeLayer(osmBugsLayer);
+			}
+		}
+
+		if(mapView.getLayers().contains(poiMapLayer) != OsmandSettings.isShowingPoiOverMap(settings)){
+			if(OsmandSettings.isShowingPoiOverMap(settings)){
+				mapView.addLayer(poiMapLayer, 3);
+			} else {
+				mapView.removeLayer(poiMapLayer);
+			}
+		}
+		
+		if(mapView.getLayers().contains(favoritesLayer) != OsmandSettings.isShowingFavorites(settings)){
+			if(OsmandSettings.isShowingFavorites(settings)){
+				mapView.addLayer(favoritesLayer, 4);
+			} else {
+				mapView.removeLayer(favoritesLayer);
+			}
+		}
+		trafficLayer.setVisible(OsmandSettings.isShowingYandexTraffic(settings));
+	}
+	
+	private void updateMapSource(){
+		boolean vectorData = OsmandSettings.isUsingMapVectorData(settings);
+		OsmandApplication app = ((OsmandApplication)getApplication());
+		ResourceManager rm = app.getResourceManager();
+		if(vectorData && !app.isApplicationInitializing()){
+			if(rm.getRenderer().isEmpty()){
+				Toast.makeText(MapActivity.this, getString(R.string.no_vector_map_loaded), Toast.LENGTH_LONG).show();
+				vectorData = false;
+			}
+		}
+		ITileSource newSource = OsmandSettings.getMapTileSource(settings);
+		if(mapView.getMap() instanceof SQLiteTileSource){
+			((SQLiteTileSource)mapView.getMap()).closeDB();
+		}
+		rm.updateMapSource(vectorData, newSource);
+		
+		mapView.setMap(vectorData ? null : newSource);
+		ZoomControls zoomControls = (ZoomControls) findViewById(R.id.ZoomControls);
+		zoomControls.setIsZoomInEnabled(mapView.getZoom() + 1 < mapView.getMaximumShownMapZoom());
+		zoomControls.setIsZoomOutEnabled(mapView.getZoom() + 1 > mapView.getMinimumShownMapZoom());
+		rendererLayer.setVisible(vectorData);
+	}
+	
+	@Override
+	protected void onResume() {
+		super.onResume();
+		if(OsmandSettings.getMapOrientation(settings) != getRequestedOrientation()){
+			setRequestedOrientation(OsmandSettings.getMapOrientation(settings));
+			// can't return from this method we are not sure if activity will be recreated or not
+		}
+		currentScreenOrientation = getWindow().getWindowManager().getDefaultDisplay().getOrientation();
+		
+		boolean showTiles = !OsmandSettings.isUsingMapVectorData(settings);
+		ITileSource source = showTiles ? OsmandSettings.getMapTileSource(settings) : null;
+		if (showTiles != !rendererLayer.isVisible() || !Algoritms.objectEquals(mapView.getMap(), source)) {
+			updateMapSource();
+		}
+		
+		updateApplicationModeSettings();
+		
+
+		poiMapLayer.setFilter(OsmandSettings.getPoiFilterForMap(this, (OsmandApplication) getApplication()));
+		backToLocation.setVisibility(View.INVISIBLE);
+		
+		routingHelper.setUiActivity(this);
+
+		
+		LocationManager service = (LocationManager) getSystemService(LOCATION_SERVICE);
+		try {
+			service.requestLocationUpdates(LocationManager.GPS_PROVIDER, GPS_TIMEOUT_REQUEST, GPS_DIST_REQUEST, gpsListener);
+			currentLocationProvider = LocationManager.GPS_PROVIDER;
+		} catch (IllegalArgumentException e) {
+			Log.d(LogUtil.TAG, "GPS location provider not available"); //$NON-NLS-1$
+		}
+		if(!useOnlyGPS()){
+			// try to always  ask for network provide : it is faster way to find location
+			try {
+				service.requestLocationUpdates(LocationManager.NETWORK_PROVIDER, GPS_TIMEOUT_REQUEST, GPS_DIST_REQUEST, networkListener);
+				currentLocationProvider = LocationManager.NETWORK_PROVIDER;
+			} catch(IllegalArgumentException e) {
+				Log.d(LogUtil.TAG, "Network location provider not available"); //$NON-NLS-1$
+			}
+		}
+		
+		LocationProvider  prov = service.getProvider(currentLocationProvider); 
+		providerSupportsBearing = prov == null ? false : prov.supportsBearing() && !isRunningOnEmulator();
+		providerSupportsSpeed = prov == null ? false : prov.supportsSpeed() && !isRunningOnEmulator();
+		
+		if(settings != null && settings.contains(OsmandSettings.LAST_KNOWN_MAP_LAT)){
+			LatLon l = OsmandSettings.getLastKnownMapLocation(settings);
+			mapView.setLatLon(l.getLatitude(), l.getLongitude());
+			mapView.setZoom(OsmandSettings.getLastKnownMapZoom(settings));
+		}
+		
+		
+		if (wakeLock == null) {
+			PowerManager powerManager = (PowerManager) getSystemService(POWER_SERVICE);
+			wakeLock = powerManager.newWakeLock(PowerManager.SCREEN_BRIGHT_WAKE_LOCK, "net.osmand.map"); //$NON-NLS-1$
+			wakeLock.acquire();
+		}
+		
+		OsmandSettings.setMapActivityEnabled(this, true);
+		checkExternalStorage();
+		showAndHideMapPosition();
+		
+		LatLon latLon = OsmandSettings.getAndClearMapLocationToShow(settings);
+		LatLon cur = new LatLon(mapView.getLatitude(), mapView.getLongitude());
+		if (latLon != null && !latLon.equals(cur)) {
+			mapView.getAnimatedDraggingThread().startMoving(cur.getLatitude(), cur.getLongitude(), latLon.getLatitude(),
+					latLon.getLongitude(), mapView.getZoom(), OsmandSettings.getMapZoomToShow(settings), mapView.getSourceTileSize(),
+					mapView.getRotate(), true);
+		}
+		
+		
+		View progress = findViewById(R.id.ProgressBar);
+		if(progress != null){
+			((OsmandApplication) getApplication()).getResourceManager().setBusyIndicator(new BusyIndicator(this, progress));
+		}
+		
+		((OsmandApplication)getApplication()).getDaynightHelper().onMapResume();
+	}
+	
+	
+	@Override
+	public boolean onKeyUp(int keyCode, KeyEvent event) {
+		if (keyCode == KeyEvent.KEYCODE_DPAD_CENTER) {
+			contextMenuPoint(mapView.getLatitude(), mapView.getLongitude());
+	    	return true;
+		}
+		return false;
+	}
+	
+	public void checkExternalStorage(){
+		String state = Environment.getExternalStorageState();
+		if(Environment.MEDIA_MOUNTED.equals(state)){
+			// ok
+		} else if(Environment.MEDIA_MOUNTED_READ_ONLY.equals(state)){
+			Toast.makeText(this, R.string.sd_mounted_ro, Toast.LENGTH_LONG).show();
+		} else {
+			Toast.makeText(this, R.string.sd_unmounted, Toast.LENGTH_LONG).show();
+		}
+	}
+	
+	
+	public void showAndHideMapPosition(){
+		mapView.setShowMapPosition(true);
+		if(mapPositionHandler == null){
+			mapPositionHandler = new Handler();
+		}
+		Message msg = Message.obtain(mapPositionHandler, new Runnable(){
+			@Override
+			public void run() {
+				if(mapView.isShowMapPosition()){
+					mapView.setShowMapPosition(false);
+					mapView.refreshMap();
+				}
+			}
+			
+		});
+		msg.what = 7;
+		mapPositionHandler.removeMessages(7);
+		mapPositionHandler.sendMessageDelayed(msg, 2500);
+		
+	}
+	
+	
+
+	@Override
+	public void locationChanged(double newLatitude, double newLongitude, Object source) {
+		// when user start dragging 
+		if(locationLayer.getLastKnownLocation() != null){
+			if(isMapLinkedToLocation()){
+				OsmandSettings.setSyncMapToGpsLocation(MapActivity.this, false);
+			}
+			if (backToLocation.getVisibility() != View.VISIBLE) {
+				runOnUiThread(new Runnable() {
+					@Override
+					public void run() {
+						backToLocation.setVisibility(View.VISIBLE);
+					}
+				});
+			}
+		}
+	}
+	
+	public void setMapLocation(double lat, double lon){
+		mapView.setLatLon(lat, lon);
+		locationChanged(lat, lon, this);
+	}
+	
+	public OsmandMapTileView getMapView() {
+		return mapView;
+	}
+	
+	@Override
+	public void onSensorChanged(SensorEvent event) {
+		// Attention : sensor produces a lot of events & can hang the system
+		float val = event.values[0];
+		if(currentScreenOrientation == 1){
+			val += 90;
+		}
+		if (currentMapRotation == OsmandSettings.ROTATE_MAP_COMPASS) {
+			mapView.setRotate(-val);
+		}
+		if(currentShowingAngle){
+			if(locationLayer.getHeading() == null || Math.abs(locationLayer.getHeading() - val) > 10){
+				locationLayer.setHeading(val);
+			}
+		}
+		
+	}
+	
+	public boolean onCreateOptionsMenu(Menu menu) {
+		MenuInflater inflater = getMenuInflater();
+		inflater.inflate(R.menu.map_menu, menu);
+		return true;
+	}
+	
+	@Override
+	public boolean onPrepareOptionsMenu(Menu menu) {
+		boolean val = super.onPrepareOptionsMenu(menu);
+		MenuItem navigateToPointMenu = menu.findItem(R.id.map_navigate_to_point);
+		if (navigateToPointMenu != null) {
+			navigateToPointMenu.setTitle(routingHelper.isRouteCalculated() ? R.string.stop_routing : R.string.stop_navigation);
+			if (OsmandSettings.getPointToNavigate(settings) != null) {
+				navigateToPointMenu.setVisible(true);
+			} else {
+				navigateToPointMenu.setVisible(false);
+			}
+		}
+		MenuItem muteMenu = menu.findItem(R.id.map_mute); 
+		if(muteMenu != null){
+			muteMenu.setTitle(routingHelper.getVoiceRouter().isMute() ? R.string.menu_mute_on : R.string.menu_mute_off);
+			if (routingHelper.getFinalLocation() != null && routingHelper.isFollowingMode()) {
+				muteMenu.setVisible(true);
+			} else {
+				muteMenu.setVisible(false);
+			}
+		}
+		
+		return val;
+	}
+	
+    @Override
+    public boolean onOptionsItemSelected(MenuItem item) {
+		if (item.getItemId() == R.id.map_show_settings) {
+    		final Intent settings = new Intent(MapActivity.this, SettingsActivity.class);
+			startActivity(settings);
+    		return true;
+		} else if (item.getItemId() == R.id.map_where_am_i) {
+			backToLocationImpl();
+        	return true;
+		} else if (item.getItemId() == R.id.map_show_gps_status) {
+			Intent intent = new Intent();
+			intent.setComponent(new ComponentName(GPS_STATUS_COMPONENT, GPS_STATUS_ACTIVITY));
+			ResolveInfo resolved = getPackageManager().resolveActivity(intent, PackageManager.MATCH_DEFAULT_ONLY);
+			if(resolved != null){
+				startActivity(intent);
+			} else {
+				AlertDialog.Builder builder = new AlertDialog.Builder(this);
+				builder.setMessage(getString(R.string.gps_status_app_not_found));
+				builder.setPositiveButton(getString(R.string.default_buttons_yes),
+						new DialogInterface.OnClickListener() {
+							@Override
+							public void onClick(DialogInterface dialog, int which) {
+								Intent intent = new Intent(Intent.ACTION_VIEW, Uri.parse("market://search?q=pname:" + GPS_STATUS_COMPONENT));
+								try {
+									startActivity(intent);
+								} catch (ActivityNotFoundException e) {
+								}
+							}
+						});
+				builder.setNegativeButton(getString(R.string.default_buttons_no), null);
+				builder.show();
+			}
+			return true;
+//		} else if (item.getItemId() == R.id.map_mark_point) {
+//			contextMenuPoint(mapView.getLatitude(), mapView.getLongitude());
+//			return true;
+		} else if (item.getItemId() == R.id.map_get_directions) {
+			getDirections(mapView.getLatitude(), mapView.getLongitude(), true);
+			return true;
+		} else if (item.getItemId() == R.id.map_layers) {
+			openLayerSelectionDialog();
+			return true;
+		} else if (item.getItemId() == R.id.map_specify_point) {
+			NavigatePointActivity dlg = new NavigatePointActivity(this);
+			dlg.showDialog();
+			return true;
+		} else if (item.getItemId() == R.id.map_mute) {
+			routingHelper.getVoiceRouter().setMute(!routingHelper.getVoiceRouter().isMute());
+			return true;
+    	}  else if (item.getItemId() == R.id.map_navigate_to_point) {
+    		if(navigationLayer.getPointToNavigate() != null){
+    			if(routingHelper.isRouteCalculated()){
+    				routingHelper.setFinalAndCurrentLocation(null, null);
+    				OsmandSettings.setFollowingByRoute(MapActivity.this, false);
+    				routingHelper.setFollowingMode(false);
+    			} else {
+    				navigateToPoint(null);
+    			}
+    		} else {
+    			navigateToPoint(new LatLon(mapView.getLatitude(), mapView.getLongitude()));
+    		}
+			mapView.refreshMap();
+    	} else if (item.getItemId() == R.id.map_gpx_routing) {
+			useGPXFileLayer(true, navigationLayer.getPointToNavigate());
+			return true;
+    	} else if (item.getItemId() == R.id.map_show_point_options) {
+			contextMenuPoint(mapView.getLatitude(), mapView.getLongitude());
+    		return true;
+    	}
+    	return super.onOptionsItemSelected(item);
+    }
+    
+    private ApplicationMode getAppMode(ToggleButton[] buttons){
+    	for(int i=0; i<buttons.length; i++){
+    		if(buttons[i] != null && buttons[i].isChecked() && i < ApplicationMode.values().length){
+    			return ApplicationMode.values()[i];
+    		}
+    	}
+    	return OsmandSettings.getApplicationMode(settings);
+    }
+    
+    
+    protected void getDirections(final double lat, final double lon, boolean followEnabled){
+    	if(navigationLayer.getPointToNavigate() == null){
+			Toast.makeText(this, R.string.mark_final_location_first, Toast.LENGTH_LONG).show();
+			return;
+		}
+    	Builder builder = new AlertDialog.Builder(this);
+    	
+    	View view = getLayoutInflater().inflate(R.layout.calculate_route, null);
+    	final ToggleButton[] buttons = new ToggleButton[ApplicationMode.values().length];
+    	buttons[ApplicationMode.CAR.ordinal()] = (ToggleButton) view.findViewById(R.id.CarButton);
+    	buttons[ApplicationMode.BICYCLE.ordinal()] = (ToggleButton) view.findViewById(R.id.BicycleButton);
+    	buttons[ApplicationMode.PEDESTRIAN.ordinal()] = (ToggleButton) view.findViewById(R.id.PedestrianButton);
+    	ApplicationMode appMode = OsmandSettings.getApplicationMode(settings);
+    	for(int i=0; i< buttons.length; i++){
+    		if(buttons[i] != null){
+    			final int ind = i;
+    			ToggleButton b = buttons[i];
+    			b.setChecked(appMode == ApplicationMode.values()[i]);
+    			b.setOnCheckedChangeListener(new CompoundButton.OnCheckedChangeListener(){
+					@Override
+					public void onCheckedChanged(CompoundButton buttonView, boolean isChecked) {
+						if(isChecked){
+							for (int j = 0; j < buttons.length; j++) {
+								if (buttons[j] != null) {
+									if(buttons[j].isChecked() != (ind == j)){
+										buttons[j].setChecked(ind == j);
+									}
+								}
+							}
+						} else {
+							// revert state
+							boolean revert = true;
+							for (int j = 0; j < buttons.length; j++) {
+								if (buttons[j] != null) {
+									if(buttons[j].isChecked()){
+										revert = false;
+										break;
+									}
+								}
+							}
+							if (revert){ 
+								buttons[ind].setChecked(true);
+							}
+						}
+					}
+    			});
+    		}
+    	}
+    	
+    	DialogInterface.OnClickListener onlyShowCall = new DialogInterface.OnClickListener(){
+
+			@Override
+			public void onClick(DialogInterface dialog, int which) {
+				ApplicationMode mode = getAppMode(buttons);
+				Location map = new Location("map"); //$NON-NLS-1$
+				map.setLatitude(lat);
+				map.setLongitude(lon);
+				routingHelper.setAppMode(mode);
+				OsmandSettings.setFollowingByRoute(MapActivity.this, false);
+				routingHelper.setFollowingMode(false);
+				routingHelper.setFinalAndCurrentLocation(navigationLayer.getPointToNavigate(), map);
+			}
+    	};
+    	
+    	DialogInterface.OnClickListener followCall = new DialogInterface.OnClickListener(){
+			@Override
+			public void onClick(DialogInterface dialog, int which) {
+				ApplicationMode mode = getAppMode(buttons);
+				// change global settings
+				ApplicationMode old = OsmandSettings.getApplicationMode(settings);
+				if (old != mode) {
+					Editor edit = getSharedPreferences(OsmandSettings.SHARED_PREFERENCES_NAME, MODE_WORLD_WRITEABLE).edit();
+					edit.putString(OsmandSettings.APPLICATION_MODE, mode.name());
+					SettingsActivity.setAppMode(mode, edit, (OsmandApplication) getApplication(), old);
+					edit.commit();
+					updateApplicationModeSettings();	
+					mapView.refreshMap();
+				}
+				
+				Location location = locationLayer.getLastKnownLocation();
+				if(location == null){
+					location = new Location("map"); //$NON-NLS-1$
+					location.setLatitude(lat);
+					location.setLongitude(lon);
+				} 
+				routingHelper.setAppMode(mode);
+				OsmandSettings.setFollowingByRoute(MapActivity.this, true);
+				routingHelper.setFollowingMode(true);
+				routingHelper.setFinalAndCurrentLocation(navigationLayer.getPointToNavigate(), location);
+				
 				((OsmandApplication) getApplication()).showDialogInitializingCommandPlayer(MapActivity.this);
 				
-			}
-    	};
-    	DialogInterface.OnClickListener showRoute = new DialogInterface.OnClickListener(){
-			@Override
-			public void onClick(DialogInterface dialog, int which) {
-				Intent intent = new Intent(MapActivity.this, ShowRouteInfoActivity.class);
-				intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
-				startActivity(intent);
-			}
-		};
-    	
-    	builder.setView(view);
-    	if (followEnabled) {
-    		builder.setTitle(R.string.follow_route);
-			builder.setPositiveButton(R.string.follow, followCall);
-			if (routingHelper.isRouterEnabled() && routingHelper.isRouteCalculated()) {
-				builder.setNeutralButton(R.string.route_about, showRoute);
-			}
-			builder.setNegativeButton(R.string.only_show, onlyShowCall);
-		} else {
-			builder.setTitle(R.string.show_route);
-			view.findViewById(R.id.TextView).setVisibility(View.GONE);
-    		builder.setPositiveButton(R.string.show_route, onlyShowCall);
-    		builder.setNegativeButton(R.string.default_buttons_cancel, null);
-    	}
-    	builder.show();
-    }
-    
-    
-    
-    
-    protected void parseLaunchIntentLocation(){
-    	Intent intent = getIntent();
-    	if(intent != null && intent.getData() != null){
-    		Uri data = intent.getData();
-    		if("http".equalsIgnoreCase(data.getScheme()) && "download.osmand.net".equals(data.getHost()) &&
-    				"/go".equals( data.getPath())) {
-    			String lat = data.getQueryParameter("lat");
-    			String lon = data.getQueryParameter("lon");
-				if (lat != null && lon != null) {
-					try {
-						double lt = Double.parseDouble(lat);
-						double ln = Double.parseDouble(lon);
-						SharedPreferences prefs = OsmandSettings.getSharedPreferences(this);
-						Editor edit = prefs.edit();
-						edit.putFloat(OsmandSettings.LAST_KNOWN_MAP_LAT, (float) lt);
-						edit.putFloat(OsmandSettings.LAST_KNOWN_MAP_LON, (float) ln);
-						String zoom = data.getQueryParameter("z");
-						if(zoom != null){
-							edit.putInt(OsmandSettings.LAST_KNOWN_MAP_ZOOM, Integer.parseInt(zoom));
-						}
-						edit.commit();
-					} catch (NumberFormatException e) {
-					}
-				}
-    		}
-    	}
-    }
-    
-    
-	private void openLayerSelectionDialog(){
-		List<String> layersList = new ArrayList<String>();
-		layersList.add(getString(R.string.layer_map));
-		layersList.add(getString(R.string.layer_poi));
-		layersList.add(getString(R.string.layer_transport));
-		layersList.add(getString(R.string.layer_osm_bugs));
-		layersList.add(getString(R.string.layer_favorites));
-		layersList.add(getString(R.string.layer_gpx_layer));
-		final int routeInfoInd = routeInfoLayer.couldBeVisible() ? layersList.size() : -1;
-		if(routeInfoLayer.couldBeVisible()){
-			layersList.add(getString(R.string.layer_route));
-		}
-		final int transportRouteInfoInd = !TransportRouteHelper.getInstance().routeIsCalculated() ? - 1 : layersList.size(); 
-		if(transportRouteInfoInd > -1){
-			layersList.add(getString(R.string.layer_transport_route));
-		}
-		final int trafficInd = layersList.size();
-		layersList.add(getString(R.string.layer_yandex_traffic));
-		
-		final boolean[] selected = new boolean[layersList.size()];
-		Arrays.fill(selected, true);
-		selected[1] = OsmandSettings.isShowingPoiOverMap(settings);
-		selected[2] = OsmandSettings.isShowingTransportOverMap(settings);
-		selected[3] = OsmandSettings.isShowingOsmBugs(settings);
-		selected[4] = OsmandSettings.isShowingFavorites(settings);
-		selected[5] = gpxLayer.isVisible();
-		selected[trafficInd] = trafficLayer.isVisible();
-		if(routeInfoInd != -1){
-			selected[routeInfoInd] = routeInfoLayer.isUserDefinedVisible(); 
-		}
-		if(transportRouteInfoInd != -1){
-			selected[transportRouteInfoInd] = transportInfoLayer.isVisible(); 
-		}
-		
-		Builder builder = new AlertDialog.Builder(this);
-		builder.setMultiChoiceItems(layersList.toArray(new String[layersList.size()]), selected, new DialogInterface.OnMultiChoiceClickListener() {
-
-			@Override
-			public void onClick(DialogInterface dialog, int item, boolean isChecked) {
-				if (item == 0) {
-					dialog.dismiss();
-					selectMapLayer();
-				} else if(item == 1){
-					if(isChecked){
-						selectPOIFilterLayer();
-					}
-					OsmandSettings.setShowPoiOverMap(MapActivity.this, isChecked);
-				} else if(item == 2){
-					OsmandSettings.setShowTransortOverMap(MapActivity.this, isChecked);
-				} else if(item == 3){
-					OsmandSettings.setShowingOsmBugs(MapActivity.this, isChecked);
-				} else if(item == 4){
-					OsmandSettings.setShowingFavorites(MapActivity.this, isChecked);
-				} else if(item == 5){
-					if(gpxLayer.isVisible()){
-						gpxLayer.clearCurrentGPX();
-						getFavoritesHelper().setFavoritePointsFromGPXFile(null);
-					} else {
-						dialog.dismiss();
-						useGPXFileLayer(false, null);
-					}
-				} else if(item == routeInfoInd){
-					routeInfoLayer.setVisible(isChecked);
-				} else if(item == transportRouteInfoInd){
-					transportInfoLayer.setVisible(isChecked);
-				} else if(item == trafficInd){
-					OsmandSettings.setShowingYandexTraffic(MapActivity.this, isChecked);
-				}
-				updateLayers();
-				mapView.refreshMap();
-			}
-		});
-		builder.show();
-	}
-	
-	private void useGPXFileLayer(final boolean useRouting, final LatLon endForRouting) {
-		final List<String> list = new ArrayList<String>();
-		final File dir = OsmandSettings.extendOsmandPath(getApplicationContext(), ResourceManager.APP_DIR + SavingTrackHelper.TRACKS_PATH);
-		if (dir != null && dir.canRead()) {
-			File[] files = dir.listFiles();
-			if (files != null) {
-				Arrays.sort(files, new Comparator<File>() {
-					@Override
-					public int compare(File object1, File object2) {
-						if (object1.lastModified() > object2.lastModified()) {
-							return -1;
-						} else if (object1.lastModified() == object2.lastModified()) {
-							return 0;
-						}
-						return 1;
-					}
-
-				});
-
-				for (File f : files) {
-					if (f.getName().endsWith(".gpx")) { //$NON-NLS-1$
-						list.add(f.getName());
-					}
-				}
-			}
-		}
-		
-		if(list.isEmpty()){
-			Toast.makeText(this, R.string.gpx_files_not_found, Toast.LENGTH_LONG).show();
-		} else {
-			Builder builder = new AlertDialog.Builder(this);
-			builder.setItems(list.toArray(new String[list.size()]), new DialogInterface.OnClickListener() {
-
-				@Override
-				public void onClick(DialogInterface dialog, int which) {
-					dialog.dismiss();
-					final ProgressDialog dlg = ProgressDialog.show(MapActivity.this, getString(R.string.loading),
-							getString(R.string.loading_data));
-					final File f = new File(dir, list.get(which));
-					new Thread(new Runnable() {
-						@Override
-						public void run() {
-							Looper.prepare();
-							final GPXFileResult res = GPXUtilities.loadGPXFile(MapActivity.this, f);
-							if (res.error != null) {
-								runOnUiThread(new Runnable() {
-									@Override
-									public void run() {
-										Toast.makeText(MapActivity.this, res.error, Toast.LENGTH_LONG).show();
-									}
-								});
-
-							}
-							dlg.dismiss();
-							if(useRouting){
-								runOnUiThread(new Runnable() {
-									@Override
-									public void run() {
-										useGPXRouting(endForRouting, res);
-									}
-								});
-							} else {
-								OsmandSettings.setShowingFavorites(MapActivity.this, true);
-								List<FavouritePoint> pts = new ArrayList<FavouritePoint>();
-								for(WptPt p : res.wayPoints){
-									FavouritePoint pt = new FavouritePoint();
-									pt.setLatitude(p.lat);
-									pt.setLongitude(p.lon);
-									pt.setName(p.name);
-									pts.add(pt);
-								}
-								getFavoritesHelper().setFavoritePointsFromGPXFile(pts);
-								gpxLayer.setTracks(res.locations);
-							}
-							mapView.refreshMap();
-
-						}
-
-						
-					}, "Loading gpx").start(); //$NON-NLS-1$
-				}
-
-			});
-			builder.show();
-		}
-		
-	}
-	
-	public FavouritesDbHelper getFavoritesHelper() {
-		return ((OsmandApplication)getApplication()).getFavorites();
-	}
-	
-	private void useGPXRouting(final LatLon endForRouting, final GPXFileResult res) {
-		Builder builder = new AlertDialog.Builder(this);
-		builder.setItems(new String[]{getString(R.string.gpx_direct_route), getString(R.string.gpx_reverse_route)}, 
-				new DialogInterface.OnClickListener() {
-
-			@Override
-			public void onClick(DialogInterface dialog, int which) {
-				boolean reverse = which == 1;
-				ArrayList<List<Location>> locations = res.locations;
-				List<Location> l = new ArrayList<Location>();
-				for(List<Location> s : locations){
-					l.addAll(s);
-				}
-				if(reverse){
-					Collections.reverse(l);
-				}
-				Location startForRouting = locationLayer.getLastKnownLocation();
-				if(startForRouting == null && !l.isEmpty()){
-					startForRouting = l.get(0);
-				}
-				LatLon endPoint = endForRouting;
-				if(/*endForRouting == null && */!l.isEmpty()){
-					LatLon point = new LatLon(l.get(l.size() - 1).getLatitude(), l.get(l.size() - 1).getLongitude());
-					OsmandSettings.setPointToNavigate(MapActivity.this, point.getLatitude(), point.getLongitude());
-					endPoint = point;
-					navigationLayer.setPointToNavigate(point);
-				}
-				if(endForRouting != null){
-					OsmandSettings.setFollowingByRoute(MapActivity.this, true);
-					routingHelper.setFollowingMode(true);
-					routingHelper.setFinalAndCurrentLocation(endPoint, startForRouting, l);
+			}
+    	};
+    	DialogInterface.OnClickListener showRoute = new DialogInterface.OnClickListener(){
+			@Override
+			public void onClick(DialogInterface dialog, int which) {
+				Intent intent = new Intent(MapActivity.this, ShowRouteInfoActivity.class);
+				intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
+				startActivity(intent);
+			}
+		};
+    	
+    	builder.setView(view);
+    	if (followEnabled) {
+    		builder.setTitle(R.string.follow_route);
+			builder.setPositiveButton(R.string.follow, followCall);
+			if (routingHelper.isRouterEnabled() && routingHelper.isRouteCalculated()) {
+				builder.setNeutralButton(R.string.route_about, showRoute);
+			}
+			builder.setNegativeButton(R.string.only_show, onlyShowCall);
+		} else {
+			builder.setTitle(R.string.show_route);
+			view.findViewById(R.id.TextView).setVisibility(View.GONE);
+    		builder.setPositiveButton(R.string.show_route, onlyShowCall);
+    		builder.setNegativeButton(R.string.default_buttons_cancel, null);
+    	}
+    	builder.show();
+    }
+    
+    
+    
+    
+    protected void parseLaunchIntentLocation(){
+    	Intent intent = getIntent();
+    	if(intent != null && intent.getData() != null){
+    		Uri data = intent.getData();
+    		if("http".equalsIgnoreCase(data.getScheme()) && "download.osmand.net".equals(data.getHost()) &&
+    				"/go".equals( data.getPath())) {
+    			String lat = data.getQueryParameter("lat");
+    			String lon = data.getQueryParameter("lon");
+				if (lat != null && lon != null) {
+					try {
+						double lt = Double.parseDouble(lat);
+						double ln = Double.parseDouble(lon);
+						SharedPreferences prefs = OsmandSettings.getSharedPreferences(this);
+						Editor edit = prefs.edit();
+						edit.putFloat(OsmandSettings.LAST_KNOWN_MAP_LAT, (float) lt);
+						edit.putFloat(OsmandSettings.LAST_KNOWN_MAP_LON, (float) ln);
+						String zoom = data.getQueryParameter("z");
+						if(zoom != null){
+							edit.putInt(OsmandSettings.LAST_KNOWN_MAP_ZOOM, Integer.parseInt(zoom));
+						}
+						edit.commit();
+					} catch (NumberFormatException e) {
+					}
+				}
+    		}
+    	}
+    }
+    
+    
+	private void openLayerSelectionDialog(){
+		List<String> layersList = new ArrayList<String>();
+		layersList.add(getString(R.string.layer_map));
+		layersList.add(getString(R.string.layer_poi));
+		layersList.add(getString(R.string.layer_transport));
+		layersList.add(getString(R.string.layer_osm_bugs));
+		layersList.add(getString(R.string.layer_favorites));
+		layersList.add(getString(R.string.layer_gpx_layer));
+		final int routeInfoInd = routeInfoLayer.couldBeVisible() ? layersList.size() : -1;
+		if(routeInfoLayer.couldBeVisible()){
+			layersList.add(getString(R.string.layer_route));
+		}
+		final int transportRouteInfoInd = !TransportRouteHelper.getInstance().routeIsCalculated() ? - 1 : layersList.size(); 
+		if(transportRouteInfoInd > -1){
+			layersList.add(getString(R.string.layer_transport_route));
+		}
+		final int trafficInd = layersList.size();
+		layersList.add(getString(R.string.layer_yandex_traffic));
+		
+		final boolean[] selected = new boolean[layersList.size()];
+		Arrays.fill(selected, true);
+		selected[1] = OsmandSettings.isShowingPoiOverMap(settings);
+		selected[2] = OsmandSettings.isShowingTransportOverMap(settings);
+		selected[3] = OsmandSettings.isShowingOsmBugs(settings);
+		selected[4] = OsmandSettings.isShowingFavorites(settings);
+		selected[5] = gpxLayer.isVisible();
+		selected[trafficInd] = trafficLayer.isVisible();
+		if(routeInfoInd != -1){
+			selected[routeInfoInd] = routeInfoLayer.isUserDefinedVisible(); 
+		}
+		if(transportRouteInfoInd != -1){
+			selected[transportRouteInfoInd] = transportInfoLayer.isVisible(); 
+		}
+		
+		Builder builder = new AlertDialog.Builder(this);
+		builder.setMultiChoiceItems(layersList.toArray(new String[layersList.size()]), selected, new DialogInterface.OnMultiChoiceClickListener() {
+
+			@Override
+			public void onClick(DialogInterface dialog, int item, boolean isChecked) {
+				if (item == 0) {
+					dialog.dismiss();
+					selectMapLayer();
+				} else if(item == 1){
+					if(isChecked){
+						selectPOIFilterLayer();
+					}
+					OsmandSettings.setShowPoiOverMap(MapActivity.this, isChecked);
+				} else if(item == 2){
+					OsmandSettings.setShowTransortOverMap(MapActivity.this, isChecked);
+				} else if(item == 3){
+					OsmandSettings.setShowingOsmBugs(MapActivity.this, isChecked);
+				} else if(item == 4){
+					OsmandSettings.setShowingFavorites(MapActivity.this, isChecked);
+				} else if(item == 5){
+					if(gpxLayer.isVisible()){
+						gpxLayer.clearCurrentGPX();
+						getFavoritesHelper().setFavoritePointsFromGPXFile(null);
+					} else {
+						dialog.dismiss();
+						useGPXFileLayer(false, null);
+					}
+				} else if(item == routeInfoInd){
+					routeInfoLayer.setVisible(isChecked);
+				} else if(item == transportRouteInfoInd){
+					transportInfoLayer.setVisible(isChecked);
+				} else if(item == trafficInd){
+					OsmandSettings.setShowingYandexTraffic(MapActivity.this, isChecked);
+				}
+				updateLayers();
+				mapView.refreshMap();
+			}
+		});
+		builder.show();
+	}
+	
+	private void useGPXFileLayer(final boolean useRouting, final LatLon endForRouting) {
+		final List<String> list = new ArrayList<String>();
+		final File dir = OsmandSettings.extendOsmandPath(getApplicationContext(), ResourceManager.APP_DIR + SavingTrackHelper.TRACKS_PATH);
+		if (dir != null && dir.canRead()) {
+			File[] files = dir.listFiles();
+			if (files != null) {
+				Arrays.sort(files, new Comparator<File>() {
+					@Override
+					public int compare(File object1, File object2) {
+						if (object1.lastModified() > object2.lastModified()) {
+							return -1;
+						} else if (object1.lastModified() == object2.lastModified()) {
+							return 0;
+						}
+						return 1;
+					}
+
+				});
+
+				for (File f : files) {
+					if (f.getName().endsWith(".gpx")) { //$NON-NLS-1$
+						list.add(f.getName());
+					}
+				}
+			}
+		}
+		
+		if(list.isEmpty()){
+			Toast.makeText(this, R.string.gpx_files_not_found, Toast.LENGTH_LONG).show();
+		} else {
+			Builder builder = new AlertDialog.Builder(this);
+			builder.setItems(list.toArray(new String[list.size()]), new DialogInterface.OnClickListener() {
+
+				@Override
+				public void onClick(DialogInterface dialog, int which) {
+					dialog.dismiss();
+					final ProgressDialog dlg = ProgressDialog.show(MapActivity.this, getString(R.string.loading),
+							getString(R.string.loading_data));
+					final File f = new File(dir, list.get(which));
+					new Thread(new Runnable() {
+						@Override
+						public void run() {
+							Looper.prepare();
+							final GPXFileResult res = GPXUtilities.loadGPXFile(MapActivity.this, f);
+							if (res.error != null) {
+								runOnUiThread(new Runnable() {
+									@Override
+									public void run() {
+										Toast.makeText(MapActivity.this, res.error, Toast.LENGTH_LONG).show();
+									}
+								});
+
+							}
+							dlg.dismiss();
+							if(useRouting){
+								runOnUiThread(new Runnable() {
+									@Override
+									public void run() {
+										useGPXRouting(endForRouting, res);
+									}
+								});
+							} else {
+								OsmandSettings.setShowingFavorites(MapActivity.this, true);
+								List<FavouritePoint> pts = new ArrayList<FavouritePoint>();
+								for(WptPt p : res.wayPoints){
+									FavouritePoint pt = new FavouritePoint();
+									pt.setLatitude(p.lat);
+									pt.setLongitude(p.lon);
+									pt.setName(p.name);
+									pts.add(pt);
+								}
+								getFavoritesHelper().setFavoritePointsFromGPXFile(pts);
+								gpxLayer.setTracks(res.locations);
+							}
+							mapView.refreshMap();
+
+						}
+
+						
+					}, "Loading gpx").start(); //$NON-NLS-1$
+				}
+
+			});
+			builder.show();
+		}
+		
+	}
+	
+	public FavouritesDbHelper getFavoritesHelper() {
+		return ((OsmandApplication)getApplication()).getFavorites();
+	}
+	
+	private void useGPXRouting(final LatLon endForRouting, final GPXFileResult res) {
+		Builder builder = new AlertDialog.Builder(this);
+		builder.setItems(new String[]{getString(R.string.gpx_direct_route), getString(R.string.gpx_reverse_route)}, 
+				new DialogInterface.OnClickListener() {
+
+			@Override
+			public void onClick(DialogInterface dialog, int which) {
+				boolean reverse = which == 1;
+				ArrayList<List<Location>> locations = res.locations;
+				List<Location> l = new ArrayList<Location>();
+				for(List<Location> s : locations){
+					l.addAll(s);
+				}
+				if(reverse){
+					Collections.reverse(l);
+				}
+				Location startForRouting = locationLayer.getLastKnownLocation();
+				if(startForRouting == null && !l.isEmpty()){
+					startForRouting = l.get(0);
+				}
+				LatLon endPoint = endForRouting;
+				if(/*endForRouting == null && */!l.isEmpty()){
+					LatLon point = new LatLon(l.get(l.size() - 1).getLatitude(), l.get(l.size() - 1).getLongitude());
+					OsmandSettings.setPointToNavigate(MapActivity.this, point.getLatitude(), point.getLongitude());
+					endPoint = point;
+					navigationLayer.setPointToNavigate(point);
+				}
+				if(endForRouting != null){
+					OsmandSettings.setFollowingByRoute(MapActivity.this, true);
+					routingHelper.setFollowingMode(true);
+					routingHelper.setFinalAndCurrentLocation(endPoint, startForRouting, l);
 					((OsmandApplication)getApplication()).showDialogInitializingCommandPlayer(MapActivity.this);
-				}
-				
-			}
-		
-		});
-		builder.show();
-	}
-		
-	private void selectPOIFilterLayer(){
-		final List<PoiFilter> userDefined = new ArrayList<PoiFilter>();
-		List<String> list = new ArrayList<String>();
-		list.add(getString(R.string.any_poi));
-		
-		final PoiFiltersHelper poiFilters = ((OsmandApplication)getApplication()).getPoiFilters();
-		for (PoiFilter f : poiFilters.getUserDefinedPoiFilters()) {
-			userDefined.add(f);
-			list.add(f.getName());
-		}
-		for(AmenityType t : AmenityType.values()){
-			list.add(OsmAndFormatter.toPublicString(t, this));
-		}
-		Builder builder = new AlertDialog.Builder(this);
-		builder.setItems(list.toArray(new String[list.size()]), new DialogInterface.OnClickListener(){
-
-			@Override
-			public void onClick(DialogInterface dialog, int which) {
-				String filterId;
-				if (which == 0) {
-					filterId = PoiFiltersHelper.getOsmDefinedFilterId(null);
-				} else if (which <= userDefined.size()) {
-					filterId = userDefined.get(which - 1).getFilterId();
-				} else {
-					filterId = PoiFiltersHelper.getOsmDefinedFilterId(AmenityType.values()[which - userDefined.size() - 1]);
-				}
-				if(filterId.equals(PoiFilter.CUSTOM_FILTER_ID)){
-					Intent newIntent = new Intent(MapActivity.this, EditPOIFilterActivity.class);
-					newIntent.putExtra(EditPOIFilterActivity.AMENITY_FILTER, filterId);
-					newIntent.putExtra(EditPOIFilterActivity.SEARCH_LAT, mapView.getLatitude());
-					newIntent.putExtra(EditPOIFilterActivity.SEARCH_LON, mapView.getLongitude());
-					startActivity(newIntent);
-				} else {
-					OsmandSettings.setPoiFilterForMap(MapActivity.this, filterId);
-					poiMapLayer.setFilter(poiFilters.getFilterById(filterId));
-					mapView.refreshMap();
-				}
-			}
-			
-		});
-		builder.show();
-	}
-	
-	private void selectMapLayer(){
-		Map<String, String> entriesMap = SettingsActivity.getTileSourceEntries(this);
-		Builder builder = new AlertDialog.Builder(this);
-		final ArrayList<String> keys = new ArrayList<String>(entriesMap.keySet());
-		String[] items = new String[entriesMap.size() + 1];
-		items[0] = getString(R.string.vector_data);
-		int i = 1;
-		for(String it : entriesMap.values()){
-			items[i++] = it;
-		}
-		builder.setItems(items, new DialogInterface.OnClickListener(){
-			@Override
-			public void onClick(DialogInterface dialog, int which) {
-				Editor edit = OsmandSettings.getWriteableEditor(MapActivity.this);
-				if(which == 0){
-					MapRenderRepositories r = ((OsmandApplication)getApplication()).getResourceManager().getRenderer();
-					if(r.isEmpty()){
-						Toast.makeText(MapActivity.this, getString(R.string.no_vector_map_loaded), Toast.LENGTH_LONG).show();
-						return;
-					} else {
-						edit.putBoolean(OsmandSettings.MAP_VECTOR_DATA, true);
-					}
-				} else {
-					edit.putBoolean(OsmandSettings.MAP_VECTOR_DATA, false);
-					edit.putString(OsmandSettings.MAP_TILE_SOURCES, keys.get(which - 1));
-				}
-				edit.commit();
-				updateMapSource();
-			}
-			
-		});
-		builder.show();
-	}
-
-    
-	public void contextMenuPoint(final double latitude, final double longitude){
-		contextMenuPoint(latitude, longitude, null, null);
-	}
-	
-    public void contextMenuPoint(final double latitude, final double longitude, List<String> additionalItems, 
-    		final DialogInterface.OnClickListener additionalActions){
-    	Builder builder = new AlertDialog.Builder(this);
-    	final int sizeAdditional = additionalActions == null || additionalItems == null ? 0 : additionalItems.size();
-    	List<String> actions = new ArrayList<String>();
-    	if(sizeAdditional > 0){
-    		actions.addAll(additionalItems);
-    	}
-    	final int[] contextMenuStandardActions = new int[]{
-    			R.string.context_menu_item_navigate_point,
-    			R.string.context_menu_item_search_poi,
-    			R.string.context_menu_item_show_route,
-    			R.string.context_menu_item_search_transport,
-    			R.string.context_menu_item_add_favorite,
-    			R.string.context_menu_item_share_location,
-    			R.string.context_menu_item_create_poi,
-    			R.string.context_menu_item_add_waypoint,
-    			R.string.context_menu_item_open_bug,
-    			R.string.context_menu_item_update_map,
-    			R.string.context_menu_item_download_map
-    	};
-    	for(int j = 0; j<contextMenuStandardActions.length; j++){
-    		actions.add(getResources().getString(contextMenuStandardActions[j]));
-    	}
-    	
-    	builder.setItems(actions.toArray(new String[actions.size()]), new DialogInterface.OnClickListener(){
-
-			@Override
-			public void onClick(DialogInterface dialog, int which) {
-				if(which < sizeAdditional){
-					additionalActions.onClick(dialog, which);
-					return;
-				}
-				int standardId = contextMenuStandardActions[which - sizeAdditional];
-				if(standardId == R.string.context_menu_item_navigate_point){
-					navigateToPoint(new LatLon(latitude, longitude));
-				} else if(standardId == R.string.context_menu_item_search_poi){
-					Intent intent = new Intent(MapActivity.this, SearchPoiFilterActivity.class);
-					intent.putExtra(SearchPoiFilterActivity.SEARCH_LAT, latitude);
-					intent.putExtra(SearchPoiFilterActivity.SEARCH_LON, longitude);
-					intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
-					startActivity(intent);
-				} else if(standardId == R.string.context_menu_item_show_route){
-					getDirections(latitude, longitude, false);
-				} else if(standardId == R.string.context_menu_item_search_transport){
-					Intent intent = new Intent(MapActivity.this, SearchTransportActivity.class);
-					intent.putExtra(SearchTransportActivity.LAT_KEY, latitude);
-					intent.putExtra(SearchTransportActivity.LON_KEY, longitude);
-					startActivity(intent);
-				} else if(standardId == R.string.context_menu_item_add_favorite){
-					mapActions.addFavouritePoint(latitude, longitude);
-				} else if(standardId == R.string.context_menu_item_share_location){
-					mapActions.shareLocation(latitude, longitude, mapView.getZoom());
-				} else if(standardId == R.string.context_menu_item_search_poi){
-					EditingPOIActivity activity = new EditingPOIActivity(MapActivity.this, (OsmandApplication) getApplication(), mapView);
-					activity.showCreateDialog(latitude, longitude);
-				} else if(standardId == R.string.context_menu_item_add_waypoint){
-					mapActions.addWaypoint(latitude, longitude, savingTrackHelper);
-				} else if(standardId == R.string.context_menu_item_open_bug){
-					osmBugsLayer.openBug(MapActivity.this, getLayoutInflater(), mapView, latitude, longitude);
-				} else if(standardId == R.string.context_menu_item_update_map){
-					mapActions.reloadTile(mapView.getZoom(), latitude, longitude);
-				} else if(standardId == R.string.context_menu_item_download_map){
-					DownloadTilesDialog dlg = new DownloadTilesDialog(MapActivity.this, 
-							(OsmandApplication) getApplication(), mapView);
-					dlg.openDialog();
-				}
-			}
-    	});
-		builder.create().show();
-    }
-    
-	@Override
-	public void onAccuracyChanged(Sensor sensor, int accuracy) {
-	}
-
-	
-
-}
+				}
+				
+			}
+		
+		});
+		builder.show();
+	}
+		
+	private void selectPOIFilterLayer(){
+		final List<PoiFilter> userDefined = new ArrayList<PoiFilter>();
+		List<String> list = new ArrayList<String>();
+		list.add(getString(R.string.any_poi));
+		
+		final PoiFiltersHelper poiFilters = ((OsmandApplication)getApplication()).getPoiFilters();
+		for (PoiFilter f : poiFilters.getUserDefinedPoiFilters()) {
+			userDefined.add(f);
+			list.add(f.getName());
+		}
+		for(AmenityType t : AmenityType.values()){
+			list.add(OsmAndFormatter.toPublicString(t, this));
+		}
+		Builder builder = new AlertDialog.Builder(this);
+		builder.setItems(list.toArray(new String[list.size()]), new DialogInterface.OnClickListener(){
+
+			@Override
+			public void onClick(DialogInterface dialog, int which) {
+				String filterId;
+				if (which == 0) {
+					filterId = PoiFiltersHelper.getOsmDefinedFilterId(null);
+				} else if (which <= userDefined.size()) {
+					filterId = userDefined.get(which - 1).getFilterId();
+				} else {
+					filterId = PoiFiltersHelper.getOsmDefinedFilterId(AmenityType.values()[which - userDefined.size() - 1]);
+				}
+				if(filterId.equals(PoiFilter.CUSTOM_FILTER_ID)){
+					Intent newIntent = new Intent(MapActivity.this, EditPOIFilterActivity.class);
+					newIntent.putExtra(EditPOIFilterActivity.AMENITY_FILTER, filterId);
+					newIntent.putExtra(EditPOIFilterActivity.SEARCH_LAT, mapView.getLatitude());
+					newIntent.putExtra(EditPOIFilterActivity.SEARCH_LON, mapView.getLongitude());
+					startActivity(newIntent);
+				} else {
+					OsmandSettings.setPoiFilterForMap(MapActivity.this, filterId);
+					poiMapLayer.setFilter(poiFilters.getFilterById(filterId));
+					mapView.refreshMap();
+				}
+			}
+			
+		});
+		builder.show();
+	}
+	
+	private void selectMapLayer(){
+		Map<String, String> entriesMap = SettingsActivity.getTileSourceEntries(this);
+		Builder builder = new AlertDialog.Builder(this);
+		final ArrayList<String> keys = new ArrayList<String>(entriesMap.keySet());
+		String[] items = new String[entriesMap.size() + 1];
+		items[0] = getString(R.string.vector_data);
+		int i = 1;
+		for(String it : entriesMap.values()){
+			items[i++] = it;
+		}
+		builder.setItems(items, new DialogInterface.OnClickListener(){
+			@Override
+			public void onClick(DialogInterface dialog, int which) {
+				Editor edit = OsmandSettings.getWriteableEditor(MapActivity.this);
+				if(which == 0){
+					MapRenderRepositories r = ((OsmandApplication)getApplication()).getResourceManager().getRenderer();
+					if(r.isEmpty()){
+						Toast.makeText(MapActivity.this, getString(R.string.no_vector_map_loaded), Toast.LENGTH_LONG).show();
+						return;
+					} else {
+						edit.putBoolean(OsmandSettings.MAP_VECTOR_DATA, true);
+					}
+				} else {
+					edit.putBoolean(OsmandSettings.MAP_VECTOR_DATA, false);
+					edit.putString(OsmandSettings.MAP_TILE_SOURCES, keys.get(which - 1));
+				}
+				edit.commit();
+				updateMapSource();
+			}
+			
+		});
+		builder.show();
+	}
+
+    
+	public void contextMenuPoint(final double latitude, final double longitude){
+		contextMenuPoint(latitude, longitude, null, null);
+	}
+	
+    public void contextMenuPoint(final double latitude, final double longitude, List<String> additionalItems, 
+    		final DialogInterface.OnClickListener additionalActions){
+    	Builder builder = new AlertDialog.Builder(this);
+    	final int sizeAdditional = additionalActions == null || additionalItems == null ? 0 : additionalItems.size();
+    	List<String> actions = new ArrayList<String>();
+    	if(sizeAdditional > 0){
+    		actions.addAll(additionalItems);
+    	}
+    	final int[] contextMenuStandardActions = new int[]{
+    			R.string.context_menu_item_navigate_point,
+    			R.string.context_menu_item_search_poi,
+    			R.string.context_menu_item_show_route,
+    			R.string.context_menu_item_search_transport,
+    			R.string.context_menu_item_add_favorite,
+    			R.string.context_menu_item_share_location,
+    			R.string.context_menu_item_create_poi,
+    			R.string.context_menu_item_add_waypoint,
+    			R.string.context_menu_item_open_bug,
+    			R.string.context_menu_item_update_map,
+    			R.string.context_menu_item_download_map
+    	};
+    	for(int j = 0; j<contextMenuStandardActions.length; j++){
+    		actions.add(getResources().getString(contextMenuStandardActions[j]));
+    	}
+    	
+    	builder.setItems(actions.toArray(new String[actions.size()]), new DialogInterface.OnClickListener(){
+
+			@Override
+			public void onClick(DialogInterface dialog, int which) {
+				if(which < sizeAdditional){
+					additionalActions.onClick(dialog, which);
+					return;
+				}
+				int standardId = contextMenuStandardActions[which - sizeAdditional];
+				if(standardId == R.string.context_menu_item_navigate_point){
+					navigateToPoint(new LatLon(latitude, longitude));
+				} else if(standardId == R.string.context_menu_item_search_poi){
+					Intent intent = new Intent(MapActivity.this, SearchPoiFilterActivity.class);
+					intent.putExtra(SearchPoiFilterActivity.SEARCH_LAT, latitude);
+					intent.putExtra(SearchPoiFilterActivity.SEARCH_LON, longitude);
+					intent.setFlags(Intent.FLAG_ACTIVITY_CLEAR_TOP);
+					startActivity(intent);
+				} else if(standardId == R.string.context_menu_item_show_route){
+					getDirections(latitude, longitude, false);
+				} else if(standardId == R.string.context_menu_item_search_transport){
+					Intent intent = new Intent(MapActivity.this, SearchTransportActivity.class);
+					intent.putExtra(SearchTransportActivity.LAT_KEY, latitude);
+					intent.putExtra(SearchTransportActivity.LON_KEY, longitude);
+					startActivity(intent);
+				} else if(standardId == R.string.context_menu_item_add_favorite){
+					mapActions.addFavouritePoint(latitude, longitude);
+				} else if(standardId == R.string.context_menu_item_share_location){
+					mapActions.shareLocation(latitude, longitude, mapView.getZoom());
+				} else if(standardId == R.string.context_menu_item_search_poi){
+					EditingPOIActivity activity = new EditingPOIActivity(MapActivity.this, (OsmandApplication) getApplication(), mapView);
+					activity.showCreateDialog(latitude, longitude);
+				} else if(standardId == R.string.context_menu_item_add_waypoint){
+					mapActions.addWaypoint(latitude, longitude, savingTrackHelper);
+				} else if(standardId == R.string.context_menu_item_open_bug){
+					osmBugsLayer.openBug(MapActivity.this, getLayoutInflater(), mapView, latitude, longitude);
+				} else if(standardId == R.string.context_menu_item_update_map){
+					mapActions.reloadTile(mapView.getZoom(), latitude, longitude);
+				} else if(standardId == R.string.context_menu_item_download_map){
+					DownloadTilesDialog dlg = new DownloadTilesDialog(MapActivity.this, 
+							(OsmandApplication) getApplication(), mapView);
+					dlg.openDialog();
+				}
+			}
+    	});
+		builder.create().show();
+    }
+    
+	@Override
+	public void onAccuracyChanged(Sensor sensor, int accuracy) {
+	}
+
+	
+
+}
diff --git a/OsmAnd/src/net/osmand/plus/activities/OsmandApplication.java b/OsmAnd/src/net/osmand/plus/activities/OsmandApplication.java
index 0c702017b17..16186fcd37b 100644
--- a/OsmAnd/src/net/osmand/plus/activities/OsmandApplication.java
+++ b/OsmAnd/src/net/osmand/plus/activities/OsmandApplication.java
@@ -1,119 +1,119 @@
-package net.osmand.plus.activities;
-
-import java.io.BufferedWriter;
-import java.io.ByteArrayOutputStream;
-import java.io.File;
-import java.io.FileWriter;
-import java.io.PrintStream;
-import java.lang.Thread.UncaughtExceptionHandler;
-import java.util.List;
-
-import net.osmand.Algoritms;
-import net.osmand.LogUtil;
-import net.osmand.plus.FavouritesDbHelper;
-import net.osmand.plus.NavigationService;
-import net.osmand.plus.OsmandSettings;
-import net.osmand.plus.PoiFiltersHelper;
-import net.osmand.plus.ProgressDialogImplementation;
-import net.osmand.plus.R;
-import net.osmand.plus.ResourceManager;
-import net.osmand.plus.voice.CommandPlayer;
-import android.app.AlertDialog;
-import android.app.Application;
-import android.app.ProgressDialog;
-import android.app.AlertDialog.Builder;
-import android.content.Context;
-import android.content.DialogInterface;
-import android.content.Intent;
-import android.os.Handler;
-import android.text.format.DateFormat;
-import android.util.Log;
-import android.widget.Toast;
-
-public class OsmandApplication extends Application {
-	public static final String EXCEPTION_PATH = ResourceManager.APP_DIR + "exception.log"; //$NON-NLS-1$
-	
-	ResourceManager manager = null; 
-	PoiFiltersHelper poiFilters = null;
-	RoutingHelper routingHelper = null;
-	FavouritesDbHelper favorites = null;
+package net.osmand.plus.activities;
+
+import java.io.BufferedWriter;
+import java.io.ByteArrayOutputStream;
+import java.io.File;
+import java.io.FileWriter;
+import java.io.PrintStream;
+import java.lang.Thread.UncaughtExceptionHandler;
+import java.util.List;
+
+import net.osmand.Algoritms;
+import net.osmand.LogUtil;
+import net.osmand.plus.FavouritesDbHelper;
+import net.osmand.plus.NavigationService;
+import net.osmand.plus.OsmandSettings;
+import net.osmand.plus.PoiFiltersHelper;
+import net.osmand.plus.ProgressDialogImplementation;
+import net.osmand.plus.R;
+import net.osmand.plus.ResourceManager;
+import net.osmand.plus.voice.CommandPlayer;
+import android.app.AlertDialog;
+import android.app.Application;
+import android.app.ProgressDialog;
+import android.app.AlertDialog.Builder;
+import android.content.Context;
+import android.content.DialogInterface;
+import android.content.Intent;
+import android.os.Handler;
+import android.text.format.DateFormat;
+import android.util.Log;
+import android.widget.Toast;
+
+public class OsmandApplication extends Application {
+	public static final String EXCEPTION_PATH = ResourceManager.APP_DIR + "exception.log"; //$NON-NLS-1$
+	
+	ResourceManager manager = null; 
+	PoiFiltersHelper poiFilters = null;
+	RoutingHelper routingHelper = null;
+	FavouritesDbHelper favorites = null;
 	CommandPlayer player = null;
-	
-	
-	// start variables
-	private ProgressDialogImplementation startDialog;
-	private List<String> startingWarnings;
-	private ProgressDialog progressDlg;
-	private Handler uiHandler;
-	private DayNightHelper daynightHelper;
-	private NavigationService navigationService;
-	private boolean applicationInitializing = false;
-	
-	
-    public void	onCreate(){
-    	super.onCreate();
-    	routingHelper = new RoutingHelper(OsmandSettings.getApplicationMode(OsmandSettings.getPrefs(OsmandApplication.this)), OsmandApplication.this, player);
-    	manager = new ResourceManager(this);
-    	daynightHelper = new DayNightHelper(this);
-    	uiHandler = new Handler();
-    	startApplication();
-	}
-    
-    public PoiFiltersHelper getPoiFilters() {
-    	if(poiFilters == null){
-    		poiFilters = new PoiFiltersHelper(this);
-    	}
-		return poiFilters;
-	}
-    
-    public FavouritesDbHelper getFavorites() {
-    	if(favorites == null) {
-    		favorites = new FavouritesDbHelper(this);
-    	}
-		return favorites;
-	}
-    
-    public ResourceManager getResourceManager() {
-		return manager;
-	}
-    
-    public DayNightHelper getDaynightHelper() {
-		return daynightHelper;
-	}
-	
-	@Override
-	public void onLowMemory() {
-		super.onLowMemory();
-		manager.onLowMemory();
-	}
-	
-	public ProgressDialog checkApplicationIsBeingInitialized(Context uiContext){
-		// start application if it was previously closed
-		startApplication();
-		synchronized (OsmandApplication.this) {
-			if(startDialog != null){
-				progressDlg = ProgressDialog.show(uiContext, getString(R.string.loading_data), getString(R.string.reading_indexes), true);
-				startDialog.setDialog(progressDlg);
-				return progressDlg;
-			}  else if(startingWarnings != null){
-				showWarnings(startingWarnings, uiContext);
-			}
-		}
-		return null;
-	}
-	
-	public boolean isApplicationInitializing(){
-		return startDialog != null;
-	}
-	
-	public RoutingHelper getRoutingHelper() {
-		return routingHelper;
-	}
-	
-	public CommandPlayer getPlayer() {
-		return player;
-	}
-	
+	
+	
+	// start variables
+	private ProgressDialogImplementation startDialog;
+	private List<String> startingWarnings;
+	private ProgressDialog progressDlg;
+	private Handler uiHandler;
+	private DayNightHelper daynightHelper;
+	private NavigationService navigationService;
+	private boolean applicationInitializing = false;
+	
+	
+    public void	onCreate(){
+    	super.onCreate();
+    	routingHelper = new RoutingHelper(OsmandSettings.getApplicationMode(OsmandSettings.getPrefs(OsmandApplication.this)), OsmandApplication.this, player);
+    	manager = new ResourceManager(this);
+    	daynightHelper = new DayNightHelper(this);
+    	uiHandler = new Handler();
+    	startApplication();
+	}
+    
+    public PoiFiltersHelper getPoiFilters() {
+    	if(poiFilters == null){
+    		poiFilters = new PoiFiltersHelper(this);
+    	}
+		return poiFilters;
+	}
+    
+    public FavouritesDbHelper getFavorites() {
+    	if(favorites == null) {
+    		favorites = new FavouritesDbHelper(this);
+    	}
+		return favorites;
+	}
+    
+    public ResourceManager getResourceManager() {
+		return manager;
+	}
+    
+    public DayNightHelper getDaynightHelper() {
+		return daynightHelper;
+	}
+	
+	@Override
+	public void onLowMemory() {
+		super.onLowMemory();
+		manager.onLowMemory();
+	}
+	
+	public ProgressDialog checkApplicationIsBeingInitialized(Context uiContext){
+		// start application if it was previously closed
+		startApplication();
+		synchronized (OsmandApplication.this) {
+			if(startDialog != null){
+				progressDlg = ProgressDialog.show(uiContext, getString(R.string.loading_data), getString(R.string.reading_indexes), true);
+				startDialog.setDialog(progressDlg);
+				return progressDlg;
+			}  else if(startingWarnings != null){
+				showWarnings(startingWarnings, uiContext);
+			}
+		}
+		return null;
+	}
+	
+	public boolean isApplicationInitializing(){
+		return startDialog != null;
+	}
+	
+	public RoutingHelper getRoutingHelper() {
+		return routingHelper;
+	}
+	
+	public CommandPlayer getPlayer() {
+		return player;
+	}
+	
 
 	public void showDialogInitializingCommandPlayer(final Context uiContext){
 		String voiceProvider = OsmandSettings.getVoiceProvider(OsmandSettings.getPrefs(this));
@@ -130,12 +130,12 @@ public void onClick(DialogInterface dialog, int which) {
 			});
 			builder.setTitle(R.string.voice_is_not_available_title);
 			builder.setMessage(R.string.voice_is_not_available_msg);
-			builder.show();
-		} else {
-			if(player == null 
-					|| !Algoritms.objectEquals(voiceProvider, player.getCurrentVoice())){
-				initVoiceDataInDifferentThread(uiContext);
-			}
+			builder.show();
+		} else {
+			if(player == null 
+					|| !Algoritms.objectEquals(voiceProvider, player.getCurrentVoice())){
+				initVoiceDataInDifferentThread(uiContext);
+			}
 		}
 		
 	}
@@ -160,85 +160,85 @@ public void run() {
 	
 	public String initCommandPlayer() {
 		if (player == null) {
-			player = new CommandPlayer(OsmandApplication.this);
-			routingHelper.getVoiceRouter().setPlayer(player);
-		}
+			player = new CommandPlayer(OsmandApplication.this);
+			routingHelper.getVoiceRouter().setPlayer(player);
+		}
 		return player.init(OsmandSettings.getVoiceProvider(OsmandSettings.getPrefs(this)));
-	}
-	
-	public NavigationService getNavigationService() {
-		return navigationService;
-	}
-	
-	public void setNavigationService(NavigationService navigationService) {
-		this.navigationService = navigationService;
-	}
-	
-	public synchronized void closeApplication(){
-		if(applicationInitializing){
-			manager.close();
-		}
-		applicationInitializing = false; 
-	}
-	
-
-	public synchronized void startApplication() {
-		if(applicationInitializing){
-			return;
-		}
-		applicationInitializing = true;
-		startDialog = new ProgressDialogImplementation(this, null, false);
-
-		startDialog.setRunnable("Initializing app", new Runnable() { //$NON-NLS-1$
-
-					@Override
-					public void run() {
-						List<String> warnings = null;
-						try {
-							warnings = manager.reloadIndexes(startDialog);
-							player = null;
-							SavingTrackHelper helper = new SavingTrackHelper(OsmandApplication.this);
-							if (helper.hasDataToSave()) {
-								startDialog.startTask(getString(R.string.saving_gpx_tracks), -1);
-								warnings.addAll(helper.saveDataToGpx());
-							}
-							helper.close();
-
-						} finally {
-							synchronized (OsmandApplication.this) {
-								startDialog = null;
-								if (progressDlg != null) {
-									progressDlg.dismiss();
-									showWarnings(warnings, progressDlg.getContext());
-									progressDlg = null;
-								} else {
-									startingWarnings = warnings;
-								}
-							}
-						}
-					}
-				});
-		startDialog.run();
-
-		Thread.setDefaultUncaughtExceptionHandler(new DefaultExceptionHandler());
-
-	}
-	
-	protected void showWarnings(List<String> warnings, final Context uiContext) {
-		if (warnings != null && !warnings.isEmpty()) {
-			final StringBuilder b = new StringBuilder();
-			boolean f = true;
-			for (String w : warnings) {
-				if(f){
-					f = false;
-				} else {
-					b.append('\n');
-				}
-				b.append(w);
-			}
+	}
+	
+	public NavigationService getNavigationService() {
+		return navigationService;
+	}
+	
+	public void setNavigationService(NavigationService navigationService) {
+		this.navigationService = navigationService;
+	}
+	
+	public synchronized void closeApplication(){
+		if(applicationInitializing){
+			manager.close();
+		}
+		applicationInitializing = false; 
+	}
+	
+
+	public synchronized void startApplication() {
+		if(applicationInitializing){
+			return;
+		}
+		applicationInitializing = true;
+		startDialog = new ProgressDialogImplementation(this, null, false);
+
+		startDialog.setRunnable("Initializing app", new Runnable() { //$NON-NLS-1$
+
+					@Override
+					public void run() {
+						List<String> warnings = null;
+						try {
+							warnings = manager.reloadIndexes(startDialog);
+							player = null;
+							SavingTrackHelper helper = new SavingTrackHelper(OsmandApplication.this);
+							if (helper.hasDataToSave()) {
+								startDialog.startTask(getString(R.string.saving_gpx_tracks), -1);
+								warnings.addAll(helper.saveDataToGpx());
+							}
+							helper.close();
+
+						} finally {
+							synchronized (OsmandApplication.this) {
+								startDialog = null;
+								if (progressDlg != null) {
+									progressDlg.dismiss();
+									showWarnings(warnings, progressDlg.getContext());
+									progressDlg = null;
+								} else {
+									startingWarnings = warnings;
+								}
+							}
+						}
+					}
+				});
+		startDialog.run();
+
+		Thread.setDefaultUncaughtExceptionHandler(new DefaultExceptionHandler());
+
+	}
+	
+	protected void showWarnings(List<String> warnings, final Context uiContext) {
+		if (warnings != null && !warnings.isEmpty()) {
+			final StringBuilder b = new StringBuilder();
+			boolean f = true;
+			for (String w : warnings) {
+				if(f){
+					f = false;
+				} else {
+					b.append('\n');
+				}
+				b.append(w);
+			}
 			showWarning(uiContext, b.toString());
-		}
-	}
+		}
+	}
 
 	private void showWarning(final Context uiContext, final String b) {
 		uiHandler.post(new Runnable() {
@@ -248,41 +248,41 @@ public void run() {
 			}
 		});
 	}
-	
-
-	private class DefaultExceptionHandler implements UncaughtExceptionHandler {
-
-		private UncaughtExceptionHandler defaultHandler;
-
-		public DefaultExceptionHandler() {
-			defaultHandler = Thread.getDefaultUncaughtExceptionHandler();
-		}
-
-		@Override
-		public void uncaughtException(final Thread thread, final Throwable ex) {
-			File file = OsmandSettings.extendOsmandPath(getApplicationContext(), EXCEPTION_PATH);
-			try {
-				ByteArrayOutputStream out = new ByteArrayOutputStream();
-				PrintStream printStream = new PrintStream(out);
-				ex.printStackTrace(printStream);
-				StringBuilder msg = new StringBuilder();
-				msg.append("Exception occured in thread " + thread.toString() + " : "). //$NON-NLS-1$ //$NON-NLS-2$
-						append(DateFormat.format("MMMM dd, yyyy h:mm:ss", System.currentTimeMillis())).append("\n"). //$NON-NLS-1$//$NON-NLS-2$
-						append(new String(out.toByteArray()));
-
-				if (file.getParentFile().canWrite()) {
-					BufferedWriter writer = new BufferedWriter(new FileWriter(file, true));
-					writer.write(msg.toString());
-					writer.close();
-				}
-				defaultHandler.uncaughtException(thread, ex);
-			} catch (Exception e) {
-				// swallow all exceptions
-				Log.e(LogUtil.TAG, "Exception while handle other exception", e); //$NON-NLS-1$
-			}
-
-		}
-	}
-	
-	
-}
+	
+
+	private class DefaultExceptionHandler implements UncaughtExceptionHandler {
+
+		private UncaughtExceptionHandler defaultHandler;
+
+		public DefaultExceptionHandler() {
+			defaultHandler = Thread.getDefaultUncaughtExceptionHandler();
+		}
+
+		@Override
+		public void uncaughtException(final Thread thread, final Throwable ex) {
+			File file = OsmandSettings.extendOsmandPath(getApplicationContext(), EXCEPTION_PATH);
+			try {
+				ByteArrayOutputStream out = new ByteArrayOutputStream();
+				PrintStream printStream = new PrintStream(out);
+				ex.printStackTrace(printStream);
+				StringBuilder msg = new StringBuilder();
+				msg.append("Exception occured in thread " + thread.toString() + " : "). //$NON-NLS-1$ //$NON-NLS-2$
+						append(DateFormat.format("MMMM dd, yyyy h:mm:ss", System.currentTimeMillis())).append("\n"). //$NON-NLS-1$//$NON-NLS-2$
+						append(new String(out.toByteArray()));
+
+				if (file.getParentFile().canWrite()) {
+					BufferedWriter writer = new BufferedWriter(new FileWriter(file, true));
+					writer.write(msg.toString());
+					writer.close();
+				}
+				defaultHandler.uncaughtException(thread, ex);
+			} catch (Exception e) {
+				// swallow all exceptions
+				Log.e(LogUtil.TAG, "Exception while handle other exception", e); //$NON-NLS-1$
+			}
+
+		}
+	}
+	
+	
+}
