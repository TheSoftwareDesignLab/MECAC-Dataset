diff --git a/OsmAnd/src/net/osmand/plus/auto/TracksFoldersScreen.kt b/OsmAnd/src/net/osmand/plus/auto/TracksFoldersScreen.kt
index 075aeb22106..483096a7df8 100644
--- a/OsmAnd/src/net/osmand/plus/auto/TracksFoldersScreen.kt
+++ b/OsmAnd/src/net/osmand/plus/auto/TracksFoldersScreen.kt
@@ -9,7 +9,7 @@ import androidx.lifecycle.DefaultLifecycleObserver
 import androidx.lifecycle.LifecycleOwner
 import net.osmand.IndexConstants
 import net.osmand.plus.R
-import net.osmand.plus.configmap.tracks.SelectedTracksHelper
+import net.osmand.plus.configmap.tracks.TrackTabsHelper
 import net.osmand.plus.configmap.tracks.TrackFolderLoaderTask
 import net.osmand.plus.configmap.tracks.TrackTab
 import net.osmand.plus.configmap.tracks.TrackTabType
@@ -24,7 +24,7 @@ class TracksFoldersScreen(
     private val settingsAction: Action) : BaseOsmAndAndroidAutoScreen(carContext),
     TrackFolderLoaderTask.LoadTracksListener {
     private var asyncLoader: TrackFolderLoaderTask? = null
-    private val selectedTracksHelper: SelectedTracksHelper = SelectedTracksHelper(app)
+    private val trackTabsHelper: TrackTabsHelper = TrackTabsHelper(app)
 
     init {
         lifecycle.addObserver(object : DefaultLifecycleObserver {
@@ -75,10 +75,10 @@ class TracksFoldersScreen(
                 .setTitle(app.getString(R.string.sort_last_modified))
                 .setImage(iconLastModified)
                 .setBrowsable(true)
-                .setOnClickListener { onClickTabFolder(selectedTracksHelper.trackTabs[TrackTabType.ALL.name]!!) }
+                .setOnClickListener { onClickTabFolder(trackTabsHelper.trackTabs[TrackTabType.ALL.name]!!) }
                 .build())
 
-        if (selectedTracksHelper.trackTabs.isEmpty()) {
+        if (trackTabsHelper.trackTabs.isEmpty()) {
             if (asyncLoader == null) {
                 reloadTracks()
                 templateBuilder.setLoading(true)
@@ -87,7 +87,7 @@ class TracksFoldersScreen(
         }
         templateBuilder.setLoading(false)
         var itemsCount = 1
-        for (trackTab in selectedTracksHelper.trackTabs.values) {
+        for (trackTab in trackTabsHelper.trackTabs.values) {
             if (trackTab.type != TrackTabType.FOLDER) {
                 continue
             }
@@ -114,7 +114,7 @@ class TracksFoldersScreen(
     private fun onClickTabFolder(trackTab: TrackTab) {
         if (trackTab.type == TrackTabType.ALL) {
             trackTab.sortMode = TracksSortMode.LAST_MODIFIED
-            selectedTracksHelper.sortTrackTab(trackTab)
+            trackTabsHelper.sortTrackTab(trackTab)
         }
         screenManager.pushForResult(
             TracksScreen(
@@ -124,7 +124,7 @@ class TracksFoldersScreen(
     }
 
     override fun loadTracksFinished(folder: TrackFolder) {
-        selectedTracksHelper.updateTrackItems(folder.flattenedTrackItems)
+        trackTabsHelper.updateTrackItems(folder.flattenedTrackItems)
         invalidate()
     }
 
diff --git a/OsmAnd/src/net/osmand/plus/configmap/tracks/SearchTrackAdapter.kt b/OsmAnd/src/net/osmand/plus/configmap/tracks/SearchTrackAdapter.kt
index 3cb5032c299..ba219ecc467 100644
--- a/OsmAnd/src/net/osmand/plus/configmap/tracks/SearchTrackAdapter.kt
+++ b/OsmAnd/src/net/osmand/plus/configmap/tracks/SearchTrackAdapter.kt
@@ -1,5 +1,6 @@
 package net.osmand.plus.configmap.tracks
 
+import android.content.Context
 import android.view.ViewGroup
 import android.widget.Filter
 import android.widget.Filterable
@@ -28,7 +29,7 @@ import net.osmand.util.Algorithms
 import java.util.Collections
 
 class SearchTracksAdapter(
-    private val app: OsmandApplication,
+    context: Context,
     private var trackItems: List<TrackItem>,
     private val nightMode: Boolean,
     private var selectionMode: Boolean,
@@ -36,6 +37,7 @@ class SearchTracksAdapter(
 ) :
     RecyclerView.Adapter<RecyclerView.ViewHolder>(), Filterable {
 
+    private val app: OsmandApplication
     private val locationViewCache: UpdateLocationViewCache
     private var items: MutableList<Any> = mutableListOf()
     private var filteredItems: List<TrackItem> = mutableListOf()
@@ -51,26 +53,12 @@ class SearchTracksAdapter(
         } else {
             updateFilteredItems(trackItems)
         }
-        locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app)
+        app = context.applicationContext as OsmandApplication
+        locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(context)
         locationViewCache.arrowResId = R.drawable.ic_direction_arrow
         locationViewCache.arrowColor = ColorUtilities.getActiveIconColorId(nightMode)
     }
 
-    constructor(
-        app: OsmandApplication,
-        trackItems: List<TrackItem>,
-        nightMode: Boolean,
-        selectionMode: Boolean
-    ) : this(app, trackItems, nightMode, selectionMode, TracksSearchFilter(app, trackItems))
-
-    constructor(
-        app: OsmandApplication,
-        trackItems: List<TrackItem>,
-        nightMode: Boolean,
-        selectionMode: Boolean,
-        currentFolder: TrackFolder?
-    ) : this(app, trackItems, nightMode, selectionMode, TracksSearchFilter(app, trackItems, currentFolder))
-
     fun getFilteredItems(): Set<TrackItem> {
         return HashSet(filteredItems)
     }
diff --git a/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsContainer.java b/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsContainer.java
index 5ad8958c61f..7d70dfa85c0 100644
--- a/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsContainer.java
+++ b/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsContainer.java
@@ -1,8 +1,10 @@
 package net.osmand.plus.configmap.tracks;
 
+import androidx.annotation.NonNull;
+
 import java.util.Set;
 
 public interface TrackItemsContainer {
 	void updateContent();
-	void onTrackItemsSelected(Set<TrackItem> trackItems);
+	void updateItems(@NonNull Set<TrackItem> trackItems);
 }
\ No newline at end of file
diff --git a/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsFragment.java b/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsFragment.java
index 62ae6b19490..6793d2a022a 100644
--- a/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackItemsFragment.java
@@ -69,7 +69,7 @@ public void onScrollStateChanged(@NonNull RecyclerView recyclerView, int newStat
 
 	private void setupAdapter(@NonNull TrackTab trackTab) {
 		TracksFragment fragment = (TracksFragment) requireParentFragment();
-		adapter = new TracksAdapter(app, trackTab, fragment, nightMode);
+		adapter = new TracksAdapter(requireContext(), trackTab, fragment, nightMode);
 		recyclerView.setAdapter(adapter);
 	}
 
@@ -84,9 +84,9 @@ public void setTrackTab(@NonNull TrackTab trackTab) {
 	}
 
 	@Override
-	public void onTrackItemsSelected(@NonNull Set<TrackItem> trackItems) {
+	public void updateItems(@NonNull Set<TrackItem> trackItems) {
 		if (adapter != null) {
-			adapter.onTrackItemsSelected(trackItems);
+			adapter.updateItems(trackItems);
 		}
 	}
 
diff --git a/OsmAnd/src/net/osmand/plus/configmap/tracks/SelectedTracksHelper.java b/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackTabsHelper.java
similarity index 98%
rename from OsmAnd/src/net/osmand/plus/configmap/tracks/SelectedTracksHelper.java
rename to OsmAnd/src/net/osmand/plus/configmap/tracks/TrackTabsHelper.java
index 3e9bebe0c53..2cb3d6877d9 100644
--- a/OsmAnd/src/net/osmand/plus/configmap/tracks/SelectedTracksHelper.java
+++ b/OsmAnd/src/net/osmand/plus/configmap/tracks/TrackTabsHelper.java
@@ -32,7 +32,7 @@
 import java.util.Map.Entry;
 import java.util.Set;
 
-public class SelectedTracksHelper {
+public class TrackTabsHelper {
 
 	private final OsmandApplication app;
 	private final OsmandSettings settings;
@@ -43,7 +43,7 @@ public class SelectedTracksHelper {
 	private final Map<String, TrackTab> trackTabs = new LinkedHashMap<>();
 
 
-	public SelectedTracksHelper(@NonNull OsmandApplication app) {
+	public TrackTabsHelper(@NonNull OsmandApplication app) {
 		this.app = app;
 		this.settings = app.getSettings();
 		this.gpxSelectionHelper = app.getSelectedGpxHelper();
diff --git a/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksAdapter.java b/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksAdapter.java
index b4b3fb75dc2..8ad7dafc564 100644
--- a/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksAdapter.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.configmap.tracks;
 
+import android.content.Context;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -8,7 +9,6 @@
 import androidx.recyclerview.widget.RecyclerView;
 import androidx.recyclerview.widget.RecyclerView.ViewHolder;
 
-import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
 import net.osmand.plus.configmap.tracks.viewholders.EmptyTracksViewHolder;
 import net.osmand.plus.configmap.tracks.viewholders.NoVisibleTracksViewHolder;
@@ -38,11 +38,11 @@ public class TracksAdapter extends RecyclerView.Adapter<ViewHolder> {
 	private final TracksFragment fragment;
 	protected final boolean nightMode;
 
-	public TracksAdapter(@NonNull OsmandApplication app, @NonNull TrackTab trackTab, @NonNull TracksFragment fragment, boolean nightMode) {
+	public TracksAdapter(@NonNull Context context, @NonNull TrackTab trackTab, @NonNull TracksFragment fragment, boolean nightMode) {
 		this.trackTab = trackTab;
 		this.fragment = fragment;
 		this.nightMode = nightMode;
-		this.locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		this.locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(context);
 		locationViewCache.arrowResId = R.drawable.ic_direction_arrow;
 		locationViewCache.arrowColor = ColorUtilities.getActiveIconColorId(nightMode);
 	}
@@ -133,7 +133,7 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
 		}
 	}
 
-	public void onTrackItemsSelected(@NonNull Set<TrackItem> trackItems) {
+	public void updateItems(@NonNull Set<TrackItem> trackItems) {
 		for (TrackItem trackItem : trackItems) {
 			updateItem(trackItem);
 		}
diff --git a/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksFragment.java b/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksFragment.java
index d74fccfaa49..77a5b735d43 100644
--- a/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksFragment.java
+++ b/OsmAnd/src/net/osmand/plus/configmap/tracks/TracksFragment.java
@@ -92,7 +92,7 @@ public class TracksFragment extends BaseOsmAndDialogFragment implements LoadTrac
 	public static final String TAG = TracksFragment.class.getSimpleName();
 
 	private ImportHelper importHelper;
-	private SelectedTracksHelper selectedTracksHelper;
+	private TrackTabsHelper trackTabsHelper;
 	private GpxSelectionHelper gpxSelectionHelper;
 	private ItemsSelectionHelper<TrackItem> itemsSelectionHelper;
 	private TrackFolderLoaderTask asyncLoader;
@@ -111,8 +111,8 @@ public class TracksFragment extends BaseOsmAndDialogFragment implements LoadTrac
 	private int tabSize;
 
 	@NonNull
-	public SelectedTracksHelper getSelectedTracksHelper() {
-		return selectedTracksHelper;
+	public TrackTabsHelper getTrackTabsHelper() {
+		return trackTabsHelper;
 	}
 
 	@NonNull
@@ -135,9 +135,9 @@ public boolean getContentStatusBarNightMode() {
 	public void onCreate(@Nullable Bundle savedInstanceState) {
 		super.onCreate(savedInstanceState);
 		importHelper = app.getImportHelper();
-		selectedTracksHelper = new SelectedTracksHelper(app);
+		trackTabsHelper = new TrackTabsHelper(app);
 		gpxSelectionHelper = app.getSelectedGpxHelper();
-		itemsSelectionHelper = selectedTracksHelper.getItemsSelectionHelper();
+		itemsSelectionHelper = trackTabsHelper.getItemsSelectionHelper();
 	}
 
 	@Override
@@ -311,17 +311,17 @@ private void setupButtons(@NonNull View view) {
 	private void updateButtonsState() {
 		TrackTab trackTab = getSelectedTab();
 		if (trackTab != null) {
-			if (TrackTabType.ON_MAP == trackTab.type && !Algorithms.isEmpty(selectedTracksHelper.getRecentlyVisibleTracks())) {
+			if (TrackTabType.ON_MAP == trackTab.type && !Algorithms.isEmpty(trackTabsHelper.getRecentlyVisibleTracks())) {
 				boolean anySelected = itemsSelectionHelper.hasSelectedItems();
 				selectionButton.setTitleId(anySelected ? R.string.shared_string_hide_all : R.string.shared_string_select_recent);
-				selectionButton.setEnabled(!Algorithms.isEmpty(selectedTracksHelper.getRecentlyVisibleTracks()) || anySelected);
+				selectionButton.setEnabled(!Algorithms.isEmpty(trackTabsHelper.getRecentlyVisibleTracks()) || anySelected);
 			} else {
 				boolean notAllSelected = !itemsSelectionHelper.isItemsSelected(trackTab.getTrackItems());
 				selectionButton.setTitleId(notAllSelected ? R.string.shared_string_select_all : R.string.shared_string_deselect_all);
 				selectionButton.setEnabled(!Algorithms.isEmpty(itemsSelectionHelper.getSelectedItems()) || notAllSelected);
 			}
 			applyButton.setEnabled(itemsSelectionHelper.hasItemsToApply());
-			TrackTab allTracksTab = selectedTracksHelper.getTrackTabs().get(TrackTabType.ALL.name());
+			TrackTab allTracksTab = trackTabsHelper.getTrackTabs().get(TrackTabType.ALL.name());
 			searchButton.setVisibility(allTracksTab == null ? View.GONE : View.VISIBLE);
 		}
 	}
@@ -331,10 +331,10 @@ private View.OnClickListener getSelectionButtonClickListener() {
 		return v -> {
 			TrackTab tab = getSelectedTab();
 			if (tab != null) {
-				if (TrackTabType.ON_MAP == tab.type && !Algorithms.isEmpty(selectedTracksHelper.getRecentlyVisibleTracks())) {
+				if (TrackTabType.ON_MAP == tab.type && !Algorithms.isEmpty(trackTabsHelper.getRecentlyVisibleTracks())) {
 					Set<TrackItem> selectedItems = itemsSelectionHelper.getSelectedItems();
 					boolean hasSelectedItems = !Algorithms.isEmpty(selectedItems);
-					Set<TrackItem> selectTracks = hasSelectedItems ? selectedItems : selectedTracksHelper.getRecentlyVisibleTracks();
+					Set<TrackItem> selectTracks = hasSelectedItems ? selectedItems : trackTabsHelper.getRecentlyVisibleTracks();
 					onTrackItemsSelected(selectTracks, !hasSelectedItems);
 				} else {
 					Set<TrackItem> trackItems = new HashSet<>(tab.getTrackItems());
@@ -347,7 +347,7 @@ private View.OnClickListener getSelectionButtonClickListener() {
 
 	@NonNull
 	public List<TrackTab> getTrackTabs() {
-		return new ArrayList<>(selectedTracksHelper.getTrackTabs().values());
+		return new ArrayList<>(trackTabsHelper.getTrackTabs().values());
 	}
 
 	@Nullable
@@ -424,7 +424,7 @@ public void loadTracksStarted() {
 
 	@Override
 	public void tracksLoaded(@NonNull TrackFolder folder) {
-		selectedTracksHelper.updateTrackItems(folder.getFlattenedTrackItems());
+		trackTabsHelper.updateTrackItems(folder.getFlattenedTrackItems());
 	}
 
 	@Override
@@ -452,20 +452,19 @@ private void applyPreselectedParams() {
 	}
 
 	private void updateTrackTabs() {
-		adapter.setTrackTabs(selectedTracksHelper.getTrackTabs());
+		adapter.setTrackTabs(trackTabsHelper.getTrackTabs());
 	}
 
 	public void saveChanges() {
-		selectedTracksHelper.saveTabsSortModes();
-		selectedTracksHelper.saveTracksVisibility();
+		trackTabsHelper.saveTabsSortModes();
+		trackTabsHelper.saveTracksVisibility();
 	}
 
 	@Override
 	public void onGpxSelectionFinished() {
-		selectedTracksHelper.processVisibleTracks();
-		selectedTracksHelper.processRecentlyVisibleTracks();
-		selectedTracksHelper.updateTracksOnMap();
-		app.getOsmandMap().getMapView().refreshMap();
+		trackTabsHelper.processVisibleTracks();
+		trackTabsHelper.processRecentlyVisibleTracks();
+		trackTabsHelper.updateTracksOnMap();
 		updateTabsContent();
 	}
 
@@ -473,12 +472,15 @@ public void onGpxSelectionFinished() {
 	public void onDestroy() {
 		super.onDestroy();
 
-		boolean loadingTracks = asyncLoader != null && asyncLoader.getStatus() == Status.RUNNING;
-		if (loadingTracks && !requireActivity().isChangingConfigurations()) {
+		if (isLoadingTracks() && !requireActivity().isChangingConfigurations()) {
 			asyncLoader.cancel(false);
 		}
 	}
 
+	public boolean isLoadingTracks() {
+		return asyncLoader != null && asyncLoader.getStatus() == Status.RUNNING;
+	}
+
 	public void changeAppearance() {
 		FragmentActivity activity = getActivity();
 		if (activity != null) {
@@ -539,7 +541,7 @@ public void onSaveComplete(boolean success, GPXFile gpxFile) {
 	}
 
 	private void addTrackItem(@NonNull TrackItem item) {
-		selectedTracksHelper.addTrackItem(item);
+		trackTabsHelper.addTrackItem(item);
 		updateTrackTabs();
 		setSelectedTab("import");
 		updateTabsContent();
@@ -551,8 +553,8 @@ public void setTracksSortMode(@NonNull TracksSortMode sortMode) {
 		TrackTab trackTab = getSelectedTab();
 		if (trackTab != null) {
 			trackTab.setSortMode(sortMode);
-			selectedTracksHelper.sortTrackTab(trackTab);
-			selectedTracksHelper.saveTabsSortModes();
+			trackTabsHelper.sortTrackTab(trackTab);
+			trackTabsHelper.saveTabsSortModes();
 			updateTabsContent();
 		}
 	}
@@ -565,7 +567,7 @@ public boolean isTrackItemSelected(@NonNull TrackItem trackItem) {
 	@Override
 	public void onTrackItemsSelected(@NonNull Set<TrackItem> trackItems, boolean selected) {
 		itemsSelectionHelper.onItemsSelected(trackItems, selected);
-		onTrackItemsSelected(trackItems);
+		updateItems(trackItems);
 		updateButtonsState();
 	}
 
@@ -712,10 +714,10 @@ public void fileRenamed(@NonNull File src, @NonNull File dest) {
 		reloadTracks();
 	}
 
-	private void onTrackItemsSelected(@NonNull Set<TrackItem> trackItems) {
+	private void updateItems(@NonNull Set<TrackItem> trackItems) {
 		for (Fragment fragment : getChildFragmentManager().getFragments()) {
 			if (fragment instanceof TrackItemsContainer) {
-				((TrackItemsContainer) fragment).onTrackItemsSelected(trackItems);
+				((TrackItemsContainer) fragment).updateItems(trackItems);
 			}
 		}
 	}
diff --git a/OsmAnd/src/net/osmand/plus/configmap/tracks/viewholders/RecentlyVisibleViewHolder.java b/OsmAnd/src/net/osmand/plus/configmap/tracks/viewholders/RecentlyVisibleViewHolder.java
index f1d47b3685f..136bc84968d 100644
--- a/OsmAnd/src/net/osmand/plus/configmap/tracks/viewholders/RecentlyVisibleViewHolder.java
+++ b/OsmAnd/src/net/osmand/plus/configmap/tracks/viewholders/RecentlyVisibleViewHolder.java
@@ -9,7 +9,7 @@
 
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
-import net.osmand.plus.configmap.tracks.SelectedTracksHelper;
+import net.osmand.plus.configmap.tracks.TrackTabsHelper;
 import net.osmand.plus.configmap.tracks.TrackItem;
 import net.osmand.plus.configmap.tracks.TracksFragment;
 import net.osmand.plus.myplaces.tracks.ItemsSelectionHelper;
@@ -37,7 +37,7 @@ public RecentlyVisibleViewHolder(@NonNull View view, @NonNull TracksFragment fra
 	}
 
 	public void bindView() {
-		SelectedTracksHelper helper = fragment.getSelectedTracksHelper();
+		TrackTabsHelper helper = fragment.getTrackTabsHelper();
 		Set<TrackItem> recentlyVisibleTracks = helper.getRecentlyVisibleTracks();
 		title.setText(app.getString(R.string.recently_visible, "(" + recentlyVisibleTracks.size() + ")"));
 
diff --git a/OsmAnd/src/net/osmand/plus/dashboard/DashLocationFragment.java b/OsmAnd/src/net/osmand/plus/dashboard/DashLocationFragment.java
index 98b2c09465c..d8b5349a6a5 100644
--- a/OsmAnd/src/net/osmand/plus/dashboard/DashLocationFragment.java
+++ b/OsmAnd/src/net/osmand/plus/dashboard/DashLocationFragment.java
@@ -55,7 +55,7 @@ public void updateAllWidgets() {
 		if (app == null || dashboard == null) {
 			return;
 		}
-		UpdateLocationViewCache cache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		UpdateLocationViewCache cache = UpdateLocationUtils.getUpdateLocationViewCache(requireContext());
 		for (DashLocationView view : distances) {
 			cache.arrowResId = view.arrowResId;
 			cache.paintTxt = view.paint;
diff --git a/OsmAnd/src/net/osmand/plus/helpers/AndroidUiHelper.java b/OsmAnd/src/net/osmand/plus/helpers/AndroidUiHelper.java
index 05648be72ab..9870c5244f1 100644
--- a/OsmAnd/src/net/osmand/plus/helpers/AndroidUiHelper.java
+++ b/OsmAnd/src/net/osmand/plus/helpers/AndroidUiHelper.java
@@ -3,7 +3,9 @@
 import static android.view.WindowInsetsController.APPEARANCE_LIGHT_STATUS_BARS;
 
 import android.app.Activity;
+import android.content.Context;
 import android.content.pm.ActivityInfo;
+import android.content.pm.PackageManager;
 import android.content.res.Configuration;
 import android.os.Build;
 import android.os.Build.VERSION_CODES;
@@ -13,11 +15,13 @@
 import android.view.View;
 import android.view.View.OnAttachStateChangeListener;
 import android.view.WindowInsetsController;
+import android.view.WindowManager;
 
 import androidx.annotation.IdRes;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 import androidx.annotation.RequiresApi;
+import androidx.annotation.UiContext;
 import androidx.appcompat.app.ActionBar;
 import androidx.appcompat.app.AppCompatActivity;
 
@@ -28,8 +32,41 @@
  */
 public class AndroidUiHelper {
 
+	private static final int ORIENTATION_0 = 0;
+	private static final int ORIENTATION_90 = 3;
+	private static final int ORIENTATION_270 = 1;
+	private static final int ORIENTATION_180 = 2;
+
+	//TODO check constants correctness, looks like ORIENTATION_.. differs from Surface.ROTATION_.. is it intended?
+	public static int getScreenRotation(@NonNull @UiContext Context context) {
+		WindowManager windowManager = ((WindowManager) context.getSystemService(Context.WINDOW_SERVICE));
+		int rotation = windowManager.getDefaultDisplay().getRotation();
+		switch (rotation) {
+			case ORIENTATION_0:   // Device default (normally portrait)
+				rotation = 0;
+				break;
+			case ORIENTATION_90:  // Landscape right
+				rotation = 90;
+				break;
+			case ORIENTATION_270: // Landscape left
+				rotation = 270;
+				break;
+			case ORIENTATION_180: // Upside down
+				rotation = 180;
+				break;
+		}
+		//Looks like rotation correction must not be applied for devices without compass?
+		PackageManager manager = context.getPackageManager();
+		boolean hasCompass = manager.hasSystemFeature(PackageManager.FEATURE_SENSOR_COMPASS);
+		if (!hasCompass) {
+			rotation = 0;
+		}
+		return rotation;
+	}
+
     public static int getScreenOrientation(@NonNull Activity activity) {
-        int rotation = activity.getWindowManager().getDefaultDisplay().getRotation();
+	    WindowManager windowManager = activity.getWindowManager();
+        int rotation = windowManager.getDefaultDisplay().getRotation();
         DisplayMetrics dm = new DisplayMetrics();
         activity.getWindowManager().getDefaultDisplay().getMetrics(dm);
         int width = dm.widthPixels;
diff --git a/OsmAnd/src/net/osmand/plus/importfiles/ui/SelectPointsFragment.java b/OsmAnd/src/net/osmand/plus/importfiles/ui/SelectPointsFragment.java
index ff4eb256459..714f8d3b10d 100644
--- a/OsmAnd/src/net/osmand/plus/importfiles/ui/SelectPointsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/importfiles/ui/SelectPointsFragment.java
@@ -112,7 +112,7 @@ protected void setupListView(@NonNull View view) {
 		GPXFile gpxFile = trackItem.selectedGpxFile.getGpxFile();
 		GpxDisplayGroup group = app.getGpxDisplayHelper().buildPointsDisplayGroup(gpxFile, points, trackItem.name);
 
-		adapter = new TrackPointsAdapter(app, selectedPoints, nightMode);
+		adapter = new TrackPointsAdapter(view.getContext(), selectedPoints, nightMode);
 		adapter.setListener(this);
 		adapter.synchronizeGroups(Collections.singletonList(group));
 
diff --git a/OsmAnd/src/net/osmand/plus/importfiles/ui/TrackPointsAdapter.java b/OsmAnd/src/net/osmand/plus/importfiles/ui/TrackPointsAdapter.java
index 7cef4966758..1d5ff5213dc 100644
--- a/OsmAnd/src/net/osmand/plus/importfiles/ui/TrackPointsAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/importfiles/ui/TrackPointsAdapter.java
@@ -2,6 +2,7 @@
 
 import static net.osmand.plus.track.cards.TrackPointsCard.setupLocationData;
 
+import android.content.Context;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -50,13 +51,13 @@ class TrackPointsAdapter extends OsmandBaseExpandableListAdapter {
 
 	private final boolean nightMode;
 
-	TrackPointsAdapter(@NonNull OsmandApplication app, @Nullable Set<WptPt> selectedPoints, boolean nightMode) {
-		this.app = app;
+	TrackPointsAdapter(@NonNull Context context, @Nullable Set<WptPt> selectedPoints, boolean nightMode) {
+		this.app = (OsmandApplication) context.getApplicationContext();
 		this.nightMode = nightMode;
 		this.selectedPoints = selectedPoints;
 		inflater = UiUtilities.getInflater(app, nightMode);
 		uiUtilities = app.getUIUtilities();
-		viewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		viewCache = UpdateLocationUtils.getUpdateLocationViewCache(context);
 	}
 
 	public void setListener(@Nullable OnItemSelectedListener listener) {
diff --git a/OsmAnd/src/net/osmand/plus/mapcontextmenu/MapContextMenuFragment.java b/OsmAnd/src/net/osmand/plus/mapcontextmenu/MapContextMenuFragment.java
index 5d1afade41a..e786c6522a7 100644
--- a/OsmAnd/src/net/osmand/plus/mapcontextmenu/MapContextMenuFragment.java
+++ b/OsmAnd/src/net/osmand/plus/mapcontextmenu/MapContextMenuFragment.java
@@ -216,7 +216,7 @@ public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup container,
 		processScreenHeight(container);
 
 		MapActivity mapActivity = requireMapActivity();
-		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(mapActivity);
 
 		markerPaddingPx = dpToPx(MARKER_PADDING_DP);
 		markerPaddingXPx = dpToPx(MARKER_PADDING_X_DP);
@@ -1317,7 +1317,7 @@ public void onResume() {
 			if (MapRouteInfoMenu.chooseRoutesVisible) {
 				mapActivity.getFragmentsHelper().getChooseRouteFragment().dismiss();
 			}
-			updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app, false);
+			updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(mapActivity, false);
 			mapActivity.getMapViewTrackingUtilities().setContextMenu(menu);
 			mapActivity.getMapViewTrackingUtilities().setMapLinkedToLocation(false);
 			wasDrawerDisabled = mapActivity.isDrawerDisabled();
diff --git a/OsmAnd/src/net/osmand/plus/mapcontextmenu/editors/SelectFavouriteToReplaceBottomSheet.java b/OsmAnd/src/net/osmand/plus/mapcontextmenu/editors/SelectFavouriteToReplaceBottomSheet.java
index f10e83704e9..f7855c70956 100644
--- a/OsmAnd/src/net/osmand/plus/mapcontextmenu/editors/SelectFavouriteToReplaceBottomSheet.java
+++ b/OsmAnd/src/net/osmand/plus/mapcontextmenu/editors/SelectFavouriteToReplaceBottomSheet.java
@@ -31,7 +31,7 @@ protected void onFavouriteSelected(@NonNull FavouritePoint favourite) {
 	}
 
 	private void showConfirmationDialog(@NonNull FavouritePoint favourite) {
-		boolean nightMode = isNightMode(mApp);
+		boolean nightMode = isNightMode(app);
 		Context themedContext = UiUtilities.getThemedContext(getContext(), nightMode);
 		AlertDialog.Builder builder = new AlertDialog.Builder(themedContext);
 		builder.setTitle(R.string.update_existing);
@@ -45,7 +45,7 @@ private void showConfirmationDialog(@NonNull FavouritePoint favourite) {
 
 	private void onApplyReplacement(@NonNull FavouritePoint favourite) {
 		FavouritePoint point = AndroidUtils.getSerializable(getArguments(), KEY_FAVORITE, FavouritePoint.class);
-		FavouritesHelper helper = mApp.getFavoritesHelper();
+		FavouritesHelper helper = app.getFavoritesHelper();
 		favourite.setAddress(point.getAddress()); // Use address from the new point
 		if (point != null && helper.editFavourite(favourite, point.getLatitude(), point.getLongitude())) {
 			helper.deleteFavourite(point);
diff --git a/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/FavouritesAdapter.java b/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/FavouritesAdapter.java
index aed9f53e9b8..f13d8ce202c 100644
--- a/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/FavouritesAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/FavouritesAdapter.java
@@ -1,11 +1,13 @@
 package net.osmand.plus.mapcontextmenu.other;
 
+import android.content.Context;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import androidx.annotation.NonNull;
 import androidx.core.content.ContextCompat;
 import androidx.recyclerview.widget.RecyclerView;
 
@@ -27,10 +29,10 @@ public class FavouritesAdapter extends RecyclerView.Adapter<RecyclerView.ViewHol
 
 	private final UpdateLocationViewCache cache;
 
-	public FavouritesAdapter(OsmandApplication app, List<FavouritePoint> FavouritePoints) {
-		this.app = app;
+	public FavouritesAdapter(@NonNull Context context, List<FavouritePoint> FavouritePoints) {
+		this.app = (OsmandApplication) context.getApplicationContext();
 		this.favouritePoints = FavouritePoints;
-		cache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		cache = UpdateLocationUtils.getUpdateLocationViewCache(context);
 	}
 
 	@Override
diff --git a/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/SelectFavouriteBottomSheet.java b/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/SelectFavouriteBottomSheet.java
index 6044c3c97ce..777c428616c 100644
--- a/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/SelectFavouriteBottomSheet.java
+++ b/OsmAnd/src/net/osmand/plus/mapcontextmenu/other/SelectFavouriteBottomSheet.java
@@ -46,7 +46,7 @@ public abstract class SelectFavouriteBottomSheet extends MenuBottomSheetDialogFr
 	private static final int SORT_TYPE_NAME = 2;
 	private static final int SORT_TYPE_CATEGORY = 3;
 
-	protected OsmandApplication mApp;
+	protected OsmandApplication app;
 	protected FavouritesHelper mFavouritesHelper;
 	private final List<FavouritePoint> mPoints = new ArrayList<>();
 
@@ -65,12 +65,12 @@ public abstract class SelectFavouriteBottomSheet extends MenuBottomSheetDialogFr
 
 	@Override
 	public void createMenuItems(@Nullable Bundle savedInstanceState) {
-		mApp = getMyApplication();
+		app = getMyApplication();
 		if (savedInstanceState != null && savedInstanceState.getBoolean(IS_SORTED)) {
 			mSortByDist = savedInstanceState.getInt(SORTED_BY_TYPE);
 		}
-		mAdapter = new FavouritesAdapter(mApp, mPoints);
-		mFavouritesHelper = mApp.getFavoritesHelper();
+		mAdapter = new FavouritesAdapter(requireContext(), mPoints);
+		mFavouritesHelper = app.getFavoritesHelper();
 		if (mFavouritesHelper.isFavoritesLoaded()) {
 			loadFavorites();
 		} else {
@@ -143,9 +143,9 @@ private void loadFavorites() {
 
 	private void sortFavourites() {
 		Collator inst = Collator.getInstance();
-		Location stale = mApp.getLocationProvider().getLastStaleKnownLocation();
+		Location stale = app.getLocationProvider().getLastStaleKnownLocation();
 		LatLon latLon = stale != null ? new LatLon(stale.getLatitude(), stale.getLongitude()) :
-				mApp.getMapViewTrackingUtilities().getMapLocation();
+				app.getMapViewTrackingUtilities().getMapLocation();
 
 		Collections.sort(mPoints, (lhs, rhs) -> {
 			if (mSortByDist == SORT_TYPE_DIST && latLon != null) {
@@ -251,7 +251,7 @@ public void onPause() {
 		super.onPause();
 		stopLocationUpdate();
 		if (mFavouritesListener != null) {
-			mApp.getFavoritesHelper().removeListener(mFavouritesListener);
+			app.getFavoritesHelper().removeListener(mFavouritesListener);
 			mFavouritesListener = null;
 		}
 	}
diff --git a/OsmAnd/src/net/osmand/plus/mapmarkers/CoordinateInputDialogFragment.java b/OsmAnd/src/net/osmand/plus/mapmarkers/CoordinateInputDialogFragment.java
index dd39fd1a896..c694442fa1d 100644
--- a/OsmAnd/src/net/osmand/plus/mapmarkers/CoordinateInputDialogFragment.java
+++ b/OsmAnd/src/net/osmand/plus/mapmarkers/CoordinateInputDialogFragment.java
@@ -373,7 +373,7 @@ public void onClick(View view) {
 				}
 			}
 		});
-		adapter = new CoordinateInputAdapter(getMyApplication(), getGpx());
+		adapter = new CoordinateInputAdapter(ctx, getGpx());
 		recyclerView = mainView.findViewById(R.id.markers_recycler_view);
 		recyclerView.setLayoutManager(new LinearLayoutManager(ctx));
 		recyclerView.setAdapter(adapter);
@@ -384,33 +384,27 @@ public void onScrollStateChanged(RecyclerView recyclerView, int newState) {
 				compassUpdateAllowed = newState == RecyclerView.SCROLL_STATE_IDLE;
 			}
 		});
-		adapter.setOnClickListener(new View.OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				int pos = recyclerView.getChildAdapterPosition(v);
-				if (pos == RecyclerView.NO_POSITION) {
-					return;
-				}
-				enterEditingMode(adapter.getItem(pos));
+		adapter.setOnClickListener(v -> {
+			int pos = recyclerView.getChildAdapterPosition(v);
+			if (pos == RecyclerView.NO_POSITION) {
+				return;
 			}
+			enterEditingMode(adapter.getItem(pos));
 		});
-		adapter.setOnActionsClickListener(new View.OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				RecyclerView.ViewHolder viewHolder = recyclerView.findContainingViewHolder(v);
-				if (viewHolder != null) {
-					int pos = viewHolder.getAdapterPosition();
-					if (pos == RecyclerView.NO_POSITION) {
-						return;
-					}
-					Bundle args = new Bundle();
-					args.putInt(CoordinateInputAdapter.ADAPTER_POSITION_KEY, pos);
-					CoordinateInputActionsBottomSheet fragment = new CoordinateInputActionsBottomSheet();
-					fragment.setUsedOnMap(false);
-					fragment.setArguments(args);
-					fragment.setListener(createCoordinateInputActionsListener());
-					fragment.show(getChildFragmentManager(), CoordinateInputActionsBottomSheet.TAG);
+		adapter.setOnActionsClickListener(v -> {
+			RecyclerView.ViewHolder viewHolder = recyclerView.findContainingViewHolder(v);
+			if (viewHolder != null) {
+				int pos = viewHolder.getAdapterPosition();
+				if (pos == RecyclerView.NO_POSITION) {
+					return;
 				}
+				Bundle args = new Bundle();
+				args.putInt(CoordinateInputAdapter.ADAPTER_POSITION_KEY, pos);
+				CoordinateInputActionsBottomSheet fragment = new CoordinateInputActionsBottomSheet();
+				fragment.setUsedOnMap(false);
+				fragment.setArguments(args);
+				fragment.setListener(createCoordinateInputActionsListener());
+				fragment.show(getChildFragmentManager(), CoordinateInputActionsBottomSheet.TAG);
 			}
 		});
 
@@ -420,22 +414,16 @@ public void onClick(View v) {
 		@ColorRes int colorId = lightTheme ? R.color.active_color_primary_light : R.color.active_color_primary_dark;
 		addButton.setCompoundDrawablesWithIntrinsicBounds(null, null, getColoredIcon(R.drawable.ic_action_type_add, colorId), null);
 		addButton.setText(R.string.shared_string_add);
-		addButton.setOnClickListener(new View.OnClickListener() {
-			@Override
-			public void onClick(View view) {
-				addWptPt();
-				hasUnsavedChanges = true;
-			}
+		addButton.setOnClickListener(view -> {
+			addWptPt();
+			hasUnsavedChanges = true;
 		});
 
 		TextView cancelButton = mainView.findViewById(R.id.cancel_button);
 		cancelButton.setText(R.string.shared_string_cancel);
-		cancelButton.setOnClickListener(new View.OnClickListener() {
-			@Override
-			public void onClick(View view) {
-				dismissEditingMode();
-				clearInputs();
-			}
+		cancelButton.setOnClickListener(view -> {
+			dismissEditingMode();
+			clearInputs();
 		});
 		View keyboardLayout = mainView.findViewById(R.id.keyboard_layout);
 		keyboardLayout.setBackgroundResource(lightTheme
@@ -447,33 +435,30 @@ public void onClick(View view) {
 		setBackgroundColor(keyboardView, dividersColorResId);
 		setBackgroundColor(R.id.keyboard_divider, dividersColorResId);
 
-		View.OnClickListener onClickListener = new View.OnClickListener() {
-			@Override
-			public void onClick(View v) {
-				if (isOsmandKeyboardOn()) {
-					View focusedView = getDialog().getCurrentFocus();
-					if (focusedView != null && focusedView instanceof EditText) {
-						EditText focusedEditText = (EditText) focusedView;
-						int id = v.getId();
-						if (id == R.id.keyboard_item_clear) {
-							focusedEditText.setText("");
-						} else if (id == R.id.keyboard_item_backspace) {
-							String str = focusedEditText.getText().toString();
-							if (str.length() > 0) {
-								str = str.substring(0, str.length() - 1);
-								focusedEditText.setText(str);
-								focusedEditText.setSelection(str.length());
-							} else {
-								switchEditText(focusedEditText.getId(), false);
-							}
-						} else if (id == R.id.keyboard_item_next_field) {
-							switchEditText(focusedEditText.getId(), true);
-						} else if (id == R.id.keyboard_item_hide) {
-							changeOsmandKeyboardVisibility(false);
+		View.OnClickListener onClickListener = v -> {
+			if (isOsmandKeyboardOn()) {
+				View focusedView = getDialog().getCurrentFocus();
+				if (focusedView != null && focusedView instanceof EditText) {
+					EditText focusedEditText = (EditText) focusedView;
+					int id = v.getId();
+					if (id == R.id.keyboard_item_clear) {
+						focusedEditText.setText("");
+					} else if (id == R.id.keyboard_item_backspace) {
+						String str = focusedEditText.getText().toString();
+						if (str.length() > 0) {
+							str = str.substring(0, str.length() - 1);
+							focusedEditText.setText(str);
+							focusedEditText.setSelection(str.length());
 						} else {
-							focusedEditText.setText(focusedEditText.getText().toString() + getItemObjectById(id));
-							focusedEditText.setSelection(focusedEditText.getText().length());
+							switchEditText(focusedEditText.getId(), false);
 						}
+					} else if (id == R.id.keyboard_item_next_field) {
+						switchEditText(focusedEditText.getId(), true);
+					} else if (id == R.id.keyboard_item_hide) {
+						changeOsmandKeyboardVisibility(false);
+					} else {
+						focusedEditText.setText(focusedEditText.getText().toString() + getItemObjectById(id));
+						focusedEditText.setSelection(focusedEditText.getText().length());
 					}
 				}
 			}
@@ -712,12 +697,7 @@ private void setupSideOfTheWorldBtns(int... ids) {
 			}
 			sideOfTheWorldBtn.setBackgroundResource(lightTheme
 					? R.drawable.context_menu_controller_bg_light : R.drawable.context_menu_controller_bg_dark);
-			sideOfTheWorldBtn.setOnClickListener(new View.OnClickListener() {
-				@Override
-				public void onClick(View v) {
-					updateSideOfTheWorldBtn(v, true);
-				}
-			});
+			sideOfTheWorldBtn.setOnClickListener(v -> updateSideOfTheWorldBtn(v, true));
 
 			int colorId = ColorUtilities.getActiveColorId(!lightTheme);
 			boolean lat = id == R.id.lat_side_of_the_world_btn;
@@ -770,7 +750,7 @@ private void addEditTexts(@IdRes int... ids) {
 		editTexts.clear();
 		for (int id : ids) {
 			View v = mainView.findViewById(id);
-			if (v != null && v instanceof EditTextEx && v.getVisibility() == View.VISIBLE) {
+			if (v instanceof EditTextEx && v.getVisibility() == View.VISIBLE) {
 				editTexts.add(mainView.findViewById(id));
 			}
 		}
@@ -809,7 +789,7 @@ public void afterTextChanged(Editable editable) {
 
 		GestureDetector gestureDetector = new GestureDetector(getContext(), new GestureDetector.SimpleOnGestureListener() {
 			@Override
-			public boolean onDoubleTap(MotionEvent e) {
+			public boolean onDoubleTap(@NonNull MotionEvent e) {
 				return true;
 			}
 		});
@@ -849,60 +829,54 @@ public boolean onTouch(View view, MotionEvent motionEvent) {
 			}
 		};
 
-		View.OnLongClickListener inputEditTextOnLongClickListener = new View.OnLongClickListener() {
-			@Override
-			public boolean onLongClick(View view) {
-				if (isOsmandKeyboardOn()) {
-					EditText inputEditText = (EditText) view;
-					PopupMenu popupMenu = new PopupMenu(getContext(), inputEditText);
-					Menu menu = popupMenu.getMenu();
-					popupMenu.getMenuInflater().inflate(R.menu.copy_paste_menu, menu);
-					ClipboardManager clipboardManager = ((ClipboardManager) getContext().getSystemService(CLIPBOARD_SERVICE));
-					MenuItem pasteMenuItem = menu.findItem(R.id.action_paste);
-					pasteMenuItem.setEnabled(clipboardManager != null && clipboardManager.hasPrimaryClip() &&
-							clipboardManager.getPrimaryClipDescription().hasMimeType(MIMETYPE_TEXT_PLAIN));
-					if (clipboardManager != null) {
-						popupMenu.setOnMenuItemClickListener(new PopupMenu.OnMenuItemClickListener() {
-							@Override
-							public boolean onMenuItemClick(MenuItem item) {
-								int i = item.getItemId();
-								if (i == R.id.action_copy) {
-									ClipData clip = ClipData.newPlainText("", inputEditText.getText().toString());
-									clipboardManager.setPrimaryClip(clip);
-									return true;
-								} else if (i == R.id.action_paste) {
-									ClipData.Item pasteItem = clipboardManager.getPrimaryClip().getItemAt(0);
-									CharSequence pasteData = pasteItem.getText();
-									if (pasteData != null) {
-										String str = inputEditText.getText().toString();
-										inputEditText.setText(str + pasteData);
-										inputEditText.setSelection(inputEditText.getText().length());
-									}
-									return true;
+		View.OnLongClickListener inputEditTextOnLongClickListener = view -> {
+			if (isOsmandKeyboardOn()) {
+				EditText inputEditText = (EditText) view;
+				PopupMenu popupMenu = new PopupMenu(getContext(), inputEditText);
+				Menu menu = popupMenu.getMenu();
+				popupMenu.getMenuInflater().inflate(R.menu.copy_paste_menu, menu);
+				ClipboardManager clipboardManager = ((ClipboardManager) getContext().getSystemService(CLIPBOARD_SERVICE));
+				MenuItem pasteMenuItem = menu.findItem(R.id.action_paste);
+				pasteMenuItem.setEnabled(clipboardManager != null && clipboardManager.hasPrimaryClip() &&
+						clipboardManager.getPrimaryClipDescription().hasMimeType(MIMETYPE_TEXT_PLAIN));
+				if (clipboardManager != null) {
+					popupMenu.setOnMenuItemClickListener(new PopupMenu.OnMenuItemClickListener() {
+						@Override
+						public boolean onMenuItemClick(MenuItem item) {
+							int i = item.getItemId();
+							if (i == R.id.action_copy) {
+								ClipData clip = ClipData.newPlainText("", inputEditText.getText().toString());
+								clipboardManager.setPrimaryClip(clip);
+								return true;
+							} else if (i == R.id.action_paste) {
+								ClipData.Item pasteItem = clipboardManager.getPrimaryClip().getItemAt(0);
+								CharSequence pasteData = pasteItem.getText();
+								if (pasteData != null) {
+									String str = inputEditText.getText().toString();
+									inputEditText.setText(str + pasteData);
+									inputEditText.setSelection(inputEditText.getText().length());
 								}
-								return false;
+								return true;
 							}
-						});
-						popupMenu.show();
-					}
-					return true;
-				} else {
-					return false;
+							return false;
+						}
+					});
+					popupMenu.show();
 				}
+				return true;
+			} else {
+				return false;
 			}
 		};
 
-		TextView.OnEditorActionListener inputTextViewOnEditorActionListener = new TextView.OnEditorActionListener() {
-			@Override
-			public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
-				if (i == EditorInfo.IME_ACTION_NEXT) {
-					switchEditText(textView.getId(), true);
-				} else if (i == EditorInfo.IME_ACTION_DONE) {
-					addWptPt();
-					hasUnsavedChanges = true;
-				}
-				return false;
+		TextView.OnEditorActionListener inputTextViewOnEditorActionListener = (textView, i, keyEvent) -> {
+			if (i == EditorInfo.IME_ACTION_NEXT) {
+				switchEditText(textView.getId(), true);
+			} else if (i == EditorInfo.IME_ACTION_DONE) {
+				addWptPt();
+				hasUnsavedChanges = true;
 			}
+			return false;
 		};
 
 		clearInputs();
@@ -949,12 +923,9 @@ public boolean onEditorAction(TextView textView, int i, KeyEvent keyEvent) {
 			if (et.getId() != R.id.point_name_et) {
 				et.addTextChangedListener(textWatcher);
 			} else {
-				et.setOnFocusChangeListener(new View.OnFocusChangeListener() {
-					@Override
-					public void onFocusChange(View v, boolean hasFocus) {
-						if (!hasFocus && isOsmandKeyboardOn() && (isOsmandKeyboardCurrentlyVisible() || softKeyboardShown)) {
-							AndroidUtils.hideSoftKeyboard(getActivity(), v);
-						}
+				et.setOnFocusChangeListener((v, hasFocus) -> {
+					if (!hasFocus && isOsmandKeyboardOn() && (isOsmandKeyboardCurrentlyVisible() || softKeyboardShown)) {
+						AndroidUtils.hideSoftKeyboard(getActivity(), v);
 					}
 				});
 			}
@@ -1056,12 +1027,7 @@ public void saveGpx(String fileName) {
 					listener.onPointsSaved();
 				}
 				snackbar = Snackbar.make(mainView, String.format(getString(R.string.shared_string_file_is_saved), fileName) + ".", Snackbar.LENGTH_LONG)
-						.setAction(R.string.shared_string_show, new View.OnClickListener() {
-							@Override
-							public void onClick(View view) {
-								TrackMenuFragment.openTrack(app, new File(getGpx().path), null);
-							}
-						});
+						.setAction(R.string.shared_string_show, view -> TrackMenuFragment.openTrack(app, new File(getGpx().path), null));
 				UiUtilities.setupSnackbar(snackbar, !lightTheme);
 				snackbar.show();
 			}
@@ -1082,12 +1048,9 @@ public void removeItem(int position) {
 				adapter.removeItem(position);
 				hasUnsavedChanges = true;
 				snackbar = Snackbar.make(mainView, getString(R.string.point_deleted, wpt.name), Snackbar.LENGTH_LONG)
-						.setAction(R.string.shared_string_undo, new View.OnClickListener() {
-							@Override
-							public void onClick(View view) {
-								getGpx().addPoint(position, wpt);
-								adapter.notifyDataSetChanged();
-							}
+						.setAction(R.string.shared_string_undo, view -> {
+							getGpx().addPoint(position, wpt);
+							adapter.notifyDataSetChanged();
 						});
 				UiUtilities.setupSnackbar(snackbar, !lightTheme);
 				snackbar.show();
diff --git a/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkerSelectionFragment.java b/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkerSelectionFragment.java
index 136f52f8dc4..b0bdce1ccd6 100644
--- a/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkerSelectionFragment.java
+++ b/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkerSelectionFragment.java
@@ -6,13 +6,13 @@
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
-import android.widget.AdapterView;
 import android.widget.ArrayAdapter;
 import android.widget.ImageButton;
 import android.widget.ListView;
 
 import androidx.annotation.Nullable;
 
+import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.data.LatLon;
 import net.osmand.plus.R;
@@ -23,7 +23,6 @@
 import net.osmand.plus.routepreparationmenu.MapRouteInfoMenu;
 import net.osmand.plus.routepreparationmenu.MapRouteInfoMenu.OnMarkerSelectListener;
 import net.osmand.plus.routepreparationmenu.MapRouteInfoMenu.PointType;
-import net.osmand.plus.utils.UiUtilities;
 
 import java.util.List;
 
@@ -60,7 +59,7 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container, Bundle sa
 			MapRouteInfoMenu routeInfoMenu = mapActivity.getMapRouteInfoMenu();
 			onClickListener = routeInfoMenu.getOnMarkerSelectListener();
 
-			screenOrientation = app.getUIUtilities().getScreenOrientation(mapActivity);
+			screenOrientation = AndroidUiHelper.getScreenOrientation(mapActivity);
 
 			MapViewTrackingUtilities trackingUtils = mapActivity.getMapViewTrackingUtilities();
 			if (trackingUtils != null) {
diff --git a/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/CoordinateInputAdapter.java b/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/CoordinateInputAdapter.java
index c4030f7651a..2eea8395dca 100644
--- a/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/CoordinateInputAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/CoordinateInputAdapter.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.mapmarkers.adapters;
 
+import android.content.Context;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -43,12 +44,12 @@ public void setOnActionsClickListener(View.OnClickListener actionsListener) {
 		this.actionsListener = actionsListener;
 	}
 	
-	public CoordinateInputAdapter(OsmandApplication app, GPXFile gpx) {
-		this.app = app;
+	public CoordinateInputAdapter(@NonNull Context context, GPXFile gpx) {
+		this.app = (OsmandApplication) context.getApplicationContext();
 		this.gpx = gpx;
 
 		uiUtilities = app.getUIUtilities();
-		updateViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		updateViewCache = UpdateLocationUtils.getUpdateLocationViewCache(context);
 		nightTheme = !app.getSettings().isLightContent();
 	}
 
diff --git a/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersActiveAdapter.java b/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersActiveAdapter.java
index 86dc635923b..7a978f78c7d 100644
--- a/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersActiveAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersActiveAdapter.java
@@ -53,7 +53,7 @@ public MapMarkersActiveAdapter(@NonNull MapActivity mapActivity) {
 		this.mapActivity = mapActivity;
 		this.app = mapActivity.getMyApplication();
 		uiUtilities = app.getUIUtilities();
-		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(mapActivity);
 		markers = app.getMapMarkersHelper().getMapMarkers();
 		nightMode = !app.getSettings().isLightContent();
 		showDirectionEnabled = WidgetsVisibilityHelper.isWidgetEnabled(mapActivity, TOP, MARKERS_TOP_BAR.id);
diff --git a/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersGroupsAdapter.java b/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersGroupsAdapter.java
index d8539c65bd1..a5bba5adc5d 100644
--- a/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersGroupsAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/mapmarkers/adapters/MapMarkersGroupsAdapter.java
@@ -83,7 +83,7 @@ public void setListener(MapMarkersGroupsAdapterListener listener) {
 	public MapMarkersGroupsAdapter(@NonNull MapActivity mapActivity) {
 		this.mapActivity = mapActivity;
 		app = mapActivity.getMyApplication();
-		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(mapActivity);
 		nightMode = !app.getSettings().isLightContent();
 		updateShowDirectionMarkers();
 		createDisplayGroups();
diff --git a/OsmAnd/src/net/osmand/plus/myplaces/favorites/dialogs/FavoritesTreeFragment.java b/OsmAnd/src/net/osmand/plus/myplaces/favorites/dialogs/FavoritesTreeFragment.java
index 21776105ceb..2deaf12f404 100644
--- a/OsmAnd/src/net/osmand/plus/myplaces/favorites/dialogs/FavoritesTreeFragment.java
+++ b/OsmAnd/src/net/osmand/plus/myplaces/favorites/dialogs/FavoritesTreeFragment.java
@@ -119,7 +119,7 @@ public class FavoritesTreeFragment extends OsmandExpandableListFragment implemen
 	@Override
 	public void onCreate(@Nullable Bundle savedInstanceState) {
 		super.onCreate(savedInstanceState);
-		favouritesAdapter = new FavouritesAdapter();
+		favouritesAdapter = new FavouritesAdapter(requireActivity());
 		importHelper = app.getImportHelper();
 
 		helper = app.getFavoritesHelper();
@@ -714,8 +714,8 @@ class FavouritesAdapter extends OsmandBaseExpandableListAdapter implements Filte
 		private Set<?> filter;
 		private final UpdateLocationViewCache cache;
 
-		FavouritesAdapter() {
-			cache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		FavouritesAdapter(@NonNull FragmentActivity activity) {
+			cache = UpdateLocationUtils.getUpdateLocationViewCache(activity);
 		}
 
 		void synchronizeGroups() {
diff --git a/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchMyPlacesTracksFragment.java b/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchMyPlacesTracksFragment.java
index 1664861d2d3..bac80e77aef 100644
--- a/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchMyPlacesTracksFragment.java
+++ b/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchMyPlacesTracksFragment.java
@@ -2,13 +2,13 @@
 
 import static net.osmand.plus.track.fragments.TrackMenuFragment.TrackMenuTab.OVERVIEW;
 
+import android.content.Context;
 import android.content.DialogInterface;
 import android.os.Bundle;
 import android.view.KeyEvent;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
-import android.widget.Filter;
 import android.widget.ImageButton;
 import android.widget.TextView;
 import android.widget.Toast;
@@ -89,11 +89,12 @@ public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup c
 	}
 
 	@NonNull
-	protected SearchTracksAdapter createAdapter(List<TrackItem> trackItems) {
+	protected SearchTracksAdapter createAdapter(@NonNull Context context, List<TrackItem> trackItems) {
 		if (externalFilter != null) {
 			return new SearchTracksAdapter(app, trackItems, nightMode, selectionMode, externalFilter);
 		} else {
-			return new SearchTracksAdapter(app, trackItems, nightMode, selectionMode, currentFolder);
+			TracksSearchFilter filter = new TracksSearchFilter(app, trackItems, currentFolder);
+			return new SearchTracksAdapter(app, trackItems, nightMode, selectionMode, filter);
 		}
 	}
 
@@ -204,7 +205,7 @@ protected void setupToolbar(@NonNull View view) {
 		selectButton.setOnClickListener(v -> {
 			Set<TrackItem> items = adapter.getFilteredItems();
 			selectionHelper.onItemsSelected(items, !areAllTracksSelected());
-			onTrackItemsSelected(items);
+			updateItems(items);
 		});
 
 		actionButton = view.findViewById(R.id.action_button);
@@ -389,11 +390,10 @@ public void onSmartFoldersUpdated() {
 	@Override
 	public void showFiltersDialog() {
 		FragmentManager manager = getFragmentManager();
-    TracksSearchFilter filter = (TracksSearchFilter) adapter.getFilter();
+		TracksSearchFilter filter = (TracksSearchFilter) adapter.getFilter();
 		filter.setCurrentFolder(currentFolder);
-		if (manager != null && filter instanceof TracksSearchFilter) {
-			TracksFilterFragment.Companion.showInstance(app, manager, getTargetFragment(), (TracksSearchFilter) filter, this, smartFolder, currentFolder);
-  
+		if (manager != null) {
+			TracksFilterFragment.Companion.showInstance(app, manager, getTargetFragment(), filter, this, smartFolder, currentFolder);
 		}
 	}
 
diff --git a/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchTrackBaseFragment.java b/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchTrackBaseFragment.java
index cb44847b2b9..a1bab4a22d5 100644
--- a/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchTrackBaseFragment.java
+++ b/OsmAnd/src/net/osmand/plus/myplaces/tracks/SearchTrackBaseFragment.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.myplaces.tracks;
 
+import android.content.Context;
 import android.os.Bundle;
 import android.text.Editable;
 import android.view.LayoutInflater;
@@ -9,7 +10,7 @@
 import android.widget.EditText;
 import android.widget.ImageButton;
 
-import androidx.annotation.ColorRes;
+import androidx.annotation.ColorInt;
 import androidx.annotation.LayoutRes;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
@@ -86,7 +87,7 @@ public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup c
 
 		Fragment fragment = getTargetFragment();
 		List<TrackItem> trackItems = new ArrayList<>(selectionHelper.getAllItems());
-		adapter = createAdapter(trackItems);
+		adapter = createAdapter(view.getContext(), trackItems);
 		adapter.setTracksSortMode(getTracksSortMode());
 		adapter.setSortTracksListener(this);
 		adapter.setSelectionListener(getTrackSelectionListener());
@@ -119,8 +120,9 @@ public void onViewCreated(@NonNull View view, @Nullable Bundle savedInstanceStat
 	}
 
 	@NonNull
-	protected SearchTracksAdapter createAdapter(List<TrackItem> trackItems) {
-		return new SearchTracksAdapter(app, trackItems, nightMode, selectionMode);
+	protected SearchTracksAdapter createAdapter(@NonNull Context context, List<TrackItem> trackItems) {
+		TracksSearchFilter filter = new TracksSearchFilter(app, trackItems);
+		return new SearchTracksAdapter(context, trackItems, nightMode, selectionMode, filter);
 	}
 
 	protected abstract void setupFragment(View view);
@@ -174,7 +176,7 @@ protected void setupToolbar(@NonNull View view) {
 		setStatusBarBackgroundColor(ContextCompat.getColor(app, nightMode ? R.color.status_bar_main_dark : R.color.status_bar_main_light));
 	}
 
-	protected void setStatusBarBackgroundColor(@ColorRes int color) {
+	protected void setStatusBarBackgroundColor(@ColorInt int color) {
 		Window window = requireDialog().getWindow();
 		if (window != null) {
 			AndroidUiHelper.setStatusBarContentColor(window.getDecorView(), true);
@@ -214,7 +216,7 @@ protected void filterTracks(@Nullable String query) {
 	}
 
 	@Override
-	public void onTrackItemsSelected(@NonNull Set<TrackItem> trackItems) {
+	public void updateItems(@NonNull Set<TrackItem> trackItems) {
 		adapter.notifyDataSetChanged();
 		updateButtonsState();
 	}
diff --git a/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/BaseTrackFolderFragment.java b/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/BaseTrackFolderFragment.java
index c1b0738d92e..c4d59162ba4 100644
--- a/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/BaseTrackFolderFragment.java
+++ b/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/BaseTrackFolderFragment.java
@@ -203,7 +203,7 @@ public TrackFoldersHelper getTrackFoldersHelper() {
 	}
 
 	protected void setupAdapter(@NonNull View view) {
-		adapter = new TrackFoldersAdapter(app, nightMode);
+		adapter = new TrackFoldersAdapter(view.getContext(), nightMode);
 		adapter.setSortTracksListener(this);
 		adapter.setTrackGroupsListener(this);
 		adapter.setTrackSelectionListener(this);
diff --git a/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/TrackFoldersAdapter.java b/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/TrackFoldersAdapter.java
index 3828979029f..c63f7556bc2 100644
--- a/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/TrackFoldersAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/myplaces/tracks/dialogs/TrackFoldersAdapter.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.myplaces.tracks.dialogs;
 
+import android.content.Context;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
@@ -86,10 +87,10 @@ public class TrackFoldersAdapter extends RecyclerView.Adapter<ViewHolder> {
 	private boolean selectionMode;
 	private boolean shouldShowFolder;
 
-	public TrackFoldersAdapter(@NonNull OsmandApplication app, boolean nightMode) {
-		this.app = app;
+	public TrackFoldersAdapter(@NonNull Context context, boolean nightMode) {
+		this.app = (OsmandApplication) context.getApplicationContext();
 		this.nightMode = nightMode;
-		locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(context);
 		locationViewCache.arrowResId = R.drawable.ic_direction_arrow;
 		locationViewCache.arrowColor = ColorUtilities.getActiveIconColorId(nightMode);
 	}
diff --git a/OsmAnd/src/net/osmand/plus/myplaces/tracks/filters/SmartFolderHelper.kt b/OsmAnd/src/net/osmand/plus/myplaces/tracks/filters/SmartFolderHelper.kt
index dc073bba292..bd8018f4a74 100644
--- a/OsmAnd/src/net/osmand/plus/myplaces/tracks/filters/SmartFolderHelper.kt
+++ b/OsmAnd/src/net/osmand/plus/myplaces/tracks/filters/SmartFolderHelper.kt
@@ -192,7 +192,7 @@ class SmartFolderHelper(val app: OsmandApplication) {
 	}
 
 	fun addTrackItemToSmartFolder(item: TrackItem) {
-		LOG.debug("addTrackItemToSmartFolder")
+		LOG.debug("addTrackItemToSmartFolder " + item.name)
 		val newSet = HashSet(allAvailableTrackItems)
 		newSet.add(item)
 		allAvailableTrackItems = newSet
diff --git a/OsmAnd/src/net/osmand/plus/routepreparationmenu/cards/MapMarkersCard.java b/OsmAnd/src/net/osmand/plus/routepreparationmenu/cards/MapMarkersCard.java
index a9c2c08a4ac..676895c5126 100644
--- a/OsmAnd/src/net/osmand/plus/routepreparationmenu/cards/MapMarkersCard.java
+++ b/OsmAnd/src/net/osmand/plus/routepreparationmenu/cards/MapMarkersCard.java
@@ -12,14 +12,15 @@
 import androidx.annotation.NonNull;
 import androidx.appcompat.view.ContextThemeWrapper;
 
-import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.data.LatLon;
-import net.osmand.plus.utils.ColorUtilities;
-import net.osmand.plus.mapmarkers.MapMarker;
 import net.osmand.plus.R;
 import net.osmand.plus.activities.MapActivity;
 import net.osmand.plus.base.MapViewTrackingUtilities;
+import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.helpers.MapMarkerDialogHelper;
+import net.osmand.plus.mapmarkers.MapMarker;
+import net.osmand.plus.utils.AndroidUtils;
+import net.osmand.plus.utils.ColorUtilities;
 import net.osmand.plus.views.DirectionDrawable;
 
 import java.util.List;
@@ -37,7 +38,7 @@ public MapMarkersCard(@NonNull MapActivity mapActivity, @NonNull List<MapMarker>
 		super(mapActivity);
 		markers = mapMarkers;
 
-		screenOrientation = app.getUIUtilities().getScreenOrientation(mapActivity);
+		screenOrientation = AndroidUiHelper.getScreenOrientation(mapActivity);
 
 		MapViewTrackingUtilities trackingUtils = mapActivity.getMapViewTrackingUtilities();
 		if (trackingUtils != null) {
diff --git a/OsmAnd/src/net/osmand/plus/search/QuickSearchCoordinatesFragment.java b/OsmAnd/src/net/osmand/plus/search/QuickSearchCoordinatesFragment.java
index ebcf0084272..a245fb9c1b8 100644
--- a/OsmAnd/src/net/osmand/plus/search/QuickSearchCoordinatesFragment.java
+++ b/OsmAnd/src/net/osmand/plus/search/QuickSearchCoordinatesFragment.java
@@ -158,7 +158,7 @@ public View onCreateView(LayoutInflater inflater, ViewGroup container,
 		toolbar.setBackgroundColor(ColorUtilities.getAppBarColor(app, !isLightTheme));
 		toolbar.setTitleTextColor(ContextCompat.getColor(app, isLightTheme ? R.color.card_and_list_background_light : R.color.text_color_primary_dark));
 
-		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(view.getContext());
 		myLocation = app.getLocationProvider().getLastKnownLocation();
 
 		if(currentFormat == -1)
diff --git a/OsmAnd/src/net/osmand/plus/search/QuickSearchListAdapter.java b/OsmAnd/src/net/osmand/plus/search/QuickSearchListAdapter.java
index 6e2fc302fa7..902af95eeac 100644
--- a/OsmAnd/src/net/osmand/plus/search/QuickSearchListAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/search/QuickSearchListAdapter.java
@@ -104,7 +104,7 @@ public QuickSearchListAdapter(@NonNull OsmandApplication app, @NonNull FragmentA
 
 		dp56 = AndroidUtils.dpToPx(app, 56f);
 		dp1 = AndroidUtils.dpToPx(app, 1f);
-		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(activity);
 	}
 
 	public void setAccessibilityAssistant(AccessibilityAssistant accessibilityAssistant) {
diff --git a/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryAdapter.java b/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryAdapter.java
index ac80c882614..a56b20d566a 100644
--- a/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryAdapter.java
@@ -17,6 +17,7 @@
 import net.osmand.data.LatLon;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
+import net.osmand.plus.activities.MapActivity;
 import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.helpers.TargetPointsHelper.TargetPoint;
 import net.osmand.plus.mapmarkers.MapMarker;
@@ -69,15 +70,15 @@ public class HistoryAdapter extends RecyclerView.Adapter<RecyclerView.ViewHolder
 	private final int defaultColorId;
 	private final boolean nightMode;
 
-	public HistoryAdapter(@NonNull OsmandApplication app, @Nullable OnItemSelectedListener listener, boolean nightMode) {
-		this.app = app;
+	public HistoryAdapter(@NonNull MapActivity activity, @Nullable OnItemSelectedListener listener, boolean nightMode) {
+		this.app = activity.getMyApplication();
 		this.listener = listener;
 		this.nightMode = nightMode;
 		activeColorId = ColorUtilities.getActiveColorId(nightMode);
 		defaultColorId = ColorUtilities.getDefaultIconColorId(nightMode);
 		uiUtilities = app.getUIUtilities();
 		themedInflater = UiUtilities.getInflater(app, nightMode);
-		locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(activity);
 	}
 
 	public void updateSettingsItems(@NonNull List<Object> items,
diff --git a/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryItemsFragment.java b/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryItemsFragment.java
index 8cacbd044d8..a1b72c88add 100644
--- a/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryItemsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/settings/fragments/HistoryItemsFragment.java
@@ -91,7 +91,7 @@ public void onScrollStateChanged(@NonNull RecyclerView recyclerView, int newStat
 			}
 		});
 
-		adapter = new HistoryAdapter(app, this, nightMode);
+		adapter = new HistoryAdapter(mapActivity, this, nightMode);
 		adapter.updateSettingsItems(items, itemsGroups, selectedItems);
 		recyclerView.setAdapter(adapter);
 
diff --git a/OsmAnd/src/net/osmand/plus/track/cards/TrackPointsCard.java b/OsmAnd/src/net/osmand/plus/track/cards/TrackPointsCard.java
index dce5fe1d4fc..0b1989a8d44 100644
--- a/OsmAnd/src/net/osmand/plus/track/cards/TrackPointsCard.java
+++ b/OsmAnd/src/net/osmand/plus/track/cards/TrackPointsCard.java
@@ -372,7 +372,7 @@ private class PointGPXAdapter extends OsmandBaseExpandableListAdapter implements
 		private final UpdateLocationViewCache locationViewCache;
 
 		PointGPXAdapter() {
-			locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+			locationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(activity);
 		}
 
 		public void synchronizeGroups(@NonNull List<GpxDisplayGroup> displayGroups) {
diff --git a/OsmAnd/src/net/osmand/plus/track/fragments/TrackMenuFragment.java b/OsmAnd/src/net/osmand/plus/track/fragments/TrackMenuFragment.java
index afb528fb7af..9f93e7dfc6b 100644
--- a/OsmAnd/src/net/osmand/plus/track/fragments/TrackMenuFragment.java
+++ b/OsmAnd/src/net/osmand/plus/track/fragments/TrackMenuFragment.java
@@ -292,9 +292,11 @@ public TrackDisplayHelper getDisplayHelper() {
 	@Override
 	public void onCreate(Bundle savedInstanceState) {
 		super.onCreate(savedInstanceState);
+		FragmentActivity activity = requireMyActivity();
+
 		displayHelper = new TrackDisplayHelper(app);
 		gpxSelectionHelper = app.getSelectedGpxHelper();
-		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(app);
+		updateLocationViewCache = UpdateLocationUtils.getUpdateLocationViewCache(activity);
 
 		toolbarHeightPx = getResources().getDimensionPixelSize(R.dimen.dashboard_map_toolbar);
 		if (selectedGpxFile == null && savedInstanceState != null) {
@@ -323,7 +325,6 @@ public void onCreate(Bundle savedInstanceState) {
 			}
 		}
 
-		FragmentActivity activity = requireMyActivity();
 		activity.getOnBackPressedDispatcher().addCallback(this, new OnBackPressedCallback(true) {
 			public void handleOnBackPressed() {
 				if (getCurrentMenuState() != MenuState.HEADER_ONLY && isPortrait()) {
diff --git a/OsmAnd/src/net/osmand/plus/utils/AndroidUtils.java b/OsmAnd/src/net/osmand/plus/utils/AndroidUtils.java
index 4502d4df0b3..e13910fdab1 100644
--- a/OsmAnd/src/net/osmand/plus/utils/AndroidUtils.java
+++ b/OsmAnd/src/net/osmand/plus/utils/AndroidUtils.java
@@ -111,7 +111,6 @@
 import java.util.List;
 import java.util.Locale;
 import java.util.Map;
-import java.util.Objects;
 import java.util.regex.Matcher;
 import java.util.regex.Pattern;
 
diff --git a/OsmAnd/src/net/osmand/plus/utils/UiUtilities.java b/OsmAnd/src/net/osmand/plus/utils/UiUtilities.java
index 5014cf3fe49..c8a4dc93214 100644
--- a/OsmAnd/src/net/osmand/plus/utils/UiUtilities.java
+++ b/OsmAnd/src/net/osmand/plus/utils/UiUtilities.java
@@ -1,7 +1,6 @@
 package net.osmand.plus.utils;
 
 import android.content.Context;
-import android.content.pm.PackageManager;
 import android.content.res.ColorStateList;
 import android.graphics.Color;
 import android.graphics.Typeface;
@@ -21,7 +20,6 @@
 import android.view.View;
 import android.view.ViewGroup;
 import android.view.ViewParent;
-import android.view.WindowManager;
 import android.widget.CompoundButton;
 import android.widget.ImageView;
 import android.widget.LinearLayout;
@@ -77,10 +75,6 @@ public class UiUtilities {
 
 	private static final Log LOG = PlatformUtil.getLog(UiUtilities.class);
 
-	private static final int ORIENTATION_0 = 0;
-	private static final int ORIENTATION_90 = 3;
-	private static final int ORIENTATION_270 = 1;
-	private static final int ORIENTATION_180 = 2;
 	private final TLongObjectHashMap<Drawable> drawableCache = new TLongObjectHashMap<>();
 	private final OsmandApplication app;
 	private static final int INVALID_ID = -1;
@@ -221,35 +215,6 @@ public static Drawable tintDrawable(Drawable drawable, @ColorInt int color) {
 		return coloredDrawable;
 	}
 
-	public int getScreenOrientation() {
-		return getScreenOrientation(app);
-	}
-
-	public int getScreenOrientation(@NonNull Context context) {
-		int screenOrientation = ((WindowManager) context.getSystemService(Context.WINDOW_SERVICE)).getDefaultDisplay().getRotation();
-		switch (screenOrientation) {
-			case ORIENTATION_0:   // Device default (normally portrait)
-				screenOrientation = 0;
-				break;
-			case ORIENTATION_90:  // Landscape right
-				screenOrientation = 90;
-				break;
-			case ORIENTATION_270: // Landscape left
-				screenOrientation = 270;
-				break;
-			case ORIENTATION_180: // Upside down
-				screenOrientation = 180;
-				break;
-		}
-		//Looks like screenOrientation correction must not be applied for devices without compass?
-		PackageManager manager = app.getPackageManager();
-		boolean hasCompass = manager.hasSystemFeature(PackageManager.FEATURE_SENSOR_COMPASS);
-		if (!hasCompass) {
-			screenOrientation = 0;
-		}
-		return screenOrientation;
-	}
-
 	public static void setupSnackbar(Snackbar snackbar, boolean nightMode) {
 		setupSnackbar(snackbar, nightMode, null, null, null, null);
 	}
diff --git a/OsmAnd/src/net/osmand/plus/utils/UpdateLocationUtils.java b/OsmAnd/src/net/osmand/plus/utils/UpdateLocationUtils.java
index ed742c2fb11..8924ba578e5 100644
--- a/OsmAnd/src/net/osmand/plus/utils/UpdateLocationUtils.java
+++ b/OsmAnd/src/net/osmand/plus/utils/UpdateLocationUtils.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.utils;
 
+import android.content.Context;
 import android.graphics.Typeface;
 import android.text.SpannableString;
 import android.text.style.ForegroundColorSpan;
@@ -9,12 +10,14 @@
 import androidx.annotation.ColorInt;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
+import androidx.annotation.UiContext;
 
 import net.osmand.Location;
 import net.osmand.data.LatLon;
 import net.osmand.plus.OsmAndLocationProvider;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
+import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.helpers.FontCache;
 import net.osmand.plus.views.DirectionDrawable;
 import net.osmand.plus.widgets.style.CustomTypefaceSpan;
@@ -22,15 +25,15 @@
 public class UpdateLocationUtils {
 
 	@NonNull
-	public static UpdateLocationViewCache getUpdateLocationViewCache(@NonNull OsmandApplication app) {
-		return getUpdateLocationViewCache(app, true);
+	public static UpdateLocationViewCache getUpdateLocationViewCache(@NonNull @UiContext Context context) {
+		return getUpdateLocationViewCache(context, true);
 	}
 
 	@NonNull
-	public static UpdateLocationViewCache getUpdateLocationViewCache(@NonNull OsmandApplication app, boolean useScreenOrientation) {
+	public static UpdateLocationViewCache getUpdateLocationViewCache(@NonNull @UiContext Context context, boolean useScreenOrientation) {
 		UpdateLocationViewCache viewCache = new UpdateLocationViewCache();
 		if (useScreenOrientation) {
-			viewCache.screenOrientation = app.getUIUtilities().getScreenOrientation();
+			viewCache.screenRotation = AndroidUiHelper.getScreenRotation(context);
 		}
 		return viewCache;
 	}
@@ -104,7 +107,7 @@ public static void setupDirectionDrawable(@NonNull DirectionDrawable drawable,
 		if (info.heading == null || info.toLocation == null) {
 			drawable.setAngle(0);
 		} else {
-			float orientation = (cache == null ? 0 : cache.screenOrientation);
+			float orientation = (cache == null ? 0 : cache.screenRotation);
 			drawable.setAngle(info.mes[1] - info.heading + 180 + orientation);
 		}
 	}
@@ -166,7 +169,7 @@ public UpdateLocationInfo(@NonNull OsmandApplication app, @Nullable LatLon speci
 	}
 
 	public static class UpdateLocationViewCache {
-		public int screenOrientation;
+		public int screenRotation;
 		public boolean paintTxt = true;
 		public int arrowResId;
 		public int arrowColor;
