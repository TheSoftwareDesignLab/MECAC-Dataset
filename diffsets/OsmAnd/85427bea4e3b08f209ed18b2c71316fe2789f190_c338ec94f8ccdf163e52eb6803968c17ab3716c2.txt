diff --git a/OsmAnd/res/layout-land/map_hud_top.xml b/OsmAnd/res/layout-land/map_hud_top.xml
index 878dc877b46..5107ee2eb6e 100644
--- a/OsmAnd/res/layout-land/map_hud_top.xml
+++ b/OsmAnd/res/layout-land/map_hud_top.xml
@@ -274,42 +274,18 @@
 		</LinearLayout>
 
 		<!-- RIGHT widgets colon -->
-		<FrameLayout
+		<LinearLayout
+			android:id="@+id/map_right_widgets_panel"
 			android:layout_width="wrap_content"
 			android:layout_height="wrap_content"
-			android:layout_gravity="top|end">
-
-			<LinearLayout
-				android:layout_width="wrap_content"
-				android:layout_height="wrap_content"
-				android:layout_gravity="top|end"
-				android:orientation="vertical">
-
-				<LinearLayout
-					android:id="@+id/map_right_widgets_panel"
-					android:layout_width="wrap_content"
-					android:layout_height="wrap_content"
-					android:layout_gravity="top|end"
-					android:orientation="vertical">
-
-					<include layout="@layout/map_hud_widget"/>
-
-					<include layout="@layout/map_hud_widget"/>
-
-				</LinearLayout>
+			android:layout_gravity="top|end"
+			android:orientation="vertical">
 
-				<ImageButton
-					android:id="@+id/map_collapse_button"
-					android:contentDescription="@string/shared_string_collapse"
-					android:layout_width="@dimen/map_small_button_size"
-					android:layout_height="@dimen/map_small_button_size"
-					android:layout_gravity="top|center_horizontal"
-					android:background="@drawable/btn_inset_circle_trans"
-					osmand:srcCompat="@drawable/ic_action_remove_dark"/>
+			<include layout="@layout/map_hud_widget"/>
 
-			</LinearLayout>
+			<include layout="@layout/map_hud_widget"/>
 
-		</FrameLayout>
+		</LinearLayout>
 
 	</LinearLayout>
 
diff --git a/OsmAnd/res/layout/map_hud_top.xml b/OsmAnd/res/layout/map_hud_top.xml
index f2ed833aaa8..3979b81c641 100644
--- a/OsmAnd/res/layout/map_hud_top.xml
+++ b/OsmAnd/res/layout/map_hud_top.xml
@@ -264,32 +264,16 @@
 				android:layout_weight="0.45">
 
 				<LinearLayout
+					android:id="@+id/map_right_widgets_panel"
 					android:layout_width="wrap_content"
 					android:layout_height="wrap_content"
 					android:layout_gravity="top|end"
-					android:orientation="vertical">
-
-					<LinearLayout
-						android:id="@+id/map_right_widgets_panel"
-						android:layout_width="wrap_content"
-						android:layout_height="wrap_content"
-						android:layout_gravity="top|end"
-						android:orientation="vertical">
-
-						<include layout="@layout/map_hud_widget"/>
-
-						<include layout="@layout/map_hud_widget"/>
+					android:orientation="vertical"
+					tools:ignore="UselessParent">
 
-					</LinearLayout>
+					<include layout="@layout/map_hud_widget"/>
 
-					<ImageButton
-						android:id="@+id/map_collapse_button"
-						android:contentDescription="@string/shared_string_collapse"
-						android:layout_width="@dimen/map_small_button_size"
-						android:layout_height="@dimen/map_small_button_size"
-						android:layout_gravity="top|center_horizontal"
-						android:background="@drawable/btn_inset_circle_trans"
-						tools:src="@drawable/ic_action_remove_dark"/>
+					<include layout="@layout/map_hud_widget"/>
 
 				</LinearLayout>
 
diff --git a/OsmAnd/src/net/osmand/plus/mapcontextmenu/controllers/MapMarkerMenuController.java b/OsmAnd/src/net/osmand/plus/mapcontextmenu/controllers/MapMarkerMenuController.java
index 92a61d0860c..fa051543b18 100644
--- a/OsmAnd/src/net/osmand/plus/mapcontextmenu/controllers/MapMarkerMenuController.java
+++ b/OsmAnd/src/net/osmand/plus/mapcontextmenu/controllers/MapMarkerMenuController.java
@@ -60,7 +60,7 @@ public void buttonPressed() {
 								= activity.getMyApplication().getSettings().MARKERS_DISTANCE_INDICATION_ENABLED;
 						if (!indication.get()) {
 							indication.set(true);
-							activity.getMapLayers().getMapWidgetRegistry().updateMapMarkersMode(activity);
+							activity.getMapLayers().getMapWidgetRegistry().updateMarkerSideWidgetsVisibility(activity);
 						}
 						MapMarkersHelper markersHelper = activity.getMyApplication().getMapMarkersHelper();
 						markersHelper.moveMarkerToTop(getMapMarker());
diff --git a/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkersDialogFragment.java b/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkersDialogFragment.java
index 9933147c8fc..1b964a902bf 100644
--- a/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkersDialogFragment.java
+++ b/OsmAnd/src/net/osmand/plus/mapmarkers/MapMarkersDialogFragment.java
@@ -443,7 +443,7 @@ private DirectionIndicationFragmentListener createShowDirectionFragmentListener(
 
 			@Override
 			public void onMapMarkersModeChanged(boolean showDirectionEnabled) {
-				mapActivity.getMapLayers().getMapWidgetRegistry().updateMapMarkersMode(mapActivity);
+				mapActivity.getMapLayers().getMapWidgetRegistry().updateMarkerSideWidgetsVisibility(mapActivity);
 				activeFragment.setShowDirectionEnabled(showDirectionEnabled);
 				updateAdapters();
 			}
diff --git a/OsmAnd/src/net/osmand/plus/mapmarkers/PlanRouteFragment.java b/OsmAnd/src/net/osmand/plus/mapmarkers/PlanRouteFragment.java
index a47b907c2f9..f188dbba1cf 100644
--- a/OsmAnd/src/net/osmand/plus/mapmarkers/PlanRouteFragment.java
+++ b/OsmAnd/src/net/osmand/plus/mapmarkers/PlanRouteFragment.java
@@ -1,8 +1,5 @@
 package net.osmand.plus.mapmarkers;
 
-import static net.osmand.plus.settings.backend.OsmandSettings.LANDSCAPE_MIDDLE_RIGHT_CONSTANT;
-import static net.osmand.plus.settings.backend.OsmandSettings.MIDDLE_TOP_CONSTANT;
-
 import android.app.ProgressDialog;
 import android.content.Context;
 import android.graphics.drawable.Drawable;
@@ -20,21 +17,8 @@
 import android.widget.ProgressBar;
 import android.widget.TextView;
 
-import androidx.activity.OnBackPressedCallback;
-import androidx.annotation.DrawableRes;
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.appcompat.widget.Toolbar;
-import androidx.core.content.ContextCompat;
-import androidx.fragment.app.Fragment;
-import androidx.fragment.app.FragmentManager;
-import androidx.recyclerview.widget.ItemTouchHelper;
-import androidx.recyclerview.widget.LinearLayoutManager;
-import androidx.recyclerview.widget.RecyclerView;
-
 import com.google.android.material.snackbar.Snackbar;
 
-import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.GPXUtilities.TrkSegment;
 import net.osmand.GPXUtilities.WptPt;
 import net.osmand.Location;
@@ -42,16 +26,14 @@
 import net.osmand.data.LatLon;
 import net.osmand.data.PointDescription;
 import net.osmand.data.RotatedTileBox;
-import net.osmand.plus.utils.ColorUtilities;
-import net.osmand.plus.utils.OsmAndFormatter;
 import net.osmand.plus.OsmAndLocationProvider.OsmAndLocationListener;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
-import net.osmand.plus.helpers.TargetPointsHelper;
-import net.osmand.plus.helpers.TargetPointsHelper.TargetPoint;
 import net.osmand.plus.activities.MapActivity;
 import net.osmand.plus.base.BaseOsmAndFragment;
 import net.osmand.plus.helpers.AndroidUiHelper;
+import net.osmand.plus.helpers.TargetPointsHelper;
+import net.osmand.plus.helpers.TargetPointsHelper.TargetPoint;
 import net.osmand.plus.mapmarkers.PlanRouteOptionsBottomSheetDialogFragment.PlanRouteOptionsFragmentListener;
 import net.osmand.plus.mapmarkers.adapters.MapMarkersItemTouchHelperCallback;
 import net.osmand.plus.mapmarkers.adapters.MapMarkersListAdapter;
@@ -60,6 +42,9 @@
 import net.osmand.plus.routing.RoutingHelper;
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.settings.backend.OsmandSettings;
+import net.osmand.plus.utils.AndroidUtils;
+import net.osmand.plus.utils.ColorUtilities;
+import net.osmand.plus.utils.OsmAndFormatter;
 import net.osmand.plus.views.OsmandMapTileView;
 import net.osmand.plus.views.layers.MapMarkersLayer;
 import net.osmand.plus.views.mapwidgets.MapInfoWidgetsFactory;
@@ -69,6 +54,21 @@
 import java.util.ArrayList;
 import java.util.List;
 
+import androidx.activity.OnBackPressedCallback;
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.appcompat.widget.Toolbar;
+import androidx.core.content.ContextCompat;
+import androidx.fragment.app.Fragment;
+import androidx.fragment.app.FragmentManager;
+import androidx.recyclerview.widget.ItemTouchHelper;
+import androidx.recyclerview.widget.LinearLayoutManager;
+import androidx.recyclerview.widget.RecyclerView;
+
+import static net.osmand.plus.settings.backend.OsmandSettings.LANDSCAPE_MIDDLE_RIGHT_CONSTANT;
+import static net.osmand.plus.settings.backend.OsmandSettings.MIDDLE_TOP_CONSTANT;
+
 public class PlanRouteFragment extends BaseOsmAndFragment implements OsmAndLocationListener {
 
 	public static final String TAG = "PlanRouteFragment";
@@ -88,7 +88,6 @@ public class PlanRouteFragment extends BaseOsmAndFragment implements OsmAndLocat
 	private boolean nightMode;
 	private boolean portrait;
 	private boolean fullScreen;
-	private boolean wasCollapseButtonVisible;
 	private boolean cancelSnapToRoad = true;
 
 	private Location location;
@@ -647,14 +646,6 @@ private void enterPlanRouteMode() {
 					R.id.map_search_button,
 					R.id.map_quick_actions_button);
 
-			View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-			if (collapseButton != null && collapseButton.getVisibility() == View.VISIBLE) {
-				wasCollapseButtonVisible = true;
-				collapseButton.setVisibility(View.INVISIBLE);
-			} else {
-				wasCollapseButtonVisible = false;
-			}
-
 			if (planRouteContext.getSnappedMode() == null) {
 				planRouteContext.setSnappedMode(ApplicationMode.DEFAULT);
 			}
@@ -717,11 +708,6 @@ private void exitPlanRouteMode() {
 					R.id.map_search_button,
 					R.id.map_quick_actions_button);
 
-			View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-			if (collapseButton != null && wasCollapseButtonVisible) {
-				collapseButton.setVisibility(View.VISIBLE);
-			}
-
 			mapActivity.findViewById(R.id.snap_to_road_image_button).setVisibility(View.GONE);
 			mainView.findViewById(R.id.snap_to_road_progress_bar).setVisibility(View.GONE);
 			mapActivity.findViewById(R.id.bottom_controls_container).setVisibility(View.VISIBLE);
diff --git a/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java b/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java
index 5254fa613e9..e517b757218 100644
--- a/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java
+++ b/OsmAnd/src/net/osmand/plus/measurementtool/MeasurementToolFragment.java
@@ -1,17 +1,5 @@
 package net.osmand.plus.measurementtool;
 
-import static net.osmand.IndexConstants.GPX_FILE_EXT;
-import static net.osmand.IndexConstants.GPX_INDEX_DIR;
-import static net.osmand.plus.measurementtool.MeasurementEditingContext.CalculationMode;
-import static net.osmand.plus.measurementtool.SaveAsNewTrackBottomSheetDialogFragment.SaveAsNewTrackFragmentListener;
-import static net.osmand.plus.measurementtool.SelectFileBottomSheet.Mode.ADD_TO_TRACK;
-import static net.osmand.plus.measurementtool.SelectFileBottomSheet.SelectFileListener;
-import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode;
-import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode.AFTER;
-import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode.ALL;
-import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode.BEFORE;
-import static net.osmand.plus.routing.TransportRoutingHelper.PUBLIC_TRANSPORT_KEY;
-
 import android.app.Activity;
 import android.content.Context;
 import android.content.Intent;
@@ -35,17 +23,6 @@
 import android.widget.TextView;
 import android.widget.Toast;
 
-import androidx.activity.OnBackPressedCallback;
-import androidx.annotation.DrawableRes;
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.appcompat.content.res.AppCompatResources;
-import androidx.core.content.ContextCompat;
-import androidx.core.widget.TextViewCompat;
-import androidx.fragment.app.FragmentManager;
-import androidx.recyclerview.widget.ItemTouchHelper;
-import androidx.recyclerview.widget.RecyclerView;
-
 import com.github.ksoichiro.android.observablescrollview.ScrollUtils;
 import com.google.android.material.snackbar.Snackbar;
 
@@ -119,6 +96,29 @@
 import java.util.List;
 import java.util.Locale;
 
+import androidx.activity.OnBackPressedCallback;
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.appcompat.content.res.AppCompatResources;
+import androidx.core.content.ContextCompat;
+import androidx.core.widget.TextViewCompat;
+import androidx.fragment.app.FragmentManager;
+import androidx.recyclerview.widget.ItemTouchHelper;
+import androidx.recyclerview.widget.RecyclerView;
+
+import static net.osmand.IndexConstants.GPX_FILE_EXT;
+import static net.osmand.IndexConstants.GPX_INDEX_DIR;
+import static net.osmand.plus.measurementtool.MeasurementEditingContext.CalculationMode;
+import static net.osmand.plus.measurementtool.SaveAsNewTrackBottomSheetDialogFragment.SaveAsNewTrackFragmentListener;
+import static net.osmand.plus.measurementtool.SelectFileBottomSheet.Mode.ADD_TO_TRACK;
+import static net.osmand.plus.measurementtool.SelectFileBottomSheet.SelectFileListener;
+import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode;
+import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode.AFTER;
+import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode.ALL;
+import static net.osmand.plus.measurementtool.command.ClearPointsCommand.ClearCommandMode.BEFORE;
+import static net.osmand.plus.routing.TransportRoutingHelper.PUBLIC_TRANSPORT_KEY;
+
 public class MeasurementToolFragment extends BaseOsmAndFragment implements RouteBetweenPointsFragmentListener,
 		OptionsFragmentListener, GpxApproximationFragmentListener, SelectedPointFragmentListener,
 		SaveAsNewTrackFragmentListener, MapControlsThemeInfoProvider, GpsFilterFragmentLister {
@@ -159,7 +159,6 @@ public class MeasurementToolFragment extends BaseOsmAndFragment implements Route
 
 	private InfoType currentInfoType;
 
-	private boolean wasCollapseButtonVisible;
 	private boolean progressBarVisible;
 	private boolean infoExpanded;
 
@@ -1941,13 +1940,6 @@ private void enterMeasurementMode() {
 
 			mainView.getViewTreeObserver().addOnGlobalLayoutListener(getWidgetsLayoutListener());
 
-			View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-			if (collapseButton != null && collapseButton.getVisibility() == View.VISIBLE) {
-				wasCollapseButtonVisible = true;
-				collapseButton.setVisibility(View.INVISIBLE);
-			} else {
-				wasCollapseButtonVisible = false;
-			}
 			updateMainIcon();
 			updateDistancePointsText();
 		}
@@ -2001,11 +1993,6 @@ private void exitMeasurementMode() {
 					R.id.map_search_button,
 					R.id.map_quick_actions_button);
 
-			View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-			if (collapseButton != null && wasCollapseButtonVisible) {
-				collapseButton.setVisibility(View.VISIBLE);
-			}
-
 			mapActivity.refreshMap();
 		}
 	}
diff --git a/OsmAnd/src/net/osmand/plus/plugins/mapillary/MapillaryPlugin.java b/OsmAnd/src/net/osmand/plus/plugins/mapillary/MapillaryPlugin.java
index 28df67f5d9b..d6f86b9267c 100644
--- a/OsmAnd/src/net/osmand/plus/plugins/mapillary/MapillaryPlugin.java
+++ b/OsmAnd/src/net/osmand/plus/plugins/mapillary/MapillaryPlugin.java
@@ -261,7 +261,7 @@ public void setWidgetVisible(MapActivity mapActivity, boolean visible) {
 		if (mapillaryWidgetRegInfo != null) {
 			final List<ApplicationMode> allModes = ApplicationMode.allPossibleValues();
 			for (ApplicationMode mode : allModes) {
-				mapActivity.getMapLayers().getMapWidgetRegistry().setVisibility(mode, mapillaryWidgetRegInfo, visible, false);
+				mapActivity.getMapLayers().getMapWidgetRegistry().setVisibility(mode, mapillaryWidgetRegInfo, visible);
 			}
 			MapInfoLayer mil = mapActivity.getMapLayers().getMapInfoLayer();
 			if (mil != null) {
diff --git a/OsmAnd/src/net/osmand/plus/settings/backend/ApplicationMode.java b/OsmAnd/src/net/osmand/plus/settings/backend/ApplicationMode.java
index 26085fa1131..40d98c968eb 100644
--- a/OsmAnd/src/net/osmand/plus/settings/backend/ApplicationMode.java
+++ b/OsmAnd/src/net/osmand/plus/settings/backend/ApplicationMode.java
@@ -1,29 +1,5 @@
 package net.osmand.plus.settings.backend;
 
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_ALTITUDE;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BATTERY;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BEARING;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_COMPASS;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_DISTANCE;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_GPS_INFO;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_DISTANCE;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_TIME;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_1;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_2;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MAX_SPEED;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_NEXT_TURN;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN_SMALL;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_PLAIN_TIME;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_RADIUS_RULER;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_SPEED;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_TIME;
-
-import androidx.annotation.ColorInt;
-import androidx.annotation.DrawableRes;
-import androidx.annotation.NonNull;
-import androidx.core.content.ContextCompat;
-
 import com.google.gson.Gson;
 import com.google.gson.GsonBuilder;
 import com.google.gson.annotations.Expose;
@@ -49,10 +25,33 @@
 import java.util.Map;
 import java.util.Set;
 
+import androidx.annotation.ColorInt;
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.core.content.ContextCompat;
+
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_ALTITUDE;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BATTERY;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BEARING;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_DISTANCE;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_GPS_INFO;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_DISTANCE;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_TIME;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_1;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_2;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MAX_SPEED;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_NEXT_TURN;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN_SMALL;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_PLAIN_TIME;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_RADIUS_RULER;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_SPEED;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_TIME;
+
 public class ApplicationMode {
 
-	private static Map<String, Set<ApplicationMode>> widgetsVisibilityMap = new LinkedHashMap<>();
-	private static Map<String, Set<ApplicationMode>> widgetsAvailabilityMap = new LinkedHashMap<>();
+	private static final Map<String, Set<ApplicationMode>> widgetsVisibilityMap = new LinkedHashMap<>();
+	private static final Map<String, Set<ApplicationMode>> widgetsAvailabilityMap = new LinkedHashMap<>();
 
 	private static List<ApplicationMode> defaultValues = new ArrayList<>();
 	private static List<ApplicationMode> values = new ArrayList<>();
@@ -260,19 +259,12 @@ public static Set<ApplicationMode> regWidgetVisibility(String widgetId, Applicat
 		return set;
 	}
 
-	public boolean isWidgetCollapsible(String key) {
-		return false;
-	}
-
-	public boolean isWidgetVisible(String key) {
+	public boolean isWidgetVisibleByDefault(@NonNull String widgetId) {
 		if (app.getAppCustomization().areWidgetsCustomized()) {
-			return app.getAppCustomization().isWidgetVisible(key, this);
+			return app.getAppCustomization().isWidgetVisible(widgetId, this);
 		}
-		Set<ApplicationMode> set = widgetsVisibilityMap.get(key);
-		if (set == null) {
-			return false;
-		}
-		return set.contains(this);
+		Set<ApplicationMode> widgetsVisibility = widgetsVisibilityMap.get(widgetId);
+		return widgetsVisibility != null && widgetsVisibility.contains(this);
 	}
 
 	public static Set<ApplicationMode> regWidgetAvailability(String widgetId, ApplicationMode... am) {
diff --git a/OsmAnd/src/net/osmand/plus/settings/backend/OsmandSettings.java b/OsmAnd/src/net/osmand/plus/settings/backend/OsmandSettings.java
index 4a0dd435f0b..8fce5b11a28 100644
--- a/OsmAnd/src/net/osmand/plus/settings/backend/OsmandSettings.java
+++ b/OsmAnd/src/net/osmand/plus/settings/backend/OsmandSettings.java
@@ -782,7 +782,7 @@ public boolean enablePlugin(String pluginId, boolean enable) {
 
 		@Override
 		public Boolean getModeValue(ApplicationMode mode) {
-			boolean defaultValue = mode.isWidgetVisible(WIDGET_COMPASS);
+			boolean defaultValue = mode.isWidgetVisibleByDefault(WIDGET_COMPASS);
 			List<String> widgetsVisibility = getWidgetsVisibilityInfo(mode);
 			if (widgetsVisibility.contains(WIDGET_COMPASS)) {
 				return true;
diff --git a/OsmAnd/src/net/osmand/plus/views/layers/ContextMenuLayer.java b/OsmAnd/src/net/osmand/plus/views/layers/ContextMenuLayer.java
index db75e3e313b..42267ee3b21 100644
--- a/OsmAnd/src/net/osmand/plus/views/layers/ContextMenuLayer.java
+++ b/OsmAnd/src/net/osmand/plus/views/layers/ContextMenuLayer.java
@@ -1,9 +1,5 @@
 package net.osmand.plus.views.layers;
 
-import static net.osmand.IndexConstants.GPX_FILE_EXT;
-import static net.osmand.aidlapi.OsmAndCustomizationConstants.MAP_CONTEXT_MENU_CHANGE_MARKER_POSITION;
-import static net.osmand.data.FavouritePoint.DEFAULT_BACKGROUND_TYPE;
-
 import android.Manifest;
 import android.content.Context;
 import android.graphics.Bitmap;
@@ -21,11 +17,6 @@
 import android.widget.FrameLayout.LayoutParams;
 import android.widget.ImageView;
 
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.annotation.RequiresPermission;
-import androidx.appcompat.content.res.AppCompatResources;
-
 import net.osmand.CallbackWithObject;
 import net.osmand.GPXUtilities;
 import net.osmand.GPXUtilities.WptPt;
@@ -96,8 +87,16 @@
 import java.util.Map.Entry;
 import java.util.Set;
 
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.annotation.RequiresPermission;
+import androidx.appcompat.content.res.AppCompatResources;
 import gnu.trove.list.array.TIntArrayList;
 
+import static net.osmand.IndexConstants.GPX_FILE_EXT;
+import static net.osmand.aidlapi.OsmAndCustomizationConstants.MAP_CONTEXT_MENU_CHANGE_MARKER_POSITION;
+import static net.osmand.data.FavouritePoint.DEFAULT_BACKGROUND_TYPE;
+
 public class ContextMenuLayer extends OsmandMapLayer {
 	//private static final Log LOG = PlatformUtil.getLog(ContextMenuLayer.class);
 	public static final int VIBRATE_SHORT = 100;
@@ -124,7 +123,6 @@ public class ContextMenuLayer extends OsmandMapLayer {
 	private IContextMenuProvider selectedObjectContextMenuProvider;
 	private boolean cancelApplyingNewMarkerPosition;
 	private LatLon applyingMarkerLatLon;
-	private boolean wasCollapseButtonVisible;
 	private boolean mInGpxDetailsMode;
 	private boolean mInAddGpxPointMode;
 
@@ -499,14 +497,6 @@ public void enterGpxDetailsMode() {
 		mapActivity.disableDrawer();
 		AndroidUiHelper.setVisibility(mapActivity, View.INVISIBLE, R.id.map_ruler_layout,
 				R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
-
-		View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-		if (collapseButton != null && collapseButton.getVisibility() == View.VISIBLE) {
-			wasCollapseButtonVisible = true;
-			collapseButton.setVisibility(View.INVISIBLE);
-		} else {
-			wasCollapseButtonVisible = false;
-		}
 	}
 
 	public void exitGpxDetailsMode() {
@@ -519,11 +509,6 @@ public void exitGpxDetailsMode() {
 		mapActivity.enableDrawer();
 		AndroidUiHelper.setVisibility(mapActivity, View.VISIBLE, R.id.map_ruler_layout,
 				R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
-
-		View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-		if (collapseButton != null && wasCollapseButtonVisible) {
-			collapseButton.setVisibility(View.VISIBLE);
-		}
 	}
 
 	private void quitMovingMarker() {
@@ -535,11 +520,6 @@ private void quitMovingMarker() {
 		mInChangeMarkerPositionMode = false;
 		AndroidUiHelper.setVisibility(mapActivity, View.VISIBLE, R.id.map_ruler_layout,
 				R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
-
-		View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-		if (collapseButton != null && wasCollapseButtonVisible) {
-			collapseButton.setVisibility(View.VISIBLE);
-		}
 	}
 
 	public void quitAddGpxPoint() {
@@ -551,11 +531,6 @@ public void quitAddGpxPoint() {
 		mInAddGpxPointMode = false;
 		AndroidUiHelper.setVisibility(mapActivity, View.VISIBLE, R.id.map_ruler_layout,
 				R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
-
-		View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-		if (collapseButton != null && wasCollapseButtonVisible) {
-			collapseButton.setVisibility(View.VISIBLE);
-		}
 	}
 
 	public void enterAddGpxPointMode(NewGpxPoint newGpxPoint) {
@@ -574,14 +549,6 @@ public void enterAddGpxPointMode(NewGpxPoint newGpxPoint) {
 		AndroidUiHelper.setVisibility(mapActivity, View.INVISIBLE, R.id.map_ruler_layout,
 				R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
 
-		View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-		if (collapseButton != null && collapseButton.getVisibility() == View.VISIBLE) {
-			wasCollapseButtonVisible = true;
-			collapseButton.setVisibility(View.INVISIBLE);
-		} else {
-			wasCollapseButtonVisible = false;
-		}
-
 		view.refreshMap();
 	}
 
@@ -612,14 +579,6 @@ private void enterMovingMode(RotatedTileBox tileBox) {
 		AndroidUiHelper.setVisibility(mapActivity, View.INVISIBLE, R.id.map_ruler_layout,
 				R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
 
-		View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-		if (collapseButton != null && collapseButton.getVisibility() == View.VISIBLE) {
-			wasCollapseButtonVisible = true;
-			collapseButton.setVisibility(View.INVISIBLE);
-		} else {
-			wasCollapseButtonVisible = false;
-		}
-
 		view.refreshMap();
 	}
 
diff --git a/OsmAnd/src/net/osmand/plus/views/layers/MapInfoLayer.java b/OsmAnd/src/net/osmand/plus/views/layers/MapInfoLayer.java
index aede2747513..2c5118664fd 100644
--- a/OsmAnd/src/net/osmand/plus/views/layers/MapInfoLayer.java
+++ b/OsmAnd/src/net/osmand/plus/views/layers/MapInfoLayer.java
@@ -1,53 +1,19 @@
 package net.osmand.plus.views.layers;
 
 
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_ALTITUDE;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BATTERY;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BEARING;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_DISTANCE;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_GPS_INFO;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_DISTANCE;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_TIME;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_1;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_2;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MAX_SPEED;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_NEXT_TURN;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN_SMALL;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_PLAIN_TIME;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_RADIUS_RULER;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_SPEED;
-import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_TIME;
-import static net.osmand.plus.views.mapwidgets.MarkersWidgetsHelper.WIDGET_MAP_MARKERS;
-import static net.osmand.plus.views.mapwidgets.widgets.CoordinatesWidget.WIDGET_COORDINATES;
-import static net.osmand.plus.views.mapwidgets.widgets.ElevationProfileWidget.WIDGET_ELEVATION_PROFILE;
-import static net.osmand.plus.views.mapwidgets.widgets.LanesWidget.WIDGET_LANES;
-import static net.osmand.plus.views.mapwidgets.widgets.StreetNameWidget.WIDGET_STREET_NAME;
-
 import android.content.Context;
 import android.graphics.Canvas;
-import android.graphics.drawable.Drawable;
 import android.view.View;
 import android.view.ViewGroup;
-import android.widget.ImageButton;
-
-import androidx.annotation.DrawableRes;
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.annotation.StringRes;
-import androidx.core.content.ContextCompat;
 
 import net.osmand.StateChangedListener;
 import net.osmand.data.RotatedTileBox;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
 import net.osmand.plus.activities.MapActivity;
-import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.mapcontextmenu.other.TrackChartPoints;
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.settings.backend.OsmandSettings;
-import net.osmand.plus.utils.ColorUtilities;
-import net.osmand.plus.utils.UiUtilities;
 import net.osmand.plus.views.OsmandMapTileView;
 import net.osmand.plus.views.layers.base.OsmandMapLayer;
 import net.osmand.plus.views.mapwidgets.MapInfoWidgetsFactory;
@@ -76,9 +42,36 @@
 import java.util.ArrayList;
 import java.util.List;
 
-public class MapInfoLayer extends OsmandMapLayer {
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.annotation.StringRes;
+import androidx.core.content.ContextCompat;
 
-	private static boolean WIDGETS_EXPANDED = false;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_ALTITUDE;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BATTERY;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_BEARING;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_DISTANCE;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_GPS_INFO;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_DISTANCE;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_INTERMEDIATE_TIME;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_1;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MARKER_2;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_MAX_SPEED;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_NEXT_TURN;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_NEXT_TURN_SMALL;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_PLAIN_TIME;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_RADIUS_RULER;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_SPEED;
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_TIME;
+import static net.osmand.plus.views.mapwidgets.MarkersWidgetsHelper.WIDGET_MAP_MARKERS;
+import static net.osmand.plus.views.mapwidgets.widgets.CoordinatesWidget.WIDGET_COORDINATES;
+import static net.osmand.plus.views.mapwidgets.widgets.ElevationProfileWidget.WIDGET_ELEVATION_PROFILE;
+import static net.osmand.plus.views.mapwidgets.widgets.LanesWidget.WIDGET_LANES;
+import static net.osmand.plus.views.mapwidgets.widgets.StreetNameWidget.WIDGET_STREET_NAME;
+
+public class MapInfoLayer extends OsmandMapLayer {
 
 	private final RouteLayer routeLayer;
 	private final OsmandSettings settings;
@@ -89,7 +82,6 @@ public class MapInfoLayer extends OsmandMapLayer {
 	private ViewGroup leftWidgetsContainer;
 	private ViewGroup bottomWidgetsContainer;
 
-	private ImageButton expandButton;
 	private View mapRulerLayout;
 	private AlarmWidget alarmControl;
 	private List<RulerWidget> rulerWidgets;
@@ -126,7 +118,6 @@ public void setMapActivity(@Nullable MapActivity mapActivity) {
 			leftWidgetsContainer = mapActivity.findViewById(R.id.map_left_widgets_panel);
 			rightWidgetsContainer = mapActivity.findViewById(R.id.map_right_widgets_panel);
 			bottomWidgetsContainer = mapActivity.findViewById(R.id.map_bottom_widgets_panel);
-			expandButton = mapActivity.findViewById(R.id.map_collapse_button);
 			mapRulerLayout = mapActivity.findViewById(R.id.map_ruler_layout);
 
 			appModeChangeListener = createAppModeChangeListener();
@@ -146,7 +137,6 @@ public void setMapActivity(@Nullable MapActivity mapActivity) {
 			topWidgetsContainer = null;
 			leftWidgetsContainer = null;
 			rightWidgetsContainer = null;
-			expandButton = null;
 			mapRulerLayout = null;
 
 			alarmControl = null;
@@ -367,36 +357,18 @@ public void recreateControls() {
 		recreateWidgetsPanel(leftWidgetsContainer, WidgetsPanel.LEFT, appMode);
 		recreateWidgetsPanel(rightWidgetsContainer, WidgetsPanel.RIGHT, appMode);
 		recreateWidgetsPanel(bottomWidgetsContainer, WidgetsPanel.BOTTOM, appMode);
-		setupExpandButton();
 	}
 
 	private void recreateWidgetsPanel(@Nullable ViewGroup container, @NonNull WidgetsPanel panel, @NonNull ApplicationMode appMode) {
 		if (container != null) {
 			container.removeAllViews();
 			if (mapInfoControls != null) {
-				mapInfoControls.populateControlsContainer(container, appMode, panel, WIDGETS_EXPANDED);
+				mapInfoControls.populateControlsContainer(container, appMode, panel);
 			}
 			container.requestLayout();
 		}
 	}
 
-	private void setupExpandButton() {
-		if (expandButton != null) {
-			AndroidUiHelper.updateVisibility(expandButton, mapInfoControls.hasCollapsibles(settings.getApplicationMode()));
-			UiUtilities uiUtilities = getApplication().getUIUtilities();
-			int iconId = WIDGETS_EXPANDED ? R.drawable.ic_action_arrow_up : R.drawable.ic_action_arrow_down;
-			int colorId = ColorUtilities.getMapButtonIconColorId(false);
-			Drawable expandIcon = uiUtilities.getIcon(iconId, colorId);
-			setMapButtonIcon(expandButton, expandIcon);
-			int contentDescrId = WIDGETS_EXPANDED ? R.string.shared_string_collapse : R.string.access_widget_expand;
-			expandButton.setContentDescription(getString(contentDescrId));
-			expandButton.setOnClickListener(v -> {
-				WIDGETS_EXPANDED = !WIDGETS_EXPANDED;
-				recreateControls();
-			});
-		}
-	}
-
 	public RulerWidget setupRulerWidget(View mapRulerView) {
 		MapActivity mapActivity = getMapActivity();
 		if (mapActivity != null) {
@@ -457,9 +429,6 @@ public void updateColorShadowsOfText() {
 			}
 			updateTopToolbar(nightMode);
 
-			expandButton.setBackgroundResource(ts.expand);
-			int padding = expandButton.getPaddingLeft();
-			expandButton.setPadding(padding, padding, padding, padding);
 			topWidgetsContainer.invalidate();
 			rightWidgetsContainer.invalidate();
 			leftWidgetsContainer.invalidate();
@@ -521,7 +490,7 @@ public void onDraw(Canvas canvas, RotatedTileBox tileBox, DrawSettings drawSetti
 			updateColorShadowsOfText();
 			if (mapInfoControls != null) {
 				ApplicationMode appMode = settings.getApplicationMode();
-				mapInfoControls.updateWidgetsInfo(appMode, drawSettings, WIDGETS_EXPANDED);
+				mapInfoControls.updateWidgetsInfo(appMode, drawSettings);
 			}
 			topToolbarView.updateInfo();
 			alarmControl.updateInfo(drawSettings, false);
diff --git a/OsmAnd/src/net/osmand/plus/views/layers/MapQuickActionLayer.java b/OsmAnd/src/net/osmand/plus/views/layers/MapQuickActionLayer.java
index 8c5d5b7001a..628ac055821 100644
--- a/OsmAnd/src/net/osmand/plus/views/layers/MapQuickActionLayer.java
+++ b/OsmAnd/src/net/osmand/plus/views/layers/MapQuickActionLayer.java
@@ -17,19 +17,11 @@
 import android.widget.ImageButton;
 import android.widget.ImageView;
 
-import androidx.annotation.DimenRes;
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.appcompat.content.res.AppCompatResources;
-import androidx.core.util.Pair;
-
 import com.getkeepsafe.taptargetview.TapTarget;
 import com.getkeepsafe.taptargetview.TapTargetView;
 
-import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.data.LatLon;
 import net.osmand.data.RotatedTileBox;
-import net.osmand.plus.utils.ColorUtilities;
 import net.osmand.plus.OsmAndLocationProvider;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
@@ -42,12 +34,20 @@
 import net.osmand.plus.quickaction.QuickActionRegistry.QuickActionUpdatesListener;
 import net.osmand.plus.quickaction.QuickActionsWidget;
 import net.osmand.plus.settings.backend.OsmandSettings;
+import net.osmand.plus.utils.AndroidUtils;
+import net.osmand.plus.utils.ColorUtilities;
 import net.osmand.plus.views.OsmandMapTileView;
 import net.osmand.plus.views.layers.base.OsmandMapLayer;
 
 import java.util.ArrayList;
 import java.util.List;
 
+import androidx.annotation.DimenRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.appcompat.content.res.AppCompatResources;
+import androidx.core.util.Pair;
+
 import static net.osmand.plus.views.layers.ContextMenuLayer.VIBRATE_SHORT;
 
 /**
@@ -65,7 +65,6 @@ public class MapQuickActionLayer extends OsmandMapLayer implements QuickActionUp
     private QuickActionsWidget quickActionsWidget;
 
     private OsmandMapTileView view;
-    private boolean wasCollapseButtonVisible;
     private int previousMapPosition;
 
     private boolean inMovingMarkerMode;
@@ -352,14 +351,6 @@ private void enterMovingMode(RotatedTileBox tileBox) {
         AndroidUiHelper.setVisibility(mapActivity, View.INVISIBLE, R.id.map_ruler_layout,
                 R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
 
-        View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-        if (collapseButton != null && collapseButton.getVisibility() == View.VISIBLE) {
-            wasCollapseButtonVisible = true;
-            collapseButton.setVisibility(View.INVISIBLE);
-        } else {
-            wasCollapseButtonVisible = false;
-        }
-
         view.refreshMap();
     }
 
@@ -393,10 +384,6 @@ private void quitMovingMarker() {
         AndroidUiHelper.setVisibility(mapActivity, View.VISIBLE, R.id.map_ruler_layout,
                 R.id.map_left_widgets_panel, R.id.map_right_widgets_panel, R.id.map_center_info);
 
-        View collapseButton = mapActivity.findViewById(R.id.map_collapse_button);
-        if (collapseButton != null && wasCollapseButtonVisible) {
-            collapseButton.setVisibility(View.VISIBLE);
-        }
         view.refreshMap();
     }
 
diff --git a/OsmAnd/src/net/osmand/plus/views/layers/RadiusRulerControlLayer.java b/OsmAnd/src/net/osmand/plus/views/layers/RadiusRulerControlLayer.java
index b980030258c..7f57036bc00 100644
--- a/OsmAnd/src/net/osmand/plus/views/layers/RadiusRulerControlLayer.java
+++ b/OsmAnd/src/net/osmand/plus/views/layers/RadiusRulerControlLayer.java
@@ -15,27 +15,30 @@
 import android.graphics.Typeface;
 import android.view.View;
 
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.core.content.ContextCompat;
-
-import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.data.LatLon;
 import net.osmand.data.QuadPoint;
 import net.osmand.data.RotatedTileBox;
-import net.osmand.plus.utils.OsmAndFormatter;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
 import net.osmand.plus.activities.MapActivity;
 import net.osmand.plus.settings.enums.AngularConstants;
 import net.osmand.plus.settings.enums.MetricsConstants;
+import net.osmand.plus.utils.AndroidUtils;
+import net.osmand.plus.utils.OsmAndFormatter;
 import net.osmand.plus.views.OsmandMapTileView;
 import net.osmand.plus.views.layers.base.OsmandMapLayer;
+import net.osmand.plus.views.mapwidgets.MapWidgetRegistry;
 import net.osmand.util.MapUtils;
 
 import java.util.ArrayList;
 import java.util.List;
 
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.core.content.ContextCompat;
+
+import static net.osmand.plus.views.mapwidgets.MapWidgetRegistry.WIDGET_RADIUS_RULER;
+
 public class RadiusRulerControlLayer extends OsmandMapLayer {
 
 	private static final int TEXT_SIZE = 14;
@@ -180,7 +183,8 @@ public void onDraw(Canvas canvas, RotatedTileBox tb, DrawSettings settings) {
 	}
 
 	public boolean rulerModeOn() {
-		return getApplication().getOsmandMap().getMapLayers().getMapWidgetRegistry().isVisible("ruler")
+		MapWidgetRegistry mapWidgetRegistry = getApplication().getOsmandMap().getMapLayers().getMapWidgetRegistry();
+		return mapWidgetRegistry.isWidgetVisible(WIDGET_RADIUS_RULER)
 				&& (rightWidgetsPanel == null || rightWidgetsPanel.getVisibility() == View.VISIBLE);
 	}
 
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/CenterWidgetInfo.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/CenterWidgetInfo.java
index 077c87ed412..0dd6f593720 100644
--- a/OsmAnd/src/net/osmand/plus/views/mapwidgets/CenterWidgetInfo.java
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/CenterWidgetInfo.java
@@ -1,14 +1,14 @@
 package net.osmand.plus.views.mapwidgets;
 
+import net.osmand.plus.settings.backend.ApplicationMode;
+import net.osmand.plus.views.mapwidgets.widgets.MapWidget;
+import net.osmand.plus.views.mapwidgets.widgetstates.WidgetState;
+
 import androidx.annotation.DrawableRes;
 import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 import androidx.annotation.StringRes;
 
-import net.osmand.plus.settings.backend.ApplicationMode;
-import net.osmand.plus.views.mapwidgets.widgets.MapWidget;
-import net.osmand.plus.views.mapwidgets.widgetstates.WidgetState;
-
 public class CenterWidgetInfo extends MapWidgetInfo {
 
 	public CenterWidgetInfo(@NonNull String key,
@@ -23,28 +23,11 @@ public CenterWidgetInfo(@NonNull String key,
 	}
 
 	@Override
-	public boolean isVisibleCollapsed(@NonNull ApplicationMode appMode) {
-		return false;
-	}
-
-	@Override
-	public boolean isVisible(@NonNull ApplicationMode appMode) {
+	public boolean isVisibleForAppMode(@NonNull ApplicationMode appMode) {
 		return true;
 	}
 
 	@Override
-	public void addVisible(@NonNull ApplicationMode appMode) {
-	}
-
-	@Override
-	public void addVisibleCollapsible(@NonNull ApplicationMode appMode) {
-	}
-
-	@Override
-	public void removeVisible(@NonNull ApplicationMode appMode) {
-	}
-
-	@Override
-	public void removeVisibleCollapsible(@NonNull ApplicationMode appMode) {
+	public void showHideForAppMode(@NonNull ApplicationMode appMode, boolean show) {
 	}
 }
\ No newline at end of file
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetInfo.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetInfo.java
index 254c7512149..74fdfc584f3 100644
--- a/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetInfo.java
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetInfo.java
@@ -2,17 +2,17 @@
 
 import android.content.Context;
 
-import androidx.annotation.DrawableRes;
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.annotation.StringRes;
-
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.settings.backend.preferences.OsmandPreference;
 import net.osmand.plus.views.mapwidgets.widgets.MapWidget;
 import net.osmand.plus.views.mapwidgets.widgets.TextInfoWidget;
 import net.osmand.plus.views.mapwidgets.widgetstates.WidgetState;
 
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.annotation.StringRes;
+
 public abstract class MapWidgetInfo implements Comparable<MapWidgetInfo> {
 
 	public static final int INVALID_ID = 0;
@@ -86,25 +86,13 @@ public int getMessageId() {
 	}
 
 	public boolean isSelected(@NonNull ApplicationMode appMode) {
-		OsmandPreference<Boolean> pref = widget.getWidgetVisibilityPref();
-		if (pref != null) {
-			return pref.getModeValue(appMode);
-		} else {
-			return isVisibleCollapsed(appMode) || isVisible(appMode);
-		}
+		OsmandPreference<Boolean> visibilityPref = widget.getWidgetVisibilityPref();
+		return visibilityPref != null ? visibilityPref.getModeValue(appMode) : isVisibleForAppMode(appMode);
 	}
 
-	public abstract boolean isVisibleCollapsed(@NonNull ApplicationMode appMode);
-
-	public abstract boolean isVisible(@NonNull ApplicationMode appMode);
-
-	public abstract void addVisible(@NonNull ApplicationMode appMode);
-
-	public abstract void addVisibleCollapsible(@NonNull ApplicationMode appMode);
-
-	public abstract void removeVisible(@NonNull ApplicationMode appMode);
+	public abstract boolean isVisibleForAppMode(@NonNull ApplicationMode appMode);
 
-	public abstract void removeVisibleCollapsible(@NonNull ApplicationMode appMode);
+	public abstract void showHideForAppMode(@NonNull ApplicationMode appMode, boolean show);
 
 	@Override
 	public int hashCode() {
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java
index 2f2930102f8..2c765bb84f9 100644
--- a/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/MapWidgetRegistry.java
@@ -2,15 +2,8 @@
 
 import android.graphics.drawable.Drawable;
 import android.view.View;
-import android.view.View.OnClickListener;
 import android.view.ViewGroup;
 
-import androidx.annotation.ColorRes;
-import androidx.annotation.DrawableRes;
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.annotation.StringRes;
-
 import net.osmand.CallbackWithObject;
 import net.osmand.StateChangedListener;
 import net.osmand.plus.OsmandApplication;
@@ -33,6 +26,7 @@
 import net.osmand.plus.widgets.popup.PopUpMenuHelper;
 import net.osmand.plus.widgets.popup.PopUpMenuHelper.PopUpMenuWidthType;
 import net.osmand.plus.widgets.popup.PopUpMenuItem;
+import net.osmand.util.Algorithms;
 
 import java.util.ArrayList;
 import java.util.Collections;
@@ -45,11 +39,16 @@
 import java.util.Set;
 import java.util.TreeSet;
 
+import androidx.annotation.ColorRes;
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.annotation.StringRes;
+
 public class MapWidgetRegistry {
 
 	public static final String COLLAPSED_PREFIX = "+";
 	public static final String HIDE_PREFIX = "-";
-	public static final String SHOW_PREFIX = "";
 	public static final String SETTINGS_SEPARATOR = ";";
 
 	public static final String WIDGET_COMPASS = "compass";
@@ -77,7 +76,7 @@ public class MapWidgetRegistry {
 	private final OsmandSettings settings;
 
 	private final Map<WidgetsPanel, Set<MapWidgetInfo>> allWidgets = new HashMap<>();
-	private final Map<ApplicationMode, Set<String>> visibleSideWidgetsFromSettings = new LinkedHashMap<>();
+	private final Map<ApplicationMode, Set<String>> sideWidgetsVisibilityFromSettings = new LinkedHashMap<>();
 
 	private final StateChangedListener<String> listener;
 
@@ -90,23 +89,17 @@ public MapWidgetRegistry(OsmandApplication app) {
 		settings.MAP_INFO_CONTROLS.addListener(listener);
 	}
 
-	public void populateControlsContainer(@NonNull ViewGroup container, @NonNull ApplicationMode mode,
-	                                      @NonNull WidgetsPanel widgetPanel, boolean expanded) {
+	public void populateControlsContainer(@NonNull ViewGroup container,
+	                                      @NonNull ApplicationMode mode,
+	                                      @NonNull WidgetsPanel widgetPanel) {
 		Set<MapWidgetInfo> widgets = getWidgetsForPanel(widgetPanel);
 
 		List<MapWidget> widgetsToShow = new ArrayList<>();
 		for (MapWidgetInfo widgetInfo : widgets) {
-			if (widgetInfo.isVisible(mode)) {
+			if (widgetInfo.isVisibleForAppMode(mode)) {
 				widgetsToShow.add(widgetInfo.widget);
 			}
 		}
-		if (expanded) {
-			for (MapWidgetInfo widgetInfo : widgets) {
-				if (widgetInfo.isVisibleCollapsed(mode)) {
-					widgetsToShow.add(widgetInfo.widget);
-				}
-			}
-		}
 
 		for (int i = 0; i < widgetsToShow.size(); i++) {
 			MapWidget widget = widgetsToShow.get(i);
@@ -117,32 +110,18 @@ public void populateControlsContainer(@NonNull ViewGroup container, @NonNull App
 		}
 	}
 
-	public boolean hasCollapsibles(ApplicationMode mode) {
-		for (MapWidgetInfo r : getLeftWidgets()) {
-			if (r.isVisibleCollapsed(mode)) {
-				return true;
-			}
-		}
-		for (MapWidgetInfo r : getRightWidgets()) {
-			if (r.isVisibleCollapsed(mode)) {
-				return true;
-			}
-		}
-		return false;
-	}
-
-	public void updateWidgetsInfo(@NonNull ApplicationMode appMode, @NonNull DrawSettings drawSettings,
-	                              boolean expanded) {
+	public void updateWidgetsInfo(@NonNull ApplicationMode appMode, @NonNull DrawSettings drawSettings) {
 		for (WidgetsPanel panel : WidgetsPanel.values()) {
 			Set<MapWidgetInfo> panelWidgets = getWidgetsForPanel(panel);
-			updatePanelInfo(panelWidgets, appMode, drawSettings, expanded);
+			updatePanelInfo(panelWidgets, appMode, drawSettings);
 		}
 	}
 
-	private void updatePanelInfo(@NonNull Set<MapWidgetInfo> panelWidgets, @NonNull ApplicationMode mode,
-	                             @NonNull DrawSettings drawSettings, boolean expanded) {
+	private void updatePanelInfo(@NonNull Set<MapWidgetInfo> panelWidgets,
+	                             @NonNull ApplicationMode mode,
+	                             @NonNull DrawSettings drawSettings) {
 		for (MapWidgetInfo widgetInfo : panelWidgets) {
-			if (widgetInfo.isVisible(mode) || (widgetInfo.isVisibleCollapsed(mode) && expanded)) {
+			if (widgetInfo.isVisibleForAppMode(mode)) {
 				widgetInfo.widget.updateInfo(drawSettings);
 			}
 		}
@@ -196,7 +175,7 @@ public MapWidgetInfo registerWidget(@NonNull String key,
 		if (widget instanceof TextInfoWidget) {
 			widgetInfo = new SideWidgetInfo(key, widget, widgetState, settingsIconId, messageId, message,
 					priorityOrder, widgetPanel);
-			processVisibleModes(key, widgetInfo);
+			processVisibleModes(widgetInfo);
 			TextInfoWidget textWidget = ((TextInfoWidget) widget);
 			if (message != null) {
 				textWidget.setContentTitle(message);
@@ -215,55 +194,49 @@ public MapWidgetInfo registerWidget(@NonNull String key,
 		return widgetInfo;
 	}
 
-	private void processVisibleModes(String key, MapWidgetInfo widgetInfo) {
-		for (ApplicationMode ms : ApplicationMode.values(app)) {
-			boolean collapse = ms.isWidgetCollapsible(key);
-			boolean visible = ms.isWidgetVisible(key);
-			Set<String> set = visibleSideWidgetsFromSettings.get(ms);
-			if (set != null) {
-				if (set.contains(key)) {
+	private void processVisibleModes(@NonNull MapWidgetInfo widgetInfo) {
+		String widgetId = widgetInfo.key;
+		for (ApplicationMode appMode : ApplicationMode.values(app)) {
+			boolean visible = appMode.isWidgetVisibleByDefault(widgetId);
+			Set<String> sideWidgetsVisibility = sideWidgetsVisibilityFromSettings.get(appMode);
+			if (sideWidgetsVisibility != null) {
+				if (isWidgetVisible(widgetId, sideWidgetsVisibility)) {
 					visible = true;
-					collapse = false;
-				} else if (set.contains(HIDE_PREFIX + key)) {
+				} else if (sideWidgetsVisibility.contains(HIDE_PREFIX + widgetId)) {
 					visible = false;
-					collapse = false;
-				} else if (set.contains(COLLAPSED_PREFIX + key)) {
-					visible = false;
-					collapse = true;
 				}
 			}
-			if (visible) {
-				widgetInfo.addVisible(ms);
-			} else if (collapse) {
-				widgetInfo.addVisibleCollapsible(ms);
-			} else {
-				widgetInfo.removeVisible(ms);
-				widgetInfo.removeVisibleCollapsible(ms);
-			}
+			widgetInfo.showHideForAppMode(appMode, visible);
 		}
 	}
 
-	private void restoreModes(Set<String> set, Set<MapWidgetInfo> widgetsInfo, ApplicationMode mode) {
+	@NonNull
+	private Set<String> getWidgetsVisibilityForAppMode(@NonNull Set<MapWidgetInfo> widgetsInfo,
+	                                                   @NonNull ApplicationMode mode) {
+		Set<String> widgetsVisibility = new LinkedHashSet<>();
 		for (MapWidgetInfo widgetInfo : widgetsInfo) {
-			if (widgetInfo.isVisible(mode)) {
-				set.add(widgetInfo.key);
-			} else if (widgetInfo.isVisibleCollapsed(mode)) {
-				set.add(COLLAPSED_PREFIX + widgetInfo.key);
+			if (widgetInfo.isVisibleForAppMode(mode)) {
+				widgetsVisibility.add(widgetInfo.key);
 			} else {
-				set.add(HIDE_PREFIX + widgetInfo.key);
+				widgetsVisibility.add(HIDE_PREFIX + widgetInfo.key);
 			}
 		}
+		return widgetsVisibility;
 	}
 
-	public boolean isVisible(String key) {
-		ApplicationMode mode = settings.APPLICATION_MODE.get();
-		Set<String> elements = visibleSideWidgetsFromSettings.get(mode);
-		return elements != null && (elements.contains(key) || elements.contains(COLLAPSED_PREFIX + key));
+	public boolean isWidgetVisible(@NonNull String widgetId) {
+		ApplicationMode appMode = settings.getApplicationMode();
+		Set<String> widgetsVisibility = sideWidgetsVisibilityFromSettings.get(appMode);
+		return widgetsVisibility != null && isWidgetVisible(widgetId, widgetsVisibility);
+	}
+
+	private boolean isWidgetVisible(@NonNull String widgetId, @NonNull Set<String> widgetsVisibility) {
+		return widgetsVisibility.contains(widgetId) || widgetsVisibility.contains(COLLAPSED_PREFIX + widgetId);
 	}
 
-	public void setVisibility(@NonNull MapWidgetInfo widgetInfo, boolean visible, boolean collapsed) {
+	public void setVisibility(@NonNull MapWidgetInfo widgetInfo, boolean visible) {
 		ApplicationMode mode = settings.APPLICATION_MODE.get();
-		setVisibility(mode, widgetInfo, visible, collapsed);
+		setVisibility(mode, widgetInfo, visible);
 
 		OsmandPreference<Boolean> pref = widgetInfo.widget.getWidgetVisibilityPref();
 		if (pref != null) {
@@ -276,92 +249,79 @@ public void setVisibility(@NonNull MapWidgetInfo widgetInfo, boolean visible, bo
 		}
 	}
 
-	public void setVisibility(ApplicationMode mode, MapWidgetInfo m, boolean visible, boolean collapsed) {
-		defineDefaultSettingsElement(mode);
-		// clear everything
-		visibleSideWidgetsFromSettings.get(mode).remove(m.key);
-		visibleSideWidgetsFromSettings.get(mode).remove(COLLAPSED_PREFIX + m.key);
-		visibleSideWidgetsFromSettings.get(mode).remove(HIDE_PREFIX + m.key);
-		m.removeVisible(mode);
-		m.removeVisibleCollapsible(mode);
-		if (visible && collapsed) {
-			// Set "collapsed" state
-			m.addVisibleCollapsible(mode);
-			visibleSideWidgetsFromSettings.get(mode).add(COLLAPSED_PREFIX + m.key);
-		} else if (visible) {
-			// Set "visible" state
-			m.addVisible(mode);
-			visibleSideWidgetsFromSettings.get(mode).add(SHOW_PREFIX + m.key);
+	public void setVisibility(@NonNull ApplicationMode mode, @NonNull MapWidgetInfo widgetInfo, boolean visible) {
+		Set<String> widgetsVisibility = getOrInitWidgetsVisibility(mode);
+		widgetsVisibility.remove(widgetInfo.key);
+		widgetsVisibility.remove(COLLAPSED_PREFIX + widgetInfo.key);
+		widgetsVisibility.remove(HIDE_PREFIX + widgetInfo.key);
+		if (visible) {
+			widgetsVisibility.add(widgetInfo.key);
 		} else {
-			// Set "hidden" state
-			visibleSideWidgetsFromSettings.get(mode).add(HIDE_PREFIX + m.key);
+			widgetsVisibility.add(HIDE_PREFIX + widgetInfo.key);
 		}
-		saveVisibleElementsToSettings(mode);
+		widgetInfo.showHideForAppMode(mode, visible);
+		saveWidgetsVisibilityToSettings(widgetsVisibility);
 	}
 
-	private void defineDefaultSettingsElement(ApplicationMode mode) {
-		if (visibleSideWidgetsFromSettings.get(mode) == null) {
-			LinkedHashSet<String> set = new LinkedHashSet<>();
-			restoreModes(set, getLeftWidgets(), mode);
-			restoreModes(set, getRightWidgets(), mode);
-			visibleSideWidgetsFromSettings.put(mode, set);
-		}
+	@NonNull
+	private Set<String> getOrInitWidgetsVisibility(@NonNull ApplicationMode appMode) {
+		Set<String> widgetsVisibility = sideWidgetsVisibilityFromSettings.get(appMode);
+		if (widgetsVisibility == null) {
+			widgetsVisibility = new LinkedHashSet<>();
+			widgetsVisibility.addAll(getWidgetsVisibilityForAppMode(getLeftWidgets(), appMode));
+			widgetsVisibility.addAll(getWidgetsVisibilityForAppMode(getRightWidgets(), appMode));
+			sideWidgetsVisibilityFromSettings.put(appMode, widgetsVisibility);
+		}
+		return widgetsVisibility;
 	}
 
 	public void updateVisibleSideWidgets() {
 		loadVisibleElementsFromSettings();
-		for (MapWidgetInfo ri : getLeftWidgets()) {
-			processVisibleModes(ri.key, ri);
+		for (MapWidgetInfo widgetInfo : getLeftWidgets()) {
+			processVisibleModes(widgetInfo);
 		}
-		for (MapWidgetInfo ri : getRightWidgets()) {
-			processVisibleModes(ri.key, ri);
+		for (MapWidgetInfo widgetInfo : getRightWidgets()) {
+			processVisibleModes(widgetInfo);
 		}
 	}
 
 	private void loadVisibleElementsFromSettings() {
-		visibleSideWidgetsFromSettings.clear();
-		for (ApplicationMode ms : ApplicationMode.values(app)) {
-			String mpf = settings.MAP_INFO_CONTROLS.getModeValue(ms);
-			if (mpf.equals(SHOW_PREFIX)) {
-				visibleSideWidgetsFromSettings.put(ms, null);
+		sideWidgetsVisibilityFromSettings.clear();
+		for (ApplicationMode appMode : ApplicationMode.values(app)) {
+			String widgetsVisibilityString = settings.MAP_INFO_CONTROLS.getModeValue(appMode);
+			boolean useDefaultVisibility = Algorithms.isEmpty(widgetsVisibilityString);
+			if (useDefaultVisibility) {
+				sideWidgetsVisibilityFromSettings.put(appMode, null);
 			} else {
-				LinkedHashSet<String> set = new LinkedHashSet<>();
-				visibleSideWidgetsFromSettings.put(ms, set);
-				Collections.addAll(set, mpf.split(SETTINGS_SEPARATOR));
+				Set<String> widgetsVisibility = new LinkedHashSet<>();
+				Collections.addAll(widgetsVisibility, widgetsVisibilityString.split(SETTINGS_SEPARATOR));
+				sideWidgetsVisibilityFromSettings.put(appMode, widgetsVisibility);
 			}
 		}
 	}
 
-	private void saveVisibleElementsToSettings(ApplicationMode mode) {
-		StringBuilder bs = new StringBuilder();
-		for (String ks : visibleSideWidgetsFromSettings.get(mode)) {
-			bs.append(ks).append(SETTINGS_SEPARATOR);
-		}
-		settings.MAP_INFO_CONTROLS.set(bs.toString());
-	}
-
-
-	private void resetDefault(ApplicationMode mode, Set<MapWidgetInfo> set) {
-		for (MapWidgetInfo ri : set) {
-			ri.removeVisibleCollapsible(mode);
-			ri.removeVisible(mode);
-			if (mode.isWidgetVisible(ri.key)) {
-				if (mode.isWidgetCollapsible(ri.key)) {
-					ri.addVisibleCollapsible(mode);
-				} else {
-					ri.addVisible(mode);
-				}
-			}
+	private void saveWidgetsVisibilityToSettings(@NonNull Set<String> widgetsVisibility) {
+		StringBuilder widgetsVisibilityString = new StringBuilder();
+		for (String widgetVisibility : widgetsVisibility) {
+			widgetsVisibilityString.append(widgetVisibility).append(SETTINGS_SEPARATOR);
 		}
+		settings.MAP_INFO_CONTROLS.set(widgetsVisibilityString.toString());
 	}
 
 	public void resetToDefault() {
 		ApplicationMode appMode = settings.getApplicationMode();
-		resetDefault(appMode, getLeftWidgets());
-		resetDefault(appMode, getRightWidgets());
+		resetWidgetsVisibility(appMode, getLeftWidgets());
+		resetWidgetsVisibility(appMode, getRightWidgets());
 		resetDefaultAppearance(appMode);
-		visibleSideWidgetsFromSettings.put(appMode, null);
-		settings.MAP_INFO_CONTROLS.set(SHOW_PREFIX);
+		sideWidgetsVisibilityFromSettings.put(appMode, null);
+		settings.MAP_INFO_CONTROLS.set("");
+	}
+
+	private void resetWidgetsVisibility(@NonNull ApplicationMode mode, @NonNull Set<MapWidgetInfo> widgets) {
+		for (MapWidgetInfo widgetInfo : widgets) {
+			boolean visibleByDefault = mode.isWidgetVisibleByDefault(widgetInfo.key);
+			widgetInfo.showHideForAppMode(mode, visibleByDefault);
+		}
 	}
 
 	private void resetDefaultAppearance(ApplicationMode mode) {
@@ -382,15 +342,18 @@ public void reorderWidgets() {
 		}
 	}
 
-	public void updateMapMarkersMode(MapActivity mapActivity) {
-		for (MapWidgetInfo info : getRightWidgets()) {
-			if (WIDGET_MARKER_1.equals(info.key)) {
-				setVisibility(info, settings.MAP_MARKERS_MODE.get().isWidgets()
-						&& settings.MARKERS_DISTANCE_INDICATION_ENABLED.get(), false);
-			} else if (WIDGET_MARKER_2.equals(info.key)) {
-				setVisibility(info, settings.MAP_MARKERS_MODE.get().isWidgets()
-						&& settings.MARKERS_DISTANCE_INDICATION_ENABLED.get()
-						&& settings.DISPLAYED_MARKERS_WIDGETS_COUNT.get() == 2, false);
+	public void updateMarkerSideWidgetsVisibility(@NonNull MapActivity mapActivity) {
+		boolean markersWidgetEnabled = settings.MARKERS_DISTANCE_INDICATION_ENABLED.get();
+		boolean sideMarkerWidgetEnabled = settings.MAP_MARKERS_MODE.get().isWidgets();
+		boolean showFirstMarkerSideWidget = markersWidgetEnabled && sideMarkerWidgetEnabled;
+		boolean showSecondMarkerSideWidget = showFirstMarkerSideWidget
+				&& settings.DISPLAYED_MARKERS_WIDGETS_COUNT.get() == 2;
+
+		for (MapWidgetInfo widgetInfo : getRightWidgets()) {
+			if (WIDGET_MARKER_1.equals(widgetInfo.key)) {
+				setVisibility(widgetInfo, showFirstMarkerSideWidget);
+			} else if (WIDGET_MARKER_2.equals(widgetInfo.key)) {
+				setVisibility(widgetInfo, showSecondMarkerSideWidget);
 			}
 		}
 		mapActivity.refreshMap();
@@ -442,9 +405,6 @@ public void showPopUpMenu(@NonNull View view,
 	                          @NonNull final CallbackWithObject<WidgetState> callback,
 	                          @Nullable final WidgetState widgetState,
 	                          @NonNull ApplicationMode mode,
-	                          @Nullable OnClickListener showBtnListener,
-	                          @Nullable OnClickListener hideBtnListener,
-	                          @Nullable OnClickListener collapseBtnListener,
 	                          boolean selected,
 	                          boolean nightMode) {
 		final int currentModeColor = mode.getProfileColor(nightMode);
@@ -483,28 +443,6 @@ public void showPopUpMenu(@NonNull View view,
 				}
 			}
 		}
-		if (showBtnListener != null) {
-			items.add(new PopUpMenuItem.Builder(app)
-					.setTitleId(R.string.shared_string_show)
-					.setIcon(uiUtilities.getThemedIcon(R.drawable.ic_action_view))
-					.setOnClickListener(showBtnListener)
-					.showTopDivider(items.size() > 0)
-					.create());
-		}
-		if (hideBtnListener != null) {
-			items.add(new PopUpMenuItem.Builder(app)
-					.setTitleId(R.string.shared_string_hide)
-					.setIcon(uiUtilities.getThemedIcon(R.drawable.ic_action_hide))
-					.setOnClickListener(hideBtnListener)
-					.create());
-		}
-		if (collapseBtnListener != null) {
-			items.add(new PopUpMenuItem.Builder(app)
-					.setTitleId(R.string.shared_string_collapse)
-					.setIcon(uiUtilities.getThemedIcon(R.drawable.ic_action_widget_collapse))
-					.setOnClickListener(collapseBtnListener)
-					.create());
-		}
 
 		new PopUpMenuHelper.Builder(parentView, items, nightMode)
 				.setWidthType(PopUpMenuWidthType.STANDARD)
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/SideWidgetInfo.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/SideWidgetInfo.java
index 97ecbfa4037..ae8a5e88ae6 100644
--- a/OsmAnd/src/net/osmand/plus/views/mapwidgets/SideWidgetInfo.java
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/SideWidgetInfo.java
@@ -1,10 +1,5 @@
 package net.osmand.plus.views.mapwidgets;
 
-import androidx.annotation.DrawableRes;
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.annotation.StringRes;
-
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.views.mapwidgets.widgets.MapWidget;
 import net.osmand.plus.views.mapwidgets.widgetstates.WidgetState;
@@ -12,10 +7,14 @@
 import java.util.LinkedHashSet;
 import java.util.Set;
 
+import androidx.annotation.DrawableRes;
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.annotation.StringRes;
+
 public class SideWidgetInfo extends MapWidgetInfo {
 
-	private final Set<ApplicationMode> visibleCollapsible = new LinkedHashSet<>();
-	private final Set<ApplicationMode> visible = new LinkedHashSet<>();
+	private final Set<ApplicationMode> visibilityForAppModes = new LinkedHashSet<>();
 
 	public SideWidgetInfo(@NonNull String key,
 	                      @NonNull MapWidget widget,
@@ -29,32 +28,16 @@ public SideWidgetInfo(@NonNull String key,
 	}
 
 	@Override
-	public boolean isVisible(@NonNull ApplicationMode appMode) {
-		return visible.contains(appMode);
-	}
-
-	@Override
-	public boolean isVisibleCollapsed(@NonNull ApplicationMode appMode) {
-		return visibleCollapsible.contains(appMode);
-	}
-
-	@Override
-	public void addVisible(@NonNull ApplicationMode appMode) {
-		visible.add(appMode);
-	}
-
-	@Override
-	public void addVisibleCollapsible(@NonNull ApplicationMode appMode) {
-		visibleCollapsible.add(appMode);
-	}
-
-	@Override
-	public void removeVisible(@NonNull ApplicationMode appMode) {
-		visible.remove(appMode);
+	public boolean isVisibleForAppMode(@NonNull ApplicationMode appMode) {
+		return visibilityForAppModes.contains(appMode);
 	}
 
 	@Override
-	public void removeVisibleCollapsible(@NonNull ApplicationMode appMode) {
-		visibleCollapsible.remove(appMode);
+	public void showHideForAppMode(@NonNull ApplicationMode appMode, boolean show) {
+		if (show) {
+			visibilityForAppModes.add(appMode);
+		} else {
+			visibilityForAppModes.remove(appMode);
+		}
 	}
 }
\ No newline at end of file
diff --git a/OsmAnd/src/net/osmand/plus/views/mapwidgets/configure/panel/WidgetsListFragment.java b/OsmAnd/src/net/osmand/plus/views/mapwidgets/configure/panel/WidgetsListFragment.java
index 464536ff92a..4daadb0f4b8 100644
--- a/OsmAnd/src/net/osmand/plus/views/mapwidgets/configure/panel/WidgetsListFragment.java
+++ b/OsmAnd/src/net/osmand/plus/views/mapwidgets/configure/panel/WidgetsListFragment.java
@@ -154,7 +154,7 @@ public void updateContent() {
 
 				boolean checked = compoundButton.isChecked();
 				WidgetViewHolder.updateWidgetIcon(imageView, widgetInfo, profileColor, defaultIconColor, checked, nightMode);
-				widgetRegistry.setVisibility(widgetInfo, checked, false);
+				widgetRegistry.setVisibility(widgetInfo, checked);
 			});
 
 			view.setOnClickListener(v -> {
@@ -162,14 +162,14 @@ public void updateContent() {
 					boolean checked = !compoundButton.isChecked();
 					compoundButton.setChecked(checked);
 					WidgetViewHolder.updateWidgetIcon(imageView, widgetInfo, profileColor, defaultIconColor, checked, nightMode);
-					widgetRegistry.setVisibility(widgetInfo, checked, false);
+					widgetRegistry.setVisibility(widgetInfo, checked);
 				} else {
 					CallbackWithObject<WidgetState> callback = result -> {
 						updateContent();
 						return true;
 					};
 					widgetRegistry.showPopUpMenu(view, callback, widgetInfo.getWidgetState(), selectedAppMode,
-							null, null, null, compoundButton.isChecked(), nightMode);
+							compoundButton.isChecked(), nightMode);
 				}
 			});
 			setupListItemBackground(view);
