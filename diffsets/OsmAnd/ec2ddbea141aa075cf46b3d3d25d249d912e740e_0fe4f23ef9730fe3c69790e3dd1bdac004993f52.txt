diff --git a/OsmAnd/src/net/osmand/plus/activities/MapActivityActions.java b/OsmAnd/src/net/osmand/plus/activities/MapActivityActions.java
index ed04951063a..dfdae7d09b8 100644
--- a/OsmAnd/src/net/osmand/plus/activities/MapActivityActions.java
+++ b/OsmAnd/src/net/osmand/plus/activities/MapActivityActions.java
@@ -713,7 +713,7 @@ public void openIntermediatePointsDialog() {
 		MapActivity activity = getMapActivity();
 		if (activity != null) {
 			activity.hideContextAndRouteInfoMenues();
-			WaypointsFragment.showInstance(activity.getSupportFragmentManager());
+			WaypointsFragment.showInstance(activity);
 		}
 	}
 
diff --git a/OsmAnd/src/net/osmand/plus/helpers/TargetPointsHelper.java b/OsmAnd/src/net/osmand/plus/helpers/TargetPointsHelper.java
index b2fa704cc58..6911d27b5f2 100644
--- a/OsmAnd/src/net/osmand/plus/helpers/TargetPointsHelper.java
+++ b/OsmAnd/src/net/osmand/plus/helpers/TargetPointsHelper.java
@@ -570,7 +570,7 @@ public void reorderAllTargetPoints(List<TargetPoint> point, boolean updateRoute)
 		cancelTargetPointAddressRequest();
 		cancelAllIntermediatePointsAddressRequests();
 		settings.clearPointToNavigate();
-		if (point.size() > 0) {
+		if (!point.isEmpty()) {
 			List<TargetPoint> subList = point.subList(0, point.size() - 1);
 			ArrayList<String> names = new ArrayList<>(subList.size());
 			ArrayList<LatLon> ls = new ArrayList<>(subList.size());
@@ -590,7 +590,7 @@ public void reorderAllTargetPoints(List<TargetPoint> point, boolean updateRoute)
 
 	public void reorderIntermediatePoints(List<TargetPoint> points, boolean updateRoute) {
 		cancelAllIntermediatePointsAddressRequests();
-		if (points.size() > 0) {
+		if (!points.isEmpty()) {
 			ArrayList<String> names = new ArrayList<>(points.size());
 			ArrayList<LatLon> ls = new ArrayList<>(points.size());
 			for (int i = 0; i < points.size(); i++) {
diff --git a/OsmAnd/src/net/osmand/plus/helpers/WaypointDialogHelper.java b/OsmAnd/src/net/osmand/plus/helpers/WaypointDialogHelper.java
index dc028382fb6..a59f6cd44ee 100644
--- a/OsmAnd/src/net/osmand/plus/helpers/WaypointDialogHelper.java
+++ b/OsmAnd/src/net/osmand/plus/helpers/WaypointDialogHelper.java
@@ -10,6 +10,7 @@
 import android.widget.ImageView;
 import android.widget.TextView;
 
+import androidx.annotation.NonNull;
 import androidx.annotation.Nullable;
 
 import net.osmand.plus.utils.AndroidUtils;
@@ -40,9 +41,6 @@
 import java.util.Collections;
 import java.util.List;
 
-/**
- *
- */
 public class WaypointDialogHelper {
 
 	private final OsmandApplication app;
@@ -65,9 +63,9 @@ public void removeHelperCallback(WaypointDialogHelperCallback callback) {
 	}
 
 	public WaypointDialogHelper(MapActivity mapActivity) {
+		this.mapActivity = mapActivity;
 		this.app = mapActivity.getMyApplication();
 		waypointHelper = this.app.getWaypointHelper();
-		this.mapActivity = mapActivity;
 	}
 
 	public static void updatePointInfoView(OsmandApplication app, Activity activity,
@@ -82,12 +80,7 @@ public static void updatePointInfoView(OsmandApplication app, Activity activity,
 		}
 		TextView textShadow = localView.findViewById(R.id.waypoint_text_shadow);
 		if (!edit) {
-			localView.setOnClickListener(new View.OnClickListener() {
-				@Override
-				public void onClick(View view) {
-					showOnMap(app, activity, point, mapCenter);
-				}
-			});
+			localView.setOnClickListener(view -> showOnMap(app, activity, point, mapCenter));
 		}
 		TextView textDist = localView.findViewById(R.id.waypoint_dist);
 		((ImageView) localView.findViewById(R.id.waypoint_icon)).setImageDrawable(ps.getDrawable(activity, app, nightMode));
@@ -180,6 +173,7 @@ public void onClick(View view) {
 		}
 	}
 
+	@NonNull
 	public List<Object> getTargetPoints() {
 		List<Object> points = new ArrayList<>();
 		for (int i = 0; i < WaypointHelper.MAX; i++) {
@@ -200,7 +194,7 @@ public List<Object> getTargetPoints() {
 								new PointDescription(PointDescription.POINT_TYPE_MY_LOCATION,
 										mapActivity.getString(R.string.shared_string_my_location)));
 					} else {
-						String oname = start.getOnlyName().length() > 0 ? start.getOnlyName()
+						String oname = !start.getOnlyName().isEmpty() ? start.getOnlyName()
 								: (mapActivity.getString(R.string.route_descr_map_location)
 								+ " " + mapActivity.getString(R.string.route_descr_lat_lon, start.getLatitude(), start.getLongitude()));
 
@@ -211,7 +205,7 @@ public List<Object> getTargetPoints() {
 					points.add(new LocationPointWrapper(WaypointHelper.TARGETS, start, 0f, 0));
 
 				}
-				if (tp != null && tp.size() > 0) {
+				if (tp != null && !tp.isEmpty()) {
 					points.addAll(tp);
 				}
 			}
@@ -219,11 +213,11 @@ public List<Object> getTargetPoints() {
 		return points;
 	}
 
+	@NonNull
 	public List<Object> getActivePoints(List<Object> points) {
 		List<Object> activePoints = new ArrayList<>();
 		for (Object p : points) {
-			if (p instanceof LocationPointWrapper) {
-				LocationPointWrapper w = (LocationPointWrapper) p;
+			if (p instanceof LocationPointWrapper w) {
 				if (w.type == WaypointHelper.TARGETS) {
 					activePoints.add(p);
 				}
@@ -303,16 +297,14 @@ public static void replaceStartWithFirstIntermediate(TargetPointsHelper targetPo
 	}
 
 	public static void deletePoint(OsmandApplication app, Activity ctx,
-	                               ArrayAdapter adapter,
+	                               ArrayAdapter<Object> adapter,
 	                               WaypointDialogHelper helper,
 	                               Object item,
 	                               List<LocationPointWrapper> deletedPoints,
 	                               boolean needCallback) {
 
-		if (item instanceof LocationPointWrapper && adapter != null) {
-			LocationPointWrapper point = (LocationPointWrapper) item;
-			if (point.type == WaypointHelper.TARGETS && adapter instanceof StableArrayAdapter) {
-				StableArrayAdapter stableAdapter = (StableArrayAdapter) adapter;
+		if (item instanceof LocationPointWrapper point && adapter != null) {
+			if (point.type == WaypointHelper.TARGETS && adapter instanceof StableArrayAdapter stableAdapter) {
 				if (helper != null && !helper.helperCallbacks.isEmpty() && needCallback) {
 					for (WaypointDialogHelperCallback callback : helper.helperCallbacks) {
 						callback.deleteWaypoint(stableAdapter.getPosition(item));
@@ -328,8 +320,7 @@ public static void deletePoint(OsmandApplication app, Activity ctx,
 
 				adapter.setNotifyOnChange(false);
 				adapter.remove(point);
-				if (adapter instanceof StableArrayAdapter) {
-					StableArrayAdapter stableAdapter = (StableArrayAdapter) adapter;
+				if (adapter instanceof StableArrayAdapter stableAdapter) {
 					stableAdapter.getObjects().remove(item);
 					stableAdapter.refreshData();
 				}
@@ -458,19 +449,16 @@ public void createMenuItems(Bundle savedInstanceState) {
 					.setIcon(getContentIcon(R.drawable.ic_action_sort_door_to_door))
 					.setTitle(getString(R.string.intermediate_items_sort_by_distance))
 					.setLayoutId(R.layout.bottom_sheet_item_simple)
-					.setOnClickListener(new View.OnClickListener() {
-						@Override
-						public void onClick(View v) {
-							MapActivity mapActivity = getMapActivity();
-							if (mapActivity != null) {
-								sortAllTargets(
-										mapActivity.getMyApplication(),
-										mapActivity,
-										mapActivity.getDashboard().getWaypointDialogHelper()
-								);
-							}
-							dismiss();
+					.setOnClickListener(v -> {
+						MapActivity mapActivity = getMapActivity();
+						if (mapActivity != null) {
+							sortAllTargets(
+									mapActivity.getMyApplication(),
+									mapActivity,
+									mapActivity.getDashboard().getWaypointDialogHelper()
+							);
 						}
+						dismiss();
 					})
 					.create();
 			items.add(sortDoorToDoorItem);
@@ -479,16 +467,13 @@ public void onClick(View v) {
 					.setIcon(getContentIcon(R.drawable.ic_action_sort_reverse_order))
 					.setTitle(getString(R.string.switch_start_finish))
 					.setLayoutId(R.layout.bottom_sheet_item_simple)
-					.setOnClickListener(new View.OnClickListener() {
-						@Override
-						public void onClick(View v) {
-							MapActivity mapActivity = getMapActivity();
-							if (mapActivity != null) {
-								OsmandApplication app = mapActivity.getMyApplication();
-								switchStartAndFinish(app, mapActivity, mapActivity.getDashboard().getWaypointDialogHelper(), true);
-							}
-							dismiss();
+					.setOnClickListener(v -> {
+						MapActivity mapActivity = getMapActivity();
+						if (mapActivity != null) {
+							OsmandApplication app1 = mapActivity.getMyApplication();
+							switchStartAndFinish(app1, mapActivity, mapActivity.getDashboard().getWaypointDialogHelper(), true);
 						}
+						dismiss();
 					})
 					.create();
 			items.add(reorderStartAndFinishItem);
@@ -498,19 +483,16 @@ public void onClick(View v) {
 						.setIcon(getContentIcon(R.drawable.ic_action_sort_reverse_order))
 						.setTitle(getString(R.string.reverse_all_points))
 						.setLayoutId(R.layout.bottom_sheet_item_simple)
-						.setOnClickListener(new View.OnClickListener() {
-							@Override
-							public void onClick(View v) {
-								MapActivity mapActivity = getMapActivity();
-								if (mapActivity != null) {
-									reverseAllPoints(
-											app,
-											mapActivity,
-											mapActivity.getDashboard().getWaypointDialogHelper()
-									);
-								}
-								dismiss();
+						.setOnClickListener(v -> {
+							MapActivity mapActivity = getMapActivity();
+							if (mapActivity != null) {
+								reverseAllPoints(
+										app,
+										mapActivity,
+										mapActivity.getDashboard().getWaypointDialogHelper()
+								);
 							}
+							dismiss();
 						})
 						.create();
 				items.add(reorderAllItems);
@@ -523,12 +505,7 @@ public void onClick(View v) {
 					.setIcon(getContentIcon(R.drawable.ic_action_plus))
 					.setTitle(getString(R.string.add_intermediate_point))
 					.setLayoutId(R.layout.bottom_sheet_item_simple)
-					.setOnClickListener(new View.OnClickListener() {
-						@Override
-						public void onClick(View v) {
-							onWaypointItemClick();
-						}
-					})
+					.setOnClickListener(v -> onWaypointItemClick())
 					.create();
 			items.add(addWaypointItem[0]);
 
@@ -536,20 +513,17 @@ public void onClick(View v) {
 					.setIcon(getContentIcon(R.drawable.ic_action_clear_all))
 					.setTitle(getString(R.string.clear_all_intermediates))
 					.setLayoutId(R.layout.bottom_sheet_item_simple)
-					.setDisabled(getMyApplication().getTargetPointsHelper().getIntermediatePoints().isEmpty())
-					.setOnClickListener(new View.OnClickListener() {
-						@Override
-						public void onClick(View v) {
-							MapActivity mapActivity = getMapActivity();
-							if (mapActivity != null) {
-								clearAllIntermediatePoints(
-										mapActivity,
-										mapActivity.getMyApplication().getTargetPointsHelper(),
-										mapActivity.getDashboard().getWaypointDialogHelper()
-								);
-							}
-							dismiss();
+					.setDisabled(app.getTargetPointsHelper().getIntermediatePoints().isEmpty())
+					.setOnClickListener(v -> {
+						MapActivity mapActivity = getMapActivity();
+						if (mapActivity != null) {
+							clearAllIntermediatePoints(
+									mapActivity,
+									mapActivity.getMyApplication().getTargetPointsHelper(),
+									mapActivity.getDashboard().getWaypointDialogHelper()
+							);
 						}
+						dismiss();
 					})
 					.create();
 			items.add(clearIntermediatesItem);
diff --git a/OsmAnd/src/net/osmand/plus/routepreparationmenu/MapRouteInfoMenu.java b/OsmAnd/src/net/osmand/plus/routepreparationmenu/MapRouteInfoMenu.java
index bab37856838..2fe93e0255f 100644
--- a/OsmAnd/src/net/osmand/plus/routepreparationmenu/MapRouteInfoMenu.java
+++ b/OsmAnd/src/net/osmand/plus/routepreparationmenu/MapRouteInfoMenu.java
@@ -284,7 +284,7 @@ public boolean onSingleTap(PointF point, RotatedTileBox tileBox) {
 				}
 				choosePointTypeAction(selectedPoint, selectFromMapPointType, name, null);
 				if (selectFromMapWaypoints) {
-					WaypointsFragment.showInstance(mapActivity.getSupportFragmentManager(), true);
+					WaypointsFragment.showInstance(mapActivity, true);
 				} else {
 					show(selectFromMapMenuState);
 				}
@@ -1601,7 +1601,7 @@ private void updateViaView() {
 					AddPointBottomSheetDialog.showInstance(mapActivity12, PointType.TARGET);
 				} else if (mapActivity12.getMyApplication().getTargetPointsHelper().checkPointToNavigateShort()) {
 					hide();
-					WaypointsFragment.showInstance(mapActivity12.getSupportFragmentManager(), true);
+					WaypointsFragment.showInstance(mapActivity12, true);
 				}
 			}
 		});
diff --git a/OsmAnd/src/net/osmand/plus/routepreparationmenu/ShowAlongTheRouteBottomSheet.java b/OsmAnd/src/net/osmand/plus/routepreparationmenu/ShowAlongTheRouteBottomSheet.java
index 62136acc6bf..4a492bb7d4a 100644
--- a/OsmAnd/src/net/osmand/plus/routepreparationmenu/ShowAlongTheRouteBottomSheet.java
+++ b/OsmAnd/src/net/osmand/plus/routepreparationmenu/ShowAlongTheRouteBottomSheet.java
@@ -242,8 +242,7 @@ public View getChildView(int groupPosition, int childPosition,
 				convertView = createItemForRadiusProximity(themedInflater, group.type);
 			} else if (child instanceof InfoItem) {
 				convertView = createInfoItem(themedInflater);
-			} else if (child instanceof PointItem) {
-				PointItem item = (PointItem) child;
+			} else if (child instanceof PointItem item) {
 				convertView = themedInflater.inflate(R.layout.along_the_route_point_item, parent, false);
 				WaypointDialogHelper.updatePointInfoView(app, mapActivity, convertView, item.point, true, nightMode, true, false);
 
diff --git a/OsmAnd/src/net/osmand/plus/routepreparationmenu/WaypointsDialogController.java b/OsmAnd/src/net/osmand/plus/routepreparationmenu/WaypointsDialogController.java
new file mode 100644
index 00000000000..4019a388609
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/routepreparationmenu/WaypointsDialogController.java
@@ -0,0 +1,127 @@
+package net.osmand.plus.routepreparationmenu;
+
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.fragment.app.FragmentActivity;
+
+import net.osmand.OnCompleteCallback;
+import net.osmand.data.LatLon;
+import net.osmand.data.PointDescription;
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.base.dialog.BaseDialogController;
+import net.osmand.plus.base.dialog.DialogManager;
+import net.osmand.plus.helpers.LocationPointWrapper;
+import net.osmand.plus.helpers.TargetPointsHelper;
+import net.osmand.plus.helpers.TargetPointsHelper.TargetPoint;
+
+import java.util.ArrayList;
+import java.util.List;
+
+public class WaypointsDialogController extends BaseDialogController {
+
+	private static final String PROCESS_ID = "manage_route_waypoints";
+
+	private boolean useRouteInfoMenu;
+	private List<Object> initialTargetPoints;
+
+	public WaypointsDialogController(@NonNull OsmandApplication app) {
+		super(app);
+	}
+
+	public void setUseRouteInfoMenu(boolean useRouteInfoMenu) {
+		this.useRouteInfoMenu = useRouteInfoMenu;
+	}
+
+	public boolean isUseRouteInfoMenu() {
+		return useRouteInfoMenu;
+	}
+
+	public void setInitialTargetPoints(@NonNull List<Object> initialTargetPoints) {
+		if (this.initialTargetPoints == null) {
+			this.initialTargetPoints = new ArrayList<>(initialTargetPoints);
+		}
+	}
+
+	public void onClearClicked(@NonNull OnCompleteCallback callback) {
+		app.getTargetPointsHelper().clearAllPoints(true);
+		callback.onComplete();
+	}
+
+	public void onCancelChanges(@NonNull OnCompleteCallback callback) {
+		onApplyChanges(initialTargetPoints, callback);
+	}
+
+	public void onApplyChanges(@Nullable List<Object> items, @NonNull OnCompleteCallback callback) {
+		app.runInUIThread(() -> onApplyChangesImpl(items, callback), 50);
+	}
+
+	private void onApplyChangesImpl(@Nullable List<Object> items, @NonNull OnCompleteCallback callback) {
+		List<TargetPoint> allTargets = new ArrayList<>();
+		TargetPoint start = null;
+		if (items != null) {
+			for (Object obj : items) {
+				if (obj instanceof LocationPointWrapper p) {
+					if (p.getPoint() instanceof TargetPoint t) {
+						if (t.start) {
+							start = t;
+						} else {
+							t.intermediate = true;
+						}
+						allTargets.add(t);
+					}
+				}
+			}
+			if (!allTargets.isEmpty()) {
+				allTargets.get(allTargets.size() - 1).intermediate = false;
+			}
+		}
+		TargetPointsHelper targetPointsHelper = app.getTargetPointsHelper();
+		if (start != null) {
+			int startInd = allTargets.indexOf(start);
+			TargetPoint first = allTargets.remove(0);
+			if (startInd != 0) {
+				start.start = false;
+				start.intermediate = startInd != allTargets.size() - 1;
+				if (targetPointsHelper.getPointToStart() == null) {
+					start.getOriginalPointDescription().setName(PointDescription
+							.getLocationNamePlain(app, start.getLatitude(), start.getLongitude()));
+				}
+				first.start = true;
+				first.intermediate = false;
+				targetPointsHelper.setStartPoint(new LatLon(first.getLatitude(), first.getLongitude()),
+						false, first.getPointDescription(app));
+			}
+		}
+		targetPointsHelper.reorderAllTargetPoints(allTargets, false);
+		targetPointsHelper.updateRouteAndRefresh(true);
+		callback.onComplete();
+	}
+
+	@NonNull
+	@Override
+	public String getProcessId() {
+		return PROCESS_ID;
+	}
+
+	public void onDestroy() {
+		FragmentActivity activity = getActivity();
+		if (activity != null && !activity.isChangingConfigurations()) {
+			dialogManager.unregister(PROCESS_ID);
+		}
+	}
+
+	@Nullable
+	public static WaypointsDialogController getInstance(@NonNull OsmandApplication app) {
+		DialogManager manager = app.getDialogManager();
+		return (WaypointsDialogController) manager.findController(PROCESS_ID);
+	}
+
+	@NonNull
+	public static WaypointsDialogController createInstance(@NonNull OsmandApplication app,
+	                                                       boolean useRouteInfoMenu) {
+		WaypointsDialogController controller = new WaypointsDialogController(app);
+		app.getDialogManager().register(PROCESS_ID, controller);
+		controller.setUseRouteInfoMenu(useRouteInfoMenu);
+		return controller;
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/routepreparationmenu/WaypointsFragment.java b/OsmAnd/src/net/osmand/plus/routepreparationmenu/WaypointsFragment.java
index b559554527c..c0add90b08f 100644
--- a/OsmAnd/src/net/osmand/plus/routepreparationmenu/WaypointsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/routepreparationmenu/WaypointsFragment.java
@@ -3,7 +3,6 @@
 import android.content.Context;
 import android.graphics.drawable.Drawable;
 import android.os.Bundle;
-import android.os.CountDownTimer;
 import android.util.TypedValue;
 import android.view.Gravity;
 import android.view.LayoutInflater;
@@ -28,10 +27,8 @@
 
 import net.osmand.StateChangedListener;
 import net.osmand.data.FavouritePoint;
-import net.osmand.data.LatLon;
 import net.osmand.data.LocationPoint;
 import net.osmand.data.PointDescription;
-import net.osmand.data.ValueHolder;
 import net.osmand.plus.GeocodingLookupService.AddressLookupRequest;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
@@ -69,8 +66,6 @@ public class WaypointsFragment extends BaseOsmAndFragment implements ObservableS
 		DynamicListViewCallbacks, WaypointDialogHelper.WaypointDialogHelperCallback, AddPointBottomSheetDialog.DialogListener {
 
 	public static final String TAG = "WaypointsFragment";
-	public static final String USE_ROUTE_INFO_MENU_KEY = "use_route_info_menu_key";
-	public static final int DELAY_BEFORE_APPLY_MS = 5000;
 
 	private View view;
 	private View mainView;
@@ -81,15 +76,11 @@ public class WaypointsFragment extends BaseOsmAndFragment implements ObservableS
 	private SwipeDismissListViewTouchListener swipeDismissListener;
 
 	private StateChangedListener<Void> onStateChangedListener;
-
-	private CountDownTimer cTimer;
-
-	private final int[] running = {-1};
+	private WaypointsDialogController controller;
 
 	private boolean portrait;
 	private boolean wasDrawerDisabled;
 
-	private boolean useRouteInfoMenu;
 	private boolean showWaypointOnMap;
 
 	@Override
@@ -97,6 +88,15 @@ protected boolean isUsedOnMap() {
 		return true;
 	}
 
+	@Override
+	public void onCreate(@Nullable Bundle savedInstanceState) {
+		super.onCreate(savedInstanceState);
+		controller = WaypointsDialogController.getInstance(app);
+		if (controller == null) {
+			dismiss();
+		}
+	}
+
 	@Nullable
 	@Override
 	public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup parent, Bundle savedInstanceState) {
@@ -110,13 +110,6 @@ public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup parent, Bun
 			return null;
 		}
 		AndroidUtils.addStatusBarPadding21v(mapActivity, view);
-		Bundle args = getArguments();
-		if (args == null) {
-			args = savedInstanceState;
-		}
-		if (args != null) {
-			useRouteInfoMenu = args.getBoolean(USE_ROUTE_INFO_MENU_KEY, false);
-		}
 		mainView = view.findViewById(R.id.main_view);
 
 		listView = view.findViewById(R.id.dash_list_view);
@@ -131,25 +124,7 @@ public View onCreateView(@NonNull LayoutInflater inflater, ViewGroup parent, Bun
 		updateTitle();
 
 		view.findViewById(R.id.sort_button).setOnClickListener(v -> {
-			boolean hasActivePoints = false;
-			List<Object> items = listAdapter.getActiveObjects();
-			if (items.size() > 0) {
-				if (items.size() > 1) {
-					hasActivePoints = true;
-				} else {
-					Object item = items.get(0);
-					if (item instanceof LocationPointWrapper) {
-						LocationPointWrapper w = (LocationPointWrapper) item;
-						if (w.getPoint() instanceof TargetPoint) {
-							hasActivePoints = !((TargetPoint) w.point).start;
-						}
-					} else {
-						hasActivePoints = true;
-					}
-				}
-			}
-
-			if (hasActivePoints) {
+			if (isHasActivePoints()) {
 				MapActivity activity = getMapActivity();
 				if (activity != null) {
 					TargetOptionsBottomSheetDialogFragment fragment = new TargetOptionsBottomSheetDialogFragment();
@@ -187,8 +162,7 @@ public boolean canDismiss(int position) {
 						if (stableAdapter != null) {
 							List<Object> activeObjects = stableAdapter.getActiveObjects();
 							Object obj = stableAdapter.getItem(position);
-							if (obj instanceof LocationPointWrapper) {
-								LocationPointWrapper w = (LocationPointWrapper) obj;
+							if (obj instanceof LocationPointWrapper w) {
 								if (w.getPoint() instanceof TargetPoint) {
 									return !((TargetPoint) w.getPoint()).start;
 								}
@@ -209,9 +183,8 @@ public Undoable onDismiss(int position) {
 							stableAdapter.getActiveObjects().remove(item);
 							stableAdapter.refreshData();
 							stableAdapter.notifyDataSetChanged();
+							controller.onApplyChanges(stableAdapter.getActiveObjects(), () -> {});
 						}
-						cancelTimer();
-						startTimer();
 						return null;
 					}
 
@@ -237,28 +210,23 @@ public void onHidePopup() {
 		FrameLayout clearButton = view.findViewById(R.id.clear_all_button);
 		TextView clearButtonDescr = view.findViewById(R.id.clear_all_button_descr);
 		clearButtonDescr.setText(R.string.shared_string_clear_all);
-		clearButton.setOnClickListener(v -> {
-			app.getTargetPointsHelper().clearAllPoints(true);
+		clearButton.setOnClickListener(v -> controller.onClearClicked(() -> {
 			updateTitle();
 			reloadAdapter();
-		});
+		}));
 
 		View applyButton = view.findViewById(R.id.start_button);
 		applyButton.setOnClickListener(v -> {
-			cancelTimer();
 			updateRouteCalculationProgress(0);
-			applyPointsChanges();
-			updateTitle();
+			controller.onApplyChanges(listAdapter.getActiveObjects(), this::dismiss);
 		});
 
 		View cancelButton = view.findViewById(R.id.cancel_button);
 		TextViewEx cancelTitle = view.findViewById(R.id.cancel_button_descr);
-		cancelTitle.setText(R.string.shared_string_undo);
+		cancelTitle.setText(R.string.shared_string_cancel);
 		cancelButton.setOnClickListener(v -> {
-			cancelTimer();
-			reloadAdapter();
 			updateRouteCalculationProgress(0);
-			updateTitle();
+			controller.onCancelChanges(this::dismiss);
 		});
 
 		onStateChangedListener = change -> app.runInUIThread(() -> {
@@ -272,6 +240,26 @@ public void onHidePopup() {
 		return view;
 	}
 
+	private boolean isHasActivePoints() {
+		boolean hasActivePoints = false;
+		List<Object> items = listAdapter.getActiveObjects();
+		if (!items.isEmpty()) {
+			if (items.size() > 1) {
+				hasActivePoints = true;
+			} else {
+				Object item = items.get(0);
+				if (item instanceof LocationPointWrapper w) {
+					if (w.getPoint() instanceof TargetPoint) {
+						hasActivePoints = !((TargetPoint) w.point).start;
+					}
+				} else {
+					hasActivePoints = true;
+				}
+			}
+		}
+		return hasActivePoints;
+	}
+
 	@Override
 	public void onResume() {
 		super.onResume();
@@ -280,7 +268,7 @@ public void onResume() {
 			MapRouteInfoMenu.waypointsVisible = true;
 			wasDrawerDisabled = mapActivity.isDrawerDisabled();
 			mapActivity.getDashboard().getWaypointDialogHelper().addHelperCallback(this);
-			mapActivity.getMyApplication().getTargetPointsHelper().addListener(onStateChangedListener);
+			app.getTargetPointsHelper().addListener(onStateChangedListener);
 			if (!wasDrawerDisabled) {
 				mapActivity.disableDrawer();
 			}
@@ -292,23 +280,24 @@ public void onResume() {
 	@Override
 	public void onPause() {
 		super.onPause();
-		cancelTimer();
 		MapActivity mapActivity = getMapActivity();
 		if (mapActivity != null) {
 			MapRouteInfoMenu.waypointsVisible = false;
 			mapActivity.getDashboard().getWaypointDialogHelper().removeHelperCallback(this);
-			mapActivity.getMyApplication().getTargetPointsHelper().removeListener(onStateChangedListener);
+			app.getTargetPointsHelper().removeListener(onStateChangedListener);
 			if (!wasDrawerDisabled) {
 				mapActivity.enableDrawer();
 			}
-			updateControlsVisibility(true, useRouteInfoMenu);
+			updateControlsVisibility(true, controller.isUseRouteInfoMenu());
 		}
 	}
 
 	@Override
-	public void onSaveInstanceState(@NonNull Bundle outState) {
-		outState.putBoolean(USE_ROUTE_INFO_MENU_KEY, useRouteInfoMenu);
-		super.onSaveInstanceState(outState);
+	public void onDestroy() {
+		super.onDestroy();
+		if (controller != null) {
+			controller.onDestroy();
+		}
 	}
 
 	@Override
@@ -339,11 +328,8 @@ public void deleteWaypoint(int position) {
 		deleteSwipeItem(position);
 	}
 
-	@SuppressWarnings("unchecked")
 	@Override
 	public void onItemsSwapped(List<Object> items) {
-		cancelTimer();
-		startTimer();
 	}
 
 	@Nullable
@@ -418,16 +404,13 @@ public void reloadListAdapter(ArrayAdapter<Object> listAdapter) {
 		listAdapter.notifyDataSetChanged();
 	}
 
-	public AdapterView.OnItemClickListener getDrawerItemClickListener(FragmentActivity ctx, int[] running,
+	public AdapterView.OnItemClickListener getDrawerItemClickListener(FragmentActivity ctx,
 	                                                                  ArrayAdapter<Object> listAdapter) {
 		return (adapterView, view, item, l) -> {
-			if (listAdapter.getItem(item) instanceof LocationPointWrapper) {
+			if (listAdapter.getItem(item) instanceof LocationPointWrapper ps) {
 				showWaypointOnMap = true;
 				dismiss();
-				LocationPointWrapper ps = (LocationPointWrapper) listAdapter.getItem(item);
-				if (ps != null) {
-					showOnMap(app, ctx, ps.getPoint(), false);
-				}
+				showOnMap(app, ctx, ps.getPoint(), false);
 			}
 		};
 	}
@@ -449,8 +432,7 @@ public StableArrayAdapter getWaypointsDrawerAdapter(
 			public View getView(int position, View convertView, @NonNull ViewGroup parent) {
 				View v = convertView;
 				Object obj = getItem(position);
-				if (obj instanceof LocationPointWrapper) {
-					LocationPointWrapper point = (LocationPointWrapper) obj;
+				if (obj instanceof LocationPointWrapper point) {
 					v = updateWaypointItemView(edit, deletedPoints, ctx, v, point, this, nightMode, flat, position);
 				}
 				return v;
@@ -458,8 +440,7 @@ public View getView(int position, View convertView, @NonNull ViewGroup parent) {
 		};
 
 		for (Object p : points) {
-			if (p instanceof LocationPointWrapper) {
-				LocationPointWrapper w = (LocationPointWrapper) p;
+			if (p instanceof LocationPointWrapper w) {
 				if (w.type == WaypointHelper.TARGETS) {
 					TargetPoint t = (TargetPoint) w.point;
 					if (t.getOriginalPointDescription() != null
@@ -491,11 +472,6 @@ public void updateControlsVisibility(boolean visible, boolean openingRouteInfo)
 		}
 	}
 
-	public void newRouteIsCalculated(boolean newRoute, ValueHolder<Boolean> showToast) {
-		reloadAdapter();
-		showToast.value = false;
-	}
-
 	public void updateRouteCalculationProgress(int progress) {
 		MapActivity mapActivity = getMapActivity();
 		if (mapActivity == null) {
@@ -534,10 +510,10 @@ private void updateListAdapter() {
 		List<LocationPointWrapper> deletedPoints = new ArrayList<>();
 		listView.setEmptyView(null);
 		StableArrayAdapter listAdapter = getWaypointsDrawerAdapter(true, deletedPoints, mapActivity, false, nightMode);
-		AdapterView.OnItemClickListener listener = getDrawerItemClickListener(mapActivity, running, listAdapter);
+		AdapterView.OnItemClickListener listener = getDrawerItemClickListener(mapActivity, listAdapter);
 		setDynamicListItems(listView, listAdapter);
 		updateListAdapter(listAdapter, listener);
-
+		controller.setInitialTargetPoints(listAdapter.getActiveObjects());
 	}
 
 	private void updateListAdapter(StableArrayAdapter listAdapter, AdapterView.OnItemClickListener listener) {
@@ -561,94 +537,25 @@ private void deleteSwipeItem(int position) {
 	}
 
 	private void updateTitle() {
-		if ( isAdded()) {
+		if (isAdded()) {
 			TextViewEx title = view.findViewById(R.id.title);
 			int pointsSize = app.getTargetPointsHelper().getAllPoints().size();
-			String text = getString(R.string.shared_string_target_points) + " (" + (pointsSize != 0 ? pointsSize : 1) + ")";
+			String text = getString(R.string.shared_string_target_points);
+			String countText = "(" + (pointsSize != 0 ? pointsSize : 1) + ")";
+			text = getString(R.string.ltr_or_rtl_combine_via_space, text, countText);
 			title.setText(text);
-	}
-	}
-
-	private void applyPointsChanges() {
-		app.runInUIThread(() -> {
-			if (!isVisible()) {
-				return;
-			}
-			List<TargetPoint> allTargets = new ArrayList<>();
-			TargetPoint start = null;
-			List<Object> items = listAdapter.getActiveObjects();
-			if (items != null) {
-				for (Object obj : items) {
-					if (obj instanceof LocationPointWrapper) {
-						LocationPointWrapper p = (LocationPointWrapper) obj;
-						if (p.getPoint() instanceof TargetPoint) {
-							TargetPoint t = (TargetPoint) p.getPoint();
-							if (t.start) {
-								start = t;
-							} else {
-								t.intermediate = true;
-							}
-							allTargets.add(t);
-						}
-					}
-				}
-				if (allTargets.size() > 0) {
-					allTargets.get(allTargets.size() - 1).intermediate = false;
-				}
-			}
-			TargetPointsHelper targetPointsHelper = app.getTargetPointsHelper();
-			if (start != null) {
-				int startInd = allTargets.indexOf(start);
-				TargetPoint first = allTargets.remove(0);
-				if (startInd != 0) {
-					start.start = false;
-					start.intermediate = startInd != allTargets.size() - 1;
-					if (targetPointsHelper.getPointToStart() == null) {
-						start.getOriginalPointDescription().setName(PointDescription
-								.getLocationNamePlain(app, start.getLatitude(), start.getLongitude()));
-					}
-					first.start = true;
-					first.intermediate = false;
-					targetPointsHelper.setStartPoint(new LatLon(first.getLatitude(), first.getLongitude()),
-							false, first.getPointDescription(app));
-				}
-			}
-			targetPointsHelper.reorderAllTargetPoints(allTargets, false);
-			newRouteIsCalculated(false, new ValueHolder<Boolean>());
-			targetPointsHelper.updateRouteAndRefresh(true);
-		}, 50);
-	}
-
-	private void startTimer() {
-		cTimer = new CountDownTimer(DELAY_BEFORE_APPLY_MS, 200) {
-
-			public void onTick(long millisUntilFinished) {
-				updateRouteCalculationProgress((int) ((1 - ((float) millisUntilFinished / DELAY_BEFORE_APPLY_MS)) * 100));
-			}
-
-			public void onFinish() {
-				updateRouteCalculationProgress(100);
-				applyPointsChanges();
-				updateTitle();
-			}
-		};
-		cTimer.start();
-	}
-
-	private void cancelTimer() {
-		if (cTimer != null)
-			cTimer.cancel();
+		}
 	}
 
 	private View updateWaypointItemView(boolean edit, List<LocationPointWrapper> deletedPoints,
 	                                    MapActivity mapActivity, View v,
 	                                    LocationPointWrapper point,
-	                                    ArrayAdapter adapter, boolean nightMode,
+	                                    ArrayAdapter<Object> adapter, boolean nightMode,
 	                                    boolean flat, int position) {
 		OsmandApplication app = mapActivity.getMyApplication();
 		WaypointDialogHelper helper = mapActivity.getDashboard().getWaypointDialogHelper();
 		if (v == null || v.findViewById(R.id.info_close) == null) {
-			v = UiUtilities.getInflater(mapActivity, nightMode).inflate(R.layout.route_waypoint_item, null);
+			v = inflate(R.layout.route_waypoint_item, null);
 		}
 		v.setBackgroundColor(ColorUtilities.getCardAndListBackgroundColor(mapActivity, nightMode));
 		updatePointInfoView(mapActivity, v, point, true, nightMode, edit, false);
@@ -817,29 +724,9 @@ private static PointDescription getPointDescription(Context ctx, TargetPoint poi
 		}
 	}
 
-	public static boolean showInstance(FragmentManager fragmentManager) {
-		return showInstance(fragmentManager, false);
-	}
-
-	public static boolean showInstance(@NonNull FragmentManager fragmentManager, boolean useRouteInfoMenu) {
-		if (AndroidUtils.isFragmentCanBeAdded(fragmentManager, TAG)) {
-			Bundle args = new Bundle();
-			args.putBoolean(USE_ROUTE_INFO_MENU_KEY, useRouteInfoMenu);
-
-			WaypointsFragment fragment = new WaypointsFragment();
-			fragment.setArguments(args);
-			fragmentManager.beginTransaction()
-					.add(R.id.routeMenuContainer, fragment, TAG)
-					.addToBackStack(TAG)
-					.commitAllowingStateLoss();
-			return true;
-		}
-		return false;
-	}
-
 	private void onDismiss() {
 		try {
-			if (useRouteInfoMenu && !showWaypointOnMap) {
+			if (controller.isUseRouteInfoMenu() && !showWaypointOnMap) {
 				MapActivity mapActivity = (MapActivity) getActivity();
 				if (mapActivity != null) {
 					mapActivity.getMapActions().showRouteInfoControlDialog();
@@ -865,8 +752,28 @@ public void onSelectOnMap(AddPointBottomSheetDialog dialog) {
 		MapActivity mapActivity = (MapActivity) getActivity();
 		if (mapActivity != null) {
 			mapActivity.getMapRouteInfoMenu().selectOnScreen(dialog.getPointType(), true);
-			useRouteInfoMenu = false;
+			controller.setUseRouteInfoMenu(false);
 			dismiss();
 		}
 	}
+
+	public static boolean showInstance(@NonNull FragmentActivity activity) {
+		return showInstance(activity, false);
+	}
+
+	public static boolean showInstance(@NonNull FragmentActivity activity, boolean useRouteInfoMenu) {
+		FragmentManager fragmentManager = activity.getSupportFragmentManager();
+		OsmandApplication app = (OsmandApplication) activity.getApplicationContext();
+		if (AndroidUtils.isFragmentCanBeAdded(fragmentManager, TAG)) {
+			WaypointsDialogController.createInstance(app, useRouteInfoMenu);
+
+			WaypointsFragment fragment = new WaypointsFragment();
+			fragmentManager.beginTransaction()
+					.add(R.id.routeMenuContainer, fragment, TAG)
+					.addToBackStack(TAG)
+					.commitAllowingStateLoss();
+			return true;
+		}
+		return false;
+	}
 }
\ No newline at end of file
