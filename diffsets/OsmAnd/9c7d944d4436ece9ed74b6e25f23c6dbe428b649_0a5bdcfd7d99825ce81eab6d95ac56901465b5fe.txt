diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/BackupSettingsFragment.java b/OsmAnd/src/net/osmand/plus/backup/ui/BackupSettingsFragment.java
index 7c2e387ded3..e96755566e8 100644
--- a/OsmAnd/src/net/osmand/plus/backup/ui/BackupSettingsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/backup/ui/BackupSettingsFragment.java
@@ -136,7 +136,7 @@ private void setupBackupTypes(@NonNull View view) {
 		container.setOnClickListener(v -> {
 			FragmentActivity activity = getActivity();
 			if (activity != null) {
-				BackupTypesFragment.showInstance(activity.getSupportFragmentManager());
+				BackupTypesController.showScreen(activity);
 			}
 		});
 		setupSelectableBackground(container);
@@ -188,7 +188,7 @@ private void setupVersionHistory(@NonNull View view) {
 		container.setOnClickListener(v -> {
 			FragmentActivity activity = getActivity();
 			if (activity != null) {
-				VersionHistoryFragment.showInstance(activity.getSupportFragmentManager());
+				VersionHistoryController.showScreen(activity);
 			}
 		});
 		setupSelectableBackground(container);
diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesAdapter.java b/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesAdapter.java
index 2f280866f18..d97eac03b99 100644
--- a/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesAdapter.java
@@ -1,6 +1,5 @@
 package net.osmand.plus.backup.ui;
 
-
 import android.content.Context;
 import android.graphics.drawable.Drawable;
 import android.view.LayoutInflater;
@@ -11,7 +10,6 @@
 import android.widget.TextView;
 
 import androidx.annotation.NonNull;
-import androidx.core.content.ContextCompat;
 
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
@@ -19,7 +17,6 @@
 import net.osmand.plus.base.OsmandBaseExpandableListAdapter;
 import net.osmand.plus.chooseplan.button.PurchasingUtils;
 import net.osmand.plus.helpers.AndroidUiHelper;
-import net.osmand.plus.inapp.InAppPurchaseUtils;
 import net.osmand.plus.mapmarkers.MapMarkersGroup;
 import net.osmand.plus.settings.backend.ExportCategory;
 import net.osmand.plus.settings.backend.backup.exporttype.ExportType;
@@ -27,6 +24,7 @@
 import net.osmand.plus.settings.fragments.ExportSettingsAdapter;
 import net.osmand.plus.settings.fragments.SettingsCategoryItems;
 import net.osmand.plus.utils.AndroidUtils;
+import net.osmand.plus.utils.ColorUtilities;
 import net.osmand.plus.utils.FontCache;
 import net.osmand.plus.utils.UiUtilities;
 import net.osmand.plus.utils.UiUtilities.CompoundButtonType;
@@ -43,27 +41,24 @@ public class BackupTypesAdapter extends OsmandBaseExpandableListAdapter {
 
 	private final OsmandApplication app;
 	private final UiUtilities uiUtilities;
+	private final BaseBackupTypesController controller;
 
 	private List<ExportCategory> itemsTypes;
 	private Map<ExportType, List<?>> selectedItemsMap;
 	private Map<ExportCategory, SettingsCategoryItems> itemsMap;
 
-	private final OnItemSelectedListener listener;
-
 	private final LayoutInflater themedInflater;
 
 	private final int activeColor;
 	private final boolean nightMode;
-	private final boolean cloudRestore;
 
-	public BackupTypesAdapter(@NonNull Context context, OnItemSelectedListener listener, boolean cloudRestore, boolean nightMode) {
+	public BackupTypesAdapter(@NonNull Context context, @NonNull BaseBackupTypesController controller) {
 		this.app = (OsmandApplication) context.getApplicationContext();
-		this.listener = listener;
-		this.nightMode = nightMode;
-		this.cloudRestore = cloudRestore;
+		this.controller = controller;
+		this.nightMode = controller.isNightMode();
 		uiUtilities = app.getUIUtilities();
 		themedInflater = UiUtilities.getInflater(context, nightMode);
-		activeColor = ContextCompat.getColor(context, nightMode ? R.color.icon_color_active_dark : R.color.icon_color_active_light);
+		activeColor = ColorUtilities.getActiveIconColor(app, nightMode);
 	}
 
 	@Override
@@ -89,17 +84,15 @@ public View getGroupView(int groupPosition, boolean isExpanded, View convertView
 			}
 		}
 		CompoundButton compoundButton = view.findViewById(R.id.switch_widget);
-		boolean available = InAppPurchaseUtils.isBackupAvailable(app) || cloudRestore;
+		boolean available = controller.isBackupAvailable();
 		compoundButton.setChecked(available && selectedTypes == items.getTypes().size());
 		compoundButton.setEnabled(available);
 		UiUtilities.setupCompoundButton(compoundButton, nightMode, CompoundButtonType.GLOBAL);
 		View switchContainer = view.findViewById(R.id.switch_container);
 		if (available) {
-			switchContainer.setOnClickListener(view1 -> {
+			switchContainer.setOnClickListener(v -> {
 				compoundButton.performClick();
-				if (listener != null) {
-					listener.onCategorySelected(category, compoundButton.isChecked());
-				}
+				controller.onCategorySelected(category, compoundButton.isChecked());
 				notifyDataSetChanged();
 			});
 		} else {
@@ -138,14 +131,12 @@ public View getChildView(int groupPosition, int childPosition, boolean isLastChi
 		UiUtilities.setupCompoundButton(compoundButton, nightMode, CompoundButtonType.GLOBAL);
 
 		ImageView proIcon = view.findViewById(R.id.pro_icon);
-		boolean showProIcon = !InAppPurchaseUtils.isExportTypeAvailable(app, exportType) && !cloudRestore;
+		boolean showProIcon = !controller.isExportTypeAvailable(exportType);
 		setupChildIcon(view, exportType.getIconId(), selected && !showProIcon);
 		proIcon.setImageResource(PurchasingUtils.getProFeatureIconId(nightMode));
-		view.setOnClickListener(view1 -> {
+		view.setOnClickListener(v -> {
 			compoundButton.performClick();
-			if (listener != null) {
-				listener.onTypeSelected(exportType, compoundButton.isChecked());
-			}
+			controller.onTypeSelected(exportType, compoundButton.isChecked());
 			notifyDataSetChanged();
 		});
 		AndroidUiHelper.updateVisibility(proIcon, showProIcon);
@@ -177,15 +168,15 @@ private void setupChildIcon(View view, int iconRes, boolean itemSelected) {
 		icon.setImageDrawable(uiUtilities.getIcon(iconRes, colorRes));
 	}
 
-	public void updateSettingsItems(@NonNull Map<ExportCategory, SettingsCategoryItems> itemsMap,
-	                                @NonNull Map<ExportType, List<?>> selectedItemsMap) {
-		this.itemsMap = itemsMap;
+	public void updateSettingsItems() {
+		this.itemsMap = controller.getDataList();
 		this.itemsTypes = new ArrayList<>(itemsMap.keySet());
-		this.selectedItemsMap = selectedItemsMap;
+		this.selectedItemsMap = controller.getSelectedItems();
 		Collections.sort(itemsTypes);
 		notifyDataSetChanged();
 	}
 
+	@NonNull
 	private String getCategoryDescr(ExportCategory category) {
 		long itemsSize = 0;
 		int selectedTypes = 0;
@@ -208,36 +199,19 @@ private String getCategoryDescr(ExportCategory category) {
 		return itemsSize == 0 ? description : app.getString(R.string.ltr_or_rtl_combine_via_comma, description, formattedSize);
 	}
 
+	@NonNull
 	public static String getSelectedTypeDescr(@NonNull OsmandApplication app,
 	                                          @NonNull Map<ExportType, List<?>> selectedItemsMap,
 	                                          @NonNull ExportType exportType, @NonNull List<?> items) {
-		long itemsSize = 0;
-		int selectedTypes = 0;
-
 		List<?> selectedItems = selectedItemsMap.get(exportType);
 		if (!Algorithms.isEmpty(selectedItems)) {
-			for (int i = 0; i < items.size(); i++) {
-				Object object = items.get(i);
-				if (selectedItems.contains(object)) {
-					selectedTypes++;
-					if (object instanceof FileSettingsItem) {
-						itemsSize += ((FileSettingsItem) object).getSize();
-					} else if (object instanceof File) {
-						itemsSize += ((File) object).length();
-					} else if (object instanceof RemoteFile) {
-						itemsSize += ((RemoteFile) object).getZipSize();
-					} else if (object instanceof MapMarkersGroup) {
-						MapMarkersGroup markersGroup = (MapMarkersGroup) object;
-						if (CollectionUtils.equalsToAny(markersGroup.getId(), ExportType.ACTIVE_MARKERS.name(), ExportType.HISTORY_MARKERS.name())) {
-							itemsSize += ((MapMarkersGroup) object).getMarkers().size();
-						}
-					}
-				}
-			}
+			CalculatedItemsSize calculatedSize = calculateSelectedItemsSize(items, selectedItems);
+			long itemsSize = calculatedSize.itemsSize;
+			int selectedTypes = calculatedSize.selectedTypes;
 			String description;
 			if (selectedTypes == items.size()) {
 				description = app.getString(R.string.shared_string_all);
-				if (items.size() > 0) {
+				if (!items.isEmpty()) {
 					description = app.getString(R.string.ltr_or_rtl_combine_via_comma, description, String.valueOf(items.size()));
 				}
 			} else {
@@ -254,6 +228,33 @@ public static String getSelectedTypeDescr(@NonNull OsmandApplication app,
 		}
 	}
 
+	@NonNull
+	private static CalculatedItemsSize calculateSelectedItemsSize(@NonNull List<?> items,
+	                                                              @NonNull List<?> selectedItems) {
+		long itemsSize = 0;
+		int selectedTypes = 0;
+		for (int i = 0; i < items.size(); i++) {
+			Object object = items.get(i);
+			if (selectedItems.contains(object)) {
+				selectedTypes++;
+				if (object instanceof FileSettingsItem) {
+					itemsSize += ((FileSettingsItem) object).getSize();
+				} else if (object instanceof File) {
+					itemsSize += ((File) object).length();
+				} else if (object instanceof RemoteFile) {
+					itemsSize += ((RemoteFile) object).getZipSize();
+				} else if (object instanceof MapMarkersGroup markersGroup) {
+					if (CollectionUtils.equalsToAny(markersGroup.getId(), ExportType.ACTIVE_MARKERS.name(), ExportType.HISTORY_MARKERS.name())) {
+						itemsSize += ((MapMarkersGroup) object).getMarkers().size();
+					}
+				}
+			}
+		}
+		return new CalculatedItemsSize(itemsSize, selectedTypes);
+	}
+
+	private record CalculatedItemsSize(long itemsSize, int selectedTypes) { }
+
 	@Override
 	public int getGroupCount() {
 		return itemsTypes.size();
@@ -283,7 +284,7 @@ public long getGroupId(int i) {
 
 	@Override
 	public long getChildId(int groupPosition, int childPosition) {
-		return groupPosition * 10000 + childPosition;
+		return groupPosition * 10000L + childPosition;
 	}
 
 	@Override
diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesController.java b/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesController.java
new file mode 100644
index 00000000000..ed6811e2a63
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesController.java
@@ -0,0 +1,85 @@
+package net.osmand.plus.backup.ui;
+
+import androidx.annotation.NonNull;
+import androidx.fragment.app.FragmentActivity;
+import androidx.fragment.app.FragmentManager;
+
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.R;
+import net.osmand.plus.backup.PrepareBackupResult.RemoteFilesType;
+import net.osmand.plus.backup.UserNotRegisteredException;
+import net.osmand.plus.backup.ui.ClearTypesBottomSheet.BackupClearType;
+import net.osmand.plus.base.dialog.DialogManager;
+import net.osmand.plus.inapp.InAppPurchaseUtils;
+import net.osmand.plus.settings.backend.ExportCategory;
+import net.osmand.plus.settings.backend.backup.exporttype.ExportType;
+import net.osmand.plus.settings.fragments.SettingsCategoryItems;
+
+import java.util.EnumMap;
+import java.util.List;
+import java.util.Map;
+
+public class BackupTypesController extends BaseBackupTypesController {
+
+	private static final String PROCESS_ID = "select_cloud_backup_types";
+
+	public BackupTypesController(@NonNull OsmandApplication app) {
+		super(app, BackupClearType.ALL, RemoteFilesType.UNIQUE);
+	}
+
+	@NonNull
+	@Override
+	public String getProcessId() {
+		return PROCESS_ID;
+	}
+
+	@Override
+	public int getTitleId() {
+		return R.string.backup_data;
+	}
+
+	@Override
+	@NonNull
+	protected Map<ExportType, List<?>> collectSelectedItems() {
+		Map<ExportType, List<?>> selectedItemsMap = new EnumMap<>(ExportType.class);
+		for (ExportType exportType : ExportType.values()) {
+			boolean enabled = backupHelper.getBackupTypePref(exportType).get();
+			boolean available = InAppPurchaseUtils.isExportTypeAvailable(app, exportType);
+
+			if (enabled && (available || cloudRestore)) {
+				selectedItemsMap.put(exportType, getItemsForType(exportType));
+			}
+		}
+		return selectedItemsMap;
+	}
+
+	@Override
+	public void onCategorySelected(ExportCategory exportCategory, boolean selected) {
+		super.onCategorySelected(exportCategory, selected);
+
+		SettingsCategoryItems categoryItems = dataList.get(exportCategory);
+		for (ExportType exportType : categoryItems.getTypes()) {
+			backupHelper.getBackupTypePref(exportType).set(selected);
+		}
+	}
+
+	@Override
+	public void onTypeSelected(@NonNull ExportType exportType, boolean selected) {
+		super.onTypeSelected(exportType, selected);
+		backupHelper.getBackupTypePref(exportType).set(selected);
+	}
+
+	@Override
+	public void clearDataForTypes(@NonNull List<ExportType> types) throws UserNotRegisteredException {
+		backupHelper.deleteAllFiles(types);
+	}
+
+	public static void showScreen(@NonNull FragmentActivity activity) {
+		OsmandApplication app = (OsmandApplication) activity.getApplicationContext();
+		DialogManager dialogManager = app.getDialogManager();
+		dialogManager.register(PROCESS_ID, new BackupTypesController(app));
+
+		FragmentManager fragmentManager = activity.getSupportFragmentManager();
+		BackupTypesFragment.showInstance(fragmentManager, PROCESS_ID);
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesFragment.java b/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesFragment.java
index 33b56b82f6a..17a78538458 100644
--- a/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesFragment.java
+++ b/OsmAnd/src/net/osmand/plus/backup/ui/BackupTypesFragment.java
@@ -1,89 +1,167 @@
 package net.osmand.plus.backup.ui;
 
+import android.os.Bundle;
+import android.view.LayoutInflater;
+import android.view.View;
+import android.view.ViewGroup;
+import android.widget.ExpandableListView;
+import android.widget.ImageView;
+import android.widget.ProgressBar;
+import android.widget.TextView;
+
 import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+import androidx.appcompat.widget.Toolbar;
+import androidx.core.view.ViewCompat;
+import androidx.fragment.app.FragmentActivity;
 import androidx.fragment.app.FragmentManager;
 
-import net.osmand.PlatformUtil;
 import net.osmand.plus.R;
-import net.osmand.plus.backup.PrepareBackupResult.RemoteFilesType;
-import net.osmand.plus.backup.UserNotRegisteredException;
-import net.osmand.plus.backup.ui.ClearTypesBottomSheet.BackupClearType;
-import net.osmand.plus.inapp.InAppPurchaseUtils;
-import net.osmand.plus.settings.backend.ExportCategory;
-import net.osmand.plus.settings.backend.backup.exporttype.ExportType;
-import net.osmand.plus.settings.fragments.SettingsCategoryItems;
+import net.osmand.plus.activities.MapActivity;
+import net.osmand.plus.base.BaseOsmAndFragment;
+import net.osmand.plus.base.dialog.DialogManager;
+import net.osmand.plus.base.dialog.interfaces.dialog.IContextDialog;
+import net.osmand.plus.base.dialog.interfaces.dialog.IDialogNightModeInfoProvider;
+import net.osmand.plus.helpers.AndroidUiHelper;
+import net.osmand.plus.inapp.InAppPurchaseHelper.InAppPurchaseListener;
+import net.osmand.plus.settings.fragments.BaseSettingsListFragment;
+import net.osmand.plus.utils.AndroidUtils;
+import net.osmand.plus.utils.ColorUtilities;
+
+public class BackupTypesFragment extends BaseOsmAndFragment
+		implements IContextDialog, IDialogNightModeInfoProvider, InAppPurchaseListener {
 
-import org.apache.commons.logging.Log;
+	private static final String TAG = BackupTypesFragment.class.getSimpleName();
+	private static final String PROCESS_ID_KEY = "process_id";
 
-import java.util.EnumMap;
-import java.util.List;
-import java.util.Map;
+	protected BaseBackupTypesController controller;
+	protected String processId;
 
-public class BackupTypesFragment extends BaseBackupTypesFragment {
+	protected ProgressBar progressBar;
+	protected BackupTypesAdapter adapter;
 
-	public static final String TAG = BackupTypesFragment.class.getSimpleName();
-	private static final Log log = PlatformUtil.getLog(BackupTypesFragment.class);
+	protected boolean wasDrawerDisabled;
 
 	@Override
-	protected int getTitleId() {
-		return R.string.backup_data;
+	public void onCreate(@Nullable Bundle savedInstanceState) {
+		super.onCreate(savedInstanceState);
+		if (savedInstanceState != null) {
+			processId = savedInstanceState.getString(PROCESS_ID_KEY);
+		}
+		DialogManager dialogManager = app.getDialogManager();
+		controller = (BaseBackupTypesController) dialogManager.findController(processId);
+		if (controller != null) {
+			controller.registerDialog(this);
+		}
 	}
 
+	@Nullable
 	@Override
-	protected BackupClearType getClearType() {
-		return BackupClearType.ALL;
+	public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
+		updateNightMode();
+		View view = inflate(R.layout.fragment_backup_types, container);
+		AndroidUtils.addStatusBarPadding21v(requireMyActivity(), view);
+		setupToolbar(view);
+
+		progressBar = view.findViewById(R.id.progress_bar);
+
+		adapter = new BackupTypesAdapter(view.getContext(), controller);
+		adapter.updateSettingsItems();
+
+		ExpandableListView expandableList = view.findViewById(R.id.list);
+		expandableList.setAdapter(adapter);
+		BaseSettingsListFragment.setupListView(expandableList);
+
+		return view;
 	}
 
-	@Override
-	protected RemoteFilesType getRemoteFilesType() {
-		return RemoteFilesType.UNIQUE;
+	protected void setupToolbar(@NonNull View view) {
+		Toolbar toolbar = view.findViewById(R.id.toolbar);
+		TextView toolbarTitle = toolbar.findViewById(R.id.toolbar_title);
+		toolbarTitle.setText(controller.getTitleId());
+
+		ImageView closeButton = toolbar.findViewById(R.id.close_button);
+		closeButton.setImageDrawable(getIcon(AndroidUtils.getNavigationIconResId(view.getContext())));
+		closeButton.setOnClickListener(v -> {
+			FragmentActivity activity = getActivity();
+			if (activity != null) {
+				activity.onBackPressed();
+			}
+		});
+		ViewCompat.setElevation(view.findViewById(R.id.appbar), 5.0f);
 	}
 
 	@Override
-	protected Map<ExportType, List<?>> getSelectedItems() {
-		Map<ExportType, List<?>> selectedItemsMap = new EnumMap<>(ExportType.class);
-		for (ExportType exportType : ExportType.values()) {
-			boolean enabled = backupHelper.getBackupTypePref(exportType).get();
-			boolean available = InAppPurchaseUtils.isExportTypeAvailable(app, exportType);
-			boolean cloudRestore = requireMapActivity().getFragmentsHelper().isFirstScreenShowing();
-
-			if (enabled && (available || cloudRestore)) {
-				selectedItemsMap.put(exportType, getItemsForType(exportType));
+	public void onResume() {
+		super.onResume();
+		MapActivity mapActivity = getMapActivity();
+		if (mapActivity != null) {
+			wasDrawerDisabled = mapActivity.isDrawerDisabled();
+			if (!wasDrawerDisabled) {
+				mapActivity.disableDrawer();
 			}
+			controller.onResume();
 		}
-		return selectedItemsMap;
 	}
 
 	@Override
-	public void onCategorySelected(ExportCategory exportCategory, boolean selected) {
-		super.onCategorySelected(exportCategory, selected);
-
-		SettingsCategoryItems categoryItems = dataList.get(exportCategory);
-		for (ExportType exportType : categoryItems.getTypes()) {
-			backupHelper.getBackupTypePref(exportType).set(selected);
+	public void onPause() {
+		super.onPause();
+		MapActivity mapActivity = getMapActivity();
+		if (mapActivity != null && !wasDrawerDisabled) {
+			mapActivity.enableDrawer();
 		}
+		controller.onPause();
+	}
+
+	@Override
+	public void onSaveInstanceState(@NonNull Bundle outState) {
+		super.onSaveInstanceState(outState);
+		outState.putString(PROCESS_ID_KEY, processId);
+	}
+
+	@Override
+	public void onDestroy() {
+		super.onDestroy();
+		controller.finishProcessIfNeeded(getActivity());
 	}
 
 	@Override
-	public void onTypeSelected(@NonNull ExportType exportType, boolean selected) {
-		super.onTypeSelected(exportType, selected);
-		backupHelper.getBackupTypePref(exportType).set(selected);
+	public int getStatusBarColorId() {
+		return ColorUtilities.getStatusBarColorId(nightMode);
 	}
 
 	@Override
-	public void onClearTypesConfirmed(@NonNull List<ExportType> types) {
-		try {
-			updateProgressVisibility(true);
-			backupHelper.deleteAllFiles(types);
-		} catch (UserNotRegisteredException e) {
-			updateProgressVisibility(false);
-			log.error(e);
+	public void onItemPurchased(String sku, boolean active) {
+		controller.updateData();
+		if (isResumed() && adapter != null) {
+			adapter.updateSettingsItems();
+		}
+	}
+
+	public void updateProgressVisibility(boolean visible) {
+		AndroidUiHelper.updateVisibility(progressBar, visible);
+	}
+
+	@NonNull
+	public MapActivity requireMapActivity() {
+		return ((MapActivity) requireActivity());
+	}
+
+	@Nullable
+	public MapActivity getMapActivity() {
+		FragmentActivity activity = getActivity();
+		if (activity instanceof MapActivity) {
+			return (MapActivity) activity;
+		} else {
+			return null;
 		}
 	}
 
-	public static void showInstance(@NonNull FragmentManager manager) {
-		if (manager.findFragmentByTag(TAG) == null) {
+	public static void showInstance(@NonNull FragmentManager manager, @NonNull String processId) {
+		if (AndroidUtils.isFragmentCanBeAdded(manager, TAG, true)) {
 			BackupTypesFragment fragment = new BackupTypesFragment();
+			fragment.processId = processId;
 			manager.beginTransaction()
 					.replace(R.id.fragmentContainer, fragment, TAG)
 					.addToBackStack(null)
diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/BaseBackupTypesController.java b/OsmAnd/src/net/osmand/plus/backup/ui/BaseBackupTypesController.java
new file mode 100644
index 00000000000..49de5f933d8
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/backup/ui/BaseBackupTypesController.java
@@ -0,0 +1,206 @@
+package net.osmand.plus.backup.ui;
+
+import androidx.annotation.NonNull;
+import androidx.annotation.StringRes;
+import androidx.fragment.app.FragmentActivity;
+
+import net.osmand.PlatformUtil;
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.backup.BackupHelper;
+import net.osmand.plus.backup.BackupListeners.OnDeleteFilesListener;
+import net.osmand.plus.backup.PrepareBackupResult.RemoteFilesType;
+import net.osmand.plus.backup.RemoteFile;
+import net.osmand.plus.backup.UserNotRegisteredException;
+import net.osmand.plus.backup.ui.BackupTypesAdapter.OnItemSelectedListener;
+import net.osmand.plus.backup.ui.ClearTypesBottomSheet.BackupClearType;
+import net.osmand.plus.backup.ui.ClearTypesBottomSheet.OnClearTypesListener;
+import net.osmand.plus.base.dialog.BaseDialogController;
+import net.osmand.plus.base.dialog.interfaces.dialog.IDialog;
+import net.osmand.plus.chooseplan.OsmAndProPlanFragment;
+import net.osmand.plus.inapp.InAppPurchaseUtils;
+import net.osmand.plus.settings.backend.ExportCategory;
+import net.osmand.plus.settings.backend.backup.SettingsHelper;
+import net.osmand.plus.settings.backend.backup.exporttype.ExportType;
+import net.osmand.plus.settings.fragments.SettingsCategoryItems;
+import net.osmand.util.Algorithms;
+
+import org.apache.commons.logging.Log;
+
+import java.util.ArrayList;
+import java.util.Collections;
+import java.util.EnumMap;
+import java.util.LinkedHashMap;
+import java.util.List;
+import java.util.Map;
+
+public abstract class BaseBackupTypesController extends BaseDialogController
+		implements OnItemSelectedListener, OnClearTypesListener, OnDeleteFilesListener {
+
+	private static final Log LOG = PlatformUtil.getLog(BaseBackupTypesController.class);
+
+	protected final BackupHelper backupHelper;
+	protected final BackupClearType clearType;
+	protected final RemoteFilesType remoteFilesType;
+	protected Map<ExportCategory, SettingsCategoryItems> dataList = new LinkedHashMap<>();
+	protected Map<ExportType, List<?>> selectedItemsMap = new EnumMap<>(ExportType.class);
+	protected BackupTypesFragment screen;
+	protected boolean cloudRestore;
+
+	public BaseBackupTypesController(@NonNull OsmandApplication app,
+	                                 @NonNull BackupClearType clearType,
+	                                 @NonNull RemoteFilesType remoteFilesType) {
+		super(app);
+		this.backupHelper = app.getBackupHelper();
+		this.clearType = clearType;
+		this.remoteFilesType = remoteFilesType;
+	}
+
+	@Override
+	public void registerDialog(@NonNull IDialog dialog) {
+		super.registerDialog(dialog);
+		this.screen = (BackupTypesFragment) dialog;
+		cloudRestore = screen.requireMapActivity().getFragmentsHelper().isFirstScreenShowing();
+		updateData();
+	}
+
+	public void onResume() {
+		backupHelper.getBackupListeners().addDeleteFilesListener(this);
+	}
+
+	public void onPause() {
+		backupHelper.getBackupListeners().removeDeleteFilesListener(this);
+	}
+
+	@StringRes
+	public abstract int getTitleId();
+
+	public void updateData() {
+		this.dataList = collectAllItems();
+		this.selectedItemsMap = collectSelectedItems();
+	}
+
+	@NonNull
+	public Map<ExportCategory, SettingsCategoryItems> getDataList() {
+		return dataList;
+	}
+
+	@NonNull
+	public Map<ExportType, List<?>> getSelectedItems() {
+		return selectedItemsMap;
+	}
+
+	@NonNull
+	private Map<ExportCategory, SettingsCategoryItems> collectAllItems() {
+		Map<String, RemoteFile> remoteFiles = backupHelper.getBackup().getRemoteFiles(remoteFilesType);
+		if (remoteFiles == null) {
+			remoteFiles = Collections.emptyMap();
+		}
+		Map<ExportType, List<?>> dataToOperate = new EnumMap<>(ExportType.class);
+		for (ExportType exportType : ExportType.enabledValues()) {
+			List<RemoteFile> filesByType = new ArrayList<>();
+			for (RemoteFile remoteFile : remoteFiles.values()) {
+				if (ExportType.findBy(remoteFile) == exportType) {
+					filesByType.add(remoteFile);
+				}
+			}
+			dataToOperate.put(exportType, filesByType);
+		}
+		return SettingsHelper.categorizeSettingsToOperate(dataToOperate, true);
+	}
+
+	@NonNull
+	protected abstract Map<ExportType, List<?>> collectSelectedItems();
+
+	@NonNull
+	public List<?> getItemsForType(@NonNull ExportType exportType) {
+		for (SettingsCategoryItems categoryItems : dataList.values()) {
+			if (categoryItems.getTypes().contains(exportType)) {
+				return categoryItems.getItemsForType(exportType);
+			}
+		}
+		return Collections.emptyList();
+	}
+
+	@Override
+	public void onCategorySelected(ExportCategory exportCategory, boolean selected) {
+		boolean hasItemsToDelete = false;
+		SettingsCategoryItems categoryItems = dataList.get(exportCategory);
+		List<ExportType> exportTypes = categoryItems.getTypes();
+		for (ExportType exportType : exportTypes) {
+			if (isExportTypeAvailable(exportType)) {
+				List<?> items = getItemsForType(exportType);
+				hasItemsToDelete |= !Algorithms.isEmpty(items);
+				selectedItemsMap.put(exportType, selected ? items : null);
+			}
+		}
+		if (!selected && hasItemsToDelete) {
+			showClearTypesBottomSheet(exportTypes);
+		}
+	}
+
+	@Override
+	public void onTypeSelected(@NonNull ExportType exportType, boolean selected) {
+		if (isExportTypeAvailable(exportType)) {
+			List<?> items = getItemsForType(exportType);
+			selectedItemsMap.put(exportType, selected ? items : null);
+			if (!selected && !Algorithms.isEmpty(items)) {
+				showClearTypesBottomSheet(Collections.singletonList(exportType));
+			}
+		} else {
+			FragmentActivity activity = getActivity();
+			if (activity != null) {
+				OsmAndProPlanFragment.showInstance(activity);
+			}
+		}
+	}
+
+	protected void showClearTypesBottomSheet(List<ExportType> types) {
+		FragmentActivity activity = getActivity();
+		if (activity != null) {
+			ClearTypesBottomSheet.showInstance(activity, this, types);
+		}
+	}
+
+	// TODO: delete
+	protected boolean isExportTypeAvailable(@NonNull ExportType exportType) {
+		return InAppPurchaseUtils.isExportTypeAvailable(app, exportType) || cloudRestore;
+	}
+
+	protected boolean isBackupAvailable() {
+		return InAppPurchaseUtils.isBackupAvailable(app) || cloudRestore;
+	}
+
+	@Override
+	public void onClearTypesConfirmed(@NonNull List<ExportType> types) {
+		try {
+			screen.updateProgressVisibility(true);
+			clearDataForTypes(types);
+		} catch (UserNotRegisteredException e) {
+			screen.updateProgressVisibility(false);
+			LOG.error(e);
+		}
+	}
+
+	protected abstract void clearDataForTypes(@NonNull List<ExportType> types) throws UserNotRegisteredException;
+
+	@Override
+	public void onFileDeleteProgress(@NonNull RemoteFile file, int progress) {
+		screen.updateProgressVisibility(true);
+	}
+
+	@Override
+	public void onFilesDeleteDone(@NonNull Map<RemoteFile, String> errors) {
+		screen.updateProgressVisibility(false);
+		backupHelper.prepareBackup();
+	}
+
+	@Override
+	public void onFilesDeleteError(int status, @NonNull String message) {
+		screen.updateProgressVisibility(false);
+		backupHelper.prepareBackup();
+	}
+
+	public boolean isCloudRestore() {
+		return cloudRestore;
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/BaseBackupTypesFragment.java b/OsmAnd/src/net/osmand/plus/backup/ui/BaseBackupTypesFragment.java
deleted file mode 100644
index 3fbf977a339..00000000000
--- a/OsmAnd/src/net/osmand/plus/backup/ui/BaseBackupTypesFragment.java
+++ /dev/null
@@ -1,261 +0,0 @@
-package net.osmand.plus.backup.ui;
-
-import android.os.Bundle;
-import android.view.LayoutInflater;
-import android.view.View;
-import android.view.ViewGroup;
-import android.widget.ExpandableListView;
-import android.widget.ImageView;
-import android.widget.ProgressBar;
-import android.widget.TextView;
-
-import androidx.annotation.NonNull;
-import androidx.annotation.Nullable;
-import androidx.appcompat.widget.Toolbar;
-import androidx.core.view.ViewCompat;
-import androidx.fragment.app.FragmentActivity;
-
-import net.osmand.plus.R;
-import net.osmand.plus.activities.MapActivity;
-import net.osmand.plus.backup.BackupHelper;
-import net.osmand.plus.backup.BackupListeners.OnDeleteFilesListener;
-import net.osmand.plus.backup.PrepareBackupResult.RemoteFilesType;
-import net.osmand.plus.backup.RemoteFile;
-import net.osmand.plus.backup.ui.BackupTypesAdapter.OnItemSelectedListener;
-import net.osmand.plus.backup.ui.ClearTypesBottomSheet.BackupClearType;
-import net.osmand.plus.backup.ui.ClearTypesBottomSheet.OnClearTypesListener;
-import net.osmand.plus.base.BaseOsmAndFragment;
-import net.osmand.plus.chooseplan.OsmAndProPlanFragment;
-import net.osmand.plus.helpers.AndroidUiHelper;
-import net.osmand.plus.inapp.InAppPurchaseHelper.InAppPurchaseListener;
-import net.osmand.plus.inapp.InAppPurchaseUtils;
-import net.osmand.plus.settings.backend.ExportCategory;
-import net.osmand.plus.settings.backend.backup.SettingsHelper;
-import net.osmand.plus.settings.backend.backup.exporttype.ExportType;
-import net.osmand.plus.settings.fragments.BaseSettingsListFragment;
-import net.osmand.plus.settings.fragments.SettingsCategoryItems;
-import net.osmand.plus.utils.AndroidUtils;
-import net.osmand.plus.utils.ColorUtilities;
-import net.osmand.util.Algorithms;
-
-import java.util.ArrayList;
-import java.util.Collections;
-import java.util.EnumMap;
-import java.util.LinkedHashMap;
-import java.util.List;
-import java.util.Map;
-
-public abstract class BaseBackupTypesFragment extends BaseOsmAndFragment implements OnItemSelectedListener,
-		OnClearTypesListener, OnDeleteFilesListener, InAppPurchaseListener {
-
-	protected BackupHelper backupHelper;
-
-	protected Map<ExportCategory, SettingsCategoryItems> dataList = new LinkedHashMap<>();
-	protected Map<ExportType, List<?>> selectedItemsMap = new EnumMap<>(ExportType.class);
-
-	protected ProgressBar progressBar;
-	protected BackupTypesAdapter adapter;
-	protected BackupClearType clearType;
-
-	protected boolean cloudRestore;
-	protected boolean wasDrawerDisabled;
-
-	@Override
-	public int getStatusBarColorId() {
-		return ColorUtilities.getStatusBarColorId(nightMode);
-	}
-
-	@Override
-	public void onCreate(@Nullable Bundle savedInstanceState) {
-		super.onCreate(savedInstanceState);
-		backupHelper = app.getBackupHelper();
-		clearType = getClearType();
-		dataList = getDataList();
-		selectedItemsMap = getSelectedItems();
-		cloudRestore = requireMapActivity().getFragmentsHelper().isFirstScreenShowing();
-	}
-
-	protected abstract int getTitleId();
-
-	protected abstract BackupClearType getClearType();
-
-	protected abstract RemoteFilesType getRemoteFilesType();
-
-	protected abstract Map<ExportType, List<?>> getSelectedItems();
-
-	@Nullable
-	@Override
-	public View onCreateView(@NonNull LayoutInflater inflater, @Nullable ViewGroup container, @Nullable Bundle savedInstanceState) {
-		updateNightMode();
-		View view = themedInflater.inflate(R.layout.fragment_backup_types, container, false);
-		AndroidUtils.addStatusBarPadding21v(requireMyActivity(), view);
-		setupToolbar(view);
-
-		progressBar = view.findViewById(R.id.progress_bar);
-
-		adapter = new BackupTypesAdapter(view.getContext(), this, cloudRestore, nightMode);
-		adapter.updateSettingsItems(dataList, selectedItemsMap);
-
-		ExpandableListView expandableList = view.findViewById(R.id.list);
-		expandableList.setAdapter(adapter);
-		BaseSettingsListFragment.setupListView(expandableList);
-
-		return view;
-	}
-
-	protected void setupToolbar(@NonNull View view) {
-		Toolbar toolbar = view.findViewById(R.id.toolbar);
-
-		TextView toolbarTitle = toolbar.findViewById(R.id.toolbar_title);
-		toolbarTitle.setText(getTitleId());
-
-		ImageView closeButton = toolbar.findViewById(R.id.close_button);
-		closeButton.setImageDrawable(getIcon(AndroidUtils.getNavigationIconResId(view.getContext())));
-		closeButton.setOnClickListener(v -> {
-			FragmentActivity activity = getActivity();
-			if (activity != null) {
-				activity.onBackPressed();
-			}
-		});
-		ViewCompat.setElevation(view.findViewById(R.id.appbar), 5.0f);
-	}
-
-	@Override
-	public void onResume() {
-		super.onResume();
-		MapActivity mapActivity = getMapActivity();
-		if (mapActivity != null) {
-			wasDrawerDisabled = mapActivity.isDrawerDisabled();
-			if (!wasDrawerDisabled) {
-				mapActivity.disableDrawer();
-			}
-			backupHelper.getBackupListeners().addDeleteFilesListener(this);
-		}
-	}
-
-	@Override
-	public void onPause() {
-		super.onPause();
-		MapActivity mapActivity = getMapActivity();
-		if (mapActivity != null && !wasDrawerDisabled) {
-			mapActivity.enableDrawer();
-		}
-		backupHelper.getBackupListeners().removeDeleteFilesListener(this);
-	}
-
-	@Override
-	public void onCategorySelected(ExportCategory exportCategory, boolean selected) {
-		boolean hasItemsToDelete = false;
-		SettingsCategoryItems categoryItems = dataList.get(exportCategory);
-		List<ExportType> exportTypes = categoryItems.getTypes();
-		for (ExportType exportType : exportTypes) {
-			if (isExportTypeAvailable(exportType)) {
-				List<?> items = getItemsForType(exportType);
-				hasItemsToDelete |= !Algorithms.isEmpty(items);
-				selectedItemsMap.put(exportType, selected ? items : null);
-			}
-		}
-		if (!selected && hasItemsToDelete) {
-			showClearTypesBottomSheet(exportTypes);
-		}
-	}
-
-	@Override
-	public void onTypeSelected(@NonNull ExportType exportType, boolean selected) {
-		if (isExportTypeAvailable(exportType)) {
-			List<?> items = getItemsForType(exportType);
-			selectedItemsMap.put(exportType, selected ? items : null);
-			if (!selected && !Algorithms.isEmpty(items)) {
-				showClearTypesBottomSheet(Collections.singletonList(exportType));
-			}
-		} else {
-			OsmAndProPlanFragment.showInstance(requireActivity());
-		}
-	}
-
-	protected boolean isExportTypeAvailable(@NonNull ExportType exportType) {
-		return InAppPurchaseUtils.isExportTypeAvailable(app, exportType) || cloudRestore;
-	}
-
-	protected void showClearTypesBottomSheet(List<ExportType> types) {
-		FragmentActivity activity = getActivity();
-		if (activity != null) {
-			ClearTypesBottomSheet.showInstance(activity.getSupportFragmentManager(), types, clearType, this);
-		}
-	}
-
-	@NonNull
-	protected Map<ExportCategory, SettingsCategoryItems> getDataList() {
-		Map<String, RemoteFile> remoteFiles = backupHelper.getBackup().getRemoteFiles(getRemoteFilesType());
-		if (remoteFiles == null) {
-			remoteFiles = Collections.emptyMap();
-		}
-		Map<ExportType, List<?>> dataToOperate = new EnumMap<>(ExportType.class);
-		for (ExportType exportType : ExportType.enabledValues()) {
-			List<RemoteFile> filesByType = new ArrayList<>();
-			for (RemoteFile remoteFile : remoteFiles.values()) {
-				if (ExportType.findBy(remoteFile) == exportType) {
-					filesByType.add(remoteFile);
-				}
-			}
-			dataToOperate.put(exportType, filesByType);
-		}
-		return SettingsHelper.categorizeSettingsToOperate(dataToOperate, true);
-	}
-
-	@NonNull
-	protected List<?> getItemsForType(@NonNull ExportType exportType) {
-		for (SettingsCategoryItems categoryItems : dataList.values()) {
-			if (categoryItems.getTypes().contains(exportType)) {
-				return categoryItems.getItemsForType(exportType);
-			}
-		}
-		return Collections.emptyList();
-	}
-
-	@Override
-	public void onFileDeleteProgress(@NonNull RemoteFile file, int progress) {
-		updateProgressVisibility(true);
-	}
-
-	@Override
-	public void onFilesDeleteDone(@NonNull Map<RemoteFile, String> errors) {
-		updateProgressVisibility(false);
-		backupHelper.prepareBackup();
-	}
-
-	@Override
-	public void onFilesDeleteError(int status, @NonNull String message) {
-		updateProgressVisibility(false);
-		backupHelper.prepareBackup();
-	}
-
-	@Override
-	public void onItemPurchased(String sku, boolean active) {
-		dataList = getDataList();
-		selectedItemsMap = getSelectedItems();
-
-		if (isResumed() && adapter != null) {
-			adapter.updateSettingsItems(dataList, selectedItemsMap);
-		}
-	}
-
-	protected void updateProgressVisibility(boolean visible) {
-		AndroidUiHelper.updateVisibility(progressBar, visible);
-	}
-
-	@NonNull
-	protected MapActivity requireMapActivity() {
-		return ((MapActivity) requireActivity());
-	}
-
-	@Nullable
-	public MapActivity getMapActivity() {
-		FragmentActivity activity = getActivity();
-		if (activity instanceof MapActivity) {
-			return (MapActivity) activity;
-		} else {
-			return null;
-		}
-	}
-}
\ No newline at end of file
diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/ClearTypesBottomSheet.java b/OsmAnd/src/net/osmand/plus/backup/ui/ClearTypesBottomSheet.java
index 32ddb67242e..4d0a912c041 100644
--- a/OsmAnd/src/net/osmand/plus/backup/ui/ClearTypesBottomSheet.java
+++ b/OsmAnd/src/net/osmand/plus/backup/ui/ClearTypesBottomSheet.java
@@ -3,10 +3,13 @@
 import android.os.Bundle;
 
 import androidx.annotation.NonNull;
-import androidx.fragment.app.Fragment;
+import androidx.fragment.app.FragmentActivity;
 import androidx.fragment.app.FragmentManager;
 
+import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
+import net.osmand.plus.base.dialog.DialogManager;
+import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.plus.widgets.dialogbutton.DialogButtonType;
 import net.osmand.plus.base.MenuBottomSheetDialogFragment;
 import net.osmand.plus.base.bottomsheetmenu.SimpleBottomSheetItem;
@@ -21,11 +24,14 @@ public class ClearTypesBottomSheet extends MenuBottomSheetDialogFragment {
 
 	public static final String TAG = ClearTypesBottomSheet.class.getSimpleName();
 
+	private static final String PROCESS_ID_KEY = "process_id";
 	private static final String CLEAR_TYPE_KEY = "clear_type_key";
 	private static final String DISABLED_TYPES_KEY = "disabled_types_key";
 
 	private final List<ExportType> types = new ArrayList<>();
+	private BaseBackupTypesController controller;
 	private BackupClearType clearType;
+	private String processId;
 
 	@Override
 	public void onCreate(Bundle savedInstanceState) {
@@ -40,7 +46,11 @@ public void onCreate(Bundle savedInstanceState) {
 			if (savedInstanceState.containsKey(CLEAR_TYPE_KEY)) {
 				clearType = BackupClearType.valueOf(savedInstanceState.getString(CLEAR_TYPE_KEY));
 			}
+			processId = savedInstanceState.getString(PROCESS_ID_KEY);
 		}
+		OsmandApplication app = requiredMyApplication();
+		DialogManager dialogManager = app.getDialogManager();
+		controller = (BaseBackupTypesController) dialogManager.findController(processId);
 	}
 
 	@Override
@@ -67,14 +77,12 @@ public void onSaveInstanceState(@NonNull Bundle outState) {
 		}
 		outState.putStringArrayList(DISABLED_TYPES_KEY, names);
 		outState.putString(CLEAR_TYPE_KEY, clearType.name());
+		outState.putString(PROCESS_ID_KEY, processId);
 	}
 
 	@Override
 	protected void onRightBottomButtonClick() {
-		Fragment fragment = getTargetFragment();
-		if (fragment instanceof OnClearTypesListener) {
-			((OnClearTypesListener) fragment).onClearTypesConfirmed(types);
-		}
+		controller.onClearTypesConfirmed(types);
 		dismiss();
 	}
 
@@ -93,17 +101,6 @@ protected DialogButtonType getRightBottomButtonType() {
 		return DialogButtonType.SECONDARY_HARMFUL;
 	}
 
-	public static void showInstance(@NonNull FragmentManager manager, @NonNull List<ExportType> types,
-									@NonNull BackupClearType clearType, @NonNull Fragment target) {
-		if (!manager.isStateSaved()) {
-			ClearTypesBottomSheet fragment = new ClearTypesBottomSheet();
-			fragment.types.addAll(types);
-			fragment.clearType = clearType;
-			fragment.setTargetFragment(target, 0);
-			fragment.show(manager, TAG);
-		}
-	}
-
 	public enum BackupClearType {
 		ALL(R.string.backup_delete_types, R.string.backup_delete_types_descr),
 		HISTORY(R.string.delete_version_history, R.string.backup_version_history_delete_descr);
@@ -125,6 +122,19 @@ public int getDescriptionId() {
 		}
 	}
 
+	public static void showInstance(@NonNull FragmentActivity activity,
+	                                @NonNull BaseBackupTypesController controller,
+	                                @NonNull List<ExportType> types) {
+		FragmentManager manager = activity.getSupportFragmentManager();
+		if (AndroidUtils.isFragmentCanBeAdded(manager, TAG)) {
+			ClearTypesBottomSheet fragment = new ClearTypesBottomSheet();
+			fragment.types.addAll(types);
+			fragment.clearType = controller.clearType;
+			fragment.processId = controller.getProcessId();
+			fragment.show(manager, TAG);
+		}
+	}
+
 	public interface OnClearTypesListener {
 		void onClearTypesConfirmed(@NonNull List<ExportType> types);
 	}
diff --git a/OsmAnd/src/net/osmand/plus/backup/ui/VersionHistoryFragment.java b/OsmAnd/src/net/osmand/plus/backup/ui/VersionHistoryController.java
similarity index 57%
rename from OsmAnd/src/net/osmand/plus/backup/ui/VersionHistoryFragment.java
rename to OsmAnd/src/net/osmand/plus/backup/ui/VersionHistoryController.java
index 81cd0535a50..afc54a7f898 100644
--- a/OsmAnd/src/net/osmand/plus/backup/ui/VersionHistoryFragment.java
+++ b/OsmAnd/src/net/osmand/plus/backup/ui/VersionHistoryController.java
@@ -1,45 +1,45 @@
 package net.osmand.plus.backup.ui;
 
 import androidx.annotation.NonNull;
+import androidx.fragment.app.FragmentActivity;
 import androidx.fragment.app.FragmentManager;
 
-import net.osmand.PlatformUtil;
+import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
 import net.osmand.plus.backup.PrepareBackupResult.RemoteFilesType;
 import net.osmand.plus.backup.UserNotRegisteredException;
 import net.osmand.plus.backup.ui.ClearTypesBottomSheet.BackupClearType;
+import net.osmand.plus.base.dialog.DialogManager;
 import net.osmand.plus.settings.backend.ExportCategory;
 import net.osmand.plus.settings.backend.backup.exporttype.ExportType;
 import net.osmand.plus.settings.fragments.SettingsCategoryItems;
 
-import org.apache.commons.logging.Log;
-
 import java.util.EnumMap;
 import java.util.List;
 import java.util.Map;
 
-public class VersionHistoryFragment extends BaseBackupTypesFragment {
+public class VersionHistoryController extends BaseBackupTypesController {
 
-	public static final String TAG = VersionHistoryFragment.class.getSimpleName();
-	private static final Log log = PlatformUtil.getLog(VersionHistoryFragment.class);
+	private static final String PROCESS_ID = "select_types_to_manage_version_history";
 
-	@Override
-	protected int getTitleId() {
-		return R.string.backup_version_history;
+	public VersionHistoryController(@NonNull OsmandApplication app) {
+		super(app, BackupClearType.HISTORY, RemoteFilesType.OLD);
 	}
 
+	@NonNull
 	@Override
-	protected BackupClearType getClearType() {
-		return BackupClearType.HISTORY;
+	public String getProcessId() {
+		return PROCESS_ID;
 	}
 
 	@Override
-	protected RemoteFilesType getRemoteFilesType() {
-		return RemoteFilesType.OLD;
+	public int getTitleId() {
+		return R.string.backup_version_history;
 	}
 
 	@Override
-	protected Map<ExportType, List<?>> getSelectedItems() {
+	@NonNull
+	protected Map<ExportType, List<?>> collectSelectedItems() {
 		Map<ExportType, List<?>> selectedItemsMap = new EnumMap<>(ExportType.class);
 		for (ExportType exportType : ExportType.values()) {
 			if (backupHelper.getVersionHistoryTypePref(exportType).get()) {
@@ -52,7 +52,6 @@ protected Map<ExportType, List<?>> getSelectedItems() {
 	@Override
 	public void onCategorySelected(ExportCategory exportCategory, boolean selected) {
 		super.onCategorySelected(exportCategory, selected);
-
 		SettingsCategoryItems categoryItems = dataList.get(exportCategory);
 		for (ExportType exportType : categoryItems.getTypes()) {
 			backupHelper.getVersionHistoryTypePref(exportType).set(selected);
@@ -66,24 +65,16 @@ public void onTypeSelected(@NonNull ExportType exportType, boolean selected) {
 	}
 
 	@Override
-	public void onClearTypesConfirmed(@NonNull List<ExportType> types) {
-		try {
-			updateProgressVisibility(true);
-			backupHelper.deleteOldFiles(types);
-		} catch (UserNotRegisteredException e) {
-			updateProgressVisibility(false);
-			log.error(e);
-		}
+	public void clearDataForTypes(@NonNull List<ExportType> types) throws UserNotRegisteredException {
+		backupHelper.deleteOldFiles(types);
 	}
 
-	public static void showInstance(@NonNull FragmentManager manager) {
-		if (manager.findFragmentByTag(TAG) == null) {
-			VersionHistoryFragment fragment = new VersionHistoryFragment();
-			fragment.setRetainInstance(true);
-			manager.beginTransaction()
-					.replace(R.id.fragmentContainer, fragment, TAG)
-					.addToBackStack(null)
-					.commitAllowingStateLoss();
-		}
+	public static void showScreen(@NonNull FragmentActivity activity) {
+		OsmandApplication app = (OsmandApplication) activity.getApplicationContext();
+		DialogManager dialogManager = app.getDialogManager();
+		dialogManager.register(PROCESS_ID, new VersionHistoryController(app));
+
+		FragmentManager fragmentManager = activity.getSupportFragmentManager();
+		BackupTypesFragment.showInstance(fragmentManager, PROCESS_ID);
 	}
 }
