diff --git a/OsmAnd/res/drawable/btn_oval_blue.xml b/OsmAnd/res/drawable/btn_oval_blue.xml
new file mode 100644
index 00000000000..ca9916a370f
--- /dev/null
+++ b/OsmAnd/res/drawable/btn_oval_blue.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+	android:shape="rectangle">
+
+	<solid android:color="@color/switch_button_active_light" />
+	<corners android:radius="@dimen/fab_icon_padding" />
+
+</shape>
\ No newline at end of file
diff --git a/OsmAnd/res/drawable/btn_oval_orange.xml b/OsmAnd/res/drawable/btn_oval_orange.xml
new file mode 100644
index 00000000000..dbb8a59dc78
--- /dev/null
+++ b/OsmAnd/res/drawable/btn_oval_orange.xml
@@ -0,0 +1,8 @@
+<?xml version="1.0" encoding="utf-8"?>
+<shape xmlns:android="http://schemas.android.com/apk/res/android"
+	android:shape="rectangle">
+
+	<solid android:color="@color/switch_button_active_dark"/>
+	<corners android:radius="@dimen/fab_icon_padding"/>
+
+</shape>
diff --git a/OsmAnd/res/drawable/ripple_oval_dark.xml b/OsmAnd/res/drawable/ripple_oval_dark.xml
new file mode 100644
index 00000000000..bfa623347f9
--- /dev/null
+++ b/OsmAnd/res/drawable/ripple_oval_dark.xml
@@ -0,0 +1,9 @@
+<ripple xmlns:android="http://schemas.android.com/apk/res/android"
+	android:color="@color/active_buttons_and_links_trans_dark">
+	<item android:id="@android:id/mask">
+		<shape android:shape="rectangle">
+			<solid android:color="@color/active_color_primary_dark" />
+			<corners android:radius="@dimen/fab_icon_padding" />
+		</shape>
+	</item>
+</ripple>
\ No newline at end of file
diff --git a/OsmAnd/res/drawable/ripple_oval_light.xml b/OsmAnd/res/drawable/ripple_oval_light.xml
new file mode 100644
index 00000000000..9ebe8ced509
--- /dev/null
+++ b/OsmAnd/res/drawable/ripple_oval_light.xml
@@ -0,0 +1,9 @@
+<ripple xmlns:android="http://schemas.android.com/apk/res/android"
+	android:color="@color/active_buttons_and_links_trans_light">
+	<item android:id="@android:id/mask">
+		<shape android:shape="rectangle">
+			<solid android:color="@color/active_color_primary_light" />
+			<corners android:radius="@dimen/fab_icon_padding" />
+		</shape>
+	</item>
+</ripple>
\ No newline at end of file
diff --git a/OsmAnd/res/layout/quick_action_add_gpx.xml b/OsmAnd/res/layout/quick_action_add_gpx.xml
index 0114d17b364..84fc8835a07 100644
--- a/OsmAnd/res/layout/quick_action_add_gpx.xml
+++ b/OsmAnd/res/layout/quick_action_add_gpx.xml
@@ -1,229 +1,243 @@
 <?xml version="1.0" encoding="utf-8"?>
 <LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
-    xmlns:osmand="http://schemas.android.com/apk/res-auto"
-    xmlns:tools="http://schemas.android.com/tools"
-    android:orientation="vertical"
-    android:layout_width="match_parent"
-    android:layout_height="match_parent">
-
-    <LinearLayout
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:background="?attr/bg_color"
-        android:minHeight="56dp"
-        android:orientation="horizontal">
-
-        <TextView
-            android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:padding="@dimen/content_padding"
-            android:layout_gravity="center"
-            android:text="@string/quick_action_interim_dialog"
-            android:textColor="?android:textColorPrimary"
-            android:textSize="@dimen/default_list_text_size"
-            android:layout_weight="1"
-            android:id="@+id/textView3" />
-
-        <androidx.appcompat.widget.SwitchCompat
-            android:id="@+id/saveButton"
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:layout_gravity="center_vertical"
-            android:layout_marginRight="@dimen/content_padding"
-            android:layout_marginLeft="@dimen/content_padding"
-	        android:layout_marginStart="@dimen/content_padding"
-	        android:layout_marginEnd="@dimen/content_padding" />
-
-    </LinearLayout>
-
-    <androidx.appcompat.widget.AppCompatImageView
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:layout_gravity="top"
-        android:scaleType="fitXY"
-        osmand:srcCompat="@drawable/bg_shadow_list_bottom" />
-
-    <androidx.appcompat.widget.AppCompatImageView
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:scaleType="fitXY"
-        android:layout_gravity="top"
-        android:layout_marginTop="@dimen/content_padding"
-        osmand:srcCompat="@drawable/bg_shadow_list_top"/>
-
-    <LinearLayout
-        android:id="@+id/title_view"
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:background="?attr/bg_color"
-        android:orientation="vertical">
-
-        <LinearLayout
-            android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:layout_marginTop="@dimen/content_padding"
-            android:baselineAligned="false"
-            android:orientation="horizontal">
-
-            <LinearLayout
-                android:layout_width="42dp"
-                android:layout_height="match_parent"
-                android:orientation="horizontal">
-
-                <androidx.appcompat.widget.AppCompatImageView
-                    android:id="@+id/name_image"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:layout_marginLeft="@dimen/content_padding_small"
-                    android:layout_marginStart="@dimen/content_padding_small"
-                    android:layout_marginTop="2dp"
-                    android:scaleType="centerInside"
-                    android:tint="?attr/default_icon_color"
-                    osmand:srcCompat="@drawable/ic_action_favorite"/>
-
-            </LinearLayout>
-
-            <LinearLayout
-                android:layout_width="0dp"
-                android:layout_height="wrap_content"
-                android:layout_marginLeft="@dimen/content_padding"
-                android:layout_weight="1"
-                android:orientation="vertical"
-	            android:layout_marginStart="@dimen/content_padding">
-
-                <TextView
-                    android:id="@+id/name_caption"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:layout_marginLeft="@dimen/content_padding_small"
-                    android:layout_marginRight="@dimen/content_padding_small"
-                    android:text="@string/shared_string_name"
-                    android:textColor="?android:textColorSecondary"
-                    android:textSize="@dimen/default_sub_text_size"
-	                android:layout_marginStart="@dimen/content_padding_small"
-	                android:layout_marginEnd="@dimen/content_padding_small" />
-
-                <androidx.appcompat.widget.AppCompatEditText
-                    android:id="@+id/name_edit"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:layout_marginLeft="@dimen/content_padding_half"
-                    android:layout_marginRight="@dimen/content_padding"
-                    android:layout_marginTop="@dimen/content_padding_half"
-                    android:imeOptions="actionDone"
-                    android:inputType="text"
-                    android:textColor="?android:textColorPrimary"
-                    android:textColorHint="?android:textColorSecondary"
-                    tools:text="@string/shared_string_name"
-	                android:layout_marginStart="@dimen/content_padding_half"
-	                android:layout_marginEnd="@dimen/content_padding" />
-
-            </LinearLayout>
-
-        </LinearLayout>
-
-        <TextView
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:layout_marginLeft="68dp"
-            android:layout_marginRight="@dimen/content_padding"
-            android:text="@string/quick_action_fav_name_descr"
-            android:textColor="?android:textColorSecondary"
-            android:textSize="@dimen/default_sub_text_size"
-            android:layout_marginBottom="@dimen/content_padding"
-	        android:layout_marginEnd="@dimen/content_padding"
-	        android:layout_marginStart="68dp" />
-
-        <View
-            android:layout_width="match_parent"
-            android:layout_height="1dp"
-            android:layout_marginBottom="@dimen/content_padding"
-            android:background="@color/shadow_color"
-            android:layout_marginLeft="68dp"
-	        android:layout_marginStart="68dp" />
-
-        <LinearLayout
-            android:layout_width="match_parent"
-            android:layout_height="wrap_content"
-            android:baselineAligned="false"
-            android:orientation="horizontal">
-
-            <LinearLayout
-                android:layout_width="42dp"
-                android:layout_height="match_parent"
-                android:orientation="horizontal">
-
-                <androidx.appcompat.widget.AppCompatImageView
-                    android:id="@+id/category_image"
-                    android:layout_width="match_parent"
-                    android:layout_height="wrap_content"
-                    android:layout_marginLeft="@dimen/content_padding_small"
-                    android:layout_marginStart="@dimen/content_padding_small"
-                    android:layout_marginTop="2dp"
-                    android:scaleType="centerInside"
-                    android:tint="?attr/default_icon_color"
-                    osmand:srcCompat="@drawable/ic_action_folder"/>
-
-            </LinearLayout>
-
-            <LinearLayout
-                android:layout_width="0dp"
-                android:layout_height="wrap_content"
-                android:layout_marginLeft="@dimen/content_padding"
-                android:layout_weight="1"
-                android:orientation="vertical"
-	            android:layout_marginStart="@dimen/content_padding">
-
-                <TextView
-                    android:id="@+id/category_caption"
-                    android:layout_width="wrap_content"
-                    android:layout_height="wrap_content"
-                    android:layout_marginLeft="@dimen/content_padding_small"
-                    android:layout_marginRight="@dimen/content_padding_small"
-                    android:text="@string/favourites_edit_dialog_category"
-                    android:textColor="?android:textColorSecondary"
-                    android:textSize="@dimen/default_sub_text_size"
-	                android:layout_marginEnd="@dimen/content_padding_small"
-	                android:layout_marginStart="@dimen/content_padding_small" />
-
-                <net.osmand.plus.widgets.AutoCompleteTextViewEx
-                    android:id="@+id/category_edit"
-                    android:layout_width="fill_parent"
-                    android:layout_height="wrap_content"
-                    android:layout_marginLeft="@dimen/content_padding_half"
-                    android:layout_marginRight="@dimen/content_padding"
-                    android:layout_marginTop="@dimen/content_padding_half"
-                    android:focusable="false"
-                    osmand:drawableRightCompat="@drawable/ic_action_arrow_drop_down"
-                    osmand:drawableEndCompat="@drawable/ic_action_arrow_drop_down"
-                    android:text="@string/shared_string_favorites"
-                    android:editable="false"
-	                android:layout_marginStart="@dimen/content_padding_half"
-	                android:layout_marginEnd="@dimen/content_padding" />
-
-            </LinearLayout>
-
-        </LinearLayout>
-
-        <TextView
-            android:layout_width="wrap_content"
-            android:layout_height="wrap_content"
-            android:layout_marginLeft="68dp"
-            android:layout_marginRight="@dimen/content_padding"
-            android:text="@string/quick_action_gpx_category_descr"
-            android:textColor="?android:textColorSecondary"
-            android:textSize="@dimen/default_sub_text_size"
-            android:layout_marginBottom="@dimen/content_padding"
-	        android:layout_marginEnd="@dimen/content_padding"
-	        android:layout_marginStart="68dp" />
-
-    </LinearLayout>
-
-    <androidx.appcompat.widget.AppCompatImageView
-        android:layout_width="match_parent"
-        android:layout_height="wrap_content"
-        android:layout_gravity="top"
-        android:scaleType="fitXY"
-        osmand:srcCompat="@drawable/bg_shadow_list_bottom" />
+	xmlns:osmand="http://schemas.android.com/apk/res-auto"
+	xmlns:tools="http://schemas.android.com/tools"
+	android:orientation="vertical"
+	android:layout_width="match_parent"
+	android:layout_height="match_parent">
+
+	<View
+		android:layout_width="match_parent"
+		android:layout_height="@dimen/content_padding"
+		android:layout_gravity="bottom"
+		android:foreground="@drawable/bg_contextmenu_shadow_top_light" />
+
+	<LinearLayout
+		android:layout_width="match_parent"
+		android:layout_height="wrap_content"
+		android:orientation="vertical"
+		android:background="?attr/list_background_color">
+
+		<net.osmand.plus.widgets.TextViewEx
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:layout_marginStart="@dimen/content_padding"
+			android:layout_marginTop="@dimen/content_padding_small"
+			android:layout_marginEnd="@dimen/content_padding"
+			android:text="@string/track_file"
+			android:textColor="?android:textColorPrimary"
+			android:textSize="@dimen/default_list_text_size"
+			android:letterSpacing="@dimen/text_button_letter_spacing"
+			osmand:typeface="@string/font_roboto_medium"
+			osmand:lineHeight="@dimen/default_title_line_height"/>
+
+		<include
+			android:id="@+id/track_toggle"
+			layout="@layout/custom_radio_buttons"
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:layout_marginStart="@dimen/content_padding"
+			android:layout_marginTop="@dimen/content_padding_small"
+			android:layout_marginEnd="@dimen/content_padding" />
+
+		<net.osmand.plus.widgets.TextViewEx
+			android:id="@+id/always_ask_track_file"
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:layout_marginStart="@dimen/content_padding"
+			android:layout_marginTop="@dimen/content_padding_small"
+			android:layout_marginEnd="@dimen/content_padding"
+			android:text="@string/track_file_description"
+			android:textColor="?android:textColorSecondary"
+			android:textSize="@dimen/default_list_text_size"
+			android:letterSpacing="@dimen/description_letter_spacing"
+			osmand:typeface="@string/font_roboto_regular"
+			osmand:lineHeight="@dimen/default_desc_line_height" />
+
+		<LinearLayout
+			android:id="@+id/selected_track_file_container"
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:orientation="vertical">
+
+			<include
+				layout="@layout/gpx_track_select_item"
+				android:layout_width="match_parent"
+				android:layout_height="wrap_content"
+				android:layout_marginEnd="@dimen/content_padding" />
+
+			<FrameLayout
+				android:id="@+id/select_another_track_button_container"
+				android:layout_width="wrap_content"
+				android:layout_height="wrap_content"
+				android:layout_marginStart="@dimen/fab_margin_bottom_big"
+				android:layout_marginEnd="@dimen/content_padding">
+
+				<net.osmand.plus.widgets.TextViewEx
+					android:id="@+id/select_another_track_button"
+					android:layout_width="wrap_content"
+					android:layout_height="wrap_content"
+					android:paddingStart="@dimen/content_padding"
+					android:paddingTop="@dimen/content_padding_half"
+					android:paddingEnd="@dimen/content_padding"
+					android:paddingBottom="@dimen/content_padding_half"
+					android:text="@string/select_another_track"
+					android:textColor="?attr/colorPrimary"
+					android:textSize="@dimen/default_desc_text_size"
+					android:letterSpacing="@dimen/description_letter_spacing"
+					osmand:typeface="@string/font_roboto_medium"
+					tools:background="@drawable/btn_solid_border_light" />
+
+			</FrameLayout>
+
+		</LinearLayout>
+
+		<View
+			android:layout_width="match_parent"
+			android:layout_height="1dp"
+			android:layout_marginTop="@dimen/content_padding_small"
+			android:background="?attr/divider_color" />
+
+		<net.osmand.plus.widgets.TextViewEx
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:layout_marginStart="@dimen/content_padding"
+			android:layout_marginTop="@dimen/content_padding_small"
+			android:layout_marginEnd="@dimen/content_padding"
+			android:text="@string/waypoint_appearance"
+			android:textColor="?android:textColorPrimary"
+			android:textSize="@dimen/default_list_text_size"
+			android:letterSpacing="@dimen/text_button_letter_spacing"
+			osmand:typeface="@string/font_roboto_medium"
+			osmand:lineHeight="@dimen/default_title_line_height"/>
+
+		<include
+			android:id="@+id/appearance_toggle"
+			layout="@layout/custom_radio_buttons"
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:layout_marginStart="@dimen/content_padding"
+			android:layout_marginTop="@dimen/content_padding_small"
+			android:layout_marginEnd="@dimen/content_padding" />
+
+		<net.osmand.plus.widgets.TextViewEx
+			android:id="@+id/always_ask_waypoint_appearance"
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:layout_marginStart="@dimen/content_padding"
+			android:layout_marginTop="@dimen/content_padding_small"
+			android:layout_marginEnd="@dimen/content_padding"
+			android:layout_marginBottom="@dimen/content_padding_small"
+			android:text="@string/always_ask_waypoint_appearance_description"
+			android:textColor="?android:textColorSecondary"
+			android:textSize="@dimen/default_list_text_size"
+			android:letterSpacing="@dimen/description_letter_spacing"
+			osmand:typeface="@string/font_roboto_regular"
+			osmand:lineHeight="@dimen/default_desc_line_height" />
+
+		<LinearLayout
+			android:id="@+id/predefined_appearance_container"
+			android:layout_width="match_parent"
+			android:layout_height="wrap_content"
+			android:orientation="vertical">
+
+			<net.osmand.plus.widgets.TextViewEx
+				android:layout_width="match_parent"
+				android:layout_height="wrap_content"
+				android:layout_marginStart="@dimen/content_padding"
+				android:layout_marginTop="@dimen/content_padding_small"
+				android:layout_marginEnd="@dimen/content_padding"
+				android:text="@string/predefined_waypoint_appearance_description"
+				android:textColor="?android:textColorSecondary"
+				android:textSize="@dimen/default_list_text_size"
+				android:letterSpacing="@dimen/description_letter_spacing"
+				osmand:typeface="@string/font_roboto_regular"
+				osmand:lineHeight="@dimen/default_desc_line_height" />
+
+			<LinearLayout
+				android:layout_width="match_parent"
+				android:layout_height="wrap_content"
+				android:layout_marginStart="@dimen/content_padding_small"
+				android:layout_marginTop="@dimen/content_padding_small"
+				android:layout_marginEnd="@dimen/content_padding"
+				android:layout_marginBottom="@dimen/content_padding"
+				android:orientation="horizontal">
+
+				<androidx.appcompat.widget.AppCompatImageView
+					android:id="@+id/predefined_icon"
+					android:layout_width="@dimen/favorites_my_places_icon_size"
+					android:layout_height="@dimen/favorites_my_places_icon_size"
+					android:layout_gravity="start|center_vertical"
+					tools:srcCompat="@drawable/ic_action_home_dark" />
+
+				<LinearLayout
+					android:layout_width="0dp"
+					android:layout_height="wrap_content"
+					android:layout_weight="1"
+					android:layout_marginStart="@dimen/list_content_padding_large"
+					android:layout_gravity="start|center_vertical"
+					android:orientation="vertical">
+
+					<net.osmand.plus.widgets.TextViewEx
+						android:id="@+id/predefined_title"
+						android:layout_width="wrap_content"
+						android:layout_height="wrap_content"
+						android:ellipsize="end"
+						android:maxLines="1"
+						android:textColor="?android:textColorPrimary"
+						android:textSize="@dimen/default_list_text_size"
+						android:letterSpacing="@dimen/text_button_letter_spacing"
+						osmand:typeface="@string/font_roboto_regular"
+						osmand:lineHeight="@dimen/default_title_line_height"
+						tools:text="Address or place name" />
+
+					<net.osmand.plus.widgets.TextViewEx
+						android:id="@+id/predefined_category_name"
+						android:layout_width="wrap_content"
+						android:layout_height="wrap_content"
+						android:layout_marginTop="@dimen/favorites_icon_padding"
+						android:drawablePadding="@dimen/content_padding_small_half"
+						android:textColor="?android:textColorSecondary"
+						android:textSize="@dimen/default_desc_text_size"
+						android:letterSpacing="@dimen/description_letter_spacing"
+						osmand:typeface="@string/font_roboto_regular"
+						osmand:lineHeight="@dimen/default_desc_line_height"
+						osmand:drawableStartCompat="@drawable/ic_action_group_name_16"
+						osmand:drawableTint="?default_icon_color"
+						tools:text="Some group" />
+
+				</LinearLayout>
+
+				<FrameLayout
+					android:id="@+id/edit_appearance_button_container"
+					android:layout_width="wrap_content"
+					android:layout_height="wrap_content"
+					android:layout_gravity="end|center_vertical"
+					android:layout_marginStart="@dimen/content_padding">
+
+					<androidx.appcompat.widget.AppCompatImageView
+						android:id="@+id/edit_appearance_button"
+						android:layout_width="wrap_content"
+						android:layout_height="wrap_content"
+						android:paddingStart="@dimen/content_padding"
+						android:paddingTop="@dimen/content_padding_half"
+						android:paddingEnd="@dimen/content_padding"
+						android:paddingBottom="@dimen/content_padding_half"
+						android:tint="?active_color_basic"
+						osmand:srcCompat="@drawable/ic_action_edit_dark" />
+
+				</FrameLayout>
+
+			</LinearLayout>
+
+		</LinearLayout>
+
+	</LinearLayout>
+
+	<View
+		android:layout_width="match_parent"
+		android:layout_height="@dimen/content_padding"
+		android:foregroundGravity="fill_horizontal|top"
+		android:foreground="@drawable/bg_contextmenu_shadow" />
 
 </LinearLayout>
\ No newline at end of file
diff --git a/OsmAnd/res/values/strings.xml b/OsmAnd/res/values/strings.xml
index 22f0592e6a8..8b5917448fd 100644
--- a/OsmAnd/res/values/strings.xml
+++ b/OsmAnd/res/values/strings.xml
@@ -11,6 +11,11 @@
 	Thx - Hardy
 -->
 
+    <string name="predefined_waypoint_appearance_description">Taping on the action will automatically save waypoint with predefined parameters.</string>
+    <string name="always_ask_waypoint_appearance_description">Taping on action will open “Add waypoint” screen, where you can change name and appearance.</string>
+    <string name="waypoint_appearance">Waypoint appearance</string>
+    <string name="track_file_description">Taping on action will show a dialogue with all available tracks to be selected.</string>
+    <string name="track_file">Track file</string>
     <string name="gps_filter_precision">GPS precision</string>
     <string name="shared_string_precision">Precision</string>
     <string name="shared_string_statistics">Statistics</string>
diff --git a/OsmAnd/src/net/osmand/plus/quickaction/actions/GPXAction.java b/OsmAnd/src/net/osmand/plus/quickaction/actions/GPXAction.java
index 2c1be325f7b..3f028f9d17c 100644
--- a/OsmAnd/src/net/osmand/plus/quickaction/actions/GPXAction.java
+++ b/OsmAnd/src/net/osmand/plus/quickaction/actions/GPXAction.java
@@ -2,37 +2,70 @@
 
 import android.app.Dialog;
 import android.app.ProgressDialog;
+import android.content.Context;
+import android.content.res.ColorStateList;
+import android.graphics.Typeface;
+import android.graphics.drawable.Drawable;
 import android.view.LayoutInflater;
 import android.view.View;
 import android.view.ViewGroup;
-import android.widget.EditText;
 import android.widget.ImageView;
-
-import androidx.annotation.NonNull;
-import androidx.appcompat.widget.SwitchCompat;
-
+import android.widget.LinearLayout;
+import android.widget.TextView;
+
+import net.osmand.AndroidUtils;
+import net.osmand.GPXUtilities;
+import net.osmand.GPXUtilities.GPXTrackAnalysis;
+import net.osmand.GPXUtilities.WptPt;
+import net.osmand.data.FavouritePoint.BackgroundType;
 import net.osmand.data.LatLon;
+import net.osmand.plus.ColorUtilities;
+import net.osmand.plus.GPXDatabase.GpxDataItem;
 import net.osmand.plus.GeocodingLookupService;
+import net.osmand.plus.GpxDbHelper.GpxDataItemCallback;
+import net.osmand.plus.GpxSelectionHelper.SelectedGpxFile;
+import net.osmand.plus.OsmAndFormatter;
+import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.R;
+import net.osmand.plus.UiUtilities;
 import net.osmand.plus.activities.MapActivity;
-import net.osmand.plus.mapcontextmenu.editors.EditCategoryDialogFragment;
-import net.osmand.plus.mapcontextmenu.editors.SelectCategoryDialogFragment;
-import net.osmand.plus.mapcontextmenu.editors.SelectFavoriteCategoryBottomSheet;
+import net.osmand.plus.base.PointImageDrawable;
+import net.osmand.plus.helpers.AndroidUiHelper;
+import net.osmand.plus.helpers.ColorDialogs;
+import net.osmand.plus.helpers.GpxUiHelper;
 import net.osmand.plus.quickaction.QuickAction;
 import net.osmand.plus.quickaction.QuickActionType;
-import net.osmand.plus.widgets.AutoCompleteTextViewEx;
+import net.osmand.plus.render.RenderingIcons;
+import net.osmand.plus.widgets.multistatetoggle.RadioItem.OnRadioItemClickListener;
+import net.osmand.plus.widgets.multistatetoggle.TextToggleButton;
+import net.osmand.plus.widgets.multistatetoggle.TextToggleButton.TextRadioItem;
+import net.osmand.util.Algorithms;
+
+import java.io.File;
+
+import androidx.annotation.ColorInt;
+import androidx.annotation.NonNull;
+import androidx.core.widget.TextViewCompat;
 
 public class GPXAction extends QuickAction {
 
-	public static final QuickActionType TYPE = new QuickActionType(6,
-			"gpx.add", GPXAction.class).
-			nameRes(R.string.quick_action_add_gpx).iconRes(R.drawable.ic_action_gnew_label_dark).
-			category(QuickActionType.CREATE_CATEGORY);
+	public static final QuickActionType TYPE = new QuickActionType(6, "gpx.add", GPXAction.class)
+			.nameRes(R.string.quick_action_add_gpx)
+			.iconRes(R.drawable.ic_action_gnew_label_dark)
+			.category(QuickActionType.CREATE_CATEGORY);
+
+	private static final String KEY_USE_SELECTED_GPX_FILE = "use_selected_gpx_file";
+	private static final String KEY_GPX_FILE_PATH = "gpx_file_path";
 
-	public static final String KEY_NAME = "name";
-	public static final String KEY_DIALOG = "dialog";
-	public static final String KEY_CATEGORY_NAME = "category_name";
-	public static final String KEY_CATEGORY_COLOR = "category_color";
+	private static final String KEY_USE_PREDEFINED_WPT_APPEARANCE = "use_predefined_appearance";
+	private static final String KEY_PREDEFINED_WPT_NAME = "name";
+	private static final String KEY_PREDEFINED_WPT_DESCRIPTION = "predefined_wpt_description";
+	private static final String KEY_PREDEFINED_WPT_COLOR = "predefined_wpt_color";
+	private static final String KEY_PREDEFINED_WPT_ICON = "predefined_wpt_icon";
+	private static final String KEY_PREDEFINED_WPT_BACKGROUND_TYPE = "predefined_wpt_background_type";
+
+	private static final String KEY_PREDEFINED_CATEGORY_NAME = "category_name";
+	private static final String KEY_PREDEFINED_CATEGORY_COLOR = "category_color";
 
 	public GPXAction() {
 		super(TYPE);
@@ -49,7 +82,7 @@ public void execute(@NonNull final MapActivity mapActivity) {
 				.getCurrentRotatedTileBox()
 				.getCenterLatLon();
 
-		final String title = getParams().get(KEY_NAME);
+		final String title = getParams().get(KEY_PREDEFINED_WPT_NAME);
 
 		if (title == null || title.isEmpty()) {
 
@@ -67,9 +100,9 @@ public void geocodingDone(String address) {
 
 							progressDialog.dismiss();
 							mapActivity.getContextMenu().addWptPt(latLon, address,
-									getParams().get(KEY_CATEGORY_NAME),
-									Integer.valueOf(getParams().get(KEY_CATEGORY_COLOR)),
-									!Boolean.valueOf(getParams().get(KEY_DIALOG)));
+									getParams().get(KEY_PREDEFINED_CATEGORY_NAME),
+									Integer.valueOf(getParams().get(KEY_PREDEFINED_CATEGORY_COLOR)),
+									false);
 						}
 
 					}, null);
@@ -77,114 +110,285 @@ public void geocodingDone(String address) {
 			mapActivity.getMyApplication().getGeocodingLookupService().lookupAddress(lookupRequest);
 
 		} else mapActivity.getContextMenu().addWptPt(latLon, title,
-				getParams().get(KEY_CATEGORY_NAME),
-				Integer.valueOf(getParams().get(KEY_CATEGORY_COLOR)),
-				!Boolean.valueOf(getParams().get(KEY_DIALOG)));
+				getParams().get(KEY_PREDEFINED_CATEGORY_NAME),
+				Integer.valueOf(getParams().get(KEY_PREDEFINED_CATEGORY_COLOR)), false);
 	}
 
 	@Override
 	public void drawUI(@NonNull final ViewGroup parent, @NonNull final MapActivity mapActivity) {
-
-		final View root = LayoutInflater.from(parent.getContext())
+		View root = LayoutInflater.from(parent.getContext())
 				.inflate(R.layout.quick_action_add_gpx, parent, false);
-
 		parent.addView(root);
 
-		AutoCompleteTextViewEx categoryEdit = (AutoCompleteTextViewEx) root.findViewById(R.id.category_edit);
-		SwitchCompat showDialog = (SwitchCompat) root.findViewById(R.id.saveButton);
-		ImageView categoryImage = (ImageView) root.findViewById(R.id.category_image);
-		EditText name = (EditText) root.findViewById(R.id.name_edit);
-
-		if (!getParams().isEmpty()) {
-
-			showDialog.setChecked(Boolean.valueOf(getParams().get(KEY_DIALOG)));
-			categoryImage.setColorFilter(Integer.valueOf(getParams().get(KEY_CATEGORY_COLOR)));
-			name.setText(getParams().get(KEY_NAME));
-			categoryEdit.setText(getParams().get(KEY_CATEGORY_NAME));
+		setupTrackToggleButton(root, mapActivity);
+		setupWaypointAppearanceToggle(root, mapActivity);
+	}
 
-			if (getParams().get(KEY_NAME).isEmpty() && Integer.valueOf(getParams().get(KEY_CATEGORY_COLOR)) == 0) {
+	private void setupTrackToggleButton(@NonNull View container, @NonNull MapActivity mapActivity) {
+		OsmandApplication app = mapActivity.getMyApplication();
+		boolean night = app.getDaynightHelper().isNightModeForMapControls();
+		LinearLayout trackToggle = container.findViewById(R.id.track_toggle);
+		TextToggleButton trackToggleButton = new TextToggleButton(app, trackToggle, night);
 
-				categoryEdit.setText("");
-				categoryImage.setColorFilter(mapActivity.getResources().getColor(R.color.icon_color_default_light));
-			}
+		TextRadioItem alwaysAskButton = new TextRadioItem(app.getString(R.string.confirm_every_run));
+		TextRadioItem selectTrackButton = new TextRadioItem(app.getString(R.string.shared_string_select));
 
-		} else {
+		alwaysAskButton.setOnClickListener(getOnTrackToggleButtonClicked(container, true, mapActivity));
+		selectTrackButton.setOnClickListener(getOnTrackToggleButtonClicked(container, false, mapActivity));
 
-			categoryEdit.setText("");
-			categoryImage.setColorFilter(mapActivity.getResources().getColor(R.color.icon_color_default_light));
+		trackToggleButton.setItems(alwaysAskButton, selectTrackButton);
+		trackToggleButton.setSelectedItem(shouldUseSelectedGpxFile() ? selectTrackButton : alwaysAskButton);
+		updateTrackBottomInfo(container, !shouldUseSelectedGpxFile());
 
-			getParams().put(KEY_CATEGORY_NAME, "");
-			getParams().put(KEY_CATEGORY_COLOR, "0");
+		setupSelectAnotherTrackButton(container, night, mapActivity);
+		if (shouldUseSelectedGpxFile()) {
+			setupGpxTrackInfo(container, app);
 		}
+	}
 
-		categoryEdit.setOnClickListener(new View.OnClickListener() {
-			@Override
-			public void onClick(final View view) {
+	@NonNull
+	private OnRadioItemClickListener getOnTrackToggleButtonClicked(@NonNull View container, boolean alwaysAsk,
+	                                                               @NonNull MapActivity mapActivity) {
+		return (radioItem, view) -> {
+			if (alwaysAsk) {
+				updateTrackBottomInfo(container, true);
+			} else {
+				if (shouldUseSelectedGpxFile()) {
+					updateTrackBottomInfo(container, false);
+				} else {
+					showSelectTrackFileDialog(mapActivity);
+					return false;
+				}
+			}
+			return true;
+		};
+	}
 
-				SelectFavoriteCategoryBottomSheet dialogFragment = SelectFavoriteCategoryBottomSheet.createInstance("", "");
+	private void updateTrackBottomInfo(@NonNull View container, boolean alwaysAsk) {
+		AndroidUiHelper.updateVisibility(container.findViewById(R.id.always_ask_track_file), alwaysAsk);
+		AndroidUiHelper.updateVisibility(container.findViewById(R.id.selected_track_file_container), !alwaysAsk);
+	}
 
-				dialogFragment.show(
-						mapActivity.getSupportFragmentManager(),
-						SelectFavoriteCategoryBottomSheet.TAG);
+	private void setupSelectAnotherTrackButton(@NonNull View container, boolean night, @NonNull MapActivity mapActivity) {
+		View selectAnotherTrackButtonContainer = container.findViewById(R.id.select_another_track_button_container);
+		View selectAnotherTrackButton = container.findViewById(R.id.select_another_track_button);
 
-				dialogFragment.setSelectionListener(new SelectFavoriteCategoryBottomSheet.CategorySelectionListener() {
-					@Override
-					public void onCategorySelected(String category, int color) {
+		AndroidUtils.setBackground(container.getContext(), selectAnotherTrackButtonContainer, night,
+				R.drawable.ripple_light, R.drawable.ripple_dark);
+		AndroidUtils.setBackground(container.getContext(), selectAnotherTrackButton, night,
+				R.drawable.btn_solid_border_light, R.drawable.btn_solid_border_light);
 
-						fillGroupParams(root, category, color);
-					}
-				});
-			}
-		});
+		selectAnotherTrackButtonContainer.setOnClickListener(v -> showSelectTrackFileDialog(mapActivity));
+	}
 
-		SelectFavoriteCategoryBottomSheet dialogFragment = (SelectFavoriteCategoryBottomSheet)
-				mapActivity.getSupportFragmentManager().findFragmentByTag(SelectCategoryDialogFragment.TAG);
+	private void setupGpxTrackInfo(@NonNull final View container, @NonNull final OsmandApplication app) {
+		String gpxFilePath = getParams().get(KEY_GPX_FILE_PATH);
+		if (gpxFilePath == null) {
+			return;
+		}
 
-		if (dialogFragment != null) {
+		View trackInfoContainer = container.findViewById(R.id.selected_track_file_container);
 
-			dialogFragment.setSelectionListener(new SelectFavoriteCategoryBottomSheet.CategorySelectionListener() {
+		File file = new File(gpxFilePath);
+		String gpxName = GpxUiHelper.getGpxTitle(file.getName());
+		SelectedGpxFile selectedGpxFile = app.getSelectedGpxHelper().getSelectedFileByPath(gpxFilePath);
+		if (selectedGpxFile != null) {
+			setupGpxTrackInfo(trackInfoContainer, gpxName, selectedGpxFile.getTrackAnalysis(app), app);
+		} else {
+			GpxDataItem gpxDataItem = app.getGpxDbHelper().getItem(file, new GpxDataItemCallback() {
 				@Override
-				public void onCategorySelected(String category, int color) {
+				public boolean isCancelled() {
+					return false;
+				}
 
-					fillGroupParams(root, category, color);
+				@Override
+				public void onGpxDataItemReady(GpxDataItem item) {
+					if (item != null && item.getAnalysis() != null) {
+						setupGpxTrackInfo(trackInfoContainer, gpxName, item.getAnalysis(), app);
+					}
 				}
 			});
 
+			if (gpxDataItem != null && gpxDataItem.getAnalysis() != null) {
+				setupGpxTrackInfo(trackInfoContainer, gpxName, gpxDataItem.getAnalysis(), app);
+			}
+		}
+	}
+
+	private void setupGpxTrackInfo(@NonNull View trackInfoContainer,
+	                               @NonNull String gpxName,
+	                               @NonNull GPXTrackAnalysis analysis,
+	                               @NonNull OsmandApplication app) {
+		UiUtilities iconsCache = app.getUIUtilities();
+
+		TextView name = trackInfoContainer.findViewById(R.id.name);
+		name.setText(gpxName);
+		name.setTypeface(Typeface.DEFAULT, Typeface.NORMAL);
+
+		ImageView trackIcon = trackInfoContainer.findViewById(R.id.icon);
+		trackIcon.setImageDrawable(iconsCache.getThemedIcon(R.drawable.ic_action_polygom_dark));
+
+		ImageView distanceIcon = trackInfoContainer.findViewById(R.id.distance_icon);
+		TextView distanceText = trackInfoContainer.findViewById(R.id.distance);
+		distanceIcon.setImageDrawable(iconsCache.getThemedIcon(R.drawable.ic_action_distance_16));
+		distanceText.setText(OsmAndFormatter.getFormattedDistance(analysis.totalDistance, app));
+
+		ImageView waypointsIcon = trackInfoContainer.findViewById(R.id.points_icon);
+		TextView waypointsCountText = trackInfoContainer.findViewById(R.id.points_count);
+		waypointsIcon.setImageDrawable(iconsCache.getThemedIcon(R.drawable.ic_action_waypoint_16));
+		waypointsCountText.setText(String.valueOf(analysis.wptPoints));
+
+		ImageView timeIcon = trackInfoContainer.findViewById(R.id.time_icon);
+		if (analysis.isTimeSpecified()) {
+			AndroidUiHelper.updateVisibility(timeIcon, true);
+			timeIcon.setImageDrawable(iconsCache.getThemedIcon(R.drawable.ic_action_time_16));
+
+			TextView timeText = trackInfoContainer.findViewById(R.id.time);
+			int duration = (int) (analysis.timeSpan / 1000);
+			timeText.setText(Algorithms.formatDuration(duration, app.accessibilityEnabled()));
 		} else {
+			AndroidUiHelper.updateVisibility(timeIcon, false);
+		}
+	}
 
-			EditCategoryDialogFragment dialog = (EditCategoryDialogFragment)
-					mapActivity.getSupportFragmentManager().findFragmentByTag(EditCategoryDialogFragment.TAG);
+	private void showSelectTrackFileDialog(@NonNull MapActivity mapActivity) {
+		// TODO
+	}
 
-			if (dialog != null) {
+	private void setupWaypointAppearanceToggle(@NonNull View container, @NonNull MapActivity mapActivity) {
+		OsmandApplication app = mapActivity.getMyApplication();
+		boolean night = app.getDaynightHelper().isNightModeForMapControls();
+		boolean usePredefinedAppearance = Boolean.parseBoolean(getParams().get(KEY_USE_PREDEFINED_WPT_APPEARANCE));
+		LinearLayout appearanceToggle = container.findViewById(R.id.appearance_toggle);
+		TextToggleButton appearanceToggleButton = new TextToggleButton(app, appearanceToggle, night);
 
-				dialogFragment.setSelectionListener(new SelectFavoriteCategoryBottomSheet.CategorySelectionListener() {
-					@Override
-					public void onCategorySelected(String category, int color) {
+		TextRadioItem alwaysAskButton = new TextRadioItem(app.getString(R.string.confirm_every_run));
+		TextRadioItem predefinedAppearanceButton = new TextRadioItem(app.getString(R.string.shared_string_predefined));
 
-						fillGroupParams(root, category, color);
-					}
-				});
+		alwaysAskButton.setOnClickListener(getOnAppearanceToggleButtonClicked(container, true, night));
+		predefinedAppearanceButton.setOnClickListener(getOnAppearanceToggleButtonClicked(container, false, night));
+
+		appearanceToggleButton.setItems(alwaysAskButton, predefinedAppearanceButton);
+		TextRadioItem selectedItem = usePredefinedAppearance ? predefinedAppearanceButton : alwaysAskButton;
+		appearanceToggleButton.setSelectedItem(selectedItem);
+		updateAppearanceBottomInfo(container, !usePredefinedAppearance, night);
+	}
+
+	@NonNull
+	private OnRadioItemClickListener getOnAppearanceToggleButtonClicked(@NonNull View container, boolean alwaysAsk, boolean night) {
+		return (radioItem, view) -> {
+			if (alwaysAsk) {
+				updateAppearanceBottomInfo(container, true, night);
+			} else {
+				if (hasPredefinedWaypointAppearance()) {
+					updateAppearanceBottomInfo(container, false, night);
+				} else {
+					// todo: open edit favorite dialog
+					return false;
+				}
 			}
+			return true;
+		};
+	}
+
+	private void updateAppearanceBottomInfo(@NonNull View container, boolean alwaysAsk, boolean night) {
+		Context context = container.getContext();
+
+		AndroidUiHelper.updateVisibility(container.findViewById(R.id.always_ask_waypoint_appearance), alwaysAsk);
+		AndroidUiHelper.updateVisibility(container.findViewById(R.id.predefined_appearance_container), !alwaysAsk);
+
+		if (!alwaysAsk) {
+			WptPt waypoint = createWaypointFromParams();
+
+			ImageView predefinedIcon = container.findViewById(R.id.predefined_icon);
+			Drawable icon = PointImageDrawable.getFromWpt(context, waypoint.getColor(),
+					false, waypoint);
+			predefinedIcon.setImageDrawable(icon);
+
+			TextView predefinedTitle = container.findViewById(R.id.predefined_title);
+			String waypointName = waypoint.name;
+			String title = Algorithms.isEmpty(waypointName) ? context.getString(R.string.address) : waypointName;
+			predefinedTitle.setText(title);
+
+			TextView predefinedCategoryName = container.findViewById(R.id.predefined_category_name);
+			String categoryName = Algorithms.isEmpty(waypoint.category) ? "" : waypoint.category;
+			predefinedCategoryName.setText(categoryName);
+			ColorStateList categoryIconTint = ColorStateList.valueOf(getCategoryColorFromParams(context, night));
+			TextViewCompat.setCompoundDrawableTintList(predefinedCategoryName, categoryIconTint);
+
+			View editAppearanceButtonContainer = container.findViewById(R.id.edit_appearance_button_container);
+			View editAppearanceButton = container.findViewById(R.id.edit_appearance_button);
+
+			AndroidUtils.setBackground(context, editAppearanceButtonContainer, night,
+					R.drawable.ripple_oval_light, R.drawable.ripple_oval_dark);
+			AndroidUtils.setBackground(context, editAppearanceButton, night,
+					R.drawable.btn_oval_blue, R.drawable.btn_oval_orange);
 		}
 	}
 
-	@Override
-	public boolean fillParams(@NonNull View root, @NonNull MapActivity mapActivity) {
+	private boolean shouldUseSelectedGpxFile() {
+		boolean useSelectedGpxFile = Boolean.parseBoolean(getParams().get(KEY_USE_SELECTED_GPX_FILE));
+		String gpxFilePath = getParams().get(KEY_GPX_FILE_PATH);
+		boolean gpxFileExist = gpxFilePath != null && (gpxFilePath.isEmpty() || new File(gpxFilePath).exists());
+		return useSelectedGpxFile && gpxFileExist;
+	}
 
-		getParams().put(KEY_NAME, ((EditText) root.findViewById(R.id.name_edit)).getText().toString());
-		getParams().put(KEY_DIALOG, Boolean.toString(((SwitchCompat) root.findViewById(R.id.saveButton)).isChecked()));
+	private boolean hasPredefinedWaypointAppearance() {
+		return getParams().containsKey(KEY_PREDEFINED_WPT_COLOR);
+	}
 
-		return true;
+	@NonNull
+	private WptPt createWaypointFromParams() {
+		WptPt waypoint = new WptPt();
+		waypoint.name = getParams().get(KEY_PREDEFINED_WPT_NAME);
+		waypoint.desc = getParams().get(KEY_PREDEFINED_WPT_DESCRIPTION);
+		waypoint.category = getParams().get(KEY_PREDEFINED_CATEGORY_NAME);
+		waypoint.setColor(getWaypointColorFromParams());
+		waypoint.setIconName(getIconNameFromParams());
+		waypoint.setBackgroundType(getBackgroundTypeFromParams());
+		return waypoint;
+	}
+
+	@ColorInt
+	private int getWaypointColorFromParams() {
+		return getColorFromParams(KEY_PREDEFINED_WPT_COLOR, ColorDialogs.pallette[0]);
+	}
+
+	@NonNull
+	private String getIconNameFromParams() {
+		String iconName = getParams().get(KEY_PREDEFINED_WPT_ICON);
+		return Algorithms.isEmpty(iconName) || !RenderingIcons.containsBigIcon(iconName)
+				? GPXUtilities.DEFAULT_ICON_NAME
+				: iconName;
 	}
 
-	private void fillGroupParams(View root, String name, int color) {
+	@NonNull
+	private String getBackgroundTypeFromParams() {
+		String backgroundType = getParams().get(KEY_PREDEFINED_WPT_BACKGROUND_TYPE);
+		return BackgroundType.getByTypeName(backgroundType, BackgroundType.CIRCLE).getTypeName();
+	}
 
-		if (color == 0) color = root.getContext().getResources().getColor(R.color.icon_color_default_light);
+	@ColorInt
+	private int getCategoryColorFromParams(@NonNull Context context, boolean night) {
+		int defaultColor = ColorUtilities.getDefaultIconColor(context, night);
+		return getColorFromParams(KEY_PREDEFINED_CATEGORY_COLOR, defaultColor);
+	}
 
-		((AutoCompleteTextViewEx) root.findViewById(R.id.category_edit)).setText(name);
-		((ImageView) root.findViewById(R.id.category_image)).setColorFilter(color);
+	@ColorInt
+	private int getColorFromParams(@NonNull String key, @ColorInt int defaultColor) {
+		String colorStr = getParams().get(key);
+		if (Algorithms.isEmpty(colorStr)) {
+			return defaultColor;
+		}
+		try {
+			return Integer.parseInt(colorStr);
+		} catch (NumberFormatException e) {
+			return defaultColor;
+		}
+	}
 
-		getParams().put(KEY_CATEGORY_NAME, name);
-		getParams().put(KEY_CATEGORY_COLOR, String.valueOf(color));
+	@Override
+	public boolean fillParams(@NonNull View root, @NonNull MapActivity mapActivity) {
+		return true;
 	}
-}
+}
\ No newline at end of file
