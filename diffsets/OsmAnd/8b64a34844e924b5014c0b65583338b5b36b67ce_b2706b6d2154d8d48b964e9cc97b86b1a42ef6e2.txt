diff --git a/OsmAnd-shared/src/commonMain/kotlin/net/osmand/shared/grid/ButtonPositionSize.kt b/OsmAnd-shared/src/commonMain/kotlin/net/osmand/shared/grid/ButtonPositionSize.kt
index 0dedc6ce57c..0115d907115 100644
--- a/OsmAnd-shared/src/commonMain/kotlin/net/osmand/shared/grid/ButtonPositionSize.kt
+++ b/OsmAnd-shared/src/commonMain/kotlin/net/osmand/shared/grid/ButtonPositionSize.kt
@@ -187,9 +187,17 @@ class ButtonPositionSize {
 		}
 		val xMoveIndicator = if (xMove) "+" else " "
 		val yMoveIndicator = if (yMove) "+" else " "
+
+		val moveDescendantsStr = when (moveDescendants) {
+			MOVE_DESCENDANTS_VERTICAL -> "vertical"
+			MOVE_DESCENDANTS_HORIZONTAL -> "horizontal"
+			else -> "any"
+		}
+
 		val paddedWidth = width.toString().padStart(2)
 		val paddedHeight = height.toString().padStart(2)
-		return "Pos ${id.padStart(10)} x=($posHStr->${marginX}$xMoveIndicator), y=($posVStr->${marginY}$yMoveIndicator), w=$paddedWidth, h=$paddedHeight"
+
+		return "Pos ${id.padStart(10)} x=($posHStr->${marginX}$xMoveIndicator), y=($posVStr->${marginY}$yMoveIndicator), w=$paddedWidth, h=$paddedHeight, move=$moveDescendantsStr"
 	}
 
 	fun overlap(position: ButtonPositionSize): Boolean {
diff --git a/OsmAnd-shared/src/commonTest/kotlin/net/osmand/shared/grid/ButtonPositionSizeTest.kt b/OsmAnd-shared/src/commonTest/kotlin/net/osmand/shared/grid/ButtonPositionSizeTest.kt
index 2daeb5c427a..5fe0a3598fe 100644
--- a/OsmAnd-shared/src/commonTest/kotlin/net/osmand/shared/grid/ButtonPositionSizeTest.kt
+++ b/OsmAnd-shared/src/commonTest/kotlin/net/osmand/shared/grid/ButtonPositionSizeTest.kt
@@ -1,5 +1,10 @@
 package net.osmand.shared.grid
 
+import net.osmand.shared.grid.ButtonPositionSize.Companion.POS_BOTTOM
+import net.osmand.shared.grid.ButtonPositionSize.Companion.POS_FULL_WIDTH
+import net.osmand.shared.grid.ButtonPositionSize.Companion.POS_LEFT
+import net.osmand.shared.grid.ButtonPositionSize.Companion.POS_RIGHT
+import net.osmand.shared.grid.ButtonPositionSize.Companion.POS_TOP
 import kotlin.test.Test
 import kotlin.test.assertTrue
 
@@ -79,7 +84,59 @@ class ButtonPositionSizeTest {
 		assertTrue { check(buttons, "map.view.zoom_out", 107.0, 38.0) }
 		assertTrue { check(buttons, "map.view.zoom_id", 107.0, 30.0) }
 		assertTrue { check(buttons, "map.view.back_to_loc", 99.0, 38.0) }
+	}
+
+	@Test
+	fun testLayout3() {
+		ButtonPositionSize.DEBUG_PRINT = true
+		// ButtonPositionSize.ALTERNATIVE_ALGORITHM = true
+
+		val buttons = listOf(
+			ButtonPositionSize("top_widgets_panel").setSize(51, 8).setNonMoveable()
+				.setMoveDescendantsVertical().apply {
+					posH = POS_FULL_WIDTH
+					posV = POS_TOP
+				},
+
+			ButtonPositionSize("map_right_widgets_panel").setSize(22, 91).setNonMoveable()
+				.setMoveDescendantsVertical().apply {
+					posH = POS_RIGHT
+					posV = POS_TOP
+					marginY = 9
+				},
+
+			ButtonPositionSize("map.view.layers", 6, true, true).apply {
+				yMove = true
+			}, ButtonPositionSize("map.view.quick_search", 6, true, true).apply {
+				xMove = true
+			}, ButtonPositionSize("map.view.compass", 6, true, true).apply {
+				yMove = true
+			}, ButtonPositionSize("map.view.zoom_out", 7, false, false).apply {
+				yMove = true
+			}, ButtonPositionSize("map.view.zoom_id", 7, false, false).apply {
+				yMove = true
+			}, ButtonPositionSize("map.view.back_to_loc", 7, false, false).apply {
+				xMove = true
+			}, ButtonPositionSize("map.view.menu", 7, true, false).apply {
+				xMove = true
+			}, ButtonPositionSize("map.view.route_planning", 7, true, false).apply {
+				xMove = true
+			}, ButtonPositionSize("map.view.map_3d", 7, true, false).apply {
+				yMove = true
+				xMove = true
+				marginX = 9
+				marginY = 35
+			}, ButtonPositionSize("map_ruler_layout").setSize(8, 3).apply {
+				xMove = true
+				posH = POS_LEFT
+				posV = POS_BOTTOM
+			})
+
+		ButtonPositionSize.computeNonOverlap(1, buttons, 51, 100)
 
+		assertTrue { !check(buttons, "map.view.zoom_id", 44.0, 1.0) } // buttons should not be moved above top_widgets_panel
+		assertTrue { !check(buttons, "map.view.zoom_out", 44.0, 1.0) }
+		assertTrue { !check(buttons, "map.view.back_to_loc", 36.0, 1.0) }
 	}
 
 	private fun check(buttons: List<ButtonPositionSize>, id: String, x: Double, y: Double): Boolean {
diff --git a/OsmAnd/src/net/osmand/plus/views/controls/MapHudLayout.java b/OsmAnd/src/net/osmand/plus/views/controls/MapHudLayout.java
index 6b1acb53808..9738bb7c829 100644
--- a/OsmAnd/src/net/osmand/plus/views/controls/MapHudLayout.java
+++ b/OsmAnd/src/net/osmand/plus/views/controls/MapHudLayout.java
@@ -235,17 +235,19 @@ public void updateButtons() {
 	@NonNull
 	private Map<View, ButtonPositionSize> getButtonPositionSizes() {
 		Map<View, ButtonPositionSize> map = collectPositions();
+		List<ButtonPositionSize> list = new ArrayList<>(map.values());
+
 //		LOG.info("--------START--------");
-//		for (ButtonPositionSize b : map.values()) {
+//		for (ButtonPositionSize b : list) {
 //			LOG.info(b + " value = " + b.toLongValue());
 //		}
 //		LOG.info("--------");
 
 		int width = Math.round(getAdjustedWidth() / dpToPx / CELL_SIZE_DP);
 		int height = Math.round(getAdjustedHeight() / dpToPx / CELL_SIZE_DP);
-		ButtonPositionSize.Companion.computeNonOverlap(1, new ArrayList<>(map.values()), width, height);
+		ButtonPositionSize.Companion.computeNonOverlap(1, list, width, height);
 
-//		for (ButtonPositionSize b : map.values()) {
+//		for (ButtonPositionSize b : list) {
 //			LOG.info(b + " value = " + b.toLongValue());
 //		}
 //		LOG.info("--------END--------");
