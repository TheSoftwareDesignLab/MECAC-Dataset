diff --git a/OsmAnd/src/net/osmand/plus/keyevent/DefaultInputDevices.java b/OsmAnd/src/net/osmand/plus/keyevent/DefaultInputDevices.java
new file mode 100644
index 00000000000..a854ca93f26
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/keyevent/DefaultInputDevices.java
@@ -0,0 +1,36 @@
+package net.osmand.plus.keyevent;
+
+import androidx.annotation.NonNull;
+
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.keyevent.devices.InputDeviceProfile;
+import net.osmand.plus.keyevent.devices.KeyboardDeviceProfile;
+import net.osmand.plus.keyevent.devices.ParrotDeviceProfile;
+import net.osmand.plus.keyevent.devices.WunderLINQDeviceProfile;
+
+import java.util.ArrayList;
+import java.util.Arrays;
+import java.util.List;
+
+public class DefaultInputDevices {
+
+	public static final InputDeviceProfile KEYBOARD = new KeyboardDeviceProfile();
+	public static final InputDeviceProfile PARROT = new ParrotDeviceProfile();
+	public static final InputDeviceProfile WUNDER_LINQ = new WunderLINQDeviceProfile();
+
+	public static final List<InputDeviceProfile> values = new ArrayList<>();
+
+	public static void initialize(@NonNull OsmandApplication app) {
+		for (InputDeviceProfile device : values()) {
+			device.initialize(app);
+		}
+	}
+
+	public static List<InputDeviceProfile> values() {
+		if (values.size() == 0) {
+			values.addAll(Arrays.asList(KEYBOARD, PARROT, WUNDER_LINQ));
+		}
+		return values;
+	}
+
+}
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/InputDeviceHelper.java b/OsmAnd/src/net/osmand/plus/keyevent/InputDeviceHelper.java
index 8793c237ec4..d39a2c6c76a 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/InputDeviceHelper.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/InputDeviceHelper.java
@@ -1,7 +1,9 @@
 package net.osmand.plus.keyevent;
 
+import static net.osmand.plus.keyevent.DefaultInputDevices.KEYBOARD;
 import static net.osmand.util.Algorithms.objectEquals;
 
+import android.content.Context;
 import android.view.KeyEvent;
 
 import androidx.annotation.NonNull;
@@ -10,12 +12,9 @@
 import net.osmand.PlatformUtil;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.keyevent.callbacks.EventType;
-import net.osmand.plus.keyevent.callbacks.InputDevicesEventCallback;
+import net.osmand.plus.keyevent.callbacks.InputDevicesEventListener;
 import net.osmand.plus.keyevent.devices.CustomInputDeviceProfile;
 import net.osmand.plus.keyevent.devices.InputDeviceProfile;
-import net.osmand.plus.keyevent.devices.KeyboardDeviceProfile;
-import net.osmand.plus.keyevent.devices.ParrotDeviceProfile;
-import net.osmand.plus.keyevent.devices.WunderLINQDeviceProfile;
 import net.osmand.plus.keyevent.keybinding.KeyBinding;
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.settings.backend.OsmandSettings;
@@ -27,7 +26,6 @@
 import org.json.JSONObject;
 
 import java.util.ArrayList;
-import java.util.Arrays;
 import java.util.HashMap;
 import java.util.List;
 import java.util.Map;
@@ -35,76 +33,77 @@
 
 public class InputDeviceHelper {
 
-	public static final InputDeviceProfile KEYBOARD = new KeyboardDeviceProfile();
-	public static final InputDeviceProfile PARROT = new ParrotDeviceProfile();
-	public static final InputDeviceProfile WUNDER_LINQ = new WunderLINQDeviceProfile();
+	public static final int FUNCTIONALITY_CACHE_ID = 0;
+	public static final int CUSTOMIZATION_CACHE_ID = 1;
 
-	private static final String CUSTOM_PREFIX = "custom_";
 	private static final Log LOG = PlatformUtil.getLog(InputDeviceHelper.class);
+	private static final String CUSTOM_DEVICE_PREFIX = "custom_";
 
 	private final OsmandApplication app;
 	private final OsmandSettings settings;
-	private ApplicationMode appMode;
 
-	private final List<InputDeviceProfile> defaultDevices = Arrays.asList(KEYBOARD, PARROT, WUNDER_LINQ);
-	private final List<InputDeviceProfile> customDevices = new ArrayList<>();
-	private final Map<String, InputDeviceProfile> cachedDevices = new HashMap<>();
-	private final List<InputDevicesEventCallback> listeners = new ArrayList<>();
+	private final List<InputDevicesEventListener> listeners = new ArrayList<>();
+	private final Map<Integer, InputDevicesCollection> cachedDevicesCollections = new HashMap<>();
 
 	public InputDeviceHelper(@NonNull OsmandApplication app) {
 		this.app = app;
 		settings = app.getSettings();
-		updateAppModeIfNeeded(settings.getApplicationMode());
+		DefaultInputDevices.initialize(app);
 	}
 
-	@NonNull
-	public List<InputDeviceProfile> getAvailableDevices() {
-		List<InputDeviceProfile> result = new ArrayList<>();
-		result.addAll(defaultDevices);
-		result.addAll(customDevices);
-		return result;
-	}
-
-	public void addListener(@NonNull InputDevicesEventCallback listener) {
+	public void addListener(@NonNull InputDevicesEventListener listener) {
 		listeners.add(listener);
 	}
 
-	public void removeListener(@NonNull InputDevicesEventCallback listener) {
+	public void removeListener(@NonNull InputDevicesEventListener listener) {
 		listeners.remove(listener);
 	}
 
+	private void notifyListeners(@NonNull ApplicationMode appMode, @NonNull EventType event) {
+		for (InputDevicesEventListener listener : listeners) {
+			listener.processInputDevicesEvent(appMode, event);
+		}
+	}
+
 	public void selectInputDevice(@NonNull ApplicationMode appMode, @NonNull String deviceId) {
 		settings.EXTERNAL_INPUT_DEVICE.setModeValue(appMode, deviceId);
-		notifyListeners(EventType.SELECT_DEVICE);
+		notifyListeners(appMode, EventType.SELECT_DEVICE);
 	}
 
-	public void createAndSaveCustomDevice(@NonNull ApplicationMode appMode, @NonNull String newName) {
-		updateAppModeIfNeeded(appMode);
-		saveCustomDevice(makeCustomDevice(newName));
+	public void createAndSaveCustomDevice(int cacheId, @NonNull ApplicationMode appMode,
+	                                      @NonNull String newDeviceName) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		saveCustomDevice(devicesCollection, makeCustomDevice(newDeviceName));
 	}
 
-	public void createAndSaveDeviceDuplicate(@NonNull ApplicationMode appMode, @NonNull InputDeviceProfile device) {
-		updateAppModeIfNeeded(appMode);
-		saveCustomDevice(makeCustomDeviceDuplicate(device));
+	public void createAndSaveDeviceDuplicate(int cacheId, @NonNull ApplicationMode appMode,
+	                                         @NonNull InputDeviceProfile device) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		saveCustomDevice(devicesCollection, makeCustomDeviceDuplicate(devicesCollection, device));
 	}
 
-	public void renameCustomDevice(@NonNull ApplicationMode appMode,
-	                               @NonNull CustomInputDeviceProfile device,
-	                               @NonNull String newName) {
-		updateAppModeIfNeeded(appMode);
-		device.setCustomName(newName);
-		syncSettings(EventType.RENAME_DEVICE);
+	public void renameCustomDevice(int cacheId, @NonNull ApplicationMode appMode,
+	                               @NonNull String deviceId, @NonNull String newName) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		InputDeviceProfile device = devicesCollection.getDeviceById(deviceId);
+		if (device instanceof CustomInputDeviceProfile) {
+			((CustomInputDeviceProfile) device).setCustomName(newName);
+			syncSettings(devicesCollection, EventType.RENAME_DEVICE);
+		} else {
+			LOG.debug("Trying to rename non-custom input device profile: " + deviceId);
+		}
 	}
 
 	@NonNull
-	private InputDeviceProfile makeCustomDeviceDuplicate(@NonNull InputDeviceProfile device) {
+	private InputDeviceProfile makeCustomDeviceDuplicate(@NonNull InputDevicesCollection devicesCollection,
+	                                                     @NonNull InputDeviceProfile device) {
 		String prevName = device.toHumanString(app);
-		String uniqueName = makeUniqueName(prevName);
+		String uniqueName = makeUniqueName(devicesCollection, prevName);
 		return makeCustomDevice(uniqueName, device);
 	}
 
-	private String makeUniqueName(@NonNull String oldName) {
-		return Algorithms.makeUniqueName(oldName, newName -> !hasDeviceNameDuplicate(appMode, newName));
+	private String makeUniqueName(@NonNull InputDevicesCollection devicesCollection, @NonNull String oldName) {
+		return Algorithms.makeUniqueName(oldName, newName -> !devicesCollection.hasDeviceNameDuplicate(app, newName));
 	}
 
 	@NonNull
@@ -113,115 +112,93 @@ private InputDeviceProfile makeCustomDevice(@NonNull String newName) {
 	}
 
 	@NonNull
-	private InputDeviceProfile makeCustomDevice(
-			@NonNull String newName, @NonNull InputDeviceProfile baseDevice
-	) {
-		String uniqueId = CUSTOM_PREFIX + System.currentTimeMillis();
+	private InputDeviceProfile makeCustomDevice(@NonNull String newName,
+	                                            @NonNull InputDeviceProfile baseDevice) {
+		String uniqueId = CUSTOM_DEVICE_PREFIX + System.currentTimeMillis();
 		return makeCustomDevice(uniqueId, newName, baseDevice);
 	}
 
 	@NonNull
 	private InputDeviceProfile makeCustomDevice(@NonNull String id, @NonNull String name,
 	                                            @NonNull InputDeviceProfile parentDevice) {
-		InputDeviceProfile device = new CustomInputDeviceProfile(id, name, parentDevice);
-		device.initialize(app);
-		return device;
+		return new CustomInputDeviceProfile(id, name, parentDevice).initialize(app);
 	}
 
-	private void saveCustomDevice(@NonNull InputDeviceProfile device) {
-		customDevices.add(device);
-		cachedDevices.put(device.getId(), device);
-		syncSettings(EventType.ADD_NEW_DEVICE);
+	private void saveCustomDevice(@NonNull InputDevicesCollection devicesCollection,
+	                              @NonNull InputDeviceProfile device) {
+		devicesCollection.addCustomDevice(device);
+		syncSettings(devicesCollection, EventType.ADD_NEW_DEVICE);
 	}
 
-	public void removeCustomDevice(@NonNull ApplicationMode appMode, @NonNull String deviceId) {
-		updateAppModeIfNeeded(appMode);
-		InputDeviceProfile device = cachedDevices.remove(deviceId);
-		if (device != null) {
-			customDevices.remove(device);
-			syncSettings(EventType.DELETE_DEVICE);
-		}
+	public void removeCustomDevice(int cacheId, @NonNull ApplicationMode appMode,
+	                               @NonNull String deviceId) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		devicesCollection.removeCustomDevice(deviceId);
+		syncSettings(devicesCollection, EventType.DELETE_DEVICE);
 	}
 
-	public boolean hasKeybindingNameDuplicate(@NonNull ApplicationMode appMode,
-	                                          @NonNull String deviceId, @NonNull String newName) {
-		updateAppModeIfNeeded(appMode);
-		InputDeviceProfile device = getDeviceById(appMode, deviceId);
-		if (device == null) {
-			return false;
-		}
-		List<KeyBinding> keyBindings = device.getKeyBindings();
-		for (KeyBinding keyBinding : keyBindings) {
-			if (Objects.equals(keyBinding.getName(app), newName)) {
-				return true;
-			}
-		}
-		return false;
-	}
-
-	public void updateKeyBinding(@NonNull ApplicationMode appMode, @NonNull String deviceId,
+	public void updateKeyBinding(int cacheId, @NonNull ApplicationMode appMode, @NonNull String deviceId,
 	                             @NonNull KeyBinding oldKeyBinding, @NonNull KeyBinding newKeyBinding) {
-		updateAppModeIfNeeded(appMode);
-		InputDeviceProfile device = getDeviceById(appMode, deviceId);
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		InputDeviceProfile device = devicesCollection.getDeviceById(deviceId);
 		if (device != null) {
-			resetPreviousKeyBindingIfNeeded(device, newKeyBinding);
+			resetPreviousKeyBindingIfNeeded(cacheId, appMode, device, newKeyBinding);
 			device.updateKeyBinding(oldKeyBinding, newKeyBinding);
-			syncSettings(EventType.UPDATE_KEY_BINDING);
+			syncSettings(devicesCollection, EventType.UPDATE_KEY_BINDING);
 		}
 	}
 
-	private void resetPreviousKeyBindingIfNeeded(@NonNull InputDeviceProfile device,
+	private void resetPreviousKeyBindingIfNeeded(int cacheId, @NonNull ApplicationMode appMode,
+	                                             @NonNull InputDeviceProfile device,
 	                                             @NonNull KeyBinding newKeyBinding) {
 		int keyCode = newKeyBinding.getKeyCode();
 		KeyBinding prevKeyBinding = device.findActiveKeyBinding(keyCode);
 		if (prevKeyBinding != null && !objectEquals(newKeyBinding, prevKeyBinding)) {
 			KeyBinding newAssignment = new KeyBinding(KeyEvent.KEYCODE_UNKNOWN, prevKeyBinding);
-			updateKeyBinding(appMode, device.getId(), prevKeyBinding, newAssignment);
+			updateKeyBinding(cacheId, appMode, device.getId(), prevKeyBinding, newAssignment);
 		}
 	}
 
-	public void resetAllKeyBindings(@NonNull ApplicationMode appMode, @NonNull String deviceId) {
-		updateAppModeIfNeeded(appMode);
-		InputDeviceProfile device = getDeviceById(appMode, deviceId);
+	public void resetAllKeyBindings(int cacheId, @NonNull ApplicationMode appMode,
+	                                @NonNull String deviceId) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		InputDeviceProfile device = devicesCollection.getDeviceById(deviceId);
 		if (device != null) {
 			device.resetAllKeyBindings();
-			syncSettings(EventType.RESET_ALL_KEY_BINDINGS);
+			syncSettings(devicesCollection, EventType.RESET_ALL_KEY_BINDINGS);
 		}
 	}
 
-	public boolean isSelectedDevice(@NonNull ApplicationMode appMode, @NonNull String deviceId) {
-		InputDeviceProfile selectedDevice = getSelectedDevice(appMode);
-		return Objects.equals(selectedDevice.getId(), deviceId);
+	public boolean hasDeviceNameDuplicate(int cacheId, @NonNull ApplicationMode appMode,
+	                                      @NonNull Context context, String newName) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		return devicesCollection.hasDeviceNameDuplicate(context, newName);
 	}
 
-	public boolean isCustomDevice(@NonNull InputDeviceProfile device) {
-		String id = device.getId();
-		return id.startsWith(CUSTOM_PREFIX);
+	public boolean hasKeybindingNameDuplicate(int cacheId, @NonNull ApplicationMode appMode,
+	                                          OsmandApplication context, String deviceId, String newName) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		return devicesCollection.hasKeybindingNameDuplicate(context, deviceId, newName);
 	}
 
-	@Nullable
-	public InputDeviceProfile getDeviceById(@NonNull ApplicationMode appMode, @NonNull String deviceId) {
-		updateAppModeIfNeeded(appMode);
-		return cachedDevices.get(deviceId);
-	}
-
-	@Nullable
-	public InputDeviceProfile getEnabledDevice() {
-		return getEnabledDevice(settings.getApplicationMode());
+	@NonNull
+	public List<InputDeviceProfile> getAllDevices(int cacheId, @NonNull ApplicationMode appMode) {
+		InputDevicesCollection devicesCollection = getInputDevicesCollection(cacheId, appMode);
+		return devicesCollection.getAllDevices();
 	}
 
 	@Nullable
-	public InputDeviceProfile getEnabledDevice(@NonNull ApplicationMode appMode) {
+	public InputDeviceProfile getEnabledSelectedDevice(int cacheId, @NonNull ApplicationMode appMode) {
 		if (settings.EXTERNAL_INPUT_DEVICE_ENABLED.getModeValue(appMode)) {
-			return getSelectedDevice(appMode);
+			return getSelectedDevice(cacheId, appMode);
 		}
 		return null;
 	}
 
 	@NonNull
-	public InputDeviceProfile getSelectedDevice(@NonNull ApplicationMode appMode) {
+	public InputDeviceProfile getSelectedDevice(int cacheId, @NonNull ApplicationMode appMode) {
 		String id = getSelectedDeviceId(appMode);
-		InputDeviceProfile device = id != null ? getDeviceById(appMode, id) : null;
+		InputDeviceProfile device = id != null ? getDeviceById(cacheId, appMode, id) : null;
 		return device != null ? device : KEYBOARD;
 	}
 
@@ -229,50 +206,32 @@ public InputDeviceProfile getSelectedDevice(@NonNull ApplicationMode appMode) {
 	private String getSelectedDeviceId(@NonNull ApplicationMode appMode) {
 		return settings.EXTERNAL_INPUT_DEVICE.getModeValue(appMode);
 	}
-
-	public boolean hasDeviceNameDuplicate(@NonNull ApplicationMode appMode, @NonNull String newName) {
-		updateAppModeIfNeeded(appMode);
-		for (InputDeviceProfile device : getAvailableDevices()) {
-			if (objectEquals(device.toHumanString(app).trim(), newName.trim())) {
-				return true;
-			}
-		}
-		return false;
+	@Nullable
+	public InputDeviceProfile getDeviceById(int cacheId, @NonNull ApplicationMode appMode,
+	                                        @NonNull String deviceId) {
+		return getInputDevicesCollection(cacheId, appMode).getDeviceById(deviceId);
 	}
 
-	private void notifyListeners(@NonNull EventType event) {
-		for (InputDevicesEventCallback listener : listeners) {
-			listener.processInputDevicesEvent(event);
-		}
+	@Nullable
+	public ApplicationMode getAppMode(int cacheId) {
+		InputDevicesCollection collection = cachedDevicesCollections.get(cacheId);
+		return collection != null ? collection.getAppMode() : null;
 	}
 
-	/**
-	 * You must call this method at the beginning of each public method
-	 * that use devices cache and can be called from the outside.
-	 * This will help ensure correct interaction with profile-dependent parameters.
-	 *
-	 * This method checks if the app mode has changed since the last time this method was called,
-	 * and if so, reloads cached devices for currently selected app mode from the settings.
-	 *
-	 * @param appMode - currently selected app mode for the context
-	 *                   from where the public method was called.
-	 */
-	private void updateAppModeIfNeeded(@NonNull ApplicationMode appMode) {
-		if (this.appMode != appMode) {
-			this.appMode = appMode;
-			updateCachedInputDevices();
+	@NonNull
+	private InputDevicesCollection getInputDevicesCollection(int cacheId, @NonNull ApplicationMode appMode) {
+		InputDevicesCollection collection = cachedDevicesCollections.get(cacheId);
+		if (collection == null || !Objects.equals(appMode, collection.getAppMode())) {
+			collection = reloadInputDevicesCollection(cacheId, appMode);
 		}
+		return collection;
 	}
 
-	private void updateCachedInputDevices() {
-		customDevices.clear();
-		cachedDevices.clear();
-
-		customDevices.addAll(loadCustomDevices(appMode));
-		for (InputDeviceProfile device : getAvailableDevices()) {
-			device.initialize(app);
-			cachedDevices.put(device.getId(), device);
-		}
+	@NonNull
+	public InputDevicesCollection reloadInputDevicesCollection(int cacheId, @NonNull ApplicationMode appMode) {
+		InputDevicesCollection collection = new InputDevicesCollection(appMode, loadCustomDevices(appMode));
+		cachedDevicesCollections.put(cacheId, collection);
+		return collection;
 	}
 
 	@NonNull
@@ -280,26 +239,29 @@ private List<InputDeviceProfile> loadCustomDevices(@NonNull ApplicationMode appM
 		String json = settings.CUSTOM_EXTERNAL_INPUT_DEVICES.getModeValue(appMode);
 		if (!Algorithms.isEmpty(json)) {
 			try {
-				return readFromJson(new JSONObject(json));
+				return readFromJson(app, new JSONObject(json));
 			} catch (JSONException e) {
-				LOG.debug("Error when reading custom devices from JSON ", e);
+				LOG.debug("Error while reading custom devices from JSON ", e);
 			}
 		}
 		return new ArrayList<>();
 	}
 
-	public void syncSettings(@NonNull EventType eventType) {
+	private void syncSettings(@NonNull InputDevicesCollection devicesCollection,
+	                          @NonNull EventType eventType) {
 		JSONObject json = new JSONObject();
+		ApplicationMode appMode = devicesCollection.getAppMode();
 		try {
-			writeToJson(json, customDevices);
+			writeToJson(json, devicesCollection.getCustomDevices());
 			settings.CUSTOM_EXTERNAL_INPUT_DEVICES.setModeValue(appMode, json.toString());
 		} catch (JSONException e) {
-			LOG.debug("Error when writing custom devices to JSON ", e);
+			LOG.debug("Error while writing custom devices to JSON ", e);
 		}
-		notifyListeners(eventType);
+		notifyListeners(appMode, eventType);
 	}
 
-	public static List<InputDeviceProfile> readFromJson(@NonNull JSONObject json) throws JSONException {
+	private static List<InputDeviceProfile> readFromJson(@NonNull OsmandApplication app,
+	                                                     @NonNull JSONObject json) throws JSONException {
 		if (!json.has("items")) {
 			return new ArrayList<>();
 		}
@@ -307,7 +269,7 @@ public static List<InputDeviceProfile> readFromJson(@NonNull JSONObject json) th
 		JSONArray jsonArray = json.getJSONArray("items");
 		for (int i = 0; i < jsonArray.length(); i++) {
 			try {
-				res.add(new CustomInputDeviceProfile(jsonArray.getJSONObject(i)));
+				res.add(new CustomInputDeviceProfile(jsonArray.getJSONObject(i)).initialize(app));
 			} catch (JSONException e) {
 				LOG.debug("Error while reading a custom device from JSON ", e);
 			}
@@ -315,8 +277,8 @@ public static List<InputDeviceProfile> readFromJson(@NonNull JSONObject json) th
 		return res;
 	}
 
-	public static void writeToJson(@NonNull JSONObject json,
-	                               @NonNull List<InputDeviceProfile> customDevices) throws JSONException {
+	private static void writeToJson(@NonNull JSONObject json,
+	                                @NonNull List<InputDeviceProfile> customDevices) throws JSONException {
 		JSONArray jsonArray = new JSONArray();
 		for (InputDeviceProfile device : customDevices) {
 			jsonArray.put(((CustomInputDeviceProfile) device).toJson());
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/InputDevicesCollection.java b/OsmAnd/src/net/osmand/plus/keyevent/InputDevicesCollection.java
new file mode 100644
index 00000000000..0fd462d5158
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/keyevent/InputDevicesCollection.java
@@ -0,0 +1,98 @@
+package net.osmand.plus.keyevent;
+
+import static net.osmand.util.Algorithms.objectEquals;
+
+import android.content.Context;
+
+import androidx.annotation.NonNull;
+import androidx.annotation.Nullable;
+
+import net.osmand.plus.OsmandApplication;
+import net.osmand.plus.keyevent.devices.InputDeviceProfile;
+import net.osmand.plus.keyevent.keybinding.KeyBinding;
+import net.osmand.plus.settings.backend.ApplicationMode;
+import net.osmand.util.Algorithms;
+
+import java.util.HashMap;
+import java.util.List;
+import java.util.Map;
+import java.util.Objects;
+
+class InputDevicesCollection {
+
+	private final ApplicationMode appMode;
+	private List<InputDeviceProfile> customDevices;
+	private final List<InputDeviceProfile> defaultDevices;
+	private Map<String, InputDeviceProfile> cachedDevices = new HashMap<>();
+
+	public InputDevicesCollection(@NonNull ApplicationMode appMode,
+	                              @NonNull List<InputDeviceProfile> customDevices) {
+		this.appMode = appMode;
+		this.customDevices = customDevices;
+		this.defaultDevices = DefaultInputDevices.values();
+		syncCachedDevices();
+	}
+
+	public boolean hasDeviceNameDuplicate(@NonNull Context context, @NonNull String newName) {
+		for (InputDeviceProfile device : getAllDevices()) {
+			if (objectEquals(device.toHumanString(context).trim(), newName.trim())) {
+				return true;
+			}
+		}
+		return false;
+	}
+
+	public boolean hasKeybindingNameDuplicate(@NonNull OsmandApplication context,
+	                                          @NonNull String deviceId, @NonNull String newName) {
+		InputDeviceProfile device = getDeviceById(deviceId);
+		if (device != null) {
+			for (KeyBinding keyBinding : device.getKeyBindings()) {
+				if (Objects.equals(keyBinding.getName(context), newName)) {
+					return true;
+				}
+			}
+		}
+		return false;
+	}
+
+	@NonNull
+	public ApplicationMode getAppMode() {
+		return appMode;
+	}
+
+	@NonNull
+	public List<InputDeviceProfile> getAllDevices() {
+		return Algorithms.asOneList(defaultDevices, customDevices);
+	}
+
+	@NonNull
+	public List<InputDeviceProfile> getCustomDevices() {
+		return customDevices;
+	}
+
+	public void addCustomDevice(@NonNull InputDeviceProfile device) {
+		customDevices = Algorithms.addToList(customDevices, device);
+		syncCachedDevices();
+	}
+
+	public void removeCustomDevice(String deviceId) {
+		InputDeviceProfile device = getDeviceById(deviceId);
+		if (device != null) {
+			customDevices = Algorithms.removeFromList(customDevices, device);
+			syncCachedDevices();
+		}
+	}
+
+	@Nullable
+	public InputDeviceProfile getDeviceById(@NonNull String deviceId) {
+		return cachedDevices.get(deviceId);
+	}
+
+	private void syncCachedDevices() {
+		Map<String ,InputDeviceProfile> newCachedDevices = new HashMap<>();
+		for (InputDeviceProfile device : getAllDevices()) {
+			newCachedDevices.put(device.getId(), device);
+		}
+		cachedDevices = newCachedDevices;
+	}
+}
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/KeyEventHelper.java b/OsmAnd/src/net/osmand/plus/keyevent/KeyEventHelper.java
index 36720610bcf..aa57c94a5bf 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/KeyEventHelper.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/KeyEventHelper.java
@@ -1,5 +1,7 @@
 package net.osmand.plus.keyevent;
 
+import static net.osmand.plus.keyevent.InputDeviceHelper.FUNCTIONALITY_CACHE_ID;
+
 import android.view.KeyEvent;
 import android.view.KeyEvent.Callback;
 
@@ -9,15 +11,18 @@
 import net.osmand.StateChangedListener;
 import net.osmand.plus.OsmandApplication;
 import net.osmand.plus.activities.MapActivity;
+import net.osmand.plus.keyevent.callbacks.EventType;
+import net.osmand.plus.keyevent.callbacks.InputDevicesEventListener;
 import net.osmand.plus.keyevent.commands.KeyEventCommand;
 import net.osmand.plus.keyevent.commands.MapZoomCommand;
 import net.osmand.plus.keyevent.devices.InputDeviceProfile;
+import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.settings.backend.OsmandSettings;
 
 import java.util.HashMap;
 import java.util.Map;
 
-public class KeyEventHelper implements KeyEvent.Callback {
+public class KeyEventHelper implements KeyEvent.Callback, InputDevicesEventListener {
 
 	private final OsmandApplication app;
 	private final OsmandSettings settings;
@@ -33,6 +38,7 @@ public KeyEventHelper(@NonNull OsmandApplication app) {
 		this.app = app;
 		settings = app.getSettings();
 		deviceHelper = app.getInputDeviceHelper();
+		deviceHelper.addListener(this);
 
 		// Update commands when related preferences updated
 		volumeButtonsPrefListener = aBoolean -> updateGlobalCommands();
@@ -104,6 +110,15 @@ public boolean onKeyMultiple(int keyCode, int count, KeyEvent event) {
 		return command != null && command.onKeyMultiple(keyCode, count, event);
 	}
 
+	@Override
+	public void processInputDevicesEvent(@NonNull ApplicationMode appMode, @NonNull EventType event) {
+		// If custom preference for current app mode was updated,
+		// We need to reload device from preferences to use it with actual customizations.
+		if (deviceHelper.getAppMode(0) == appMode && event.isCustomPreferenceRelated()) {
+			deviceHelper.reloadInputDevicesCollection(FUNCTIONALITY_CACHE_ID, appMode);
+		}
+	}
+
 	private void showToastAboutPressedKey(@NonNull KeyEvent keyEvent) {
 		int keyCode = keyEvent.getKeyCode();
 		int deviceId = keyEvent.getDeviceId();
@@ -123,8 +138,9 @@ private KeyEventCommand findCommand(int keyCode) {
 			return globalCommand;
 		}
 		// Search command for current input device profile
-		InputDeviceProfile inputDevice = deviceHelper.getEnabledDevice();
-		return inputDevice != null ? inputDevice.findCommand(keyCode) : null;
+		ApplicationMode appMode = settings.getApplicationMode();
+		InputDeviceProfile device = deviceHelper.getEnabledSelectedDevice(FUNCTIONALITY_CACHE_ID, appMode);
+		return device != null ? device.findCommand(keyCode) : null;
 	}
 
 	private void bindCommand(int keyCode, @NonNull String commandId) {
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/callbacks/EventType.java b/OsmAnd/src/net/osmand/plus/keyevent/callbacks/EventType.java
index e1797de4a71..cf572cec560 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/callbacks/EventType.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/callbacks/EventType.java
@@ -3,6 +3,7 @@
 import net.osmand.util.Algorithms;
 
 public enum EventType {
+
 	SELECT_DEVICE,
 	RENAME_DEVICE,
 	ADD_NEW_DEVICE,
@@ -17,4 +18,8 @@ public boolean isDeviceRelated() {
 	public boolean isKeyBindingRelated() {
 		return Algorithms.equalsToAny(this, UPDATE_KEY_BINDING, RESET_ALL_KEY_BINDINGS);
 	}
+
+	public boolean isCustomPreferenceRelated() {
+		return this != SELECT_DEVICE;
+	}
 }
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/callbacks/InputDevicesEventCallback.java b/OsmAnd/src/net/osmand/plus/keyevent/callbacks/InputDevicesEventCallback.java
deleted file mode 100644
index e0d8b11f722..00000000000
--- a/OsmAnd/src/net/osmand/plus/keyevent/callbacks/InputDevicesEventCallback.java
+++ /dev/null
@@ -1,7 +0,0 @@
-package net.osmand.plus.keyevent.callbacks;
-
-import androidx.annotation.NonNull;
-
-public interface InputDevicesEventCallback {
-	void processInputDevicesEvent(@NonNull EventType event);
-}
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/callbacks/InputDevicesEventListener.java b/OsmAnd/src/net/osmand/plus/keyevent/callbacks/InputDevicesEventListener.java
new file mode 100644
index 00000000000..2b87fbe09dd
--- /dev/null
+++ b/OsmAnd/src/net/osmand/plus/keyevent/callbacks/InputDevicesEventListener.java
@@ -0,0 +1,9 @@
+package net.osmand.plus.keyevent.callbacks;
+
+import androidx.annotation.NonNull;
+
+import net.osmand.plus.settings.backend.ApplicationMode;
+
+public interface InputDevicesEventListener {
+	void processInputDevicesEvent(@NonNull ApplicationMode appMode, @NonNull EventType event);
+}
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/devices/CustomInputDeviceProfile.java b/OsmAnd/src/net/osmand/plus/keyevent/devices/CustomInputDeviceProfile.java
index 18109e2d4d0..bea98ec6028 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/devices/CustomInputDeviceProfile.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/devices/CustomInputDeviceProfile.java
@@ -47,6 +47,11 @@ public String getId() {
 		return customId;
 	}
 
+	@Override
+	public boolean isCustom() {
+		return true;
+	}
+
 	@NonNull
 	public JSONObject toJson() throws JSONException {
 		JSONObject jsonObject = new JSONObject();
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/devices/InputDeviceProfile.java b/OsmAnd/src/net/osmand/plus/keyevent/devices/InputDeviceProfile.java
index 61cbae29815..ee925b25184 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/devices/InputDeviceProfile.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/devices/InputDeviceProfile.java
@@ -23,8 +23,10 @@ public abstract class InputDeviceProfile {
 	protected List<KeyBinding> keyBindings = new ArrayList<>();
 	protected Map<Integer, KeyBinding> activeKeyBindings = new HashMap<>();
 
-	public void initialize(@NonNull OsmandApplication app) {
+	@NonNull
+	public InputDeviceProfile initialize(@NonNull OsmandApplication app) {
 		this.app = app;
+		return this;
 	}
 
 	public List<KeyBinding> getKeyBindingsForCategory(@NonNull KeyEventCategory category) {
@@ -102,6 +104,10 @@ public int getActiveKeyBindingsCount() {
 	@NonNull
 	public abstract String getId();
 
+	public boolean isCustom() {
+		return false;
+	}
+
 	@NonNull
 	public abstract String toHumanString(@NonNull Context context);
 
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/devices/PredefinedInputDeviceProfile.java b/OsmAnd/src/net/osmand/plus/keyevent/devices/PredefinedInputDeviceProfile.java
index b8e1894aa3e..1b5f0fb408e 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/devices/PredefinedInputDeviceProfile.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/devices/PredefinedInputDeviceProfile.java
@@ -8,11 +8,13 @@
 public abstract class PredefinedInputDeviceProfile extends InputDeviceProfile {
 
 	@Override
-	public void initialize(@NonNull OsmandApplication app) {
+	@NonNull
+	public InputDeviceProfile initialize(@NonNull OsmandApplication app) {
 		super.initialize(app);
 		keyBindings.clear();
 		collectKeyBindings();
 		syncActiveKeyBindings();
+		return this;
 	}
 
 	/**
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/EditKeyBindingFragment.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/EditKeyBindingFragment.java
index 805151ac4c9..48e5f5aaf7a 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/EditKeyBindingFragment.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/EditKeyBindingFragment.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.keyevent.fragments;
 
+import static net.osmand.plus.keyevent.InputDeviceHelper.CUSTOMIZATION_CACHE_ID;
 import static net.osmand.plus.settings.fragments.BaseSettingsFragment.APP_MODE_KEY;
 import static net.osmand.plus.utils.AndroidUtils.setBackground;
 import static net.osmand.plus.utils.ColorUtilities.getActiveColor;
@@ -33,7 +34,7 @@
 import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.keyevent.InputDeviceHelper;
 import net.osmand.plus.keyevent.callbacks.EventType;
-import net.osmand.plus.keyevent.callbacks.InputDevicesEventCallback;
+import net.osmand.plus.keyevent.callbacks.InputDevicesEventListener;
 import net.osmand.plus.keyevent.callbacks.OnKeyCodeSelectedCallback;
 import net.osmand.plus.keyevent.keybinding.KeyBinding;
 import net.osmand.plus.settings.backend.ApplicationMode;
@@ -50,7 +51,7 @@
 import java.util.Objects;
 
 public class EditKeyBindingFragment extends BaseOsmAndFragment
-		implements OnKeyCodeSelectedCallback, InputDevicesEventCallback {
+		implements OnKeyCodeSelectedCallback, InputDevicesEventListener {
 
 	public static final String TAG = EditKeyBindingFragment.class.getSimpleName();
 
@@ -197,7 +198,7 @@ private void showEnterNameDialog(@Nullable String oldName,
 				}
 				if (Algorithms.isBlank(newName)) {
 					app.showToastMessage(R.string.empty_name);
-				} else if (deviceHelper.hasKeybindingNameDuplicate(appMode, deviceId, newName)) {
+				} else if (deviceHelper.hasKeybindingNameDuplicate(CUSTOMIZATION_CACHE_ID, appMode, app, deviceId, newName)) {
 					app.showToastMessage(R.string.message_name_is_already_exists);
 				} else {
 					callback.processResult(newName.trim());
@@ -225,7 +226,7 @@ private void onNameEntered(@NonNull String newName) {
 		KeyBinding originalKeyBinding = keyBinding;
 		if (!Objects.equals(originalKeyBinding.getName(app), newName)) {
 			keyBinding = new KeyBinding(newName, keyBinding);
-			deviceHelper.updateKeyBinding(appMode, deviceId, originalKeyBinding, keyBinding);
+			deviceHelper.updateKeyBinding(CUSTOMIZATION_CACHE_ID, appMode, deviceId, originalKeyBinding, keyBinding);
 		}
 	}
 
@@ -234,12 +235,12 @@ public void onKeyCodeSelected(int newKeyCode) {
 		KeyBinding originalKeyBinding = keyBinding;
 		if (newKeyCode != originalKeyBinding.getKeyCode()) {
 			keyBinding = new KeyBinding(newKeyCode, keyBinding);
-			deviceHelper.updateKeyBinding(appMode, deviceId, originalKeyBinding, keyBinding);
+			deviceHelper.updateKeyBinding(CUSTOMIZATION_CACHE_ID, appMode, deviceId, originalKeyBinding, keyBinding);
 		}
 	}
 
 	@Override
-	public void processInputDevicesEvent(@NonNull EventType event) {
+	public void processInputDevicesEvent(@NonNull ApplicationMode appMode, @NonNull EventType event) {
 		View view = getView();
 		if (view != null && event.isKeyBindingRelated()) {
 			updateViewContent(view);
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/MainExternalInputDevicesFragment.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/MainExternalInputDevicesFragment.java
index 5ecdf39ebc9..f7011a3cf52 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/MainExternalInputDevicesFragment.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/MainExternalInputDevicesFragment.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.keyevent.fragments;
 
+import static net.osmand.plus.keyevent.InputDeviceHelper.CUSTOMIZATION_CACHE_ID;
 import static net.osmand.plus.utils.UiUtilities.CompoundButtonType.TOOLBAR;
 
 import android.content.Context;
@@ -99,11 +100,12 @@ private void updateToolbarSwitch(View view) {
 
 	private Preference createTypePreference(@NonNull Context context) {
 		Preference uiPreference = new Preference(context);
-		InputDeviceProfile inputDevice = deviceHelper.getSelectedDevice(getSelectedAppMode());
+		ApplicationMode appMode = getSelectedAppMode();
+		InputDeviceProfile device = deviceHelper.getSelectedDevice(CUSTOMIZATION_CACHE_ID, appMode);
 		uiPreference.setKey(PREF_ID_TYPE);
 		uiPreference.setLayoutResource(R.layout.preference_with_descr_and_divider);
 		uiPreference.setTitle(R.string.shared_string_type);
-		uiPreference.setSummary(inputDevice.toHumanString(context));
+		uiPreference.setSummary(device.toHumanString(context));
 		uiPreference.setIcon(getContentIcon(R.drawable.ic_action_keyboard));
 		uiPreference.setSelectable(true);
 		return uiPreference;
@@ -111,11 +113,12 @@ private Preference createTypePreference(@NonNull Context context) {
 
 	private Preference createBindingPreference(@NonNull Context context) {
 		Preference uiPreference = new Preference(context);
-		InputDeviceProfile inputDevice = deviceHelper.getSelectedDevice(getSelectedAppMode());
+		ApplicationMode appMode = getSelectedAppMode();
+		InputDeviceProfile device = deviceHelper.getSelectedDevice(CUSTOMIZATION_CACHE_ID, appMode);
 		uiPreference.setKey(PREF_ID_BINDING);
 		uiPreference.setLayoutResource(R.layout.preference_with_descr);
 		uiPreference.setTitle(R.string.key_assignments);
-		uiPreference.setSummary(String.valueOf(inputDevice.getActiveKeyBindingsCount()));
+		uiPreference.setSummary(String.valueOf(device.getActiveKeyBindingsCount()));
 		uiPreference.setIcon(getContentIcon(R.drawable.ic_action_button_default));
 		uiPreference.setSelectable(true);
 		return uiPreference;
@@ -150,7 +153,7 @@ public boolean onPreferenceClick(Preference preference) {
 	}
 
 	private boolean isInputDeviceEnabled(@NonNull ApplicationMode appMode) {
-		return deviceHelper.getEnabledDevice(appMode) != null;
+		return deviceHelper.getEnabledSelectedDevice(CUSTOMIZATION_CACHE_ID, appMode) != null;
 	}
 
 	@Override
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/SelectKeyCodeFragment.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/SelectKeyCodeFragment.java
index f2e4d0bd11d..fde0b3d0cbf 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/SelectKeyCodeFragment.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/SelectKeyCodeFragment.java
@@ -1,6 +1,7 @@
 package net.osmand.plus.keyevent.fragments;
 
 import static android.graphics.Typeface.BOLD;
+import static net.osmand.plus.keyevent.InputDeviceHelper.CUSTOMIZATION_CACHE_ID;
 import static net.osmand.plus.settings.fragments.BaseSettingsFragment.APP_MODE_KEY;
 import static net.osmand.plus.utils.ColorUtilities.getPrimaryIconColor;
 import static net.osmand.plus.utils.UiUtilities.createSpannableString;
@@ -72,7 +73,8 @@ public void onCreate(@Nullable Bundle savedInstanceState) {
 
 		String appModeKey = arguments.getString(APP_MODE_KEY);
 		ApplicationMode appMode = ApplicationMode.valueOfStringKey(appModeKey, settings.getApplicationMode());
-		inputDevice = deviceHelper.getDeviceById(appMode, arguments.getString(ATTR_DEVICE_ID));
+		String deviceId = Objects.requireNonNull(arguments.getString(ATTR_DEVICE_ID));
+		inputDevice = deviceHelper.getDeviceById(CUSTOMIZATION_CACHE_ID, appMode, deviceId);
 
 		if (savedInstanceState != null) {
 			keyCode = savedInstanceState.containsKey(ATTR_KEY_CODE)
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesAdapter.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesAdapter.java
index 406246caada..93b91d4ffdf 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesAdapter.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesAdapter.java
@@ -99,7 +99,7 @@ public void onBindViewHolder(@NonNull ViewHolder holder, int position) {
 			UiUtilities.setupCompoundButton(nightMode, color, h.compoundButton);
 			h.compoundButton.setChecked(controller.isSelected(device));
 
-			AndroidUiHelper.updateVisibility(h.overflowMenuButton, controller.isCustom(device));
+			AndroidUiHelper.updateVisibility(h.overflowMenuButton, device.isCustom());
 			h.overflowMenuButton.setOnClickListener(v -> {
 				showOverflowMenu(h.overflowMenuButton, device);
 			});
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesController.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesController.java
index b1dadbce3df..228a759db5e 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesController.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesController.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.keyevent.fragments.inputdevices;
 
+import static net.osmand.plus.keyevent.InputDeviceHelper.CUSTOMIZATION_CACHE_ID;
 import static net.osmand.plus.keyevent.fragments.inputdevices.InputDevicesAdapter.CARD_BOTTOM_SHADOW;
 import static net.osmand.plus.keyevent.fragments.inputdevices.InputDevicesAdapter.CARD_DIVIDER;
 import static net.osmand.plus.keyevent.fragments.inputdevices.InputDevicesAdapter.DEVICE_ITEM;
@@ -26,6 +27,7 @@
 
 import java.util.ArrayList;
 import java.util.List;
+import java.util.Objects;
 
 class InputDevicesController {
 
@@ -46,7 +48,7 @@ public InputDevicesController(@NonNull OsmandApplication app,
 	public List<ScreenItem> populateScreenItems() {
 		List<ScreenItem> screenItems = new ArrayList<>();
 		screenItems.add(new ScreenItem(CARD_DIVIDER));
-		for (InputDeviceProfile device : deviceHelper.getAvailableDevices()) {
+		for (InputDeviceProfile device : deviceHelper.getAllDevices(CUSTOMIZATION_CACHE_ID, appMode)) {
 			screenItems.add(new ScreenItem(DEVICE_ITEM, device));
 		}
 		screenItems.add(new ScreenItem(CARD_BOTTOM_SHADOW));
@@ -61,7 +63,7 @@ public void selectDevice(@NonNull InputDeviceProfile device) {
 	public void askAddNewCustomDevice() {
 		String title = app.getString(R.string.add_new_type);
 		showEnterNameDialog(title, "", newName -> {
-			deviceHelper.createAndSaveCustomDevice(appMode, newName);
+			deviceHelper.createAndSaveCustomDevice(CUSTOMIZATION_CACHE_ID, appMode, newName);
 			return true;
 		});
 	}
@@ -70,7 +72,7 @@ public void askRenameDevice(@NonNull InputDeviceProfile device) {
 		String title = app.getString(R.string.shared_string_rename);
 		showEnterNameDialog(title, device.toHumanString(app), newName -> {
 			if (device instanceof CustomInputDeviceProfile) {
-				deviceHelper.renameCustomDevice(appMode, (CustomInputDeviceProfile) device, newName);
+				deviceHelper.renameCustomDevice(CUSTOMIZATION_CACHE_ID, appMode, device.getId(), newName);
 			}
 			return true;
 		});
@@ -94,7 +96,7 @@ private void showEnterNameDialog(@NonNull String title, @NonNull String oldName,
 				if (Algorithms.isBlank(newName)) {
 					app.showToastMessage(R.string.empty_name);
 				} else {
-					if (deviceHelper.hasDeviceNameDuplicate(appMode, newName)) {
+					if (deviceHelper.hasDeviceNameDuplicate(CUSTOMIZATION_CACHE_ID, appMode, app, newName)) {
 						app.showToastMessage(R.string.message_name_is_already_exists);
 					} else {
 						callback.processResult(newName.trim());
@@ -107,7 +109,7 @@ private void showEnterNameDialog(@NonNull String title, @NonNull String oldName,
 	}
 
 	public void duplicateDevice(@NonNull InputDeviceProfile device) {
-		deviceHelper.createAndSaveDeviceDuplicate(appMode, device);
+		deviceHelper.createAndSaveDeviceDuplicate(CUSTOMIZATION_CACHE_ID, appMode, device);
 	}
 
 	public void askRemoveDevice(@NonNull InputDeviceProfile device) {
@@ -119,7 +121,7 @@ public void askRemoveDevice(@NonNull InputDeviceProfile device) {
 				.setNegativeButton(R.string.shared_string_cancel, null)
 				.setPositiveButtonTextColor(ColorUtilities.getColor(app, R.color.color_warning))
 				.setPositiveButton(R.string.shared_string_delete, (dialog, which) -> {
-					deviceHelper.removeCustomDevice(appMode, device.getId());
+					deviceHelper.removeCustomDevice(CUSTOMIZATION_CACHE_ID, appMode, device.getId());
 				});
 		String typeName = device.toHumanString(app);
 		String message = app.getString(R.string.remove_type_q, typeName);
@@ -127,11 +129,8 @@ public void askRemoveDevice(@NonNull InputDeviceProfile device) {
 	}
 
 	public boolean isSelected(@NonNull InputDeviceProfile device) {
-		return deviceHelper.isSelectedDevice(appMode, device.getId());
-	}
-
-	public boolean isCustom(@NonNull InputDeviceProfile device) {
-		return deviceHelper.isCustomDevice(device);
+		InputDeviceProfile selectedDevice = deviceHelper.getSelectedDevice(CUSTOMIZATION_CACHE_ID, appMode);
+		return Objects.equals(selectedDevice.getId(), device.getId());
 	}
 
 	private boolean isNightMode() {
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesFragment.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesFragment.java
index 72cf7515fbd..6dba8c6419d 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesFragment.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/inputdevices/InputDevicesFragment.java
@@ -24,12 +24,12 @@
 import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.keyevent.InputDeviceHelper;
 import net.osmand.plus.keyevent.callbacks.EventType;
-import net.osmand.plus.keyevent.callbacks.InputDevicesEventCallback;
+import net.osmand.plus.keyevent.callbacks.InputDevicesEventListener;
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.plus.utils.ColorUtilities;
 
-public class InputDevicesFragment extends BaseOsmAndFragment implements InputDevicesEventCallback {
+public class InputDevicesFragment extends BaseOsmAndFragment implements InputDevicesEventListener {
 
 	public static final String TAG = InputDevicesFragment.class.getSimpleName();
 
@@ -87,7 +87,7 @@ private void setupToolbar(@NonNull View view) {
 	}
 
 	@Override
-	public void processInputDevicesEvent(@NonNull EventType event) {
+	public void processInputDevicesEvent(@NonNull ApplicationMode appMode, @NonNull EventType event) {
 		if (event.isDeviceRelated()) {
 			updateViewContent();
 		}
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsController.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsController.java
index 323abc16f1e..f9ce460b57e 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsController.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsController.java
@@ -1,5 +1,6 @@
 package net.osmand.plus.keyevent.fragments.keybindings;
 
+import static net.osmand.plus.keyevent.InputDeviceHelper.CUSTOMIZATION_CACHE_ID;
 import static net.osmand.plus.keyevent.fragments.keybindings.KeyBindingsAdapter.CARD_BOTTOM_SHADOW;
 import static net.osmand.plus.keyevent.fragments.keybindings.KeyBindingsAdapter.CARD_DIVIDER;
 import static net.osmand.plus.keyevent.fragments.keybindings.KeyBindingsAdapter.CARD_TOP_DIVIDER;
@@ -43,7 +44,7 @@ public KeyBindingsController(@NonNull OsmandApplication app,
 		this.appMode = appMode;
 		this.usedOnMap = usedOnMap;
 		this.deviceHelper = app.getInputDeviceHelper();
-		this.inputDevice = deviceHelper.getSelectedDevice(appMode);
+		this.inputDevice = deviceHelper.getSelectedDevice(CUSTOMIZATION_CACHE_ID, appMode);
 	}
 
 	@NonNull
@@ -77,13 +78,13 @@ public void askRemoveAllKeyBindings() {
 				.setTitle(R.string.reset_key_assignments)
 				.setNegativeButton(R.string.shared_string_cancel, null)
 				.setPositiveButton(R.string.shared_string_reset_all, (dialog, which) -> {
-					deviceHelper.resetAllKeyBindings(appMode, inputDevice.getId());
+					deviceHelper.resetAllKeyBindings(CUSTOMIZATION_CACHE_ID, appMode, inputDevice.getId());
 				});
 		CustomAlert.showSimpleMessage(dialogData, R.string.reset_key_assignments_desc);
 	}
 
 	public boolean isDeviceTypeEditable() {
-		return inputDevice != null && deviceHelper.isCustomDevice(inputDevice);
+		return inputDevice != null && inputDevice.isCustom();
 	}
 
 	public void askEditKeyAction(KeyBinding action) {
diff --git a/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsFragment.java b/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsFragment.java
index a98f2159ff5..24369adc891 100644
--- a/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/keyevent/fragments/keybindings/KeyBindingsFragment.java
@@ -25,12 +25,12 @@
 import net.osmand.plus.helpers.AndroidUiHelper;
 import net.osmand.plus.keyevent.InputDeviceHelper;
 import net.osmand.plus.keyevent.callbacks.EventType;
-import net.osmand.plus.keyevent.callbacks.InputDevicesEventCallback;
+import net.osmand.plus.keyevent.callbacks.InputDevicesEventListener;
 import net.osmand.plus.settings.backend.ApplicationMode;
 import net.osmand.plus.utils.AndroidUtils;
 import net.osmand.plus.utils.ColorUtilities;
 
-public class KeyBindingsFragment extends BaseOsmAndFragment implements InputDevicesEventCallback {
+public class KeyBindingsFragment extends BaseOsmAndFragment implements InputDevicesEventListener {
 
 	public static final String TAG = KeyBindingsFragment.class.getSimpleName();
 
@@ -97,7 +97,7 @@ private void setupToolbar(@NonNull View view) {
 	}
 
 	@Override
-	public void processInputDevicesEvent(@NonNull EventType event) {
+	public void processInputDevicesEvent(@NonNull ApplicationMode appMode, @NonNull EventType event) {
 		if (event.isKeyBindingRelated()) {
 			updateViewContent();
 		}
diff --git a/OsmAnd/src/net/osmand/plus/settings/fragments/GeneralProfileSettingsFragment.java b/OsmAnd/src/net/osmand/plus/settings/fragments/GeneralProfileSettingsFragment.java
index 07155ae99ec..e6b6cb230cb 100644
--- a/OsmAnd/src/net/osmand/plus/settings/fragments/GeneralProfileSettingsFragment.java
+++ b/OsmAnd/src/net/osmand/plus/settings/fragments/GeneralProfileSettingsFragment.java
@@ -1,12 +1,12 @@
 package net.osmand.plus.settings.fragments;
 
+import static net.osmand.plus.keyevent.InputDeviceHelper.CUSTOMIZATION_CACHE_ID;
 import static net.osmand.plus.settings.fragments.SettingsScreenType.EXTERNAL_INPUT_DEVICE;
 
 import android.content.Context;
 import android.content.pm.ActivityInfo;
 import android.content.res.Configuration;
 import android.graphics.drawable.Drawable;
-import android.os.Build;
 import android.os.Bundle;
 import android.view.LayoutInflater;
 import android.view.View;
@@ -267,14 +267,16 @@ private void setupExternalInputDevicePref() {
 	}
 
 	private String getExternalInputDeviceSummary() {
+		ApplicationMode appMode = getSelectedAppMode();
 		InputDeviceHelper deviceHelper = app.getInputDeviceHelper();
-		InputDeviceProfile inputDevice = deviceHelper.getEnabledDevice(getSelectedAppMode());
+		InputDeviceProfile inputDevice = deviceHelper.getEnabledSelectedDevice(CUSTOMIZATION_CACHE_ID, appMode);
 		return inputDevice != null ? inputDevice.toHumanString(app) : getString(R.string.shared_string_disabled);
 	}
 
 	private Drawable getExternalInputDeviceIcon() {
+		ApplicationMode appMode = getSelectedAppMode();
 		InputDeviceHelper deviceHelper = app.getInputDeviceHelper();
-		return deviceHelper.getEnabledDevice(getSelectedAppMode()) != null
+		return deviceHelper.getEnabledSelectedDevice(CUSTOMIZATION_CACHE_ID, appMode) != null
 				? getActiveIcon(R.drawable.ic_action_keyboard)
 				: getContentIcon(R.drawable.ic_action_keyboard_disabled);
 	}
@@ -335,9 +337,7 @@ public View getView(int position, View convertView, @NonNull ViewGroup parent) {
 							desc.setVisibility(View.GONE);
 						}
 						title.setChecked(position == selected);
-						if (Build.VERSION.SDK_INT >= Build.VERSION_CODES.JELLY_BEAN) {
-							UiUtilities.setupCompoundButtonDrawable(app, isNightMode(), getActiveProfileColor(), title.getCheckMarkDrawable());
-						}
+						UiUtilities.setupCompoundButtonDrawable(app, isNightMode(), getActiveProfileColor(), title.getCheckMarkDrawable());
 						return v;
 					}
 				};
