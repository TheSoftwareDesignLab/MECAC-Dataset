diff --git a/Signal.xcodeproj/project.pbxproj b/Signal.xcodeproj/project.pbxproj
index d835bd1f95f..4cef7551dcf 100644
--- a/Signal.xcodeproj/project.pbxproj
+++ b/Signal.xcodeproj/project.pbxproj
@@ -69,7 +69,7 @@
 		34123C5E239AA3E900782788 /* TooltipView.swift in Sources */ = {isa = PBXBuildFile; fileRef = 34123C5D239AA3E900782788 /* TooltipView.swift */; };
 		34123C60239AA93B00782788 /* ViewOnceTooltip.swift in Sources */ = {isa = PBXBuildFile; fileRef = 34123C5F239AA93A00782788 /* ViewOnceTooltip.swift */; };
 		3412F9BB2350D0840022EDAA /* ThreadPerformanceTest.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3412F9BA2350D0840022EDAA /* ThreadPerformanceTest.swift */; };
-		3415217525B0CB31009F177F /* AttachmentProgressView.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3415217425B0CB30009F177F /* AttachmentProgressView.swift */; };
+		3415217525B0CB31009F177F /* CVAttachmentProgressView.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3415217425B0CB30009F177F /* CVAttachmentProgressView.swift */; };
 		3416BCAE2277A24000E761B4 /* StickerPackDataSource.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3416BCAD2277A24000E761B4 /* StickerPackDataSource.swift */; };
 		341CBFC42405B7C000F15C13 /* GroupsV2Impl+RestoreGroups.swift in Sources */ = {isa = PBXBuildFile; fileRef = 341CBFC32405B7C000F15C13 /* GroupsV2Impl+RestoreGroups.swift */; };
 		341D392925472F3B00996E7B /* CVViewState.swift in Sources */ = {isa = PBXBuildFile; fileRef = 341D392825472F3B00996E7B /* CVViewState.swift */; };
@@ -203,6 +203,10 @@
 		347024A0238C85850078D72C /* VersionedProfilesImpl.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3470249F238C85850078D72C /* VersionedProfilesImpl.swift */; };
 		3470518C254B320700A19468 /* CVRenderState.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3470518B254B320700A19468 /* CVRenderState.swift */; };
 		3470518E254B511B00A19468 /* ConversationViewController+CVC.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3470518D254B511B00A19468 /* ConversationViewController+CVC.swift */; };
+		347091CF25B74B820061A8FF /* determinate_spinner_blue.json in Resources */ = {isa = PBXBuildFile; fileRef = 347091CB25B74B820061A8FF /* determinate_spinner_blue.json */; };
+		347091D025B74B820061A8FF /* indeterminate_spinner_blue.json in Resources */ = {isa = PBXBuildFile; fileRef = 347091CC25B74B820061A8FF /* indeterminate_spinner_blue.json */; };
+		347091D125B74B820061A8FF /* determinate_spinner.json in Resources */ = {isa = PBXBuildFile; fileRef = 347091CD25B74B820061A8FF /* determinate_spinner.json */; };
+		347091D225B74B820061A8FF /* indeterminate_spinner.json in Resources */ = {isa = PBXBuildFile; fileRef = 347091CE25B74B820061A8FF /* indeterminate_spinner.json */; };
 		3470C8742554926200F5847C /* QuotedMessageView.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3470C8732554926200F5847C /* QuotedMessageView.swift */; };
 		3470C8772555883600F5847C /* CVLoadRequest.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3470C8752555883600F5847C /* CVLoadRequest.swift */; };
 		3470C8782555883600F5847C /* CVLoadContext.swift in Sources */ = {isa = PBXBuildFile; fileRef = 3470C8762555883600F5847C /* CVLoadContext.swift */; };
@@ -1045,7 +1049,7 @@
 		34129B8521EF8779005457A8 /* LinkPreviewView.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = LinkPreviewView.swift; sourceTree = "<group>"; };
 		3412F9BA2350D0840022EDAA /* ThreadPerformanceTest.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = ThreadPerformanceTest.swift; sourceTree = "<group>"; };
 		341458471FBE11C4005ABCF9 /* fa */ = {isa = PBXFileReference; lastKnownFileType = text.plist.strings; name = fa; path = translations/fa.lproj/Localizable.strings; sourceTree = "<group>"; };
-		3415217425B0CB30009F177F /* AttachmentProgressView.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = AttachmentProgressView.swift; sourceTree = "<group>"; };
+		3415217425B0CB30009F177F /* CVAttachmentProgressView.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = CVAttachmentProgressView.swift; sourceTree = "<group>"; };
 		3416BCAD2277A24000E761B4 /* StickerPackDataSource.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = StickerPackDataSource.swift; sourceTree = "<group>"; };
 		341CBFC32405B7C000F15C13 /* GroupsV2Impl+RestoreGroups.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = "GroupsV2Impl+RestoreGroups.swift"; sourceTree = "<group>"; };
 		341D392825472F3B00996E7B /* CVViewState.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = CVViewState.swift; sourceTree = "<group>"; };
@@ -1199,6 +1203,10 @@
 		3470249F238C85850078D72C /* VersionedProfilesImpl.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = VersionedProfilesImpl.swift; sourceTree = "<group>"; };
 		3470518B254B320700A19468 /* CVRenderState.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = CVRenderState.swift; sourceTree = "<group>"; };
 		3470518D254B511B00A19468 /* ConversationViewController+CVC.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = "ConversationViewController+CVC.swift"; sourceTree = "<group>"; };
+		347091CB25B74B820061A8FF /* determinate_spinner_blue.json */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.json; path = determinate_spinner_blue.json; sourceTree = "<group>"; };
+		347091CC25B74B820061A8FF /* indeterminate_spinner_blue.json */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.json; path = indeterminate_spinner_blue.json; sourceTree = "<group>"; };
+		347091CD25B74B820061A8FF /* determinate_spinner.json */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.json; path = determinate_spinner.json; sourceTree = "<group>"; };
+		347091CE25B74B820061A8FF /* indeterminate_spinner.json */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.json; path = indeterminate_spinner.json; sourceTree = "<group>"; };
 		3470C8732554926200F5847C /* QuotedMessageView.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = QuotedMessageView.swift; sourceTree = "<group>"; };
 		3470C8752555883600F5847C /* CVLoadRequest.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = CVLoadRequest.swift; sourceTree = "<group>"; };
 		3470C8762555883600F5847C /* CVLoadContext.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = CVLoadContext.swift; sourceTree = "<group>"; };
@@ -2917,10 +2925,10 @@
 		34D1F0951F867BFC0066283D /* Cells */ = {
 			isa = PBXGroup;
 			children = (
-				3415217425B0CB30009F177F /* AttachmentProgressView.swift */,
 				88594E592335B08000390B19 /* AudioMessageView.swift */,
 				88A695BC232C18DF002F7B9B /* AudioWaveformProgressView.swift */,
 				3488F9352191CC4000E524CC /* ConversationMediaView.swift */,
+				3415217425B0CB30009F177F /* CVAttachmentProgressView.swift */,
 				3470C87F2555F25200F5847C /* CVContactShareView.swift */,
 				34A8B3502190A40E00218A25 /* CVMediaAlbumView.swift */,
 				34635331257549F1003C5428 /* CVReactionCountsView.swift */,
@@ -3540,6 +3548,10 @@
 			isa = PBXGroup;
 			children = (
 				88A9419324099F6E000E9700 /* Attachment Keyboard */,
+				347091CB25B74B820061A8FF /* determinate_spinner_blue.json */,
+				347091CD25B74B820061A8FF /* determinate_spinner.json */,
+				347091CC25B74B820061A8FF /* indeterminate_spinner_blue.json */,
+				347091CE25B74B820061A8FF /* indeterminate_spinner.json */,
 				887CD48924735D4200FDD265 /* launchApp-iPad.json */,
 				887CD48824735D4200FDD265 /* launchApp-iPhone.json */,
 				4C9D34842369EA3E006A4307 /* NotificationPermission */,
@@ -4342,9 +4354,11 @@
 				45B74A872044AAB600CD42F8 /* complete-quiet.aifc in Resources */,
 				88D6E93F254CF712003142D9 /* group_call_leave.aiff in Resources */,
 				45B74A772044AAB600CD42F8 /* hello.aifc in Resources */,
+				347091D025B74B820061A8FF /* indeterminate_spinner_blue.json in Resources */,
 				45B74A7C2044AAB600CD42F8 /* hello-quiet.aifc in Resources */,
 				45B74A792044AAB600CD42F8 /* input.aifc in Resources */,
 				45B74A8C2044AAB600CD42F8 /* input-quiet.aifc in Resources */,
+				347091D125B74B820061A8FF /* determinate_spinner.json in Resources */,
 				45B74A7A2044AAB600CD42F8 /* keys.aifc in Resources */,
 				45B74A762044AAB600CD42F8 /* keys-quiet.aifc in Resources */,
 				45B74A862044AAB600CD42F8 /* note.aifc in Resources */,
@@ -4358,9 +4372,11 @@
 				887CD48A24735D4200FDD265 /* launchApp-iPhone.json in Resources */,
 				45B74A802044AAB600CD42F8 /* pulse-quiet.aifc in Resources */,
 				882F8DE6251AB23600AA4359 /* Settings.bundle in Resources */,
+				347091CF25B74B820061A8FF /* determinate_spinner_blue.json in Resources */,
 				45B74A8B2044AAB600CD42F8 /* synth.aifc in Resources */,
 				888C828223D795FA0059464B /* pinCreationFail.json in Resources */,
 				45B74A752044AAB600CD42F8 /* synth-quiet.aifc in Resources */,
+				347091D225B74B820061A8FF /* indeterminate_spinner.json in Resources */,
 			);
 			runOnlyForDeploymentPostprocessing = 0;
 		};
@@ -5042,7 +5058,7 @@
 				3434AE1C22AEDE7D002EE04E /* ViewOnceMessageViewController.swift in Sources */,
 				88D1BCBB24F73C15009A1738 /* PhoneNumberDiscoverabilitySettingsTableViewController.swift in Sources */,
 				349767E425B8744700ECE1B0 /* StickerPackViewController.swift in Sources */,
-				3415217525B0CB31009F177F /* AttachmentProgressView.swift in Sources */,
+				3415217525B0CB31009F177F /* CVAttachmentProgressView.swift in Sources */,
 				88ABB8B52534070400229EAA /* CallHeader.swift in Sources */,
 				347B83FD24378DDF0019A52C /* GroupMemberRequestsAndInvitesViewController.swift in Sources */,
 				3426A366255C854B0036407F /* CVItemViewModelImpl.swift in Sources */,
diff --git a/Signal/Images.xcassets/stop-20.imageset/Contents.json b/Signal/Images.xcassets/stop-20.imageset/Contents.json
new file mode 100644
index 00000000000..ea2991e9658
--- /dev/null
+++ b/Signal/Images.xcassets/stop-20.imageset/Contents.json
@@ -0,0 +1,21 @@
+{
+  "images" : [
+    {
+      "filename" : "stop-20.pdf",
+      "idiom" : "universal",
+      "scale" : "1x"
+    },
+    {
+      "idiom" : "universal",
+      "scale" : "2x"
+    },
+    {
+      "idiom" : "universal",
+      "scale" : "3x"
+    }
+  ],
+  "info" : {
+    "author" : "xcode",
+    "version" : 1
+  }
+}
diff --git a/Signal/Images.xcassets/stop-20.imageset/stop-20.pdf b/Signal/Images.xcassets/stop-20.imageset/stop-20.pdf
new file mode 100644
index 00000000000..6427a878ed7
Binary files /dev/null and b/Signal/Images.xcassets/stop-20.imageset/stop-20.pdf differ
diff --git a/Signal/Lottie/determinate_spinner.json b/Signal/Lottie/determinate_spinner.json
new file mode 100644
index 00000000000..578c00619f3
--- /dev/null
+++ b/Signal/Lottie/determinate_spinner.json
@@ -0,0 +1 @@
+{"v":"5.7.1","fr":60,"ip":0,"op":324,"w":44,"h":44,"nm":"Progress indicator - Determinate - Circular","ddd":0,"assets":[],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[22,22,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"i":{"x":[1,1,0.833],"y":[1,1,1]},"o":{"x":[0.4,0.4,0.167],"y":[0,0,0]},"t":180,"s":[44,44,100]},{"t":185,"s":[36.08,36.08,100]}],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[70,70],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[1,1,1,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":1,"k":[{"i":{"x":[1],"y":[1]},"o":{"x":[0.167],"y":[0]},"t":0,"s":[6.5]},{"i":{"x":[1],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":180,"s":[8]},{"t":185,"s":[0]}],"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":0,"k":0,"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.63],"y":[0]},"t":0,"s":[0]},{"t":181,"s":[100]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":0,"op":483,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"1","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[22,22,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"i":{"x":[1,1,0.833],"y":[1,1,1]},"o":{"x":[0.4,0.4,0.167],"y":[0,0,0]},"t":180,"s":[44,44,100]},{"t":185,"s":[36.08,36.08,100]}],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[70,70],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[1,1,1,1],"ix":3},"o":{"a":0,"k":50,"ix":4},"w":{"a":1,"k":[{"i":{"x":[1],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":180,"s":[8]},{"t":185,"s":[0]}],"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":0,"k":100,"ix":1},"e":{"a":0,"k":0,"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":0,"op":483,"st":0,"bm":0}],"markers":[]}
\ No newline at end of file
diff --git a/Signal/Lottie/determinate_spinner_blue.json b/Signal/Lottie/determinate_spinner_blue.json
new file mode 100644
index 00000000000..785d5e9104e
--- /dev/null
+++ b/Signal/Lottie/determinate_spinner_blue.json
@@ -0,0 +1 @@
+{"v":"5.7.1","fr":60,"ip":0,"op":210,"w":44,"h":44,"nm":"Progress indicator - Determinate - Circular Blue","ddd":0,"assets":[],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"2","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[22,22,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"i":{"x":[1,1,0.833],"y":[1,1,1]},"o":{"x":[0.4,0.4,0.167],"y":[0,0,0]},"t":180,"s":[44,44,100]},{"t":185,"s":[36.08,36.08,100]}],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[70,70],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[0.172549024224,0.419607847929,0.929411768913,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":1,"k":[{"i":{"x":[1],"y":[1]},"o":{"x":[0.167],"y":[0]},"t":0,"s":[6.5]},{"i":{"x":[1],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":180,"s":[8]},{"t":185,"s":[0]}],"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":0,"k":0,"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.63],"y":[0]},"t":0,"s":[0]},{"t":181,"s":[100]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":0,"op":210,"st":0,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"1","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[22,22,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":1,"k":[{"i":{"x":[1,1,0.833],"y":[1,1,1]},"o":{"x":[0.4,0.4,0.167],"y":[0,0,0]},"t":180,"s":[44,44,100]},{"t":185,"s":[36.08,36.08,100]}],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[70,70],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[0.517647087574,0.517647087574,0.517647087574,1],"ix":3},"o":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":0,"s":[30]},{"t":250,"s":[50]}],"ix":4},"w":{"a":1,"k":[{"i":{"x":[1],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":180,"s":[8]},{"t":185,"s":[0]}],"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":0,"k":100,"ix":1},"e":{"a":0,"k":0,"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":0,"op":210,"st":0,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"play Outlines","sr":1,"ks":{"o":{"a":1,"k":[{"i":{"x":[0.667],"y":[1]},"o":{"x":[0.333],"y":[0]},"t":196,"s":[0]},{"t":200,"s":[100]}],"ix":11},"r":{"a":0,"k":0,"ix":10},"p":{"a":0,"k":[22,22,0],"ix":2},"a":{"a":0,"k":[22,22,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"ind":0,"ty":"sh","ix":1,"ks":{"a":0,"k":{"i":[[0,0],[-0.373,0],[0,0],[-0.153,-0.099],[0,0],[-0.081,-0.123],[0,-0.15],[0.082,-0.123],[0.135,-0.052],[0,0],[0.179,-0.007],[0,0.537]],"o":[[0,-0.537],[0,0],[0.179,0.007],[0,0],[0.135,0.052],[0.082,0.123],[0,0.149],[-0.081,0.123],[0,0],[-0.152,0.1],[-0.373,0],[0,0]],"v":[[-7.971,-8.708],[-7.341,-9.557],[-7.339,-9.557],[-6.833,-9.395],[7.514,-0.689],[7.845,-0.421],[7.971,-0.001],[7.845,0.417],[7.514,0.686],[-6.835,9.393],[-7.341,9.557],[-7.971,8.708]],"c":true},"ix":2},"nm":"Path 1","mn":"ADBE Vector Shape - Group","hd":false},{"ty":"fl","c":{"a":0,"k":[1,1,1,1],"ix":4},"o":{"a":0,"k":100,"ix":5},"r":1,"bm":0,"nm":"Fill 1","mn":"ADBE Vector Graphic - Fill","hd":false},{"ty":"tr","p":{"a":0,"k":[24.471,22],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Group 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false}],"ip":0,"op":210,"st":0,"bm":0}],"markers":[]}
\ No newline at end of file
diff --git a/Signal/Lottie/indeterminate_spinner.json b/Signal/Lottie/indeterminate_spinner.json
new file mode 100644
index 00000000000..fba2eb75b95
--- /dev/null
+++ b/Signal/Lottie/indeterminate_spinner.json
@@ -0,0 +1 @@
+{"v":"5.7.1","fr":60,"ip":1,"op":324,"w":44,"h":44,"nm":"Progress indicator - Indeterminate - Circular","ddd":0,"assets":[],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"4","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":243,"s":[787.1]},{"t":323,"s":[804.2]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[1,1,1,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":283,"s":[0]},{"t":323,"s":[69.5]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":243,"s":[5.5]},{"t":283,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":243,"op":324,"st":243,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"3","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":162,"s":[519]},{"t":242,"s":[536]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[1,1,1,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":202,"s":[0]},{"t":242,"s":[69.5]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":162,"s":[5.5]},{"t":202,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":162,"op":243,"st":162,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"2","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":81,"s":[249]},{"t":162,"s":[268]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[1,1,1,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":121,"s":[0]},{"t":161,"s":[69.5]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":81,"s":[5.5]},{"t":121,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":81,"op":162,"st":81,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"1","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":0,"s":[-26]},{"t":81,"s":[0]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[1,1,1,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":40,"s":[0]},{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.167],"y":[0]},"t":80,"s":[69]},{"t":81,"s":[69]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":0,"s":[5.5]},{"t":40,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":0,"op":81,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rotator","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":0,"s":[0]},{"t":323,"s":[1444]}],"ix":10},"p":{"a":0,"k":[22,22,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[44,44,100],"ix":6}},"ao":0,"shapes":[],"ip":0,"op":324,"st":0,"bm":0}],"markers":[]}
\ No newline at end of file
diff --git a/Signal/Lottie/indeterminate_spinner_blue.json b/Signal/Lottie/indeterminate_spinner_blue.json
new file mode 100644
index 00000000000..f132bfe24d4
--- /dev/null
+++ b/Signal/Lottie/indeterminate_spinner_blue.json
@@ -0,0 +1 @@
+{"v":"5.7.1","fr":60,"ip":1,"op":324,"w":44,"h":44,"nm":"Progress indicator - Indeterminate - Circular Blue","ddd":0,"assets":[],"layers":[{"ddd":0,"ind":1,"ty":4,"nm":"4","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":243,"s":[787.1]},{"t":323,"s":[804.2]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[0.172549024224,0.419607847929,0.929411768913,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":283,"s":[0]},{"t":323,"s":[69.5]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":243,"s":[5.5]},{"t":283,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":243,"op":324,"st":243,"bm":0},{"ddd":0,"ind":2,"ty":4,"nm":"3","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":162,"s":[519]},{"t":242,"s":[536]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[0.172549024224,0.419607847929,0.929411768913,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":202,"s":[0]},{"t":242,"s":[69.5]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":162,"s":[5.5]},{"t":202,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":162,"op":243,"st":162,"bm":0},{"ddd":0,"ind":3,"ty":4,"nm":"2","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":81,"s":[249]},{"t":162,"s":[268]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[0.172549024224,0.419607847929,0.929411768913,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":121,"s":[0]},{"t":161,"s":[69.5]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":81,"s":[5.5]},{"t":121,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":81,"op":162,"st":81,"bm":0},{"ddd":0,"ind":4,"ty":4,"nm":"1","parent":5,"sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":0,"s":[-26]},{"t":81,"s":[0]}],"ix":10},"p":{"a":0,"k":[0,0,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[100,100,100],"ix":6}},"ao":0,"shapes":[{"ty":"gr","it":[{"d":1,"ty":"el","s":{"a":0,"k":[64,64],"ix":2},"p":{"a":0,"k":[0,0],"ix":3},"nm":"Ellipse Path 1","mn":"ADBE Vector Shape - Ellipse","hd":false},{"ty":"st","c":{"a":0,"k":[0.172549024224,0.419607847929,0.929411768913,1],"ix":3},"o":{"a":0,"k":100,"ix":4},"w":{"a":0,"k":6.5,"ix":5},"lc":1,"lj":2,"bm":0,"nm":"Stroke 1","mn":"ADBE Vector Graphic - Stroke","hd":false},{"ty":"tr","p":{"a":0,"k":[0,0],"ix":2},"a":{"a":0,"k":[0,0],"ix":1},"s":{"a":0,"k":[100,100],"ix":3},"r":{"a":0,"k":0,"ix":6},"o":{"a":0,"k":100,"ix":7},"sk":{"a":0,"k":0,"ix":4},"sa":{"a":0,"k":0,"ix":5},"nm":"Transform"}],"nm":"Ellipse 1","np":2,"cix":2,"bm":0,"ix":1,"mn":"ADBE Vector Group","hd":false},{"ty":"tm","s":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":40,"s":[0]},{"i":{"x":[0.833],"y":[1]},"o":{"x":[0.167],"y":[0]},"t":80,"s":[69]},{"t":81,"s":[69]}],"ix":1},"e":{"a":1,"k":[{"i":{"x":[0.2],"y":[1]},"o":{"x":[0.4],"y":[0]},"t":0,"s":[5.5]},{"t":40,"s":[75]}],"ix":2},"o":{"a":0,"k":1,"ix":3},"m":1,"ix":2,"nm":"Trim Paths 1","mn":"ADBE Vector Filter - Trim","hd":false}],"ip":0,"op":81,"st":0,"bm":0},{"ddd":0,"ind":5,"ty":4,"nm":"Rotator","sr":1,"ks":{"o":{"a":0,"k":100,"ix":11},"r":{"a":1,"k":[{"i":{"x":[0.833],"y":[0.833]},"o":{"x":[0.167],"y":[0.167]},"t":0,"s":[0]},{"t":323,"s":[1444]}],"ix":10},"p":{"a":0,"k":[22,22,0],"ix":2},"a":{"a":0,"k":[0,0,0],"ix":1},"s":{"a":0,"k":[44,44,100],"ix":6}},"ao":0,"shapes":[],"ip":0,"op":324,"st":0,"bm":0}],"markers":[]}
\ No newline at end of file
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyMedia.swift b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyMedia.swift
index fbd28006dcf..d22b5da507a 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyMedia.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyMedia.swift
@@ -70,7 +70,8 @@ public class CVComponentBodyMedia: CVComponentBase, CVComponent {
                             items: self.items,
                             isOutgoing: self.isOutgoing,
                             isBorderless: self.isBorderless,
-                            cellMeasurement: cellMeasurement)
+                            cellMeasurement: cellMeasurement,
+                            conversationStyle: conversationStyle)
 
         let blockLayoutView = componentView.blockLayoutView
         blockLayoutView.addSubview(albumView)
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentGenericAttachment.swift b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentGenericAttachment.swift
index 9a739a0fd73..689d0393c6c 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentGenericAttachment.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentGenericAttachment.swift
@@ -193,8 +193,9 @@ public class CVComponentGenericAttachment: CVComponentBase, CVComponent {
         }
 
         let downloadViewSize = min(iconSize.width, iconSize.height)
-        let progressView = AttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
-                                                  style: .withoutCircle(diameter: downloadViewSize))
+        let progressView = CVAttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
+                                                    style: .withoutCircle(diameter: downloadViewSize),
+                                                    conversationStyle: conversationStyle)
         return progressView
     }
 
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentViewOnce.swift b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentViewOnce.swift
index 389bf34e28a..e328ba1c576 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentViewOnce.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentViewOnce.swift
@@ -88,8 +88,9 @@ public class CVComponentViewOnce: CVComponentBase, CVComponent {
 
         switch viewOnceState {
         case .incomingDownloading(let attachmentPointer):
-            let progressView = AttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
-                                                      style: .withoutCircle(diameter: iconSize))
+            let progressView = CVAttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
+                                                        style: .withoutCircle(diameter: iconSize),
+                                                        conversationStyle: conversationStyle)
             componentView.hStackView.addArrangedSubview(progressView)
         default:
             if shouldShowIcon, let iconName = self.iconName {
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/AudioMessageView.swift b/Signal/src/ViewControllers/ConversationView/Cells/AudioMessageView.swift
index 56794dab88d..8e69036ada8 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/AudioMessageView.swift
+++ b/Signal/src/ViewControllers/ConversationView/Cells/AudioMessageView.swift
@@ -105,8 +105,9 @@ class AudioMessageView: OWSStackView {
 
             leftView = playPauseAnimation
         } else if let attachmentPointer = audioAttachment.attachmentPointer {
-            leftView = AttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
-                                              style: .withoutCircle(diameter: Self.animationSize))
+            leftView = CVAttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
+                                                style: .withoutCircle(diameter: Self.animationSize),
+                                                conversationStyle: conversationStyle)
         } else {
             owsFailDebug("Unexpected state.")
             leftView = UIView()
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/AttachmentProgressView.swift b/Signal/src/ViewControllers/ConversationView/Cells/CVAttachmentProgressView.swift
similarity index 64%
rename from Signal/src/ViewControllers/ConversationView/Cells/AttachmentProgressView.swift
rename to Signal/src/ViewControllers/ConversationView/Cells/CVAttachmentProgressView.swift
index 639d6d5ca95..dafea05a68d 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/AttachmentProgressView.swift
+++ b/Signal/src/ViewControllers/ConversationView/Cells/CVAttachmentProgressView.swift
@@ -7,7 +7,7 @@ import Lottie
 
 // A view for presenting attachment upload/download/failure/pending state.
 @objc
-public class AttachmentProgressView: UIView {
+public class CVAttachmentProgressView: UIView {
 
     public enum Direction {
         case upload(attachmentStream: TSAttachmentStream)
@@ -45,15 +45,20 @@ public class AttachmentProgressView: UIView {
 
     private let direction: Direction
     private let style: Style
-
-    private var attachmentId: String { direction.attachmentId }
+    private let conversationStyle: ConversationStyle
 
     private let stateView: StateView
 
-    public required init(direction: Direction, style: Style) {
+    private var attachmentId: String { direction.attachmentId }
+
+    public required init(direction: Direction, style: Style, conversationStyle: ConversationStyle) {
         self.direction = direction
         self.style = style
-        self.stateView = StateView(diameter: Self.innerDiameter(style: style), style: style)
+        self.conversationStyle = conversationStyle
+        self.stateView = StateView(diameter: Self.innerDiameter(style: style),
+                                   direction: direction,
+                                   style: style,
+                                   conversationStyle: conversationStyle)
 
         super.init(frame: .zero)
 
@@ -96,13 +101,35 @@ public class AttachmentProgressView: UIView {
         case uploadUnknownProgress
         case downloadProgress(progress: CGFloat)
         case uploadProgress(progress: CGFloat)
+        
+        var debugDescription: String {
+            switch self {
+            case .none:
+                return "none"
+            case .tapToDownload:
+                return "tapToDownload"
+            case .downloadFailed:
+                return "downloadFailed"
+            case .downloadUnknownProgress:
+                return "downloadUnknownProgress"
+            case .uploadUnknownProgress:
+                return "uploadUnknownProgress"
+            case .downloadProgress(let progress):
+                return "downloadProgress: \(progress)"
+            case .uploadProgress(let progress):
+                return "uploadProgress: \(progress)"
+            }
+        }
     }
 
     private class StateView: UIView {
         private let diameter: CGFloat
+        private let direction: Direction
         private let style: Style
+        private let conversationStyle: ConversationStyle
         private lazy var imageView = UIImageView()
-        private lazy var progressView = CircularProgressView(thickness: 0.1)
+        private var unknownProgressView: Lottie.AnimationView?
+        private var progressView: Lottie.AnimationView?
 
         private var layoutConstraints = [NSLayoutConstraint]()
 
@@ -112,9 +139,21 @@ public class AttachmentProgressView: UIView {
             }
         }
 
-        required init(diameter: CGFloat, style: Style) {
+        private var isDarkThemeEnabled: Bool { conversationStyle.isDarkThemeEnabled }
+        private var isIncoming: Bool {
+            switch direction {
+            case .upload:
+                return false
+            case .download:
+                return true
+            }
+        }
+
+        required init(diameter: CGFloat, direction: Direction, style: Style, conversationStyle: ConversationStyle) {
             self.diameter = diameter
+            self.direction = direction
             self.style = style
+            self.conversationStyle = conversationStyle
 
             super.init(frame: .zero)
 
@@ -126,16 +165,21 @@ public class AttachmentProgressView: UIView {
         }
 
         private func applyState(oldState: State, newState: State) {
+
             switch newState {
             case .none:
                 reset()
             case .tapToDownload:
                 if oldState != newState {
-                    presentIcon(templateName: "arrow-down-24", fractionalSize: 0.5)
+                    presentIcon(templateName: "arrow-down-24",
+                                sizeInsideCircle: 15,
+                                isInsideProgress: false)
                 }
             case .downloadFailed:
                 if oldState != newState {
-                    presentIcon(templateName: "retry-alt-24", fractionalSize: 0.5)
+                    presentIcon(templateName: "retry-alt-24",
+                                sizeInsideCircle: 18,
+                                isInsideProgress: false)
                 }
             case .downloadProgress(let progress):
                 switch oldState {
@@ -143,7 +187,9 @@ public class AttachmentProgressView: UIView {
                     updateProgress(progress: progress)
                 default:
                     presentProgress(progress: progress)
-                    presentIcon(templateName: "pause-filled-24", fractionalSize: 0.5, isPauseIcon: true)
+                    presentIcon(templateName: "stop-20",
+                                sizeInsideCircle: 10,
+                                isInsideProgress: true)
                 }
             case .uploadProgress(let progress):
                 switch oldState {
@@ -154,16 +200,18 @@ public class AttachmentProgressView: UIView {
                 }
             case .downloadUnknownProgress:
                 presentUnknownProgress()
-                presentIcon(templateName: "pause-filled-24", fractionalSize: 0.5, isPauseIcon: true)
+                presentIcon(templateName: "stop-20",
+                            sizeInsideCircle: 10,
+                            isInsideProgress: true)
             case .uploadUnknownProgress:
                 presentUnknownProgress()
             }
         }
 
         private func presentIcon(templateName: String,
-                                 fractionalSize: CGFloat,
-                                 isPauseIcon: Bool = false) {
-            if !isPauseIcon {
+                                 sizeInsideCircle: CGFloat,
+                                 isInsideProgress: Bool) {
+            if !isInsideProgress {
                 reset()
             }
 
@@ -172,63 +220,88 @@ public class AttachmentProgressView: UIView {
             switch style {
             case .withCircle:
                 tintColor = .ows_white
-                iconSize = diameter * fractionalSize
+                owsAssertDebug(sizeInsideCircle < diameter)
+                iconSize = sizeInsideCircle
             case .withoutCircle:
                 tintColor = Theme.primaryTextColor
-                if isPauseIcon {
-                    iconSize = diameter * fractionalSize
-                } else {
-                    iconSize = diameter
-                }
+                let fractionalSize: CGFloat = isInsideProgress ? 0.45 : 1.0
+                iconSize = diameter * fractionalSize
             }
             imageView.setTemplateImageName(templateName, tintColor: tintColor)
             addSubview(imageView)
             layoutConstraints.append(contentsOf: imageView.autoSetDimensions(to: .square(iconSize)))
+            layoutConstraints.append(contentsOf: imageView.autoCenterInSuperview())
         }
 
         private func presentProgress(progress: CGFloat) {
             reset()
 
-            progressView.progress = progress
-            switch style {
-            case .withCircle:
-                break
-            case .withoutCircle:
-                progressView.progressColor = Theme.primaryTextColor
+            let animationName = (isIncoming && !isDarkThemeEnabled
+                                    ? "determinate_spinner_blue"
+                                    : "determinate_spinner")
+            let animationView = ensureAnimationView(progressView, animationName: animationName)
+            progressView = animationView
+            animationView.backgroundBehavior = .pause
+            animationView.loopMode = .playOnce
+            animationView.contentMode = .scaleAspectFit
+            // We DO NOT play this animation; we "scrub" it to reflect
+            // attachment upload/download progress.
+            updateProgress(progress: progress)
+            addSubview(animationView)
+            layoutConstraints.append(contentsOf: animationView.autoPinEdgesToSuperviewEdges())
+        }
+
+        private func presentUnknownProgress() {
+            reset()
+
+            let animationName = (isIncoming && !isDarkThemeEnabled
+                                    ? "indeterminate_spinner_blue"
+                                    : "indeterminate_spinner")
+            let animationView = ensureAnimationView(unknownProgressView, animationName: animationName)
+            unknownProgressView = animationView
+            animationView.backgroundBehavior = .pauseAndRestore
+            animationView.loopMode = .loop
+            animationView.contentMode = .scaleAspectFit
+            animationView.play()
+
+            addSubview(animationView)
+            layoutConstraints.append(contentsOf: animationView.autoPinEdgesToSuperviewEdges())
+        }
+
+        private func ensureAnimationView(_ animationView: Lottie.AnimationView?,
+                                         animationName: String) -> AnimationView {
+            if let animationView = animationView {
+                return animationView
+            } else {
+                let animationView = AnimationView(name: animationName)
+                return animationView
             }
-            addSubview(progressView)
-            layoutConstraints.append(contentsOf: progressView.autoPinEdgesToSuperviewEdges())
         }
 
         private func updateProgress(progress: CGFloat) {
-            progressView.progress = progress
+            Logger.verbose("----- progress: \(progress)")
+
+            guard let progressView = progressView else {
+                owsFailDebug("Missing progressView.")
+                return
+            }
+            guard let animation = progressView.animation else {
+                owsFailDebug("Missing animation.")
+                return
+            }
+
+            // We DO NOT play this animation; we "scrub" it to reflect
+            // attachment upload/download progress.
+            progressView.currentFrame = progress.lerp(animation.startFrame,
+                                                      animation.endFrame)
         }
 
         private func reset() {
             removeAllSubviews()
             NSLayoutConstraint.deactivate(layoutConstraints)
             layoutConstraints.removeAll()
-            unknownProgressAnimation?.stop()
-        }
-
-        private var unknownProgressAnimation: AnimationView?
-
-        private func presentUnknownProgress() {
-            reset()
-
-            let animationView: AnimationView
-            if let unknownProgressAnimation = unknownProgressAnimation {
-                animationView = unknownProgressAnimation
-            } else {
-                animationView = AnimationView(name: "pinCreationInProgress")
-                animationView.backgroundBehavior = .pauseAndRestore
-                animationView.loopMode = .loop
-                animationView.contentMode = .scaleAspectFit
-            }
-            animationView.play()
-
-            addSubview(animationView)
-            layoutConstraints.append(contentsOf: animationView.autoPinEdgesToSuperviewEdges())
+            progressView?.stop()
+            unknownProgressView?.stop()
         }
     }
 
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/CVMediaAlbumView.swift b/Signal/src/ViewControllers/ConversationView/Cells/CVMediaAlbumView.swift
index 9514deacee2..7d5050a1c35 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/CVMediaAlbumView.swift
+++ b/Signal/src/ViewControllers/ConversationView/Cells/CVMediaAlbumView.swift
@@ -28,7 +28,8 @@ public class CVMediaAlbumView: UIStackView {
                           items: [CVMediaAlbumItem],
                           isOutgoing: Bool,
                           isBorderless: Bool,
-                          cellMeasurement: CVCellMeasurement) {
+                          cellMeasurement: CVCellMeasurement,
+                          conversationStyle: ConversationStyle) {
 
         guard let maxMessageWidth = cellMeasurement.value(key: Self.maxMessageWidthKey) else {
             owsFailDebug("Missing maxMessageWidth.")
@@ -38,10 +39,11 @@ public class CVMediaAlbumView: UIStackView {
         self.items = items
         self.itemViews = CVMediaAlbumView.itemsToDisplay(forItems: items).map {
             CVMediaView(mediaCache: mediaCache,
-                                  attachment: $0.attachment,
-                                  isOutgoing: isOutgoing,
-                                  maxMessageWidth: maxMessageWidth,
-                                  isBorderless: isBorderless)
+                        attachment: $0.attachment,
+                        isOutgoing: isOutgoing,
+                        maxMessageWidth: maxMessageWidth,
+                        isBorderless: isBorderless,
+                        conversationStyle: conversationStyle)
         }
         self.isBorderless = isBorderless
 
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/ConversationMediaView.swift b/Signal/src/ViewControllers/ConversationView/Cells/ConversationMediaView.swift
index e4fe53b66aa..21c217d4808 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/ConversationMediaView.swift
+++ b/Signal/src/ViewControllers/ConversationView/Cells/ConversationMediaView.swift
@@ -9,13 +9,13 @@ public class CVMediaView: UIView {
     private enum MediaError {
         case missing
         case invalid
-        case failed
     }
 
     // MARK: -
 
     private let mediaCache: NSCache<NSString, AnyObject>
     public let attachment: TSAttachment
+    private let conversationStyle: ConversationStyle
     private let isOutgoing: Bool
     private let maxMessageWidth: CGFloat
     private let isBorderless: Bool
@@ -83,12 +83,14 @@ public class CVMediaView: UIView {
                          attachment: TSAttachment,
                          isOutgoing: Bool,
                          maxMessageWidth: CGFloat,
-                         isBorderless: Bool) {
+                         isBorderless: Bool,
+                         conversationStyle: ConversationStyle) {
         self.mediaCache = mediaCache
         self.attachment = attachment
         self.isOutgoing = isOutgoing
         self.maxMessageWidth = maxMessageWidth
         self.isBorderless = isBorderless
+        self.conversationStyle = conversationStyle
 
         super.init(frame: .zero)
 
@@ -117,10 +119,6 @@ public class CVMediaView: UIView {
         guard let attachmentStream = attachment as? TSAttachmentStream else {
             return configureForUndownloadedImage()
         }
-        guard !isFailedDownload else {
-            configure(forError: .failed)
-            return
-        }
         if attachmentStream.shouldBeRenderedByYY {
             configureForAnimatedImage(attachmentStream: attachmentStream)
         } else if attachmentStream.isImage {
@@ -136,22 +134,6 @@ public class CVMediaView: UIView {
     private func configureForUndownloadedImage() {
         tryToConfigureForBlurHash(attachment: attachment)
 
-        guard !isFailedDownload else {
-            return configure(forError: .failed)
-        }
-
-        guard !isPendingDownload else {
-            return
-        }
-
-        addDownloadProgressIfNecessary()
-    }
-
-    private func addDownloadProgressIfNecessary() {
-        guard !isFailedDownload else {
-            configure(forError: .failed)
-            return
-        }
         guard let attachmentPointer = attachment as? TSAttachmentPointer else {
             owsFailDebug("Attachment has unexpected type.")
             configure(forError: .invalid)
@@ -164,8 +146,9 @@ public class CVMediaView: UIView {
         }
 
         backgroundColor = (Theme.isDarkThemeEnabled ? .ows_gray90 : .ows_gray05)
-        let progressView = AttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
-                                                     style: .withCircle)
+        let progressView = CVAttachmentProgressView(direction: .download(attachmentPointer: attachmentPointer),
+                                                    style: .withCircle,
+                                                    conversationStyle: conversationStyle)
         self.addSubview(progressView)
         progressView.autoCenterInSuperview()
     }
@@ -180,8 +163,9 @@ public class CVMediaView: UIView {
         guard !attachmentStream.isUploaded else {
             return false
         }
-        let progressView = AttachmentProgressView(direction: .upload(attachmentStream: attachmentStream),
-                                                     style: .withCircle)
+        let progressView = CVAttachmentProgressView(direction: .upload(attachmentStream: attachmentStream),
+                                                    style: .withCircle,
+                                                    conversationStyle: conversationStyle)
         self.addSubview(progressView)
         progressView.autoCenterInSuperview()
         return true
@@ -432,22 +416,6 @@ public class CVMediaView: UIView {
         return playVideoButton
     }
 
-    private var isPendingDownload: Bool {
-        guard let attachmentPointer = attachment as? TSAttachmentPointer else {
-            return false
-        }
-        return (attachmentPointer.state == .pendingMessageRequest ||
-            attachmentPointer.state == .pendingManualDownload)
-
-    }
-
-    private var isFailedDownload: Bool {
-        guard let attachmentPointer = attachment as? TSAttachmentPointer else {
-            return false
-        }
-        return attachmentPointer.state == .failed
-    }
-
     private var hasBlurHash: Bool {
         return BlurHash.isValidBlurHash(attachment.blurHash)
     }
@@ -456,12 +424,6 @@ public class CVMediaView: UIView {
         backgroundColor = (Theme.isDarkThemeEnabled ? .ows_gray90 : .ows_gray05)
         let icon: UIImage
         switch error {
-        case .failed:
-            guard let asset = UIImage(named: "media_retry") else {
-                owsFailDebug("Missing image")
-                return
-            }
-            icon = asset
         case .invalid:
             guard let asset = UIImage(named: "media_invalid") else {
                 owsFailDebug("Missing image")
diff --git a/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.swift b/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.swift
index 65934ddd8ca..41a8bb23f25 100644
--- a/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.swift
+++ b/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.swift
@@ -437,7 +437,7 @@ public extension OWSAttachmentDownloads {
         return result
     }
 
-    static func autoDownloadableMediaTypes(transaction: SDSAnyReadTransaction) -> Set<MediaDownloadType> {
+    private static func autoDownloadableMediaTypes(transaction: SDSAnyReadTransaction) -> Set<MediaDownloadType> {
         let preferenceMap = loadMediaBandwidthPreferences(transaction: transaction)
         let hasWifiConnection = reachabilityManager.isReachable(via: .wifi)
         var result = Set<MediaDownloadType>()
diff --git a/SignalServiceKit/src/Network/OWSURLSession.swift b/SignalServiceKit/src/Network/OWSURLSession.swift
index 31eea2e9463..854e1b0604e 100644
--- a/SignalServiceKit/src/Network/OWSURLSession.swift
+++ b/SignalServiceKit/src/Network/OWSURLSession.swift
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2021 Open Whisper Systems. All rights reserved.
 //
 
 import Foundation
@@ -238,109 +238,86 @@ public class OWSURLSession: NSObject {
                       shouldHandleRemoteDeprecation: shouldHandleRemoteDeprecation)
     }
 
-    private class func handleGenericTaskCompletion(resolver: Resolver<OWSHTTPResponse>,
-                                                   requestConfig: RequestConfig,
-                                                   responseData: Data?) {
-        handleTaskCompletion(requestConfig: requestConfig,
-                             responseData: responseData,
-                             success: { (httpUrlResponse: HTTPURLResponse) in
-                                resolver.fulfill(OWSHTTPResponse(task: requestConfig.task,
-                                                                 httpUrlResponse: httpUrlResponse,
-                                                                 responseData: responseData))
-        },
-                             failure: { (error: Error) in
-                                resolver.reject(error)
-        })
-    }
-
-    private class func handleUrlDownloadTaskCompletion(resolver: Resolver<OWSUrlDownloadResponse>,
-                                                       requestConfig: RequestConfig,
-                                                       downloadUrl: URL?) {
-        handleTaskCompletion(requestConfig: requestConfig,
-                             responseData: nil,
-                             success: { (httpUrlResponse: HTTPURLResponse) in
-                                guard let downloadUrl = downloadUrl else {
-                                    resolver.reject(OWSAssertionError("Missing downloadUrl."))
-                                    return
-                                }
-                                let temporaryUrl = OWSFileSystem.temporaryFileUrl(fileExtension: nil,
-                                                                                  isAvailableWhileDeviceLocked: true)
-                                do {
-                                    try OWSFileSystem.moveFile(from: downloadUrl, to: temporaryUrl)
-                                } catch {
-                                    resolver.reject(error)
-                                    return
-                                }
-                                resolver.fulfill(OWSUrlDownloadResponse(task: requestConfig.task,
-                                                                        httpUrlResponse: httpUrlResponse,
-                                                                        downloadUrl: temporaryUrl))
-        },
-                             failure: { (error: Error) in
-                                resolver.reject(error)
-        })
-    }
-
-    private class func handleTaskCompletion(requestConfig: RequestConfig,
-                                            responseData: Data?,
-                                            success: (HTTPURLResponse) -> Void,
-                                            failure: (Error) -> Void) {
-
-        let task = requestConfig.task
-
-        if requestConfig.shouldHandleRemoteDeprecation {
-            checkForRemoteDeprecation(task: task, response: task.response)
-        }
-
-        if let error = task.error {
-            if IsNetworkConnectivityFailure(error) {
-                Logger.warn("Request failed: \(error)")
-            } else {
-                #if TESTABLE_BUILD
-                TSNetworkManager.logCurl(for: task)
+    private class func uploadOrDataTaskCompletionPromise(requestConfig: RequestConfig,
+                                                         responseData: Data?) -> Promise<OWSHTTPResponse> {
+        firstly {
+            baseCompletionPromise(requestConfig: requestConfig, responseData: responseData)
+        }.map(on: .global()) { (httpUrlResponse: HTTPURLResponse) -> OWSHTTPResponse in
+            OWSHTTPResponse(task: requestConfig.task,
+                            httpUrlResponse: httpUrlResponse,
+                            responseData: responseData)
+        }
+    }
 
-                if let responseData = responseData,
-                    let httpUrlResponse = task.response as? HTTPURLResponse,
-                    let contentType = httpUrlResponse.allHeaderFields["Content-Type"] as? String,
-                    contentType == OWSMimeTypeJson,
-                    let jsonString = String(data: responseData, encoding: .utf8) {
-                    Logger.verbose("Response JSON: \(jsonString)")
-                }
-                #endif
+    private class func downloadTaskCompletionPromise(requestConfig: RequestConfig,
+                                                     downloadUrl: URL) -> Promise<OWSUrlDownloadResponse> {
+        firstly {
+            baseCompletionPromise(requestConfig: requestConfig, responseData: nil)
+        }.map(on: .global()) { (httpUrlResponse: HTTPURLResponse) -> OWSUrlDownloadResponse in
+            return OWSUrlDownloadResponse(task: requestConfig.task,
+                                          httpUrlResponse: httpUrlResponse,
+                                          downloadUrl: downloadUrl)
+        }
+    }
 
-                if requestConfig.failOnError {
-                    owsFailDebug("Request failed: \(error)")
+    private class func baseCompletionPromise(requestConfig: RequestConfig,
+                                             responseData: Data?) -> Promise<HTTPURLResponse> {
+
+        firstly(on: .global()) { () -> HTTPURLResponse in
+            let task = requestConfig.task
+
+            if requestConfig.shouldHandleRemoteDeprecation {
+                checkForRemoteDeprecation(task: task, response: task.response)
+            }
+
+            if let error = task.error {
+                if IsNetworkConnectivityFailure(error) {
+                    Logger.warn("Request failed: \(error)")
                 } else {
-                    Logger.error("Request failed: \(error)")
+                    #if TESTABLE_BUILD
+                    TSNetworkManager.logCurl(for: task)
+
+                    if let responseData = responseData,
+                       let httpUrlResponse = task.response as? HTTPURLResponse,
+                       let contentType = httpUrlResponse.allHeaderFields["Content-Type"] as? String,
+                       contentType == OWSMimeTypeJson,
+                       let jsonString = String(data: responseData, encoding: .utf8) {
+                        Logger.verbose("Response JSON: \(jsonString)")
+                    }
+                    #endif
+
+                    if requestConfig.failOnError {
+                        owsFailDebug("Request failed: \(error)")
+                    } else {
+                        Logger.error("Request failed: \(error)")
+                    }
                 }
+                throw error
+            }
+            guard let httpUrlResponse = task.response as? HTTPURLResponse else {
+                throw OWSAssertionError("Invalid response: \(type(of: task.response)).")
             }
-            failure(error)
-            return
-        }
-        guard let httpUrlResponse = task.response as? HTTPURLResponse else {
-            failure(OWSAssertionError("Invalid response: \(type(of: task.response))."))
-            return
-        }
 
-        if requestConfig.require2xxOr3xx {
-            let statusCode = httpUrlResponse.statusCode
-            guard statusCode >= 200, statusCode < 400 else {
-                #if TESTABLE_BUILD
-                TSNetworkManager.logCurl(for: task)
-                Logger.verbose("Status code: \(statusCode)")
-                #endif
+            if requestConfig.require2xxOr3xx {
+                let statusCode = httpUrlResponse.statusCode
+                guard statusCode >= 200, statusCode < 400 else {
+                    #if TESTABLE_BUILD
+                    TSNetworkManager.logCurl(for: task)
+                    Logger.verbose("Status code: \(statusCode)")
+                    #endif
 
-                failure(OWSHTTPError.requestError(statusCode: statusCode, httpUrlResponse: httpUrlResponse))
-                return
+                    throw OWSHTTPError.requestError(statusCode: statusCode, httpUrlResponse: httpUrlResponse)
+                }
             }
-        }
 
-        #if TESTABLE_BUILD
-        if DebugFlags.logCurlOnSuccess {
-            TSNetworkManager.logCurl(for: task)
-        }
-        #endif
+            #if TESTABLE_BUILD
+            if DebugFlags.logCurlOnSuccess {
+                TSNetworkManager.logCurl(for: task)
+            }
+            #endif
 
-        success(httpUrlResponse)
+            return httpUrlResponse
+        }
     }
 
     private class func checkForRemoteDeprecation(task: URLSessionTask,
@@ -469,54 +446,62 @@ public class OWSURLSession: NSObject {
         return finalUrl
     }
 
-    // MARK: - Progress Blocks
+    // MARK: - TaskState
 
-    typealias TaskIdentifier = Int
+    private let lock = UnfairLock()
 
+    typealias TaskIdentifier = Int
     public typealias ProgressBlock = (URLSessionTask, Progress) -> Void
-    typealias ProgressBlockMap = [TaskIdentifier: ProgressBlock]
 
-    private let lock = UnfairLock()
-    private var progressBlockMap = ProgressBlockMap()
+    private typealias TaskStateMap = [TaskIdentifier: TaskState]
+    private var taskStateMap = TaskStateMap()
 
-    private func progressBlock(forTask task: URLSessionTask) -> ProgressBlock? {
+    private func addTask(_ task: URLSessionTask, taskState: TaskState) {
         lock.withLock {
-            self.progressBlockMap[task.taskIdentifier]
+            owsAssertDebug(self.taskStateMap[task.taskIdentifier] == nil)
+            self.taskStateMap[task.taskIdentifier] = taskState
         }
     }
 
-    private func setProgressBlock(forTask task: URLSessionTask, _ progressBlock: ProgressBlock?) {
+    private func progressBlock(forTask task: URLSessionTask) -> ProgressBlock? {
         lock.withLock {
-            if let progressBlock = progressBlock {
-                self.progressBlockMap[task.taskIdentifier] = progressBlock
-            } else {
-                self.progressBlockMap.removeValue(forKey: task.taskIdentifier)
-            }
+            self.taskStateMap[task.taskIdentifier]?.progressBlock
         }
     }
 
-    // MARK: - Download Completion Blocks
-
-    public typealias DownloadCompletionBlock = (URLSessionTask, URL) -> Void
-    typealias DownloadCompletionBlockMap = [TaskIdentifier: DownloadCompletionBlock]
+    private func removeCompletedTaskState(_ task: URLSessionTask) -> TaskState? {
+        lock.withLock { () -> TaskState? in
+            guard let taskState = self.taskStateMap[task.taskIdentifier] else {
+                owsFailDebug("Missing TaskState.")
+                return nil
+            }
+            self.taskStateMap[task.taskIdentifier] = nil
+            return taskState
+        }
+    }
 
-    private var downloadCompletionBlockMap = DownloadCompletionBlockMap()
+    private func downloadTaskDidSucceed(_ task: URLSessionTask, downloadUrl: URL) {
+        guard let taskState = removeCompletedTaskState(task) as? DownloadTaskState else {
+            owsFailDebug("Missing TaskState.")
+            return
+        }
+        taskState.resolver.fulfill((task, downloadUrl))
+    }
 
-    private func downloadCompletionBlock(forTask task: URLSessionTask) -> DownloadCompletionBlock? {
-        lock.withLock {
-            self.downloadCompletionBlockMap[task.taskIdentifier]
+    private func uploadOrDataTaskDidSucceed(_ task: URLSessionTask, responseData: Data?) {
+        guard let taskState = removeCompletedTaskState(task) as? UploadTaskState else {
+            owsFailDebug("Missing TaskState.")
+            return
         }
+        taskState.resolver.fulfill((task, responseData))
     }
 
-    private func setDownloadCompletionBlock(forTask task: URLSessionTask,
-                                            _ downloadCompletionBlock: DownloadCompletionBlock?) {
-        lock.withLock {
-            if let downloadCompletionBlock = downloadCompletionBlock {
-                self.downloadCompletionBlockMap[task.taskIdentifier] = downloadCompletionBlock
-            } else {
-                self.downloadCompletionBlockMap.removeValue(forKey: task.taskIdentifier)
-            }
+    private func taskDidFail(_ task: URLSessionTask, error: Error) {
+        guard let taskState = removeCompletedTaskState(task) else {
+            owsFailDebug("Missing TaskState.")
+            return
         }
+        taskState.reject(error: error)
     }
 
     // MARK: -
@@ -549,6 +534,22 @@ public class OWSURLSession: NSObject {
 
 extension OWSURLSession: URLSessionDelegate {
 
+    public func urlSession(_ session: URLSession, didBecomeInvalidWithError error: Error?) {
+        Logger.info("Error: \(String(describing: error))")
+        Logger.flush()
+        Logger.flush()
+    }
+
+    public func urlSession(_ session: URLSession, task: URLSessionTask, didCompleteWithError error: Error?) {
+//        Logger.info("Error: \(String(describing: error))")
+//        Logger.flush()
+//        Logger.flush()
+        if let error = error {
+            Logger.info("Error: \(error)")
+            taskDidFail(task, error: error)
+        }
+    }
+
     public func urlSession(_ session: URLSession,
                            didReceive challenge: URLAuthenticationChallenge,
                            completionHandler: @escaping URLAuthenticationChallengeCompletion) {
@@ -599,10 +600,18 @@ extension OWSURLSession: URLSessionTaskDelegate {
 extension OWSURLSession: URLSessionDownloadDelegate {
 
     public func urlSession(_ session: URLSession, downloadTask: URLSessionDownloadTask, didFinishDownloadingTo location: URL) {
-        guard let downloadCompletionBlock = self.downloadCompletionBlock(forTask: downloadTask) else {
-            return
+        do {
+            // Download locations are cleaned up quickly, so we
+            // need to move the file synchronously.
+            let temporaryUrl = OWSFileSystem.temporaryFileUrl(fileExtension: nil,
+                                                              isAvailableWhileDeviceLocked: true)
+            try OWSFileSystem.moveFile(from: location, to: temporaryUrl)
+            downloadTaskDidSucceed(downloadTask, downloadUrl: temporaryUrl)
+        } catch {
+            owsFailDebugUnlessNetworkFailure(error)
+
+            taskDidFail(downloadTask, error: error)
         }
-        downloadCompletionBlock(downloadTask, location)
     }
 
     public func urlSession(_ session: URLSession, downloadTask: URLSessionDownloadTask, didWriteData bytesWritten: Int64, totalBytesWritten: Int64, totalBytesExpectedToWrite: Int64) {
@@ -651,22 +660,27 @@ public extension OWSURLSession {
             return Promise(error: OWSAssertionError("App is expired."))
         }
 
-        let (promise, resolver) = Promise<OWSHTTPResponse>.pending()
+        let taskState = UploadTaskState(progressBlock: progressBlock)
         var requestConfig: RequestConfig?
-        let task = session.uploadTask(with: request, from: requestData) { (responseData: Data?, _: URLResponse?, _: Error?) in
+        let task = session.uploadTask(with: request, from: requestData) { [weak self] (responseData: Data?, _: URLResponse?, _: Error?) in
             guard let requestConfig = requestConfig else {
                 owsFailDebug("Missing requestConfig.")
                 return
             }
-            self.setProgressBlock(forTask: requestConfig.task, nil)
-            Self.handleGenericTaskCompletion(resolver: resolver,
-                                             requestConfig: requestConfig,
-                                             responseData: responseData)
+            self?.uploadOrDataTaskDidSucceed(requestConfig.task, responseData: responseData)
         }
+        addTask(task, taskState: taskState)
         requestConfig = self.requestConfig(forTask: task)
-        setProgressBlock(forTask: task, progressBlock)
         task.resume()
-        return promise
+
+        return firstly { () -> Promise<(URLSessionTask, Data?)> in
+            taskState.promise
+        }.then(on: .global()) { (_, responseData: Data?) -> Promise<OWSHTTPResponse> in
+            guard let requestConfig = requestConfig else {
+                throw OWSAssertionError("Missing requestConfig.")
+            }
+            return Self.uploadOrDataTaskCompletionPromise(requestConfig: requestConfig, responseData: responseData)
+        }
     }
 
     func uploadTaskPromise(_ urlString: String,
@@ -688,22 +702,27 @@ public extension OWSURLSession {
             return Promise(error: OWSAssertionError("App is expired."))
         }
 
-        let (promise, resolver) = Promise<OWSHTTPResponse>.pending()
+        let taskState = UploadTaskState(progressBlock: progressBlock)
         var requestConfig: RequestConfig?
-        let task = session.uploadTask(with: request, fromFile: dataUrl) { (responseData: Data?, _: URLResponse?, _: Error?) in
+        let task = session.uploadTask(with: request, fromFile: dataUrl) { [weak self] (responseData: Data?, _: URLResponse?, _: Error?) in
             guard let requestConfig = requestConfig else {
                 owsFailDebug("Missing requestConfig.")
                 return
             }
-            self.setProgressBlock(forTask: requestConfig.task, nil)
-            Self.handleGenericTaskCompletion(resolver: resolver,
-                                             requestConfig: requestConfig,
-                                             responseData: responseData)
+            self?.uploadOrDataTaskDidSucceed(requestConfig.task, responseData: responseData)
         }
+        addTask(task, taskState: taskState)
         requestConfig = self.requestConfig(forTask: task)
-        setProgressBlock(forTask: task, progressBlock)
         task.resume()
-        return promise
+
+        return firstly { () -> Promise<(URLSessionTask, Data?)> in
+            taskState.promise
+        }.then(on: .global()) { (_, responseData: Data?) -> Promise<OWSHTTPResponse> in
+            guard let requestConfig = requestConfig else {
+                throw OWSAssertionError("Missing requestConfig.")
+            }
+            return Self.uploadOrDataTaskCompletionPromise(requestConfig: requestConfig, responseData: responseData)
+        }
     }
 
     // MARK: - Data Tasks
@@ -724,21 +743,27 @@ public extension OWSURLSession {
             return Promise(error: OWSAssertionError("App is expired."))
         }
 
-        let (promise, resolver) = Promise<OWSHTTPResponse>.pending()
+        let taskState = UploadTaskState(progressBlock: nil)
         var requestConfig: RequestConfig?
-        let task = session.dataTask(with: request) { (responseData: Data?, _: URLResponse?, _: Error?) in
+        let task = session.dataTask(with: request) { [weak self] (responseData: Data?, _: URLResponse?, _: Error?) in
             guard let requestConfig = requestConfig else {
                 owsFailDebug("Missing requestConfig.")
                 return
             }
-            self.setProgressBlock(forTask: requestConfig.task, nil)
-            Self.handleGenericTaskCompletion(resolver: resolver,
-                                             requestConfig: requestConfig,
-                                             responseData: responseData)
+            self?.uploadOrDataTaskDidSucceed(requestConfig.task, responseData: responseData)
         }
+        addTask(task, taskState: taskState)
         requestConfig = self.requestConfig(forTask: task)
         task.resume()
-        return promise
+
+        return firstly { () -> Promise<(URLSessionTask, Data?)> in
+            taskState.promise
+        }.then(on: .global()) { (_, responseData: Data?) -> Promise<OWSHTTPResponse> in
+            guard let requestConfig = requestConfig else {
+                throw OWSAssertionError("Missing requestConfig.")
+            }
+            return Self.uploadOrDataTaskCompletionPromise(requestConfig: requestConfig, responseData: responseData)
+        }
     }
 
     // MARK: - Download Tasks
@@ -757,58 +782,42 @@ public extension OWSURLSession {
 
     func urlDownloadTaskPromise(request: URLRequest,
                                 progress progressBlock: ProgressBlock? = nil) -> Promise<OWSUrlDownloadResponse> {
-
-        guard !Self.appExpiry.isExpired else {
-            return Promise(error: OWSAssertionError("App is expired."))
+        urlDownloadTaskPromise(progress: progressBlock) {
+            // Don't use a completion block or the delegate will be ignored for download tasks.
+            session.downloadTask(with: request)
         }
-
-        let (promise, resolver) = Promise<OWSUrlDownloadResponse>.pending()
-        var requestConfig: RequestConfig?
-        // Don't use the a completion block or the delegate will be ignored for download tasks.
-        let task = session.downloadTask(with: request)
-        requestConfig = self.requestConfig(forTask: task)
-        setProgressBlock(forTask: task, progressBlock)
-        setDownloadCompletionBlock(forTask: task) { (task: URLSessionTask, downloadUrl: URL) in
-            guard let requestConfig = requestConfig else {
-                owsFailDebug("Missing requestConfig.")
-                return
-            }
-            self.setProgressBlock(forTask: task, nil)
-            self.setDownloadCompletionBlock(forTask: task, nil)
-            Self.handleUrlDownloadTaskCompletion(resolver: resolver,
-                                                 requestConfig: requestConfig,
-                                                 downloadUrl: downloadUrl)
-        }
-        task.resume()
-        return promise
     }
 
     func urlDownloadTaskPromise(resumeData: Data,
                                 progress progressBlock: ProgressBlock? = nil) -> Promise<OWSUrlDownloadResponse> {
+        urlDownloadTaskPromise(progress: progressBlock) {
+            // Don't use a completion block or the delegate will be ignored for download tasks.
+            session.downloadTask(withResumeData: resumeData)
+        }
+    }
+
+    private func urlDownloadTaskPromise(progress progressBlock: ProgressBlock? = nil,
+                                        taskBlock: () -> URLSessionDownloadTask) -> Promise<OWSUrlDownloadResponse> {
 
         guard !Self.appExpiry.isExpired else {
             return Promise(error: OWSAssertionError("App is expired."))
         }
 
-        let (promise, resolver) = Promise<OWSUrlDownloadResponse>.pending()
+        let taskState = DownloadTaskState(progressBlock: progressBlock)
         var requestConfig: RequestConfig?
-        // Don't use the a completion block or the delegate will be ignored for download tasks.
-        let task = session.downloadTask(withResumeData: resumeData)
+        let task = taskBlock()
+        addTask(task, taskState: taskState)
         requestConfig = self.requestConfig(forTask: task)
-        setProgressBlock(forTask: task, progressBlock)
-        setDownloadCompletionBlock(forTask: task) { (task: URLSessionTask, downloadUrl: URL) in
+        task.resume()
+
+        return firstly { () -> Promise<(URLSessionTask, URL)> in
+            taskState.promise
+        }.then(on: .global()) { (_: URLSessionTask, downloadUrl: URL) -> Promise<OWSUrlDownloadResponse> in
             guard let requestConfig = requestConfig else {
-                owsFailDebug("Missing requestConfig.")
-                return
+                throw OWSAssertionError("Missing requestConfig.")
             }
-            self.setProgressBlock(forTask: task, nil)
-            self.setDownloadCompletionBlock(forTask: task, nil)
-            Self.handleUrlDownloadTaskCompletion(resolver: resolver,
-                                                 requestConfig: requestConfig,
-                                                 downloadUrl: downloadUrl)
+            return Self.downloadTaskCompletionPromise(requestConfig: requestConfig, downloadUrl: downloadUrl)
         }
-        task.resume()
-        return promise
     }
 }
 
@@ -881,3 +890,53 @@ public extension URLRequest {
         }
     }
 }
+
+// MARK: - TaskState
+
+private protocol TaskState {
+    typealias ProgressBlock = (URLSessionTask, Progress) -> Void
+
+    var progressBlock: ProgressBlock? { get }
+
+    func reject(error: Error)
+}
+
+// MARK: - TaskState
+
+private class DownloadTaskState: TaskState {
+    let progressBlock: ProgressBlock?
+    let promise: Promise<(URLSessionTask, URL)>
+    let resolver: Resolver<(URLSessionTask, URL)>
+
+    init(progressBlock: ProgressBlock?) {
+        self.progressBlock = progressBlock
+
+        let (promise, resolver) = Promise<(URLSessionTask, URL)>.pending()
+        self.promise = promise
+        self.resolver = resolver
+    }
+
+    func reject(error: Error) {
+        resolver.reject(error)
+    }
+}
+
+// MARK: - TaskState
+
+private class UploadTaskState: TaskState {
+    let progressBlock: ProgressBlock?
+    let promise: Promise<(URLSessionTask, Data?)>
+    let resolver: Resolver<(URLSessionTask, Data?)>
+
+    init(progressBlock: ProgressBlock?) {
+        self.progressBlock = progressBlock
+
+        let (promise, resolver) = Promise<(URLSessionTask, Data?)>.pending()
+        self.promise = promise
+        self.resolver = resolver
+    }
+
+    func reject(error: Error) {
+        resolver.reject(error)
+    }
+}
