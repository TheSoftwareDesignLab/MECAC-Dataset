diff --git a/Pods b/Pods
index 48f56ff1ff1..675160d79af 160000
--- a/Pods
+++ b/Pods
@@ -1 +1 @@
-Subproject commit 48f56ff1ff168be8871e680371712991057ec1ce
+Subproject commit 675160d79afb2cfcac902ac2ec35c07faf2b9f90
diff --git a/Signal/Signal-Prefix.pch b/Signal/Signal-Prefix.pch
index b832a848685..50e5d3f03b9 100644
--- a/Signal/Signal-Prefix.pch
+++ b/Signal/Signal-Prefix.pch
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import <Availability.h>
@@ -19,4 +19,5 @@
     #import <SignalCoreKit/OWSAsserts.h>
     #import <SignalServiceKit/SSKAsserts.h>
     #import <SignalServiceKit/OWSAnalytics.h>
+    #import <SignalServiceKit/SDSDatabaseStorage+Objc.h>
 #endif
diff --git a/Signal/src/AppDelegate.m b/Signal/src/AppDelegate.m
index d89fb5a771a..b8675c73e13 100644
--- a/Signal/src/AppDelegate.m
+++ b/Signal/src/AppDelegate.m
@@ -1268,9 +1268,9 @@ - (void)registrationStateDidChange
     if ([self.tsAccountManager isRegistered]) {
         OWSLogInfo(@"localAddress: %@", [self.tsAccountManager localAddress]);
 
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [ExperienceUpgradeFinder markAllCompleteForNewUserWithTransaction:transaction.unwrapGrdbWrite];
-        }];
+        });
 
         // Start running the disappearing messages job in case the newly registered user
         // enables this feature
diff --git a/Signal/src/ViewControllers/AppSettings/NotificationSettingsViewController.m b/Signal/src/ViewControllers/AppSettings/NotificationSettingsViewController.m
index dbddf48ce51..a6e0f6d7571 100644
--- a/Signal/src/ViewControllers/AppSettings/NotificationSettingsViewController.m
+++ b/Signal/src/ViewControllers/AppSettings/NotificationSettingsViewController.m
@@ -140,9 +140,9 @@ - (void)didToggleSoundNotificationsSwitch:(UISwitch *)sender
 
 - (void)didToggleshouldNotifyOfNewAccountsSwitch:(UISwitch *)sender
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.preferences setShouldNotifyOfNewAccounts:sender.isOn transaction:transaction];
-    }];
+    });
 }
 
 @end
diff --git a/Signal/src/ViewControllers/AppSettings/OWSLinkedDevicesTableViewController.m b/Signal/src/ViewControllers/AppSettings/OWSLinkedDevicesTableViewController.m
index d53fa67c872..69777d1f162 100644
--- a/Signal/src/ViewControllers/AppSettings/OWSLinkedDevicesTableViewController.m
+++ b/Signal/src/ViewControllers/AppSettings/OWSLinkedDevicesTableViewController.m
@@ -354,9 +354,10 @@ - (void)tableView:(UITableView *)tableView
             touchedUnlinkControlForDevice:device
                                   success:^{
                                       OWSLogInfo(@"Removing unlinked device with deviceId: %ld", (long)device.deviceId);
-                                      [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
-                                          [device anyRemoveWithTransaction:transaction];
-                                      }];
+                                      DatabaseStorageWrite(
+                                          self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
+                                              [device anyRemoveWithTransaction:transaction];
+                                          });
                                       [self updateDeviceList];
                                   }];
     }
diff --git a/Signal/src/ViewControllers/AppSettings/PrivacySettingsTableViewController.m b/Signal/src/ViewControllers/AppSettings/PrivacySettingsTableViewController.m
index fd3bad44e47..cac59bb00c4 100644
--- a/Signal/src/ViewControllers/AppSettings/PrivacySettingsTableViewController.m
+++ b/Signal/src/ViewControllers/AppSettings/PrivacySettingsTableViewController.m
@@ -574,9 +574,9 @@ - (void)didToggleUDShowIndicatorsSwitch:(UISwitch *)sender
 - (void)didToggleLinkPreviewsEnabled:(UISwitch *)sender
 {
     OWSLogInfo(@"toggled to: %@", (sender.isOn ? @"ON" : @"OFF"));
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [SSKPreferences setAreLinkPreviewsEnabledAndSendSyncMessage:sender.isOn transaction:transaction];
-    }];
+    });
 }
 
 - (void)show2FASettings
@@ -690,9 +690,9 @@ - (void)isRegistrationLockV2EnabledDidChange:(UISwitch *)sender
 - (void)arePINRemindersEnabledDidChange:(UISwitch *)sender
 {
     if (sender.isOn) {
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [OWS2FAManager.sharedManager setAreRemindersEnabled:YES transaction:transaction];
-        }];
+        });
     } else {
         OWSPinConfirmationViewController *pinConfirmationVC = [[OWSPinConfirmationViewController alloc]
                 initWithTitle:NSLocalizedString(@"SETTINGS_PIN_REMINDER_DISABLE_CONFIRMATION_TITLE",
@@ -705,9 +705,9 @@ - (void)arePINRemindersEnabledDidChange:(UISwitch *)sender
                            @"The button text for the dialog asking user to confirm their PIN to disable reminders".)
             completionHandler:^(BOOL confirmed) {
                 if (confirmed) {
-                    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                         [OWS2FAManager.sharedManager setAreRemindersEnabled:NO transaction:transaction];
-                    }];
+                    });
 
                     [ExperienceUpgradeManager dismissPINReminderIfNecessary];
                 } else {
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m
index 146341b6df1..039bcac53bb 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m
+++ b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m
@@ -543,9 +543,9 @@ - (void)showStickerTooltipIfNecessary
     }
 
     dispatch_block_t markTooltipAsShown = ^{
-        [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [StickerManager.shared stickerTooltipWasShownWithTransaction:transaction];
-        }];
+        });
     };
 
     __block StickerPack *_Nullable stickerPack;
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationViewController.m b/Signal/src/ViewControllers/ConversationView/ConversationViewController.m
index 47ca5275a4c..a1790d0555b 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationViewController.m
+++ b/Signal/src/ViewControllers/ConversationView/ConversationViewController.m
@@ -1872,9 +1872,9 @@ - (void)handleUnsentMessageTap:(TSOutgoingMessage *)message
         initWithTitle:CommonStrings.deleteButton
                 style:ActionSheetActionStyleDestructive
               handler:^(ActionSheetAction *action) {
-                  [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                  DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                       [message anyRemoveWithTransaction:transaction];
-                  }];
+                  });
               }];
     [actionSheet addAction:deleteMessageAction];
 
@@ -1883,9 +1883,9 @@ - (void)handleUnsentMessageTap:(TSOutgoingMessage *)message
         accessibilityIdentifier:ACCESSIBILITY_IDENTIFIER_WITH_NAME(self, @"send_again")
                           style:ActionSheetActionStyleDefault
                         handler:^(ActionSheetAction *action) {
-                            [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                            DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                 [self.messageSenderJobQueue addMessage:message.asPreparer transaction:transaction];
-                            }];
+                            });
                         }];
 
     [actionSheet addAction:resendMessageAction];
@@ -1937,9 +1937,9 @@ - (void)tappedCorruptedMessage:(TSErrorMessage *)message
                                 return;
                             }
                             TSContactThread *contactThread = (TSContactThread *)self.thread;
-                            [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                            DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                 [self.sessionResetJobQueue addContactThread:contactThread transaction:transaction];
-                            }];
+                            });
                         }];
     [alert addAction:resetSessionAction];
 
@@ -2468,7 +2468,7 @@ - (void)tappedUnknownContactBlockOfferMessage:(OWSContactOffersInteraction *)int
                             OWSLogInfo(@"Blocking an unknown user.");
                             [self.blockingManager addBlockedAddress:contactThread.contactAddress
                                                 wasLocallyInitiated:YES];
-                            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                 [contactThread anyUpdateContactThreadWithTransaction:transaction
                                                                                block:^(TSContactThread *thread) {
                                                                                    // The contactoffers interaction is
@@ -2478,7 +2478,7 @@ - (void)tappedUnknownContactBlockOfferMessage:(OWSContactOffersInteraction *)int
                                                                                    // response to this change.
                                                                                    thread.hasDismissedOffers = YES;
                                                                                }];
-                            }];
+                            });
                         }];
     [actionSheet addAction:blockAction];
 
@@ -2509,7 +2509,7 @@ - (void)tappedAddToContactsOfferMessage:(OWSContactOffersInteraction *)interacti
 
     [self.navigationController pushViewController:contactVC animated:YES];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [contactThread anyUpdateContactThreadWithTransaction:transaction
                                                        block:^(TSContactThread *thread) {
                                                            // The contactoffers interaction is an unsaved interaction.
@@ -2517,7 +2517,7 @@ - (void)tappedAddToContactsOfferMessage:(OWSContactOffersInteraction *)interacti
                                                            // interaction in response to this change.
                                                            thread.hasDismissedOffers = YES;
                                                        }];
-    }];
+    });
 }
 
 - (void)tappedAddToProfileWhitelistOfferMessage:(OWSContactOffersInteraction *)interaction
@@ -2530,7 +2530,7 @@ - (void)tappedAddToProfileWhitelistOfferMessage:(OWSContactOffersInteraction *)i
     TSContactThread *contactThread = (TSContactThread *)self.thread;
 
     [self presentAddThreadToProfileWhitelistWithSuccess:^() {
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [contactThread anyUpdateContactThreadWithTransaction:transaction
                                                            block:^(TSContactThread *thread) {
                                                                // The contactoffers interaction is an unsaved
@@ -2539,7 +2539,7 @@ - (void)tappedAddToProfileWhitelistOfferMessage:(OWSContactOffersInteraction *)i
                                                                // change.
                                                                thread.hasDismissedOffers = YES;
                                                            }];
-        }];
+        });
     }];
 }
 
@@ -2754,19 +2754,19 @@ - (void)didTapConversationItem:(id<ConversationViewItem>)viewItem
         success:^(NSArray<TSAttachmentStream *> *attachmentStreams) {
             OWSAssertDebug(attachmentStreams.count == 1);
             TSAttachmentStream *attachmentStream = attachmentStreams.firstObject;
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 [message anyUpdateMessageWithTransaction:transaction
                                                    block:^(TSMessage *latestInstance) {
                                                        [latestInstance
                                                            setQuotedMessageThumbnailAttachmentStream:attachmentStream];
                                                    }];
-            }];
+            });
         }
         failure:^(NSError *error) {
             OWSLogWarn(@"Failed to redownload thumbnail with error: %@", error);
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 [self.databaseStorage touchInteraction:message transaction:transaction];
-            }];
+            });
         }];
 }
 
@@ -3299,8 +3299,9 @@ - (void)sendContactShare:(ContactShareViewModel *)contactShare
     OWSLogVerbose(@"Sending contact share.");
 
     __block BOOL didAddToProfileWhitelist;
-    [self.databaseStorage
-        asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWriteWithCompletion(
+        SDSDatabaseStorage.shared,
+        ^(SDSAnyWriteTransaction *transaction) {
             didAddToProfileWhitelist = [ThreadUtil addThreadToProfileWhitelistIfEmptyOrPendingRequest:self.thread
                                                                                           transaction:transaction];
 
@@ -3309,8 +3310,8 @@ - (void)sendContactShare:(ContactShareViewModel *)contactShare
             if (contactShare.avatarImage) {
                 [contactShare.dbRecord saveAvatarImage:contactShare.avatarImage transaction:transaction];
             }
-        }
-        completion:^{
+        },
+        ^{
             TSOutgoingMessage *message = [ThreadUtil enqueueMessageWithContactShare:contactShare.dbRecord
                                                                              thread:self.thread];
             [self messageWasSent:message];
@@ -3318,7 +3319,7 @@ - (void)sendContactShare:(ContactShareViewModel *)contactShare
             if (didAddToProfileWhitelist) {
                 [self ensureBannerState];
             }
-        }];
+        });
 }
 
 - (void)showApprovalDialogAfterProcessingVideoURL:(NSURL *)movieURL filename:(nullable NSString *)filename
@@ -3730,11 +3731,11 @@ - (void)conversationSettingsDidUpdate
 {
     OWSAssertIsOnMainThread();
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         // We updated the group, so if there was a pending message request we should accept it.
         [ThreadUtil addThreadToProfileWhitelistIfEmptyOrPendingRequest:self.thread transaction:transaction];
         [self updateDisappearingMessagesConfigurationWithTransaction:transaction];
-    }];
+    });
 }
 
 - (void)popKeyBoard
@@ -3769,9 +3770,9 @@ - (void)saveDraft
         TSThread *thread = _thread;
         NSString *currentDraft = [self.inputToolbar messageText];
 
-        [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [thread updateWithDraft:currentDraft transaction:transaction];
-        }];
+        });
     }
 }
 
@@ -4138,9 +4139,9 @@ - (void)resendGroupUpdateForErrorMessage:(TSErrorMessage *)message
         dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
             OWSLogInfo(@"Group updated, removing group creation error.");
 
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 [message anyRemoveWithTransaction:transaction];
-            }];
+            });
         });
 }
 
@@ -4357,9 +4358,9 @@ - (void)tryToSendTextMessage:(NSString *)text updateKeyboardState:(BOOL)updateKe
         [BenchManager completeEventWithEventId:@"fromSendUntil_toggleDefaultKeyboard"];
     });
 
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.thread updateWithDraft:@"" transaction:transaction];
-    }];
+    });
 
     if (didAddToProfileWhitelist) {
         [self ensureBannerState];
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationViewItem.m b/Signal/src/ViewControllers/ConversationView/ConversationViewItem.m
index 5721cc03b61..55d89d29f22 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationViewItem.m
+++ b/Signal/src/ViewControllers/ConversationView/ConversationViewItem.m
@@ -1393,9 +1393,9 @@ - (BOOL)canForwardMessage
 
 - (void)deleteAction
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.interaction anyRemoveWithTransaction:transaction];
-    }];
+    });
 }
 
 - (BOOL)hasBodyTextActionContent
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIBackup.m b/Signal/src/ViewControllers/DebugUI/DebugUIBackup.m
index eefb95938cc..9a9cae92c7e 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIBackup.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIBackup.m
@@ -225,9 +225,9 @@ + (void)clearBackupMetadataCache
 {
     OWSLogInfo(@"");
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [OWSBackupFragment anyRemoveAllWithInstantationWithTransaction:transaction];
-    }];
+    });
 }
 
 + (void)logBackupMetadataCache
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIContacts.m b/Signal/src/ViewControllers/DebugUI/DebugUIContacts.m
index 7694e010c54..0d6b7d4d039 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIContacts.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIContacts.m
@@ -81,17 +81,17 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
 + (void)clearSignalAccountCache
 {
     OWSLogWarn(@"Deleting all signal accounts.");
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [SignalAccount anyRemoveAllWithoutInstantationWithTransaction:transaction];
-    }];
+    });
 }
 
 + (void)clearSignalRecipientCache
 {
     OWSLogWarn(@"Deleting all signal recipients.");
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [SignalRecipient anyRemoveAllWithoutInstantationWithTransaction:transaction];
-    }];
+    });
 }
 
 + (SignalServiceAddress *)unregisteredRecipient
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIDiskUsage.m b/Signal/src/ViewControllers/DebugUI/DebugUIDiskUsage.m
index 6456392c891..02fef0993b6 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIDiskUsage.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIDiskUsage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "DebugUIDiskUsage.h"
@@ -54,7 +54,7 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
 
 + (void)saveAllAttachments
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSMutableArray<TSAttachmentStream *> *attachmentStreams = [NSMutableArray new];
         [TSAttachment anyEnumerateWithTransaction:transaction
                                             block:^(TSAttachment *attachment, BOOL *stop) {
@@ -76,7 +76,7 @@ + (void)saveAllAttachments
                                                      // Do nothing, rewriting is sufficient.
                                                  }];
         }
-    }];
+    });
 }
 
 + (void)deleteOldMessages_3Months
@@ -86,7 +86,7 @@ + (void)deleteOldMessages_3Months
 
 + (void)deleteOldMessages:(NSTimeInterval)maxAgeSeconds
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSArray<NSString *> *threadIds = [TSThread anyAllUniqueIdsWithTransaction:transaction];
         NSMutableArray<TSInteraction *> *interactionsToDelete = [NSMutableArray new];
         for (NSString *threadId in threadIds) {
@@ -109,7 +109,7 @@ + (void)deleteOldMessages:(NSTimeInterval)maxAgeSeconds
         for (TSInteraction *interaction in interactionsToDelete) {
             [interaction anyRemoveWithTransaction:transaction];
         }
-    }];
+    });
 }
 
 @end
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m b/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m
index 7a226419c8f..c282251f343 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m
@@ -232,10 +232,11 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
                             OWSGroupInfoRequestMessage *groupInfoRequestMessage = [[OWSGroupInfoRequestMessage alloc]
                                 initWithThread:thread
                                        groupId:[TSGroupModel generateRandomV1GroupId]];
-                            [self writeWithBlock:^(SDSAnyWriteTransaction *_Nonnull transaction) {
-                                [self.messageSenderJobQueue addMessage:groupInfoRequestMessage.asPreparer
-                                                           transaction:transaction];
-                            }];
+                            DatabaseStorageWrite(
+                                SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *_Nonnull transaction) {
+                                    [self.messageSenderJobQueue addMessage:groupInfoRequestMessage.asPreparer
+                                                               transaction:transaction];
+                                });
                         }],
         [OWSTableItem itemWithTitle:@"Message with stalled timer"
                         actionBlock:^{
@@ -328,16 +329,6 @@ - (void)readWithBlock:(void (^)(SDSAnyReadTransaction *transaction))block
     [self.class readWithBlock:block];
 }
 
-+ (void)writeWithBlock:(void (^)(SDSAnyWriteTransaction *transaction))block
-{
-    [self.databaseStorage writeWithBlock:block];
-}
-
-- (void)writeWithBlock:(void (^)(SDSAnyWriteTransaction *transaction))block
-{
-    [self.class writeWithBlock:block];
-}
-
 #pragma mark -
 
 + (void)sendMessages:(NSUInteger)count toAllMembersOfGroup:(TSGroupThread *)groupThread
@@ -356,13 +347,13 @@ + (void)sendTextMessageInThread:(TSThread *)thread counter:(NSUInteger)counter
     NSString *randomText = [self randomText];
     NSString *text = [[[@(counter) description] stringByAppendingString:@" "] stringByAppendingString:randomText];
     __block TSOutgoingMessage *message;
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         message = [ThreadUtil enqueueMessageWithText:text
                                               thread:thread
                                     quotedReplyModel:nil
                                     linkPreviewDraft:nil
                                          transaction:transaction];
-    }];
+    });
     OWSLogInfo(@"sendTextMessageInThread timestamp: %llu.", message.timestamp);
 }
 
@@ -3447,158 +3438,168 @@ + (SSKProtoEnvelope *)createEnvelopeForThread:(TSThread *)thread
 {
     OWSAssertDebug(thread);
 
+    __block NSArray<TSInteraction *> *result;
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
+        result = [self unsavedSystemMessagesInThread:thread transaction:transaction];
+    });
+    return result;
+}
+
++ (NSArray<TSInteraction *> *)unsavedSystemMessagesInThread:(TSThread *)thread
+                                                transaction:(SDSAnyWriteTransaction *)transaction
+{
+    OWSAssertDebug(thread);
+
     NSMutableArray<TSInteraction *> *result = [NSMutableArray new];
 
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
-        if ([thread isKindOfClass:[TSContactThread class]]) {
-            TSContactThread *contactThread = (TSContactThread *)thread;
+    if ([thread isKindOfClass:[TSContactThread class]]) {
+        TSContactThread *contactThread = (TSContactThread *)thread;
 
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncoming
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeOutgoing
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingMissed
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingMissedBecauseOfChangedIdentity
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeOutgoingIncomplete
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingIncomplete
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingDeclined
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-            [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeOutgoingMissed
-                                                        thread:contactThread
-                                               sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
-        }
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncoming
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeOutgoing
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingMissed
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingMissedBecauseOfChangedIdentity
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeOutgoingIncomplete
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingIncomplete
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeIncomingDeclined
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+        [result addObject:[[TSCall alloc] initWithCallType:RPRecentCallTypeOutgoingMissed
+                                                    thread:contactThread
+                                           sentAtTimestamp:[NSDate ows_millisecondTimeStamp]]];
+    }
 
-        {
-            NSNumber *durationSeconds = [OWSDisappearingMessagesConfiguration validDurationsSeconds][0];
-            OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
-                [thread disappearingMessagesConfigurationWithTransaction:transaction];
-            disappearingMessagesConfiguration = [disappearingMessagesConfiguration
-                copyAsEnabledWithDurationSeconds:(uint32_t)[durationSeconds intValue]];
-
-            [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
-                                          initWithThread:thread
-                                           configuration:disappearingMessagesConfiguration
-                                     createdByRemoteName:@"Alice"
-                                  createdInExistingGroup:NO]];
-        }
+    {
+        NSNumber *durationSeconds = [OWSDisappearingMessagesConfiguration validDurationsSeconds][0];
+        OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
+            [thread disappearingMessagesConfigurationWithTransaction:transaction];
+        disappearingMessagesConfiguration =
+            [disappearingMessagesConfiguration copyAsEnabledWithDurationSeconds:(uint32_t)[durationSeconds intValue]];
+
+        [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
+                                      initWithThread:thread
+                                       configuration:disappearingMessagesConfiguration
+                                 createdByRemoteName:@"Alice"
+                              createdInExistingGroup:NO]];
+    }
 
-        {
-            NSNumber *durationSeconds = [OWSDisappearingMessagesConfiguration validDurationsSeconds][0];
-            OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
-                [thread disappearingMessagesConfigurationWithTransaction:transaction];
-            disappearingMessagesConfiguration = [disappearingMessagesConfiguration
-                copyAsEnabledWithDurationSeconds:(uint32_t)[durationSeconds intValue]];
-
-            [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
-                                          initWithThread:thread
-                                           configuration:disappearingMessagesConfiguration
-                                     createdByRemoteName:nil
-                                  createdInExistingGroup:YES]];
-        }
+    {
+        NSNumber *durationSeconds = [OWSDisappearingMessagesConfiguration validDurationsSeconds][0];
+        OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
+            [thread disappearingMessagesConfigurationWithTransaction:transaction];
+        disappearingMessagesConfiguration =
+            [disappearingMessagesConfiguration copyAsEnabledWithDurationSeconds:(uint32_t)[durationSeconds intValue]];
+
+        [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
+                                      initWithThread:thread
+                                       configuration:disappearingMessagesConfiguration
+                                 createdByRemoteName:nil
+                              createdInExistingGroup:YES]];
+    }
 
-        {
-            NSNumber *durationSeconds = [[OWSDisappearingMessagesConfiguration validDurationsSeconds] lastObject];
-            OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
-                [thread disappearingMessagesConfigurationWithTransaction:transaction];
-            disappearingMessagesConfiguration = [disappearingMessagesConfiguration
-                copyAsEnabledWithDurationSeconds:(uint32_t)[durationSeconds intValue]];
-
-            [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
-                                          initWithThread:thread
-                                           configuration:disappearingMessagesConfiguration
-                                     createdByRemoteName:@"Alice"
-                                  createdInExistingGroup:NO]];
-        }
-        {
-            OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
-                [thread disappearingMessagesConfigurationWithTransaction:transaction];
-            disappearingMessagesConfiguration = [disappearingMessagesConfiguration copyWithIsEnabled:NO];
-
-            [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
-                                          initWithThread:thread
-                                           configuration:disappearingMessagesConfiguration
-                                     createdByRemoteName:@"Alice"
-                                  createdInExistingGroup:NO]];
-        }
+    {
+        NSNumber *durationSeconds = [[OWSDisappearingMessagesConfiguration validDurationsSeconds] lastObject];
+        OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
+            [thread disappearingMessagesConfigurationWithTransaction:transaction];
+        disappearingMessagesConfiguration =
+            [disappearingMessagesConfiguration copyAsEnabledWithDurationSeconds:(uint32_t)[durationSeconds intValue]];
+
+        [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
+                                      initWithThread:thread
+                                       configuration:disappearingMessagesConfiguration
+                                 createdByRemoteName:@"Alice"
+                              createdInExistingGroup:NO]];
+    }
+    {
+        OWSDisappearingMessagesConfiguration *disappearingMessagesConfiguration =
+            [thread disappearingMessagesConfigurationWithTransaction:transaction];
+        disappearingMessagesConfiguration = [disappearingMessagesConfiguration copyWithIsEnabled:NO];
+
+        [result addObject:[[OWSDisappearingConfigurationUpdateInfoMessage alloc]
+                                      initWithThread:thread
+                                       configuration:disappearingMessagesConfiguration
+                                 createdByRemoteName:@"Alice"
+                              createdInExistingGroup:NO]];
+    }
 
-        [result addObject:[TSInfoMessage userNotRegisteredMessageInThread:thread
-                                                                  address:[[SignalServiceAddress alloc]
-                                                                              initWithPhoneNumber:@"+19174054215"]]];
-
-        [result addObject:[[TSInfoMessage alloc] initWithThread:thread messageType:TSInfoMessageTypeSessionDidEnd]];
-        // TODO: customMessage?
-        [result addObject:[[TSInfoMessage alloc] initWithThread:thread messageType:TSInfoMessageTypeGroupUpdate]];
-        // TODO: customMessage?
-        [result addObject:[[TSInfoMessage alloc] initWithThread:thread messageType:TSInfoMessageTypeGroupQuit]];
-
-        [result addObject:[[OWSVerificationStateChangeMessage alloc]
-                                 initWithThread:thread
-                               recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
-                              verificationState:OWSVerificationStateDefault
-                                  isLocalChange:YES]];
-
-        [result addObject:[[OWSVerificationStateChangeMessage alloc]
-                                 initWithThread:thread
-                               recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
-                              verificationState:OWSVerificationStateVerified
-                                  isLocalChange:YES]];
-        [result addObject:[[OWSVerificationStateChangeMessage alloc]
-                                 initWithThread:thread
-                               recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
-                              verificationState:OWSVerificationStateNoLongerVerified
-                                  isLocalChange:YES]];
-
-        [result addObject:[[OWSVerificationStateChangeMessage alloc]
-                                 initWithThread:thread
-                               recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
-                              verificationState:OWSVerificationStateDefault
-                                  isLocalChange:NO]];
-        [result addObject:[[OWSVerificationStateChangeMessage alloc]
-                                 initWithThread:thread
-                               recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
-                              verificationState:OWSVerificationStateVerified
-                                  isLocalChange:NO]];
-        [result addObject:[[OWSVerificationStateChangeMessage alloc]
-                                 initWithThread:thread
-                               recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
-                              verificationState:OWSVerificationStateNoLongerVerified
-                                  isLocalChange:NO]];
-
-        [result addObject:[TSErrorMessage missingSessionWithEnvelope:[self createEnvelopeForThread:thread]
-                                                     withTransaction:transaction]];
-        [result addObject:[TSErrorMessage invalidKeyExceptionWithEnvelope:[self createEnvelopeForThread:thread]
-                                                          withTransaction:transaction]];
-        [result addObject:[TSErrorMessage invalidVersionWithEnvelope:[self createEnvelopeForThread:thread]
-                                                     withTransaction:transaction]];
-        [result addObject:[TSErrorMessage corruptedMessageWithEnvelope:[self createEnvelopeForThread:thread]
-                                                       withTransaction:transaction]];
+    [result addObject:[TSInfoMessage userNotRegisteredMessageInThread:thread
+                                                              address:[[SignalServiceAddress alloc]
+                                                                          initWithPhoneNumber:@"+19174054215"]]];
+
+    [result addObject:[[TSInfoMessage alloc] initWithThread:thread messageType:TSInfoMessageTypeSessionDidEnd]];
+    // TODO: customMessage?
+    [result addObject:[[TSInfoMessage alloc] initWithThread:thread messageType:TSInfoMessageTypeGroupUpdate]];
+    // TODO: customMessage?
+    [result addObject:[[TSInfoMessage alloc] initWithThread:thread messageType:TSInfoMessageTypeGroupQuit]];
+
+    [result addObject:[[OWSVerificationStateChangeMessage alloc]
+                             initWithThread:thread
+                           recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
+                          verificationState:OWSVerificationStateDefault
+                              isLocalChange:YES]];
+
+    [result addObject:[[OWSVerificationStateChangeMessage alloc]
+                             initWithThread:thread
+                           recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
+                          verificationState:OWSVerificationStateVerified
+                              isLocalChange:YES]];
+    [result addObject:[[OWSVerificationStateChangeMessage alloc]
+                             initWithThread:thread
+                           recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
+                          verificationState:OWSVerificationStateNoLongerVerified
+                              isLocalChange:YES]];
+
+    [result addObject:[[OWSVerificationStateChangeMessage alloc]
+                             initWithThread:thread
+                           recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
+                          verificationState:OWSVerificationStateDefault
+                              isLocalChange:NO]];
+    [result addObject:[[OWSVerificationStateChangeMessage alloc]
+                             initWithThread:thread
+                           recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
+                          verificationState:OWSVerificationStateVerified
+                              isLocalChange:NO]];
+    [result addObject:[[OWSVerificationStateChangeMessage alloc]
+                             initWithThread:thread
+                           recipientAddress:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]
+                          verificationState:OWSVerificationStateNoLongerVerified
+                              isLocalChange:NO]];
+
+    [result addObject:[TSErrorMessage missingSessionWithEnvelope:[self createEnvelopeForThread:thread]
+                                                 withTransaction:transaction]];
+    [result addObject:[TSErrorMessage invalidKeyExceptionWithEnvelope:[self createEnvelopeForThread:thread]
+                                                      withTransaction:transaction]];
+    [result addObject:[TSErrorMessage invalidVersionWithEnvelope:[self createEnvelopeForThread:thread]
+                                                 withTransaction:transaction]];
+    [result addObject:[TSErrorMessage corruptedMessageWithEnvelope:[self createEnvelopeForThread:thread]
+                                                   withTransaction:transaction]];
 #pragma clang diagnostic push
 #pragma clang diagnostic ignored "-Wdeprecated-declarations"
-        TSInvalidIdentityKeyReceivingErrorMessage *_Nullable blockingSNChangeMessage =
-            [TSInvalidIdentityKeyReceivingErrorMessage untrustedKeyWithEnvelope:[self createEnvelopeForThread:thread]
-                                                                withTransaction:transaction];
+    TSInvalidIdentityKeyReceivingErrorMessage *_Nullable blockingSNChangeMessage =
+        [TSInvalidIdentityKeyReceivingErrorMessage untrustedKeyWithEnvelope:[self createEnvelopeForThread:thread]
+                                                            withTransaction:transaction];
 #pragma clang diagnostic pop
 
 
-        OWSAssertDebug(blockingSNChangeMessage);
-        [result addObject:blockingSNChangeMessage];
+    OWSAssertDebug(blockingSNChangeMessage);
+    [result addObject:blockingSNChangeMessage];
 
-        [result addObject:[[TSErrorMessage alloc]
-                                 initWithThread:thread
-                              failedMessageType:TSErrorMessageNonBlockingIdentityChange
-                                        address:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]]];
-    }];
+    [result addObject:[[TSErrorMessage alloc]
+                             initWithThread:thread
+                          failedMessageType:TSErrorMessageNonBlockingIdentityChange
+                                    address:[[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]]];
 
     return result;
 }
@@ -3608,11 +3609,11 @@ + (void)createSystemMessagesInThread:(TSThread *)thread
     OWSAssertDebug(thread);
 
     NSArray<TSInteraction *> *messages = [self unsavedSystemMessagesInThread:thread];
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         for (TSInteraction *message in messages) {
             [message anyInsertWithTransaction:transaction];
         }
-    }];
+    });
 }
 
 + (void)createSystemMessageInThread:(TSThread *)thread
@@ -3621,9 +3622,9 @@ + (void)createSystemMessageInThread:(TSThread *)thread
 
     NSArray<TSInteraction *> *messages = [self unsavedSystemMessagesInThread:thread];
     TSInteraction *message = messages[(NSUInteger)arc4random_uniform((uint32_t)messages.count)];
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         [message anyInsertWithTransaction:transaction];
-    }];
+    });
 }
 
 + (void)sendTextAndSystemMessages:(NSUInteger)counter thread:(TSThread *)thread
@@ -3692,7 +3693,7 @@ + (void)createFakeThreads:(NSUInteger)threadCount withFakeMessages:(NSUInteger)m
                   OWSAssertDebug(phoneNumber);
                   OWSAssertDebug(phoneNumber.toE164);
 
-                  [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                  DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                       SignalServiceAddress *address =
                           [[SignalServiceAddress alloc] initWithPhoneNumber:phoneNumber.toE164];
                       TSContactThread *contactThread =
@@ -3706,15 +3707,15 @@ + (void)createFakeThreads:(NSUInteger)threadCount withFakeMessages:(NSUInteger)m
                       OWSLogInfo(@"Create fake thread: %@, interactions: %lu",
                           phoneNumber.toE164,
                           (unsigned long)interactionCount);
-                  }];
+                  });
               }];
 }
 
 + (void)createFakeMessagesInBatches:(NSUInteger)counter thread:(TSThread *)thread isTextOnly:(BOOL)isTextOnly
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self createFakeMessagesInBatches:counter thread:thread isTextOnly:isTextOnly transaction:transaction];
-    }];
+    });
 }
 
 + (void)createFakeMessagesInBatches:(NSUInteger)counter
@@ -3751,9 +3752,9 @@ + (void)thrashInsertAndDeleteForThread:(TSThread *)thread counter:(NSUInteger)co
     uint32_t deleteDelay = arc4random_uniform((uint32_t)(0.01 * NSEC_PER_SEC));
     dispatch_after(dispatch_time(DISPATCH_TIME_NOW, deleteDelay), dispatch_get_main_queue(), ^{
         dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
-            [self writeWithBlock:^(SDSAnyWriteTransaction *_Nonnull transaction) {
+            DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *_Nonnull transaction) {
                 [self deleteRandomMessagesWithCount:1 thread:thread transaction:transaction];
-            }];
+            });
         });
         [self thrashInsertAndDeleteForThread:thread counter:counter - 1];
     });
@@ -3854,13 +3855,13 @@ + (void)createNewGroups:(NSUInteger)counter recipientAddress:(SignalServiceAddre
 
     void (^completion)(TSGroupThread *) = ^(TSGroupThread *thread) {
         dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)1.f * NSEC_PER_SEC), dispatch_get_main_queue(), ^{
-            [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
                 [ThreadUtil enqueueMessageWithText:[@(counter) description]
                                             thread:thread
                                   quotedReplyModel:nil
                                   linkPreviewDraft:nil
                                        transaction:transaction];
-            }];
+            });
             dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)1.f * NSEC_PER_SEC), dispatch_get_main_queue(), ^{
                 [self createNewGroups:counter - 1 recipientAddress:recipientAddress];
             });
@@ -3935,12 +3936,12 @@ + (void)injectIncomingMessageInThread:(TSThread *)thread counter:(NSUInteger)cou
         return;
     }
 
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         [SSKEnvironment.shared.batchMessageProcessor enqueueEnvelopeData:envelopeData
                                                            plaintextData:plaintextData
                                                          wasReceivedByUD:NO
                                                              transaction:transaction];
-    }];
+    });
 }
 
 + (void)performRandomActions:(NSUInteger)counter thread:(TSThread *)thread
@@ -3998,13 +3999,13 @@ + (void)performRandomActionInThread:(TSThread *)thread counter:(NSUInteger)count
             [self resurrectNewOutgoingMessages2:messageCount thread:thread transaction:transaction];
         },
     ];
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         NSUInteger actionCount = 1 + (NSUInteger)arc4random_uniform(3);
         for (NSUInteger actionIdx = 0; actionIdx < actionCount; actionIdx++) {
             TransactionBlock actionBlock = actionBlocks[(NSUInteger)arc4random_uniform((uint32_t)actionBlocks.count)];
             actionBlock(transaction);
         }
-    }];
+    });
 }
 
 + (void)deleteLastMessages:(NSUInteger)count thread:(TSThread *)thread transaction:(SDSAnyWriteTransaction *)transaction
@@ -4129,14 +4130,14 @@ + (void)resurrectNewOutgoingMessages1:(NSUInteger)count
 
     dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.f * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
         OWSLogInfo(@"resurrectNewOutgoingMessages1.2: %zd", count);
-        [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
             for (TSOutgoingMessage *message in messages) {
                 [message anyRemoveWithTransaction:transaction];
             }
             for (TSOutgoingMessage *message in messages) {
                 [message anyInsertWithTransaction:transaction];
             }
-        }];
+        });
     });
 }
 
@@ -4167,18 +4168,18 @@ + (void)resurrectNewOutgoingMessages2:(NSUInteger)count
 
     dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.f * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
         OWSLogInfo(@"resurrectNewOutgoingMessages2.2: %zd", count);
-        [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
             for (TSOutgoingMessage *message in messages) {
                 [message anyRemoveWithTransaction:transaction];
             }
-        }];
+        });
         dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1.f * NSEC_PER_SEC)), dispatch_get_main_queue(), ^{
             OWSLogInfo(@"resurrectNewOutgoingMessages2.3: %zd", count);
-            [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
                 for (TSOutgoingMessage *message in messages) {
                     [message anyInsertWithTransaction:transaction];
                 }
-            }];
+            });
         });
     });
 }
@@ -4209,7 +4210,7 @@ + (void)createTimestampMessagesInThread:(TSThread *)thread
         = (addresses.count > 0 ? addresses.firstObject
                                : [[SignalServiceAddress alloc] initWithPhoneNumber:@"+19174054215"]);
 
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         for (NSNumber *timestamp in timestamps) {
             NSString *randomText = [self randomText];
             {
@@ -4237,7 +4238,7 @@ + (void)createTimestampMessagesInThread:(TSThread *)thread
                                      transaction:transaction];
             }
         }
-    }];
+    });
 }
 
 + (void)createDisappearingMessagesWhichFailedToStartInThread:(TSThread *)thread
@@ -4253,9 +4254,9 @@ + (void)createDisappearingMessagesWhichFailedToStartInThread:(TSThread *)thread
     TSIncomingMessage *message = [incomingMessageBuilder build];
     // private setter to avoid starting expire machinery.
     message.read = YES;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [message anyInsertWithTransaction:transaction];
-    }];
+    });
 }
 
 + (void)testLinkificationInThread:(TSThread *)thread
@@ -4272,7 +4273,7 @@ + (void)testLinkificationInThread:(TSThread *)thread
                                      @"https://./some/path",
                                      @"http://foo.."];
 
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         for (NSString *string in strings) {
             // DO NOT log these strings with the debugger attached.
             //        OWSLogInfo(@"%@", string);
@@ -4291,7 +4292,7 @@ + (void)testLinkificationInThread:(TSThread *)thread
                                         // Do nothing.
                                     }];
         }
-    }];
+    });
 }
 
 + (void)createRandomGroupWithName:(NSString *)groupName
@@ -4324,7 +4325,7 @@ + (void)testIndicScriptsInThread:(TSThread *)thread
         @"non-crashing string",
     ];
 
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         for (NSString *string in strings) {
             // DO NOT log these strings with the debugger attached.
             //        OWSLogInfo(@"%@", string);
@@ -4343,7 +4344,7 @@ + (void)testIndicScriptsInThread:(TSThread *)thread
                                         // Do nothing.
                                     }];
         }
-    }];
+    });
 }
 
 + (void)testZalgoTextInThread:(TSThread *)thread
@@ -4353,7 +4354,7 @@ + (void)testZalgoTextInThread:(TSThread *)thread
         @"This is some normal text",
     ];
 
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         for (NSString *string in strings) {
             OWSLogInfo(@"sending zalgo");
 
@@ -4372,7 +4373,7 @@ + (void)testZalgoTextInThread:(TSThread *)thread
                                         // Do nothing.
                                     }];
         }
-    }];
+    });
 }
 
 + (void)testDirectionalFilenamesInThread:(TSThread *)thread
@@ -4415,9 +4416,9 @@ + (void)testDirectionalFilenamesInThread:(TSThread *)thread
 
 + (void)deleteAllMessagesInThread:(TSThread *)thread
 {
-    [self writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         [thread removeAllThreadInteractionsWithTransaction:transaction];
-    }];
+    });
 }
 
 #pragma mark - Utility
@@ -4757,7 +4758,7 @@ + (void)sendMediaAlbumInThread:(TSThread *)thread
 
 + (void)requestGroupInfoForGroupThread:(TSGroupThread *)groupThread
 {
-    [self writeWithBlock:^(SDSAnyWriteTransaction *_Nonnull transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *_Nonnull transaction) {
         for (SignalServiceAddress *address in groupThread.groupModel.groupMembers) {
             TSThread *thread = [TSContactThread getOrCreateThreadWithContactAddress:address transaction:transaction];
             OWSLogInfo(@"Requesting group info for group thread from: %@", address);
@@ -4765,7 +4766,7 @@ + (void)requestGroupInfoForGroupThread:(TSGroupThread *)groupThread
                 [[OWSGroupInfoRequestMessage alloc] initWithThread:thread groupId:groupThread.groupModel.groupId];
             [self.messageSenderJobQueue addMessage:groupInfoRequestMessage.asPreparer transaction:transaction];
         }
-    }];
+    });
 }
 
 @end
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIMessagesAction.m b/Signal/src/ViewControllers/DebugUI/DebugUIMessagesAction.m
index e20bdf801f1..5e804685d51 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIMessagesAction.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIMessagesAction.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "DebugUIMessagesAction.h"
@@ -79,7 +79,7 @@ - (void)performNTimes:(NSUInteger)countParam success:(ActionSuccessBlock)success
     }
 
     __block NSUInteger count = countParam;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *_Nonnull transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *_Nonnull transaction) {
         NSUInteger batchSize = 0;
         while (count > 0) {
             NSUInteger index = count;
@@ -121,7 +121,7 @@ - (void)performNTimes:(NSUInteger)countParam success:(ActionSuccessBlock)success
                 count--;
             }
         }
-    }];
+    });
 }
 
 @end
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m b/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m
index b8677d50914..1da641a58ec 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m
@@ -85,9 +85,9 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
     [items addObject:[OWSTableItem
                          itemWithTitle:@"Clear experience upgrades (works once per launch)"
                            actionBlock:^{
-                               [DebugUIMisc.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                               DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
                                    [ExperienceUpgrade anyRemoveAllWithoutInstantationWithTransaction:transaction];
-                               }];
+                               });
                            }]];
     [items addObject:[OWSTableItem itemWithTitle:@"Clear hasDismissedOffers"
                                      actionBlock:^{
@@ -97,13 +97,13 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
     [items addObject:[OWSTableItem
                          itemWithTitle:@"Delete disappearing messages config"
                            actionBlock:^{
-                               [DebugUIMisc.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                               DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
                                    OWSDisappearingMessagesConfiguration *_Nullable config =
                                        [thread disappearingMessagesConfigurationWithTransaction:transaction];
                                    if (config) {
                                        [config anyRemoveWithTransaction:transaction];
                                    }
-                               }];
+                               });
                            }]];
 
     [items addObject:[OWSTableItem
@@ -152,11 +152,11 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
 
     [items addObject:[OWSTableItem itemWithTitle:@"Reset 2FA Repetition Interval"
                                      actionBlock:^() {
-                                         [SDSDatabaseStorage.shared
-                                             writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                         DatabaseStorageWrite(
+                                             SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
                                                  [OWS2FAManager.sharedManager
                                                      setDefaultRepetitionIntervalWithTransaction:transaction];
-                                             }];
+                                             });
                                      }]];
 
     [items addObject:[OWSTableItem subPageItemWithText:@"Share UIImage"
@@ -224,10 +224,10 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
                                      }]];
     [items addObject:[OWSTableItem itemWithTitle:@"Delete all threads without leaving groups or removing interactions"
                                      actionBlock:^{
-                                         [DebugUIMisc.databaseStorage
-                                             writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                         DatabaseStorageWrite(
+                                             SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
                                                  [TSThread anyRemoveAllWithoutInstantationWithTransaction:transaction];
-                                             }];
+                                             });
                                      }]];
 
     return [OWSTableSection sectionWithTitle:self.name items:items];
@@ -274,7 +274,7 @@ + (void)setManualCensorshipCircumventionEnabled:(BOOL)isEnabled
 
 + (void)clearHasDismissedOffers
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSMutableArray<TSContactThread *> *contactThreads = [NSMutableArray new];
         [TSThread anyEnumerateWithTransaction:transaction
                                         block:^(TSThread *thread, BOOL *stop) {
@@ -293,7 +293,7 @@ + (void)clearHasDismissedOffers
                                                                }];
             }
         }
-    }];
+    });
 }
 
 + (void)sendEncryptedDatabase:(TSThread *)thread
@@ -302,7 +302,7 @@ + (void)sendEncryptedDatabase:(TSThread *)thread
     NSString *fileName = filePath.lastPathComponent;
 
     __block BOOL success;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSError *error;
         success = [[NSFileManager defaultManager] copyItemAtPath:OWSPrimaryStorage.databaseFilePath
                                                           toPath:filePath
@@ -311,7 +311,7 @@ + (void)sendEncryptedDatabase:(TSThread *)thread
             OWSFailDebug(@"Could not copy database file: %@.", error);
             success = NO;
         }
-    }];
+    });
 
     if (!success) {
         return;
@@ -437,7 +437,7 @@ + (void)populateRandomKeyValueStores:(NSUInteger)keyCount
         OWSLogVerbose(@"batchIndex: %i / %i", (int)batchIndex, (int)batchCount);
 
         @autoreleasepool {
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 SDSKeyValueStore *store = [OWSBlockingManager keyValueStore];
                 
                 // Set three values at a time.
@@ -449,161 +449,163 @@ + (void)populateRandomKeyValueStores:(NSUInteger)keyCount
                     
                     [store setBool:true key:NSUUID.UUID.UUIDString transaction:transaction];
                 }
-            }];
+            });
         }
     }
 }
 
 + (void)clearRandomKeyValueStores
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         SDSKeyValueStore *store = [OWSBlockingManager keyValueStore];
         [store removeAllWithTransaction:transaction];
-    }];
+    });
 }
 
 + (void)saveOneOfEachModel
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
-        SignalServiceAddress *address1 = [[SignalServiceAddress alloc] initWithUuid:NSUUID.UUID phoneNumber:nil];
-        SignalServiceAddress *address2 = [[SignalServiceAddress alloc] initWithUuid:NSUUID.UUID phoneNumber:nil];
-
-        // TSThread
-        TSContactThread *thread = [TSContactThread getOrCreateThreadWithContactAddress:address1
-                                                                           transaction:transaction];
-
-        // TSInteraction
-        TSIncomingMessageBuilder *incomingMessageBuilder =
-            [TSIncomingMessageBuilder incomingMessageBuilderWithThread:thread messageBody:@"Exemplar"];
-        incomingMessageBuilder.authorAddress = address2;
-        [[incomingMessageBuilder build] anyInsertWithTransaction:transaction];
-
-        StickerPackInfo *stickerPackInfo =
-            [[StickerPackInfo alloc] initWithPackId:[Randomness generateRandomBytes:16]
-                                            packKey:[Randomness generateRandomBytes:(int)StickerManager.packKeyLength]];
-        StickerInfo *stickerInfo = [[StickerInfo alloc] initWithPackId:stickerPackInfo.packId
-                                                               packKey:stickerPackInfo.packKey
-                                                             stickerId:0];
-        // InstalledSticker
-        [[[InstalledSticker alloc] initWithInfo:stickerInfo emojiString:nil] anyInsertWithTransaction:transaction];
-
-        // StickerPack
-        [[[StickerPack alloc] initWithInfo:stickerPackInfo
-                                     title:@"some title"
-                                    author:nil
-                                     cover:[[StickerPackItem alloc] initWithStickerId:0 emojiString:@""]
-                                  stickers:@[
-                                      [[StickerPackItem alloc] initWithStickerId:1 emojiString:@""],
-                                      [[StickerPackItem alloc] initWithStickerId:2 emojiString:@""],
-                                  ]] anyInsertWithTransaction:transaction];
-
-        // KnownStickerPack
-        [[[KnownStickerPack alloc] initWithInfo:stickerPackInfo] anyInsertWithTransaction:transaction];
-
-        // OWSMessageDecryptJob
-        //
-        // TODO: Generate real envelope data.
-        if (StorageCoordinator.dataStoreForUI == DataStoreYdb) {
-            [[[OWSMessageDecryptJob alloc] initWithEnvelopeData:[Randomness generateRandomBytes:16]]
-                anyInsertWithTransaction:transaction];
-        }
-
-        // OWSMessageContentJob
-        //
-        // TODO: Generate real envelope data.
-        [[[OWSMessageContentJob alloc] initWithEnvelopeData:[Randomness generateRandomBytes:16]
-                                              plaintextData:nil
-                                            wasReceivedByUD:NO] anyInsertWithTransaction:transaction];
-
-        // TSAttachment
-        [[[TSAttachmentPointer alloc] initWithServerId:12345
-                                                cdnKey:@""
-                                             cdnNumber:0
-                                                   key:[Randomness generateRandomBytes:16]
-                                                digest:nil
-                                             byteCount:1024
-                                           contentType:OWSMimeTypePdf
-                                        sourceFilename:nil
-                                               caption:nil
-                                        albumMessageId:nil
-                                        attachmentType:TSAttachmentTypeDefault
-                                             mediaSize:CGSizeMake(1, 10)
-                                              blurHash:nil
-                                       uploadTimestamp:0] anyInsertWithTransaction:transaction];
-        [[[TSAttachmentStream alloc] initWithContentType:OWSMimeTypePdf
-                                               byteCount:1024
-                                          sourceFilename:nil
-                                                 caption:nil
-                                          albumMessageId:nil] anyInsertWithTransaction:transaction];
-
-        // ExperienceUpgrade
-        //
-        // We don't bother.
-
-        // TestModel
-        [[[TestModel alloc] init] anyInsertWithTransaction:transaction];
-
-        // OWSUserProfile
-        [[OWSUserProfile getOrBuildUserProfileForAddress:address1
-                                             transaction:transaction] updateWithUsername:nil
-                                                                           isUuidCapable:YES
-                                                                             transaction:transaction];
-
-        // OWSBackupFragment
-        //
-        // We don't bother.
-
-        // OWSRecipientIdentity
-        [[[OWSRecipientIdentity alloc] initWithAccountId:NSUUID.UUID.UUIDString
-                                             identityKey:[Randomness generateRandomBytes:16]
-                                         isFirstKnownKey:YES
-                                               createdAt:[NSDate new]
-                                       verificationState:OWSVerificationStateDefault]
-            anyInsertWithTransaction:transaction];
-
-        // SignalAccount
-        [[[SignalAccount alloc] initWithSignalServiceAddress:address1] anyInsertWithTransaction:transaction];
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
+        [self saveOneOfEachModelWithTransaction:transaction];
+    });
+}
 
-        // OWSDisappearingMessagesConfiguration
-        [[OWSDisappearingMessagesConfiguration fetchOrBuildDefaultWithThread:thread transaction:transaction]
++ (void)saveOneOfEachModelWithTransaction:(SDSAnyWriteTransaction *)transaction
+{
+    SignalServiceAddress *address1 = [[SignalServiceAddress alloc] initWithUuid:NSUUID.UUID phoneNumber:nil];
+    SignalServiceAddress *address2 = [[SignalServiceAddress alloc] initWithUuid:NSUUID.UUID phoneNumber:nil];
+
+    // TSThread
+    TSContactThread *thread = [TSContactThread getOrCreateThreadWithContactAddress:address1 transaction:transaction];
+
+    // TSInteraction
+    TSIncomingMessageBuilder *incomingMessageBuilder =
+        [TSIncomingMessageBuilder incomingMessageBuilderWithThread:thread messageBody:@"Exemplar"];
+    incomingMessageBuilder.authorAddress = address2;
+    [[incomingMessageBuilder build] anyInsertWithTransaction:transaction];
+
+    StickerPackInfo *stickerPackInfo =
+        [[StickerPackInfo alloc] initWithPackId:[Randomness generateRandomBytes:16]
+                                        packKey:[Randomness generateRandomBytes:(int)StickerManager.packKeyLength]];
+    StickerInfo *stickerInfo = [[StickerInfo alloc] initWithPackId:stickerPackInfo.packId
+                                                           packKey:stickerPackInfo.packKey
+                                                         stickerId:0];
+    // InstalledSticker
+    [[[InstalledSticker alloc] initWithInfo:stickerInfo emojiString:nil] anyInsertWithTransaction:transaction];
+
+    // StickerPack
+    [[[StickerPack alloc] initWithInfo:stickerPackInfo
+                                 title:@"some title"
+                                author:nil
+                                 cover:[[StickerPackItem alloc] initWithStickerId:0 emojiString:@""]
+                              stickers:@[
+                                  [[StickerPackItem alloc] initWithStickerId:1 emojiString:@""],
+                                  [[StickerPackItem alloc] initWithStickerId:2 emojiString:@""],
+                              ]] anyInsertWithTransaction:transaction];
+
+    // KnownStickerPack
+    [[[KnownStickerPack alloc] initWithInfo:stickerPackInfo] anyInsertWithTransaction:transaction];
+
+    // OWSMessageDecryptJob
+    //
+    // TODO: Generate real envelope data.
+    if (StorageCoordinator.dataStoreForUI == DataStoreYdb) {
+        [[[OWSMessageDecryptJob alloc] initWithEnvelopeData:[Randomness generateRandomBytes:16]]
             anyInsertWithTransaction:transaction];
+    }
 
-        // SignalRecipient
-        [[[SignalRecipient alloc] initWithAddress:address1] anyInsertWithTransaction:transaction];
-
-        // OWSUnknownDBObject
-        //
-        // We don't bother.
-
-        // OWSDevice
-        [[[OWSDevice alloc] initWithUniqueId:NSUUID.UUID.UUIDString
-                                   createdAt:[NSDate new]
-                                    deviceId:1
-                                  lastSeenAt:[NSDate new]
-                                        name:nil] anyInsertWithTransaction:transaction];
-
-        // SSKJobRecord
-        //
-        // NOTE: We insert every kind of job record.
-        [[[SSKMessageDecryptJobRecord alloc] initWithEnvelopeData:[Randomness generateRandomBytes:16]
-                                                            label:SSKMessageDecryptJobQueue.jobRecordLabel]
-            anyInsertWithTransaction:transaction];
-        TSOutgoingMessage *queuedMessage =
-            [[TSOutgoingMessageBuilder outgoingMessageBuilderWithThread:thread messageBody:@"some body"] build];
-        NSError *_Nullable error;
-        [queuedMessage anyInsertWithTransaction:transaction];
-        [[[SSKMessageSenderJobRecord alloc] initWithMessage:queuedMessage
-                                  removeMessageAfterSending:NO
-                                                      label:MessageSenderJobQueue.jobRecordLabel
-                                                transaction:transaction
-                                                      error:&error] anyInsertWithTransaction:transaction];
-        OWSAssertDebug(error == nil);
-        [[[OWSBroadcastMediaMessageJobRecord alloc]
-            initWithAttachmentIdMap:[NSMutableDictionary new]
-                              label:BroadcastMediaMessageJobQueue.jobRecordLabel] anyInsertWithTransaction:transaction];
-        [[[OWSSessionResetJobRecord alloc] initWithContactThread:thread label:OWSSessionResetJobQueue.jobRecordLabel]
-            anyInsertWithTransaction:transaction];
-    }];
+    // OWSMessageContentJob
+    //
+    // TODO: Generate real envelope data.
+    [[[OWSMessageContentJob alloc] initWithEnvelopeData:[Randomness generateRandomBytes:16]
+                                          plaintextData:nil
+                                        wasReceivedByUD:NO] anyInsertWithTransaction:transaction];
+
+    // TSAttachment
+    [[[TSAttachmentPointer alloc] initWithServerId:12345
+                                            cdnKey:@""
+                                         cdnNumber:0
+                                               key:[Randomness generateRandomBytes:16]
+                                            digest:nil
+                                         byteCount:1024
+                                       contentType:OWSMimeTypePdf
+                                    sourceFilename:nil
+                                           caption:nil
+                                    albumMessageId:nil
+                                    attachmentType:TSAttachmentTypeDefault
+                                         mediaSize:CGSizeMake(1, 10)
+                                          blurHash:nil
+                                   uploadTimestamp:0] anyInsertWithTransaction:transaction];
+    [[[TSAttachmentStream alloc] initWithContentType:OWSMimeTypePdf
+                                           byteCount:1024
+                                      sourceFilename:nil
+                                             caption:nil
+                                      albumMessageId:nil] anyInsertWithTransaction:transaction];
+
+    // ExperienceUpgrade
+    //
+    // We don't bother.
+
+    // TestModel
+    [[[TestModel alloc] init] anyInsertWithTransaction:transaction];
+
+    // OWSUserProfile
+    [[OWSUserProfile getOrBuildUserProfileForAddress:address1 transaction:transaction] updateWithUsername:nil
+                                                                                            isUuidCapable:YES
+                                                                                              transaction:transaction];
+
+    // OWSBackupFragment
+    //
+    // We don't bother.
+
+    // OWSRecipientIdentity
+    [[[OWSRecipientIdentity alloc] initWithAccountId:NSUUID.UUID.UUIDString
+                                         identityKey:[Randomness generateRandomBytes:16]
+                                     isFirstKnownKey:YES
+                                           createdAt:[NSDate new]
+                                   verificationState:OWSVerificationStateDefault] anyInsertWithTransaction:transaction];
+
+    // SignalAccount
+    [[[SignalAccount alloc] initWithSignalServiceAddress:address1] anyInsertWithTransaction:transaction];
+
+    // OWSDisappearingMessagesConfiguration
+    [[OWSDisappearingMessagesConfiguration fetchOrBuildDefaultWithThread:thread transaction:transaction]
+        anyInsertWithTransaction:transaction];
+
+    // SignalRecipient
+    [[[SignalRecipient alloc] initWithAddress:address1] anyInsertWithTransaction:transaction];
+
+    // OWSUnknownDBObject
+    //
+    // We don't bother.
+
+    // OWSDevice
+    [[[OWSDevice alloc] initWithUniqueId:NSUUID.UUID.UUIDString
+                               createdAt:[NSDate new]
+                                deviceId:1
+                              lastSeenAt:[NSDate new]
+                                    name:nil] anyInsertWithTransaction:transaction];
+
+    // SSKJobRecord
+    //
+    // NOTE: We insert every kind of job record.
+    [[[SSKMessageDecryptJobRecord alloc] initWithEnvelopeData:[Randomness generateRandomBytes:16]
+                                                        label:SSKMessageDecryptJobQueue.jobRecordLabel]
+        anyInsertWithTransaction:transaction];
+    TSOutgoingMessage *queuedMessage = [[TSOutgoingMessageBuilder outgoingMessageBuilderWithThread:thread
+                                                                                       messageBody:@"some body"] build];
+    NSError *_Nullable error;
+    [queuedMessage anyInsertWithTransaction:transaction];
+    [[[SSKMessageSenderJobRecord alloc] initWithMessage:queuedMessage
+                              removeMessageAfterSending:NO
+                                                  label:MessageSenderJobQueue.jobRecordLabel
+                                            transaction:transaction
+                                                  error:&error] anyInsertWithTransaction:transaction];
+    OWSAssertDebug(error == nil);
+    [[[OWSBroadcastMediaMessageJobRecord alloc] initWithAttachmentIdMap:[NSMutableDictionary new]
+                                                                  label:BroadcastMediaMessageJobQueue.jobRecordLabel]
+        anyInsertWithTransaction:transaction];
+    [[[OWSSessionResetJobRecord alloc] initWithContactThread:thread label:OWSSessionResetJobQueue.jobRecordLabel]
+        anyInsertWithTransaction:transaction];
 }
 
 @end
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUISessionState.m b/Signal/src/ViewControllers/DebugUI/DebugUISessionState.m
index 7b7cc93f432..6192bcd5e85 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUISessionState.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUISessionState.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "DebugUISessionState.h"
@@ -75,23 +75,23 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)threadParame
                             }],
             [OWSTableItem itemWithTitle:@"Delete all sessions"
                             actionBlock:^{
-                                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                     [self.sessionStore deleteAllSessionsForAddress:thread.contactAddress
                                                                        transaction:transaction];
-                                }];
+                                });
                             }],
             [OWSTableItem itemWithTitle:@"Archive all sessions"
                             actionBlock:^{
-                                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                     [self.sessionStore archiveAllSessionsForAddress:thread.contactAddress
                                                                         transaction:transaction];
-                                }];
+                                });
                             }],
             [OWSTableItem itemWithTitle:@"Send session reset"
                             actionBlock:^{
-                                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                     [self.sessionResetJobQueue addContactThread:thread transaction:transaction];
-                                }];
+                                });
                             }],
         ]];
     }
@@ -106,10 +106,10 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)threadParame
 
 - (void)clearSessionAndIdentityStore
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.sessionStore resetSessionStore:transaction];
         [[OWSIdentityManager sharedManager] clearIdentityState:transaction];
-    }];
+    });
 }
 
 @end
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIStress.m b/Signal/src/ViewControllers/DebugUI/DebugUIStress.m
index c86e6abbefc..89aa2625ad7 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIStress.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIStress.m
@@ -518,9 +518,9 @@ + (void)sendStressMessage:(TSOutgoingMessage *)message
 {
     OWSAssertDebug(message);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.messageSenderJobQueue addMessage:message.asPreparer transaction:transaction];
-    }];
+    });
 }
 
 + (void)sendStressMessage:(TSThread *)thread
@@ -623,7 +623,7 @@ - (void)thrashWritesWithThread:(TSThread *)thread
     __block TSThread *_Nullable otherThread = nil;
     BOOL shouldUseOtherThread = arc4random_uniform(2) == 0;
     if (shouldUseOtherThread) {
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             BOOL shouldUseGroupThread = arc4random_uniform(2) == 0;
             if (shouldUseGroupThread) {
                 NSError *_Nullable error;
@@ -647,7 +647,7 @@ - (void)thrashWritesWithThread:(TSThread *)thread
                                                                        transaction:transaction];
             }
             interactionThread = otherThread;
-        }];
+        });
     }
 
     NSString *text = NSUUID.UUID.UUIDString;
@@ -655,23 +655,23 @@ - (void)thrashWritesWithThread:(TSThread *)thread
         [TSOutgoingMessageBuilder outgoingMessageBuilderWithThread:interactionThread messageBody:text];
     TSOutgoingMessage *message = [messageBuilder build];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [message anyInsertWithTransaction:transaction];
-    }];
+    });
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [message updateWithFakeMessageState:TSOutgoingMessageStateSending transaction:transaction];
         [message updateWithFakeMessageState:TSOutgoingMessageStateFailed transaction:transaction];
-    }];
+    });
 
     BOOL shouldDelete = arc4random_uniform(2) == 0;
     if (shouldDelete) {
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [message anyRemoveWithTransaction:transaction];
             if (otherThread != nil) {
                 [otherThread anyRemoveWithTransaction:transaction];
             }
-        }];
+        });
     }
 }
 
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUISyncMessages.m b/Signal/src/ViewControllers/DebugUI/DebugUISyncMessages.m
index 6cf5aa17191..8cc1260ccd8 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUISyncMessages.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUISyncMessages.m
@@ -121,9 +121,9 @@ + (void)sendContactsSyncMessage
 
 + (void)sendGroupSyncMessage
 {
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.syncManager syncGroupsWithTransaction:transaction];
-    }];
+    });
 }
 
 + (void)sendBlockListSyncMessage
diff --git a/Signal/src/ViewControllers/HomeView/ConversationListViewController.m b/Signal/src/ViewControllers/HomeView/ConversationListViewController.m
index 1d365c6917a..892763aa47b 100644
--- a/Signal/src/ViewControllers/HomeView/ConversationListViewController.m
+++ b/Signal/src/ViewControllers/HomeView/ConversationListViewController.m
@@ -506,9 +506,9 @@ - (void)firstConversationCueWasTapped:(UITapGestureRecognizer *)gestureRecognize
 {
     OWSLogInfo(@"");
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [AppPreferences setHasDimissedFirstConversationCue:YES transaction:transaction];
-    }];
+    });
 
     [self updateViewState];
 }
@@ -978,9 +978,9 @@ - (void)archiveSelectedConversation
 
     [self.conversationSplitViewController closeSelectedConversationAnimated:YES];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [selectedThread archiveThreadAndUpdateStorageService:YES transaction:transaction];
-    }];
+    });
     [self updateViewState];
 }
 
@@ -1002,9 +1002,9 @@ - (void)unarchiveSelectedConversation
 
     [self.conversationSplitViewController closeSelectedConversationAnimated:YES];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [selectedThread unarchiveThreadAndUpdateStorageService:YES transaction:transaction];
-    }];
+    });
     [self updateViewState];
 }
 
@@ -1636,7 +1636,7 @@ - (void)deleteThread:(TSThread *)thread
         [self.conversationSplitViewController closeSelectedConversationAnimated:YES];
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         if ([thread isKindOfClass:[TSGroupThread class]]) {
             TSGroupThread *groupThread = (TSGroupThread *)thread;
             if (groupThread.isLocalUserInGroup || groupThread.isGroupV2Thread) {
@@ -1649,7 +1649,7 @@ - (void)deleteThread:(TSThread *)thread
             // contact thread
             [thread softDeleteThreadWithTransaction:transaction];
         }
-    }];
+    });
 
     [self updateViewState];
 }
@@ -1663,9 +1663,9 @@ - (void)markAsReadIndexPath:(NSIndexPath *)indexPath
 
     TSThread *thread = [self threadForIndexPath:indexPath];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [thread markAllAsReadAndUpdateStorageService:YES transaction:transaction];
-    }];
+    });
 }
 
 - (void)markAsUnreadIndexPath:(NSIndexPath *)indexPath
@@ -1677,9 +1677,9 @@ - (void)markAsUnreadIndexPath:(NSIndexPath *)indexPath
 
     TSThread *thread = [self threadForIndexPath:indexPath];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [thread markAsUnreadAndUpdateStorageService:YES transaction:transaction];
-    }];
+    });
 }
 
 - (void)archiveIndexPath:(NSIndexPath *)indexPath
@@ -1696,7 +1696,7 @@ - (void)archiveIndexPath:(NSIndexPath *)indexPath
         [self.conversationSplitViewController closeSelectedConversationAnimated:YES];
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         switch (self.conversationListMode) {
             case ConversationListMode_Inbox:
                 [thread archiveThreadAndUpdateStorageService:YES transaction:transaction];
@@ -1705,7 +1705,7 @@ - (void)archiveIndexPath:(NSIndexPath *)indexPath
                 [thread unarchiveThreadAndUpdateStorageService:YES transaction:transaction];
                 break;
         }
-    }];
+    });
     [self updateViewState];
 }
 
diff --git a/Signal/src/ViewControllers/ProfileViewController.m b/Signal/src/ViewControllers/ProfileViewController.m
index 5372ea642a4..9dab11b4f85 100644
--- a/Signal/src/ViewControllers/ProfileViewController.m
+++ b/Signal/src/ViewControllers/ProfileViewController.m
@@ -88,11 +88,11 @@ - (instancetype)initWithMode:(ProfileViewMode)profileViewMode
     _profileViewMode = profileViewMode;
     _completionHandler = completionHandler;
 
-    [ProfileViewController.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
         [ProfileViewController.keyValueStore setDate:[NSDate new]
                                                  key:kProfileView_LastPresentedDate
                                          transaction:transaction];
-    }];
+    });
 
     return self;
 }
@@ -574,11 +574,11 @@ - (void)updateProfile
 
                                   // Clear the profile name experience upgrade if the user edits their profile name,
                                   // even if they didn't dismiss the reminder directly.
-                                  [ProfileViewController.databaseStorage
-                                      asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                  DatabaseStorageAsyncWrite(
+                                      SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
                                           [ExperienceUpgradeManager
                                               clearProfileNameReminderWithTransaction:transaction.unwrapGrdbWrite];
-                                      }];
+                                      });
                               }];
                           })
                           .catch(^(NSError *error) {
diff --git a/Signal/src/ViewControllers/ThreadSettings/FingerprintViewController.m b/Signal/src/ViewControllers/ThreadSettings/FingerprintViewController.m
index 994a23202de..cb73421d8b6 100644
--- a/Signal/src/ViewControllers/ThreadSettings/FingerprintViewController.m
+++ b/Signal/src/ViewControllers/ThreadSettings/FingerprintViewController.m
@@ -535,7 +535,7 @@ - (void)fingerprintViewTapped:(UIGestureRecognizer *)gestureRecognizer
 - (void)verifyUnverifyButtonTapped:(UIGestureRecognizer *)gestureRecognizer
 {
     if (gestureRecognizer.state == UIGestureRecognizerStateRecognized) {
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             BOOL isVerified =
                 [[OWSIdentityManager sharedManager] verificationStateForAddress:self.address transaction:transaction]
                 == OWSVerificationStateVerified;
@@ -547,7 +547,7 @@ - (void)verifyUnverifyButtonTapped:(UIGestureRecognizer *)gestureRecognizer
                                                              address:self.address
                                                isUserInitiatedChange:YES
                                                          transaction:transaction];
-        }];
+        });
 
         [self dismissViewControllerAnimated:YES completion:nil];
     }
diff --git a/Signal/src/environment/SignalApp.m b/Signal/src/environment/SignalApp.m
index 930d5a0157c..7cdbc6ed231 100644
--- a/Signal/src/environment/SignalApp.m
+++ b/Signal/src/environment/SignalApp.m
@@ -99,9 +99,9 @@ - (void)presentConversationForAddress:(SignalServiceAddress *)address
                              animated:(BOOL)isAnimated
 {
     __block TSThread *thread = nil;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         thread = [TSContactThread getOrCreateThreadWithContactAddress:address transaction:transaction];
-    }];
+    });
     [self presentConversationForThread:thread action:action animated:(BOOL)isAnimated];
 }
 
diff --git a/Signal/src/util/Backup/OWSBackup.m b/Signal/src/util/Backup/OWSBackup.m
index 2bf4683b875..00129b98ae2 100644
--- a/Signal/src/util/Backup/OWSBackup.m
+++ b/Signal/src/util/Backup/OWSBackup.m
@@ -241,9 +241,9 @@ - (void)setLastExportSuccessDate:(NSDate *)value
 {
     OWSAssertDebug(value);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setDate:value key:OWSBackup_LastExportSuccessDateKey transaction:transaction];
-    }];
+    });
 }
 
 - (nullable NSDate *)lastExportSuccessDate
@@ -255,12 +255,11 @@ - (void)setLastExportFailureDate:(NSDate *)value
 {
     OWSAssertDebug(value);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setDate:value key:OWSBackup_LastExportFailureDateKey transaction:transaction];
-    }];
+    });
 }
 
-
 - (nullable NSDate *)lastExportFailureDate
 {
     return [self.keyValueStore getDate:OWSBackup_LastExportFailureDateKey];
@@ -273,14 +272,14 @@ - (BOOL)isBackupEnabled
 
 - (void)setIsBackupEnabled:(BOOL)value
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setBool:value key:OWSBackup_IsBackupEnabledKey transaction:transaction];
 
         if (!value) {
             [self.keyValueStore removeValueForKey:OWSBackup_LastExportSuccessDateKey transaction:transaction];
             [self.keyValueStore removeValueForKey:OWSBackup_LastExportFailureDateKey transaction:transaction];
         }
-    }];
+    });
 
     [self postDidChangeNotification];
 
@@ -855,7 +854,7 @@ - (AnyPromise *)lazyRestoreAttachment:(TSAttachmentPointer *)attachmentPointer
         return [AnyPromise promiseWithValue:error];
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         // This should overwrite the attachment pointer with an attachment stream.
         //
         // Since our "any" methods are strict about "insert vs. update", we need to
@@ -869,7 +868,7 @@ - (AnyPromise *)lazyRestoreAttachment:(TSAttachmentPointer *)attachmentPointer
             [oldValue anyRemoveWithTransaction:transaction];
         }
         [stream anyInsertWithTransaction:transaction];
-    }];
+    });
 
     return [AnyPromise promiseWithValue:@(1)];
 }
diff --git a/Signal/src/util/Backup/OWSBackupExportJob.m b/Signal/src/util/Backup/OWSBackupExportJob.m
index 37bbab87cb9..cd1c853db2f 100644
--- a/Signal/src/util/Backup/OWSBackupExportJob.m
+++ b/Signal/src/util/Backup/OWSBackupExportJob.m
@@ -838,9 +838,9 @@ - (AnyPromise *)saveAttachmentFilesToCloud
                 backupFragment.relativeFilePath = attachmentExport.relativeFilePath;
                 backupFragment.attachmentId = attachmentExport.attachmentId;
                 backupFragment.uncompressedDataLength = exportItem.uncompressedDataLength;
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     [backupFragment anyInsertWithTransaction:transaction];
-                }];
+                });
 
                 OWSLogVerbose(@"saved attachment: %@ as %@",
                     attachmentExport.attachmentFilePath,
@@ -1083,7 +1083,7 @@ - (void)cleanUpMetadataCacheWithActiveRecordNames:(NSSet<NSString *> *)activeRec
     // After every successful backup export, we can (and should) cull metadata
     // for any backup fragment (i.e. CloudKit record) that wasn't involved in
     // the latest backup export.
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSArray<NSString *> *allRecordNames = [OWSBackupFragment anyAllUniqueIdsWithTransaction:transaction];
 
         NSMutableSet<NSString *> *obsoleteRecordNames = [NSMutableSet new];
@@ -1099,7 +1099,7 @@ - (void)cleanUpMetadataCacheWithActiveRecordNames:(NSSet<NSString *> *)activeRec
             }
             [instance anyRemoveWithTransaction:transaction];
         }
-    }];
+    });
 }
 
 - (AnyPromise *)cleanUpCloudWithActiveRecordNames:(NSSet<NSString *> *)activeRecordNames
diff --git a/Signal/src/util/Backup/OWSBackupImportJob.m b/Signal/src/util/Backup/OWSBackupImportJob.m
index 92f2092d2cd..5833822a11f 100644
--- a/Signal/src/util/Backup/OWSBackupImportJob.m
+++ b/Signal/src/util/Backup/OWSBackupImportJob.m
@@ -150,11 +150,11 @@ - (AnyPromise *)downloadAndProcessImport
     [allItems addObjectsFromArray:self.attachmentsItems];
 
     // Record metadata for all items, so that we can re-use them in incremental backups after the restore.
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         for (OWSBackupFragment *item in allItems) {
             [item anyUpsertWithTransaction:transaction];
         }
-    }];
+    });
 
     return [self downloadFilesFromCloud:blockingItems]
         .thenInBackground(^{
@@ -375,7 +375,7 @@ - (AnyPromise *)restoreAttachmentFiles
     }
 
     __block NSUInteger count = 0;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         for (OWSBackupFragment *item in self.attachmentsItems) {
             if (self.isComplete) {
                 return;
@@ -414,7 +414,7 @@ - (AnyPromise *)restoreAttachmentFiles
                                                     @"Indicates that the backup import data is being restored.")
                                        progress:@(count / (CGFloat)self.attachmentsItems.count)];
         }
-    }];
+    });
 
     OWSLogError(@"enqueued lazy restore of %zd files.", count);
 
@@ -433,7 +433,7 @@ - (AnyPromise *)restoreDatabase
     NSMutableDictionary<NSString *, NSNumber *> *restoredEntityCounts = [NSMutableDictionary new];
     __block unsigned long long copiedEntities = 0;
     __block BOOL aborted = NO;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
     // POST GRDB TODO: We need to totally rework this, post GRDB.
 
 #ifdef GRDB_BACKUP
@@ -576,7 +576,7 @@ - (AnyPromise *)restoreDatabase
             }
         }
 #endif
-    }];
+    });
 
     if (aborted) {
         return [AnyPromise promiseWithValue:OWSBackupErrorWithDescription(@"Backup import failed.")];
diff --git a/Signal/src/util/Pastelog.m b/Signal/src/util/Pastelog.m
index 37ae566ac82..6f48e8518c8 100644
--- a/Signal/src/util/Pastelog.m
+++ b/Signal/src/util/Pastelog.m
@@ -612,7 +612,7 @@ - (void)sendToSelf:(NSURL *)url
 
     DispatchMainThreadSafe(^{
         __block TSThread *thread = nil;
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             thread = [TSContactThread getOrCreateThreadWithContactAddress:recipientAddress transaction:transaction];
         }];
         [self.databaseStorage readWithBlock:^(SDSAnyReadTransaction *transaction) {
@@ -621,7 +621,7 @@ - (void)sendToSelf:(NSURL *)url
                               quotedReplyModel:nil
                               linkPreviewDraft:nil
                                    transaction:transaction];
-        }];
+        });
     });
 
     // Also copy to pasteboard.
diff --git a/SignalMessaging/SignalMessaging-Prefix.pch b/SignalMessaging/SignalMessaging-Prefix.pch
index 0d268646ebb..5562e15e54b 100644
--- a/SignalMessaging/SignalMessaging-Prefix.pch
+++ b/SignalMessaging/SignalMessaging-Prefix.pch
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import <Availability.h>
@@ -19,4 +19,5 @@
     #import <SignalCoreKit/NSObject+OWS.h>
     #import <SignalServiceKit/OWSAnalytics.h>
     #import <SignalServiceKit/SSKAsserts.h>
+    #import <SignalServiceKit/SDSDatabaseStorage+Objc.h>
 #endif
diff --git a/SignalMessaging/ViewControllers/SelectThreadViewController.m b/SignalMessaging/ViewControllers/SelectThreadViewController.m
index a964bd9d8bf..79445111098 100644
--- a/SignalMessaging/ViewControllers/SelectThreadViewController.m
+++ b/SignalMessaging/ViewControllers/SelectThreadViewController.m
@@ -333,10 +333,10 @@ - (void)signalAccountWasSelected:(SignalAccount *)signalAccount
     }
 
     __block TSThread *thread = nil;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         thread = [TSContactThread getOrCreateThreadWithContactAddress:signalAccount.recipientAddress
                                                           transaction:transaction];
-    }];
+    });
     OWSAssertDebug(thread);
 
     [self.selectThreadViewDelegate threadWasSelected:thread];
diff --git a/SignalMessaging/ViewControllers/SharingThreadPickerViewController.m b/SignalMessaging/ViewControllers/SharingThreadPickerViewController.m
index df7dbe98cb6..a2e62306347 100644
--- a/SignalMessaging/ViewControllers/SharingThreadPickerViewController.m
+++ b/SignalMessaging/ViewControllers/SharingThreadPickerViewController.m
@@ -371,13 +371,14 @@ - (void)approveContactShare:(ContactShareApprovalViewController *)approvalViewCo
         OWSAssertIsOnMainThread();
         // TODO - in line with QuotedReply and other message attachments, saving should happen as part of sending
         // preparation rather than duplicated here and in the SAE
-        [self.databaseStorage
-            asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageAsyncWriteWithCompletion(
+            SDSDatabaseStorage.shared,
+            ^(SDSAnyWriteTransaction *transaction) {
                 if (contactShare.avatarImage) {
                     [contactShare.dbRecord saveAvatarImage:contactShare.avatarImage transaction:transaction];
                 }
-            }
-            completion:^{
+            },
+            ^{
                 __block TSOutgoingMessage *outgoingMessage = nil;
                 outgoingMessage = [ThreadUtil sendMessageNonDurablyWithContactShare:contactShare.dbRecord
                                                                              thread:self.thread
@@ -386,7 +387,7 @@ - (void)approveContactShare:(ContactShareApprovalViewController *)approvalViewCo
                                                                          }];
                 // This is necessary to show progress.
                 self.outgoingMessage = outgoingMessage;
-            }];
+            });
         
         
     }
@@ -575,8 +576,9 @@ - (void)confirmIdentityAndResendMessage:(TSOutgoingMessage *)message
 
     OWSLogDebug(@"Confirming identity for recipient: %@", address);
 
-    [self.databaseStorage
-        asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWriteWithCompletion(
+        SDSDatabaseStorage.shared,
+        ^(SDSAnyWriteTransaction *transaction) {
             OWSVerificationState verificationState =
                 [[OWSIdentityManager sharedManager] verificationStateForAddress:address transaction:transaction];
             switch (verificationState) {
@@ -606,10 +608,10 @@ - (void)confirmIdentityAndResendMessage:(TSOutgoingMessage *)message
                     break;
                 }
             }
-        }
-        completion:^{
+        },
+        ^{
             [self resendMessage:message fromViewController:fromViewController];
-        }];
+        });
 }
 
 - (void)resendMessage:(TSOutgoingMessage *)message fromViewController:(UIViewController *)fromViewController
diff --git a/SignalMessaging/appearance/Theme.m b/SignalMessaging/appearance/Theme.m
index bb70b46d263..22a7ff83898 100644
--- a/SignalMessaging/appearance/Theme.m
+++ b/SignalMessaging/appearance/Theme.m
@@ -172,9 +172,9 @@ - (void)setCurrentTheme:(ThemeMode)mode
 {
     OWSAssertIsOnMainThread();
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [Theme.keyValueStore setUInt:mode key:ThemeKeyCurrentMode transaction:transaction];
-    }];
+    });
 
     NSNumber *previousMode = self.isDarkThemeEnabledNumber;
 
diff --git a/SignalMessaging/contacts/OWSContactsManager.m b/SignalMessaging/contacts/OWSContactsManager.m
index 1d6be37b22f..8ea595fd08b 100644
--- a/SignalMessaging/contacts/OWSContactsManager.m
+++ b/SignalMessaging/contacts/OWSContactsManager.m
@@ -394,7 +394,7 @@ - (void)markIntersectionAsComplete:(NSSet<NSString *> *)phoneNumbersForIntersect
     OWSAssertDebug(phoneNumbersForIntersection.count > 0);
 
     dispatch_async(self.intersectionQueue, ^{
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             if (isFullIntersection) {
                 // replace last known numbers
                 [self.keyValueStore setObject:phoneNumbersForIntersection
@@ -455,7 +455,7 @@ - (void)markIntersectionAsComplete:(NSSet<NSString *> *)phoneNumbersForIntersect
                                       transaction:transaction];
                 }
             }
-        }];
+        });
     });
 }
 
@@ -676,7 +676,7 @@ - (void)buildSignalAccountsAndClearStaleCache:(BOOL)shouldClearStaleCache didLoa
         }
 
         // Update cached SignalAccounts on disk
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             if (signalAccountsToUpsert.count > 0) {
                 OWSLogInfo(@"Saving %lu SignalAccounts", (unsigned long)signalAccountsToUpsert.count);
                 for (SignalAccount *signalAccount in signalAccountsToUpsert) {
@@ -695,7 +695,7 @@ - (void)buildSignalAccountsAndClearStaleCache:(BOOL)shouldClearStaleCache didLoa
 
             OWSLogInfo(
                 @"SignalAccount cache size: %lu.", (unsigned long)[SignalAccount anyCountWithTransaction:transaction]);
-        }];
+        });
 
         // Add system contacts to the profile whitelist immediately
         // so that they do not see the "message request" UI.
diff --git a/SignalMessaging/contacts/OWSSyncManager.m b/SignalMessaging/contacts/OWSSyncManager.m
index 0b7ff900cf0..3b8e7de4188 100644
--- a/SignalMessaging/contacts/OWSSyncManager.m
+++ b/SignalMessaging/contacts/OWSSyncManager.m
@@ -212,7 +212,7 @@ - (void)sendConfigurationSyncMessage_AppReady {
     BOOL showUnidentifiedDeliveryIndicators = Environment.shared.preferences.shouldShowUnidentifiedDeliveryIndicators;
     BOOL showTypingIndicators = self.typingIndicators.areTypingIndicatorsEnabled;
 
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         TSThread *_Nullable thread = [TSAccountManager getOrCreateLocalThreadWithTransaction:transaction];
         if (thread == nil) {
             OWSFailDebug(@"Missing thread.");
@@ -229,7 +229,7 @@ - (void)sendConfigurationSyncMessage_AppReady {
                                                sendLinkPreviews:sendLinkPreviews];
 
         [self.messageSenderJobQueue addMessage:syncConfigurationMessage.asPreparer transaction:transaction];
-    }];
+    });
 }
 
 - (void)processIncomingConfigurationSyncMessage:(SSKProtoSyncMessageConfiguration *)syncMessage transaction:(SDSAnyWriteTransaction *)transaction
@@ -411,11 +411,13 @@ - (AnyPromise *)syncContactsForSignalAccounts:(NSArray<SignalAccount *> *)signal
                                                         OWSLogInfo(@"Successfully sent contacts sync message.");
                                                         
                                                         if (messageHash != nil) {
-                                                            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
-                                                                [OWSSyncManager.keyValueStore setData:messageHash
-                                                                                                  key:kSyncManagerLastContactSyncKey
-                                                                                          transaction:transaction];
-                                                            }];
+                                                            DatabaseStorageWrite(self.databaseStorage,
+                                                                ^(SDSAnyWriteTransaction *transaction) {
+                                                                    [OWSSyncManager.keyValueStore
+                                                                            setData:messageHash
+                                                                                key:kSyncManagerLastContactSyncKey
+                                                                        transaction:transaction];
+                                                                });
                                                         }
                                                         
                                                         dispatch_async(self.serialQueue, ^{
@@ -471,7 +473,7 @@ - (void)sendFetchLatestSyncMessageWithType:(OWSSyncFetchType)fetchType
         return;
     }
 
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         TSThread *_Nullable thread = [TSAccountManager getOrCreateLocalThreadWithTransaction:transaction];
         if (thread == nil) {
             OWSFailDebug(@"Missing thread.");
@@ -482,7 +484,7 @@ - (void)sendFetchLatestSyncMessageWithType:(OWSSyncFetchType)fetchType
             [[OWSSyncFetchLatestMessage alloc] initWithThread:thread fetchType:fetchType];
 
         [self.messageSenderJobQueue addMessage:syncFetchLatestMessage.asPreparer transaction:transaction];
-    }];
+    });
 }
 
 - (void)processIncomingFetchLatestSyncMessage:(SSKProtoSyncMessageFetchLatest *)syncMessage
diff --git a/SignalMessaging/environment/OWSSounds.m b/SignalMessaging/environment/OWSSounds.m
index ded9cc19b4e..fa51854059b 100644
--- a/SignalMessaging/environment/OWSSounds.m
+++ b/SignalMessaging/environment/OWSSounds.m
@@ -309,9 +309,9 @@ + (void)setGlobalNotificationSound:(OWSSound)sound
 
 - (void)setGlobalNotificationSound:(OWSSound)sound
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self setGlobalNotificationSound:sound transaction:transaction];
-    }];
+    });
 }
 
 + (void)setGlobalNotificationSound:(OWSSound)sound transaction:(SDSAnyWriteTransaction *)transaction
@@ -376,9 +376,9 @@ + (OWSSound)notificationSoundForThread:(TSThread *)thread
 
 + (void)setNotificationSound:(OWSSound)sound forThread:(TSThread *)thread
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setUInt:sound key:thread.uniqueId transaction:transaction];
-    }];
+    });
 }
 
 #pragma mark - AudioPlayer
diff --git a/SignalMessaging/environment/migrations/OWSDatabaseMigration.m b/SignalMessaging/environment/migrations/OWSDatabaseMigration.m
index 217fd19f6ff..63f97332fa9 100644
--- a/SignalMessaging/environment/migrations/OWSDatabaseMigration.m
+++ b/SignalMessaging/environment/migrations/OWSDatabaseMigration.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import <SignalMessaging/OWSDatabaseMigration.h>
@@ -88,9 +88,9 @@ + (void)markMigrationIdAsIncomplete:(NSString *)migrationId transaction:(SDSAnyW
 
 - (void)markAsCompleteWithSneakyTransaction
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self markAsCompleteWithTransaction:transaction];
-    }];
+    });
 }
 
 - (BOOL)isCompleteWithSneakyTransaction
diff --git a/SignalMessaging/environment/migrations/OWSDatabaseMigrationRunner.m b/SignalMessaging/environment/migrations/OWSDatabaseMigrationRunner.m
index ac506135ab3..a7f61034893 100644
--- a/SignalMessaging/environment/migrations/OWSDatabaseMigrationRunner.m
+++ b/SignalMessaging/environment/migrations/OWSDatabaseMigrationRunner.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSDatabaseMigrationRunner.h"
@@ -59,13 +59,13 @@ - (SDSDatabaseStorage *)databaseStorage
 
 - (void)assumeAllExistingMigrationsRun
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         for (OWSDatabaseMigration *migration in self.allMigrations) {
             OWSLogInfo(@"Skipping migration on new install: %@", migration);
 
             [migration markAsCompleteWithTransaction:transaction];
         }
-    }];
+    });
 }
 
 - (void)runAllOutstandingWithCompletion:(OWSDatabaseMigrationCompletion)completion
@@ -86,7 +86,7 @@ - (void)removeUnknownMigrations
         [knownMigrationIds addObject:migration.migrationId];
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSArray<NSString *> *savedMigrationIds =
             [OWSDatabaseMigration allCompleteMigrationIdsWithTransaction:transaction];
 
@@ -98,7 +98,7 @@ - (void)removeUnknownMigrations
             OWSLogInfo(@"Culling unknown migration: %@", unknownMigrationId);
             [OWSDatabaseMigration markMigrationIdAsIncomplete:unknownMigrationId transaction:transaction];
         }
-    }];
+    });
 }
 
 // Run migrations serially to:
diff --git a/SignalMessaging/profiles/OWSProfileManager.m b/SignalMessaging/profiles/OWSProfileManager.m
index 2acc993dcda..409e69e6e97 100644
--- a/SignalMessaging/profiles/OWSProfileManager.m
+++ b/SignalMessaging/profiles/OWSProfileManager.m
@@ -246,10 +246,10 @@ - (OWSUserProfile *)localUserProfile
         return localUserProfile;
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         localUserProfile =
             [OWSUserProfile getOrBuildUserProfileForAddress:OWSUserProfile.localProfileAddress transaction:transaction];
-    }];
+    });
 
     @synchronized(self) {
         _localUserProfile = localUserProfile;
@@ -481,9 +481,9 @@ - (void)fetchAndUpdateProfileForUsername:(NSString *)username
 
     dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
         __block OWSUserProfile *_Nullable userProfile;
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             userProfile = [OWSUserProfile userProfileForUsername:username transaction:transaction];
-        }];
+        });
 
         if (userProfile) {
             success(userProfile.address);
@@ -661,7 +661,7 @@ - (void)rotateProfileKeyWithIntersectingPhoneNumbers:(NSSet<NSString *> *)inters
 
         // Rotate the stored profile key.
         AnyPromise *promise = [AnyPromise promiseWithResolverBlock:^(PMKResolver resolve) {
-            [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 SignalServiceAddress *_Nullable localAddress =
                     [self.tsAccountManager localAddressWithTransaction:transaction];
                 oldAvatarData = [self profileAvatarDataForAddress:localAddress transaction:transaction];
@@ -681,7 +681,7 @@ - (void)rotateProfileKeyWithIntersectingPhoneNumbers:(NSSet<NSString *> *)inters
                 // We schedule the updates here but process them below using processProfileKeyUpdates.
                 // It's more efficient to process them after the intermediary steps are done.
                 [self.groupsV2 scheduleAllGroupsV2ForProfileKeyUpdateWithTransaction:transaction];
-            }];
+            });
         }];
 
         // Try to re-upload our profile name and avatar, if any.
@@ -700,7 +700,7 @@ - (void)rotateProfileKeyWithIntersectingPhoneNumbers:(NSSet<NSString *> *)inters
             // Remove blocked users and groups from profile whitelist.
             //
             // This will always succeed.
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 [self.whitelistedPhoneNumbersStore removeValuesForKeys:intersectingPhoneNumbers.allObjects
                                                            transaction:transaction];
                 [self.whitelistedUUIDsStore removeValuesForKeys:intersectingUUIDs.allObjects transaction:transaction];
@@ -708,7 +708,7 @@ - (void)rotateProfileKeyWithIntersectingPhoneNumbers:(NSSet<NSString *> *)inters
                     NSString *groupIdKey = [self groupKeyForGroupId:groupId];
                     [self.whitelistedGroupsStore removeValueForKey:groupIdKey transaction:transaction];
                 }
-            }];
+            });
             return @(1);
         });
 
@@ -761,7 +761,7 @@ - (void)clearProfileWhitelist
 {
     OWSLogWarn(@"Clearing the profile whitelist.");
 
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.whitelistedPhoneNumbersStore removeAllWithTransaction:transaction];
         [self.whitelistedUUIDsStore removeAllWithTransaction:transaction];
         [self.whitelistedGroupsStore removeAllWithTransaction:transaction];
@@ -769,13 +769,13 @@ - (void)clearProfileWhitelist
         OWSAssertDebug(0 == [self.whitelistedPhoneNumbersStore numberOfKeysWithTransaction:transaction]);
         OWSAssertDebug(0 == [self.whitelistedUUIDsStore numberOfKeysWithTransaction:transaction]);
         OWSAssertDebug(0 == [self.whitelistedGroupsStore numberOfKeysWithTransaction:transaction]);
-    }];
+    });
 }
 
 - (void)removeThreadFromProfileWhitelist:(TSThread *)thread
 {
     OWSLogWarn(@"Removing thread from profile whitelist: %@", thread);
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         if ([thread isKindOfClass:TSContactThread.class]) {
             TSContactThread *contactThread = (TSContactThread *)thread;
             NSString *_Nullable phoneNumber = contactThread.contactAddress.phoneNumber;
@@ -792,7 +792,7 @@ - (void)removeThreadFromProfileWhitelist:(TSThread *)thread
             NSString *groupKey = [self groupKeyForGroupId:groupThread.groupModel.groupId];
             [self.whitelistedGroupsStore removeValueForKey:groupKey transaction:transaction];
         }
-    }];
+    });
 }
 
 - (void)logProfileWhitelist
@@ -822,12 +822,12 @@ - (void)logProfileWhitelist
 - (void)debug_regenerateLocalProfileWithSneakyTransaction
 {
     OWSUserProfile *userProfile = self.localUserProfile;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [userProfile clearWithProfileKey:[OWSAES256Key generateRandomKey]
                      wasLocallyInitiated:YES
                              transaction:transaction
                               completion:nil];
-    }];
+    });
     [self.tsAccountManager updateAccountAttributes].catch(^(NSError *error) {
         OWSLogError(@"Error: %@.", error);
     });
@@ -880,11 +880,11 @@ - (void)addUsersToProfileWhitelist:(NSArray<SignalServiceAddress *> *)addresses
             return;
         }
 
-        [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *writeTransaction) {
+        DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *writeTransaction) {
             [self addConfirmedUnwhitelistedAddresses:addressesToAdd
                                  wasLocallyInitiated:YES
                                          transaction:writeTransaction];
-        }];
+        });
     }];
 }
 
@@ -951,11 +951,11 @@ - (void)removeUsersFromProfileWhitelist:(NSArray<SignalServiceAddress *> *)addre
             return;
         }
 
-        [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *writeTransaction) {
+        DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *writeTransaction) {
             [self removeConfirmedWhitelistedAddresses:addressesToRemove
                                   wasLocallyInitiated:YES
                                           transaction:writeTransaction];
-        }];
+        });
     }];
 }
 
@@ -1148,9 +1148,9 @@ - (void)addGroupIdToProfileWhitelist:(NSData *)groupId
             // Do nothing.
             return;
         }
-        [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *writeTransaction) {
+        DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *writeTransaction) {
             [self addConfirmedUnwhitelistedGroupId:groupId wasLocallyInitiated:YES transaction:writeTransaction];
-        }];
+        });
     }];
 }
 
@@ -1179,9 +1179,9 @@ - (void)removeGroupIdFromProfileWhitelist:(NSData *)groupId
             // Do nothing.
             return;
         }
-        [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *writeTransaction) {
+        DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *writeTransaction) {
             [self removeConfirmedWhitelistedGroupId:groupId wasLocallyInitiated:YES transaction:writeTransaction];
-        }];
+        });
     }];
 }
 
@@ -1425,7 +1425,7 @@ - (void)setProfileKeyData:(NSData *)profileKeyData
 
 - (void)fillInMissingProfileKeys:(NSDictionary<SignalServiceAddress *, NSData *> *)profileKeys
 {
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         for (SignalServiceAddress *address in profileKeys) {
             NSData *_Nullable profileKeyData = profileKeys[address];
             if (profileKeyData == nil) {
@@ -1443,7 +1443,7 @@ - (void)fillInMissingProfileKeys:(NSDictionary<SignalServiceAddress *, NSData *>
                 wasLocallyInitiated:NO
                         transaction:transaction];
         }
-    }];
+    });
 }
 
 - (void)setProfileGivenName:(nullable NSString *)givenName
@@ -1697,10 +1697,10 @@ - (void)downloadAvatarForUserProfile:(OWSUserProfile *)userProfile
                 }
 
                 __block OWSUserProfile *latestUserProfile;
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     latestUserProfile =
                         [OWSUserProfile getOrBuildUserProfileForAddress:userProfile.address transaction:transaction];
-                }];
+                });
 
                 if (latestUserProfile.profileKey.keyData.length < 1
                     || ![latestUserProfile.profileKey isEqual:userProfile.profileKey]) {
@@ -1726,7 +1726,7 @@ - (void)downloadAvatarForUserProfile:(OWSUserProfile *)userProfile
                 } else {
                     [self updateProfileAvatarCache:image filename:fileName];
 
-                    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                         [latestUserProfile updateWithAvatarFileName:fileName transaction:transaction];
 
                         // If we're updating the profile that corresponds to our local number,
@@ -1737,7 +1737,7 @@ - (void)downloadAvatarForUserProfile:(OWSUserProfile *)userProfile
 
                             [localUserProfile updateWithAvatarFileName:fileName transaction:transaction];
                         }
-                    }];
+                    });
                 }
 
                 OWSAssertDebug(backgroundTask);
@@ -1785,7 +1785,7 @@ - (void)updateProfileForAddress:(SignalServiceAddress *)address
         OWSAssertDebug(localUserProfile);
 
         __block OWSUserProfile *userProfile;
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             userProfile = [OWSUserProfile getOrBuildUserProfileForAddress:address transaction:transaction];
 
             // If we're updating the profile that corresponds to our local number,
@@ -1842,7 +1842,7 @@ - (void)updateProfileForAddress:(SignalServiceAddress *)address
                     [localUserProfile updateWithAvatarFileName:userProfile.avatarFileName transaction:transaction];
                 }
             }
-        }];
+        });
 
         // Whenever we change avatarUrlPath, OWSUserProfile clears avatarFileName.
         // So if avatarUrlPath is set and avatarFileName is not set, we should to
@@ -1973,9 +1973,9 @@ - (void)userAddedThreadToProfileWhitelist:(TSThread *)thread
     OWSProfileKeyMessage *message = [[OWSProfileKeyMessage alloc] initWithThread:thread];
     [OWSProfileManager.sharedManager addThreadToProfileWhitelist:thread];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.messageSenderJobQueue addMessage:message.asPreparer transaction:transaction];
-    }];
+    });
 }
 
 #pragma mark - Notifications
diff --git a/SignalMessaging/utils/OWSOrphanDataCleaner.m b/SignalMessaging/utils/OWSOrphanDataCleaner.m
index 0a89f8f22a3..f76084ab3e0 100644
--- a/SignalMessaging/utils/OWSOrphanDataCleaner.m
+++ b/SignalMessaging/utils/OWSOrphanDataCleaner.m
@@ -675,7 +675,7 @@ + (void)auditAndCleanup:(BOOL)shouldRemoveOrphans
                 success:^{
                     OWSLogInfo(@"Completed orphan data cleanup.");
 
-                    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                         [self.keyValueStore setString:AppVersion.sharedInstance.currentAppVersion
                                                   key:OWSOrphanDataCleaner_LastCleaningVersionKey
                                           transaction:transaction];
@@ -683,7 +683,7 @@ + (void)auditAndCleanup:(BOOL)shouldRemoveOrphans
                         [self.keyValueStore setDate:[NSDate new]
                                                 key:OWSOrphanDataCleaner_LastCleaningDateKey
                                         transaction:transaction];
-                    }];
+                    });
 
                     if (completion) {
                         completion();
@@ -758,7 +758,7 @@ + (BOOL)processOrphansSync:(OWSOrphanData *)orphanData
     NSDate *appLaunchTime = CurrentAppContext().appLaunchTime;
     NSTimeInterval thresholdTimestamp = appLaunchTime.timeIntervalSince1970 - kMinimumOrphanAgeSeconds;
     NSDate *thresholdDate = [NSDate dateWithTimeIntervalSince1970:thresholdTimestamp];
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSUInteger interactionsRemoved = 0;
         for (NSString *interactionId in orphanData.interactionIds) {
             if (!self.isMainAppAndActive) {
@@ -847,7 +847,7 @@ + (BOOL)processOrphansSync:(OWSOrphanData *)orphanData
             [reaction anyRemoveWithTransaction:transaction];
         }
         OWSLogInfo(@"Deleted orphan reactions: %zu", reactionsRemoved);
-    }];
+    });
 
     if (shouldAbort) {
         return NO;
diff --git a/SignalMessaging/utils/OWSPreferences.m b/SignalMessaging/utils/OWSPreferences.m
index 70f7b163e88..126b0a1f161 100644
--- a/SignalMessaging/utils/OWSPreferences.m
+++ b/SignalMessaging/utils/OWSPreferences.m
@@ -106,9 +106,9 @@ - (BOOL)hasValueForKey:(NSString *)key
 
 - (void)removeValueForKey:(NSString *)key
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore removeValueForKey:key transaction:transaction];
-    }];
+    });
 }
 
 - (BOOL)boolForKey:(NSString *)key defaultValue:(BOOL)defaultValue
@@ -122,9 +122,9 @@ - (BOOL)boolForKey:(NSString *)key defaultValue:(BOOL)defaultValue
 
 - (void)setBool:(BOOL)value forKey:(NSString *)key
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setBool:value key:key transaction:transaction];
-    }];
+    });
 }
 
 - (NSUInteger)uintForKey:(NSString *)key defaultValue:(NSUInteger)defaultValue
@@ -138,9 +138,9 @@ - (NSUInteger)uintForKey:(NSString *)key defaultValue:(NSUInteger)defaultValue
 
 - (void)setUInt:(NSUInteger)value forKey:(NSString *)key
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setUInt:value key:key transaction:transaction];
-    }];
+    });
 }
 
 - (nullable NSDate *)dateForKey:(NSString *)key
@@ -154,9 +154,9 @@ - (nullable NSDate *)dateForKey:(NSString *)key
 
 - (void)setDate:(NSDate *)value forKey:(NSString *)key
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setDate:value key:key transaction:transaction];
-    }];
+    });
 }
 
 - (nullable NSString *)stringForKey:(NSString *)key
@@ -170,9 +170,9 @@ - (nullable NSString *)stringForKey:(NSString *)key
 
 - (void)setString:(NSString *)value forKey:(NSString *)key
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setString:value key:key transaction:transaction];
-    }];
+    });
 }
 
 #pragma mark - Specific Preferences
diff --git a/SignalMessaging/utils/ThreadUtil.m b/SignalMessaging/utils/ThreadUtil.m
index c053bee15e5..c29ee83686f 100644
--- a/SignalMessaging/utils/ThreadUtil.m
+++ b/SignalMessaging/utils/ThreadUtil.m
@@ -84,15 +84,16 @@ + (TSOutgoingMessage *)enqueueMessageWithText:(nullable NSString *)fullMessageTe
 
     [BenchManager benchAsyncWithTitle:@"Saving outgoing message"
                                 block:^(void (^benchmarkCompletion)(void)) {
-                                    [self.databaseStorage
-                                        asyncWriteWithBlock:^(SDSAnyWriteTransaction *writeTransaction) {
+                                    DatabaseStorageAsyncWriteWithCompletion(
+                                        SDSDatabaseStorage.shared,
+                                        ^(SDSAnyWriteTransaction *writeTransaction) {
                                             [outgoingMessagePreparer
                                                 insertMessageWithLinkPreviewDraft:linkPreviewDraft
                                                                       transaction:writeTransaction];
                                             [self.messageSenderJobQueue addMessage:outgoingMessagePreparer
                                                                        transaction:writeTransaction];
-                                        }
-                                                 completion:benchmarkCompletion];
+                                        },
+                                        benchmarkCompletion);
                                 }];
 
     return outgoingMessagePreparer.unpreparedMessage;
@@ -193,7 +194,7 @@ + (void)enqueueMessage:(TSOutgoingMessage *)message
     OWSAssertDebug(stickerDraft != nil);
     OWSAssertDebug(thread != nil);
 
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         MessageSticker *_Nullable messageSticker = [self messageStickerForStickerDraft:stickerDraft
                                                                            transaction:transaction];
         if (!messageSticker) {
@@ -205,7 +206,7 @@ + (void)enqueueMessage:(TSOutgoingMessage *)message
         [message updateWithMessageSticker:messageSticker transaction:transaction];
         
         [self.messageSenderJobQueue addMessage:message.asPreparer transaction:transaction];
-    }];
+    });
 }
 
 // MARK: Non-Durable Sending
@@ -248,7 +249,7 @@ + (TSOutgoingMessage *)sendMessageNonDurablyWithText:(NSString *)fullMessageText
                                                 quotedReplyModel:quotedReplyModel
                                                      transaction:transaction];
 
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *writeTransaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *writeTransaction) {
         [outgoingMessagePreparer insertMessageWithLinkPreviewDraft:nil transaction:writeTransaction];
 
         [messageSender sendMessage:outgoingMessagePreparer
@@ -262,7 +263,7 @@ + (TSOutgoingMessage *)sendMessageNonDurablyWithText:(NSString *)fullMessageText
                     completion(error);
                 });
             }];
-    }];
+    });
 
     return outgoingMessagePreparer.unpreparedMessage;
 }
@@ -325,7 +326,7 @@ + (void)deleteAllContent
 {
     OWSLogInfo(@"");
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [TSThread anyRemoveAllWithInstantationWithTransaction:transaction];
         [TSInteraction anyRemoveAllWithInstantationWithTransaction:transaction];
         [TSAttachment anyRemoveAllWithInstantationWithTransaction:transaction];
@@ -334,7 +335,7 @@ + (void)deleteAllContent
         // Deleting attachments above should be enough to remove any gallery items, but
         // we redunantly clean up *all* gallery items to be safe.
         [AnyMediaGalleryFinder didRemoveAllContentWithTransaction:transaction];
-    }];
+    });
     [TSAttachmentStream deleteAttachmentsFromDisk];
 }
 
diff --git a/SignalServiceKit/src/Account/TSAccountManager.m b/SignalServiceKit/src/Account/TSAccountManager.m
index fd6dac45383..c154a2606a9 100644
--- a/SignalServiceKit/src/Account/TSAccountManager.m
+++ b/SignalServiceKit/src/Account/TSAccountManager.m
@@ -381,9 +381,9 @@ - (void)didRegister
         OWSFail(@"uuid was unexpectedly nil");
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self storeLocalNumber:phoneNumber uuid:uuid transaction:transaction];
-    }];
+    });
 
     [self postRegistrationStateDidChangeNotification];
 }
@@ -392,7 +392,7 @@ - (void)recordUuidForLegacyUser:(NSUUID *)uuid
 {
     OWSAssert(self.localUuid == nil);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         @synchronized(self) {
             [self.keyValueStore setString:uuid.UUIDString
                                       key:TSAccountManager_RegisteredUUIDKey
@@ -400,7 +400,7 @@ - (void)recordUuidForLegacyUser:(NSUUID *)uuid
 
             [self loadAccountStateWithTransaction:transaction];
         }
-    }];
+    });
 }
 
 + (nullable NSString *)localNumber
@@ -521,9 +521,9 @@ - (void)storeLocalNumber:(NSString *)localNumber
 - (uint32_t)getOrGenerateRegistrationId
 {
     __block uint32_t result;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         result = [self getOrGenerateRegistrationIdWithTransaction:transaction];
-    }];
+    });
     return result;
 }
 
@@ -797,7 +797,7 @@ - (void)setIsDeregistered:(BOOL)isDeregistered
 
     OWSLogWarn(@"Updating isDeregistered: %d", isDeregistered);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         @synchronized(self) {
             [self.keyValueStore setObject:@(isDeregistered)
                                       key:TSAccountManager_IsDeregisteredKey
@@ -805,7 +805,7 @@ - (void)setIsDeregistered:(BOOL)isDeregistered
 
             [self loadAccountStateWithTransaction:transaction];
         }
-    }];
+    });
 
     [self postRegistrationStateDidChangeNotification];
 }
@@ -820,7 +820,7 @@ - (BOOL)resetForReregistration
         return NO;
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         @synchronized(self) {
             self.phoneNumberAwaitingVerification = nil;
             self.uuidAwaitingVerification = nil;
@@ -842,7 +842,7 @@ - (BOOL)resetForReregistration
             [OWSKeyBackupService clearKeysWithTransaction:transaction];
             [OWS2FAManager.sharedManager setPinCode:nil transaction:transaction];
         }
-    }];
+    });
 
     [self postRegistrationStateDidChangeNotification];
 
@@ -872,7 +872,7 @@ - (void)setIsTransferInProgress:(BOOL)transferInProgress
         return;
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         @synchronized(self) {
             [self.keyValueStore setObject:@(transferInProgress)
                                       key:TSAccountManager_IsTransferInProgressKey
@@ -880,7 +880,7 @@ - (void)setIsTransferInProgress:(BOOL)transferInProgress
 
             [self loadAccountStateWithTransaction:transaction];
         }
-    }];
+    });
 
     [self postRegistrationStateDidChangeNotification];
 }
@@ -892,7 +892,7 @@ - (BOOL)wasTransferred
 
 - (void)setWasTransferred:(BOOL)wasTransferred
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         @synchronized(self) {
             [self.keyValueStore setObject:@(wasTransferred)
                                       key:TSAccountManager_WasTransferredKey
@@ -900,7 +900,7 @@ - (void)setWasTransferred:(BOOL)wasTransferred
 
             [self loadAccountStateWithTransaction:transaction];
         }
-    }];
+    });
 
     [self postRegistrationStateDidChangeNotification];
 }
@@ -919,9 +919,9 @@ - (BOOL)hasPendingBackupRestoreDecision
 - (void)setHasPendingBackupRestoreDecision:(BOOL)value
 {
     OWSLogInfo(@"%d", value);
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setBool:value key:TSAccountManager_HasPendingRestoreDecisionKey transaction:transaction];
-    }];
+    });
     [self postRegistrationStateDidChangeNotification];
 }
 
@@ -937,9 +937,9 @@ - (BOOL)isManualMessageFetchEnabled
 
 - (void)setIsManualMessageFetchEnabled:(BOOL)value
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setBool:value key:TSAccountManager_ManualMessageFetchKey transaction:transaction];
-    }];
+    });
 }
 
 - (void)registerForTestsWithLocalNumber:(NSString *)localNumber uuid:(NSUUID *)uuid
@@ -950,9 +950,9 @@ - (void)registerForTestsWithLocalNumber:(NSString *)localNumber uuid:(NSUUID *)u
     OWSAssertDebug(localNumber.length > 0);
     OWSAssertDebug(uuid != nil);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self storeLocalNumber:localNumber uuid:uuid transaction:transaction];
-    }];
+    });
 }
 
 - (void)reachabilityChanged {
diff --git a/SignalServiceKit/src/Account/TSPreKeyManager.m b/SignalServiceKit/src/Account/TSPreKeyManager.m
index fca0d4bf2b8..88d8123eb36 100644
--- a/SignalServiceKit/src/Account/TSPreKeyManager.m
+++ b/SignalServiceKit/src/Account/TSPreKeyManager.m
@@ -301,7 +301,7 @@ + (void)clearSignedPreKeyRecordsWithKeyId:(NSNumber *_Nullable)keyId
 
 + (void)cullPreKeyRecords {
     NSTimeInterval expirationInterval = kDayInterval * 30;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSMutableArray<NSString *> *keys = [[self.preKeyStore.keyStore allKeysWithTransaction:transaction] mutableCopy];
         NSMutableSet<NSString *> *keysToRemove = [NSMutableSet new];
         [Batching loopObjcWithBatchSize:Batching.kDefaultBatchSize
@@ -336,7 +336,7 @@ + (void)cullPreKeyRecords {
             [self.preKeyStore.keyStore removeValueForKey:key
                                              transaction:transaction];
         }
-    }];
+    });
 }
 
 + (NSArray *)removeCurrentRecord:(SignedPreKeyRecord *)currentRecord fromRecords:(NSArray *)allRecords {
diff --git a/SignalServiceKit/src/Contacts/ContactsUpdater.m b/SignalServiceKit/src/Contacts/ContactsUpdater.m
index e30c1176100..f43d71131e0 100644
--- a/SignalServiceKit/src/Contacts/ContactsUpdater.m
+++ b/SignalServiceKit/src/Contacts/ContactsUpdater.m
@@ -106,7 +106,7 @@ - (void)contactIntersectionWithSet:(NSSet<NSString *> *)phoneNumbersToLookup
         }
 
         NSSet<NSString *> *registeredPhoneNumbers = operation.registeredPhoneNumbers;
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             for (NSString *phoneNumber in phoneNumbersToLookup) {
                 SignalServiceAddress *address = [[SignalServiceAddress alloc] initWithPhoneNumber:phoneNumber];
                 if ([registeredPhoneNumbers containsObject:phoneNumber]) {
@@ -117,7 +117,7 @@ - (void)contactIntersectionWithSet:(NSSet<NSString *> *)phoneNumbersToLookup
                     [SignalRecipient markRecipientAsUnregistered:address transaction:transaction];
                 }
             }
-        }];
+        });
 
         dispatch_async(dispatch_get_main_queue(), ^{
             success([registeredRecipients copy]);
diff --git a/SignalServiceKit/src/Contacts/Threads/TSContactThread.m b/SignalServiceKit/src/Contacts/Threads/TSContactThread.m
index 165a2a12e5c..5a5dea801a3 100644
--- a/SignalServiceKit/src/Contacts/Threads/TSContactThread.m
+++ b/SignalServiceKit/src/Contacts/Threads/TSContactThread.m
@@ -137,9 +137,9 @@ + (instancetype)getOrCreateThreadWithContactAddress:(SignalServiceAddress *)cont
     OWSAssertDebug(contactAddress.isValid);
 
     __block TSContactThread *thread;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         thread = [self getOrCreateThreadWithContactAddress:contactAddress transaction:transaction];
-    }];
+    });
 
     return thread;
 }
diff --git a/SignalServiceKit/src/Devices/OWSDevice.m b/SignalServiceKit/src/Devices/OWSDevice.m
index a83f18b9136..5b79f123da3 100644
--- a/SignalServiceKit/src/Devices/OWSDevice.m
+++ b/SignalServiceKit/src/Devices/OWSDevice.m
@@ -78,17 +78,17 @@ - (BOOL)mayHaveLinkedDevicesWithTransaction:(SDSAnyReadTransaction *)transaction
 - (void)clearMayHaveLinkedDevices
 {
     // Note that we write async to avoid opening transactions within transactions.
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [OWSDeviceManager.keyValueStore setBool:NO key:kMayHaveLinkedDevicesKey transaction:transaction];
-    }];
+    });
 }
 
 - (void)setMayHaveLinkedDevices
 {
     // Note that we write async to avoid opening transactions within transactions.
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [OWSDeviceManager.keyValueStore setBool:YES key:kMayHaveLinkedDevicesKey transaction:transaction];
-    }];
+    });
 }
 
 - (BOOL)hasReceivedSyncMessageInLastSeconds:(NSTimeInterval)intervalSeconds
diff --git a/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m b/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m
index 42d63a7a6ef..50956e0057a 100644
--- a/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m
+++ b/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m
@@ -174,7 +174,7 @@ + (void)processIncomingSentMessageTranscript:(OWSIncomingSentMessageTranscript *
                 success:^(NSArray<TSAttachmentStream *> *attachmentStreams) {
                     OWSAssertDebug(attachmentStreams.count == 1);
                     TSAttachmentStream *attachmentStream = attachmentStreams.firstObject;
-                    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                         [outgoingMessage
                             anyUpdateOutgoingMessageWithTransaction:transaction
                                                               block:^(TSOutgoingMessage *outgoingMessage) {
@@ -182,7 +182,7 @@ + (void)processIncomingSentMessageTranscript:(OWSIncomingSentMessageTranscript *
                                                                       setQuotedMessageThumbnailAttachmentStream:
                                                                           attachmentStream];
                                                               }];
-                    }];
+                    });
                 }
                 failure:^(NSError *error) {
                     OWSLogWarn(
diff --git a/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.m b/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.m
index d7c25f485d2..64872d501b4 100644
--- a/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.m
+++ b/SignalServiceKit/src/Messages/Attachments/OWSAttachmentDownloads.m
@@ -416,7 +416,7 @@ - (void)enqueueJobsForAttachmentStreams:(NSArray<TSAttachmentStream *> *)attachm
                 && !message.isViewOnceMessage) {
                 OWSLogInfo(@"Not queueing visual media download for thread with pending message request");
 
-                [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     [attachmentPointer
                         anyUpdateAttachmentPointerWithTransaction:transaction
                                                             block:^(TSAttachmentPointer *pointer) {
@@ -425,7 +425,7 @@ - (void)enqueueJobsForAttachmentStreams:(NSArray<TSAttachmentStream *> *)attachm
                                                                         = TSAttachmentPointerStatePendingMessageRequest;
                                                                 }
                                                             }];
-                }];
+                });
 
                 continue;
             }
@@ -516,7 +516,7 @@ - (void)tryToStartNextDownload
         }
 
         __block TSAttachmentPointer *_Nullable attachmentPointer;
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             // Fetch latest to ensure we don't overwrite an attachment stream, resurrect an attachment, etc.
             attachmentPointer =
                 [TSAttachmentPointer anyFetchAttachmentPointerWithUniqueId:job.attachmentId transaction:transaction];
@@ -539,7 +539,7 @@ - (void)tryToStartNextDownload
             if (job.message != nil) {
                 [self reloadAndTouchLatestVersionOfMessage:job.message transaction:transaction];
             }
-        }];
+        });
 
         if (!attachmentPointer) {
             // Abort.
@@ -552,7 +552,7 @@ - (void)tryToStartNextDownload
             success:^(TSAttachmentStream *attachmentStream) {
                 OWSLogVerbose(@"Attachment download succeeded.");
 
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     TSAttachmentPointer *_Nullable existingAttachment =
                         [TSAttachmentPointer anyFetchAttachmentPointerWithUniqueId:attachmentStream.uniqueId
                                                                        transaction:transaction];
@@ -569,7 +569,7 @@ - (void)tryToStartNextDownload
                     if (job.message != nil) {
                         [self reloadAndTouchLatestVersionOfMessage:job.message transaction:transaction];
                     }
-                }];
+                });
 
                 job.success(attachmentStream);
 
@@ -582,7 +582,7 @@ - (void)tryToStartNextDownload
             failure:^(NSError *error) {
                 OWSLogError(@"Attachment download failed with error: %@", error);
 
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     // Fetch latest to ensure we don't overwrite an attachment stream, resurrect an attachment, etc.
                     TSAttachmentPointer *_Nullable attachmentPointer =
                         [TSAttachmentPointer anyFetchAttachmentPointerWithUniqueId:job.attachmentId
@@ -600,7 +600,7 @@ - (void)tryToStartNextDownload
                     if (job.message != nil) {
                         [self reloadAndTouchLatestVersionOfMessage:job.message transaction:transaction];
                     }
-                }];
+                });
 
                 @synchronized(self) {
                     [self.downloadingJobMap removeObjectForKey:job.attachmentId];
diff --git a/SignalServiceKit/src/Messages/Attachments/TSAttachmentStream.m b/SignalServiceKit/src/Messages/Attachments/TSAttachmentStream.m
index 38b4b7fe565..28edfd25824 100644
--- a/SignalServiceKit/src/Messages/Attachments/TSAttachmentStream.m
+++ b/SignalServiceKit/src/Messages/Attachments/TSAttachmentStream.m
@@ -713,7 +713,7 @@ - (void)applyChangeAsyncToLatestCopyWithChangeBlock:(void (^)(TSAttachmentStream
     OWSAssertDebug(changeBlock);
 
     dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             // We load a new instance before using anyUpdateWithTransaction()
             // since it isn't thread-safe to mutate the current instance async.
             TSAttachmentStream *_Nullable latestInstance =
@@ -731,7 +731,7 @@ - (void)applyChangeAsyncToLatestCopyWithChangeBlock:(void (^)(TSAttachmentStream
                                                                block:^(TSAttachmentStream *attachmentStream) {
                                                                    changeBlock(attachmentStream);
                                                                }];
-        }];
+        });
 
         if (completion != nil) {
             completion();
diff --git a/SignalServiceKit/src/Messages/InvalidKeyMessages/TSInvalidIdentityKeyReceivingErrorMessage.m b/SignalServiceKit/src/Messages/InvalidKeyMessages/TSInvalidIdentityKeyReceivingErrorMessage.m
index 8ae7583758c..ef00b7aaa45 100644
--- a/SignalServiceKit/src/Messages/InvalidKeyMessages/TSInvalidIdentityKeyReceivingErrorMessage.m
+++ b/SignalServiceKit/src/Messages/InvalidKeyMessages/TSInvalidIdentityKeyReceivingErrorMessage.m
@@ -187,9 +187,9 @@ - (void)throws_acceptNewIdentityKey
         // Here we remove the existing error message because handleReceivedEnvelope will either
         //  1.) succeed and create a new successful message in the thread or...
         //  2.) fail and create a new identical error message in the thread.
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [errorMessage anyRemoveWithTransaction:transaction];
-        }];
+        });
     }
 }
 
diff --git a/SignalServiceKit/src/Messages/OWSBatchMessageProcessor.m b/SignalServiceKit/src/Messages/OWSBatchMessageProcessor.m
index 77e517b5f9d..c14f349a281 100644
--- a/SignalServiceKit/src/Messages/OWSBatchMessageProcessor.m
+++ b/SignalServiceKit/src/Messages/OWSBatchMessageProcessor.m
@@ -289,13 +289,13 @@ - (void)drainQueueWorkStep
 
     __block NSArray<OWSMessageContentJob *> *processedJobs;
     __block NSUInteger jobCount;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         processedJobs = [self processJobs:batchJobs transaction:transaction];
         
         [self.finder removeJobsWithUniqueIds:processedJobs.uniqueIds transaction:transaction];
         
         jobCount = [self.finder jobCountWithTransaction:transaction];
-    }];
+    });
 
     OWSAssertDebug(backgroundTask);
     backgroundTask = nil;
diff --git a/SignalServiceKit/src/Messages/OWSBlockingManager.m b/SignalServiceKit/src/Messages/OWSBlockingManager.m
index 4ac70090847..7a3745bc42e 100644
--- a/SignalServiceKit/src/Messages/OWSBlockingManager.m
+++ b/SignalServiceKit/src/Messages/OWSBlockingManager.m
@@ -437,12 +437,12 @@ - (void)addBlockedGroup:(TSGroupModel *)groupModel wasLocallyInitiated:(BOOL)was
 
     // Open a sneaky transaction and quit the group if we're a member
     if ([groupModel.groupMembers containsObject:TSAccountManager.localAddress]) {
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             TSGroupThread *groupThread = [TSGroupThread fetchWithGroupId:groupId transaction:transaction];
             [GroupManager leaveGroupOrDeclineInviteAsyncWithoutUIWithGroupThread:groupThread
                                                                      transaction:transaction
                                                                          success:nil];
-        }];
+        });
     }
 
     [self handleUpdateWithSneakyTransactionAndSendSyncMessage:wasLocallyInitiated];
@@ -568,9 +568,9 @@ - (void)addBlockedThread:(TSThread *)thread wasLocallyInitiated:(BOOL)wasLocally
     if ([self isThreadBlocked:thread]) {
         return;
     }
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self addBlockedThread:thread wasLocallyInitiated:wasLocallyInitiated transaction:transaction];
-    }];
+    });
 }
 
 - (void)removeBlockedThread:(TSThread *)thread
@@ -597,9 +597,9 @@ - (void)removeBlockedThread:(TSThread *)thread wasLocallyInitiated:(BOOL)wasLoca
     if (![self isThreadBlocked:thread]) {
         return;
     }
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self removeBlockedThread:thread wasLocallyInitiated:wasLocallyInitiated transaction:transaction];
-    }];
+    });
 }
 
 #pragma mark - Updates
@@ -608,9 +608,9 @@ - (void)removeBlockedThread:(TSThread *)thread wasLocallyInitiated:(BOOL)wasLoca
 
 - (void)handleUpdateWithSneakyTransactionAndSendSyncMessage:(BOOL)sendSyncMessage
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self handleUpdateAndSendSyncMessage:sendSyncMessage transaction:transaction];
-    }];
+    });
 }
 
 - (void)handleUpdateAndSendSyncMessage:(BOOL)sendSyncMessage transaction:(SDSAnyWriteTransaction *)transaction
@@ -767,9 +767,9 @@ - (void)sendBlockListSyncMessageWithPhoneNumbers:(NSArray<NSString *> *)blockedP
     OWSAssertDebug(blockedGroupIds);
 
     __block TSThread *_Nullable thread;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         thread = [TSAccountManager getOrCreateLocalThreadWithTransaction:transaction];
-    }];
+    });
     if (thread == nil) {
         OWSFailDebug(@"Missing thread.");
         return;
@@ -802,7 +802,7 @@ - (void)saveSyncedBlockListWithPhoneNumbers:(NSArray<NSString *> *)blockedPhoneN
     OWSAssertDebug(blockedUUIDs);
     OWSAssertDebug(blockedGroupIds);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [OWSBlockingManager.keyValueStore setObject:blockedPhoneNumbers
                                                 key:kOWSBlockingManager_SyncedBlockedPhoneNumbersKey
                                         transaction:transaction];
@@ -812,7 +812,7 @@ - (void)saveSyncedBlockListWithPhoneNumbers:(NSArray<NSString *> *)blockedPhoneN
         [OWSBlockingManager.keyValueStore setObject:blockedGroupIds
                                                 key:kOWSBlockingManager_SyncedBlockedGroupIdsKey
                                         transaction:transaction];
-    }];
+    });
 }
 
 #pragma mark - Notifications
diff --git a/SignalServiceKit/src/Messages/OWSDisappearingMessagesJob.m b/SignalServiceKit/src/Messages/OWSDisappearingMessagesJob.m
index 7220b9144cc..1e98f8b4f0b 100644
--- a/SignalServiceKit/src/Messages/OWSDisappearingMessagesJob.m
+++ b/SignalServiceKit/src/Messages/OWSDisappearingMessagesJob.m
@@ -123,7 +123,7 @@ - (NSUInteger)deleteExpiredMessages
     OWSBackgroundTask *_Nullable backgroundTask = [OWSBackgroundTask backgroundTaskWithLabelStr:__PRETTY_FUNCTION__];
 
     __block NSUInteger expirationCount = 0;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.disappearingMessagesFinder enumerateExpiredMessagesWithBlock:^(TSMessage *message) {
             // We want to compute `now` *after* our finder fetches results.
             // Otherwise, if we computed it before the finder, and a message had expired in the tiny
@@ -142,7 +142,7 @@ - (NSUInteger)deleteExpiredMessages
             expirationCount++;
         }
                                                                transaction:transaction];
-    }];
+    });
 
     OWSLogDebug(@"Removed %lu expired messages", (unsigned long)expirationCount);
 
@@ -215,9 +215,9 @@ - (void)startIfNecessary
         dispatch_async(OWSDisappearingMessagesJob.serialQueue, ^{
             // Theoretically this shouldn't be necessary, but there was a race condition when receiving a backlog
             // of messages across timer changes which could cause a disappearing message's timer to never be started.
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 [self cleanupMessagesWhichFailedToStartExpiringWithTransaction:transaction];
-            }];
+            });
 
             [self runLoop];
         });
diff --git a/SignalServiceKit/src/Messages/OWSFailedAttachmentDownloadsJob.m b/SignalServiceKit/src/Messages/OWSFailedAttachmentDownloadsJob.m
index 57119ee4623..02b86093755 100644
--- a/SignalServiceKit/src/Messages/OWSFailedAttachmentDownloadsJob.m
+++ b/SignalServiceKit/src/Messages/OWSFailedAttachmentDownloadsJob.m
@@ -67,8 +67,8 @@ - (void)enumerateAttemptingOutAttachmentsWithBlock:(void (^_Nonnull)(TSAttachmen
 - (void)runSync
 {
     __block uint count = 0;
-    [self.databaseStorage
-        writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(
+        self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [self enumerateAttemptingOutAttachmentsWithBlock:^(TSAttachmentPointer *attachment) {
                 // sanity check
                 if (attachment.state == TSAttachmentPointerStateFailed) {
@@ -98,7 +98,7 @@ - (void)runSync
 
             }
                                                  transaction:transaction];
-        }];
+        });
 
     if (count > 0) {
         OWSLogDebug(@"Marked %u attachments as failed", count);
diff --git a/SignalServiceKit/src/Messages/OWSFailedMessagesJob.m b/SignalServiceKit/src/Messages/OWSFailedMessagesJob.m
index 7bccccedec4..761bbd5247c 100644
--- a/SignalServiceKit/src/Messages/OWSFailedMessagesJob.m
+++ b/SignalServiceKit/src/Messages/OWSFailedMessagesJob.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSFailedMessagesJob.h"
@@ -74,8 +74,8 @@ - (void)runSync
 {
     __block uint count = 0;
 
-    [self.databaseStorage
-        writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(
+        self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [self enumerateAttemptingOutMessagesWithBlock:^(TSOutgoingMessage *message) {
                 // sanity check
                 OWSAssertDebug(message.messageState == TSOutgoingMessageStateSending);
@@ -91,7 +91,7 @@ - (void)runSync
                 count++;
             }
                                               transaction:transaction];
-        }];
+        });
 
     OWSLogDebug(@"Marked %u messages as unsent", count);
 }
diff --git a/SignalServiceKit/src/Messages/OWSIdentityManager.m b/SignalServiceKit/src/Messages/OWSIdentityManager.m
index 75b0e406cc6..9de173bb43d 100644
--- a/SignalServiceKit/src/Messages/OWSIdentityManager.m
+++ b/SignalServiceKit/src/Messages/OWSIdentityManager.m
@@ -131,9 +131,9 @@ - (void)observeNotifications
 
 - (void)generateNewIdentityKey
 {
-    [self.databaseQueue writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseQueue, ^(SDSAnyWriteTransaction *transaction) {
         [self storeIdentityKeyPair:[Curve25519 generateKeyPair] transaction:transaction];
-    }];
+    });
 }
 
 - (void)storeIdentityKeyPair:(ECKeyPair *)keyPair transaction:(SDSAnyWriteTransaction *)transaction
@@ -213,9 +213,9 @@ - (BOOL)saveRemoteIdentity:(NSData *)identityKey address:(SignalServiceAddress *
     OWSAssertDebug(address.isValid);
 
     __block BOOL result;
-    [self.databaseQueue writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseQueue, ^(SDSAnyWriteTransaction *transaction) {
         result = [self saveRemoteIdentity:identityKey address:address transaction:transaction];
-    }];
+    });
 
     return result;
 }
@@ -307,13 +307,13 @@ - (void)setVerificationState:(OWSVerificationState)verificationState
     OWSAssertDebug(identityKey.length == kStoredIdentityKeyLength);
     OWSAssertDebug(address.isValid);
 
-    [self.databaseQueue writeWithBlock:^(SDSAnyWriteTransaction *_Nonnull transaction) {
+    DatabaseStorageWrite(self.databaseQueue, ^(SDSAnyWriteTransaction *_Nonnull transaction) {
         [self setVerificationState:verificationState
                        identityKey:identityKey
                            address:address
              isUserInitiatedChange:isUserInitiatedChange
                        transaction:transaction];
-    }];
+    });
 }
 
 - (void)setVerificationState:(OWSVerificationState)verificationState
@@ -730,10 +730,10 @@ - (void)sendSyncVerificationStateMessage:(OWSVerificationStateSyncMessage *)mess
                     OWSLogInfo(@"Successfully sent verification state sync message");
 
                     // Record that this verification state was successfully synced.
-                    [self.databaseQueue writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseQueue, ^(SDSAnyWriteTransaction *transaction) {
                         [self clearSyncMessageForAddress:message.verificationForRecipientAddress
                                              transaction:transaction];
-                    }];
+                    });
                 }
                 failure:^(NSError *error) {
                     OWSLogError(@"Failed to send verification state sync message with error: %@", error);
@@ -745,9 +745,9 @@ - (void)sendSyncVerificationStateMessage:(OWSVerificationStateSyncMessage *)mess
                 OWSLogInfo(@"Removing retries for syncing verification state, since user is no longer registered: %@",
                     message.verificationForRecipientAddress);
                 // Otherwise this will fail forever.
-                [self.databaseQueue writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseQueue, ^(SDSAnyWriteTransaction *transaction) {
                     [self clearSyncMessageForAddress:message.verificationForRecipientAddress transaction:transaction];
-                }];
+                });
             }
         }];
 }
diff --git a/SignalServiceKit/src/Messages/OWSIncompleteCallsJob.m b/SignalServiceKit/src/Messages/OWSIncompleteCallsJob.m
index 2338beee34b..f666e453b75 100644
--- a/SignalServiceKit/src/Messages/OWSIncompleteCallsJob.m
+++ b/SignalServiceKit/src/Messages/OWSIncompleteCallsJob.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSIncompleteCallsJob.h"
@@ -82,7 +82,7 @@ - (void)runSync
     OWSAssertDebug(CurrentAppContext().appLaunchTime);
     uint64_t cutoffTimestamp = [NSDate ows_millisecondsSince1970ForDate:CurrentAppContext().appLaunchTime];
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self
             enumerateIncompleteCallsWithBlock:^(TSCall *call) {
                 if (call.timestamp > cutoffTimestamp) {
@@ -105,7 +105,7 @@ - (void)runSync
                 count++;
             }
                                   transaction:transaction];
-    }];
+    });
 
     OWSLogInfo(@"Marked %u calls as missed", count);
 }
diff --git a/SignalServiceKit/src/Messages/OWSMessageDecrypter.m b/SignalServiceKit/src/Messages/OWSMessageDecrypter.m
index a2b02bed5fa..ca7db50609e 100644
--- a/SignalServiceKit/src/Messages/OWSMessageDecrypter.m
+++ b/SignalServiceKit/src/Messages/OWSMessageDecrypter.m
@@ -273,7 +273,7 @@ - (void)decryptEnvelope:(SSKProtoEnvelope *)envelope
             case SSKProtoEnvelopeTypeReceipt:
             case SSKProtoEnvelopeTypeKeyExchange:
             case SSKProtoEnvelopeTypeUnknown: {
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     OWSMessageDecryptResult *result =
                         [OWSMessageDecryptResult resultWithEnvelopeData:envelopeData
                                                           plaintextData:nil
@@ -281,7 +281,7 @@ - (void)decryptEnvelope:(SSKProtoEnvelope *)envelope
                                                            sourceDevice:envelope.sourceDevice
                                                             isUDMessage:NO];
                     successBlock(result, transaction);
-                }];
+                });
                 // Return to avoid double-acknowledging.
                 return;
             }
@@ -313,11 +313,11 @@ - (void)decryptEnvelope:(SSKProtoEnvelope *)envelope
         OWSFailDebug(@"Received an invalid envelope: %@", exception.debugDescription);
         OWSProdFail([OWSAnalyticsEvents messageManagerErrorInvalidProtocolMessage]);
 
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             ThreadlessErrorMessage *errorMessage = [ThreadlessErrorMessage corruptedMessageInUnknownThread];
             [SSKEnvironment.shared.notificationsManager notifyUserForThreadlessErrorMessage:errorMessage
                                                                                 transaction:transaction];
-        }];
+        });
     }
 
     failureBlock();
@@ -390,8 +390,8 @@ - (void)decryptEnvelope:(SSKProtoEnvelope *)envelope
         return failureBlock(error);
     }
 
-    [self.databaseStorage
-        asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(
+        SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
             NSString *accountIdentifier = [[OWSAccountIdFinder new] ensureAccountIdForAddress:envelope.sourceAddress
                                                                                   transaction:transaction];
             @try {
@@ -422,7 +422,7 @@ - (void)decryptEnvelope:(SSKProtoEnvelope *)envelope
                     failureBlock(error);
                 });
             }
-        }];
+        });
 }
 
 - (void)decryptUnidentifiedSender:(SSKProtoEnvelope *)envelope
@@ -465,157 +465,175 @@ - (void)decryptUnidentifiedSender:(SSKProtoEnvelope *)envelope
     SignalServiceAddress *localAddress = self.tsAccountManager.localAddress;
     uint32_t localDeviceId = self.tsAccountManager.storedDeviceId;
 
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
-        NSError *cipherError;
-        SMKSecretSessionCipher *_Nullable cipher =
-            [[SMKSecretSessionCipher alloc] initWithSessionStore:self.sessionStore
-                                                     preKeyStore:self.preKeyStore
-                                               signedPreKeyStore:self.signedPreKeyStore
-                                                   identityStore:self.identityManager
-                                                           error:&cipherError];
-        if (cipherError || !cipher) {
-            OWSFailDebug(@"Could not create secret session cipher: %@", cipherError);
-            cipherError = EnsureDecryptError(cipherError, @"Could not create secret session cipher");
-            return failureBlock(cipherError);
-        }
-
-        NSError *decryptError;
-        SMKDecryptResult *_Nullable decryptResult =
-            [cipher throwswrapped_decryptMessageWithCertificateValidator:certificateValidator
-                                                          cipherTextData:encryptedData
-                                                               timestamp:serverTimestamp
-                                                               localE164:localAddress.phoneNumber
-                                                               localUuid:localAddress.uuid
-                                                           localDeviceId:localDeviceId
-                                                         protocolContext:transaction
-                                                                   error:&decryptError];
-
-        if (!decryptResult) {
-            if (!decryptError) {
-                OWSFailDebug(@"Caller should provide specific error");
-                NSError *error = OWSErrorWithCodeDescription(
-                    OWSErrorCodeFailedToDecryptUDMessage, @"Could not decrypt UD message");
-                return failureBlock(error);
-            }
-
-            // Decrypt Failure Part 1: Unwrap failure details
-
-            NSError *_Nullable underlyingError;
-            SSKProtoEnvelope *_Nullable identifiedEnvelope;
-
-            if (![decryptError.domain isEqualToString:@"SignalMetadataKit.SecretSessionKnownSenderError"]) {
-                underlyingError = decryptError;
-                identifiedEnvelope = envelope;
-            } else {
-                underlyingError = decryptError.userInfo[NSUnderlyingErrorKey];
-
-                NSString *_Nullable senderE164 = decryptError.userInfo[SecretSessionKnownSenderError.kSenderE164Key];
-                NSUUID *_Nullable senderUuid = decryptError.userInfo[SecretSessionKnownSenderError.kSenderUuidKey];
-                SignalServiceAddress *senderAddress = [[SignalServiceAddress alloc] initWithUuid:senderUuid
-                                                                                     phoneNumber:senderE164];
-                OWSAssert(senderAddress.isValid);
-
-                NSNumber *senderDeviceId = decryptError.userInfo[SecretSessionKnownSenderError.kSenderDeviceIdKey];
-                OWSAssert(senderDeviceId);
-
-                SSKProtoEnvelopeBuilder *identifiedEnvelopeBuilder = envelope.asBuilder;
-                identifiedEnvelopeBuilder.sourceE164 = senderAddress.phoneNumber;
-                identifiedEnvelopeBuilder.sourceUuid = senderAddress.uuidString;
-                identifiedEnvelopeBuilder.sourceDevice = senderDeviceId.unsignedIntValue;
-                NSError *identifiedEnvelopeBuilderError;
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
+        [self decryptUnidentifiedSender:envelope
+                          encryptedData:encryptedData
+                   certificateValidator:certificateValidator
+                           localAddress:localAddress
+                          localDeviceId:localDeviceId
+                        serverTimestamp:serverTimestamp
+                            transaction:transaction
+                           successBlock:successBlock
+                           failureBlock:failureBlock];
+    });
+}
 
-                identifiedEnvelope = [identifiedEnvelopeBuilder buildAndReturnError:&identifiedEnvelopeBuilderError];
-                if (identifiedEnvelopeBuilderError) {
-                    OWSFailDebug(@"failure identifiedEnvelopeBuilderError: %@", identifiedEnvelopeBuilderError);
-                }
-            }
-            OWSAssert(underlyingError);
-            OWSAssert(identifiedEnvelope);
+- (void)decryptUnidentifiedSender:(SSKProtoEnvelope *)envelope
+                    encryptedData:(NSData *)encryptedData
+             certificateValidator:(id<SMKCertificateValidator>)certificateValidator
+                     localAddress:(SignalServiceAddress *)localAddress
+                    localDeviceId:(uint32_t)localDeviceId
+                  serverTimestamp:(UInt64)serverTimestamp
+                      transaction:(SDSAnyWriteTransaction *)transaction
+                     successBlock:(DecryptSuccessBlock)successBlock
+                     failureBlock:(void (^)(NSError *_Nullable error))failureBlock
+{
+    NSError *cipherError;
+    SMKSecretSessionCipher *_Nullable cipher =
+        [[SMKSecretSessionCipher alloc] initWithSessionStore:self.sessionStore
+                                                 preKeyStore:self.preKeyStore
+                                           signedPreKeyStore:self.signedPreKeyStore
+                                               identityStore:self.identityManager
+                                                       error:&cipherError];
+    if (cipherError || !cipher) {
+        OWSFailDebug(@"Could not create secret session cipher: %@", cipherError);
+        cipherError = EnsureDecryptError(cipherError, @"Could not create secret session cipher");
+        return failureBlock(cipherError);
+    }
 
-            NSException *_Nullable underlyingException;
-            if ([underlyingError.domain isEqualToString:SCKExceptionWrapperErrorDomain]
-                && underlyingError.code == SCKExceptionWrapperErrorThrown) {
+    NSError *decryptError;
+    SMKDecryptResult *_Nullable decryptResult =
+        [cipher throwswrapped_decryptMessageWithCertificateValidator:certificateValidator
+                                                      cipherTextData:encryptedData
+                                                           timestamp:serverTimestamp
+                                                           localE164:localAddress.phoneNumber
+                                                           localUuid:localAddress.uuid
+                                                       localDeviceId:localDeviceId
+                                                     protocolContext:transaction
+                                                               error:&decryptError];
+
+    if (!decryptResult) {
+        if (!decryptError) {
+            OWSFailDebug(@"Caller should provide specific error");
+            NSError *error
+                = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptUDMessage, @"Could not decrypt UD message");
+            return failureBlock(error);
+        }
 
-                underlyingException = underlyingError.userInfo[SCKExceptionWrapperUnderlyingExceptionKey];
-                OWSAssert(underlyingException);
-            }
+        // Decrypt Failure Part 1: Unwrap failure details
 
-            // Decrypt Failure Part 2: Handle unwrapped failure details
+        NSError *_Nullable underlyingError;
+        SSKProtoEnvelope *_Nullable identifiedEnvelope;
 
-            if (underlyingException) {
-                dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
-                    [self processException:underlyingException envelope:identifiedEnvelope];
-                    NSString *errorDescription = [NSString
-                        stringWithFormat:@"Exception while decrypting ud message: %@", underlyingException.description];
-                    NSError *error;
-                    if ([underlyingException.name isEqualToString:DuplicateMessageException]) {
-                        OWSLogInfo(@"%@", errorDescription);
-                        error = OWSErrorWithCodeDescription(
-                            OWSErrorCodeFailedToDecryptDuplicateMessage, errorDescription);
-                    } else {
-                        OWSLogError(@"%@", errorDescription);
-                        error = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptMessage, errorDescription);
-                    }
-                    failureBlock(error);
-                });
-                return;
+        if (![decryptError.domain isEqualToString:@"SignalMetadataKit.SecretSessionKnownSenderError"]) {
+            underlyingError = decryptError;
+            identifiedEnvelope = envelope;
+        } else {
+            underlyingError = decryptError.userInfo[NSUnderlyingErrorKey];
+
+            NSString *_Nullable senderE164 = decryptError.userInfo[SecretSessionKnownSenderError.kSenderE164Key];
+            NSUUID *_Nullable senderUuid = decryptError.userInfo[SecretSessionKnownSenderError.kSenderUuidKey];
+            SignalServiceAddress *senderAddress = [[SignalServiceAddress alloc] initWithUuid:senderUuid
+                                                                                 phoneNumber:senderE164];
+            OWSAssert(senderAddress.isValid);
+
+            NSNumber *senderDeviceId = decryptError.userInfo[SecretSessionKnownSenderError.kSenderDeviceIdKey];
+            OWSAssert(senderDeviceId);
+
+            SSKProtoEnvelopeBuilder *identifiedEnvelopeBuilder = envelope.asBuilder;
+            identifiedEnvelopeBuilder.sourceE164 = senderAddress.phoneNumber;
+            identifiedEnvelopeBuilder.sourceUuid = senderAddress.uuidString;
+            identifiedEnvelopeBuilder.sourceDevice = senderDeviceId.unsignedIntValue;
+            NSError *identifiedEnvelopeBuilderError;
+
+            identifiedEnvelope = [identifiedEnvelopeBuilder buildAndReturnError:&identifiedEnvelopeBuilderError];
+            if (identifiedEnvelopeBuilderError) {
+                OWSFailDebug(@"failure identifiedEnvelopeBuilderError: %@", identifiedEnvelopeBuilderError);
             }
+        }
+        OWSAssert(underlyingError);
+        OWSAssert(identifiedEnvelope);
+
+        NSException *_Nullable underlyingException;
+        if ([underlyingError.domain isEqualToString:SCKExceptionWrapperErrorDomain]
+            && underlyingError.code == SCKExceptionWrapperErrorThrown) {
+            underlyingException = underlyingError.userInfo[SCKExceptionWrapperUnderlyingExceptionKey];
+            OWSAssert(underlyingException);
+        }
 
-            if ([underlyingError.domain isEqualToString:@"SignalMetadataKit.SMKSecretSessionCipherError"]
-                && underlyingError.code == SMKSecretSessionCipherErrorSelfSentMessage) {
-                // Self-sent messages can be safely discarded.
-                failureBlock(underlyingError);
-                return;
-            }
+        // Decrypt Failure Part 2: Handle unwrapped failure details
+
+        if (underlyingException) {
+            dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
+                [self processException:underlyingException envelope:identifiedEnvelope];
+                NSString *errorDescription = [NSString
+                    stringWithFormat:@"Exception while decrypting ud message: %@", underlyingException.description];
+                NSError *error;
+                if ([underlyingException.name isEqualToString:DuplicateMessageException]) {
+                    OWSLogInfo(@"%@", errorDescription);
+                    error = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptDuplicateMessage, errorDescription);
+                } else {
+                    OWSLogError(@"%@", errorDescription);
+                    error = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptMessage, errorDescription);
+                }
+                failureBlock(error);
+            });
+            return;
+        }
 
-            OWSFailDebug(@"Could not decrypt UD message: %@", underlyingError);
+        if ([underlyingError.domain isEqualToString:@"SignalMetadataKit.SMKSecretSessionCipherError"]
+            && underlyingError.code == SMKSecretSessionCipherErrorSelfSentMessage) {
+            // Self-sent messages can be safely discarded.
             failureBlock(underlyingError);
             return;
         }
 
-        if (decryptResult.messageType == SMKMessageTypePrekey) {
-            [TSPreKeyManager checkPreKeys];
-        }
+        OWSFailDebug(@"Could not decrypt UD message: %@", underlyingError);
+        failureBlock(underlyingError);
+        return;
+    }
 
-        NSString *_Nullable senderE164 = decryptResult.senderE164;
-        NSUUID *_Nullable senderUuid = decryptResult.senderUuid;
-        SignalServiceAddress *sourceAddress = [[SignalServiceAddress alloc] initWithUuid:senderUuid
-                                                                             phoneNumber:senderE164];
-        if (!sourceAddress.isValid) {
-            NSString *errorDescription = [NSString stringWithFormat:@"Invalid UD sender: %@", sourceAddress];
-            OWSFailDebug(@"%@", errorDescription);
-            NSError *error = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptUDMessage, errorDescription);
-            return failureBlock(error);
-        }
+    if (decryptResult.messageType == SMKMessageTypePrekey) {
+        [TSPreKeyManager checkPreKeys];
+    }
 
-        long sourceDeviceId = decryptResult.senderDeviceId;
-        if (sourceDeviceId < 1 || sourceDeviceId > UINT32_MAX) {
-            NSString *errorDescription = @"Invalid UD sender device id.";
-            OWSFailDebug(@"%@", errorDescription);
-            NSError *error = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptUDMessage, errorDescription);
-            return failureBlock(error);
-        }
-        NSData *plaintextData = [decryptResult.paddedPayload removePadding];
-
-        SSKProtoEnvelopeBuilder *envelopeBuilder = [envelope asBuilder];
-        [envelopeBuilder setSourceE164:sourceAddress.phoneNumber];
-        [envelopeBuilder setSourceUuid:sourceAddress.uuidString];
-        [envelopeBuilder setSourceDevice:(uint32_t)sourceDeviceId];
-        NSError *envelopeBuilderError;
-        NSData *_Nullable newEnvelopeData = [envelopeBuilder buildSerializedDataAndReturnError:&envelopeBuilderError];
-        if (envelopeBuilderError || !newEnvelopeData) {
-            OWSFailDebug(@"Could not update UD envelope data: %@", envelopeBuilderError);
-            NSError *error = EnsureDecryptError(envelopeBuilderError, @"Could not update UD envelope data");
-            return failureBlock(error);
-        }
+    NSString *_Nullable senderE164 = decryptResult.senderE164;
+    NSUUID *_Nullable senderUuid = decryptResult.senderUuid;
+    SignalServiceAddress *sourceAddress = [[SignalServiceAddress alloc] initWithUuid:senderUuid phoneNumber:senderE164];
+    if (!sourceAddress.isValid) {
+        NSString *errorDescription = [NSString stringWithFormat:@"Invalid UD sender: %@", sourceAddress];
+        OWSFailDebug(@"%@", errorDescription);
+        NSError *error = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptUDMessage, errorDescription);
+        return failureBlock(error);
+    }
+
+    long sourceDeviceId = decryptResult.senderDeviceId;
+    if (sourceDeviceId < 1 || sourceDeviceId > UINT32_MAX) {
+        NSString *errorDescription = @"Invalid UD sender device id.";
+        OWSFailDebug(@"%@", errorDescription);
+        NSError *error = OWSErrorWithCodeDescription(OWSErrorCodeFailedToDecryptUDMessage, errorDescription);
+        return failureBlock(error);
+    }
+    NSData *plaintextData = [decryptResult.paddedPayload removePadding];
+
+    SSKProtoEnvelopeBuilder *envelopeBuilder = [envelope asBuilder];
+    [envelopeBuilder setSourceE164:sourceAddress.phoneNumber];
+    [envelopeBuilder setSourceUuid:sourceAddress.uuidString];
+    [envelopeBuilder setSourceDevice:(uint32_t)sourceDeviceId];
+    NSError *envelopeBuilderError;
+    NSData *_Nullable newEnvelopeData = [envelopeBuilder buildSerializedDataAndReturnError:&envelopeBuilderError];
+    if (envelopeBuilderError || !newEnvelopeData) {
+        OWSFailDebug(@"Could not update UD envelope data: %@", envelopeBuilderError);
+        NSError *error = EnsureDecryptError(envelopeBuilderError, @"Could not update UD envelope data");
+        return failureBlock(error);
+    }
 
-        OWSMessageDecryptResult *result = [OWSMessageDecryptResult resultWithEnvelopeData:newEnvelopeData
-                                                                            plaintextData:plaintextData
-                                                                            sourceAddress:sourceAddress
-                                                                             sourceDevice:(UInt32)sourceDeviceId
-                                                                              isUDMessage:YES];
-        successBlock(result, transaction);
-    }];
+    OWSMessageDecryptResult *result = [OWSMessageDecryptResult resultWithEnvelopeData:newEnvelopeData
+                                                                        plaintextData:plaintextData
+                                                                        sourceAddress:sourceAddress
+                                                                         sourceDevice:(UInt32)sourceDeviceId
+                                                                          isUDMessage:YES];
+    successBlock(result, transaction);
 }
 
 - (void)processException:(NSException *)exception envelope:(SSKProtoEnvelope *)envelope
@@ -630,7 +648,7 @@ - (void)processException:(NSException *)exception envelope:(SSKProtoEnvelope *)e
         OWSLogError(@"%@", logString);
     }
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         TSErrorMessage *errorMessage;
 
         if (!envelope.sourceAddress.isValid) {
@@ -670,7 +688,7 @@ - (void)processException:(NSException *)exception envelope:(SSKProtoEnvelope *)e
             [errorMessage anyInsertWithTransaction:transaction];
             [self notifyUserForErrorMessage:errorMessage envelope:envelope transaction:transaction];
         }
-    }];
+    });
 }
 
 - (void)notifyUserForErrorMessage:(TSErrorMessage *)errorMessage
diff --git a/SignalServiceKit/src/Messages/OWSMessageManager.m b/SignalServiceKit/src/Messages/OWSMessageManager.m
index cfcc76f04fb..29295094293 100644
--- a/SignalServiceKit/src/Messages/OWSMessageManager.m
+++ b/SignalServiceKit/src/Messages/OWSMessageManager.m
@@ -1292,7 +1292,7 @@ - (void)handleReceivedGroupAvatarUpdateWithEnvelope:(SSKProtoEnvelope *)envelope
                 return;
             }
 
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 TSGroupThread *_Nullable oldGroupThread = [TSGroupThread fetchWithGroupId:groupId
                                                                               transaction:transaction];
                 if (oldGroupThread == nil) {
@@ -1313,14 +1313,14 @@ - (void)handleReceivedGroupAvatarUpdateWithEnvelope:(SSKProtoEnvelope *)envelope
 
                 // Eagerly clean up the attachment.
                 [attachmentStream anyRemoveWithTransaction:transaction];
-            }];
+            });
         }
         failure:^(NSError *error) {
             OWSLogError(@"failed to fetch attachments for group avatar sent at: %llu. with error: %@",
                 envelope.timestamp,
                 error);
 
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 // Eagerly clean up the attachment.
                 TSAttachment *_Nullable attachment = [TSAttachment anyFetchWithUniqueId:avatarPointer.uniqueId
                                                                             transaction:transaction];
@@ -1331,7 +1331,7 @@ - (void)handleReceivedGroupAvatarUpdateWithEnvelope:(SSKProtoEnvelope *)envelope
                     return;
                 }
                 [attachment anyRemoveWithTransaction:transaction];
-            }];
+            });
         }];
 }
 
@@ -2063,7 +2063,7 @@ - (TSIncomingMessage *_Nullable)handleReceivedEnvelope:(SSKProtoEnvelope *)envel
                     // This is expected if there is a pending message request.
                     return;
                 }
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     TSAttachmentStream *_Nullable attachmentStream = attachmentStreams.firstObject;
                     OWSAssertDebug(attachmentStream);
                     if (attachmentStream && incomingMessage.quotedMessage.thumbnailAttachmentPointerId.length > 0 &&
@@ -2080,7 +2080,7 @@ - (TSIncomingMessage *_Nullable)handleReceivedEnvelope:(SSKProtoEnvelope *)envel
                         // since the attachment might be a contact avatar, etc.
                         [self.databaseStorage touchInteraction:incomingMessage transaction:transaction];
                     }
-                }];
+                });
             }
             failure:^(NSError *error) {
                 OWSLogWarn(@"failed to download attachment for message: %llu with error: %@",
diff --git a/SignalServiceKit/src/Messages/OWSMessageReceiver.m b/SignalServiceKit/src/Messages/OWSMessageReceiver.m
index 1efe53d5eff..08ee8481fc2 100644
--- a/SignalServiceKit/src/Messages/OWSMessageReceiver.m
+++ b/SignalServiceKit/src/Messages/OWSMessageReceiver.m
@@ -149,9 +149,9 @@ - (OWSMessageDecryptJob *_Nullable)nextJob
 
 - (void)addJobForEnvelopeData:(NSData *)envelopeData
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self addJobForEnvelopeData:envelopeData transaction:transaction];
-    }];
+    });
 }
 
 - (void)addJobForEnvelopeData:(NSData *)envelopeData transaction:(SDSAnyWriteTransaction *)transaction
@@ -162,13 +162,13 @@ - (void)addJobForEnvelopeData:(NSData *)envelopeData transaction:(SDSAnyWriteTra
 
 - (void)removeJobWithId:(NSString *)uniqueId
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         OWSMessageDecryptJob *_Nullable job =
             [OWSMessageDecryptJob anyFetchWithUniqueId:uniqueId transaction:transaction];
         if (job) {
             [job anyRemoveWithTransaction:transaction];
         }
-    }];
+    });
 }
 
 - (NSUInteger)queuedJobCount
@@ -436,11 +436,11 @@ - (void)processJob:(OWSMessageDecryptJob *)job completion:(void (^)(BOOL))comple
         OWSFailDebug(@"Could not parse proto.");
         // TODO: Add analytics.
 
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             ThreadlessErrorMessage *errorMessage = [ThreadlessErrorMessage corruptedMessageInUnknownThread];
             [SSKEnvironment.shared.notificationsManager notifyUserForThreadlessErrorMessage:errorMessage
                                                                                 transaction:transaction];
-        }];
+        });
 
         dispatch_async(self.serialQueue, ^{
             completion(NO);
diff --git a/SignalServiceKit/src/Messages/OWSMessageSender.m b/SignalServiceKit/src/Messages/OWSMessageSender.m
index 9d3a35f5fc2..30198b435f5 100644
--- a/SignalServiceKit/src/Messages/OWSMessageSender.m
+++ b/SignalServiceKit/src/Messages/OWSMessageSender.m
@@ -441,7 +441,7 @@ - (void)sendMessage:(OutgoingMessagePreparer *)outgoingMessagePreparer
         // unorthodox.
         __block NSError *error;
         __block TSOutgoingMessage *message;
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             message = [outgoingMessagePreparer prepareMessageWithTransaction:transaction error:&error];
             if (error != nil) {
                 return;
@@ -452,7 +452,7 @@ - (void)sendMessage:(OutgoingMessagePreparer *)outgoingMessagePreparer
                 OWSAssertDebug([message.body lengthOfBytesUsingEncoding:NSUTF8StringEncoding]
                     <= kOversizeTextMessageSizeThreshold);
             }
-        }];
+        });
 
         if (error != nil) {
             dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
@@ -493,10 +493,10 @@ - (void)sendTemporaryAttachment:(id<DataSource>)dataSource
 
         OWSLogDebug(@"Removing successful temporary attachment message with attachment ids: %@", message.attachmentIds);
 
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [message anyRemoveWithTransaction:transaction];
             [message removeTemporaryAttachmentsWithTransaction:transaction];
-        }];
+        });
     };
 
     void (^failureWithDeleteHandler)(NSError *error) = ^(NSError *error) {
@@ -504,10 +504,10 @@ - (void)sendTemporaryAttachment:(id<DataSource>)dataSource
 
         OWSLogDebug(@"Removing failed temporary attachment message with attachment ids: %@", message.attachmentIds);
 
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [message anyRemoveWithTransaction:transaction];
             [message removeTemporaryAttachmentsWithTransaction:transaction];
-        }];
+        });
     };
 
     [self sendAttachment:dataSource
@@ -682,12 +682,12 @@ - (AnyPromise *)sendPromiseForRecipients:(NSArray<SignalRecipient *> *)recipient
         AnyPromise *sendPromise = [AnyPromise promiseWithResolverBlock:^(PMKResolver resolve) {
             __block OWSUDSendingAccess *_Nullable udSendingAccess;
             if (senderCertificate != nil && !recipient.address.isLocalAddress) {
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     udSendingAccess = [self.udManager udSendingAccessForAddress:recipient.address
                                                               requireSyncAccess:YES
                                                               senderCertificate:senderCertificate
                                                                     transaction:transaction];
-                }];
+                });
             }
 
             OWSMessageSend *messageSend = [[OWSMessageSend alloc] initWithMessage:message
@@ -814,12 +814,12 @@ - (void)sendMessageToService:(TSOutgoingMessage *)message
         [NSMutableSet setWithArray:message.sendingRecipientAddresses];
     [obsoleteRecipientAddresses minusSet:[NSSet setWithArray:recipientAddresses]];
     if (obsoleteRecipientAddresses.count > 0) {
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             for (SignalServiceAddress *obsoleteAddress in obsoleteRecipientAddresses) {
                 // Mark this recipient as "skipped".
                 [message updateWithSkippedRecipient:obsoleteAddress transaction:transaction];
             }
-        }];
+        });
     }
 
     if (recipientAddresses.count < 1) {
@@ -900,9 +900,9 @@ - (void)sendMessageToService:(TSOutgoingMessage *)message
 - (nullable TSThread *)threadForMessageWithSneakyTransaction:(TSMessage *)message
 {
     __block TSThread *_Nullable thread = nil;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         thread = [self threadForMessage:message transaction:transaction];
-    }];
+    });
     return thread;
 }
 
@@ -929,7 +929,7 @@ - (void)unregisteredRecipient:(SignalRecipient *)recipient
                       message:(TSOutgoingMessage *)message
                        thread:(TSThread *)thread
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         if (thread.isGroupThread) {
             // Mark as "skipped" group members who no longer have signal accounts.
             [message updateWithSkippedRecipient:recipient.address transaction:transaction];
@@ -947,7 +947,7 @@ - (void)unregisteredRecipient:(SignalRecipient *)recipient
         // TODO: Should we deleteAllSessionsForContact here?
         //       If so, we'll need to avoid doing a prekey fetch every
         //       time we try to send a message to an unregistered user.
-    }];
+    });
 }
 
 - (nullable NSArray<NSDictionary *> *)deviceMessagesForMessageSend:(OWSMessageSend *)messageSend
@@ -1171,9 +1171,9 @@ - (void)sendMessageToRecipient:(OWSMessageSend *)messageSend
 
             dispatch_async([OWSDispatch sendingQueue], ^{
                 // This emulates the completion logic of an actual successful send (see below).
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     [message updateWithSkippedRecipient:messageSend.localAddress transaction:transaction];
-                }];
+                });
                 messageSend.success();
             });
 
@@ -1315,7 +1315,7 @@ - (void)messageSendDidSucceed:(OWSMessageSend *)messageSend
     }
 
     dispatch_async([OWSDispatch sendingQueue], ^{
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [messageSend.message updateWithSentRecipient:messageSend.recipient.address
                                              wasSentByUD:wasSentByUD
                                              transaction:transaction];
@@ -1323,7 +1323,7 @@ - (void)messageSendDidSucceed:(OWSMessageSend *)messageSend
             // If we've just delivered a message to a user, we know they
             // have a valid Signal account.
             [SignalRecipient markRecipientAsRegisteredAndGet:recipient.address transaction:transaction];
-        }];
+        });
 
         messageSend.success();
     });
@@ -1476,8 +1476,8 @@ - (void)handleMismatchedDevicesWithResponseJson:(NSDictionary *)responseJson
         }
     }
 
-    [self.databaseStorage
-        writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(
+        SDSDatabaseStorage.shared, ^(SDSAnyWriteTransaction *transaction) {
             if (extraDevices.count < 1 && missingDevices.count < 1) {
                 OWSProdFail([OWSAnalyticsEvents messageSenderErrorNoMissingOrExtraDevices]);
             }
@@ -1498,7 +1498,7 @@ - (void)handleMismatchedDevicesWithResponseJson:(NSDictionary *)responseJson
             dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
                 completionHandler();
             });
-        }];
+        });
 }
 
 - (void)handleMessageSentLocally:(TSOutgoingMessage *)message
@@ -1519,19 +1519,19 @@ - (void)handleMessageSentLocally:(TSOutgoingMessage *)message
         if (contactThread && contactThread.contactAddress.isLocalAddress && !isSyncMessage) {
             OWSAssertDebug(message.recipientAddresses.count == 1);
             // Don't mark self-sent messages as read (or sent) until the sync transcript is sent.
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 for (SignalServiceAddress *sendingAddress in message.sendingRecipientAddresses) {
                     [message updateWithReadRecipient:sendingAddress
                                        readTimestamp:message.timestamp
                                          transaction:transaction];
                 }
-            }];
+            });
         }
 
         successParam();
     };
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         if (!message.shouldBeSaved) {
             // We don't need to do this work for transient messages.
             return;
@@ -1544,7 +1544,7 @@ - (void)handleMessageSentLocally:(TSOutgoingMessage *)message
         }
         TSOutgoingMessage *latestMessage = (TSOutgoingMessage *)latestCopy;
         [ViewOnceMessages completeIfNecessaryWithMessage:latestMessage transaction:transaction];
-    }];
+    });
 
     if (!message.shouldSyncTranscript) {
         return success();
@@ -1559,9 +1559,9 @@ - (void)handleMessageSentLocally:(TSOutgoingMessage *)message
     [self sendSyncTranscriptForMessage:message
                      isRecipientUpdate:isRecipientUpdate
                                success:^{
-                                   [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                   DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                        [message updateWithHasSyncedTranscript:YES transaction:transaction];
-                                   }];
+                                   });
 
                                    success();
                                }
@@ -1579,13 +1579,13 @@ - (void)sendSyncTranscriptForMessage:(TSOutgoingMessage *)message
     __block TSThread *_Nullable localThread;
     __block TSThread *_Nullable messageThread;
     __block SignalRecipient *recipient;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         localThread = [TSAccountManager getOrCreateLocalThreadWithTransaction:transaction];
 
         messageThread = [self threadForMessage:message transaction:transaction];
 
         recipient = [SignalRecipient markRecipientAsRegisteredAndGet:localAddress transaction:transaction];
-    }];
+    });
     if (localThread == nil) {
         OWSFailDebug(@"Missing local thread.");
         return;
@@ -1662,7 +1662,7 @@ - (void)sendSyncTranscriptForMessage:(TSOutgoingMessage *)message
 
             __block NSDictionary *_Nullable messageDict;
             __block NSException *encryptionException;
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 @try {
                     messageDict = [self throws_encryptedMessageForMessageSend:messageSend
                                                                      deviceId:deviceId
@@ -1671,7 +1671,7 @@ - (void)sendSyncTranscriptForMessage:(TSOutgoingMessage *)message
                 } @catch (NSException *exception) {
                     encryptionException = exception;
                 }
-            }];
+            });
 
             if (encryptionException) {
                 OWSLogInfo(@"Exception during encryption: %@", encryptionException);
@@ -1685,11 +1685,11 @@ - (void)sendSyncTranscriptForMessage:(TSOutgoingMessage *)message
             }
         } @catch (NSException *exception) {
             if ([exception.name isEqualToString:OWSMessageSenderInvalidDeviceException]) {
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     [recipient updateRegisteredRecipientWithDevicesToAdd:nil
                                                          devicesToRemove:@[ deviceId ]
                                                              transaction:transaction];
-                }];
+                });
             } else {
                 @throw exception;
             }
@@ -1711,11 +1711,11 @@ - (void)throws_ensureRecipientHasSessionForMessageSend:(OWSMessageSend *)message
     NSString *accountId = messageSend.recipient.accountId;
 
     __block BOOL hasSession;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         hasSession = [self.sessionStore containsSessionForAddress:recipientAddress
                                                          deviceId:[deviceId intValue]
                                                       transaction:transaction];
-    }];
+    });
     if (hasSession) {
         return;
     }
@@ -1764,13 +1764,13 @@ - (void)throws_ensureRecipientHasSessionForMessageSend:(OWSMessageSend *)message
                                                               identityKeyStore:self.identityManager
                                                                    recipientId:accountId
                                                                       deviceId:[deviceId intValue]];
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             @try {
                 [builder throws_processPrekeyBundle:bundle protocolContext:transaction];
             } @catch (NSException *caughtException) {
                 exception = caughtException;
             }
-        }];
+        });
         if (exception) {
             if ([exception.name isEqualToString:UntrustedIdentityKeyException]) {
                 OWSRaiseExceptionWithUserInfo(UntrustedIdentityKeyException,
@@ -1946,12 +1946,12 @@ - (void)handleStaleDevicesWithResponseJson:(NSDictionary *)responseJson
             return;
         }
 
-        [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             for (NSUInteger i = 0; i < [devices count]; i++) {
                 int deviceNumber = [devices[i] intValue];
                 [self.sessionStore deleteSessionForAddress:address deviceId:deviceNumber transaction:transaction];
             }
-        }];
+        });
         completionHandler();
     });
 }
diff --git a/SignalServiceKit/src/Messages/OWSOutgoingReceiptManager.m b/SignalServiceKit/src/Messages/OWSOutgoingReceiptManager.m
index f4c420062fe..b45d9f265f3 100644
--- a/SignalServiceKit/src/Messages/OWSOutgoingReceiptManager.m
+++ b/SignalServiceKit/src/Messages/OWSOutgoingReceiptManager.m
@@ -331,7 +331,7 @@ - (void)dequeueReceiptsForAddress:(SignalServiceAddress *)address
         OWSFailDebug(@"Invalid timestamps.");
         return;
     }
-    [self.databaseStorage asyncWriteWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageAsyncWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         NSString *identifier = address.uuidString ?: address.phoneNumber;
 
         NSSet<NSNumber *> *_Nullable oldUUIDTimestamps;
@@ -368,7 +368,7 @@ - (void)dequeueReceiptsForAddress:(SignalServiceAddress *)address
         } else {
             [store removeValueForKey:identifier transaction:transaction];
         }
-    }];
+    });
 }
 
 - (void)reachabilityChanged
diff --git a/SignalServiceKit/src/Messages/OWSReadReceiptManager.m b/SignalServiceKit/src/Messages/OWSReadReceiptManager.m
index 5bdf669cf1e..0ad5bf586ac 100644
--- a/SignalServiceKit/src/Messages/OWSReadReceiptManager.m
+++ b/SignalServiceKit/src/Messages/OWSReadReceiptManager.m
@@ -180,7 +180,7 @@ - (void)markAsReadLocallyBeforeSortId:(uint64_t)sortId
             unreadMessages =
                 [unreadMessages subarrayWithRange:NSMakeRange(batchSize, unreadMessages.count - batchSize)];
             OWSAssertDebug(batch.count > 0);
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 OWSReadCircumstance circumstance = hasPendingMessageRequest
                     ? OWSReadCircumstanceReadOnThisDeviceWhilePendingMessageRequest
                     : OWSReadCircumstanceReadOnThisDevice;
@@ -189,7 +189,7 @@ - (void)markAsReadLocallyBeforeSortId:(uint64_t)sortId
                            readTimestamp:readTimestamp
                             circumstance:circumstance
                              transaction:transaction];
-            }];
+            });
         }
         while (messagesWithUnreadReactions.count > 0) {
             NSUInteger batchSize = MIN(messagesWithUnreadReactions.count, maxBatchSize);
@@ -198,13 +198,13 @@ - (void)markAsReadLocallyBeforeSortId:(uint64_t)sortId
             messagesWithUnreadReactions = [messagesWithUnreadReactions
                 subarrayWithRange:NSMakeRange(batchSize, messagesWithUnreadReactions.count - batchSize)];
             OWSAssertDebug(batch.count > 0);
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 for (TSOutgoingMessage *message in batch) {
                     [message markUnreadReactionsAsReadWithTransaction:transaction];
                 }
 
                 [self sendLinkedDeviceReadReceiptForMessages:batch thread:thread transaction:transaction];
-            }];
+            });
         }
         dispatch_async(dispatch_get_main_queue(), completion);
     });
@@ -489,9 +489,9 @@ - (void)setAreReadReceiptsEnabledWithSneakyTransactionAndSyncConfiguration:(BOOL
 {
     OWSLogInfo(@"setAreReadReceiptsEnabled: %d.", value);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self setAreReadReceiptsEnabled:value transaction:transaction];
-    }];
+    });
 
     [SSKEnvironment.shared.syncManager sendConfigurationSyncMessage];
     [SSKEnvironment.shared.storageServiceManager recordPendingLocalAccountUpdates];
diff --git a/SignalServiceKit/src/Messages/TSCall.m b/SignalServiceKit/src/Messages/TSCall.m
index 9f85ec41e27..da340e10a17 100644
--- a/SignalServiceKit/src/Messages/TSCall.m
+++ b/SignalServiceKit/src/Messages/TSCall.m
@@ -209,9 +209,9 @@ - (void)markAsReadAtTimestamp:(uint64_t)readTimestamp
 
 - (void)updateCallType:(RPRecentCallType)callType
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self updateCallType:callType transaction:transaction];
-    }];
+    });
 }
 
 - (void)updateCallType:(RPRecentCallType)callType transaction:(SDSAnyWriteTransaction *)transaction
diff --git a/SignalServiceKit/src/Network/API/OWSDevicesService.m b/SignalServiceKit/src/Network/API/OWSDevicesService.m
index bf46f67bb80..1b6436af0b4 100644
--- a/SignalServiceKit/src/Network/API/OWSDevicesService.m
+++ b/SignalServiceKit/src/Network/API/OWSDevicesService.m
@@ -38,9 +38,9 @@ + (void)refreshDevices
                 }
 
                 __block BOOL didAddOrRemove;
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     didAddOrRemove = [OWSDevice replaceAll:devices transaction:transaction];
-                }];
+                });
 
                 [NSNotificationCenter.defaultCenter
                     postNotificationNameAsync:NSNotificationName_DeviceListUpdateSucceeded
diff --git a/SignalServiceKit/src/Network/API/OWSUploadOperation.m b/SignalServiceKit/src/Network/API/OWSUploadOperation.m
index d4cea275410..f634cd3343d 100644
--- a/SignalServiceKit/src/Network/API/OWSUploadOperation.m
+++ b/SignalServiceKit/src/Network/API/OWSUploadOperation.m
@@ -127,7 +127,7 @@ - (void)run
                                        }];
         })
         .thenInBackground(^{
-            [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+            DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                 [attachmentStream updateAsUploadedWithEncryptionKey:upload.encryptionKey
                                                              digest:upload.digest
                                                            serverId:upload.serverId
@@ -135,7 +135,7 @@ - (void)run
                                                           cdnNumber:0
                                                     uploadTimestamp:upload.uploadTimestamp
                                                         transaction:transaction];
-            }];
+            });
             self.completedUpload = attachmentStream;
             [self reportSuccess];
         })
diff --git a/SignalServiceKit/src/Network/OWSSignalService.m b/SignalServiceKit/src/Network/OWSSignalService.m
index a63afc6a710..b0431920a6b 100644
--- a/SignalServiceKit/src/Network/OWSSignalService.m
+++ b/SignalServiceKit/src/Network/OWSSignalService.m
@@ -126,9 +126,9 @@ - (BOOL)isCensorshipCircumventionManuallyActivated
 
 - (void)setIsCensorshipCircumventionManuallyActivated:(BOOL)value
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setBool:value key:kisCensorshipCircumventionManuallyActivatedKey transaction:transaction];
-    }];
+    });
 
     [self updateIsCensorshipCircumventionActive];
 }
@@ -146,9 +146,9 @@ - (BOOL)isCensorshipCircumventionManuallyDisabled
 
 - (void)setIsCensorshipCircumventionManuallyDisabled:(BOOL)value
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setBool:value key:kisCensorshipCircumventionManuallyDisabledKey transaction:transaction];
-    }];
+    });
 
     [self updateIsCensorshipCircumventionActive];
 }
@@ -432,9 +432,9 @@ - (nullable NSString *)manualCensorshipCircumventionCountryCode
 
 - (void)setManualCensorshipCircumventionCountryCode:(nullable NSString *)value
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyValueStore setString:value key:kManualCensorshipCircumventionCountryCodeKey transaction:transaction];
-    }];
+    });
 }
 
 @end
diff --git a/SignalServiceKit/src/Network/WebSockets/OWSWebSocket.m b/SignalServiceKit/src/Network/WebSockets/OWSWebSocket.m
index 22164b43d50..312a49a0ff4 100644
--- a/SignalServiceKit/src/Network/WebSockets/OWSWebSocket.m
+++ b/SignalServiceKit/src/Network/WebSockets/OWSWebSocket.m
@@ -812,11 +812,11 @@ - (void)processWebSocketRequestMessage:(WebSocketProtoWebSocketRequestMessage *)
             }
 
             if (!success) {
-                [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                     ThreadlessErrorMessage *errorMessage = [ThreadlessErrorMessage corruptedMessageInUnknownThread];
                     [self.notificationsManager notifyUserForThreadlessErrorMessage:errorMessage
                                                                        transaction:transaction];
-                }];
+                });
             }
 
             dispatch_async(dispatch_get_main_queue(), ^{
diff --git a/SignalServiceKit/src/SignalServiceKit.h b/SignalServiceKit/src/SignalServiceKit.h
index 86f7ae52d2a..9c2282ed2d3 100644
--- a/SignalServiceKit/src/SignalServiceKit.h
+++ b/SignalServiceKit/src/SignalServiceKit.h
@@ -42,6 +42,7 @@
 #import <SignalServiceKit/OWSVerificationStateChangeMessage.h>
 #import <SignalServiceKit/PhoneNumber.h>
 #import <SignalServiceKit/RemoteAttestation.h>
+#import <SignalServiceKit/SDSDatabaseStorage+Objc.h>
 #import <SignalServiceKit/SSKJobRecord.h>
 #import <SignalServiceKit/SSKMessageDecryptJobRecord.h>
 #import <SignalServiceKit/SSKMessageSenderJobRecord.h>
diff --git a/SignalServiceKit/src/Storage/AxolotlStore/CallKitIdStore.m b/SignalServiceKit/src/Storage/AxolotlStore/CallKitIdStore.m
index 5ac2efe7356..9d24b99490e 100644
--- a/SignalServiceKit/src/Storage/AxolotlStore/CallKitIdStore.m
+++ b/SignalServiceKit/src/Storage/AxolotlStore/CallKitIdStore.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "CallKitIdStore.h"
@@ -35,7 +35,7 @@ + (void)setAddress:(SignalServiceAddress *)address forCallKitId:(NSString *)call
     OWSAssertDebug(address.isValid);
     OWSAssertDebug(callKitId.length > 0);
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         if (address.phoneNumber) {
             [self.phoneNumberStore setString:address.phoneNumber key:callKitId transaction:transaction];
         } else {
@@ -47,7 +47,7 @@ + (void)setAddress:(SignalServiceAddress *)address forCallKitId:(NSString *)call
         } else {
             [self.uuidStore removeValueForKey:callKitId transaction:transaction];
         }
-    }];
+    });
 }
 
 + (SignalServiceAddress *)addressForCallKitId:(NSString *)callKitId
diff --git a/SignalServiceKit/src/Storage/AxolotlStore/SSKPreKeyStore.m b/SignalServiceKit/src/Storage/AxolotlStore/SSKPreKeyStore.m
index e65896087e6..ce704191f44 100644
--- a/SignalServiceKit/src/Storage/AxolotlStore/SSKPreKeyStore.m
+++ b/SignalServiceKit/src/Storage/AxolotlStore/SSKPreKeyStore.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 #import "SSKPreKeyStore.h"
@@ -92,22 +92,22 @@ - (SDSDatabaseStorage *)databaseStorage
             preKeyId++;
         }
 
-        [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+        DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
             [self.metadataStore setInt:preKeyId key:TSNextPrekeyIdKey transaction:transaction];
-        }];
+        });
     }
     return preKeyRecords;
 }
 
 - (void)storePreKeyRecords:(NSArray<PreKeyRecord *> *)preKeyRecords
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         for (PreKeyRecord *record in preKeyRecords) {
             [self.keyStore setPreKeyRecord:record
                                     forKey:[SDSKeyValueStore keyWithInt:record.Id]
                                transaction:transaction];
         }
-    }];
+    });
 }
 
 - (nullable PreKeyRecord *)loadPreKey:(int)preKeyId
@@ -121,9 +121,9 @@ - (nullable PreKeyRecord *)loadPreKey:(int)preKeyId
 
 - (void)storePreKey:(int)preKeyId preKeyRecord:(PreKeyRecord *)record
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyStore setPreKeyRecord:record forKey:[SDSKeyValueStore keyWithInt:preKeyId] transaction:transaction];
-    }];
+    });
 }
 
 - (void)removePreKey:(int)preKeyId
diff --git a/SignalServiceKit/src/Storage/AxolotlStore/SSKSignedPreKeyStore.m b/SignalServiceKit/src/Storage/AxolotlStore/SSKSignedPreKeyStore.m
index 46da2353c59..b77c989ff2e 100644
--- a/SignalServiceKit/src/Storage/AxolotlStore/SSKSignedPreKeyStore.m
+++ b/SignalServiceKit/src/Storage/AxolotlStore/SSKSignedPreKeyStore.m
@@ -137,11 +137,11 @@ - (NSArray *)loadSignedPreKeys
 
 - (void)storeSignedPreKey:(int)signedPreKeyId signedPreKeyRecord:(SignedPreKeyRecord *)signedPreKeyRecord
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyStore setSignedPreKeyRecord:signedPreKeyRecord
                                       forKey:[SDSKeyValueStore keyWithInt:signedPreKeyId]
                                  transaction:transaction];
-    }];
+    });
 }
 
 - (BOOL)containsSignedPreKey:(int)signedPreKeyId
@@ -156,9 +156,9 @@ - (BOOL)containsSignedPreKey:(int)signedPreKeyId
 
 - (void)removeSignedPreKey:(int)signedPrekeyId
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.keyStore removeValueForKey:[SDSKeyValueStore keyWithInt:signedPrekeyId] transaction:transaction];
-    }];
+    });
 }
 
 - (nullable NSNumber *)currentSignedPrekeyId
@@ -172,9 +172,9 @@ - (nullable NSNumber *)currentSignedPrekeyId
 
 - (void)setCurrentSignedPrekeyId:(int)value
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.metadataStore setObject:@(value) key:kPrekeyCurrentSignedPrekeyIdKey transaction:transaction];
-    }];
+    });
 }
 
 - (nullable SignedPreKeyRecord *)currentSignedPreKey
@@ -208,17 +208,17 @@ - (int)prekeyUpdateFailureCount
 
 - (void)clearPrekeyUpdateFailureCount
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.metadataStore removeValueForKey:kPrekeyUpdateFailureCountKey transaction:transaction];
-    }];
+    });
 }
 
 - (NSInteger)incrementPrekeyUpdateFailureCount
 {
     __block NSInteger result;
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         result = [self.metadataStore incrementIntForKey:kPrekeyUpdateFailureCountKey transaction:transaction];
-    }];
+    });
     return result;
 }
 
@@ -233,16 +233,16 @@ - (nullable NSDate *)firstPrekeyUpdateFailureDate
 
 - (void)setFirstPrekeyUpdateFailureDate:(nonnull NSDate *)value
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.metadataStore setDate:value key:kFirstPrekeyUpdateFailureDateKey transaction:transaction];
-    }];
+    });
 }
 
 - (void)clearFirstPrekeyUpdateFailureDate
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self.metadataStore removeValueForKey:kFirstPrekeyUpdateFailureDateKey transaction:transaction];
-    }];
+    });
 }
 
 #pragma mark - Debugging
diff --git a/SignalServiceKit/src/Storage/Database/SDSDatabaseQueue.swift b/SignalServiceKit/src/Storage/Database/SDSDatabaseQueue.swift
index 657ed30f78f..adf2d701e23 100644
--- a/SignalServiceKit/src/Storage/Database/SDSDatabaseQueue.swift
+++ b/SignalServiceKit/src/Storage/Database/SDSDatabaseQueue.swift
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2019 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
 //
 
 import Foundation
@@ -113,19 +113,40 @@ public class SDSAnyDatabaseQueue: SDSTransactable, SDSDatabaseQueue {
         }
     }
 
+    func write(block: @escaping (SDSAnyWriteTransaction) -> Void) {
+        write(file: #file,
+              function: #function,
+              line: #line,
+              block: block)
+    }
+
     @objc
-    public override func write(block: @escaping (SDSAnyWriteTransaction) -> Void) {
+    public override func write(file: String = #file,
+                               function: String = #function,
+                               line: Int = #line,
+                               block: @escaping (SDSAnyWriteTransaction) -> Void) {
+
+        let benchTitle = "Slow Write Transaction \(SDSDatabaseStorage.owsFormatLogMessage(file: file, function: function, line: line))"
+
         switch databaseStorage.dataStoreForWrites {
         case .grdb:
             guard let grdbDatabaseQueue = grdbDatabaseQueue else {
                 owsFail("Missing grdbDatabaseQueue.")
             }
-            grdbDatabaseQueue.write { block($0.asAnyWrite) }
+            grdbDatabaseQueue.write { transaction in
+                Bench(title: benchTitle, logIfLongerThan: 0.1) {
+                    block(transaction.asAnyWrite)
+                }
+            }
         case .ydb:
             guard let yapDatabaseQueue = yapDatabaseQueue else {
                 owsFail("Missing grdbDatabaseQueue.")
             }
-            yapDatabaseQueue.write { block($0.asAnyWrite) }
+            yapDatabaseQueue.write { transaction in
+                Bench(title: benchTitle, logIfLongerThan: 0.1) {
+                    block(transaction.asAnyWrite)
+                }
+            }
         }
 
         crossProcess.notifyChangedAsync()
diff --git a/SignalServiceKit/src/Storage/Database/SDSDatabaseStorage+Objc.h b/SignalServiceKit/src/Storage/Database/SDSDatabaseStorage+Objc.h
new file mode 100644
index 00000000000..2e8748c1582
--- /dev/null
+++ b/SignalServiceKit/src/Storage/Database/SDSDatabaseStorage+Objc.h
@@ -0,0 +1,22 @@
+//
+//  Copyright (c) 2020 Open Whisper Systems. All rights reserved.
+//
+
+#define DatabaseStorageWrite(__databaseStorage, __block)                                                               \
+    [__databaseStorage writeWithFile:[NSString stringWithUTF8String:__FILE__]                                          \
+                            function:[NSString stringWithUTF8String:__PRETTY_FUNCTION__]                               \
+                                line:__LINE__                                                                          \
+                               block:__block];
+
+#define DatabaseStorageAsyncWrite(__databaseStorage, __block)                                                          \
+    [__databaseStorage asyncWriteWithFile:[NSString stringWithUTF8String:__FILE__]                                     \
+                                 function:[NSString stringWithUTF8String:__PRETTY_FUNCTION__]                          \
+                                     line:__LINE__                                                                     \
+                                    block:__block];
+
+#define DatabaseStorageAsyncWriteWithCompletion(__databaseStorage, __block, __completion)                              \
+    [__databaseStorage asyncWriteWithFile:[NSString stringWithUTF8String:__FILE__]                                     \
+                                 function:[NSString stringWithUTF8String:__PRETTY_FUNCTION__]                          \
+                                     line:__LINE__                                                                     \
+                                    block:__block                                                                      \
+                               completion:__completion];
diff --git a/SignalServiceKit/src/Storage/Database/SDSDatabaseStorage.swift b/SignalServiceKit/src/Storage/Database/SDSDatabaseStorage.swift
index 643ac8c19e5..52faa01098e 100644
--- a/SignalServiceKit/src/Storage/Database/SDSDatabaseStorage.swift
+++ b/SignalServiceKit/src/Storage/Database/SDSDatabaseStorage.swift
@@ -394,18 +394,22 @@ public class SDSDatabaseStorage: SDSTransactable {
     }
 
     @objc
-    public override func write(block: @escaping (SDSAnyWriteTransaction) -> Void) {
+    public override func write(file: String = #file,
+                               function: String = #function,
+                               line: Int = #line,
+                               block: @escaping (SDSAnyWriteTransaction) -> Void) {
         if OWSIsDebugBuild() &&
             Thread.isMainThread &&
             AppReadiness.isAppReady() {
             Logger.verbose("Database write on main thread.")
         }
 
+        let benchTitle = "Slow Write Transaction \(Self.owsFormatLogMessage(file: file, function: function, line: line))"
         switch dataStoreForWrites {
         case .grdb:
             do {
                 try grdbStorage.write { transaction in
-                    Bench(title: "Slow Write Transaction", logIfLongerThan: 0.1) {
+                    Bench(title: benchTitle, logIfLongerThan: 0.1) {
                         block(transaction.asAnyWrite)
                     }
                 }
@@ -414,7 +418,7 @@ public class SDSDatabaseStorage: SDSTransactable {
             }
         case .ydb:
             yapStorage.write { transaction in
-                Bench(title: "Slow Write Transaction", logIfLongerThan: 0.1) {
+                Bench(title: benchTitle, logIfLongerThan: 0.1) {
                     block(transaction.asAnyWrite)
                 }
             }
@@ -446,6 +450,15 @@ public class SDSDatabaseStorage: SDSTransactable {
         }
         return value
     }
+
+    public static func owsFormatLogMessage(file: String = #file,
+                                           function: String = #function,
+                                           line: Int = #line) -> String {
+        let filename = (file as NSString).lastPathComponent
+        // We format the filename & line number in a format compatible
+        // with XCode's "Open Quickly..." feature.
+        return "[\(filename):\(line) \(function)]"
+    }
 }
 
 // MARK: - Coordination
diff --git a/SignalServiceKit/src/Storage/Database/SDSTransactable.swift b/SignalServiceKit/src/Storage/Database/SDSTransactable.swift
index 0d05f26694e..5f0eedfd948 100644
--- a/SignalServiceKit/src/Storage/Database/SDSTransactable.swift
+++ b/SignalServiceKit/src/Storage/Database/SDSTransactable.swift
@@ -13,7 +13,10 @@ public class SDSTransactable: NSObject {
         owsFail("Method should be implemented by subclasses.")
     }
 
-    public func write(block: @escaping (SDSAnyWriteTransaction) -> Void) {
+    public func write(file: String = #file,
+                      function: String = #function,
+                      line: Int = #line,
+                      block: @escaping (SDSAnyWriteTransaction) -> Void) {
         owsFail("Method should be implemented by subclasses.")
     }
 }
@@ -38,17 +41,38 @@ public extension SDSTransactable {
         }
     }
 
-    func asyncWrite(block: @escaping (SDSAnyWriteTransaction) -> Void) {
-        asyncWrite(block: block, completion: { })
-    }
-
-    func asyncWrite(block: @escaping (SDSAnyWriteTransaction) -> Void, completion: @escaping () -> Void) {
-        asyncWrite(block: block, completionQueue: .main, completion: completion)
-    }
-
-    func asyncWrite(block: @escaping (SDSAnyWriteTransaction) -> Void, completionQueue: DispatchQueue, completion: @escaping () -> Void) {
+    func asyncWrite(file: String = #file,
+                    function: String = #function,
+                    line: Int = #line,
+                    block: @escaping (SDSAnyWriteTransaction) -> Void) {
+        asyncWrite(file: file,
+                   function: function,
+                   line: line,
+                   block: block,
+                   completion: { })
+    }
+
+    func asyncWrite(file: String = #file,
+                    function: String = #function,
+                    line: Int = #line,
+                    block: @escaping (SDSAnyWriteTransaction) -> Void, completion: @escaping () -> Void) {
+        asyncWrite(file: file,
+                   function: function,
+                   line: line,
+                   block: block,
+                   completionQueue: .main,
+                   completion: completion)
+    }
+
+    func asyncWrite(file: String = #file,
+                    function: String = #function,
+                    line: Int = #line,
+                    block: @escaping (SDSAnyWriteTransaction) -> Void, completionQueue: DispatchQueue, completion: @escaping () -> Void) {
         DispatchQueue.global().async {
-            self.write(block: block)
+            self.write(file: file,
+                       function: function,
+                       line: line,
+                       block: block)
 
             completionQueue.async(execute: completion)
         }
@@ -88,19 +112,33 @@ public extension SDSTransactable {
         return AnyPromise(write(.promise, block) as Promise<Void>)
     }
 
-    func write<T>(_: PMKNamespacer, _ block: @escaping (SDSAnyWriteTransaction) -> T) -> Promise<T> {
+    func write<T>(_: PMKNamespacer,
+                  file: String = #file,
+                  function: String = #function,
+                  line: Int = #line,
+                  _ block: @escaping (SDSAnyWriteTransaction) -> T) -> Promise<T> {
         return Promise { resolver in
             DispatchQueue.global().async {
-                resolver.fulfill(self.write(block: block))
+                resolver.fulfill(self.write(file: file,
+                                            function: function,
+                                            line: line,
+                                            block: block))
             }
         }
     }
 
-    func write<T>(_: PMKNamespacer, _ block: @escaping (SDSAnyWriteTransaction) throws -> T) -> Promise<T> {
+    func write<T>(_: PMKNamespacer,
+                  file: String = #file,
+                  function: String = #function,
+                  line: Int = #line,
+                  _ block: @escaping (SDSAnyWriteTransaction) throws -> T) -> Promise<T> {
         return Promise { resolver in
             DispatchQueue.global().async {
                 do {
-                    resolver.fulfill(try self.write(block: block))
+                    resolver.fulfill(try self.write(file: file,
+                                                    function: function,
+                                                    line: line,
+                                                    block: block))
                 } catch {
                     resolver.reject(error)
                 }
@@ -141,19 +179,29 @@ public extension SDSTransactable {
     }
 
     @discardableResult
-    func write<T>(block: @escaping (SDSAnyWriteTransaction) -> T) -> T {
+    func write<T>(file: String = #file,
+                  function: String = #function,
+                  line: Int = #line,
+                  block: @escaping (SDSAnyWriteTransaction) -> T) -> T {
         var value: T!
-        write { (transaction) in
+        write(file: file,
+              function: function,
+              line: line) { (transaction) in
             value = block(transaction)
         }
         return value
     }
 
     @discardableResult
-    func write<T>(block: @escaping (SDSAnyWriteTransaction) throws -> T) throws -> T {
+    func write<T>(file: String = #file,
+                  function: String = #function,
+                  line: Int = #line,
+                  block: @escaping (SDSAnyWriteTransaction) throws -> T) throws -> T {
         var value: T!
         var thrown: Error?
-        write { (transaction) in
+        write(file: file,
+              function: function,
+              line: line) { (transaction) in
             do {
                 value = try block(transaction)
             } catch {
diff --git a/SignalServiceKit/src/Util/OWS2FAManager.m b/SignalServiceKit/src/Util/OWS2FAManager.m
index cb3ee67e933..df636e6d0be 100644
--- a/SignalServiceKit/src/Util/OWS2FAManager.m
+++ b/SignalServiceKit/src/Util/OWS2FAManager.m
@@ -203,9 +203,9 @@ - (void)requestEnable2FAWithPin:(NSString *)pin
                 .then(^{
                     OWSAssertIsOnMainThread();
 
-                    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                         [self markEnabledWithPin:pin transaction:transaction];
-                    }];
+                    });
 
                     if (success) {
                         success();
@@ -228,9 +228,9 @@ - (void)requestEnable2FAWithPin:(NSString *)pin
                 success:^(NSURLSessionDataTask *task, id responseObject) {
                     OWSAssertIsOnMainThread();
 
-                    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                         [self markEnabledWithPin:pin transaction:transaction];
-                    }];
+                    });
 
                     if (success) {
                         success();
@@ -263,9 +263,9 @@ - (void)disable2FAWithSuccess:(nullable OWS2FASuccess)success failure:(nullable
                 .ensure(^{
                     OWSAssertIsOnMainThread();
 
-                    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                         [self markDisabledWithTransaction:transaction];
-                    }];
+                    });
                 })
                 .then(^() {
                     OWSAssertIsOnMainThread();
@@ -290,9 +290,10 @@ - (void)disable2FAWithSuccess:(nullable OWS2FASuccess)success failure:(nullable
                                      success:^(NSURLSessionDataTask *task, id responseObject) {
                                          OWSAssertIsOnMainThread();
 
-                                         [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
-                                             [self markDisabledWithTransaction:transaction];
-                                         }];
+                                         DatabaseStorageWrite(
+                                             self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
+                                                 [self markDisabledWithTransaction:transaction];
+                                             });
 
                                          if (success) {
                                              success();
@@ -383,9 +384,9 @@ - (BOOL)needsLegacyPinMigration
     // We don't need to migrate this pin, either because it's v2 or short enough that
     // we never truncated it. Mark it as complete so we don't need to check again.
 
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         [self markLegacyPinAsMigratedWithTransaction:transaction];
-    }];
+    });
 
     return NO;
 }
@@ -409,9 +410,9 @@ - (void)verifyPin:(NSString *)pin result:(void (^_Nonnull)(BOOL))result
                                  result(isValid);
 
                                  if (isValid) {
-                                     [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+                                     DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
                                          [self setPinCode:pin transaction:transaction];
-                                     }];
+                                     });
                                  }
                              }];
         }
@@ -481,7 +482,7 @@ - (NSTimeInterval)repetitionIntervalWithTransaction:(SDSAnyReadTransaction *)tra
 
 - (void)updateRepetitionIntervalWithWasSuccessful:(BOOL)wasSuccessful
 {
-    [self.databaseStorage writeWithBlock:^(SDSAnyWriteTransaction *transaction) {
+    DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
         if (wasSuccessful) {
             [self setLastSuccessfulReminderDate:[NSDate new] transaction:transaction];
         }
@@ -497,7 +498,7 @@ - (void)updateRepetitionIntervalWithWasSuccessful:(BOOL)wasSuccessful
         [OWS2FAManager.keyValueStore setDouble:newInterval
                                            key:kOWS2FAManager_RepetitionInterval
                                    transaction:transaction];
-    }];
+    });
 }
 
 - (NSTimeInterval)adjustRepetitionInterval:(NSTimeInterval)oldInterval wasSuccessful:(BOOL)wasSuccessful
