diff --git a/Signal.xcodeproj/project.pbxproj b/Signal.xcodeproj/project.pbxproj
index 079b71d8fe7..1e16593d1cb 100644
--- a/Signal.xcodeproj/project.pbxproj
+++ b/Signal.xcodeproj/project.pbxproj
@@ -111,7 +111,6 @@
 		346129C71FD2072E00532771 /* NSString+OWS.h in Headers */ = {isa = PBXBuildFile; fileRef = 346129C01FD2072C00532771 /* NSString+OWS.h */; settings = {ATTRIBUTES = (Public, ); }; };
 		346129C81FD2072E00532771 /* NSAttributedString+OWS.m in Sources */ = {isa = PBXBuildFile; fileRef = 346129C11FD2072D00532771 /* NSAttributedString+OWS.m */; };
 		346129C91FD2072E00532771 /* NSString+OWS.m in Sources */ = {isa = PBXBuildFile; fileRef = 346129C21FD2072D00532771 /* NSString+OWS.m */; };
-		346129CA1FD2072E00532771 /* UIImage+OWS.h in Headers */ = {isa = PBXBuildFile; fileRef = 346129C31FD2072D00532771 /* UIImage+OWS.h */; settings = {ATTRIBUTES = (Public, ); }; };
 		346129CB1FD2072E00532771 /* Promise+retainUntilComplete.swift in Sources */ = {isa = PBXBuildFile; fileRef = 346129C41FD2072D00532771 /* Promise+retainUntilComplete.swift */; };
 		346129CC1FD2072E00532771 /* NSAttributedString+OWS.h in Headers */ = {isa = PBXBuildFile; fileRef = 346129C51FD2072D00532771 /* NSAttributedString+OWS.h */; settings = {ATTRIBUTES = (Public, ); }; };
 		346129CD1FD2072E00532771 /* UIImage+OWS.m in Sources */ = {isa = PBXBuildFile; fileRef = 346129C61FD2072D00532771 /* UIImage+OWS.m */; };
@@ -684,10 +683,8 @@
 		346129C01FD2072C00532771 /* NSString+OWS.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; path = "NSString+OWS.h"; sourceTree = "<group>"; };
 		346129C11FD2072D00532771 /* NSAttributedString+OWS.m */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.objc; path = "NSAttributedString+OWS.m"; sourceTree = "<group>"; };
 		346129C21FD2072D00532771 /* NSString+OWS.m */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.objc; path = "NSString+OWS.m"; sourceTree = "<group>"; };
-		346129C31FD2072D00532771 /* UIImage+OWS.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; path = "UIImage+OWS.h"; sourceTree = "<group>"; };
 		346129C41FD2072D00532771 /* Promise+retainUntilComplete.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = "Promise+retainUntilComplete.swift"; sourceTree = "<group>"; };
 		346129C51FD2072D00532771 /* NSAttributedString+OWS.h */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.h; path = "NSAttributedString+OWS.h"; sourceTree = "<group>"; };
-		346129C61FD2072D00532771 /* UIImage+OWS.m */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.objc; path = "UIImage+OWS.m"; sourceTree = "<group>"; };
 		346129CF1FD207F200532771 /* OWSAlerts.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = OWSAlerts.swift; sourceTree = "<group>"; };
 		346129D11FD2085A00532771 /* CommonStrings.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = CommonStrings.swift; sourceTree = "<group>"; };
 		346129D31FD20ADB00532771 /* UIViewController+OWS.m */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.c.objc; path = "UIViewController+OWS.m"; sourceTree = "<group>"; };
@@ -1407,8 +1404,6 @@
 				34480B5E1FD0A98800BC14EF /* UIColor+OWS.m */,
 				34480B661FD0AA9400BC14EF /* UIFont+OWS.h */,
 				34480B651FD0AA9400BC14EF /* UIFont+OWS.m */,
-				346129C31FD2072D00532771 /* UIImage+OWS.h */,
-				346129C61FD2072D00532771 /* UIImage+OWS.m */,
 				34480B5F1FD0A98800BC14EF /* UIView+OWS.h */,
 				34480B601FD0A98800BC14EF /* UIView+OWS.m */,
 				346129D41FD20ADC00532771 /* UIViewController+OWS.h */,
@@ -3072,7 +3067,6 @@
 				347850591FD9972E007B8332 /* SwiftSingletons.swift in Sources */,
 				344F248720069ECB00CFB4F4 /* ModalActivityIndicatorViewController.swift in Sources */,
 				346129961FD1E30000532771 /* OWSDatabaseMigration.m in Sources */,
-				346129CD1FD2072E00532771 /* UIImage+OWS.m in Sources */,
 				344D6CEC20069E070042AF96 /* NewNonContactConversationViewController.m in Sources */,
 				346129FB1FD5F31400532771 /* OWS101ExistingUsersBlockOnIdentityChange.m in Sources */,
 				344F248D2007CCD600CFB4F4 /* DisplayableText.swift in Sources */,
diff --git a/Signal/Images.xcassets/quoted-message-cancel.imageset/Contents.json b/Signal/Images.xcassets/quoted-message-cancel.imageset/Contents.json
new file mode 100644
index 00000000000..21bdf79c942
--- /dev/null
+++ b/Signal/Images.xcassets/quoted-message-cancel.imageset/Contents.json
@@ -0,0 +1,23 @@
+{
+  "images" : [
+    {
+      "idiom" : "universal",
+      "filename" : "quoted-message-cancel@1x.png",
+      "scale" : "1x"
+    },
+    {
+      "idiom" : "universal",
+      "filename" : "quoted-message-cancel@2x.png",
+      "scale" : "2x"
+    },
+    {
+      "idiom" : "universal",
+      "filename" : "quoted-message-cancel@3x.png",
+      "scale" : "3x"
+    }
+  ],
+  "info" : {
+    "version" : 1,
+    "author" : "xcode"
+  }
+}
\ No newline at end of file
diff --git a/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@1x.png b/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@1x.png
new file mode 100644
index 00000000000..5996721bbf2
Binary files /dev/null and b/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@1x.png differ
diff --git a/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@2x.png b/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@2x.png
new file mode 100644
index 00000000000..745f1eb6d09
Binary files /dev/null and b/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@2x.png differ
diff --git a/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@3x.png b/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@3x.png
new file mode 100644
index 00000000000..325c0ac5a7a
Binary files /dev/null and b/Signal/Images.xcassets/quoted-message-cancel.imageset/quoted-message-cancel@3x.png differ
diff --git a/Signal/src/Signal-Bridging-Header.h b/Signal/src/Signal-Bridging-Header.h
index 15ef23f82c1..8cd537cdd96 100644
--- a/Signal/src/Signal-Bridging-Header.h
+++ b/Signal/src/Signal-Bridging-Header.h
@@ -62,7 +62,6 @@
 #import <SignalMessaging/ThreadUtil.h>
 #import <SignalMessaging/UIColor+OWS.h>
 #import <SignalMessaging/UIFont+OWS.h>
-#import <SignalMessaging/UIImage+OWS.h>
 #import <SignalMessaging/UIUtil.h>
 #import <SignalMessaging/UIView+OWS.h>
 #import <SignalMessaging/UIViewController+OWS.h>
@@ -126,6 +125,7 @@
 #import <SignalServiceKit/TSSocketManager.h>
 #import <SignalServiceKit/TSThread.h>
 #import <SignalServiceKit/Threading.h>
+#import <SignalServiceKit/UIImage+OWS.h>
 #import <WebRTC/RTCAudioSession.h>
 #import <WebRTC/RTCCameraPreviewView.h>
 #import <YYImage/YYImage.h>
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.h b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.h
index 0a1e8813ba9..bf79c50a679 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.h
+++ b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.h
@@ -5,6 +5,7 @@
 NS_ASSUME_NONNULL_BEGIN
 
 @class SignalAttachment;
+@class TSQuotedMessage;
 
 @protocol ConversationInputToolbarDelegate <NSObject>
 
@@ -57,6 +58,9 @@ NS_ASSUME_NONNULL_BEGIN
 
 - (void)cancelVoiceMemoIfNecessary;
 
+- (void)setQuotedMessage:(TSQuotedMessage *)quotedMessage;
+- (void)clearQuotedMessage;
+
 @end
 
 NS_ASSUME_NONNULL_END
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m
index 942c6ccb77d..fa1cccf2412 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m
+++ b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.m
@@ -4,6 +4,8 @@
 
 #import "ConversationInputToolbar.h"
 #import "ConversationInputTextView.h"
+#import "Environment.h"
+#import "OWSContactsManager.h"
 #import "OWSMath.h"
 #import "Signal-Swift.h"
 #import "UIColor+OWS.h"
@@ -12,11 +14,104 @@
 #import "ViewControllerUtils.h"
 #import <SignalMessaging/OWSFormat.h>
 #import <SignalServiceKit/NSTimer+OWS.h>
+#import <SignalServiceKit/TSQuotedMessage.h>
 
 NS_ASSUME_NONNULL_BEGIN
 
 static void *kConversationInputTextViewObservingContext = &kConversationInputTextViewObservingContext;
 static const CGFloat ConversationInputToolbarBorderViewHeight = 0.5;
+
+@interface QuotedMessagePreviewView : UIView
+
+@property (nonatomic, readonly) UILabel *titleLabel;
+@property (nonatomic, readonly) UILabel *bodyLabel;
+@property (nonatomic, readonly) UIImageView *iconView;
+@property (nonatomic, readonly) UIButton *cancelButton;
+@property (nonatomic, readonly) UIView *quoteStripe;
+
+@end
+
+@implementation QuotedMessagePreviewView
+
+- (nullable UIImageView *)iconForMessage:(TSQuotedMessage *)message
+{
+    // FIXME TODO
+    return nil;
+}
+
+- (instancetype)initWithQuotedMessage:(TSQuotedMessage *)message
+{
+    self = [super initWithFrame:CGRectZero];
+    if (!self) {
+        return self;
+    }
+
+    _titleLabel = [UILabel new];
+    _titleLabel.text = [[Environment current].contactsManager displayNameForPhoneIdentifier:message.authorId];
+
+    _bodyLabel = [UILabel new];
+    _bodyLabel.text = message.body;
+
+    _iconView = [self iconForMessage:message];
+    if (_iconView) {
+        [self addSubview:_iconView];
+    }
+
+    _cancelButton = [UIButton buttonWithType:UIButtonTypeCustom];
+    UIImage *buttonImage =
+        [[UIImage imageNamed:@"quoted-message-cancel"] imageWithRenderingMode:UIImageRenderingModeAlwaysTemplate];
+    [_cancelButton setImage:buttonImage forState:UIControlStateNormal];
+    _cancelButton.imageView.tintColor = [UIColor ows_blackColor];
+
+    _quoteStripe = [UIView new];
+    BOOL isQuotingSelf = [message.authorId isEqualToString:[TSAccountManager localNumber]];
+
+    // FIXME actual colors TBD
+    _quoteStripe.backgroundColor = isQuotingSelf ? [UIColor orangeColor] : [UIColor blackColor];
+
+    UIView *contentContainer = [UIView containerView];
+
+    [self addSubview:_titleLabel];
+    [self addSubview:contentContainer];
+    [contentContainer addSubview:_bodyLabel];
+    [self addSubview:_cancelButton];
+    [self addSubview:_quoteStripe];
+
+    // Layout
+
+    CGFloat kLeadingMargin = 4;
+
+    [_quoteStripe autoPinEdgesToSuperviewEdgesWithInsets:UIEdgeInsetsZero excludingEdge:ALEdgeRight];
+    [_titleLabel autoPinEdgeToSuperviewEdge:ALEdgeTop];
+    [_titleLabel autoPinEdge:ALEdgeLeading toEdge:ALEdgeTrailing ofView:_quoteStripe withOffset:kLeadingMargin];
+    [_titleLabel autoPinEdge:ALEdgeTrailing toEdge:ALEdgeLeading ofView:_cancelButton];
+
+    if (_iconView) {
+        [contentContainer addSubview:_iconView];
+        [_iconView autoPinEdgeToSuperviewEdge:ALEdgeLeading];
+        [_iconView autoPinEdge:ALEdgeTrailing toEdge:ALEdgeTrailing ofView:_bodyLabel];
+        [_iconView autoPinHeightToSuperview];
+    } else {
+        [_bodyLabel autoPinEdge:ALEdgeLeading toEdge:ALEdgeTrailing ofView:_quoteStripe withOffset:kLeadingMargin];
+    }
+
+    [_bodyLabel autoPinHeightToSuperview];
+    [_bodyLabel autoPinEdgeToSuperviewEdge:ALEdgeTrailing];
+
+    [contentContainer autoPinEdge:ALEdgeTop toEdge:ALEdgeBottom ofView:_titleLabel];
+    [contentContainer autoPinEdge:ALEdgeTrailing toEdge:ALEdgeLeading ofView:_cancelButton];
+    [contentContainer autoPinEdgeToSuperviewEdge:ALEdgeBottom];
+
+    [_cancelButton autoPinEdgeToSuperviewEdge:ALEdgeTop];
+    [_cancelButton autoVCenterInSuperview];
+
+    return self;
+}
+
+@end
+
+#pragma mark -
+
 @interface ConversationInputToolbar () <UIGestureRecognizerDelegate, ConversationTextViewToolbarDelegate>
 
 @property (nonatomic, readonly) UIView *contentView;
@@ -34,6 +129,10 @@ @interface ConversationInputToolbar () <UIGestureRecognizerDelegate, Conversatio
 @property (nonatomic) CGFloat toolbarHeight;
 @property (nonatomic) CGFloat textViewHeight;
 
+#pragma mark -
+
+@property (nonatomic, nullable) QuotedMessagePreviewView *quotedMessageView;
+
 #pragma mark - Voice Memo Recording UI
 
 @property (nonatomic, nullable) UIView *voiceMemoUI;
@@ -46,6 +145,9 @@ @interface ConversationInputToolbar () <UIGestureRecognizerDelegate, Conversatio
 
 @end
 
+#pragma mark -
+
+
 #pragma mark -
 
 @implementation ConversationInputToolbar
@@ -226,6 +328,18 @@ - (void)setShouldShowVoiceMemoButton:(BOOL)shouldShowVoiceMemoButton
     [self ensureContentConstraints];
 }
 
+- (void)setQuotedMessage:(TSQuotedMessage *)quotedMessage
+{
+    QuotedMessagePreviewView *quotedMessageView =
+        [[QuotedMessagePreviewView alloc] initWithQuotedMessage:quotedMessage];
+
+    [self ensureContentConstraints];
+}
+
+- (void)clearQuotedMessage
+{
+}
+
 - (void)beginEditingTextMessage
 {
     [self.inputTextView becomeFirstResponder];
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationViewController.m b/Signal/src/ViewControllers/ConversationView/ConversationViewController.m
index 8854eb3f624..3fd6eb17471 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationViewController.m
+++ b/Signal/src/ViewControllers/ConversationView/ConversationViewController.m
@@ -3549,9 +3549,15 @@ - (void)updateGroupModelTo:(TSGroupModel *)newGroupModel successCompletion:(void
 
         groupThread.groupModel = newGroupModel;
         [groupThread saveWithTransaction:transaction];
-        message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                      inThread:groupThread
-                                              groupMetaMessage:TSGroupMessageUpdate];
+        message = [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                                     inThread:groupThread
+                                                                  messageBody:nil
+                                                                attachmentIds:[NSMutableArray new]
+                                                             expiresInSeconds:0
+                                                              expireStartedAt:0
+                                                               isVoiceMessage:NO
+                                                             groupMetaMessage:TSGroupMessageUpdate
+                                                                quotedMessage:nil];
         [message updateWithCustomMessage:updateGroupInfo transaction:transaction];
     }];
 
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m b/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m
index 486414d2b0d..90f5337e215 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIMessages.m
@@ -9,8 +9,14 @@
 #import "OWSTableViewController.h"
 #import "Signal-Swift.h"
 #import <Curve25519Kit/Randomness.h>
+#import <SignalMessaging/Environment.h>
 #import <SignalServiceKit/MIMETypeUtil.h>
+#import <SignalServiceKit/NSDate+OWS.h>
+#import <SignalServiceKit/OWSBatchMessageProcessor.h>
 #import <SignalServiceKit/OWSDisappearingConfigurationUpdateInfoMessage.h>
+#import <SignalServiceKit/OWSDisappearingMessagesConfiguration.h>
+#import <SignalServiceKit/OWSMessageUtils.h>
+#import <SignalServiceKit/OWSPrimaryStorage+SessionStore.h>
 #import <SignalServiceKit/OWSSyncGroupsRequestMessage.h>
 #import <SignalServiceKit/OWSVerificationStateChangeMessage.h>
 #import <SignalServiceKit/TSIncomingMessage.h>
@@ -87,10 +93,6 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
                         actionBlock:^{
                             [DebugUIMessages sendNTextMessagesInThread:thread];
                         }],
-        //        [OWSTableItem itemWithTitle:@"Send N Random Media (1/sec.)"
-        //                        actionBlock:^{
-        //                            [DebugUIMessages sendSelectedMediaTypeInThread:thread];
-        //                        }],
         [OWSTableItem itemWithTitle:@"Select Fake"
                         actionBlock:^{
                             [DebugUIMessages selectFakeAction:thread];
@@ -110,30 +112,6 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
                         actionBlock:^{
                             [DebugUIMessages performRandomActions:1000 thread:thread];
                         }],
-        [OWSTableItem itemWithTitle:@"Send 10 tiny text messages (1/sec.)"
-                        actionBlock:^{
-                            [DebugUIMessages sendTinyTextMessages:10 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Send 100 tiny text messages (1/sec.)"
-                        actionBlock:^{
-                            [DebugUIMessages sendTinyTextMessages:100 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Send 10 tiny attachments"
-                        actionBlock:^{
-                            [DebugUIMessages sendTinyAttachments:10 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Send 100 tiny attachments"
-                        actionBlock:^{
-                            [DebugUIMessages sendTinyAttachments:100 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Send 1,000 tiny attachments"
-                        actionBlock:^{
-                            [DebugUIMessages sendTinyAttachments:1000 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Send 3,000 tiny attachments"
-                        actionBlock:^{
-                            [DebugUIMessages sendTinyAttachments:3000 thread:thread];
-                        }],
         [OWSTableItem itemWithTitle:@"Create 10 fake messages"
                         actionBlock:^{
                             [DebugUIMessages sendFakeMessages:10 thread:thread];
@@ -178,30 +156,6 @@ - (nullable OWSTableSection *)sectionForThread:(nullable TSThread *)thread
                         actionBlock:^{
                             [DebugUIMessages sendFakeMessages:100 * 1000 thread:thread isTextOnly:YES];
                         }],
-        [OWSTableItem itemWithTitle:@"Create 1 fake unread messages"
-                        actionBlock:^{
-                            [DebugUIMessages createFakeUnreadMessages:1 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Create 10 fake unread messages"
-                        actionBlock:^{
-                            [DebugUIMessages createFakeUnreadMessages:10 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Create 10 fake large attachments"
-                        actionBlock:^{
-                            [DebugUIMessages createFakeLargeOutgoingAttachments:10 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Create 100 fake large attachments"
-                        actionBlock:^{
-                            [DebugUIMessages createFakeLargeOutgoingAttachments:100 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Create 1k fake large attachments"
-                        actionBlock:^{
-                            [DebugUIMessages createFakeLargeOutgoingAttachments:1000 thread:thread];
-                        }],
-        [OWSTableItem itemWithTitle:@"Create 10k fake large attachments"
-                        actionBlock:^{
-                            [DebugUIMessages createFakeLargeOutgoingAttachments:10000 thread:thread];
-                        }],
         [OWSTableItem itemWithTitle:@"Send text/x-signal-plain"
                         actionBlock:^{
                             [DebugUIMessages sendOversizeTextMessage:thread];
@@ -345,25 +299,6 @@ + (DebugUIMessagesAction *)sendTextMessagesActionInThread:(TSThread *)thread
                                    }];
 }
 
-+ (void)sendTinyTextMessageInThread:(TSThread *)thread counter:(NSUInteger)counter
-{
-    NSString *randomText = [[self randomText] substringToIndex:arc4random_uniform(4)];
-    NSString *text = [[[@(counter) description] stringByAppendingString:@" "] stringByAppendingString:randomText];
-    OWSMessageSender *messageSender = [Environment current].messageSender;
-    [ThreadUtil sendMessageWithText:text inThread:thread messageSender:messageSender];
-}
-
-+ (void)sendTinyTextMessages:(NSUInteger)counter thread:(TSThread *)thread
-{
-    if (counter < 1) {
-        return;
-    }
-    [self sendTinyTextMessageInThread:thread counter:counter];
-    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)1.f * NSEC_PER_SEC), dispatch_get_main_queue(), ^{
-        [self sendTinyTextMessages:counter - 1 thread:thread];
-    });
-}
-
 + (void)sendAttachment:(NSString *)filePath
                 thread:(TSThread *)thread
                  label:(NSString *)label
@@ -801,19 +736,10 @@ + (DebugUIMessagesAction *)fakeOutgoingMediaAction:(NSString *)labelParam
     OWSAssert(fakeAssetLoader);
     OWSAssert(thread);
 
-    NSString *label = labelParam;
-    if (hasCaption) {
-        label = [label stringByAppendingString:@" ðŸ”¤"];
-    }
-    if (messageState == TSOutgoingMessageStateUnsent) {
-        label = [label stringByAppendingString:@" (Unsent)"];
-    } else if (messageState == TSOutgoingMessageStateAttemptingOut) {
-        label = [label stringByAppendingString:@" (Sending)"];
-    } else if (messageState == TSOutgoingMessageStateSentToService) {
-        label = [label stringByAppendingString:@" (Sent)"];
-    } else {
-        OWSFail(@"%@ unknown message state.", self.logTag)
-    }
+    NSString *label = [labelParam stringByAppendingString:[self actionLabelForHasCaption:hasCaption
+                                                                    outgoingMessageState:messageState
+                                                                             isDelivered:NO
+                                                                                  isRead:NO]];
 
     return
         [DebugUIMessagesSingleAction actionWithLabel:label
@@ -853,47 +779,25 @@ + (void)createFakeOutgoingMedia:(NSUInteger)index
         NSString *sampleText = @"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, "
                                @"consectetur adipiscing elit.";
         messageBody = [[@(index).stringValue stringByAppendingString:@" "] stringByAppendingString:sampleText];
-
-        if (hasCaption) {
-            messageBody = [messageBody stringByAppendingString:@" ðŸ”¤"];
-        }
-        if (messageState == TSOutgoingMessageStateUnsent) {
-            messageBody = [messageBody stringByAppendingString:@" (Unsent)"];
-        } else if (messageState == TSOutgoingMessageStateAttemptingOut) {
-            messageBody = [messageBody stringByAppendingString:@" (Sending)"];
-        } else if (messageState == TSOutgoingMessageStateSentToService) {
-            messageBody = [messageBody stringByAppendingString:@" (Sent)"];
-        } else {
-            OWSFail(@"%@ unknown message state.", self.logTag)
-        }
+        messageBody = [messageBody stringByAppendingString:[self actionLabelForHasCaption:hasCaption
+                                                                     outgoingMessageState:messageState
+                                                                              isDelivered:NO
+                                                                                   isRead:NO]];
     }
 
-    TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:timestamp
-                                                                     inThread:thread
-                                                                  messageBody:messageBody
-                                                               isVoiceMessage:NO
-                                                             expiresInSeconds:0];
+    TSOutgoingMessage *message = [self createFakeOutgoingMessage:thread
+                                                     messageBody:messageBody
+                                                 fakeAssetLoader:fakeAssetLoader
+                                                    messageState:(TSOutgoingMessageState)messageState
+                                                     isDelivered:YES
+                                                          isRead:NO
+                                                   quotedMessage:nil
+                                                     transaction:transaction];
+
+    // This is a hack to "back-date" the message.
     [message setReceivedAtTimestamp:timestamp];
 
-    DataSource *dataSource = [DataSourcePath dataSourceWithFilePath:fakeAssetLoader.filePath];
-    NSString *filename = dataSource.sourceFilename;
-    // To support "fake missing" attachments, we sometimes lie about the
-    // length of the data.
-    UInt32 nominalDataLength = (UInt32)MAX((NSUInteger)1, dataSource.dataLength);
-    TSAttachmentStream *attachmentStream = [[TSAttachmentStream alloc] initWithContentType:fakeAssetLoader.mimeType
-                                                                                 byteCount:nominalDataLength
-                                                                            sourceFilename:filename];
-    NSError *error;
-    BOOL success = [attachmentStream writeData:dataSource.data error:&error];
-    OWSAssert(success && !error);
-
-    [attachmentStream saveWithTransaction:transaction];
-    [message.attachmentIds addObject:attachmentStream.uniqueId];
-    if (filename) {
-        message.attachmentFilenameMap[attachmentStream.uniqueId] = filename;
-    }
     [message saveWithTransaction:transaction];
-    [message updateWithMessageState:messageState transaction:transaction];
 }
 
 #pragma mark - Fake Incoming Media
@@ -1160,12 +1064,34 @@ + (DebugUIMessagesAction *)fakeIncomingMediaAction:(NSString *)labelParam
                                         prepareBlock:fakeAssetLoader.prepareBlock];
 }
 
-+ (void)createFakeIncomingMedia:(NSUInteger)index
-         isAttachmentDownloaded:(BOOL)isAttachmentDownloaded
-                     hasCaption:(BOOL)hasCaption
-                fakeAssetLoader:(DebugUIMessagesAssetLoader *)fakeAssetLoader
-                         thread:(TSThread *)thread
-                    transaction:(YapDatabaseReadWriteTransaction *)transaction
++ (TSIncomingMessage *)createFakeIncomingMedia:(NSUInteger)index
+                        isAttachmentDownloaded:(BOOL)isAttachmentDownloaded
+                                    hasCaption:(BOOL)hasCaption
+                               fakeAssetLoader:(DebugUIMessagesAssetLoader *)fakeAssetLoader
+                                        thread:(TSThread *)thread
+                                   transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    NSString *_Nullable caption = nil;
+    if (hasCaption) {
+        // We want a message body that is "more than one line on all devices,
+        // using all dynamic type sizes."
+        caption = @"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, "
+                  @"consectetur adipiscing elit.";
+    }
+    return [self createFakeIncomingMedia:index
+                  isAttachmentDownloaded:isAttachmentDownloaded
+                                 caption:caption
+                         fakeAssetLoader:fakeAssetLoader
+                                  thread:thread
+                             transaction:transaction];
+}
+
++ (TSIncomingMessage *)createFakeIncomingMedia:(NSUInteger)index
+                        isAttachmentDownloaded:(BOOL)isAttachmentDownloaded
+                                       caption:(nullable NSString *)caption
+                               fakeAssetLoader:(DebugUIMessagesAssetLoader *)fakeAssetLoader
+                                        thread:(TSThread *)thread
+                                   transaction:(YapDatabaseReadWriteTransaction *)transaction
 {
     OWSAssert(thread);
     OWSAssert(fakeAssetLoader.filePath);
@@ -1177,62 +1103,22 @@ + (void)createFakeIncomingMedia:(NSUInteger)index
     //    uint64_t timestamp = [NSDate ows_millisecondTimeStamp] - millisAgo;
 
     NSString *messageBody = nil;
-    if (hasCaption) {
-        // We want a message body that is "more than one line on all devices,
-        // using all dynamic type sizes."
-        NSString *sampleText = @"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit amet, "
-                               @"consectetur adipiscing elit.";
-        messageBody = [[@(index).stringValue stringByAppendingString:@" "] stringByAppendingString:sampleText];
+    if (caption) {
+        messageBody = [[@(index).stringValue stringByAppendingString:@" "] stringByAppendingString:caption];
 
-        if (hasCaption) {
-            messageBody = [messageBody stringByAppendingString:@" ðŸ”¤"];
-        }
+        messageBody = [messageBody stringByAppendingString:@" ðŸ”¤"];
 
         if (isAttachmentDownloaded) {
             messageBody = [messageBody stringByAppendingString:@" ðŸ‘"];
         }
     }
-    NSString *attachmentId;
-    if (isAttachmentDownloaded) {
-        DataSource *dataSource = [DataSourcePath dataSourceWithFilePath:fakeAssetLoader.filePath];
-        NSString *filename = dataSource.sourceFilename;
-        // To support "fake missing" attachments, we sometimes lie about the
-        // length of the data.
-        UInt32 nominalDataLength = (UInt32)MAX((NSUInteger)1, dataSource.dataLength);
-        TSAttachmentStream *attachmentStream = [[TSAttachmentStream alloc] initWithContentType:fakeAssetLoader.mimeType
-                                                                                     byteCount:nominalDataLength
-                                                                                sourceFilename:filename];
-        NSError *error;
-        BOOL success = [attachmentStream writeData:dataSource.data error:&error];
-        OWSAssert(success && !error);
 
-        [attachmentStream saveWithTransaction:transaction];
-        attachmentId = attachmentStream.uniqueId;
-    } else {
-        UInt32 filesize = 64;
-        TSAttachmentPointer *pointer =
-            [[TSAttachmentPointer alloc] initWithServerId:237391539706350548
-                                                      key:[self createRandomNSDataOfSize:filesize]
-                                                   digest:nil
-                                                byteCount:filesize
-                                              contentType:fakeAssetLoader.mimeType
-                                                    relay:@""
-                                           sourceFilename:fakeAssetLoader.filename
-                                           attachmentType:TSAttachmentTypeDefault];
-        pointer.state = TSAttachmentPointerStateFailed;
-        [pointer saveWithTransaction:transaction];
-        attachmentId = pointer.uniqueId;
-    }
-    TSIncomingMessage *message = [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                     inThread:thread
-                                                                     authorId:@"+19174054215"
-                                                               sourceDeviceId:0
-                                                                  messageBody:messageBody
-                                                                attachmentIds:@[
-                                                                    attachmentId,
-                                                                ]
-                                                             expiresInSeconds:0];
-    [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
+    return [self createFakeIncomingMessage:thread
+                               messageBody:messageBody
+                           fakeAssetLoader:fakeAssetLoader
+                    isAttachmentDownloaded:isAttachmentDownloaded
+                             quotedMessage:nil
+                               transaction:transaction];
 }
 
 #pragma mark - Fake Media
@@ -1774,15 +1660,52 @@ + (DebugUIMessagesAction *)fakeShortIncomingTextMessageAction:(TSThread *)thread
         unstaggeredActionBlock:^(NSUInteger index, YapDatabaseReadWriteTransaction *transaction) {
             NSString *messageBody =
                 [[@(index).stringValue stringByAppendingString:@" "] stringByAppendingString:[self randomText]];
-            TSIncomingMessage *message = [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                             inThread:thread
-                                                                             authorId:@"+19174054215"
-                                                                       sourceDeviceId:0
-                                                                          messageBody:messageBody];
-            [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
+            [self createFakeIncomingMessage:thread
+                                messageBody:messageBody
+                            fakeAssetLoader:nil
+                     isAttachmentDownloaded:NO
+                              quotedMessage:nil
+                                transaction:transaction];
         }];
 }
 
++ (SignalAttachment *)signalAttachmentForFilePath:(NSString *)filePath
+{
+    OWSAssert(filePath);
+
+    NSString *filename = [filePath lastPathComponent];
+    NSString *utiType = [MIMETypeUtil utiTypeForFileExtension:filename.pathExtension];
+    DataSource *_Nullable dataSource = [DataSourcePath dataSourceWithFilePath:filePath];
+    [dataSource setSourceFilename:filename];
+    SignalAttachment *attachment =
+        [SignalAttachment attachmentWithDataSource:dataSource dataUTI:utiType imageQuality:TSImageQualityOriginal];
+    if (arc4random_uniform(100) > 50) {
+        attachment.captionText = [self randomCaptionText];
+    }
+
+    OWSAssert(attachment);
+    if ([attachment hasError]) {
+        DDLogError(@"attachment[%@]: %@", [attachment sourceFilename], [attachment errorName]);
+        [DDLog flushLog];
+    }
+    OWSAssert(![attachment hasError]);
+    return attachment;
+}
+
++ (void)sendAttachment:(NSString *)filePath
+                thread:(TSThread *)thread
+               success:(nullable void (^)(void))success
+               failure:(nullable void (^)(void))failure
+{
+    OWSAssert(filePath);
+    OWSAssert(thread);
+
+    SignalAttachment *attachment = [self signalAttachmentForFilePath:filePath];
+    OWSMessageSender *messageSender = [Environment current].messageSender;
+    [ThreadUtil sendMessageWithAttachment:attachment inThread:thread messageSender:messageSender completion:nil];
+    success();
+}
+
 + (DebugUIMessagesAction *)fakeIncomingTextMessageAction:(TSThread *)thread text:(NSString *)text
 {
     OWSAssert(thread);
@@ -1791,12 +1714,12 @@ + (DebugUIMessagesAction *)fakeIncomingTextMessageAction:(TSThread *)thread text
                actionWithLabel:[NSString stringWithFormat:@"Fake Incoming Text Message (%@)", text]
         unstaggeredActionBlock:^(NSUInteger index, YapDatabaseReadWriteTransaction *transaction) {
             NSString *messageBody = [[@(index).stringValue stringByAppendingString:@" "] stringByAppendingString:text];
-            TSIncomingMessage *message = [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                             inThread:thread
-                                                                             authorId:@"+19174054215"
-                                                                       sourceDeviceId:0
-                                                                          messageBody:messageBody];
-            [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
+            [self createFakeIncomingMessage:thread
+                                messageBody:messageBody
+                            fakeAssetLoader:nil
+                     isAttachmentDownloaded:NO
+                              quotedMessage:nil
+                                transaction:transaction];
         }];
 }
 
@@ -1810,11 +1733,14 @@ + (DebugUIMessagesAction *)fakeOutgoingTextMessageAction:(TSThread *)thread
                actionWithLabel:[NSString stringWithFormat:@"Fake Incoming Text Message (%@)", text]
         unstaggeredActionBlock:^(NSUInteger index, YapDatabaseReadWriteTransaction *transaction) {
             NSString *messageBody = [[@(index).stringValue stringByAppendingString:@" "] stringByAppendingString:text];
-            TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                             inThread:thread
-                                                                          messageBody:messageBody];
-            [message saveWithTransaction:transaction];
-            [message updateWithMessageState:messageState transaction:transaction];
+            [self createFakeOutgoingMessage:thread
+                                messageBody:messageBody
+                            fakeAssetLoader:nil
+                               messageState:messageState
+                                isDelivered:NO
+                                     isRead:NO
+                              quotedMessage:nil
+                                transaction:transaction];
         }];
 }
 
@@ -1845,45 +1771,23 @@ + (DebugUIMessagesAction *)fakeShortOutgoingTextMessageAction:(TSThread *)thread
     OWSAssert(thread);
 
     NSString *label = @"Fake Short Incoming Text Message";
-    if (messageState == TSOutgoingMessageStateUnsent) {
-        label = [label stringByAppendingString:@" (Unsent)"];
-    } else if (messageState == TSOutgoingMessageStateAttemptingOut) {
-        label = [label stringByAppendingString:@" (Sending)"];
-    } else if (messageState == TSOutgoingMessageStateSentToService) {
-        if (isRead) {
-            label = [label stringByAppendingString:@" (Read)"];
-        } else if (isDelivered) {
-            label = [label stringByAppendingString:@" (Delivered)"];
-        } else {
-            label = [label stringByAppendingString:@" (Sent)"];
-        }
-    } else {
-        OWSFail(@"%@ unknown message state.", self.logTag)
-    }
+    label = [label stringByAppendingString:[self actionLabelForHasCaption:YES
+                                                     outgoingMessageState:messageState
+                                                              isDelivered:isDelivered
+                                                                   isRead:isRead]];
 
     return [DebugUIMessagesSingleAction
                actionWithLabel:label
         unstaggeredActionBlock:^(NSUInteger index, YapDatabaseReadWriteTransaction *transaction) {
             NSString *messageBody = [[@(index).stringValue stringByAppendingString:@" "] stringByAppendingString:text];
-            TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                             inThread:thread
-                                                                          messageBody:messageBody];
-            [message saveWithTransaction:transaction];
-            [message updateWithMessageState:messageState transaction:transaction];
-            if (isDelivered) {
-                NSString *_Nullable recipientId = thread.recipientIdentifiers.lastObject;
-                OWSAssert(recipientId.length > 0);
-                [message updateWithDeliveredToRecipientId:recipientId
-                                        deliveryTimestamp:@([NSDate ows_millisecondTimeStamp])
-                                              transaction:transaction];
-            }
-            if (isRead) {
-                NSString *_Nullable recipientId = thread.recipientIdentifiers.lastObject;
-                OWSAssert(recipientId.length > 0);
-                [message updateWithReadRecipientId:recipientId
-                                     readTimestamp:[NSDate ows_millisecondTimeStamp]
-                                       transaction:transaction];
-            }
+            [self createFakeOutgoingMessage:thread
+                                messageBody:messageBody
+                            fakeAssetLoader:nil
+                               messageState:messageState
+                                isDelivered:isDelivered
+                                     isRead:isRead
+                              quotedMessage:nil
+                                transaction:transaction];
         }];
 }
 
@@ -1958,6 +1862,289 @@ + (DebugUIMessagesAction *)fakeRandomTextAction:(TSThread *)thread
                                                        subactions:[self allFakeTextActions:thread includeLabels:NO]];
 }
 
+#pragma mark - Fake Quoted Replies
+
+//+ (DebugUIMessagesAction *)fakeIncomingQuotedReplyToIncomingAction:(TSThread *)thread
++ (DebugUIMessagesAction *)
+              fakeQuotedReplyAction:(TSThread *)thread
+                 quotedMessageLabel:(NSString *)quotedMessageLabel
+            isQuotedMessageIncoming:(BOOL)isQuotedMessageIncoming
+                  // Optional. At least one of quotedMessageBody and quotedMessageAssetLoader should be non-nil.
+                  quotedMessageBody:(nullable NSString *)quotedMessageBody
+           // Optional. At least one of quotedMessageBody and quotedMessageAssetLoader should be non-nil.
+           quotedMessageAssetLoader:(nullable DebugUIMessagesAssetLoader *)quotedMessageAssetLoader
+// Only applies if quotedMessageAssetLoader is non-nil.
+isQuotedMessageAttachmentDownloaded:(BOOL)isQuotedMessageAttachmentDownloaded
+          // Only applies if !isQuotedMessageIncoming.
+          quotedMessageMessageState:(TSOutgoingMessageState)quotedMessageMessageState
+                         replyLabel:(NSString *)replyLabel
+                    isReplyIncoming:(BOOL)isReplyIncoming
+                   replyMessageBody:(NSString *)replyMessageBody
+                  // Only applies if !isReplyIncoming.
+                  replyMessageState:(TSOutgoingMessageState)replyMessageState
+                   // Only applies if !isReplyIncoming.
+                   replyIsDelivered:(BOOL)replyIsDelivered
+                        // Only applies if !isReplyIncoming.
+                        replyIsRead:(BOOL)replyIsRead
+{
+    // fakeAssetLoader:[DebugUIMessagesAssetLoader jpegInstance]
+
+    OWSAssert(thread);
+
+    // Only applies if !isQuotedMessageIncoming.
+    BOOL quotedMessageIsDelivered = NO;
+    BOOL quotedMessageIsRead = NO;
+
+
+    //    NSString *_Nullable quotedMessageBody = [quotedMessageBodyParam ]
+    //    NSString *messageBody = nil;
+    //    if (hasCaption) {
+    //        // We want a message body that is "more than one line on all devices,
+    //        // using all dynamic type sizes."
+    //        NSString *sampleText = @"Lorem ipsum dolor sit amet, consectetur adipiscing elit. Lorem ipsum dolor sit
+    //        amet, "
+    //        @"consectetur adipiscing elit.";
+    //        messageBody = [[label stringByAppendingString:@" "] stringByAppendingString:sampleText];
+    //
+    //        messageBody = [messageBody stringByAppendingString:@" ðŸ”¤"];
+    //    }
+    //    attachment.captionText = messageBody;
+
+    NSMutableString *label = [NSMutableString new];
+    [label appendString:@"Quoted Reply ("];
+    [label appendString:replyLabel];
+    if (isReplyIncoming) {
+    } else {
+        [label appendString:[self actionLabelForHasCaption:NO
+                                      outgoingMessageState:replyMessageState
+                                               isDelivered:replyIsDelivered
+                                                    isRead:replyIsRead]];
+    }
+    [label appendString:@") to ("];
+    [label appendString:quotedMessageLabel];
+    if (quotedMessageAssetLoader) {
+        [label appendString:@" ðŸ“Ž"];
+    }
+    if (isQuotedMessageIncoming) {
+        if (quotedMessageAssetLoader && isQuotedMessageAttachmentDownloaded) {
+            [label appendString:@" Downloaded"];
+        }
+    } else {
+        [label appendString:[self actionLabelForHasCaption:quotedMessageBody.length > 0
+                                      outgoingMessageState:quotedMessageMessageState
+                                               isDelivered:quotedMessageIsDelivered
+                                                    isRead:quotedMessageIsRead]];
+    }
+    [label appendString:@")"];
+
+    //    NSString *label = labelParam;
+    //    if (hasCaption) {
+    //        label = [label stringByAppendingString:@" ðŸ”¤"];
+    //    }
+    //    if (messageState == TSOutgoingMessageStateUnsent) {
+    //        label = [label stringByAppendingString:@" (Unsent)"];
+    //    } else if (messageState == TSOutgoingMessageStateAttemptingOut) {
+    //        label = [label stringByAppendingString:@" (Sending)"];
+    //    } else if (messageState == TSOutgoingMessageStateSentToService) {
+    //        label = [label stringByAppendingString:@" (Sent)"];
+    //    } else {
+    //        OWSFail(@"%@ unknown message state.", self.logTag)
+    //    }
+    //    replyLabel = [replyLabel stringByAppendingString:[self actionLabelForHasCaption:NO
+    //                                                     outgoingMessageState:messageState
+    //                                                              isDelivered:isDelivered
+    //                                                                   isRead:isRead]];
+
+    return [DebugUIMessagesSingleAction
+               actionWithLabel:label
+        unstaggeredActionBlock:^(NSUInteger index, YapDatabaseReadWriteTransaction *transaction) {
+            TSQuotedMessage *_Nullable quotedMessage = nil;
+            if (isQuotedMessageIncoming) {
+                TSIncomingMessage *_Nullable messageToQuote = nil;
+                messageToQuote = [self createFakeIncomingMessage:thread
+                                                     messageBody:quotedMessageBody
+                                                 fakeAssetLoader:quotedMessageAssetLoader
+                                          isAttachmentDownloaded:isQuotedMessageAttachmentDownloaded
+                                                   quotedMessage:nil
+                                                     transaction:transaction];
+                //                    if (quotedMessageAssetLoader) {
+                //                        // Attachment, w/ or w/o caption.
+                //                        messageToQuote =
+                //                        [self createFakeIncomingMedia:index
+                //                               isAttachmentDownloaded:isQuotedMessageAttachmentDownloaded
+                //                                              caption:quotedMessageBody
+                //                                      fakeAssetLoader:quotedMessageAssetLoader
+                //                                               thread:thread
+                //                                          transaction:transaction];
+                //                    } else {
+                //                        // Text-only
+                //                        messageToQuote =
+                //                        [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:[NSDate
+                //                        ows_millisecondTimeStamp]
+                //                                                                           inThread:thread
+                //                                                                           authorId:@"+19174054215"
+                //                                                                     sourceDeviceId:0
+                //                                                                        messageBody:quotedMessageBody
+                //                                                                      attachmentIds:@[]
+                //                                                                   expiresInSeconds:0
+                //                                                                      quotedMessage:nil];
+                //                        [messageToQuote markAsReadWithTransaction:transaction sendReadReceipt:NO
+                //                        updateExpiration:NO];
+                //                    }
+                quotedMessage =
+                    [OWSMessageUtils quotedMessageForIncomingMessage:messageToQuote transaction:transaction];
+            } else {
+                TSOutgoingMessage *_Nullable messageToQuote = [self createFakeOutgoingMessage:thread
+                                                                                  messageBody:quotedMessageBody
+                                                                              fakeAssetLoader:quotedMessageAssetLoader
+                                                                                 messageState:quotedMessageMessageState
+                                                                                  isDelivered:quotedMessageIsDelivered
+                                                                                       isRead:quotedMessageIsRead
+                                                                                quotedMessage:nil
+                                                                                  transaction:transaction];
+                quotedMessage = [OWSMessageUtils quotedMessageForOutgoingMessage:(TSOutgoingMessage *)messageToQuote
+                                                                     transaction:transaction];
+            }
+            OWSAssert(quotedMessage);
+
+            //            isReplyIncoming:(BOOL)isReplyIncoming
+            //            replyMessageBody:(NSString *)replyMessageBody
+            //                // Only applies if !isReplyIncoming.
+            //            replyMessageState:(TSOutgoingMessageState)replyMessageState
+            //                // Only applies if !isReplyIncoming.
+            //            replyIsDelivered:(BOOL)replyIsDelivered
+            //                // Only applies if !isReplyIncoming.
+            //            replyIsRead:(BOOL)replyIsRead
+            if (isReplyIncoming) {
+                [self createFakeIncomingMessage:thread
+                                    messageBody:replyMessageBody
+                                fakeAssetLoader:nil
+                         isAttachmentDownloaded:NO
+                                  quotedMessage:quotedMessage
+                                    transaction:transaction];
+            } else {
+                [self createFakeOutgoingMessage:thread
+                                    messageBody:replyMessageBody
+                                fakeAssetLoader:nil
+                                   messageState:replyMessageState
+                                    isDelivered:replyIsDelivered
+                                         isRead:replyIsRead
+                                  quotedMessage:quotedMessage
+                                    transaction:transaction];
+            }
+
+
+            //                NSString *replyText = [@"Some reply: " stringByAppendingString:[self randomText]];
+            //                TSOutgoingMessage *replyMessage =
+            //                [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate
+            //                ows_millisecondTimeStamp]
+            //                                                                   inThread:thread
+            //                                                                messageBody:replyText
+            //                                                              attachmentIds:[NSMutableArray new]
+            //                                                           expiresInSeconds:0
+            //                                                            expireStartedAt:0
+            //                                                             isVoiceMessage:NO
+            //                                                           groupMetaMessage:TSGroupMessageNone
+            //                                                              quotedMessage:quotedMessage];
+            //                [replyMessage saveWithTransaction:transaction];
+            //                [replyMessage updateWithMessageState:TSOutgoingMessageStateUnsent
+            //                transaction:transaction];
+        }];
+}
+
++ (NSArray<DebugUIMessagesAction *> *)allFakeQuotedReplyActions:(TSThread *)thread includeLabels:(BOOL)includeLabels
+{
+    OWSAssert(thread);
+
+    //    NSArray<NSString *> *messageBodies = @[
+    //                                           @"Hi",
+    //                                           @"1ï¸âƒ£",
+    //                                           @"1ï¸âƒ£2ï¸âƒ£",
+    //                                           @"1ï¸âƒ£2ï¸âƒ£3ï¸âƒ£",
+    //                                           @"è½",
+    //                                           @"ï·½",
+    //                                           ];
+
+    NSMutableArray<DebugUIMessagesAction *> *actions = [NSMutableArray new];
+
+    if (includeLabels) {
+        [actions addObject:[self fakeIncomingTextMessageAction:thread
+                                                          text:@"âš ï¸ Incoming Quoted Reply To Incoming âš ï¸"]];
+    }
+    //    [actions addObject:[self fakeShortIncomingTextMessageAction:thread]];
+    [actions addObjectsFromArray:@[
+        [self fakeQuotedReplyAction:thread
+                             quotedMessageLabel:@"Short Text"
+                        isQuotedMessageIncoming:YES
+                              quotedMessageBody:@"lorem"
+                       quotedMessageAssetLoader:nil
+            isQuotedMessageAttachmentDownloaded:NO
+                      quotedMessageMessageState:TSOutgoingMessageStateUnsent
+                                     replyLabel:@"Short Text"
+                                isReplyIncoming:YES
+                               replyMessageBody:@"ipsum"
+                              replyMessageState:TSOutgoingMessageStateUnsent
+                               replyIsDelivered:NO
+                                    replyIsRead:NO],
+    ]];
+
+    //    for (NSString *messageBody in messageBodies) {
+    //        [actions addObject:[self fakeIncomingTextMessageAction:thread text:messageBody]];
+    //    }
+    //
+    //    if (includeLabels) {
+    //        [actions addObject:[self fakeOutgoingTextMessageAction:thread
+    //                                                  messageState:TSOutgoingMessageStateSentToService
+    //                                                          text:@"âš ï¸ Outgoing Statuses âš ï¸"]];
+    //    }
+    //    [actions addObjectsFromArray:@[
+    //                                   [self fakeShortOutgoingTextMessageAction:thread
+    //                                   messageState:TSOutgoingMessageStateUnsent], [self
+    //                                   fakeShortOutgoingTextMessageAction:thread
+    //                                   messageState:TSOutgoingMessageStateAttemptingOut], [self
+    //                                   fakeShortOutgoingTextMessageAction:thread
+    //                                   messageState:TSOutgoingMessageStateSentToService], [self
+    //                                   fakeShortOutgoingTextMessageAction:thread
+    //                                                               messageState:TSOutgoingMessageStateSentToService
+    //                                                                isDelivered:YES
+    //                                                                     isRead:NO],
+    //                                   [self fakeShortOutgoingTextMessageAction:thread
+    //                                                               messageState:TSOutgoingMessageStateSentToService
+    //                                                                isDelivered:YES
+    //                                                                     isRead:YES],
+    //                                   ]];
+    //
+    //    if (includeLabels) {
+    //        [actions addObject:[self fakeOutgoingTextMessageAction:thread
+    //                                                  messageState:TSOutgoingMessageStateSentToService
+    //                                                          text:@"âš ï¸ Outgoing Message Bodies âš ï¸"]];
+    //    }
+    //    for (NSString *messageBody in messageBodies) {
+    //        [actions addObject:[self fakeOutgoingTextMessageAction:thread
+    //                                                  messageState:TSOutgoingMessageStateSentToService
+    //                                                          text:messageBody]];
+    //    }
+    return actions;
+}
+
++ (DebugUIMessagesAction *)allQuotedReplyAction:(TSThread *)thread
+{
+    OWSAssert(thread);
+
+    return
+        [DebugUIMessagesGroupAction allGroupActionWithLabel:@"All Quoted Reply"
+                                                 subactions:[self allFakeQuotedReplyActions:thread includeLabels:YES]];
+}
+
++ (DebugUIMessagesAction *)randomQuotedReplyAction:(TSThread *)thread
+{
+    OWSAssert(thread);
+
+    return [DebugUIMessagesGroupAction
+        randomGroupActionWithLabel:@"Random Quoted Reply"
+                        subactions:[self allFakeQuotedReplyActions:thread includeLabels:NO]];
+}
+
 #pragma mark - Exemplary
 
 + (NSArray<DebugUIMessagesAction *> *)allFakeActions:(TSThread *)thread includeLabels:(BOOL)includeLabels
@@ -2438,21 +2625,6 @@ + (NSString *)randomText
     return randomText;
 }
 
-+ (void)createFakeUnreadMessages:(NSUInteger)counter thread:(TSThread *)thread
-{
-    [OWSPrimaryStorage.dbReadWriteConnection readWriteWithBlock:^(YapDatabaseReadWriteTransaction *transaction) {
-        for (NSUInteger i = 0; i < counter; i++) {
-            NSString *randomText = [self randomText];
-            TSIncomingMessage *message = [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                             inThread:thread
-                                                                             authorId:@"+19174054215"
-                                                                       sourceDeviceId:0
-                                                                          messageBody:randomText];
-            [message saveWithTransaction:transaction];
-        }
-    }];
-}
-
 + (void)createFakeThreads:(NSUInteger)threadCount withFakeMessages:(NSUInteger)messageCount
 {
     [DebugUIContacts
@@ -2500,6 +2672,7 @@ + (void)sendFakeMessages:(NSUInteger)counter thread:(TSThread *)thread isTextOnl
     }
 }
 
+// TODO: Remove.
 + (void)sendFakeMessages:(NSUInteger)counter
                   thread:(TSThread *)thread
               isTextOnly:(BOOL)isTextOnly
@@ -2512,21 +2685,26 @@ + (void)sendFakeMessages:(NSUInteger)counter
         switch (arc4random_uniform(isTextOnly ? 2 : 4)) {
             case 0: {
                 TSIncomingMessage *message =
-                    [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                        inThread:thread
-                                                        authorId:@"+19174054215"
-                                                  sourceDeviceId:0
-                                                     messageBody:randomText];
+                    [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                                       inThread:thread
+                                                                       authorId:@"+19174054215"
+                                                                 sourceDeviceId:0
+                                                                    messageBody:randomText
+                                                                  attachmentIds:@[]
+                                                               expiresInSeconds:0
+                                                                  quotedMessage:nil];
                 [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
                 break;
             }
             case 1: {
-                TSOutgoingMessage *message =
-                    [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                        inThread:thread
-                                                     messageBody:randomText];
-                [message saveWithTransaction:transaction];
-                [message updateWithMessageState:TSOutgoingMessageStateUnsent transaction:transaction];
+                [self createFakeOutgoingMessage:thread
+                                    messageBody:randomText
+                                fakeAssetLoader:nil
+                                   messageState:TSOutgoingMessageStateUnsent
+                                    isDelivered:NO
+                                         isRead:NO
+                                  quotedMessage:nil
+                                    transaction:transaction];
                 break;
             }
             case 2: {
@@ -2543,26 +2721,20 @@ + (void)sendFakeMessages:(NSUInteger)counter
                 pointer.state = TSAttachmentPointerStateFailed;
                 [pointer saveWithTransaction:transaction];
                 TSIncomingMessage *message =
-                    [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                        inThread:thread
-                                                        authorId:@"+19174054215"
-                                                  sourceDeviceId:0
-                                                     messageBody:nil
-                                                   attachmentIds:@[
-                                                       pointer.uniqueId,
-                                                   ]
-                                                expiresInSeconds:0];
+                    [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                                       inThread:thread
+                                                                       authorId:@"+19174054215"
+                                                                 sourceDeviceId:0
+                                                                    messageBody:nil
+                                                                  attachmentIds:@[
+                                                                      pointer.uniqueId,
+                                                                  ]
+                                                               expiresInSeconds:0
+                                                                  quotedMessage:nil];
                 [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
                 break;
             }
             case 3: {
-                TSOutgoingMessage *message =
-                    [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                        inThread:thread
-                                                     messageBody:nil
-                                                  isVoiceMessage:NO
-                                                expiresInSeconds:0];
-
                 NSString *filename = @"test.mp3";
                 UInt32 filesize = 16;
 
@@ -2573,14 +2745,17 @@ + (void)sendFakeMessages:(NSUInteger)counter
                 NSError *error;
                 BOOL success = [attachmentStream writeData:[self createRandomNSDataOfSize:filesize] error:&error];
                 OWSAssert(success && !error);
-
                 [attachmentStream saveWithTransaction:transaction];
-                [message.attachmentIds addObject:attachmentStream.uniqueId];
-                if (filename) {
-                    message.attachmentFilenameMap[attachmentStream.uniqueId] = filename;
-                }
-                [message saveWithTransaction:transaction];
-                [message updateWithMessageState:TSOutgoingMessageStateUnsent transaction:transaction];
+
+                [self createFakeOutgoingMessage:thread
+                                    messageBody:nil
+                                   attachmentId:attachmentStream.uniqueId
+                                       filename:filename
+                                   messageState:TSOutgoingMessageStateUnsent
+                                    isDelivered:NO
+                                         isRead:NO
+                                  quotedMessage:nil
+                                    transaction:transaction];
                 break;
             }
         }
@@ -2589,65 +2764,6 @@ + (void)sendFakeMessages:(NSUInteger)counter
 
 #pragma mark -
 
-+ (void)createFakeLargeOutgoingAttachments:(NSUInteger)counter thread:(TSThread *)thread
-{
-    if (counter < 1) {
-        return;
-    }
-
-    [OWSPrimaryStorage.dbReadWriteConnection readWriteWithBlock:^(YapDatabaseReadWriteTransaction *transaction) {
-        TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                         inThread:thread
-                                                                      messageBody:nil
-                                                                   isVoiceMessage:NO
-                                                                 expiresInSeconds:0];
-        DDLogError(@"%@ sendFakeMessages outgoing attachment timestamp: %llu.", self.logTag, message.timestamp);
-
-        NSString *filename = @"test.mp3";
-        UInt32 filesize = 8 * 1024 * 1024;
-
-        TSAttachmentStream *attachmentStream =
-            [[TSAttachmentStream alloc] initWithContentType:@"audio/mp3" byteCount:filesize sourceFilename:filename];
-
-        NSError *error;
-        BOOL success = [attachmentStream writeData:[self createRandomNSDataOfSize:filesize] error:&error];
-        OWSAssert(success && !error);
-
-        [attachmentStream saveWithTransaction:transaction];
-        [message.attachmentIds addObject:attachmentStream.uniqueId];
-        if (filename) {
-            message.attachmentFilenameMap[attachmentStream.uniqueId] = filename;
-        }
-        [message updateWithMessageState:TSOutgoingMessageStateUnsent transaction:transaction];
-        [message saveWithTransaction:transaction];
-    }];
-
-    dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
-        [self createFakeLargeOutgoingAttachments:counter - 1 thread:thread];
-    });
-}
-
-+ (void)sendTinyAttachments:(NSUInteger)counter thread:(TSThread *)thread
-{
-    if (counter < 1) {
-        return;
-    }
-
-    NSArray<NSString *> *utis = @[
-        (NSString *)kUTTypePDF,
-        (NSString *)kUTTypeMP3,
-        (NSString *)kUTTypeGIF,
-        (NSString *)kUTTypeMPEG4,
-        (NSString *)kUTTypeJPEG,
-    ];
-    NSString *uti = utis[(NSUInteger)arc4random_uniform((uint32_t)utis.count)];
-    [self sendRandomAttachment:thread uti:uti length:16];
-
-    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)1.f * NSEC_PER_SEC), dispatch_get_main_queue(), ^{
-        [self sendTinyAttachments:counter - 1 thread:thread];
-    });
-}
-
 + (void)createNewGroups:(NSUInteger)counter recipientId:(NSString *)recipientId
 {
     if (counter < 1) {
@@ -2670,9 +2786,16 @@ + (void)createNewGroups:(NSUInteger)counter recipientId:(NSString *)recipientId
         }];
     OWSAssert(thread);
 
-    TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                     inThread:thread
-                                                             groupMetaMessage:TSGroupMessageNew];
+    TSOutgoingMessage *message =
+        [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                           inThread:thread
+                                                        messageBody:nil
+                                                      attachmentIds:[NSMutableArray new]
+                                                   expiresInSeconds:0
+                                                    expireStartedAt:0
+                                                     isVoiceMessage:NO
+                                                   groupMetaMessage:TSGroupMessageNew
+                                                      quotedMessage:nil];
     [message updateWithCustomMessage:NSLocalizedString(@"GROUP_CREATED", nil)];
 
     OWSMessageSender *messageSender = [Environment current].messageSender;
@@ -2920,12 +3043,16 @@ + (void)insertAndDeleteNewOutgoingMessages:(NSUInteger)count
         NSString *text = [self randomText];
         OWSDisappearingMessagesConfiguration *configuration =
             [OWSDisappearingMessagesConfiguration fetchObjectWithUniqueID:thread.uniqueId transaction:transaction];
-        TSOutgoingMessage *message =
-        [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                            inThread:thread
-                                         messageBody:text
-                                       attachmentIds:[NSMutableArray new]
-                                    expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds : 0)];
+        TSOutgoingMessage *message = [[TSOutgoingMessage alloc]
+            initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                    inThread:thread
+                                 messageBody:text
+                               attachmentIds:[NSMutableArray new]
+                            expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds
+                                                                      : 0)expireStartedAt:0
+                              isVoiceMessage:NO
+                            groupMetaMessage:TSGroupMessageNone
+                               quotedMessage:nil];
         DDLogError(@"%@ insertAndDeleteNewOutgoingMessages timestamp: %llu.", self.logTag, message.timestamp);
         [messages addObject:message];
     }
@@ -2950,12 +3077,16 @@ + (void)resurrectNewOutgoingMessages1:(NSUInteger)count
         OWSDisappearingMessagesConfiguration *configuration =
             [OWSDisappearingMessagesConfiguration fetchObjectWithUniqueID:thread.uniqueId
                                                               transaction:initialTransaction];
-        TSOutgoingMessage *message =
-        [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                            inThread:thread
-                                         messageBody:text
-                                       attachmentIds:[NSMutableArray new]
-                                    expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds : 0)];
+        TSOutgoingMessage *message = [[TSOutgoingMessage alloc]
+            initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                    inThread:thread
+                                 messageBody:text
+                               attachmentIds:[NSMutableArray new]
+                            expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds
+                                                                      : 0)expireStartedAt:0
+                              isVoiceMessage:NO
+                            groupMetaMessage:TSGroupMessageNone
+                               quotedMessage:nil];
         DDLogError(@"%@ resurrectNewOutgoingMessages1 timestamp: %llu.", self.logTag, message.timestamp);
         [messages addObject:message];
     }
@@ -2989,12 +3120,16 @@ + (void)resurrectNewOutgoingMessages2:(NSUInteger)count
         OWSDisappearingMessagesConfiguration *configuration =
             [OWSDisappearingMessagesConfiguration fetchObjectWithUniqueID:thread.uniqueId
                                                               transaction:initialTransaction];
-        TSOutgoingMessage *message =
-        [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                            inThread:thread
-                                         messageBody:text
-                                       attachmentIds:[NSMutableArray new]
-                                    expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds : 0)];
+        TSOutgoingMessage *message = [[TSOutgoingMessage alloc]
+            initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                    inThread:thread
+                                 messageBody:text
+                               attachmentIds:[NSMutableArray new]
+                            expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds
+                                                                      : 0)expireStartedAt:0
+                              isVoiceMessage:NO
+                            groupMetaMessage:TSGroupMessageNone
+                               quotedMessage:nil];
         DDLogError(@"%@ resurrectNewOutgoingMessages2 timestamp: %llu.", self.logTag, message.timestamp);
         [messages addObject:message];
     }
@@ -3052,18 +3187,27 @@ + (void)createTimestampMessagesInThread:(TSThread *)thread
             NSString *randomText = [self randomText];
             {
                 TSIncomingMessage *message =
-                    [[TSIncomingMessage alloc] initWithTimestamp:timestamp.unsignedLongLongValue
-                                                        inThread:thread
-                                                        authorId:recipientId
-                                                  sourceDeviceId:0
-                                                     messageBody:randomText];
+                    [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:timestamp.unsignedLongLongValue
+                                                                       inThread:thread
+                                                                       authorId:recipientId
+                                                                 sourceDeviceId:0
+                                                                    messageBody:randomText
+                                                                  attachmentIds:[NSMutableArray new]
+                                                               expiresInSeconds:0
+                                                                  quotedMessage:nil];
                 [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
             }
             {
                 TSOutgoingMessage *message =
-                    [[TSOutgoingMessage alloc] initWithTimestamp:timestamp.unsignedLongLongValue
-                                                        inThread:thread
-                                                     messageBody:randomText];
+                    [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:timestamp.unsignedLongLongValue
+                                                                       inThread:thread
+                                                                    messageBody:randomText
+                                                                  attachmentIds:[NSMutableArray new]
+                                                               expiresInSeconds:0
+                                                                expireStartedAt:0
+                                                                 isVoiceMessage:NO
+                                                               groupMetaMessage:TSGroupMessageNone
+                                                                  quotedMessage:nil];
                 [message saveWithTransaction:transaction];
                 [message updateWithMessageState:TSOutgoingMessageStateSentToService transaction:transaction];
                 [message updateWithSentRecipient:recipientId transaction:transaction];
@@ -3093,14 +3237,12 @@ + (void)testIndicScriptsInThread:(TSThread *)thread
                 //        DDLogInfo(@"%@ %@", self.logTag, string);
 
                 {
-                    TSIncomingMessage *message =
-                        [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                            inThread:thread
-                                                            authorId:@"+19174054215"
-                                                      sourceDeviceId:0
-                                                         messageBody:string];
-                    [message saveWithTransaction:transaction];
-                    [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
+                    [self createFakeIncomingMessage:thread
+                                        messageBody:string
+                                    fakeAssetLoader:nil
+                             isAttachmentDownloaded:NO
+                                      quotedMessage:nil
+                                        transaction:transaction];
                 }
                 {
                     NSString *recipientId = @"+19174054215";
@@ -3134,14 +3276,12 @@ + (void)testZalgoTextInThread:(TSThread *)thread
                 DDLogInfo(@"%@ sending zalgo", self.logTag);
 
                 {
-                    TSIncomingMessage *message =
-                        [[TSIncomingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                            inThread:thread
-                                                            authorId:@"+19174054215"
-                                                      sourceDeviceId:0
-                                                         messageBody:string];
-                    [message saveWithTransaction:transaction];
-                    [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
+                    [self createFakeIncomingMessage:thread
+                                        messageBody:string
+                                    fakeAssetLoader:nil
+                             isAttachmentDownloaded:NO
+                                      quotedMessage:nil
+                                        transaction:transaction];
                 }
                 {
                     NSString *recipientId = @"+19174054215";
@@ -3207,6 +3347,214 @@ + (void)deleteAllMessagesInThread:(TSThread *)thread
         }];
 }
 
+#pragma mark - Utility
+
++ (NSString *)actionLabelForHasCaption:(BOOL)hasCaption
+                  outgoingMessageState:(TSOutgoingMessageState)outgoingMessageState
+                           isDelivered:(BOOL)isDelivered
+                                isRead:(BOOL)isRead
+{
+    NSMutableString *label = [NSMutableString new];
+    if (hasCaption) {
+        [label appendString:@" ðŸ”¤"];
+    }
+    if (outgoingMessageState == TSOutgoingMessageStateUnsent) {
+        [label appendString:@" (Unsent)"];
+    } else if (outgoingMessageState == TSOutgoingMessageStateAttemptingOut) {
+        [label appendString:@" (Sending)"];
+    } else if (outgoingMessageState == TSOutgoingMessageStateSentToService) {
+        if (isRead) {
+            [label appendString:@" (Read)"];
+        } else if (isDelivered) {
+            [label appendString:@" (Delivered)"];
+        } else {
+            [label appendString:@" (Sent)"];
+        }
+    } else {
+        OWSFail(@"%@ unknown message state.", self.logTag)
+    }
+    return label;
+}
+
++ (TSOutgoingMessage *)createFakeOutgoingMessage:(TSThread *)thread
+                                     messageBody:(nullable NSString *)messageBody
+                                 fakeAssetLoader:(nullable DebugUIMessagesAssetLoader *)fakeAssetLoader
+                                    messageState:(TSOutgoingMessageState)messageState
+                                     isDelivered:(BOOL)isDelivered
+                                          isRead:(BOOL)isRead
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage
+                                     transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    OWSAssert(thread);
+    OWSAssert(fakeAssetLoader);
+
+    TSAttachment *_Nullable attachment = nil;
+    if (fakeAssetLoader) {
+        attachment = [self createFakeAttachment:fakeAssetLoader isAttachmentDownloaded:YES transaction:transaction];
+    }
+
+    return [self createFakeOutgoingMessage:thread
+                               messageBody:messageBody
+                              attachmentId:attachment.uniqueId
+                                  filename:fakeAssetLoader.filename
+                              messageState:messageState
+                               isDelivered:isDelivered
+                                    isRead:isRead
+                             quotedMessage:quotedMessage
+                               transaction:transaction];
+}
+
++ (TSOutgoingMessage *)createFakeOutgoingMessage:(TSThread *)thread
+                                     messageBody:(nullable NSString *)messageBody
+                                    attachmentId:(nullable NSString *)attachmentId
+                                        filename:(nullable NSString *)filename
+                                    messageState:(TSOutgoingMessageState)messageState
+                                     isDelivered:(BOOL)isDelivered
+                                          isRead:(BOOL)isRead
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage
+                                     transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    OWSAssert(thread);
+    OWSAssert(transaction);
+    OWSAssert(messageBody.length > 0 || attachmentId.length > 0);
+
+    NSMutableArray<NSString *> *attachmentIds = [NSMutableArray new];
+    if (attachmentId) {
+        [attachmentIds addObject:attachmentId];
+    }
+
+    TSOutgoingMessage *message =
+        [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                           inThread:thread
+                                                        messageBody:messageBody
+                                                      attachmentIds:attachmentIds
+                                                   expiresInSeconds:0
+                                                    expireStartedAt:0
+                                                     isVoiceMessage:NO
+                                                   groupMetaMessage:TSGroupMessageNone
+                                                      quotedMessage:quotedMessage];
+
+    if (attachmentId.length > 0 && filename.length > 0) {
+        message.attachmentFilenameMap[attachmentId] = filename;
+    }
+
+    [message saveWithTransaction:transaction];
+    [message updateWithMessageState:messageState transaction:transaction];
+    if (isDelivered) {
+        NSString *_Nullable recipientId = thread.recipientIdentifiers.lastObject;
+        OWSAssert(recipientId.length > 0);
+        [message updateWithDeliveredToRecipientId:recipientId
+                                deliveryTimestamp:@([NSDate ows_millisecondTimeStamp])
+                                      transaction:transaction];
+    }
+    if (isRead) {
+        NSString *_Nullable recipientId = thread.recipientIdentifiers.lastObject;
+        OWSAssert(recipientId.length > 0);
+        [message updateWithReadRecipientId:recipientId
+                             readTimestamp:[NSDate ows_millisecondTimeStamp]
+                               transaction:transaction];
+    }
+}
+
++ (TSIncomingMessage *)createFakeIncomingMessage:(TSThread *)thread
+                                     messageBody:(nullable NSString *)messageBody
+                                 fakeAssetLoader:(nullable DebugUIMessagesAssetLoader *)fakeAssetLoader
+                          isAttachmentDownloaded:(BOOL)isAttachmentDownloaded
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage
+                                     transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    OWSAssert(thread);
+    OWSAssert(fakeAssetLoader);
+
+    TSAttachment *_Nullable attachment = nil;
+    if (fakeAssetLoader) {
+        attachment = [self createFakeAttachment:fakeAssetLoader
+                         isAttachmentDownloaded:isAttachmentDownloaded
+                                    transaction:transaction];
+    }
+
+    return [self createFakeIncomingMessage:thread
+                               messageBody:messageBody
+                              attachmentId:attachment.uniqueId
+                                  filename:fakeAssetLoader.filename
+                    isAttachmentDownloaded:isAttachmentDownloaded
+                             quotedMessage:quotedMessage
+                               transaction:transaction];
+}
+
++ (TSIncomingMessage *)createFakeIncomingMessage:(TSThread *)thread
+                                     messageBody:(nullable NSString *)messageBody
+                                    attachmentId:(nullable NSString *)attachmentId
+                                        filename:(nullable NSString *)filename
+                          isAttachmentDownloaded:(BOOL)isAttachmentDownloaded
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage
+                                     transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    OWSAssert(thread);
+    OWSAssert(transaction);
+    OWSAssert(messageBody.length > 0 || attachmentId.length > 0);
+
+    NSMutableArray<NSString *> *attachmentIds = [NSMutableArray new];
+    if (attachmentId) {
+        [attachmentIds addObject:attachmentId];
+    }
+
+    //    // Random time within last n years. Helpful for filling out a media gallery over time.
+    //    double yearsMillis = 4.0 * kYearsInMs;
+    //    uint64_t millisAgo = (uint64_t)(((double)arc4random() / ((double)0xffffffff)) * yearsMillis);
+    //    uint64_t timestamp = [NSDate ows_millisecondTimeStamp] - millisAgo;
+
+    TSIncomingMessage *message =
+        [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                           inThread:thread
+                                                           authorId:@"+19174054215"
+                                                     sourceDeviceId:0
+                                                        messageBody:messageBody
+                                                      attachmentIds:attachmentIds
+                                                   expiresInSeconds:0
+                                                      quotedMessage:quotedMessage];
+    [message markAsReadWithTransaction:transaction sendReadReceipt:NO updateExpiration:NO];
+    return message;
+}
+
++ (TSAttachment *)createFakeAttachment:(DebugUIMessagesAssetLoader *)fakeAssetLoader
+                isAttachmentDownloaded:(BOOL)isAttachmentDownloaded
+                           transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    OWSAssert(fakeAssetLoader.filePath);
+    OWSAssert(transaction);
+
+    if (isAttachmentDownloaded) {
+        DataSource *dataSource = [DataSourcePath dataSourceWithFilePath:fakeAssetLoader.filePath];
+        NSString *filename = dataSource.sourceFilename;
+        // To support "fake missing" attachments, we sometimes lie about the
+        // length of the data.
+        UInt32 nominalDataLength = (UInt32)MAX((NSUInteger)1, dataSource.dataLength);
+        TSAttachmentStream *attachmentStream = [[TSAttachmentStream alloc] initWithContentType:fakeAssetLoader.mimeType
+                                                                                     byteCount:nominalDataLength
+                                                                                sourceFilename:filename];
+        NSError *error;
+        BOOL success = [attachmentStream writeData:dataSource.data error:&error];
+        OWSAssert(success && !error);
+        [attachmentStream saveWithTransaction:transaction];
+        return attachmentStream;
+    } else {
+        UInt32 filesize = 64;
+        TSAttachmentPointer *attachmentPointer =
+            [[TSAttachmentPointer alloc] initWithServerId:237391539706350548
+                                                      key:[self createRandomNSDataOfSize:filesize]
+                                                   digest:nil
+                                                byteCount:filesize
+                                              contentType:fakeAssetLoader.mimeType
+                                                    relay:@""
+                                           sourceFilename:fakeAssetLoader.filename
+                                           attachmentType:TSAttachmentTypeDefault];
+        attachmentPointer.state = TSAttachmentPointerStateFailed;
+        [attachmentPointer saveWithTransaction:transaction];
+        return attachmentPointer;
+    }
+}
+
 @end
 
 NS_ASSUME_NONNULL_END
diff --git a/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m b/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m
index e715add2d58..b8f4c9c35d1 100644
--- a/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m
+++ b/Signal/src/ViewControllers/DebugUI/DebugUIMisc.m
@@ -12,7 +12,6 @@
 #import <AxolotlKit/PreKeyBundle.h>
 #import <SignalMessaging/AttachmentSharing.h>
 #import <SignalMessaging/Environment.h>
-#import <SignalMessaging/UIImage+OWS.h>
 #import <SignalServiceKit/OWSDisappearingConfigurationUpdateInfoMessage.h>
 #import <SignalServiceKit/OWSDisappearingMessagesConfiguration.h>
 #import <SignalServiceKit/OWSPrimaryStorage+SessionStore.h>
@@ -21,6 +20,7 @@
 #import <SignalServiceKit/TSCall.h>
 #import <SignalServiceKit/TSInvalidIdentityKeyReceivingErrorMessage.h>
 #import <SignalServiceKit/TSThread.h>
+#import <SignalServiceKit/UIImage+OWS.h>
 
 NS_ASSUME_NONNULL_BEGIN
 
diff --git a/Signal/src/ViewControllers/HomeViewController.m b/Signal/src/ViewControllers/HomeViewController.m
index dd48ef95efc..c827a21d5ed 100644
--- a/Signal/src/ViewControllers/HomeViewController.m
+++ b/Signal/src/ViewControllers/HomeViewController.m
@@ -683,9 +683,16 @@ - (void)tableViewCellTappedDelete:(NSIndexPath *)indexPath
                           preferredStyle:UIAlertControllerStyleAlert];
             [self presentViewController:removingFromGroup animated:YES completion:nil];
 
-            TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                             inThread:thread
-                                                                     groupMetaMessage:TSGroupMessageQuit];
+            TSOutgoingMessage *message =
+                [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                                   inThread:thread
+                                                                messageBody:nil
+                                                              attachmentIds:[NSMutableArray new]
+                                                           expiresInSeconds:0
+                                                            expireStartedAt:0
+                                                             isVoiceMessage:NO
+                                                           groupMetaMessage:TSGroupMessageQuit
+                                                              quotedMessage:nil];
             [self.messageSender enqueueMessage:message
                 success:^{
                     [self dismissViewControllerAnimated:YES
diff --git a/Signal/src/ViewControllers/NewGroupViewController.m b/Signal/src/ViewControllers/NewGroupViewController.m
index 161a4c467f8..dd95b1a4eb2 100644
--- a/Signal/src/ViewControllers/NewGroupViewController.m
+++ b/Signal/src/ViewControllers/NewGroupViewController.m
@@ -490,9 +490,15 @@ - (void)createGroup
                         canCancel:NO
                   backgroundBlock:^(ModalActivityIndicatorViewController *modalActivityIndicator) {
                       TSOutgoingMessage *message =
-                          [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                              inThread:thread
-                                                      groupMetaMessage:TSGroupMessageNew];
+                          [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                                             inThread:thread
+                                                                          messageBody:nil
+                                                                        attachmentIds:[NSMutableArray new]
+                                                                     expiresInSeconds:0
+                                                                      expireStartedAt:0
+                                                                       isVoiceMessage:NO
+                                                                     groupMetaMessage:TSGroupMessageNew
+                                                                        quotedMessage:nil];
 
                       [message updateWithCustomMessage:NSLocalizedString(@"GROUP_CREATED", nil)];
 
diff --git a/Signal/src/ViewControllers/ThreadSettings/OWSConversationSettingsViewController.m b/Signal/src/ViewControllers/ThreadSettings/OWSConversationSettingsViewController.m
index 068a0e11a7f..7f73c52df4c 100644
--- a/Signal/src/ViewControllers/ThreadSettings/OWSConversationSettingsViewController.m
+++ b/Signal/src/ViewControllers/ThreadSettings/OWSConversationSettingsViewController.m
@@ -936,9 +936,16 @@ - (void)didTapLeaveGroup
 - (void)leaveGroup
 {
     TSGroupThread *gThread = (TSGroupThread *)self.thread;
-    TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                     inThread:gThread
-                                                             groupMetaMessage:TSGroupMessageQuit];
+    TSOutgoingMessage *message =
+        [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                           inThread:gThread
+                                                        messageBody:nil
+                                                      attachmentIds:[NSMutableArray new]
+                                                   expiresInSeconds:0
+                                                    expireStartedAt:0
+                                                     isVoiceMessage:NO
+                                                   groupMetaMessage:TSGroupMessageQuit
+                                                      quotedMessage:nil];
     [self.messageSender enqueueMessage:message
         success:^{
             DDLogInfo(@"%@ Successfully left group.", self.logTag);
diff --git a/SignalMessaging/Models/OWSContactOffersInteraction.h b/SignalMessaging/Models/OWSContactOffersInteraction.h
index 8438f6470f8..2f387812311 100644
--- a/SignalMessaging/Models/OWSContactOffersInteraction.h
+++ b/SignalMessaging/Models/OWSContactOffersInteraction.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import <SignalServiceKit/TSInteraction.h>
@@ -13,14 +13,16 @@ NS_ASSUME_NONNULL_BEGIN
 @property (nonatomic, readonly) BOOL hasAddToProfileWhitelistOffer;
 @property (nonatomic, readonly) NSString *recipientId;
 
+- (instancetype)initInteractionWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread NS_UNAVAILABLE;
+
 - (instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                           thread:(TSThread *)thread
-                    hasBlockOffer:(BOOL)hasBlockOffer
-            hasAddToContactsOffer:(BOOL)hasAddToContactsOffer
-    hasAddToProfileWhitelistOffer:(BOOL)hasAddToProfileWhitelistOffer
-                      recipientId:(NSString *)recipientId NS_DESIGNATED_INITIALIZER;
+- (instancetype)initContactOffersWithTimestamp:(uint64_t)timestamp
+                                        thread:(TSThread *)thread
+                                 hasBlockOffer:(BOOL)hasBlockOffer
+                         hasAddToContactsOffer:(BOOL)hasAddToContactsOffer
+                 hasAddToProfileWhitelistOffer:(BOOL)hasAddToProfileWhitelistOffer
+                                   recipientId:(NSString *)recipientId NS_DESIGNATED_INITIALIZER;
 
 @end
 
diff --git a/SignalMessaging/Models/OWSContactOffersInteraction.m b/SignalMessaging/Models/OWSContactOffersInteraction.m
index 79157a7436d..02a39c11dc4 100644
--- a/SignalMessaging/Models/OWSContactOffersInteraction.m
+++ b/SignalMessaging/Models/OWSContactOffersInteraction.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSContactOffersInteraction.h"
@@ -13,14 +13,14 @@ - (instancetype)initWithCoder:(NSCoder *)coder
     return [super initWithCoder:coder];
 }
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                           thread:(TSThread *)thread
-                    hasBlockOffer:(BOOL)hasBlockOffer
-            hasAddToContactsOffer:(BOOL)hasAddToContactsOffer
-    hasAddToProfileWhitelistOffer:(BOOL)hasAddToProfileWhitelistOffer
-                      recipientId:(NSString *)recipientId
+- (instancetype)initContactOffersWithTimestamp:(uint64_t)timestamp
+                                        thread:(TSThread *)thread
+                                 hasBlockOffer:(BOOL)hasBlockOffer
+                         hasAddToContactsOffer:(BOOL)hasAddToContactsOffer
+                 hasAddToProfileWhitelistOffer:(BOOL)hasAddToProfileWhitelistOffer
+                                   recipientId:(NSString *)recipientId
 {
-    self = [super initWithTimestamp:timestamp inThread:thread];
+    self = [super initInteractionWithTimestamp:timestamp inThread:thread];
 
     if (!self) {
         return self;
diff --git a/SignalMessaging/Models/TSUnreadIndicatorInteraction.h b/SignalMessaging/Models/TSUnreadIndicatorInteraction.h
index b9d962231d7..b9c6f50ddf6 100644
--- a/SignalMessaging/Models/TSUnreadIndicatorInteraction.h
+++ b/SignalMessaging/Models/TSUnreadIndicatorInteraction.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import <SignalServiceKit/TSInteraction.h>
@@ -12,12 +12,15 @@ NS_ASSUME_NONNULL_BEGIN
 
 @property (atomic, readonly) NSUInteger missingUnseenSafetyNumberChangeCount;
 
+- (instancetype)initInteractionWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread NS_UNAVAILABLE;
+
 - (instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                                  thread:(TSThread *)thread
-                   hasMoreUnseenMessages:(BOOL)hasMoreUnseenMessages
-    missingUnseenSafetyNumberChangeCount:(NSUInteger)missingUnseenSafetyNumberChangeCount NS_DESIGNATED_INITIALIZER;
+- (instancetype)initUnreadIndicatorWithTimestamp:(uint64_t)timestamp
+                                          thread:(TSThread *)thread
+                           hasMoreUnseenMessages:(BOOL)hasMoreUnseenMessages
+            missingUnseenSafetyNumberChangeCount:(NSUInteger)missingUnseenSafetyNumberChangeCount
+    NS_DESIGNATED_INITIALIZER;
 
 @end
 
diff --git a/SignalMessaging/Models/TSUnreadIndicatorInteraction.m b/SignalMessaging/Models/TSUnreadIndicatorInteraction.m
index bf50449827f..aed872e471f 100644
--- a/SignalMessaging/Models/TSUnreadIndicatorInteraction.m
+++ b/SignalMessaging/Models/TSUnreadIndicatorInteraction.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "TSUnreadIndicatorInteraction.h"
@@ -21,12 +21,12 @@ - (instancetype)initWithCoder:(NSCoder *)coder
     return [super initWithCoder:coder];
 }
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                                  thread:(TSThread *)thread
-                   hasMoreUnseenMessages:(BOOL)hasMoreUnseenMessages
-    missingUnseenSafetyNumberChangeCount:(NSUInteger)missingUnseenSafetyNumberChangeCount
+- (instancetype)initUnreadIndicatorWithTimestamp:(uint64_t)timestamp
+                                          thread:(TSThread *)thread
+                           hasMoreUnseenMessages:(BOOL)hasMoreUnseenMessages
+            missingUnseenSafetyNumberChangeCount:(NSUInteger)missingUnseenSafetyNumberChangeCount
 {
-    self = [super initWithTimestamp:timestamp inThread:thread];
+    self = [super initInteractionWithTimestamp:timestamp inThread:thread];
 
     if (!self) {
         return self;
diff --git a/SignalMessaging/SignalMessaging.h b/SignalMessaging/SignalMessaging.h
index 4c01089d76e..f4fbdb45b8d 100644
--- a/SignalMessaging/SignalMessaging.h
+++ b/SignalMessaging/SignalMessaging.h
@@ -40,9 +40,9 @@ FOUNDATION_EXPORT const unsigned char SignalMessagingVersionString[];
 #import <SignalMessaging/ThreadUtil.h>
 #import <SignalMessaging/UIColor+OWS.h>
 #import <SignalMessaging/UIFont+OWS.h>
-#import <SignalMessaging/UIImage+OWS.h>
 #import <SignalMessaging/UIUtil.h>
 #import <SignalMessaging/UIView+OWS.h>
 #import <SignalMessaging/UIViewController+OWS.h>
 #import <SignalMessaging/VersionMigrations.h>
 #import <SignalMessaging/ViewControllerUtils.h>
+#import <SignalServiceKit/UIImage+OWS.h>
diff --git a/SignalMessaging/profiles/OWSProfileManager.m b/SignalMessaging/profiles/OWSProfileManager.m
index b5df48fc417..796d9b3edad 100644
--- a/SignalMessaging/profiles/OWSProfileManager.m
+++ b/SignalMessaging/profiles/OWSProfileManager.m
@@ -6,7 +6,6 @@
 #import "Environment.h"
 #import "NSString+OWS.h"
 #import "OWSUserProfile.h"
-#import "UIImage+OWS.h"
 #import <SignalMessaging/SignalMessaging-Swift.h>
 #import <SignalServiceKit/AppContext.h>
 #import <SignalServiceKit/Cryptography.h>
@@ -28,6 +27,7 @@
 #import <SignalServiceKit/TSThread.h>
 #import <SignalServiceKit/TSYapDatabaseObject.h>
 #import <SignalServiceKit/TextSecureKitEnv.h>
+#import <SignalServiceKit/UIImage+OWS.h>
 
 NS_ASSUME_NONNULL_BEGIN
 
diff --git a/SignalMessaging/utils/ThreadUtil.m b/SignalMessaging/utils/ThreadUtil.m
index 86a5f8b286e..9a86fc2ff33 100644
--- a/SignalMessaging/utils/ThreadUtil.m
+++ b/SignalMessaging/utils/ThreadUtil.m
@@ -82,12 +82,15 @@ + (TSOutgoingMessage *)sendMessageWithText:(NSString *)text
 
     OWSDisappearingMessagesConfiguration *configuration =
         [OWSDisappearingMessagesConfiguration fetchObjectWithUniqueID:thread.uniqueId];
-    TSOutgoingMessage *message =
-        [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                            inThread:thread
-                                         messageBody:text
-                                       attachmentIds:[NSMutableArray new]
-                                    expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds : 0)];
+    TSOutgoingMessage *message = [[TSOutgoingMessage alloc]
+        initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                inThread:thread
+                             messageBody:text
+                           attachmentIds:[NSMutableArray new]
+                        expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds : 0)expireStartedAt:0
+                          isVoiceMessage:NO
+                        groupMetaMessage:TSGroupMessageNone
+                           quotedMessage:nil];
 
     [messageSender enqueueMessage:message success:successHandler failure:failureHandler];
 
@@ -121,13 +124,16 @@ + (TSOutgoingMessage *)sendMessageWithAttachment:(SignalAttachment *)attachment
 
     OWSDisappearingMessagesConfiguration *configuration =
         [OWSDisappearingMessagesConfiguration fetchObjectWithUniqueID:thread.uniqueId];
-    TSOutgoingMessage *message =
-        [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                            inThread:thread
-                                         messageBody:attachment.captionText
-                                      isVoiceMessage:[attachment isVoiceMessage]
-                                    expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds : 0)];
-    
+    TSOutgoingMessage *message = [[TSOutgoingMessage alloc]
+        initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                inThread:thread
+                             messageBody:attachment.captionText
+                           attachmentIds:[NSMutableArray new]
+                        expiresInSeconds:(configuration.isEnabled ? configuration.durationSeconds : 0)expireStartedAt:0
+                          isVoiceMessage:[attachment isVoiceMessage]
+                        groupMetaMessage:TSGroupMessageNone
+                           quotedMessage:nil];
+
     [messageSender enqueueAttachment:attachment.dataSource
         contentType:attachment.mimeType
         sourceFilename:attachment.filenameOrDefault
@@ -499,12 +505,12 @@ + (ThreadDynamicInteractions *)ensureDynamicInteractionsForThread:(TSThread *)th
             NSString *recipientId = ((TSContactThread *)thread).contactIdentifier;
 
             TSInteraction *offersMessage =
-                [[OWSContactOffersInteraction alloc] initWithTimestamp:contactOffersTimestamp
-                                                                thread:thread
-                                                         hasBlockOffer:shouldHaveBlockOffer
-                                                 hasAddToContactsOffer:shouldHaveAddToContactsOffer
-                                         hasAddToProfileWhitelistOffer:shouldHaveAddToProfileWhitelistOffer
-                                                           recipientId:recipientId];
+                [[OWSContactOffersInteraction alloc] initContactOffersWithTimestamp:contactOffersTimestamp
+                                                                             thread:thread
+                                                                      hasBlockOffer:shouldHaveBlockOffer
+                                                              hasAddToContactsOffer:shouldHaveAddToContactsOffer
+                                                      hasAddToProfileWhitelistOffer:shouldHaveAddToProfileWhitelistOffer
+                                                                        recipientId:recipientId];
             [offersMessage saveWithTransaction:transaction];
 
             DDLogInfo(@"%@ Creating contact offers: %@ (%llu)",
@@ -540,11 +546,11 @@ + (ThreadDynamicInteractions *)ensureDynamicInteractionsForThread:(TSThread *)th
                     [existingUnreadIndicator removeWithTransaction:transaction];
                 }
 
-                TSUnreadIndicatorInteraction *indicator =
-                    [[TSUnreadIndicatorInteraction alloc] initWithTimestamp:indicatorTimestamp
-                                                                     thread:thread
-                                                      hasMoreUnseenMessages:result.hasMoreUnseenMessages
-                                       missingUnseenSafetyNumberChangeCount:missingUnseenSafetyNumberChangeCount];
+                TSUnreadIndicatorInteraction *indicator = [[TSUnreadIndicatorInteraction alloc]
+                        initUnreadIndicatorWithTimestamp:indicatorTimestamp
+                                                  thread:thread
+                                   hasMoreUnseenMessages:result.hasMoreUnseenMessages
+                    missingUnseenSafetyNumberChangeCount:missingUnseenSafetyNumberChangeCount];
                 [indicator saveWithTransaction:transaction];
 
                 DDLogInfo(@"%@ Creating TSUnreadIndicatorInteraction: %@ (%llu)",
diff --git a/SignalMessaging/utils/UIUtil.h b/SignalMessaging/utils/UIUtil.h
index 6b4046cde3a..cb8a9ef8fb5 100644
--- a/SignalMessaging/utils/UIUtil.h
+++ b/SignalMessaging/utils/UIUtil.h
@@ -1,11 +1,11 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "UIColor+OWS.h"
 #import "UIFont+OWS.h"
-#import "UIImage+OWS.h"
 #import <SignalServiceKit/MIMETypeUtil.h>
+#import <SignalServiceKit/UIImage+OWS.h>
 
 typedef void (^completionBlock)(void);
 
diff --git a/SignalServiceKit/protobuf/OWSSignalServiceProtos.proto b/SignalServiceKit/protobuf/OWSSignalServiceProtos.proto
index 263ff798c2a..e4c935ac613 100644
--- a/SignalServiceKit/protobuf/OWSSignalServiceProtos.proto
+++ b/SignalServiceKit/protobuf/OWSSignalServiceProtos.proto
@@ -87,6 +87,14 @@ message DataMessage {
     PROFILE_KEY_UPDATE      = 4;
   }
 
+  message Quote
+  {
+      optional uint64 id = 1;
+      optional string author = 2;
+      optional string text = 3;
+      optional AttachmentPointer attachment = 4;
+  }
+
   optional string             body        = 1;
   repeated AttachmentPointer  attachments = 2;
   optional GroupContext       group       = 3;
@@ -94,6 +102,7 @@ message DataMessage {
   optional uint32             expireTimer = 5;
   optional bytes              profileKey  = 6;
   optional uint64             timestamp   = 7;
+  optional Quote quote = 8;
 }
 
 message NullMessage {
diff --git a/SignalServiceKit/src/Devices/OWSReadReceiptsForSenderMessage.m b/SignalServiceKit/src/Devices/OWSReadReceiptsForSenderMessage.m
index f0cbd22fcaf..7c1a30c5396 100644
--- a/SignalServiceKit/src/Devices/OWSReadReceiptsForSenderMessage.m
+++ b/SignalServiceKit/src/Devices/OWSReadReceiptsForSenderMessage.m
@@ -15,11 +15,21 @@ @interface OWSReadReceiptsForSenderMessage ()
 
 @end
 
+#pragma mark -
+
 @implementation OWSReadReceiptsForSenderMessage
 
 - (instancetype)initWithThread:(nullable TSThread *)thread messageTimestamps:(NSArray<NSNumber *> *)messageTimestamps
 {
-    self = [super initWithTimestamp:[NSDate ows_millisecondTimeStamp] inThread:thread];
+    self = [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:thread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
     if (!self) {
         return self;
     }
diff --git a/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m b/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m
index b53db30944b..94ef2e91b8b 100644
--- a/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m
+++ b/SignalServiceKit/src/Devices/OWSRecordTranscriptJob.m
@@ -88,12 +88,15 @@ - (void)runWithAttachmentHandler:(void (^)(TSAttachmentStream *attachmentStream)
 
     // TODO group updates. Currently desktop doesn't support group updates, so not a problem yet.
     TSOutgoingMessage *outgoingMessage =
-        [[TSOutgoingMessage alloc] initWithTimestamp:transcript.timestamp
-                                            inThread:thread
-                                         messageBody:transcript.body
-                                       attachmentIds:[attachmentsProcessor.attachmentIds mutableCopy]
-                                    expiresInSeconds:transcript.expirationDuration
-                                     expireStartedAt:transcript.expirationStartedAt];
+        [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:transcript.timestamp
+                                                           inThread:thread
+                                                        messageBody:transcript.body
+                                                      attachmentIds:[attachmentsProcessor.attachmentIds mutableCopy]
+                                                   expiresInSeconds:transcript.expirationDuration
+                                                    expireStartedAt:transcript.expirationStartedAt
+                                                     isVoiceMessage:NO
+                                                   groupMetaMessage:TSGroupMessageNone
+                                                      quotedMessage:nil];
 
     if (transcript.isExpirationTimerUpdate) {
         [OWSDisappearingMessagesJob becomeConsistentWithConfigurationForMessage:outgoingMessage
diff --git a/SignalServiceKit/src/Messages/Attachments/TSAttachment.m b/SignalServiceKit/src/Messages/Attachments/TSAttachment.m
index 6fbcaaffc44..d01b1629d61 100644
--- a/SignalServiceKit/src/Messages/Attachments/TSAttachment.m
+++ b/SignalServiceKit/src/Messages/Attachments/TSAttachment.m
@@ -180,6 +180,8 @@ - (NSString *)description {
         }
     } else if ([MIMETypeUtil isAnimated:self.contentType]) {
         return [NSString stringWithFormat:@"ðŸŽ¡ %@", attachmentString];
+    } else {
+        return [NSString stringWithFormat:@"ðŸ“Ž %@", attachmentString];
     }
 
     return attachmentString;
diff --git a/SignalServiceKit/src/Messages/DeviceSyncing/OWSOutgoingSyncMessage.m b/SignalServiceKit/src/Messages/DeviceSyncing/OWSOutgoingSyncMessage.m
index 3001e1e76bb..6b1a7ed3fc2 100644
--- a/SignalServiceKit/src/Messages/DeviceSyncing/OWSOutgoingSyncMessage.m
+++ b/SignalServiceKit/src/Messages/DeviceSyncing/OWSOutgoingSyncMessage.m
@@ -14,7 +14,16 @@ @implementation OWSOutgoingSyncMessage
 
 - (instancetype)init
 {
-    self = [super initWithTimestamp:[NSDate ows_millisecondTimeStamp]];
+    self = [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:nil
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
+
     if (!self) {
         return self;
     }
diff --git a/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncContactsMessage.m b/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncContactsMessage.m
index 78f6db821d4..d77fd650663 100644
--- a/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncContactsMessage.m
+++ b/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncContactsMessage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSSyncContactsMessage.h"
@@ -30,7 +30,15 @@ - (instancetype)initWithSignalAccounts:(NSArray<SignalAccount *> *)signalAccount
                        identityManager:(OWSIdentityManager *)identityManager
                         profileManager:(id<ProfileManagerProtocol>)profileManager
 {
-    self = [super initWithTimestamp:[NSDate ows_millisecondTimeStamp]];
+    self = [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:nil
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
     if (!self) {
         return self;
     }
diff --git a/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsMessage.m b/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsMessage.m
index 575a1d1612f..674eabb8487 100644
--- a/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsMessage.m
+++ b/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsMessage.m
@@ -16,7 +16,15 @@ @implementation OWSSyncGroupsMessage
 
 - (instancetype)init
 {
-    return [super initWithTimestamp:[NSDate ows_millisecondTimeStamp]];
+    return [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:nil
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
 }
 
 - (OWSSignalServiceProtosSyncMessageBuilder *)syncMessageBuilder
diff --git a/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsRequestMessage.m b/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsRequestMessage.m
index 395b69f4cf7..2f7adaf1847 100644
--- a/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsRequestMessage.m
+++ b/SignalServiceKit/src/Messages/DeviceSyncing/OWSSyncGroupsRequestMessage.m
@@ -20,7 +20,15 @@ @implementation OWSSyncGroupsRequestMessage
 
 - (instancetype)initWithThread:(nullable TSThread *)thread groupId:(NSData *)groupId
 {
-    self = [super initWithTimestamp:[NSDate ows_millisecondTimeStamp] inThread:thread];
+    self = [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:thread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
     if (!self) {
         return self;
     }
diff --git a/SignalServiceKit/src/Messages/Interactions/OWSDisappearingMessagesConfigurationMessage.m b/SignalServiceKit/src/Messages/Interactions/OWSDisappearingMessagesConfigurationMessage.m
index 5da1b3fbd35..a3994209d52 100644
--- a/SignalServiceKit/src/Messages/Interactions/OWSDisappearingMessagesConfigurationMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/OWSDisappearingMessagesConfigurationMessage.m
@@ -15,6 +15,8 @@ @interface OWSDisappearingMessagesConfigurationMessage ()
 
 @end
 
+#pragma mark -
+
 @implementation OWSDisappearingMessagesConfigurationMessage
 
 - (BOOL)shouldBeSaved
@@ -24,7 +26,15 @@ - (BOOL)shouldBeSaved
 
 - (instancetype)initWithConfiguration:(OWSDisappearingMessagesConfiguration *)configuration thread:(TSThread *)thread
 {
-    self = [super initWithTimestamp:[NSDate ows_millisecondTimeStamp] inThread:thread];
+    self = [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:thread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
     if (!self) {
         return self;
     }
diff --git a/SignalServiceKit/src/Messages/Interactions/OWSDynamicOutgoingMessage.m b/SignalServiceKit/src/Messages/Interactions/OWSDynamicOutgoingMessage.m
index 2e76352e145..5c5af8d3c61 100644
--- a/SignalServiceKit/src/Messages/Interactions/OWSDynamicOutgoingMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/OWSDynamicOutgoingMessage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSDynamicOutgoingMessage.h"
@@ -27,7 +27,15 @@ - (instancetype)initWithPlainTextDataBlock:(DynamicOutgoingMessageBlock)block
                                  timestamp:(uint64_t)timestamp
                                     thread:(nullable TSThread *)thread
 {
-    self = [super initWithTimestamp:timestamp inThread:thread];
+    self = [super initOutgoingMessageWithTimestamp:timestamp
+                                          inThread:thread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
 
     if (self) {
         _block = block;
diff --git a/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.h b/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.h
index 48bd54158aa..4e49289f9e3 100644
--- a/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.h
@@ -1,5 +1,6 @@
-//  Created by Michael Kirk on 11/3/16.
-//  Copyright Â© 2016 Open Whisper Systems. All rights reserved.
+//
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
+//
 
 #import "TSOutgoingMessage.h"
 
@@ -8,6 +9,8 @@ NS_ASSUME_NONNULL_BEGIN
 NS_SWIFT_NAME(EndSessionMessage)
 @interface OWSEndSessionMessage : TSOutgoingMessage
 
+- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread NS_DESIGNATED_INITIALIZER;
+
 @end
 
 NS_ASSUME_NONNULL_END
diff --git a/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.m b/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.m
index 562c240993f..9b8edd5c9fa 100644
--- a/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/OWSEndSessionMessage.m
@@ -9,6 +9,19 @@
 
 @implementation OWSEndSessionMessage
 
+- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread
+{
+    return [super initOutgoingMessageWithTimestamp:timestamp
+                                          inThread:thread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
+}
+
 - (BOOL)shouldBeSaved
 {
     return NO;
diff --git a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h
index e120751cfb5..68c3222592b 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSReadTracking.h"
@@ -8,12 +8,10 @@
 
 NS_ASSUME_NONNULL_BEGIN
 
-@interface TSErrorMessage : TSMessage <OWSReadTracking>
-
 typedef NS_ENUM(int32_t, TSErrorMessageType) {
     TSErrorMessageNoSession,
     TSErrorMessageWrongTrustedIdentityKey, // DEPRECATED: We no longer create TSErrorMessageWrongTrustedIdentityKey, but
-                                           // persisted legacy messages could exist indefinitly.
+    // persisted legacy messages could exist indefinitly.
     TSErrorMessageInvalidKeyException,
     TSErrorMessageMissingKeyId, // unused
     TSErrorMessageInvalidMessage,
@@ -24,6 +22,16 @@ typedef NS_ENUM(int32_t, TSErrorMessageType) {
     TSErrorMessageGroupCreationFailed,
 };
 
+@interface TSErrorMessage : TSMessage <OWSReadTracking>
+
+- (instancetype)initMessageWithTimestamp:(uint64_t)timestamp
+                                inThread:(nullable TSThread *)thread
+                             messageBody:(nullable NSString *)body
+                           attachmentIds:(NSArray<NSString *> *)attachmentIds
+                        expiresInSeconds:(uint32_t)expiresInSeconds
+                         expireStartedAt:(uint64_t)expireStartedAt
+                           quotedMessage:(nullable TSQuotedMessage *)quotedMessage NS_UNAVAILABLE;
+
 - (instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
 
 - (instancetype)initWithTimestamp:(uint64_t)timestamp
diff --git a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.m b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.m
index 65726c35b3c..497aca86801 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "TSErrorMessage.h"
@@ -59,12 +59,13 @@ - (instancetype)initWithTimestamp:(uint64_t)timestamp
                 failedMessageType:(TSErrorMessageType)errorMessageType
                       recipientId:(nullable NSString *)recipientId
 {
-    self = [super initWithTimestamp:timestamp
-                           inThread:thread
-                        messageBody:nil
-                      attachmentIds:@[]
-                   expiresInSeconds:0
-                    expireStartedAt:0];
+    self = [super initMessageWithTimestamp:timestamp
+                                  inThread:thread
+                               messageBody:nil
+                             attachmentIds:@[]
+                          expiresInSeconds:0
+                           expireStartedAt:0
+                             quotedMessage:nil];
 
     if (!self) {
         return self;
diff --git a/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.h b/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.h
index e7224c99e99..823b2251500 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSReadTracking.h"
@@ -12,27 +12,13 @@ NS_ASSUME_NONNULL_BEGIN
 
 @interface TSIncomingMessage : TSMessage <OWSReadTracking>
 
-/**
- *  Inits an incoming group message without attachments
- *
- *  @param timestamp
- *    When the message was created in milliseconds since epoch
- *  @param thread
- *    Thread to which the message belongs
- *  @param authorId
- *    Signal ID (i.e. e164) of the user who sent the message
- *  @param sourceDeviceId
- *    Numeric ID of the device used to send the message. Used to detect duplicate messages.
- *  @param body
- *    Body of the message
- *
- *  @return initiated incoming group message
- */
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(TSThread *)thread
-                         authorId:(NSString *)authorId
-                   sourceDeviceId:(uint32_t)sourceDeviceId
-                      messageBody:(nullable NSString *)body;
+- (instancetype)initMessageWithTimestamp:(uint64_t)timestamp
+                                inThread:(nullable TSThread *)thread
+                             messageBody:(nullable NSString *)body
+                           attachmentIds:(NSArray<NSString *> *)attachmentIds
+                        expiresInSeconds:(uint32_t)expiresInSeconds
+                         expireStartedAt:(uint64_t)expireStartedAt
+                           quotedMessage:(nullable TSQuotedMessage *)quotedMessage NS_UNAVAILABLE;
 
 /**
  *  Inits an incoming group message that expires.
@@ -51,45 +37,22 @@ NS_ASSUME_NONNULL_BEGIN
  *    The uniqueIds for the message's attachments, possibly an empty list.
  *  @param expiresInSeconds
  *    Seconds from when the message is read until it is deleted.
+ *  @param quotedMessage
+ *    If this message is a quoted reply to another message, contains data about that message.
  *
  *  @return initiated incoming group message
  */
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(TSThread *)thread
-                         authorId:(NSString *)authorId
-                   sourceDeviceId:(uint32_t)sourceDeviceId
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds NS_DESIGNATED_INITIALIZER;
+- (instancetype)initIncomingMessageWithTimestamp:(uint64_t)timestamp
+                                        inThread:(TSThread *)thread
+                                        authorId:(NSString *)authorId
+                                  sourceDeviceId:(uint32_t)sourceDeviceId
+                                     messageBody:(nullable NSString *)body
+                                   attachmentIds:(NSArray<NSString *> *)attachmentIds
+                                expiresInSeconds:(uint32_t)expiresInSeconds
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage NS_DESIGNATED_INITIALIZER;
 
 - (instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
 
-
-/**
- * For sake of a smaller API, and simplifying assumptions elsewhere, you must specify an author id for *all* incoming
- * messages, even though we technically could infer the author id for a contact thread.
- */
-- (instancetype)initWithTimestamp:(uint64_t)timestamp NS_UNAVAILABLE;
-- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread NS_UNAVAILABLE;
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body NS_UNAVAILABLE;
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds NS_UNAVAILABLE;
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds NS_UNAVAILABLE;
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-                  expireStartedAt:(uint64_t)expireStartedAt NS_UNAVAILABLE;
-
 /*
  * Find a message matching the senderId and timestamp, if any.
  *
diff --git a/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.m b/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.m
index d91d036bbbf..5da9c822ff9 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/TSIncomingMessage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "TSIncomingMessage.h"
@@ -35,35 +35,22 @@ - (instancetype)initWithCoder:(NSCoder *)coder
     return self;
 }
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(TSThread *)thread
-                         authorId:(NSString *)authorId
-                   sourceDeviceId:(uint32_t)sourceDeviceId
-                      messageBody:(nullable NSString *)body
+- (instancetype)initIncomingMessageWithTimestamp:(uint64_t)timestamp
+                                        inThread:(TSThread *)thread
+                                        authorId:(NSString *)authorId
+                                  sourceDeviceId:(uint32_t)sourceDeviceId
+                                     messageBody:(nullable NSString *)body
+                                   attachmentIds:(NSArray<NSString *> *)attachmentIds
+                                expiresInSeconds:(uint32_t)expiresInSeconds
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage
 {
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                          authorId:authorId
-                    sourceDeviceId:sourceDeviceId
-                       messageBody:body
-                     attachmentIds:@[]
-                  expiresInSeconds:0];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(TSThread *)thread
-                         authorId:(NSString *)authorId
-                   sourceDeviceId:(uint32_t)sourceDeviceId
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-{
-    self = [super initWithTimestamp:timestamp
-                           inThread:thread
-                        messageBody:body
-                      attachmentIds:attachmentIds
-                   expiresInSeconds:expiresInSeconds
-                    expireStartedAt:0];
+    self = [super initMessageWithTimestamp:timestamp
+                                  inThread:thread
+                               messageBody:body
+                             attachmentIds:attachmentIds
+                          expiresInSeconds:expiresInSeconds
+                           expireStartedAt:0
+                             quotedMessage:quotedMessage];
 
     if (!self) {
         return self;
diff --git a/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.h b/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.h
index b43d0fe9dbb..c6378b47767 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSReadTracking.h"
@@ -28,6 +28,14 @@ typedef NS_ENUM(NSInteger, TSInfoMessageType) {
 @property (atomic, readonly) TSInfoMessageType messageType;
 @property (atomic, readonly) NSString *customMessage;
 
+- (instancetype)initMessageWithTimestamp:(uint64_t)timestamp
+                                inThread:(nullable TSThread *)thread
+                             messageBody:(nullable NSString *)body
+                           attachmentIds:(NSArray<NSString *> *)attachmentIds
+                        expiresInSeconds:(uint32_t)expiresInSeconds
+                         expireStartedAt:(uint64_t)expireStartedAt
+                           quotedMessage:(nullable TSQuotedMessage *)quotedMessage NS_UNAVAILABLE;
+
 - (instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
 
 - (instancetype)initWithTimestamp:(uint64_t)timestamp
diff --git a/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.m b/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.m
index 88d854c9c01..4c53c8cc5f9 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/TSInfoMessage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "TSInfoMessage.h"
@@ -46,12 +46,13 @@ - (instancetype)initWithTimestamp:(uint64_t)timestamp
                          inThread:(TSThread *)thread
                       messageType:(TSInfoMessageType)infoMessage
 {
-    self = [super initWithTimestamp:timestamp
-                           inThread:thread
-                        messageBody:nil
-                      attachmentIds:@[]
-                   expiresInSeconds:0
-                    expireStartedAt:0];
+    self = [super initMessageWithTimestamp:timestamp
+                                  inThread:thread
+                               messageBody:nil
+                             attachmentIds:@[]
+                          expiresInSeconds:0
+                           expireStartedAt:0
+                             quotedMessage:nil];
 
     if (!self) {
         return self;
diff --git a/SignalServiceKit/src/Messages/Interactions/TSInteraction.h b/SignalServiceKit/src/Messages/Interactions/TSInteraction.h
index 19f6d246d3a..1debf19d290 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSInteraction.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSInteraction.h
@@ -21,7 +21,7 @@ typedef NS_ENUM(NSInteger, OWSInteractionType) {
 
 @interface TSInteraction : TSYapDatabaseObject
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread;
+- (instancetype)initInteractionWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread;
 
 @property (nonatomic, readonly) NSString *uniqueThreadId;
 @property (nonatomic, readonly) TSThread *thread;
diff --git a/SignalServiceKit/src/Messages/Interactions/TSInteraction.m b/SignalServiceKit/src/Messages/Interactions/TSInteraction.m
index e95088d8dbe..7bfa746eb77 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSInteraction.m
+++ b/SignalServiceKit/src/Messages/Interactions/TSInteraction.m
@@ -54,7 +54,7 @@ + (NSString *)collection {
     return @"TSInteraction";
 }
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread
+- (instancetype)initInteractionWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread
 {
     OWSAssert(timestamp > 0);
 
diff --git a/SignalServiceKit/src/Messages/Interactions/TSMessage.h b/SignalServiceKit/src/Messages/Interactions/TSMessage.h
index 85fd3519fc2..97dfc8dd250 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSMessage.h
@@ -11,6 +11,7 @@ NS_ASSUME_NONNULL_BEGIN
  */
 
 @class TSAttachment;
+@class TSQuotedMessage;
 
 @interface TSMessage : TSInteraction
 
@@ -20,32 +21,17 @@ NS_ASSUME_NONNULL_BEGIN
 @property (nonatomic, readonly) uint64_t expireStartedAt;
 @property (nonatomic, readonly) uint64_t expiresAt;
 @property (nonatomic, readonly) BOOL isExpiringMessage;
+@property (nonatomic, readonly, nullable) TSQuotedMessage *quotedMessage;
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp;
+- (instancetype)initInteractionWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread NS_UNAVAILABLE;
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-                  expireStartedAt:(uint64_t)expireStartedAt NS_DESIGNATED_INITIALIZER;
+- (instancetype)initMessageWithTimestamp:(uint64_t)timestamp
+                                inThread:(nullable TSThread *)thread
+                             messageBody:(nullable NSString *)body
+                           attachmentIds:(NSArray<NSString *> *)attachmentIds
+                        expiresInSeconds:(uint32_t)expiresInSeconds
+                         expireStartedAt:(uint64_t)expireStartedAt
+                           quotedMessage:(nullable TSQuotedMessage *)quotedMessage NS_DESIGNATED_INITIALIZER;
 
 - (nullable instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
 
diff --git a/SignalServiceKit/src/Messages/Interactions/TSMessage.m b/SignalServiceKit/src/Messages/Interactions/TSMessage.m
index e5cc0829393..7cc7b27aa2a 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/TSMessage.m
@@ -16,6 +16,8 @@
 
 static const NSUInteger OWSMessageSchemaVersion = 4;
 
+#pragma mark -
+
 @interface TSMessage ()
 
 @property (nonatomic, nullable) NSString *body;
@@ -48,63 +50,23 @@ @interface TSMessage ()
 // they were received & decrypted, not by when they were sent.
 @property (nonatomic) uint64_t receivedAtTimestamp;
 
+@property (nonatomic, nullable) TSQuotedMessage *quotedMessage;
+
 @end
 
 #pragma mark -
 
 @implementation TSMessage
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-{
-    return [self initWithTimestamp:timestamp inThread:nil messageBody:nil];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread
-{
-    return [self initWithTimestamp:timestamp inThread:thread messageBody:nil attachmentIds:@[]];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-{
-    return [self initWithTimestamp:timestamp inThread:thread messageBody:body attachmentIds:@[]];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-{
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:body
-                     attachmentIds:attachmentIds
-                  expiresInSeconds:0];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-{
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:body
-                     attachmentIds:attachmentIds
-                  expiresInSeconds:expiresInSeconds
-                   expireStartedAt:0];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-                  expireStartedAt:(uint64_t)expireStartedAt
+- (instancetype)initMessageWithTimestamp:(uint64_t)timestamp
+                                inThread:(nullable TSThread *)thread
+                             messageBody:(nullable NSString *)body
+                           attachmentIds:(NSArray<NSString *> *)attachmentIds
+                        expiresInSeconds:(uint32_t)expiresInSeconds
+                         expireStartedAt:(uint64_t)expireStartedAt
+                           quotedMessage:(nullable TSQuotedMessage *)quotedMessage
 {
-    self = [super initWithTimestamp:timestamp inThread:thread];
+    self = [super initInteractionWithTimestamp:timestamp inThread:thread];
 
     if (!self) {
         return self;
@@ -118,6 +80,7 @@ - (instancetype)initWithTimestamp:(uint64_t)timestamp
     _expireStartedAt = expireStartedAt;
     [self updateExpiresAt];
     _receivedAtTimestamp = [NSDate ows_millisecondTimeStamp];
+    _quotedMessage = quotedMessage;
 
     return self;
 }
diff --git a/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.h b/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.h
index aec65fb4917..3db15ce8512 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "TSMessage.h"
@@ -37,49 +37,23 @@ typedef NS_ENUM(NSInteger, TSGroupMetaMessage) {
 
 @interface TSOutgoingMessage : TSMessage
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                 groupMetaMessage:(TSGroupMetaMessage)groupMetaMessage;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)messageBody
-                   isVoiceMessage:(BOOL)isVoiceMessage
-                 expiresInSeconds:(uint32_t)expiresInSeconds;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-                  expireStartedAt:(uint64_t)expireStartedAt;
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-                  expireStartedAt:(uint64_t)expireStartedAt
-                 groupMetaMessage:(TSGroupMetaMessage)groupMetaMessage NS_DESIGNATED_INITIALIZER;
+- (instancetype)initMessageWithTimestamp:(uint64_t)timestamp
+                                inThread:(nullable TSThread *)thread
+                             messageBody:(nullable NSString *)body
+                           attachmentIds:(NSArray<NSString *> *)attachmentIds
+                        expiresInSeconds:(uint32_t)expiresInSeconds
+                         expireStartedAt:(uint64_t)expireStartedAt
+                           quotedMessage:(nullable TSQuotedMessage *)quotedMessage NS_UNAVAILABLE;
+
+- (instancetype)initOutgoingMessageWithTimestamp:(uint64_t)timestamp
+                                        inThread:(nullable TSThread *)thread
+                                     messageBody:(nullable NSString *)body
+                                   attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
+                                expiresInSeconds:(uint32_t)expiresInSeconds
+                                 expireStartedAt:(uint64_t)expireStartedAt
+                                  isVoiceMessage:(BOOL)isVoiceMessage
+                                groupMetaMessage:(TSGroupMetaMessage)groupMetaMessage
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage NS_DESIGNATED_INITIALIZER;
 
 - (instancetype)initWithCoder:(NSCoder *)coder NS_DESIGNATED_INITIALIZER;
 
diff --git a/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.m b/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.m
index debd8e82d6f..cd8576f0723 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/TSOutgoingMessage.m
@@ -11,6 +11,7 @@
 #import "TSAttachmentStream.h"
 #import "TSContactThread.h"
 #import "TSGroupThread.h"
+#import "TSQuotedMessage.h"
 #import "TextSecureKitEnv.h"
 #import <YapDatabase/YapDatabase.h>
 #import <YapDatabase/YapDatabaseTransaction.h>
@@ -74,117 +75,23 @@ - (instancetype)initWithCoder:(NSCoder *)coder
     return self;
 }
 
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-{
-    return [self initWithTimestamp:timestamp inThread:nil];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread
-{
-    return [self initWithTimestamp:timestamp inThread:thread messageBody:nil];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-{
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:body
-                     attachmentIds:[NSMutableArray new]
-                  expiresInSeconds:0];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
-{
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:body
-                     attachmentIds:attachmentIds
-                  expiresInSeconds:0];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-{
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:body
-                     attachmentIds:attachmentIds
-                  expiresInSeconds:expiresInSeconds
-                   expireStartedAt:0];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)messageBody
-                   isVoiceMessage:(BOOL)isVoiceMessage
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-{
-    self = [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:messageBody
-                     attachmentIds:[NSMutableArray new]
-                  expiresInSeconds:expiresInSeconds
-                   expireStartedAt:0];
-    if (self) {
-        _isVoiceMessage = isVoiceMessage;
-    }
-
-    return self;
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-                  expireStartedAt:(uint64_t)expireStartedAt
-{
-    TSGroupMetaMessage groupMetaMessage
-        = ([thread isKindOfClass:[TSGroupThread class]] ? TSGroupMessageDeliver : TSGroupMessageNone);
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:body
-                     attachmentIds:attachmentIds
-                  expiresInSeconds:expiresInSeconds
-                   expireStartedAt:expireStartedAt
-                  groupMetaMessage:groupMetaMessage];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                 groupMetaMessage:(TSGroupMetaMessage)groupMetaMessage
-{
-    return [self initWithTimestamp:timestamp
-                          inThread:thread
-                       messageBody:@""
-                     attachmentIds:[NSMutableArray new]
-                  expiresInSeconds:0
-                   expireStartedAt:0
-                  groupMetaMessage:groupMetaMessage];
-}
-
-- (instancetype)initWithTimestamp:(uint64_t)timestamp
-                         inThread:(nullable TSThread *)thread
-                      messageBody:(nullable NSString *)body
-                    attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
-                 expiresInSeconds:(uint32_t)expiresInSeconds
-                  expireStartedAt:(uint64_t)expireStartedAt
-                 groupMetaMessage:(TSGroupMetaMessage)groupMetaMessage
-{
-    self = [super initWithTimestamp:timestamp
-                           inThread:thread
-                        messageBody:body
-                      attachmentIds:attachmentIds
-                   expiresInSeconds:expiresInSeconds
-                    expireStartedAt:expireStartedAt];
+- (instancetype)initOutgoingMessageWithTimestamp:(uint64_t)timestamp
+                                        inThread:(nullable TSThread *)thread
+                                     messageBody:(nullable NSString *)body
+                                   attachmentIds:(NSMutableArray<NSString *> *)attachmentIds
+                                expiresInSeconds:(uint32_t)expiresInSeconds
+                                 expireStartedAt:(uint64_t)expireStartedAt
+                                  isVoiceMessage:(BOOL)isVoiceMessage
+                                groupMetaMessage:(TSGroupMetaMessage)groupMetaMessage
+                                   quotedMessage:(nullable TSQuotedMessage *)quotedMessage
+{
+    self = [super initMessageWithTimestamp:timestamp
+                                  inThread:thread
+                               messageBody:body
+                             attachmentIds:attachmentIds
+                          expiresInSeconds:expiresInSeconds
+                           expireStartedAt:expireStartedAt
+                             quotedMessage:quotedMessage];
     if (!self) {
         return self;
     }
@@ -193,6 +100,7 @@ - (instancetype)initWithTimestamp:(uint64_t)timestamp
     _sentRecipients = [NSArray new];
     _hasSyncedTranscript = NO;
     _groupMetaMessage = groupMetaMessage;
+    _isVoiceMessage = isVoiceMessage;
 
     _attachmentFilenameMap = [NSMutableDictionary new];
 
@@ -498,6 +406,44 @@ - (OWSSignalServiceProtosDataMessage *)buildDataMessage:(NSString *_Nullable)rec
     OWSSignalServiceProtosDataMessageBuilder *builder = [self dataMessageBuilder];
     [builder setTimestamp:self.timestamp];
     [builder addLocalProfileKeyIfNecessary:self.thread recipientId:recipientId];
+
+    if (self.quotedMessage) {
+        OWSSignalServiceProtosDataMessageQuoteBuilder *quoteBuilder =
+            [OWSSignalServiceProtosDataMessageQuoteBuilder new];
+        [quoteBuilder setId:self.quotedMessage.timestamp];
+        [quoteBuilder setAuthor:self.quotedMessage.authorId];
+
+        BOOL hasQuotedText = NO;
+        BOOL hasQuotedAttachment = NO;
+        if (self.quotedMessage.body.length > 0) {
+            [quoteBuilder setText:self.quotedMessage.body];
+
+            hasQuotedText = YES;
+        }
+
+        if (self.quotedMessage.contentType.length > 0) {
+
+            OWSSignalServiceProtosAttachmentPointerBuilder *attachmentBuilder =
+                [OWSSignalServiceProtosAttachmentPointerBuilder new];
+            if (self.quotedMessage.thumbnailData.length > 0) {
+                [attachmentBuilder setThumbnail:self.quotedMessage.thumbnailData];
+            }
+            if (self.quotedMessage.sourceFilename.length > 0) {
+                [attachmentBuilder setFileName:self.quotedMessage.sourceFilename];
+            }
+            [attachmentBuilder setContentType:self.quotedMessage.contentType];
+            [quoteBuilder setAttachmentBuilder:attachmentBuilder];
+
+            hasQuotedAttachment = YES;
+        }
+
+        if (hasQuotedText || hasQuotedAttachment) {
+            [builder setQuoteBuilder:quoteBuilder];
+        } else {
+            OWSFail(@"%@ Invalid quoted message data.", self.logTag);
+        }
+    }
+
     return [builder build];
 }
 
diff --git a/SignalServiceKit/src/Messages/Interactions/TSQuotedMessage.h b/SignalServiceKit/src/Messages/Interactions/TSQuotedMessage.h
new file mode 100644
index 00000000000..0d9ae2d53fb
--- /dev/null
+++ b/SignalServiceKit/src/Messages/Interactions/TSQuotedMessage.h
@@ -0,0 +1,39 @@
+//
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
+//
+
+#import <SignalServiceKit/TSYapDatabaseObject.h>
+
+NS_ASSUME_NONNULL_BEGIN
+
+@interface TSQuotedMessage : TSYapDatabaseObject
+
+@property (nonatomic, readonly) uint64_t timestamp;
+@property (nonatomic, readonly) NSString *authorId;
+
+// This property should be set IFF we are quoting a text message.
+@property (nullable, nonatomic, readonly) NSString *body;
+
+// This property should be set IFF we are quoting a attachment message.
+@property (nullable, nonatomic, readonly) NSString *sourceFilename;
+// This property can be set IFF we are quoting a attachment message, but it is optional.
+@property (nullable, nonatomic, readonly) NSData *thumbnailData;
+// This is a MIME type.
+//
+// This property should be set IFF we are quoting a attachment message.
+@property (nullable, nonatomic, readonly) NSString *contentType;
+
+- (instancetype)init NS_UNAVAILABLE;
+
+- (instancetype)initWithTimestamp:(uint64_t)timestamp
+                         authorId:(NSString *)authorId
+                             body:(NSString *_Nullable)body
+                   sourceFilename:(NSString *_Nullable)sourceFilename
+                    thumbnailData:(NSData *_Nullable)thumbnailData
+                      contentType:(NSString *_Nullable)contentType;
+
+@end
+
+#pragma mark -
+
+NS_ASSUME_NONNULL_END
diff --git a/SignalServiceKit/src/Messages/Interactions/TSQuotedMessage.m b/SignalServiceKit/src/Messages/Interactions/TSQuotedMessage.m
new file mode 100644
index 00000000000..d6160b3a08a
--- /dev/null
+++ b/SignalServiceKit/src/Messages/Interactions/TSQuotedMessage.m
@@ -0,0 +1,38 @@
+//
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
+//
+
+#import "TSQuotedMessage.h"
+
+NS_ASSUME_NONNULL_BEGIN
+
+@implementation TSQuotedMessage
+
+- (instancetype)initWithTimestamp:(uint64_t)timestamp
+                         authorId:(NSString *)authorId
+                             body:(NSString *_Nullable)body
+                   sourceFilename:(NSString *_Nullable)sourceFilename
+                    thumbnailData:(NSData *_Nullable)thumbnailData
+                      contentType:(NSString *_Nullable)contentType
+{
+    self = [super initWithUniqueId:[NSUUID UUID].UUIDString];
+    if (!self) {
+        return self;
+    }
+
+    OWSAssert(timestamp > 0);
+    OWSAssert(authorId.length > 0);
+
+    _timestamp = timestamp;
+    _authorId = authorId;
+    _body = body;
+    _sourceFilename = sourceFilename;
+    _thumbnailData = thumbnailData;
+    _contentType = contentType;
+
+    return self;
+}
+
+@end
+
+NS_ASSUME_NONNULL_END
diff --git a/SignalServiceKit/src/Messages/OWSMessageManager.m b/SignalServiceKit/src/Messages/OWSMessageManager.m
index 5ba04270773..8ff873a2255 100644
--- a/SignalServiceKit/src/Messages/OWSMessageManager.m
+++ b/SignalServiceKit/src/Messages/OWSMessageManager.m
@@ -41,6 +41,7 @@
 #import "TSInfoMessage.h"
 #import "TSNetworkManager.h"
 #import "TSOutgoingMessage.h"
+#import "TSQuotedMessage.h"
 #import "TextSecureKitEnv.h"
 #import <YapDatabase/YapDatabase.h>
 
@@ -888,9 +889,16 @@ - (void)handleGroupInfoRequest:(OWSSignalServiceProtosEnvelope *)envelope
 
     NSString *updateGroupInfo =
         [gThread.groupModel getInfoStringAboutUpdateTo:gThread.groupModel contactsManager:self.contactsManager];
-    TSOutgoingMessage *message = [[TSOutgoingMessage alloc] initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                                                                     inThread:gThread
-                                                             groupMetaMessage:TSGroupMessageUpdate];
+    TSOutgoingMessage *message =
+        [[TSOutgoingMessage alloc] initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                                           inThread:gThread
+                                                        messageBody:nil
+                                                      attachmentIds:[NSMutableArray new]
+                                                   expiresInSeconds:0
+                                                    expireStartedAt:0
+                                                     isVoiceMessage:NO
+                                                   groupMetaMessage:TSGroupMessageUpdate
+                                                      quotedMessage:nil];
     [message updateWithCustomMessage:updateGroupInfo transaction:transaction];
     // Only send this group update to the requester.
     [message updateWithSingleGroupRecipient:envelope.source transaction:transaction];
@@ -993,19 +1001,24 @@ - (TSIncomingMessage *_Nullable)handleReceivedEnvelope:(OWSSignalServiceProtosEn
                     return nil;
                 }
 
+                TSQuotedMessage *_Nullable quotedMessage = [self quotedMessageForDataMessage:dataMessage];
+
                 DDLogDebug(@"%@ incoming message from: %@ for group: %@ with timestamp: %lu",
                     self.logTag,
                     envelopeAddress(envelope),
                     groupId,
                     (unsigned long)timestamp);
+
                 TSIncomingMessage *incomingMessage =
-                    [[TSIncomingMessage alloc] initWithTimestamp:timestamp
-                                                        inThread:oldGroupThread
-                                                        authorId:envelope.source
-                                                  sourceDeviceId:envelope.sourceDevice
-                                                     messageBody:body
-                                                   attachmentIds:attachmentIds
-                                                expiresInSeconds:dataMessage.expireTimer];
+                    [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:timestamp
+                                                                       inThread:oldGroupThread
+                                                                       authorId:envelope.source
+                                                                 sourceDeviceId:envelope.sourceDevice
+                                                                    messageBody:body
+                                                                  attachmentIds:attachmentIds
+                                                               expiresInSeconds:dataMessage.expireTimer
+                                                                  quotedMessage:quotedMessage];
+
                 [self finalizeIncomingMessage:incomingMessage
                                        thread:oldGroupThread
                                      envelope:envelope
@@ -1036,13 +1049,17 @@ - (TSIncomingMessage *_Nullable)handleReceivedEnvelope:(OWSSignalServiceProtosEn
                                                                       transaction:transaction
                                                                             relay:envelope.relay];
 
-        TSIncomingMessage *incomingMessage = [[TSIncomingMessage alloc] initWithTimestamp:timestamp
-                                                                                 inThread:thread
-                                                                                 authorId:[thread contactIdentifier]
-                                                                           sourceDeviceId:envelope.sourceDevice
-                                                                              messageBody:body
-                                                                            attachmentIds:attachmentIds
-                                                                         expiresInSeconds:dataMessage.expireTimer];
+        TSQuotedMessage *_Nullable quotedMessage = [self quotedMessageForDataMessage:dataMessage];
+
+        TSIncomingMessage *incomingMessage =
+            [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:timestamp
+                                                               inThread:thread
+                                                               authorId:[thread contactIdentifier]
+                                                         sourceDeviceId:envelope.sourceDevice
+                                                            messageBody:body
+                                                          attachmentIds:attachmentIds
+                                                       expiresInSeconds:dataMessage.expireTimer
+                                                          quotedMessage:quotedMessage];
         [self finalizeIncomingMessage:incomingMessage
                                thread:thread
                              envelope:envelope
@@ -1053,6 +1070,70 @@ - (TSIncomingMessage *_Nullable)handleReceivedEnvelope:(OWSSignalServiceProtosEn
     }
 }
 
+- (TSQuotedMessage *_Nullable)quotedMessageForDataMessage:(OWSSignalServiceProtosDataMessage *)dataMessage
+{
+    OWSAssert(dataMessage);
+
+    if (!dataMessage.hasQuote) {
+        return nil;
+    }
+
+    OWSSignalServiceProtosDataMessageQuote *quoteProto = [dataMessage quote];
+
+    if (![quoteProto hasId] || [quoteProto id] == 0) {
+        OWSFail(@"%@ quoted message missing id", self.logTag);
+        return nil;
+    }
+    uint64_t timestamp = [quoteProto id];
+
+    if (![quoteProto hasAuthor] || [quoteProto author].length == 0) {
+        OWSFail(@"%@ quoted message missing author", self.logTag);
+        return nil;
+    }
+    // TODO: We could verify that this is a valid e164 value.
+    NSString *authorId = [quoteProto author];
+
+    NSString *_Nullable body = nil;
+    BOOL hasText = NO;
+    BOOL hasAttachment = NO;
+    if ([quoteProto hasText] && [quoteProto text].length > 0) {
+        body = [quoteProto text];
+        hasText = YES;
+    }
+
+    NSString *_Nullable sourceFilename = nil;
+    NSData *_Nullable thumbnailData = nil;
+    NSString *_Nullable contentType = nil;
+
+    if ([quoteProto hasAttachment]) {
+        OWSSignalServiceProtosAttachmentPointer *attachmentProto = [quoteProto attachment];
+        if ([attachmentProto hasContentType] && attachmentProto.contentType.length > 0) {
+            contentType = attachmentProto.contentType;
+
+            if ([attachmentProto hasFileName] && attachmentProto.fileName.length > 0) {
+                sourceFilename = attachmentProto.fileName;
+            }
+            if ([attachmentProto hasThumbnail] && attachmentProto.thumbnail.length > 0) {
+                thumbnailData = [attachmentProto thumbnail];
+            }
+        }
+        hasAttachment = YES;
+    }
+
+    if (!hasText && !hasAttachment) {
+        OWSFail(@"%@ quoted message has neither text nor attachment", self.logTag);
+        return nil;
+    }
+
+    TSQuotedMessage *quotedMessage = [[TSQuotedMessage alloc] initWithTimestamp:timestamp
+                                                                       authorId:authorId
+                                                                           body:body
+                                                                 sourceFilename:sourceFilename
+                                                                  thumbnailData:thumbnailData
+                                                                    contentType:contentType];
+    return quotedMessage;
+}
+
 - (void)finalizeIncomingMessage:(TSIncomingMessage *)incomingMessage
                          thread:(TSThread *)thread
                        envelope:(OWSSignalServiceProtosEnvelope *)envelope
@@ -1069,8 +1150,6 @@ - (void)finalizeIncomingMessage:(TSIncomingMessage *)incomingMessage
 
     OWSAssert([TSAccountManager isRegistered]);
     NSString *localNumber = [TSAccountManager localNumber];
-    NSString *body = dataMessage.body;
-    uint64_t timestamp = envelope.timestamp;
 
     if (!thread) {
         OWSFail(@"%@ Can't finalize without thread", self.logTag);
diff --git a/SignalServiceKit/src/Messages/OWSMessageSender.m b/SignalServiceKit/src/Messages/OWSMessageSender.m
index e8866c430e9..60ebdea8e35 100644
--- a/SignalServiceKit/src/Messages/OWSMessageSender.m
+++ b/SignalServiceKit/src/Messages/OWSMessageSender.m
@@ -1236,13 +1236,14 @@ - (void)handleSendToMyself:(TSOutgoingMessage *)outgoingMessage
 
         // We want the incoming message to appear after the outgoing message.
         TSIncomingMessage *incomingMessage =
-            [[TSIncomingMessage alloc] initWithTimestamp:(outgoingMessage.timestamp + 1)
-                                                inThread:cThread
-                                                authorId:[cThread contactIdentifier]
-                                          sourceDeviceId:[OWSDevice currentDeviceId]
-                                             messageBody:outgoingMessage.body
-                                           attachmentIds:attachmentIds
-                                        expiresInSeconds:outgoingMessage.expiresInSeconds];
+            [[TSIncomingMessage alloc] initIncomingMessageWithTimestamp:(outgoingMessage.timestamp + 1)
+                                                               inThread:cThread
+                                                               authorId:[cThread contactIdentifier]
+                                                         sourceDeviceId:[OWSDevice currentDeviceId]
+                                                            messageBody:outgoingMessage.body
+                                                          attachmentIds:attachmentIds
+                                                       expiresInSeconds:outgoingMessage.expiresInSeconds
+                                                          quotedMessage:outgoingMessage.quotedMessage];
         [incomingMessage saveWithTransaction:transaction];
     }];
 }
diff --git a/SignalServiceKit/src/Messages/OWSMessageUtils.h b/SignalServiceKit/src/Messages/OWSMessageUtils.h
index 2e2d05fe862..bca37b88eab 100644
--- a/SignalServiceKit/src/Messages/OWSMessageUtils.h
+++ b/SignalServiceKit/src/Messages/OWSMessageUtils.h
@@ -4,7 +4,11 @@
 
 NS_ASSUME_NONNULL_BEGIN
 
+@class TSIncomingMessage;
+@class TSOutgoingMessage;
+@class TSQuotedMessage;
 @class TSThread;
+@class YapDatabaseReadWriteTransaction;
 
 @interface OWSMessageUtils : NSObject
 
@@ -17,6 +21,12 @@ NS_ASSUME_NONNULL_BEGIN
 
 - (void)updateApplicationBadgeCount;
 
++ (nullable TSQuotedMessage *)quotedMessageForIncomingMessage:(TSIncomingMessage *)message
+                                                  transaction:(YapDatabaseReadWriteTransaction *)transaction;
+
++ (nullable TSQuotedMessage *)quotedMessageForOutgoingMessage:(TSOutgoingMessage *)message
+                                                  transaction:(YapDatabaseReadWriteTransaction *)transaction;
+
 @end
 
 NS_ASSUME_NONNULL_END
diff --git a/SignalServiceKit/src/Messages/OWSMessageUtils.m b/SignalServiceKit/src/Messages/OWSMessageUtils.m
index cb0a8ece960..1607b184385 100644
--- a/SignalServiceKit/src/Messages/OWSMessageUtils.m
+++ b/SignalServiceKit/src/Messages/OWSMessageUtils.m
@@ -5,8 +5,16 @@
 #import "OWSMessageUtils.h"
 #import "AppContext.h"
 #import "OWSPrimaryStorage.h"
+#import "TSAccountManager.h"
+#import "TSAttachment.h"
+#import "TSAttachmentStream.h"
 #import "TSDatabaseView.h"
+#import "TSIncomingMessage.h"
+#import "TSMessage.h"
+#import "TSOutgoingMessage.h"
+#import "TSQuotedMessage.h"
 #import "TSThread.h"
+#import "UIImage+OWS.h"
 #import <YapDatabase/YapDatabase.h>
 
 NS_ASSUME_NONNULL_BEGIN
@@ -94,6 +102,138 @@ - (NSUInteger)unreadMessagesInThread:(TSThread *)thread
     return numberOfItems;
 }
 
++ (nullable TSQuotedMessage *)quotedMessageForIncomingMessage:(TSIncomingMessage *)message
+                                                  transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    OWSAssert(message);
+    OWSAssert(transaction);
+
+    return [self quotedMessageForMessage:message
+                                authorId:message.authorId
+                                  thread:[message threadWithTransaction:transaction]
+                             transaction:transaction];
+}
+
++ (nullable TSQuotedMessage *)quotedMessageForOutgoingMessage:(TSOutgoingMessage *)message
+                                                  transaction:(YapDatabaseReadWriteTransaction *)transaction
+{
+    OWSAssert(message);
+    OWSAssert(transaction);
+
+    return [self quotedMessageForMessage:message
+                                authorId:TSAccountManager.localNumber
+                                  thread:[message threadWithTransaction:transaction]
+                             transaction:transaction];
+}
+
++ (nullable TSQuotedMessage *)quotedMessageForMessage:(TSMessage *)message
+                                             authorId:(NSString *)authorId
+                                               thread:(TSThread *)thread
+                                          transaction:(YapDatabaseReadTransaction *)transaction
+{
+    OWSAssert(message);
+    OWSAssert(authorId.length > 0);
+    OWSAssert(thread);
+    OWSAssert(transaction);
+
+    uint64_t timestamp = message.timestamp;
+    NSString *_Nullable body = message.body;
+    BOOL hasText = body.length > 0;
+    BOOL hasAttachment = NO;
+    NSString *_Nullable sourceFilename = nil;
+    NSData *_Nullable thumbnailData = nil;
+    NSString *_Nullable contentType = nil;
+
+    if (message.attachmentIds.count > 0) {
+        NSString *attachmentId = message.attachmentIds[0];
+        TSAttachment *_Nullable attachment =
+            [TSAttachment fetchObjectWithUniqueID:attachmentId transaction:transaction];
+        if (attachment) {
+            sourceFilename = attachment.sourceFilename;
+            contentType = attachment.contentType;
+            // Try to generate a thumbnail, if possible.
+            thumbnailData = [self thumbnailDataForAttachment:attachment];
+            hasAttachment = YES;
+        }
+    }
+
+    if (!hasText && !hasAttachment) {
+        OWSFail(@"%@ quoted message has neither text nor attachment", self.logTag);
+        return nil;
+    }
+
+    TSQuotedMessage *quotedMessage = [[TSQuotedMessage alloc] initWithTimestamp:timestamp
+                                                                       authorId:authorId
+                                                                           body:body
+                                                                 sourceFilename:sourceFilename
+                                                                  thumbnailData:thumbnailData
+                                                                    contentType:contentType];
+    return quotedMessage;
+}
+
++ (nullable NSData *)thumbnailDataForAttachment:(TSAttachment *)attachment
+{
+    OWSAssert(attachment);
+
+    // Try to generate a thumbnail, if possible.
+    if (![attachment isKindOfClass:[TSAttachmentStream class]]) {
+        return nil;
+    }
+
+    TSAttachmentStream *attachmentStream = (TSAttachmentStream *)attachment;
+    UIImage *_Nullable attachmentImage = [attachmentStream image];
+    if (!attachmentImage) {
+        return nil;
+    }
+
+    CGSize attachmentImageSizePx;
+    attachmentImageSizePx.width = CGImageGetWidth(attachmentImage.CGImage);
+    attachmentImageSizePx.height = CGImageGetHeight(attachmentImage.CGImage);
+    if (attachmentImageSizePx.width <= 0 || attachmentImageSizePx.height <= 0) {
+        DDLogError(@"%@ attachment thumbnail has invalid size.", self.logTag);
+        return nil;
+    }
+
+    const int kMaxThumbnailSizePx = 100;
+
+    // Try to resize image to thumbnail if necessary.
+    if (attachmentImageSizePx.width > kMaxThumbnailSizePx || attachmentImageSizePx.height > kMaxThumbnailSizePx) {
+        const CGFloat widthFactor = kMaxThumbnailSizePx / attachmentImageSizePx.width;
+        const CGFloat heightFactor = kMaxThumbnailSizePx / attachmentImageSizePx.height;
+        const CGFloat scalingFactor = MIN(widthFactor, heightFactor);
+        const CGFloat scaledWidthPx = (CGFloat)round(attachmentImageSizePx.width * scalingFactor);
+        const CGFloat scaledHeightPx = (CGFloat)round(attachmentImageSizePx.height * scalingFactor);
+
+        if (scaledWidthPx <= 0 || scaledHeightPx <= 0) {
+            DDLogError(@"%@ can't determined desired size for attachment thumbnail.", self.logTag);
+            return nil;
+        }
+
+        if (scaledWidthPx > 0 && scaledHeightPx > 0) {
+            attachmentImage = [attachmentImage resizedImageToSize:CGSizeMake(scaledWidthPx, scaledHeightPx)];
+            if (!attachmentImage) {
+                DDLogError(@"%@ attachment thumbnail could not be resized.", self.logTag);
+                return nil;
+            }
+
+            attachmentImageSizePx.width = CGImageGetWidth(attachmentImage.CGImage);
+            attachmentImageSizePx.height = CGImageGetHeight(attachmentImage.CGImage);
+        }
+    }
+
+    if (attachmentImageSizePx.width <= 0 || attachmentImageSizePx.height <= 0) {
+        DDLogError(@"%@ resized attachment thumbnail has invalid size.", self.logTag);
+        return nil;
+    }
+
+    NSData *_Nullable attachmentImageData = UIImagePNGRepresentation(attachmentImage);
+    if (!attachmentImage) {
+        OWSFail(@"%@ attachment thumbnail could not be written to PNG.", self.logTag);
+        return nil;
+    }
+    return attachmentImageData;
+}
+
 @end
 
 NS_ASSUME_NONNULL_END
diff --git a/SignalServiceKit/src/Messages/OWSOutgoingCallMessage.m b/SignalServiceKit/src/Messages/OWSOutgoingCallMessage.m
index 56186563642..3ff93dac613 100644
--- a/SignalServiceKit/src/Messages/OWSOutgoingCallMessage.m
+++ b/SignalServiceKit/src/Messages/OWSOutgoingCallMessage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSOutgoingCallMessage.h"
@@ -18,13 +18,19 @@
 
 @implementation OWSOutgoingCallMessage
 
-//@synthesize thread = _thread;
-
 - (instancetype)initWithThread:(TSThread *)thread
 {
     // These records aren't saved, but their timestamp is used in the event
     // of a failing message send to insert the error at the appropriate place.
-    self = [super initWithTimestamp:[NSDate ows_millisecondTimeStamp] inThread:thread];
+    self = [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:thread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
     if (!self) {
         return self;
     }
diff --git a/SignalServiceKit/src/Messages/OWSOutgoingNullMessage.m b/SignalServiceKit/src/Messages/OWSOutgoingNullMessage.m
index b75056bcb13..e12dcf791de 100644
--- a/SignalServiceKit/src/Messages/OWSOutgoingNullMessage.m
+++ b/SignalServiceKit/src/Messages/OWSOutgoingNullMessage.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSOutgoingNullMessage.h"
@@ -17,13 +17,22 @@ @interface OWSOutgoingNullMessage ()
 
 @end
 
+#pragma mark -
+
 @implementation OWSOutgoingNullMessage
 
 - (instancetype)initWithContactThread:(TSContactThread *)contactThread
          verificationStateSyncMessage:(OWSVerificationStateSyncMessage *)verificationStateSyncMessage
 {
-    self = [super initWithTimestamp:[NSDate ows_millisecondTimeStamp]
-                           inThread:contactThread];
+    self = [super initOutgoingMessageWithTimestamp:[NSDate ows_millisecondTimeStamp]
+                                          inThread:contactThread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
     if (!self) {
         return self;
     }
diff --git a/SignalServiceKit/src/Messages/OWSProfileKeyMessage.h b/SignalServiceKit/src/Messages/OWSProfileKeyMessage.h
index cd8c4d73a65..b223199ac37 100644
--- a/SignalServiceKit/src/Messages/OWSProfileKeyMessage.h
+++ b/SignalServiceKit/src/Messages/OWSProfileKeyMessage.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "TSOutgoingMessage.h"
@@ -8,6 +8,8 @@ NS_ASSUME_NONNULL_BEGIN
 
 @interface OWSProfileKeyMessage : TSOutgoingMessage
 
+- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread NS_DESIGNATED_INITIALIZER;
+
 @end
 
 NS_ASSUME_NONNULL_END
diff --git a/SignalServiceKit/src/Messages/OWSProfileKeyMessage.m b/SignalServiceKit/src/Messages/OWSProfileKeyMessage.m
index c79e0a3ba0d..207a19ea5b3 100644
--- a/SignalServiceKit/src/Messages/OWSProfileKeyMessage.m
+++ b/SignalServiceKit/src/Messages/OWSProfileKeyMessage.m
@@ -12,6 +12,19 @@
 
 @implementation OWSProfileKeyMessage
 
+- (instancetype)initWithTimestamp:(uint64_t)timestamp inThread:(nullable TSThread *)thread
+{
+    return [super initOutgoingMessageWithTimestamp:timestamp
+                                          inThread:thread
+                                       messageBody:nil
+                                     attachmentIds:[NSMutableArray new]
+                                  expiresInSeconds:0
+                                   expireStartedAt:0
+                                    isVoiceMessage:NO
+                                  groupMetaMessage:TSGroupMessageNone
+                                     quotedMessage:nil];
+}
+
 - (BOOL)shouldBeSaved
 {
     return NO;
diff --git a/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.h b/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.h
index 2307512a3a1..1c4de7803e5 100644
--- a/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.h
+++ b/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.h
@@ -1,4 +1,6 @@
-// Generated by the protocol buffer compiler.  DO NOT EDIT!
+//
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
+//
 
 #import <ProtocolBuffers/ProtocolBuffers.h>
 
@@ -26,6 +28,8 @@
 @class OWSSignalServiceProtosContentBuilder;
 @class OWSSignalServiceProtosDataMessage;
 @class OWSSignalServiceProtosDataMessageBuilder;
+@class OWSSignalServiceProtosDataMessageQuote;
+@class OWSSignalServiceProtosDataMessageQuoteBuilder;
 @class OWSSignalServiceProtosEnvelope;
 @class OWSSignalServiceProtosEnvelopeBuilder;
 @class OWSSignalServiceProtosGroupContext;
@@ -101,7 +105,6 @@
 @class PBUninterpretedOptionNamePart;
 @class PBUninterpretedOptionNamePartBuilder;
 
-
 typedef NS_ENUM(SInt32, OWSSignalServiceProtosEnvelopeType) {
   OWSSignalServiceProtosEnvelopeTypeUnknown = 0,
   OWSSignalServiceProtosEnvelopeTypeCiphertext = 1,
@@ -800,17 +803,20 @@ NSString *NSStringFromOWSSignalServiceProtosGroupContextType(OWSSignalServicePro
 #define DataMessage_expireTimer @"expireTimer"
 #define DataMessage_profileKey @"profileKey"
 #define DataMessage_timestamp @"timestamp"
+#define DataMessage_quote @"quote"
 @interface OWSSignalServiceProtosDataMessage : PBGeneratedMessage<GeneratedMessageProtocol> {
 @private
   BOOL hasTimestamp_:1;
   BOOL hasBody_:1;
   BOOL hasGroup_:1;
+  BOOL hasQuote_ : 1;
   BOOL hasProfileKey_:1;
   BOOL hasFlags_:1;
   BOOL hasExpireTimer_:1;
   UInt64 timestamp;
   NSString* body;
   OWSSignalServiceProtosGroupContext* group;
+  OWSSignalServiceProtosDataMessageQuote *quote;
   NSData* profileKey;
   UInt32 flags;
   UInt32 expireTimer;
@@ -822,6 +828,7 @@ NSString *NSStringFromOWSSignalServiceProtosGroupContextType(OWSSignalServicePro
 - (BOOL) hasExpireTimer;
 - (BOOL) hasProfileKey;
 - (BOOL) hasTimestamp;
+- (BOOL)hasQuote;
 @property (readonly, strong) NSString* body;
 @property (readonly, strong) NSArray<OWSSignalServiceProtosAttachmentPointer*> * attachments;
 @property (readonly, strong) OWSSignalServiceProtosGroupContext* group;
@@ -829,6 +836,7 @@ NSString *NSStringFromOWSSignalServiceProtosGroupContextType(OWSSignalServicePro
 @property (readonly) UInt32 expireTimer;
 @property (readonly, strong) NSData* profileKey;
 @property (readonly) UInt64 timestamp;
+@property (readonly, strong) OWSSignalServiceProtosDataMessageQuote *quote;
 - (OWSSignalServiceProtosAttachmentPointer*)attachmentsAtIndex:(NSUInteger)index;
 
 + (instancetype) defaultInstance;
@@ -849,6 +857,94 @@ NSString *NSStringFromOWSSignalServiceProtosGroupContextType(OWSSignalServicePro
 + (OWSSignalServiceProtosDataMessage*) parseFromCodedInputStream:(PBCodedInputStream*) input extensionRegistry:(PBExtensionRegistry*) extensionRegistry;
 @end
 
+#define Quote_id @"id"
+#define Quote_author @"author"
+#define Quote_text @"text"
+#define Quote_attachment @"attachment"
+@interface OWSSignalServiceProtosDataMessageQuote : PBGeneratedMessage <GeneratedMessageProtocol> {
+@private
+    BOOL hasId_ : 1;
+    BOOL hasAuthor_ : 1;
+    BOOL hasText_ : 1;
+    BOOL hasAttachment_ : 1;
+    UInt64 id;
+    NSString *author;
+    NSString *text;
+    OWSSignalServiceProtosAttachmentPointer *attachment;
+}
+- (BOOL)hasId;
+- (BOOL)hasAuthor;
+- (BOOL)hasText;
+- (BOOL)hasAttachment;
+@property (readonly) UInt64 id;
+@property (readonly, strong) NSString *author;
+@property (readonly, strong) NSString *text;
+@property (readonly, strong) OWSSignalServiceProtosAttachmentPointer *attachment;
+
++ (instancetype)defaultInstance;
+- (instancetype)defaultInstance;
+
+- (BOOL)isInitialized;
+- (void)writeToCodedOutputStream:(PBCodedOutputStream *)output;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)builder;
++ (OWSSignalServiceProtosDataMessageQuoteBuilder *)builder;
++ (OWSSignalServiceProtosDataMessageQuoteBuilder *)builderWithPrototype:
+    (OWSSignalServiceProtosDataMessageQuote *)prototype;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)toBuilder;
+
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromData:(NSData *)data;
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromData:(NSData *)data
+                                        extensionRegistry:(PBExtensionRegistry *)extensionRegistry;
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromInputStream:(NSInputStream *)input;
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromInputStream:(NSInputStream *)input
+                                               extensionRegistry:(PBExtensionRegistry *)extensionRegistry;
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromCodedInputStream:(PBCodedInputStream *)input;
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromCodedInputStream:(PBCodedInputStream *)input
+                                                    extensionRegistry:(PBExtensionRegistry *)extensionRegistry;
+@end
+
+@interface OWSSignalServiceProtosDataMessageQuoteBuilder : PBGeneratedMessageBuilder {
+@private
+    OWSSignalServiceProtosDataMessageQuote *resultQuote;
+}
+
+- (OWSSignalServiceProtosDataMessageQuote *)defaultInstance;
+
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clear;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clone;
+
+- (OWSSignalServiceProtosDataMessageQuote *)build;
+- (OWSSignalServiceProtosDataMessageQuote *)buildPartial;
+
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeFrom:(OWSSignalServiceProtosDataMessageQuote *)other;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeFromCodedInputStream:(PBCodedInputStream *)input;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeFromCodedInputStream:(PBCodedInputStream *)input
+                                                           extensionRegistry:(PBExtensionRegistry *)extensionRegistry;
+
+- (BOOL)hasId;
+- (UInt64)id;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setId:(UInt64)value;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearId;
+
+- (BOOL)hasAuthor;
+- (NSString *)author;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setAuthor:(NSString *)value;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearAuthor;
+
+- (BOOL)hasText;
+- (NSString *)text;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setText:(NSString *)value;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearText;
+
+- (BOOL)hasAttachment;
+- (OWSSignalServiceProtosAttachmentPointer *)attachment;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setAttachment:(OWSSignalServiceProtosAttachmentPointer *)value;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setAttachmentBuilder:
+    (OWSSignalServiceProtosAttachmentPointerBuilder *)builderForValue;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeAttachment:(OWSSignalServiceProtosAttachmentPointer *)value;
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearAttachment;
+@end
+
 @interface OWSSignalServiceProtosDataMessageBuilder : PBGeneratedMessageBuilder {
 @private
   OWSSignalServiceProtosDataMessage* resultDataMessage;
@@ -903,6 +999,14 @@ NSString *NSStringFromOWSSignalServiceProtosGroupContextType(OWSSignalServicePro
 - (UInt64) timestamp;
 - (OWSSignalServiceProtosDataMessageBuilder*) setTimestamp:(UInt64) value;
 - (OWSSignalServiceProtosDataMessageBuilder*) clearTimestamp;
+
+- (BOOL)hasQuote;
+- (OWSSignalServiceProtosDataMessageQuote *)quote;
+- (OWSSignalServiceProtosDataMessageBuilder *)setQuote:(OWSSignalServiceProtosDataMessageQuote *)value;
+- (OWSSignalServiceProtosDataMessageBuilder *)setQuoteBuilder:
+    (OWSSignalServiceProtosDataMessageQuoteBuilder *)builderForValue;
+- (OWSSignalServiceProtosDataMessageBuilder *)mergeQuote:(OWSSignalServiceProtosDataMessageQuote *)value;
+- (OWSSignalServiceProtosDataMessageBuilder *)clearQuote;
 @end
 
 #define NullMessage_padding @"padding"
diff --git a/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.m b/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.m
index 9b81f29081b..c0bff0827d3 100644
--- a/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.m
+++ b/SignalServiceKit/src/Messages/OWSSignalServiceProtos.pb.m
@@ -1,6 +1,9 @@
-// Generated by the protocol buffer compiler.  DO NOT EDIT!
+//
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
+//
 
 #import "OWSSignalServiceProtos.pb.h"
+
 // @@protoc_insertion_point(imports)
 
 @implementation OWSSignalServiceProtosOwssignalServiceProtosRoot
@@ -2922,6 +2925,7 @@ @interface OWSSignalServiceProtosDataMessage ()
 @property UInt32 expireTimer;
 @property (strong) NSData* profileKey;
 @property UInt64 timestamp;
+@property (strong) OWSSignalServiceProtosDataMessageQuote *quote;
 @end
 
 @implementation OWSSignalServiceProtosDataMessage
@@ -2970,6 +2974,15 @@ - (void) setHasTimestamp:(BOOL) _value_ {
   hasTimestamp_ = !!_value_;
 }
 @synthesize timestamp;
+- (BOOL)hasQuote
+{
+    return !!hasQuote_;
+}
+- (void)setHasQuote:(BOOL)_value_
+{
+    hasQuote_ = !!_value_;
+}
+@synthesize quote;
 - (instancetype) init {
   if ((self = [super init])) {
     self.body = @"";
@@ -2978,6 +2991,7 @@ - (instancetype) init {
     self.expireTimer = 0;
     self.profileKey = [NSData data];
     self.timestamp = 0L;
+    self.quote = [OWSSignalServiceProtosDataMessageQuote defaultInstance];
   }
   return self;
 }
@@ -3024,6 +3038,9 @@ - (void) writeToCodedOutputStream:(PBCodedOutputStream*) output {
   if (self.hasTimestamp) {
     [output writeUInt64:7 value:self.timestamp];
   }
+  if (self.hasQuote) {
+      [output writeMessage:8 value:self.quote];
+  }
   [self.unknownFields writeToCodedOutputStream:output];
 }
 - (SInt32) serializedSize {
@@ -3054,6 +3071,9 @@ - (SInt32) serializedSize {
   if (self.hasTimestamp) {
     size_ += computeUInt64Size(7, self.timestamp);
   }
+  if (self.hasQuote) {
+      size_ += computeMessageSize(8, self.quote);
+  }
   size_ += self.unknownFields.serializedSize;
   memoizedSerializedSize = size_;
   return size_;
@@ -3116,6 +3136,11 @@ - (void) writeDescriptionTo:(NSMutableString*) output withIndent:(NSString*) ind
   if (self.hasTimestamp) {
     [output appendFormat:@"%@%@: %@\n", indent, @"timestamp", [NSNumber numberWithLongLong:self.timestamp]];
   }
+  if (self.hasQuote) {
+      [output appendFormat:@"%@%@ {\n", indent, @"quote"];
+      [self.quote writeDescriptionTo:output withIndent:[NSString stringWithFormat:@"%@  ", indent]];
+      [output appendFormat:@"%@}\n", indent];
+  }
   [self.unknownFields writeDescriptionTo:output withIndent:indent];
 }
 - (void) storeInDictionary:(NSMutableDictionary *)dictionary {
@@ -3144,6 +3169,11 @@ - (void) storeInDictionary:(NSMutableDictionary *)dictionary {
   if (self.hasTimestamp) {
     [dictionary setObject: [NSNumber numberWithLongLong:self.timestamp] forKey: @"timestamp"];
   }
+  if (self.hasQuote) {
+      NSMutableDictionary *messageDictionary = [NSMutableDictionary dictionary];
+      [self.quote storeInDictionary:messageDictionary];
+      [dictionary setObject:[NSDictionary dictionaryWithDictionary:messageDictionary] forKey:@"quote"];
+  }
   [self.unknownFields storeInDictionary:dictionary];
 }
 - (BOOL) isEqual:(id)other {
@@ -3154,21 +3184,18 @@ - (BOOL) isEqual:(id)other {
     return NO;
   }
   OWSSignalServiceProtosDataMessage *otherMessage = other;
-  return
-      self.hasBody == otherMessage.hasBody &&
-      (!self.hasBody || [self.body isEqual:otherMessage.body]) &&
-      [self.attachmentsArray isEqualToArray:otherMessage.attachmentsArray] &&
-      self.hasGroup == otherMessage.hasGroup &&
-      (!self.hasGroup || [self.group isEqual:otherMessage.group]) &&
-      self.hasFlags == otherMessage.hasFlags &&
-      (!self.hasFlags || self.flags == otherMessage.flags) &&
-      self.hasExpireTimer == otherMessage.hasExpireTimer &&
-      (!self.hasExpireTimer || self.expireTimer == otherMessage.expireTimer) &&
-      self.hasProfileKey == otherMessage.hasProfileKey &&
-      (!self.hasProfileKey || [self.profileKey isEqual:otherMessage.profileKey]) &&
-      self.hasTimestamp == otherMessage.hasTimestamp &&
-      (!self.hasTimestamp || self.timestamp == otherMessage.timestamp) &&
-      (self.unknownFields == otherMessage.unknownFields || (self.unknownFields != nil && [self.unknownFields isEqual:otherMessage.unknownFields]));
+  return self.hasBody == otherMessage.hasBody && (!self.hasBody || [self.body isEqual:otherMessage.body]) &&
+      [self.attachmentsArray isEqualToArray:otherMessage.attachmentsArray] && self.hasGroup == otherMessage.hasGroup
+      && (!self.hasGroup || [self.group isEqual:otherMessage.group]) && self.hasFlags == otherMessage.hasFlags
+      && (!self.hasFlags || self.flags == otherMessage.flags) && self.hasExpireTimer == otherMessage.hasExpireTimer
+      && (!self.hasExpireTimer || self.expireTimer == otherMessage.expireTimer)
+      && self.hasProfileKey == otherMessage.hasProfileKey
+      && (!self.hasProfileKey || [self.profileKey isEqual:otherMessage.profileKey])
+      && self.hasTimestamp == otherMessage.hasTimestamp
+      && (!self.hasTimestamp || self.timestamp == otherMessage.timestamp) && self.hasQuote == otherMessage.hasQuote
+      && (!self.hasQuote || [self.quote isEqual:otherMessage.quote])
+      && (self.unknownFields == otherMessage.unknownFields
+             || (self.unknownFields != nil && [self.unknownFields isEqual:otherMessage.unknownFields]));
 }
 - (NSUInteger) hash {
   __block NSUInteger hashCode = 7;
@@ -3193,6 +3220,9 @@ - (NSUInteger) hash {
   if (self.hasTimestamp) {
     hashCode = hashCode * 31 + [[NSNumber numberWithLongLong:self.timestamp] hash];
   }
+  if (self.hasQuote) {
+      hashCode = hashCode * 31 + [self.quote hash];
+  }
   hashCode = hashCode * 31 + [self.unknownFields hash];
   return hashCode;
 }
@@ -3221,6 +3251,455 @@ BOOL OWSSignalServiceProtosDataMessageFlagsIsValidValue(OWSSignalServiceProtosDa
   }
 }
 
+@interface OWSSignalServiceProtosDataMessageQuote ()
+@property UInt64 id;
+@property (strong) NSString *author;
+@property (strong) NSString *text;
+@property (strong) OWSSignalServiceProtosAttachmentPointer *attachment;
+@end
+
+@implementation OWSSignalServiceProtosDataMessageQuote
+
+- (BOOL)hasId
+{
+    return !!hasId_;
+}
+- (void)setHasId:(BOOL)_value_
+{
+    hasId_ = !!_value_;
+}
+@synthesize id;
+- (BOOL)hasAuthor
+{
+    return !!hasAuthor_;
+}
+- (void)setHasAuthor:(BOOL)_value_
+{
+    hasAuthor_ = !!_value_;
+}
+@synthesize author;
+- (BOOL)hasText
+{
+    return !!hasText_;
+}
+- (void)setHasText:(BOOL)_value_
+{
+    hasText_ = !!_value_;
+}
+@synthesize text;
+- (BOOL)hasAttachment
+{
+    return !!hasAttachment_;
+}
+- (void)setHasAttachment:(BOOL)_value_
+{
+    hasAttachment_ = !!_value_;
+}
+@synthesize attachment;
+- (instancetype)init
+{
+    if ((self = [super init])) {
+        self.id = 0L;
+        self.author = @"";
+        self.text = @"";
+        self.attachment = [OWSSignalServiceProtosAttachmentPointer defaultInstance];
+    }
+    return self;
+}
+static OWSSignalServiceProtosDataMessageQuote *defaultOWSSignalServiceProtosDataMessageQuoteInstance = nil;
++ (void)initialize
+{
+    if (self == [OWSSignalServiceProtosDataMessageQuote class]) {
+        defaultOWSSignalServiceProtosDataMessageQuoteInstance = [[OWSSignalServiceProtosDataMessageQuote alloc] init];
+    }
+}
++ (instancetype)defaultInstance
+{
+    return defaultOWSSignalServiceProtosDataMessageQuoteInstance;
+}
+- (instancetype)defaultInstance
+{
+    return defaultOWSSignalServiceProtosDataMessageQuoteInstance;
+}
+- (BOOL)isInitialized
+{
+    return YES;
+}
+- (void)writeToCodedOutputStream:(PBCodedOutputStream *)output
+{
+    if (self.hasId) {
+        [output writeUInt64:1 value:self.id];
+    }
+    if (self.hasAuthor) {
+        [output writeString:2 value:self.author];
+    }
+    if (self.hasText) {
+        [output writeString:3 value:self.text];
+    }
+    if (self.hasAttachment) {
+        [output writeMessage:4 value:self.attachment];
+    }
+    [self.unknownFields writeToCodedOutputStream:output];
+}
+- (SInt32)serializedSize
+{
+    __block SInt32 size_ = memoizedSerializedSize;
+    if (size_ != -1) {
+        return size_;
+    }
+
+    size_ = 0;
+    if (self.hasId) {
+        size_ += computeUInt64Size(1, self.id);
+    }
+    if (self.hasAuthor) {
+        size_ += computeStringSize(2, self.author);
+    }
+    if (self.hasText) {
+        size_ += computeStringSize(3, self.text);
+    }
+    if (self.hasAttachment) {
+        size_ += computeMessageSize(4, self.attachment);
+    }
+    size_ += self.unknownFields.serializedSize;
+    memoizedSerializedSize = size_;
+    return size_;
+}
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromData:(NSData *)data
+{
+    return (OWSSignalServiceProtosDataMessageQuote *)[
+        [[OWSSignalServiceProtosDataMessageQuote builder] mergeFromData:data] build];
+}
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromData:(NSData *)data
+                                        extensionRegistry:(PBExtensionRegistry *)extensionRegistry
+{
+    return (OWSSignalServiceProtosDataMessageQuote *)[
+        [[OWSSignalServiceProtosDataMessageQuote builder] mergeFromData:data extensionRegistry:extensionRegistry]
+        build];
+}
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromInputStream:(NSInputStream *)input
+{
+    return (OWSSignalServiceProtosDataMessageQuote *)[
+        [[OWSSignalServiceProtosDataMessageQuote builder] mergeFromInputStream:input] build];
+}
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromInputStream:(NSInputStream *)input
+                                               extensionRegistry:(PBExtensionRegistry *)extensionRegistry
+{
+    return (OWSSignalServiceProtosDataMessageQuote *)[
+        [[OWSSignalServiceProtosDataMessageQuote builder] mergeFromInputStream:input
+                                                             extensionRegistry:extensionRegistry] build];
+}
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromCodedInputStream:(PBCodedInputStream *)input
+{
+    return (OWSSignalServiceProtosDataMessageQuote *)[
+        [[OWSSignalServiceProtosDataMessageQuote builder] mergeFromCodedInputStream:input] build];
+}
++ (OWSSignalServiceProtosDataMessageQuote *)parseFromCodedInputStream:(PBCodedInputStream *)input
+                                                    extensionRegistry:(PBExtensionRegistry *)extensionRegistry
+{
+    return (OWSSignalServiceProtosDataMessageQuote *)[
+        [[OWSSignalServiceProtosDataMessageQuote builder] mergeFromCodedInputStream:input
+                                                                  extensionRegistry:extensionRegistry] build];
+}
++ (OWSSignalServiceProtosDataMessageQuoteBuilder *)builder
+{
+    return [[OWSSignalServiceProtosDataMessageQuoteBuilder alloc] init];
+}
++ (OWSSignalServiceProtosDataMessageQuoteBuilder *)builderWithPrototype:
+    (OWSSignalServiceProtosDataMessageQuote *)prototype
+{
+    return [[OWSSignalServiceProtosDataMessageQuote builder] mergeFrom:prototype];
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)builder
+{
+    return [OWSSignalServiceProtosDataMessageQuote builder];
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)toBuilder
+{
+    return [OWSSignalServiceProtosDataMessageQuote builderWithPrototype:self];
+}
+- (void)writeDescriptionTo:(NSMutableString *)output withIndent:(NSString *)indent
+{
+    if (self.hasId) {
+        [output appendFormat:@"%@%@: %@\n", indent, @"id", [NSNumber numberWithLongLong:self.id]];
+    }
+    if (self.hasAuthor) {
+        [output appendFormat:@"%@%@: %@\n", indent, @"author", self.author];
+    }
+    if (self.hasText) {
+        [output appendFormat:@"%@%@: %@\n", indent, @"text", self.text];
+    }
+    if (self.hasAttachment) {
+        [output appendFormat:@"%@%@ {\n", indent, @"attachment"];
+        [self.attachment writeDescriptionTo:output withIndent:[NSString stringWithFormat:@"%@  ", indent]];
+        [output appendFormat:@"%@}\n", indent];
+    }
+    [self.unknownFields writeDescriptionTo:output withIndent:indent];
+}
+- (void)storeInDictionary:(NSMutableDictionary *)dictionary
+{
+    if (self.hasId) {
+        [dictionary setObject:[NSNumber numberWithLongLong:self.id] forKey:@"id"];
+    }
+    if (self.hasAuthor) {
+        [dictionary setObject:self.author forKey:@"author"];
+    }
+    if (self.hasText) {
+        [dictionary setObject:self.text forKey:@"text"];
+    }
+    if (self.hasAttachment) {
+        NSMutableDictionary *messageDictionary = [NSMutableDictionary dictionary];
+        [self.attachment storeInDictionary:messageDictionary];
+        [dictionary setObject:[NSDictionary dictionaryWithDictionary:messageDictionary] forKey:@"attachment"];
+    }
+    [self.unknownFields storeInDictionary:dictionary];
+}
+- (BOOL)isEqual:(id)other
+{
+    if (other == self) {
+        return YES;
+    }
+    if (![other isKindOfClass:[OWSSignalServiceProtosDataMessageQuote class]]) {
+        return NO;
+    }
+    OWSSignalServiceProtosDataMessageQuote *otherMessage = other;
+    return self.hasId == otherMessage.hasId && (!self.hasId || self.id == otherMessage.id)
+        && self.hasAuthor == otherMessage.hasAuthor && (!self.hasAuthor || [self.author isEqual:otherMessage.author])
+        && self.hasText == otherMessage.hasText && (!self.hasText || [self.text isEqual:otherMessage.text])
+        && self.hasAttachment == otherMessage.hasAttachment
+        && (!self.hasAttachment || [self.attachment isEqual:otherMessage.attachment])
+        && (self.unknownFields == otherMessage.unknownFields
+               || (self.unknownFields != nil && [self.unknownFields isEqual:otherMessage.unknownFields]));
+}
+- (NSUInteger)hash
+{
+    __block NSUInteger hashCode = 7;
+    if (self.hasId) {
+        hashCode = hashCode * 31 + [[NSNumber numberWithLongLong:self.id] hash];
+    }
+    if (self.hasAuthor) {
+        hashCode = hashCode * 31 + [self.author hash];
+    }
+    if (self.hasText) {
+        hashCode = hashCode * 31 + [self.text hash];
+    }
+    if (self.hasAttachment) {
+        hashCode = hashCode * 31 + [self.attachment hash];
+    }
+    hashCode = hashCode * 31 + [self.unknownFields hash];
+    return hashCode;
+}
+@end
+
+@interface OWSSignalServiceProtosDataMessageQuoteBuilder ()
+@property (strong) OWSSignalServiceProtosDataMessageQuote *resultQuote;
+@end
+
+@implementation OWSSignalServiceProtosDataMessageQuoteBuilder
+@synthesize resultQuote;
+- (instancetype)init
+{
+    if ((self = [super init])) {
+        self.resultQuote = [[OWSSignalServiceProtosDataMessageQuote alloc] init];
+    }
+    return self;
+}
+- (PBGeneratedMessage *)internalGetResult
+{
+    return resultQuote;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clear
+{
+    self.resultQuote = [[OWSSignalServiceProtosDataMessageQuote alloc] init];
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clone
+{
+    return [OWSSignalServiceProtosDataMessageQuote builderWithPrototype:resultQuote];
+}
+- (OWSSignalServiceProtosDataMessageQuote *)defaultInstance
+{
+    return [OWSSignalServiceProtosDataMessageQuote defaultInstance];
+}
+- (OWSSignalServiceProtosDataMessageQuote *)build
+{
+    [self checkInitialized];
+    return [self buildPartial];
+}
+- (OWSSignalServiceProtosDataMessageQuote *)buildPartial
+{
+    OWSSignalServiceProtosDataMessageQuote *returnMe = resultQuote;
+    self.resultQuote = nil;
+    return returnMe;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeFrom:(OWSSignalServiceProtosDataMessageQuote *)other
+{
+    if (other == [OWSSignalServiceProtosDataMessageQuote defaultInstance]) {
+        return self;
+    }
+    if (other.hasId) {
+        [self setId:other.id];
+    }
+    if (other.hasAuthor) {
+        [self setAuthor:other.author];
+    }
+    if (other.hasText) {
+        [self setText:other.text];
+    }
+    if (other.hasAttachment) {
+        [self mergeAttachment:other.attachment];
+    }
+    [self mergeUnknownFields:other.unknownFields];
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeFromCodedInputStream:(PBCodedInputStream *)input
+{
+    return [self mergeFromCodedInputStream:input extensionRegistry:[PBExtensionRegistry emptyRegistry]];
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeFromCodedInputStream:(PBCodedInputStream *)input
+                                                           extensionRegistry:(PBExtensionRegistry *)extensionRegistry
+{
+    PBUnknownFieldSetBuilder *unknownFields = [PBUnknownFieldSet builderWithUnknownFields:self.unknownFields];
+    while (YES) {
+        SInt32 tag = [input readTag];
+        switch (tag) {
+            case 0:
+                [self setUnknownFields:[unknownFields build]];
+                return self;
+            default: {
+                if (![self parseUnknownField:input
+                               unknownFields:unknownFields
+                           extensionRegistry:extensionRegistry
+                                         tag:tag]) {
+                    [self setUnknownFields:[unknownFields build]];
+                    return self;
+                }
+                break;
+            }
+            case 8: {
+                [self setId:[input readUInt64]];
+                break;
+            }
+            case 18: {
+                [self setAuthor:[input readString]];
+                break;
+            }
+            case 26: {
+                [self setText:[input readString]];
+                break;
+            }
+            case 34: {
+                OWSSignalServiceProtosAttachmentPointerBuilder *subBuilder =
+                    [OWSSignalServiceProtosAttachmentPointer builder];
+                if (self.hasAttachment) {
+                    [subBuilder mergeFrom:self.attachment];
+                }
+                [input readMessage:subBuilder extensionRegistry:extensionRegistry];
+                [self setAttachment:[subBuilder buildPartial]];
+                break;
+            }
+        }
+    }
+}
+- (BOOL)hasId
+{
+    return resultQuote.hasId;
+}
+- (UInt64)id
+{
+    return resultQuote.id;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setId:(UInt64)value
+{
+    resultQuote.hasId = YES;
+    resultQuote.id = value;
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearId
+{
+    resultQuote.hasId = NO;
+    resultQuote.id = 0L;
+    return self;
+}
+- (BOOL)hasAuthor
+{
+    return resultQuote.hasAuthor;
+}
+- (NSString *)author
+{
+    return resultQuote.author;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setAuthor:(NSString *)value
+{
+    resultQuote.hasAuthor = YES;
+    resultQuote.author = value;
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearAuthor
+{
+    resultQuote.hasAuthor = NO;
+    resultQuote.author = @"";
+    return self;
+}
+- (BOOL)hasText
+{
+    return resultQuote.hasText;
+}
+- (NSString *)text
+{
+    return resultQuote.text;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setText:(NSString *)value
+{
+    resultQuote.hasText = YES;
+    resultQuote.text = value;
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearText
+{
+    resultQuote.hasText = NO;
+    resultQuote.text = @"";
+    return self;
+}
+- (BOOL)hasAttachment
+{
+    return resultQuote.hasAttachment;
+}
+- (OWSSignalServiceProtosAttachmentPointer *)attachment
+{
+    return resultQuote.attachment;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setAttachment:(OWSSignalServiceProtosAttachmentPointer *)value
+{
+    resultQuote.hasAttachment = YES;
+    resultQuote.attachment = value;
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)setAttachmentBuilder:
+    (OWSSignalServiceProtosAttachmentPointerBuilder *)builderForValue
+{
+    return [self setAttachment:[builderForValue build]];
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)mergeAttachment:(OWSSignalServiceProtosAttachmentPointer *)value
+{
+    if (resultQuote.hasAttachment
+        && resultQuote.attachment != [OWSSignalServiceProtosAttachmentPointer defaultInstance]) {
+        resultQuote.attachment = [[[OWSSignalServiceProtosAttachmentPointer builderWithPrototype:resultQuote.attachment]
+            mergeFrom:value] buildPartial];
+    } else {
+        resultQuote.attachment = value;
+    }
+    resultQuote.hasAttachment = YES;
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageQuoteBuilder *)clearAttachment
+{
+    resultQuote.hasAttachment = NO;
+    resultQuote.attachment = [OWSSignalServiceProtosAttachmentPointer defaultInstance];
+    return self;
+}
+@end
+
 @interface OWSSignalServiceProtosDataMessageBuilder()
 @property (strong) OWSSignalServiceProtosDataMessage* resultDataMessage;
 @end
@@ -3284,6 +3763,9 @@ - (OWSSignalServiceProtosDataMessageBuilder*) mergeFrom:(OWSSignalServiceProtosD
   if (other.hasTimestamp) {
     [self setTimestamp:other.timestamp];
   }
+  if (other.hasQuote) {
+      [self mergeQuote:other.quote];
+  }
   [self mergeUnknownFields:other.unknownFields];
   return self;
 }
@@ -3340,6 +3822,15 @@ - (OWSSignalServiceProtosDataMessageBuilder*) mergeFromCodedInputStream:(PBCoded
         [self setTimestamp:[input readUInt64]];
         break;
       }
+      case 66: {
+          OWSSignalServiceProtosDataMessageQuoteBuilder *subBuilder = [OWSSignalServiceProtosDataMessageQuote builder];
+          if (self.hasQuote) {
+              [subBuilder mergeFrom:self.quote];
+          }
+          [input readMessage:subBuilder extensionRegistry:extensionRegistry];
+          [self setQuote:[subBuilder buildPartial]];
+          break;
+      }
     }
   }
 }
@@ -3474,6 +3965,44 @@ - (OWSSignalServiceProtosDataMessageBuilder*) clearTimestamp {
   resultDataMessage.timestamp = 0L;
   return self;
 }
+- (BOOL)hasQuote
+{
+    return resultDataMessage.hasQuote;
+}
+- (OWSSignalServiceProtosDataMessageQuote *)quote
+{
+    return resultDataMessage.quote;
+}
+- (OWSSignalServiceProtosDataMessageBuilder *)setQuote:(OWSSignalServiceProtosDataMessageQuote *)value
+{
+    resultDataMessage.hasQuote = YES;
+    resultDataMessage.quote = value;
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageBuilder *)setQuoteBuilder:
+    (OWSSignalServiceProtosDataMessageQuoteBuilder *)builderForValue
+{
+    return [self setQuote:[builderForValue build]];
+}
+- (OWSSignalServiceProtosDataMessageBuilder *)mergeQuote:(OWSSignalServiceProtosDataMessageQuote *)value
+{
+    if (resultDataMessage.hasQuote
+        && resultDataMessage.quote != [OWSSignalServiceProtosDataMessageQuote defaultInstance]) {
+        resultDataMessage.quote =
+            [[[OWSSignalServiceProtosDataMessageQuote builderWithPrototype:resultDataMessage.quote] mergeFrom:value]
+                buildPartial];
+    } else {
+        resultDataMessage.quote = value;
+    }
+    resultDataMessage.hasQuote = YES;
+    return self;
+}
+- (OWSSignalServiceProtosDataMessageBuilder *)clearQuote
+{
+    resultDataMessage.hasQuote = NO;
+    resultDataMessage.quote = [OWSSignalServiceProtosDataMessageQuote defaultInstance];
+    return self;
+}
 @end
 
 @interface OWSSignalServiceProtosNullMessage ()
diff --git a/SignalServiceKit/src/Messages/TSCall.h b/SignalServiceKit/src/Messages/TSCall.h
index c653bdd5090..bcadbaf8b9a 100644
--- a/SignalServiceKit/src/Messages/TSCall.h
+++ b/SignalServiceKit/src/Messages/TSCall.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "OWSReadTracking.h"
@@ -24,6 +24,8 @@ typedef enum {
 
 @property (nonatomic, readonly) RPRecentCallType callType;
 
+- (instancetype)initInteractionWithTimestamp:(uint64_t)timestamp inThread:(TSThread *)thread NS_UNAVAILABLE;
+
 - (instancetype)initWithTimestamp:(uint64_t)timestamp
                    withCallNumber:(NSString *)contactNumber
                          callType:(RPRecentCallType)callType
diff --git a/SignalServiceKit/src/Messages/TSCall.m b/SignalServiceKit/src/Messages/TSCall.m
index db9643e31b4..a0b05c891b4 100644
--- a/SignalServiceKit/src/Messages/TSCall.m
+++ b/SignalServiceKit/src/Messages/TSCall.m
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 #import "TSCall.h"
@@ -28,7 +28,7 @@ - (instancetype)initWithTimestamp:(uint64_t)timestamp
                          callType:(RPRecentCallType)callType
                          inThread:(TSContactThread *)thread
 {
-    self = [super initWithTimestamp:timestamp inThread:thread];
+    self = [super initInteractionWithTimestamp:timestamp inThread:thread];
 
     if (!self) {
         return self;
diff --git a/SignalMessaging/categories/UIImage+OWS.h b/SignalServiceKit/src/Util/UIImage+OWS.h
similarity index 87%
rename from SignalMessaging/categories/UIImage+OWS.h
rename to SignalServiceKit/src/Util/UIImage+OWS.h
index 87bc9b7224a..35eb5d6736b 100644
--- a/SignalMessaging/categories/UIImage+OWS.h
+++ b/SignalServiceKit/src/Util/UIImage+OWS.h
@@ -1,5 +1,5 @@
 //
-//  Copyright (c) 2017 Open Whisper Systems. All rights reserved.
+//  Copyright (c) 2018 Open Whisper Systems. All rights reserved.
 //
 
 NS_ASSUME_NONNULL_BEGIN
diff --git a/SignalMessaging/categories/UIImage+OWS.m b/SignalServiceKit/src/Util/UIImage+OWS.m
similarity index 100%
rename from SignalMessaging/categories/UIImage+OWS.m
rename to SignalServiceKit/src/Util/UIImage+OWS.m
