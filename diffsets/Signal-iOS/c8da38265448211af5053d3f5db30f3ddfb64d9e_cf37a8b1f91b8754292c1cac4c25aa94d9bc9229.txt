diff --git a/Signal/src/ViewControllers/HomeView/Chat List/ChatListCell.swift b/Signal/src/ViewControllers/HomeView/Chat List/ChatListCell.swift
index c2e7424264c..93c58aca20b 100644
--- a/Signal/src/ViewControllers/HomeView/Chat List/ChatListCell.swift	
+++ b/Signal/src/ViewControllers/HomeView/Chat List/ChatListCell.swift	
@@ -144,8 +144,8 @@ public class ChatListCell: UITableViewCell {
         UIFont.dynamicTypeBodyClamped.italic()
     }
 
-    private static var snippetColor: UIColor {
-        Theme.isDarkThemeEnabled ? .ows_gray25 : .ows_gray45
+    private static var snippetColor: ThemedColor {
+        return ThemedColor(light: .ows_gray45, dark: .ows_gray25)
     }
 
     // This value is now larger than AvatarBuilder.standardAvatarSizePoints.
@@ -380,7 +380,7 @@ public class ChatListCell: UITableViewCell {
         if shouldShowMuteIndicator {
             muteIconView.setTemplateImageName("bell-disabled-outline-24",
                                               tintColor: Theme.primaryTextColor)
-            muteIconView.tintColor = Self.snippetColor
+            muteIconView.tintColor = Self.snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
             topRowStackSubviews.append(muteIconView)
         }
 
@@ -557,7 +557,7 @@ public class ChatListCell: UITableViewCell {
         }
 
         var statusIndicatorImage: UIImage?
-        var messageStatusViewTintColor = snippetColor
+        var messageStatusViewTintColor = snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
         var shouldAnimateStatusIcon = false
 
         let messageStatus =
@@ -698,7 +698,7 @@ public class ChatListCell: UITableViewCell {
                                                                 comment: "Table cell subtitle label for a conversation the user has blocked."),
                                       attributes: [
                                         .font: snippetFont,
-                                        .foregroundColor: snippetColor
+                                        .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                       ])
         case .pendingMessageRequest(let addedToGroupByName):
             // If you haven't accepted the message request for this thread, don't show the latest message
@@ -710,7 +710,7 @@ public class ChatListCell: UITableViewCell {
                 return NSAttributedString(string: String(format: addedToGroupFormat, addedToGroupByName),
                                           attributes: [
                                             .font: snippetFont,
-                                            .foregroundColor: snippetColor
+                                            .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                           ])
             } else {
                 // Otherwise just show a generic "message request" message
@@ -719,7 +719,7 @@ public class ChatListCell: UITableViewCell {
                 return NSAttributedString(string: text,
                                           attributes: [
                                             .font: snippetFont,
-                                            .foregroundColor: snippetColor
+                                            .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                           ])
             }
         case .draft(let draftText):
@@ -728,13 +728,21 @@ public class ChatListCell: UITableViewCell {
                                                  comment: "A prefix indicating that a message preview is a draft"),
                                attributes: [
                                 .font: snippetFont.italic(),
-                                .foregroundColor: snippetColor
-                               ])
-            snippetText.append(draftText,
-                               attributes: [
-                                .font: snippetFont,
-                                .foregroundColor: snippetColor
+                                .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                ])
+            let attributedDraftText = draftText.asAttributedStringForDisplay(
+                config: HydratedMessageBody.DisplayConfiguration(
+                    mention: .conversationListSnippet(font: snippetFont, textColor: snippetColor),
+                    style: .forConversationListSnippet(baseFont: snippetFont, textColor: snippetColor),
+                    searchRanges: nil
+                ),
+                baseAttributes: [
+                    .font: snippetFont,
+                    .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
+                ],
+                isDarkThemeEnabled: Theme.isDarkThemeEnabled
+            )
+            snippetText.append(attributedDraftText)
             return snippetText
         case .voiceMemoDraft:
             let snippetText = NSMutableAttributedString()
@@ -742,52 +750,67 @@ public class ChatListCell: UITableViewCell {
                                                  comment: "A prefix indicating that a message preview is a draft"),
                                attributes: [
                                 .font: snippetFont.italic(),
-                                .foregroundColor: snippetColor
+                                .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                ])
             snippetText.append("ðŸŽ¤",
                                attributes: [
                                 .font: snippetFont,
-                                .foregroundColor: snippetColor
+                                .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                ])
             snippetText.append(" ",
                                attributes: [
                                 .font: snippetFont,
-                                .foregroundColor: snippetColor
+                                .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                ])
             snippetText.append(OWSLocalizedString("ATTACHMENT_TYPE_VOICE_MESSAGE",
                                                  comment: "Short text label for a voice message attachment, used for thread preview and on the lock screen"),
                                attributes: [
                                 .font: snippetFont,
-                                .foregroundColor: snippetColor
+                                .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                ])
             return snippetText
         case .contactSnippet(let lastMessageText):
-            return NSAttributedString(string: lastMessageText,
-                                      attributes: [
-                                        .font: snippetFont,
-                                        .foregroundColor: snippetColor
-                                      ])
+            return lastMessageText.asAttributedStringForDisplay(
+                config: HydratedMessageBody.DisplayConfiguration(
+                    mention: .conversationListSnippet(font: snippetFont, textColor: snippetColor),
+                    style: .forConversationListSnippet(baseFont: snippetFont, textColor: snippetColor),
+                    searchRanges: nil
+                ),
+                baseAttributes: [
+                    .font: snippetFont,
+                    .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
+                ],
+                isDarkThemeEnabled: Theme.isDarkThemeEnabled
+            )
         case .groupSnippet(let lastMessageText, let senderName):
             let snippetText = NSMutableAttributedString()
             snippetText.append(senderName,
                                attributes: [
                                 .font: snippetFont.medium(),
-                                .foregroundColor: snippetColor
+                                .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                ])
             snippetText.append(":",
                                attributes: [
                                 .font: snippetFont.medium(),
-                                .foregroundColor: snippetColor
+                                .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
                                ])
             snippetText.append(" ",
                                attributes: [
                                 .font: snippetFont
                                ])
-            snippetText.append(lastMessageText,
-                               attributes: [
-                                .font: snippetFont,
-                                .foregroundColor: snippetColor
-                               ])
+            let attributedLastMessageText = lastMessageText.asAttributedStringForDisplay(
+                config: HydratedMessageBody.DisplayConfiguration(
+                    mention: .conversationListSnippet(font: snippetFont, textColor: snippetColor),
+                    style: .forConversationListSnippet(baseFont: snippetFont, textColor: snippetColor),
+                    searchRanges: nil
+                ),
+                baseAttributes: [
+                    .font: snippetFont,
+                    .foregroundColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled)
+                ],
+                isDarkThemeEnabled: Theme.isDarkThemeEnabled
+            )
+            snippetText.append(attributedLastMessageText)
             return snippetText
         case .none:
             return NSAttributedString(string: "")
@@ -806,7 +829,7 @@ public class ChatListCell: UITableViewCell {
         }
         return CVLabelConfig(text: text,
                              font: dateTimeFont,
-                             textColor: snippetColor,
+                             textColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled),
                              textAlignment: .trailing)
     }
 
@@ -842,7 +865,7 @@ public class ChatListCell: UITableViewCell {
         }()
         return CVLabelConfig(attributedText: attributedText,
                              font: snippetFont,
-                             textColor: snippetColor,
+                             textColor: snippetColor.color(isDarkThemeEnabled: Theme.isDarkThemeEnabled),
                              numberOfLines: 2,
                              lineBreakMode: .byTruncatingTail)
     }
diff --git a/Signal/src/ViewControllers/HomeView/Chat List/ConversationSearchViewController.swift b/Signal/src/ViewControllers/HomeView/Chat List/ConversationSearchViewController.swift
index 892d1e45994..a434a9afc38 100644
--- a/Signal/src/ViewControllers/HomeView/Chat List/ConversationSearchViewController.swift	
+++ b/Signal/src/ViewControllers/HomeView/Chat List/ConversationSearchViewController.swift	
@@ -277,7 +277,7 @@ public class ConversationSearchViewController: UITableViewController, ThreadSwip
 
         // If we have an existing CLVCellContentToken, use it.
         // Cell measurement/arrangement is expensive.
-        let cacheKey = "\(configuration.thread.threadRecord.uniqueId).\(configuration.overrideSnippet?.string ?? "")"
+        let cacheKey = "\(configuration.thread.threadRecord.uniqueId).\(configuration.overrideSnippet?.hash ?? 0)"
         if useCache {
             if let cellContentToken = cellContentCache.get(key: cacheKey) {
                 return cellContentToken
@@ -398,7 +398,15 @@ public class ConversationSearchViewController: UITableViewController, ThreadSwip
                 // a snippet for conversations that reflects the latest
                 // contents.
                 if let messageSnippet = searchResult.snippet {
-                    overrideSnippet = messageSnippet.styled(with: Self.matchSnippetStyle)
+                    overrideSnippet = RecoveredHydratedMessageBody.recover(from: messageSnippet)
+                        .reapplyAttributes(
+                            config: HydratedMessageBody.DisplayConfiguration(
+                                mention: .conversationListSearchResultSnippet,
+                                style: .conversationListSearchResultSnippet,
+                                searchRanges: nil
+                            ),
+                            isDarkThemeEnabled: Theme.isDarkThemeEnabled
+                        )
                 } else {
                     owsFailDebug("message search result is missing message snippet")
                 }
diff --git a/Signal/test/util/FTS/GRDBFullTextSearcherTest.swift b/Signal/test/util/FTS/GRDBFullTextSearcherTest.swift
index 2168a7474f7..0514339ac92 100644
--- a/Signal/test/util/FTS/GRDBFullTextSearcherTest.swift
+++ b/Signal/test/util/FTS/GRDBFullTextSearcherTest.swift
@@ -557,7 +557,7 @@ class GRDBFullTextSearcherTest: SignalBaseTest {
                 XCTFail("Missing snippet.", file: file, line: line)
                 continue
             }
-            XCTAssertTrue(snippet.lowercased().contains(expectedSnippetContent.lowercased()), file: file, line: line)
+            XCTAssertTrue(snippet.string.lowercased().contains(expectedSnippetContent.lowercased()), file: file, line: line)
         }
     }
 
diff --git a/SignalMessaging/Notifications/AppNotifications.swift b/SignalMessaging/Notifications/AppNotifications.swift
index 3f80f7034e9..28bb0a66185 100644
--- a/SignalMessaging/Notifications/AppNotifications.swift
+++ b/SignalMessaging/Notifications/AppNotifications.swift
@@ -562,7 +562,7 @@ public class NotificationPresenter: NSObject, NotificationsProtocol {
         }
 
         // While batch processing, some of the necessary changes have not been committed.
-        let rawMessageText = incomingMessage.previewText(transaction: transaction)
+        let rawMessageText = incomingMessage.notificationPreviewText(transaction)
 
         let messageText = rawMessageText.filterStringForDisplay()
 
@@ -691,8 +691,7 @@ public class NotificationPresenter: NSObject, NotificationsProtocol {
 
         let notificationBody: String
         if let bodyDescription: String = {
-            // TODO[TextFormatting]: apply styles for notification
-            if let messageBody = message.plaintextBody(with: transaction.unwrapGrdbRead), !messageBody.isEmpty {
+            if let messageBody = message.notificationPreviewText(transaction).nilIfEmpty {
                 return messageBody
             } else {
                 return nil
@@ -882,17 +881,56 @@ public class NotificationPresenter: NSObject, NotificationsProtocol {
              .groupCreationFailed:
             return
         case .sessionRefresh:
-            notifyUser(forPreviewableInteraction: errorMessage as TSMessage,
-                       thread: thread,
-                       wantsSound: true,
-                       transaction: transaction)
+            notifyUser(
+                forTSMessage: errorMessage as TSMessage,
+                thread: thread,
+                wantsSound: true,
+                transaction: transaction
+            )
         }
     }
 
-    public func notifyUser(forPreviewableInteraction previewableInteraction: TSInteraction & OWSPreviewText,
-                           thread: TSThread,
-                           wantsSound: Bool,
-                           transaction: SDSAnyWriteTransaction) {
+    public func notifyUser(
+        forTSMessage message: TSMessage,
+        thread: TSThread,
+        wantsSound: Bool,
+        transaction: SDSAnyWriteTransaction
+    ) {
+        notifyUser(
+            tsInteraction: message,
+            previewProvider: { tx in
+                return message.notificationPreviewText(tx)
+            },
+            thread: thread,
+            wantsSound: wantsSound,
+            transaction: transaction
+        )
+    }
+
+    public func notifyUser(
+        forPreviewableInteraction previewableInteraction: TSInteraction & OWSPreviewText,
+        thread: TSThread,
+        wantsSound: Bool,
+        transaction: SDSAnyWriteTransaction
+    ) {
+        notifyUser(
+            tsInteraction: previewableInteraction,
+            previewProvider: { tx in
+                return previewableInteraction.previewText(transaction: tx)
+            },
+            thread: thread,
+            wantsSound: wantsSound,
+            transaction: transaction
+        )
+    }
+
+    private func notifyUser(
+        tsInteraction: TSInteraction,
+        previewProvider: (SDSAnyWriteTransaction) -> String,
+        thread: TSThread,
+        wantsSound: Bool,
+        transaction: SDSAnyWriteTransaction
+    ) {
         guard !isThreadMuted(thread, transaction: transaction) else { return }
 
         let notificationTitle: String?
@@ -911,17 +949,16 @@ public class NotificationPresenter: NSObject, NotificationsProtocol {
         case .noNameNoPreview, .nameNoPreview:
             notificationBody = NotificationStrings.genericIncomingMessageNotification
         case .namePreview:
-            // TODO[TextFormatting]: apply styles (except spoiler which gets a special treatment in notifications)
-            notificationBody = previewableInteraction.previewText(transaction: transaction)
+            notificationBody = previewProvider(transaction)
         }
 
-        let isGroupCallMessage = previewableInteraction is OWSGroupCallMessage
+        let isGroupCallMessage = tsInteraction is OWSGroupCallMessage
         let preferredDefaultAction: AppNotificationAction = isGroupCallMessage ? .showCallLobby : .showThread
 
         let threadId = thread.uniqueId
         let userInfo = [
             AppNotificationUserInfoKey.threadId: threadId,
-            AppNotificationUserInfoKey.messageId: previewableInteraction.uniqueId,
+            AppNotificationUserInfoKey.messageId: tsInteraction.uniqueId,
             AppNotificationUserInfoKey.defaultAction: preferredDefaultAction.rawValue
         ]
 
@@ -936,7 +973,7 @@ public class NotificationPresenter: NSObject, NotificationsProtocol {
                 interaction = wrapper
             }
 
-            if let infoMessage = previewableInteraction as? TSInfoMessage {
+            if let infoMessage = tsInteraction as? TSInfoMessage {
                 switch infoMessage.messageType {
                 case .typeGroupUpdate:
                     if let groupUpdateAuthor = infoMessage.groupUpdateSourceAddress,
@@ -951,7 +988,7 @@ public class NotificationPresenter: NSObject, NotificationsProtocol {
                 default:
                     break
                 }
-            } else if let callMessage = previewableInteraction as? OWSGroupCallMessage,
+            } else if let callMessage = tsInteraction as? OWSGroupCallMessage,
                       let callCreator = callMessage.creatorAddress,
                       let intent = thread.generateSendMessageIntent(context: .senderAddress(callCreator), transaction: transaction) {
                 wrapIntent(intent)
diff --git a/SignalMessaging/contacts/NewAccountDiscovery.swift b/SignalMessaging/contacts/NewAccountDiscovery.swift
index 0bc54b92c82..83d3a62b5c2 100644
--- a/SignalMessaging/contacts/NewAccountDiscovery.swift
+++ b/SignalMessaging/contacts/NewAccountDiscovery.swift
@@ -56,10 +56,12 @@ public class NewAccountDiscovery: NSObject {
                 }
 
                 // Keep these notifications less obtrusive by making them silent.
-                notificationPresenter.notifyUser(forPreviewableInteraction: message,
-                                                 thread: thread,
-                                                 wantsSound: false,
-                                                 transaction: transaction)
+                notificationPresenter.notifyUser(
+                    forTSMessage: message,
+                    thread: thread,
+                    wantsSound: false,
+                    transaction: transaction
+                )
             }
         }
     }
diff --git a/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift b/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift
index 628fbdc827c..0a84bb95e17 100644
--- a/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift
+++ b/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift
@@ -58,6 +58,10 @@ public class HydratedMessageBody: Equatable, Hashable {
         self.styleAttributes = styleAttributes
     }
 
+    public static func fromPlaintextWithoutRanges(_ text: String) -> HydratedMessageBody {
+        return HydratedMessageBody(hydratedText: text, mentionAttributes: [], styleAttributes: [])
+    }
+
     internal init(
         messageBody: MessageBody,
         mentionHydrator: MentionHydrator,
@@ -85,25 +89,25 @@ public class HydratedMessageBody: Equatable, Hashable {
         } else {
             strippedPrefixLength = 0
         }
-        var mentionsInOriginal: [(NSRange, UUID)]
-        var stylesInOriginal: [(NSRange, Style)]
+        var mentionsInOriginal: [NSRangedValue<UUID>]
+        var stylesInOriginal: [NSRangedValue<Style>]
         if strippedPrefixLength != 0 {
-            mentionsInOriginal = messageBody.ranges.orderedMentions.map { range, uuid in
-                return (
-                    NSRange(
-                        location: range.location + strippedPrefixLength,
-                        length: range.length
-                    ),
-                    uuid
+            mentionsInOriginal = messageBody.ranges.orderedMentions.map { mention in
+                return .init(
+                    mention.value,
+                    range: NSRange(
+                        location: mention.range.location + strippedPrefixLength,
+                        length: mention.range.length
+                    )
                 )
             }
-            stylesInOriginal = messageBody.ranges.styles.map { range, style in
-                return (
-                    NSRange(
-                        location: range.location + strippedPrefixLength,
-                        length: range.length
-                    ),
-                    style
+            stylesInOriginal = messageBody.ranges.styles.map { style in
+                return .init(
+                    style.value,
+                    range: NSRange(
+                        location: style.range.location + strippedPrefixLength,
+                        length: style.range.length
+                    )
                 )
             }
         } else {
@@ -143,25 +147,26 @@ public class HydratedMessageBody: Equatable, Hashable {
                 styleAtCurrentIndex = nil
             }
             // Check for any new styles starting at the current index.
-            if stylesInOriginal.first?.0.contains(currentIndex) == true {
-                let (originalRange, style) = stylesInOriginal.removeFirst()
+            if stylesInOriginal.first?.range.contains(currentIndex) == true {
+                let style = stylesInOriginal.removeFirst()
+                let originalRange = style.range
                 styleAtCurrentIndex = .init(
                     originalRange: originalRange,
                     newRange: NSRange(
                         location: originalRange.location + rangeOffset,
                         length: originalRange.length
                     ),
-                    style: style
+                    style: style.value
                 )
             }
 
             // Check for any mentions at the current index.
             // Mentions can't overlap, so we don't need a while loop to check for multiple.
             guard
-                let (originalMentionRange, mentionUuid) = mentionsInOriginal.first,
+                let mention = mentionsInOriginal.first,
                 (
-                    originalMentionRange.contains(currentIndex)
-                    || originalMentionRange.location == currentIndex
+                    mention.range.contains(currentIndex)
+                    || mention.range.location == currentIndex
                 )
             else {
                 // No mentions, so no additional logic needed, just go to the next index.
@@ -170,17 +175,17 @@ public class HydratedMessageBody: Equatable, Hashable {
             mentionsInOriginal.removeFirst()
 
             let newMentionRange = NSRange(
-                location: originalMentionRange.location + rangeOffset,
-                length: originalMentionRange.length
+                location: mention.range.location + rangeOffset,
+                length: mention.range.length
             )
 
             let finalMentionLength: Int
             let mentionOffsetDelta: Int
-            switch mentionHydrator(mentionUuid) {
+            switch mentionHydrator(mention.value) {
             case .preserveMention:
                 // Preserve the mention without replacement and proceed.
                 unhydratedMentions.append(.init(
-                    MentionAttribute.fromOriginalRange(originalMentionRange, mentionUuid: mentionUuid),
+                    MentionAttribute.fromOriginalRange(mention.range, mentionUuid: mention.value),
                     range: newMentionRange
                 ))
                 continue
@@ -192,10 +197,10 @@ public class HydratedMessageBody: Equatable, Hashable {
                     mentionPlaintext = MentionAttribute.mentionPrefix + displayName
                 }
                 finalMentionLength = (mentionPlaintext as NSString).length
-                mentionOffsetDelta = finalMentionLength - originalMentionRange.length
+                mentionOffsetDelta = finalMentionLength - mention.range.length
                 finalText.replaceCharacters(in: newMentionRange, with: mentionPlaintext)
                 finalMentionAttributes.append(.init(
-                    MentionAttribute.fromOriginalRange(originalMentionRange, mentionUuid: mentionUuid),
+                    MentionAttribute.fromOriginalRange(mention.range, mentionUuid: mention.value),
                     range: NSRange(location: newMentionRange.location, length: finalMentionLength)
                 ))
             }
@@ -203,7 +208,7 @@ public class HydratedMessageBody: Equatable, Hashable {
 
             // We have to adjust style ranges for the active style
             if let style = styleAtCurrentIndex {
-                if style.originalRange.upperBound <= originalMentionRange.upperBound {
+                if style.originalRange.upperBound <= mention.range.upperBound {
                     // If the style ended inside (or right at the end of) the mention,
                     // it should now end at the end of the replacement text.
                     let finalLength = (newMentionRange.location + finalMentionLength) - style.newRange.location
@@ -294,9 +299,10 @@ public class HydratedMessageBody: Equatable, Hashable {
 
     public func asAttributedStringForDisplay(
         config: DisplayConfiguration,
+        baseAttributes: [NSAttributedString.Key: Any]? = nil,
         isDarkThemeEnabled: Bool
     ) -> NSAttributedString {
-        let string = NSMutableAttributedString(string: hydratedText)
+        let string = NSMutableAttributedString(string: hydratedText, attributes: baseAttributes ?? [:])
         return Self.applyAttributes(
             on: string,
             mentionAttributes: mentionAttributes,
@@ -397,9 +403,41 @@ public class HydratedMessageBody: Equatable, Hashable {
             ranges: MessageBodyRanges(
                 mentions: unhydratedMentionsDict,
                 styles: styleAttributes.map {
-                    return ($0.range, $0.value.style)
+                    return .init($0.value.style, range: $0.range)
                 }
             )
         )
     }
+
+    // MARK: - Adding prefix
+
+    public func addingPrefix(_ prefix: String) -> HydratedMessageBody {
+        let offset = (prefix as NSString).length
+        return HydratedMessageBody(
+            hydratedText: prefix + hydratedText,
+            unhydratedMentions: unhydratedMentions.map { $0.offset(by: offset) },
+            mentionAttributes: mentionAttributes.map { $0.offset(by: offset) },
+            styleAttributes: styleAttributes.map { $0.offset(by: offset) }
+        )
+    }
+
+    public var nilIfEmpty: HydratedMessageBody? {
+        if self.hydratedText.isEmpty {
+            return nil
+        }
+        return self
+    }
+}
+
+fileprivate extension NSRangedValue {
+
+    func offset(by offset: Int) -> Self {
+        return Self.init(
+            value,
+            range: NSRange(
+                location: self.range.location + offset,
+                length: self.range.length
+            )
+        )
+    }
 }
diff --git a/SignalServiceKit/src/Messages/BodyRanges/MessageBody.swift b/SignalServiceKit/src/Messages/BodyRanges/MessageBody.swift
index 878bf105975..29d5c2dcac3 100644
--- a/SignalServiceKit/src/Messages/BodyRanges/MessageBody.swift
+++ b/SignalServiceKit/src/Messages/BodyRanges/MessageBody.swift
@@ -103,6 +103,36 @@ extension MessageBody {
 
         return hydrating(mentionHydrator: mentionHydrator, isRTL: isRTL)
     }
+
+    // MARK: Merging
+
+    /// Given a substring and set of styles _within that substring_, returns the same
+    /// substring if found with provided styles merged with the overall styles from
+    /// the entire message body.
+    ///
+    /// If the substring is not found, returns self.
+    ///
+    /// The provided styles should have their locations in the substring's local coordinates,
+    /// e.g. 0 being the first character of the substring.
+    public func mergeIntoFirstMatchOfStyledSubstring(
+        _ substring: String,
+        styles: [NSRangedValue<MessageBodyRanges.Style>]
+    ) -> MessageBody {
+        // First find the offset.
+        let substringRange = (text as NSString).range(of: substring)
+        guard substringRange.location != NSNotFound else {
+            return self
+        }
+        let subrangeStyles = MessageBodyRanges.SubrangeStyles(
+            substringRange: substringRange,
+            stylesInSubstring: styles
+        )
+        let newRanges = self.ranges.mergingStyles(subrangeStyles)
+        return MessageBody(
+            text: substring,
+            ranges: newRanges
+        )
+    }
 }
 
 public extension TSThread {
diff --git a/SignalServiceKit/src/Messages/BodyRanges/MessageBodyRanges.swift b/SignalServiceKit/src/Messages/BodyRanges/MessageBodyRanges.swift
index ba707af9112..0d4142637c5 100644
--- a/SignalServiceKit/src/Messages/BodyRanges/MessageBodyRanges.swift
+++ b/SignalServiceKit/src/Messages/BodyRanges/MessageBodyRanges.swift
@@ -25,7 +25,7 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
     public var hasMentions: Bool { !mentions.isEmpty }
 
     /// Sorted from lowest location to highest location
-    public let orderedMentions: [(NSRange, UUID)]
+    public let orderedMentions: [NSRangedValue<UUID>]
 
     public struct Style: OptionSet, Equatable, Hashable {
         public let rawValue: Int
@@ -47,15 +47,17 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
     /// Styles can overlap with mentions but not with each other.
     /// If a style overlaps with _any_ part of a mention, it applies
     /// to the entire length of the mention.
-    public let styles: [(NSRange, Style)]
+    public let styles: [NSRangedValue<Style>]
 
     public var hasRanges: Bool {
         return mentions.isEmpty.negated || styles.isEmpty.negated
     }
 
-    public init(mentions: [NSRange: UUID], styles: [(NSRange, Style)]) {
+    public init(mentions: [NSRange: UUID], styles: [NSRangedValue<Style>]) {
         self.mentions = mentions
-        let orderedMentions = mentions.sorted(by: { $0.key.location < $1.key.location })
+        let orderedMentions = mentions.lazy
+            .sorted(by: { $0.key.location < $1.key.location })
+            .map { return NSRangedValue($0.value, range: $0.key) }
         self.orderedMentions = orderedMentions
         self.styles = Self.processStylesForInitialization(styles, orderedMentions: orderedMentions)
 
@@ -64,7 +66,7 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
 
     public convenience init(protos: [SSKProtoBodyRange]) {
         var mentions = [NSRange: UUID]()
-        var styles = [(NSRange, Style)]()
+        var styles = [NSRangedValue<Style>]()
         for proto in protos {
             let range = NSRange(location: Int(proto.start), length: Int(proto.length))
             if
@@ -88,7 +90,7 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
                 case .monospace:
                     style = .monospace
                 }
-                styles.append((range, style))
+                styles.append(.init(style, range: range))
             }
         }
         self.init(mentions: mentions, styles: styles)
@@ -111,7 +113,9 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
         }
 
         self.mentions = mentions
-        let orderedMentions = mentions.sorted(by: { $0.key.location < $1.key.location })
+        let orderedMentions = mentions.lazy
+            .sorted(by: { $0.key.location < $1.key.location })
+            .map { NSRangedValue($0.value, range: $0.key) }
         self.orderedMentions = orderedMentions
 
         let stylesCount: Int = {
@@ -124,41 +128,41 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
             return coder.decodeInteger(forKey: key)
         }()
 
-        var styles = [(NSRange, Style)]()
+        var styles = [NSRangedValue<Style>]()
         for idx in 0..<stylesCount {
             guard let range = coder.decodeObject(of: NSValue.self, forKey: "styles.range.\(idx)")?.rangeValue else {
                 owsFailDebug("Failed to decode style range key of MessageBody")
                 return nil
             }
             let style = Style(rawValue: coder.decodeInteger(forKey: "styles.style.\(idx)"))
-            styles.append((range, style))
+            styles.append(.init(style, range: range))
         }
 
         self.styles = Self.processStylesForInitialization(styles, orderedMentions: orderedMentions)
     }
 
     private static func processStylesForInitialization(
-        _ styles: [(NSRange, Style)],
-        orderedMentions: [(NSRange, UUID)]
-    ) -> [(NSRange, Style)] {
+        _ styles: [NSRangedValue<Style>],
+        orderedMentions: [NSRangedValue<UUID>]
+    ) -> [NSRangedValue<Style>] {
         guard !styles.isEmpty else {
             return []
         }
-        var maxUpperBound = orderedMentions.last?.0.upperBound ?? 0
+        var maxUpperBound = orderedMentions.last?.range.upperBound ?? 0
         var sortedStyles = styles
             .lazy
-            .filter { (range, _) in
-                guard range.location >= 0 else {
+            .filter {
+                guard $0.range.location >= 0 else {
                     return false
                 }
-                maxUpperBound = max(maxUpperBound, range.upperBound)
+                maxUpperBound = max(maxUpperBound, $0.range.upperBound)
                 return true
             }
-            .sorted(by: { $0.0.location < $1.0.location })
+            .sorted(by: { $0.range.location < $1.range.location })
         var orderedMentions = orderedMentions
 
         // Collapse all overlaps.
-        var finalStyles = [(NSRange, Style)]()
+        var finalStyles = [NSRangedValue<Style>]()
         var collapsedStyleAtIndex: (start: Int, Style) = (start: 0, [])
         var endIndexToStyle = [Int: Style]()
         var styleToEndIndex = [Style: Int]()
@@ -166,22 +170,22 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
             var newStylesToApply: Style = []
 
             func startApplyingStyles(at index: Int) {
-                while let (newRange, newStyle) = sortedStyles.first, newRange.location == index {
+                while let newRangedStyle = sortedStyles.first, newRangedStyle.range.location == index {
                     sortedStyles.removeFirst()
-                    newStylesToApply.insert(newStyle)
+                    newStylesToApply.insert(newRangedStyle.value)
 
                     // A new style starts here. But we might overlap with
                     // a style of the same type, in which case we should
                     // join them by taking the further of the two endpoints
-                    let oldUpperBound = styleToEndIndex[newStyle]
-                    if newRange.upperBound > (oldUpperBound ?? -1) {
-                        styleToEndIndex[newStyle] = newRange.upperBound
-                        var stylesAtEnd = endIndexToStyle[newRange.upperBound] ?? []
-                        stylesAtEnd.insert(newStyle)
-                        endIndexToStyle[newRange.upperBound] = stylesAtEnd
+                    let oldUpperBound = styleToEndIndex[newRangedStyle.value]
+                    if newRangedStyle.range.upperBound > (oldUpperBound ?? -1) {
+                        styleToEndIndex[newRangedStyle.value] = newRangedStyle.range.upperBound
+                        var stylesAtEnd = endIndexToStyle[newRangedStyle.range.upperBound] ?? []
+                        stylesAtEnd.insert(newRangedStyle.value)
+                        endIndexToStyle[newRangedStyle.range.upperBound] = stylesAtEnd
                         if let oldUpperBound {
                             var stylesAtExistingEnd = endIndexToStyle[oldUpperBound] ?? []
-                            stylesAtExistingEnd.remove(newStyle)
+                            stylesAtExistingEnd.remove(newRangedStyle.value)
                             endIndexToStyle[oldUpperBound] = stylesAtExistingEnd
                         }
                     }
@@ -194,21 +198,21 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
                 styleToEndIndex[stylesToRemove] = nil
             }
 
-            if let mention = orderedMentions.first, mention.0.location == i {
+            if let mention = orderedMentions.first, mention.range.location == i {
                 orderedMentions.removeFirst()
-                if mention.0.length > 0 {
+                if mention.range.length > 0 {
                     // Styles always apply to an entire mention. This means when we find
                     // a mention we have to do two things:
                     // 1) any styles that start later in the mention are treated as if they start now.
-                    for j in i+1..<mention.0.upperBound {
+                    for j in i+1..<mention.range.upperBound {
                         startApplyingStyles(at: j)
                     }
                     // 2) make sure any active styles are extended to the end of the mention
-                    for j in i..<mention.0.upperBound {
+                    for j in i..<mention.range.upperBound {
                         if let stylesEndingMidMention = endIndexToStyle.removeValue(forKey: j) {
-                            var stylesAtNewEnd = endIndexToStyle[mention.0.upperBound] ?? []
+                            var stylesAtNewEnd = endIndexToStyle[mention.range.upperBound] ?? []
                             stylesAtNewEnd.insert(stylesEndingMidMention)
-                            endIndexToStyle[mention.0.upperBound] = stylesAtNewEnd
+                            endIndexToStyle[mention.range.upperBound] = stylesAtNewEnd
                         }
                     }
                 }
@@ -218,7 +222,10 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
                 // We have changes. End the previous style if any, and start a new one.
                 var (startIndex, currentCollapsedStyle) = collapsedStyleAtIndex
                 if currentCollapsedStyle.isEmpty.negated {
-                    finalStyles.append((NSRange(location: startIndex, length: i - startIndex), currentCollapsedStyle))
+                    finalStyles.append(.init(
+                        currentCollapsedStyle,
+                        range: NSRange(location: startIndex, length: i - startIndex)
+                    ))
                 }
 
                 currentCollapsedStyle.remove(stylesToRemove)
@@ -228,18 +235,71 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
         }
 
         if collapsedStyleAtIndex.1.isEmpty.negated {
-            finalStyles.append((
-                NSRange(
+            finalStyles.append(.init(
+                collapsedStyleAtIndex.1,
+                range: NSRange(
                     location: collapsedStyleAtIndex.start,
                     length: maxUpperBound - collapsedStyleAtIndex.start
-                ),
-                collapsedStyleAtIndex.1
+                )
             ))
         }
 
         return finalStyles
     }
 
+    internal struct SubrangeStyles {
+        let substringRange: NSRange
+        let stylesInSubstring: [NSRangedValue<Style>]
+    }
+
+    /// Given a subrange and set of styles indexed _within that subrange_,
+    /// filters ranges to those within that subrange and merges them with
+    /// the provided styles.
+    ///
+    /// This method is confusing because of the interpretation of ranges.
+    /// _First_ we filter the ranges to those falling in the subrange; the subrange
+    /// is now our coordinate system, with its start being 0.
+    /// _Then_ we merge in the styles, which are already in this coordinate system.
+    internal func mergingStyles(_ styles: SubrangeStyles) -> MessageBodyRanges {
+        func intersect(_ range: NSRange) -> NSRange? {
+            guard
+                let intersection = range.intersection(styles.substringRange),
+                intersection.location != NSNotFound,
+                intersection.length > 0
+            else {
+                return nil
+            }
+            return NSRange(
+                location: intersection.location - styles.substringRange.location,
+                length: intersection.length
+            )
+        }
+
+        var mentions = [NSRange: UUID]()
+        for (range, uuid) in self.mentions {
+            guard let newRange = intersect(range) else {
+                continue
+            }
+            mentions[newRange] = uuid
+        }
+        let oldStyles: [NSRangedValue<Style>] = self.styles.compactMap { style in
+            guard let newRange = intersect(style.range) else {
+                return nil
+            }
+            return .init(style.value, range: newRange)
+        }
+        let finalStyles = Self.processStylesForInitialization(
+            oldStyles + styles.stylesInSubstring,
+            orderedMentions: mentions.lazy
+                .sorted(by: { $0.key.location < $1.key.location })
+                .map { NSRangedValue($0.value, range: $0.key) }
+        )
+        return MessageBodyRanges(
+            mentions: mentions,
+            styles: finalStyles
+        )
+    }
+
     public func copy(with zone: NSZone? = nil) -> Any {
         return MessageBodyRanges(mentions: mentions, styles: styles)
     }
@@ -251,9 +311,9 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
             coder.encode(uuid, forKey: "mentions.uuid.\(idx)")
         }
         coder.encode(styles.count, forKey: "stylesCount")
-        for (idx, (range, style)) in styles.enumerated() {
-            coder.encode(NSValue(range: range), forKey: "styles.range.\(idx)")
-            coder.encode(style.rawValue, forKey: "styles.style.\(idx)")
+        for (idx, style) in styles.enumerated() {
+            coder.encode(NSValue(range: style.range), forKey: "styles.range.\(idx)")
+            coder.encode(style.value.rawValue, forKey: "styles.style.\(idx)")
         }
     }
 
@@ -270,10 +330,10 @@ public class MessageBodyRanges: NSObject, NSCopying, NSSecureCoding {
         for i in 0..<styles.count {
             let style = styles[i]
             let otherStyle = other.styles[i]
-            guard style.0 == otherStyle.0 else {
+            guard style.value == otherStyle.value else {
                 return false
             }
-            guard style.1 == otherStyle.1 else {
+            guard style.range == otherStyle.range else {
                 return false
             }
         }
diff --git a/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift b/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift
index d0a744f9eb1..b5336fab0cd 100644
--- a/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift
+++ b/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift
@@ -266,7 +266,7 @@ public class RecoveredHydratedMessageBody {
             text: string.string,
             ranges: MessageBodyRanges(
                 mentions: mentions,
-                styles: styleAttributes.map { ($0.range, $0.value.style) }
+                styles: styleAttributes.map { .init($0.value.style, range: $0.range) }
             )
         )
     }
diff --git a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h
index e6d5acf8072..d0d4e5254b6 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.h
@@ -41,7 +41,7 @@ extern NSUInteger TSErrorMessageSchemaVersion;
 
 #pragma mark -
 
-@interface TSErrorMessage : TSMessage <OWSReadTracking>
+@interface TSErrorMessage : TSMessage <OWSReadTracking, OWSPreviewText>
 
 - (instancetype)initMessageWithBuilder:(TSMessageBuilder *)messageBuilder NS_UNAVAILABLE;
 
diff --git a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.swift b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.swift
index d644f1836e0..717c2453ccb 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.swift
+++ b/SignalServiceKit/src/Messages/Interactions/TSErrorMessage.swift
@@ -83,3 +83,10 @@ public class TSErrorMessageBuilder: TSMessageBuilder {
         return TSErrorMessage(errorMessageWithBuilder: self)
     }
 }
+
+extension TSErrorMessage {
+
+    public func plaintextBody(_ tx: SDSAnyReadTransaction) -> String {
+        return self.rawBody(with: tx.unwrapGrdbRead) ?? ""
+    }
+}
diff --git a/SignalServiceKit/src/Messages/Interactions/TSMessage.h b/SignalServiceKit/src/Messages/Interactions/TSMessage.h
index 688163ee9b0..0e07ecf5df6 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSMessage.h
+++ b/SignalServiceKit/src/Messages/Interactions/TSMessage.h
@@ -37,7 +37,7 @@ typedef NS_CLOSED_ENUM(NSInteger, TSEditState) {
     TSEditState_PastRevision
 };
 
-@interface TSMessage : TSInteraction <OWSPreviewText>
+@interface TSMessage : TSInteraction <NSObject>
 
 // NOTE: These correspond to just the "body" attachments.
 @property (nonatomic) NSArray<NSString *> *attachmentIds;
@@ -149,11 +149,8 @@ NS_DESIGNATED_INITIALIZER NS_SWIFT_NAME(init(grdbId:uniqueId:receivedAtTimestamp
 
 // The raw body contains placeholders for things like mentions and is not
 // user friendly. If you want a constant string representing the body of
-// this message, this is it. The `plaintextBody` below will fill in the
-// appropriate contact names for a given mention at the time of querying
-// providing a more "user friendly" string.
+// this message, this is it.
 - (nullable NSString *)rawBodyWithTransaction:(GRDBReadTransaction *)transaction;
-- (nullable NSString *)plaintextBodyWithTransaction:(GRDBReadTransaction *)transaction;
 
 - (BOOL)shouldStartExpireTimer;
 
diff --git a/SignalServiceKit/src/Messages/Interactions/TSMessage.m b/SignalServiceKit/src/Messages/Interactions/TSMessage.m
index f5a30229790..b19e50ca266 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSMessage.m
+++ b/SignalServiceKit/src/Messages/Interactions/TSMessage.m
@@ -472,128 +472,6 @@ - (nullable NSString *)rawBodyWithTransaction:(GRDBReadTransaction *)transaction
     return nil;
 }
 
-- (nullable NSString *)plaintextBodyWithTransaction:(GRDBReadTransaction *)transaction
-{
-    NSString *_Nullable rawBody = [self rawBodyWithTransaction:transaction];
-    if (rawBody) {
-        if (self.bodyRanges) {
-            return [self previewTextForBodyRangesWithBodyRanges:self.bodyRanges
-                                                bodyDescription:rawBody
-                                                    transaction:transaction.asAnyRead];
-        }
-
-        return rawBody.filterStringForDisplay;
-    }
-
-    return nil;
-}
-
-// TODO: This method contains view-specific logic and probably belongs in NotificationsManager, not in SSK.
-- (NSString *)previewTextWithTransaction:(SDSAnyReadTransaction *)transaction
-{
-    if (self.wasRemotelyDeleted) {
-        return [self isKindOfClass:[TSIncomingMessage class]]
-            ? OWSLocalizedString(@"THIS_MESSAGE_WAS_DELETED", "text indicating the message was remotely deleted")
-            : OWSLocalizedString(@"YOU_DELETED_THIS_MESSAGE", "text indicating the message was remotely deleted by you");
-    }
-
-    NSString *_Nullable bodyDescription = nil;
-
-    if (self.body.length > 0) {
-        bodyDescription = self.body;
-    }
-
-    if (self.bodyRanges) {
-        bodyDescription = [self previewTextForBodyRangesWithBodyRanges:self.bodyRanges
-                                                       bodyDescription:bodyDescription
-                                                           transaction:transaction];
-    }
-
-    if (bodyDescription == nil) {
-        TSAttachment *_Nullable oversizeTextAttachment =
-            [self oversizeTextAttachmentWithTransaction:transaction.unwrapGrdbRead];
-        if ([oversizeTextAttachment isKindOfClass:[TSAttachmentStream class]]) {
-            TSAttachmentStream *oversizeTextAttachmentStream = (TSAttachmentStream *)oversizeTextAttachment;
-            NSData *_Nullable data = [NSData dataWithContentsOfFile:oversizeTextAttachmentStream.originalFilePath];
-            if (data) {
-                NSString *_Nullable text = [[NSString alloc] initWithData:data encoding:NSUTF8StringEncoding];
-                if (text) {
-                    bodyDescription = text.filterStringForDisplay;
-                }
-            }
-        }
-    }
-
-    if (bodyDescription == nil && self.storyReactionEmoji.length > 0) {
-        if (self.storyAuthorAddress.isLocalAddress) {
-            bodyDescription =
-                [NSString stringWithFormat:OWSLocalizedString(@"STORY_REACTION_LOCAL_AUTHOR_PREVIEW_FORMAT",
-                                               @"inbox and notification text for a reaction to a story authored by the "
-                                               @"local user. Embeds {{reaction emoji}}"),
-                          self.storyReactionEmoji];
-        } else {
-            NSString *storyAuthorName = [self.contactsManager shortDisplayNameForAddress:self.storyAuthorAddress
-                                                                             transaction:transaction];
-            bodyDescription = [NSString
-                stringWithFormat:OWSLocalizedString(@"STORY_REACTION_REMOTE_AUTHOR_PREVIEW_FORMAT",
-                                     @"inbox and notification text for a reaction to a story authored by another user. "
-                                     @"Embeds {{ %1$@ reaction emoji, %2$@ story author name }}"),
-                self.storyReactionEmoji,
-                storyAuthorName];
-        }
-    }
-
-    NSString *_Nullable attachmentEmoji = nil;
-    NSString *_Nullable attachmentDescription = nil;
-
-    TSAttachment *_Nullable mediaAttachment =
-        [self mediaAttachmentsWithTransaction:transaction.unwrapGrdbRead].firstObject;
-    if (mediaAttachment != nil) {
-        attachmentEmoji = mediaAttachment.emoji;
-        attachmentDescription = mediaAttachment.description;
-    }
-
-    if (self.isViewOnceMessage) {
-        if ([self isKindOfClass:TSOutgoingMessage.class] || mediaAttachment == nil) {
-            return OWSLocalizedString(@"PER_MESSAGE_EXPIRATION_NOT_VIEWABLE",
-                @"inbox cell and notification text for an already viewed view-once media message.");
-        } else if (mediaAttachment.isVideo) {
-            return OWSLocalizedString(
-                @"PER_MESSAGE_EXPIRATION_VIDEO_PREVIEW", @"inbox cell and notification text for a view-once video.");
-        } else {
-            OWSAssertDebug(mediaAttachment.isImage || mediaAttachment.isLoopingVideo || mediaAttachment.isAnimated);
-            return OWSLocalizedString(
-                @"PER_MESSAGE_EXPIRATION_PHOTO_PREVIEW", @"inbox cell and notification text for a view-once photo.");
-        }
-    }
-
-    if (attachmentEmoji.length > 0 && bodyDescription.length > 0) {
-        // Attachment with caption.
-        return [[attachmentEmoji stringByAppendingString:@" "] stringByAppendingString:bodyDescription];
-    } else if (bodyDescription.length > 0) {
-        return bodyDescription;
-    } else if (attachmentDescription.length > 0) {
-        return attachmentDescription;
-    } else if (self.contactShare) {
-        return [[@"ðŸ‘¤" stringByAppendingString:@" "] stringByAppendingString:self.contactShare.name.displayName];
-    } else if (self.messageSticker) {
-        NSString *stickerDescription = OWSLocalizedString(@"STICKER_MESSAGE_PREVIEW",
-            @"Preview text shown in notifications and conversation list for sticker messages.");
-        NSString *_Nullable stickerEmoji = [StickerManager firstEmojiInEmojiString:self.messageSticker.emoji];
-        if (stickerEmoji.length > 0) {
-            return [[stickerEmoji stringByAppendingString:@" "] stringByAppendingString:stickerDescription];
-        } else {
-            return stickerDescription;
-        }
-    } else if (self.giftBadge != nil) {
-        return [self previewTextForGiftBadgeWithTransaction:transaction];
-    } else {
-        // This can happen when initially saving outgoing messages
-        // with camera first capture over the conversation list.
-        return @"";
-    }
-}
-
 - (void)anyWillInsertWithTransaction:(SDSAnyWriteTransaction *)transaction
 {
     [super anyWillInsertWithTransaction:transaction];
diff --git a/SignalServiceKit/src/Messages/Interactions/TSMessage.swift b/SignalServiceKit/src/Messages/Interactions/TSMessage.swift
index d73bc9d470a..2aaacaaed8a 100644
--- a/SignalServiceKit/src/Messages/Interactions/TSMessage.swift
+++ b/SignalServiceKit/src/Messages/Interactions/TSMessage.swift
@@ -268,20 +268,163 @@ public extension TSMessage {
         }
     }
 
-    @objc(previewTextForBodyRangesWithBodyRanges:bodyDescription:transaction:)
-    func previewTextForBodyRanges(
-        bodyRanges: MessageBodyRanges,
-        bodyDescription: String?,
-        transaction: SDSAnyReadTransaction
-    ) -> String? {
-        guard let bodyDescription else {
+    func notificationPreviewText(_ tx: SDSAnyReadTransaction) -> String {
+        switch previewText(tx) {
+        case let .body(body, prefix, ranges):
+            let hydrated = MessageBody(text: body, ranges: ranges ?? .empty)
+                .hydrating(mentionHydrator: ContactsMentionHydrator.mentionHydrator(transaction: tx.asV2Read))
+                .asPlaintext()
+            guard let prefix else {
+                return hydrated.filterForDisplay
+            }
+            return prefix.appending(hydrated).filterForDisplay
+        case let .remotelyDeleted(text),
+            let .storyReactionEmoji(text),
+            let .viewOnceMessage(text),
+            let .contactShare(text),
+            let .stickerDescription(text),
+            let .giftBadge(text):
+            return text
+        case .empty:
+            return ""
+        }
+    }
+
+    func conversationListPreviewText(_ tx: SDSAnyReadTransaction) -> HydratedMessageBody {
+        switch previewText(tx) {
+        case let .body(body, prefix, ranges):
+            let hydrated = MessageBody(text: body, ranges: ranges ?? .empty)
+                .hydrating(mentionHydrator: ContactsMentionHydrator.mentionHydrator(transaction: tx.asV2Read))
+            guard let prefix else {
+                return hydrated
+            }
+            return hydrated.addingPrefix(prefix)
+        case let .remotelyDeleted(text),
+            let .storyReactionEmoji(text),
+            let .viewOnceMessage(text),
+            let .contactShare(text),
+            let .stickerDescription(text),
+            let .giftBadge(text):
+            return HydratedMessageBody.fromPlaintextWithoutRanges(text)
+        case .empty:
+            return HydratedMessageBody.fromPlaintextWithoutRanges("")
+        }
+    }
+
+    func conversationListSearchResultsBody(_ tx: SDSAnyReadTransaction) -> MessageBody? {
+        switch previewText(tx) {
+        case let .body(body, _, ranges):
+            // We ignore the prefix here.
+            return MessageBody(text: body, ranges: ranges ?? .empty)
+        case .remotelyDeleted,
+            .storyReactionEmoji,
+            .viewOnceMessage,
+            .contactShare,
+            .stickerDescription,
+            .giftBadge,
+            .empty:
             return nil
         }
-        let messageBody = MessageBody(text: bodyDescription, ranges: bodyRanges)
-        // TODO[TextFormatting]: apply styles depending on context.
-        return messageBody.hydrating(
-            mentionHydrator: ContactsMentionHydrator.mentionHydrator(transaction: transaction.asV2Read)
-        ).asPlaintext()
+    }
+
+    private enum PreviewText {
+        case body(String, prefix: String?, ranges: MessageBodyRanges?)
+        case remotelyDeleted(String)
+        case storyReactionEmoji(String)
+        case viewOnceMessage(String)
+        case contactShare(String)
+        case stickerDescription(String)
+        case giftBadge(String)
+        case empty
+    }
+
+    private func previewText(_ tx: SDSAnyReadTransaction) -> PreviewText {
+        if self.wasRemotelyDeleted {
+            return .remotelyDeleted((self is TSIncomingMessage)
+                ? OWSLocalizedString("THIS_MESSAGE_WAS_DELETED", comment: "text indicating the message was remotely deleted")
+                : OWSLocalizedString("YOU_DELETED_THIS_MESSAGE", comment: "text indicating the message was remotely deleted by you")
+            )
+        }
+
+        let bodyDescription = self.rawBody(with: tx.unwrapGrdbRead)
+        if
+            bodyDescription == nil,
+            let storyReactionEmoji,
+            storyReactionEmoji.isEmpty.negated
+        {
+            if let storyAuthorAddress, storyAuthorAddress.isLocalAddress.negated {
+                let storyAuthorName = self.contactsManager.shortDisplayName(for: storyAuthorAddress, transaction: tx)
+                return .storyReactionEmoji(String(
+                    format: OWSLocalizedString(
+                        "STORY_REACTION_REMOTE_AUTHOR_PREVIEW_FORMAT",
+                        comment: "inbox and notification text for a reaction to a story authored by another user. Embeds {{ %1$@ reaction emoji, %2$@ story author name }}"
+                    ),
+                    storyReactionEmoji,
+                    storyAuthorName
+                ))
+            } else {
+                return .storyReactionEmoji(String(
+                    format: OWSLocalizedString(
+                        "STORY_REACTION_LOCAL_AUTHOR_PREVIEW_FORMAT",
+                        comment: "inbox and notification text for a reaction to a story authored by the local user. Embeds {{reaction emoji}}"
+                    ),
+                    storyReactionEmoji
+                ))
+            }
+        }
+
+        let mediaAttachment = self.mediaAttachments(with: tx.unwrapGrdbRead).first
+        let attachmentEmoji = mediaAttachment?.emoji
+        let attachmentDescription = mediaAttachment?.description()
+
+        if isViewOnceMessage {
+            if self is TSOutgoingMessage || mediaAttachment == nil {
+                return .viewOnceMessage(OWSLocalizedString(
+                    "PER_MESSAGE_EXPIRATION_NOT_VIEWABLE",
+                    comment: "inbox cell and notification text for an already viewed view-once media message."
+                ))
+            } else if mediaAttachment?.isVideo == true {
+                return .viewOnceMessage(OWSLocalizedString(
+                    "PER_MESSAGE_EXPIRATION_VIDEO_PREVIEW",
+                    comment: "inbox cell and notification text for a view-once video."
+                ))
+            } else {
+                // Make sure that if we add new types we cover them here.
+                owsAssertDebug(
+                    mediaAttachment?.isImage == true
+                    || mediaAttachment?.isLoopingVideo == true
+                    || mediaAttachment?.isAnimated == true
+                )
+                return .viewOnceMessage(OWSLocalizedString(
+                    "PER_MESSAGE_EXPIRATION_PHOTO_PREVIEW",
+                    comment: "inbox cell and notification text for a view-once photo."
+                ))
+            }
+        }
+
+        if let bodyDescription = bodyDescription?.nilIfEmpty {
+            return .body(bodyDescription, prefix: attachmentDescription?.nilIfEmpty?.appending(" "), ranges: bodyRanges)
+        } else if let attachmentDescription = attachmentDescription?.nilIfEmpty {
+            return .body(attachmentDescription, prefix: nil, ranges: bodyRanges)
+        } else if let contactShare {
+            return .contactShare("ðŸ‘¤".appending(" ").appending(contactShare.name.displayName))
+        } else if let messageSticker {
+            let stickerDescription = OWSLocalizedString(
+                "STICKER_MESSAGE_PREVIEW",
+                comment: "Preview text shown in notifications and conversation list for sticker messages."
+            )
+            if let stickerEmoji = StickerManager.firstEmoji(inEmojiString: messageSticker.emoji)?.nilIfEmpty {
+                return .stickerDescription(stickerEmoji.appending(" ").appending(stickerDescription))
+            } else {
+                return .stickerDescription(stickerDescription)
+            }
+        } else if giftBadge != nil {
+            return .giftBadge(self.previewTextForGiftBadge(transaction: tx))
+        } else {
+            // This can happen when initially saving outgoing messages
+            // with camera first capture over the conversation list.
+            return .empty
+        }
     }
 
     // MARK: - Stories
diff --git a/SignalServiceKit/src/Protocols/NotificationsProtocol.h b/SignalServiceKit/src/Protocols/NotificationsProtocol.h
index 3448bdc5ca8..3c8bc0c7af3 100644
--- a/SignalServiceKit/src/Protocols/NotificationsProtocol.h
+++ b/SignalServiceKit/src/Protocols/NotificationsProtocol.h
@@ -11,6 +11,7 @@ NS_ASSUME_NONNULL_BEGIN
 @class TSErrorMessage;
 @class TSIncomingMessage;
 @class TSInteraction;
+@class TSMessage;
 @class TSOutgoingMessage;
 @class TSThread;
 @class ThreadlessErrorMessage;
@@ -36,6 +37,12 @@ NS_ASSUME_NONNULL_BEGIN
                       transaction:(SDSAnyWriteTransaction *)transaction
     NS_SWIFT_NAME(notifyUser(forErrorMessage:thread:transaction:));
 
+- (void)notifyUserForTSMessage:(TSMessage *)message
+                        thread:(TSThread *)thread
+                    wantsSound:(BOOL)wantsSound
+                   transaction:(SDSAnyWriteTransaction *)transaction
+    NS_SWIFT_NAME(notifyUser(forTSMessage:thread:wantsSound:transaction:));
+
 - (void)notifyUserForPreviewableInteraction:(TSInteraction<OWSPreviewText> *)previewableInteraction
                                      thread:(TSThread *)thread
                                  wantsSound:(BOOL)wantsSound
diff --git a/SignalServiceKit/src/TestUtils/NoopNotificationsManager.swift b/SignalServiceKit/src/TestUtils/NoopNotificationsManager.swift
index 767102024cd..610021ac249 100644
--- a/SignalServiceKit/src/TestUtils/NoopNotificationsManager.swift
+++ b/SignalServiceKit/src/TestUtils/NoopNotificationsManager.swift
@@ -26,6 +26,15 @@ public class NoopNotificationsManager: NSObject, NotificationsProtocol {
         Logger.warn("skipping notification for: \(errorMessage.description)")
     }
 
+    public func notifyUser(
+        forTSMessage message: TSMessage,
+        thread: TSThread,
+        wantsSound: Bool,
+        transaction: SDSAnyWriteTransaction
+    ) {
+        Logger.warn("skipping notification for: \(message.description)")
+    }
+
     public func notifyUser(forPreviewableInteraction previewableInteraction: TSInteraction & OWSPreviewText,
                            thread: TSThread,
                            wantsSound: Bool,
diff --git a/SignalServiceKit/src/groups/GroupManager+GroupUpdateInfoMessages.swift b/SignalServiceKit/src/groups/GroupManager+GroupUpdateInfoMessages.swift
index 3c10ab209e3..94ae41de7c0 100644
--- a/SignalServiceKit/src/groups/GroupManager+GroupUpdateInfoMessages.swift
+++ b/SignalServiceKit/src/groups/GroupManager+GroupUpdateInfoMessages.swift
@@ -106,7 +106,7 @@ extension GroupManager {
         } else if !wasLocalUserInGroup && isLocalUserInGroup {
             // Notify when the local user is added or invited to a group.
             self.notificationsManager?.notifyUser(
-                forPreviewableInteraction: infoMessage,
+                forTSMessage: infoMessage,
                 thread: groupThread,
                 wantsSound: true,
                 transaction: transaction
diff --git a/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyRangesTests.swift b/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyRangesTests.swift
index 38b450c22e9..e472399e394 100644
--- a/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyRangesTests.swift
+++ b/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyRangesTests.swift
@@ -14,83 +14,83 @@ final class MessageBodyRangesTests: XCTestCase {
 
     func testStyleCollapsing_sequential() {
         // They don't overlap but they're out of order.
-        let styles: [(NSRange, Style)] = [
-            (NSRange(location: 11, length: 5), .strikethrough),
-            (NSRange(location: 0, length: 1), .bold),
-            (NSRange(location: 1, length: 2), .italic),
-            (NSRange(location: 120, length: 10), .bold.union(.italic)),
-            (NSRange(location: 3, length: 3), .monospace),
-            (NSRange(location: 6, length: 4), .spoiler)
+        let styles: [NSRangedValue<Style>] = [
+            .init(.strikethrough, range: NSRange(location: 11, length: 5)),
+            .init(.bold, range: NSRange(location: 0, length: 1)),
+            .init(.italic, range: NSRange(location: 1, length: 2)),
+            .init(.bold.union(.italic), range: NSRange(location: 120, length: 10)),
+            .init(.monospace, range: NSRange(location: 3, length: 3)),
+            .init(.spoiler, range: NSRange(location: 6, length: 4))
         ]
-        let expectedOutput: [(NSRange, Style)] = [
-            (NSRange(location: 0, length: 1), .bold),
-            (NSRange(location: 1, length: 2), .italic),
-            (NSRange(location: 3, length: 3), .monospace),
-            (NSRange(location: 6, length: 4), .spoiler),
-            (NSRange(location: 11, length: 5), .strikethrough),
-            (NSRange(location: 120, length: 10), .bold.union(.italic))
+        let expectedOutput: [NSRangedValue<Style>] = [
+            .init(.bold, range: NSRange(location: 0, length: 1)),
+            .init(.italic, range: NSRange(location: 1, length: 2)),
+            .init(.monospace, range: NSRange(location: 3, length: 3)),
+            .init(.spoiler, range: NSRange(location: 6, length: 4)),
+            .init(.strikethrough, range: NSRange(location: 11, length: 5)),
+            .init(.bold.union(.italic), range: NSRange(location: 120, length: 10))
         ]
         let output = MessageBodyRanges(mentions: [:], styles: styles).styles
         assertStylesEqual(expectedOutput, output)
     }
 
     func testStyleCollapsing_overlap() {
-        var styles: [(NSRange, Style)] = [
-            (NSRange(location: 0, length: 3), .bold),
-            (NSRange(location: 1, length: 3), .italic)
+        var styles: [NSRangedValue<Style>] = [
+            .init(.bold, range: NSRange(location: 0, length: 3)),
+            .init(.italic, range: NSRange(location: 1, length: 3))
         ]
-        var expectedOutput: [(NSRange, Style)] = [
-            (NSRange(location: 0, length: 1), .bold),
-            (NSRange(location: 1, length: 2), .bold.union(.italic)),
-            (NSRange(location: 3, length: 1), .italic)
+        var expectedOutput: [NSRangedValue<Style>] = [
+            .init(.bold, range: NSRange(location: 0, length: 1)),
+            .init(.bold.union(.italic), range: NSRange(location: 1, length: 2)),
+            .init(.italic, range: NSRange(location: 3, length: 1))
         ]
         var output = MessageBodyRanges(mentions: [:], styles: styles).styles
         assertStylesEqual(expectedOutput, output)
 
         styles = [
-            (NSRange(location: 0, length: 5), .bold),
-            (NSRange(location: 1, length: 3), .italic)
+            .init(.bold, range: NSRange(location: 0, length: 5)),
+            .init(.italic, range: NSRange(location: 1, length: 3))
         ]
         expectedOutput = [
-            (NSRange(location: 0, length: 1), .bold),
-            (NSRange(location: 1, length: 3), .bold.union(.italic)),
-            (NSRange(location: 4, length: 1), .bold)
+            .init(.bold, range: NSRange(location: 0, length: 1)),
+            .init(.bold.union(.italic), range: NSRange(location: 1, length: 3)),
+            .init(.bold, range: NSRange(location: 4, length: 1))
         ]
         output = MessageBodyRanges(mentions: [:], styles: styles).styles
         assertStylesEqual(expectedOutput, output)
 
         styles = [
-            (NSRange(location: 0, length: 5), .bold),
-            (NSRange(location: 4, length: 5), .italic),
-            (NSRange(location: 8, length: 5), .spoiler)
+            .init(.bold, range: NSRange(location: 0, length: 5)),
+            .init(.italic, range: NSRange(location: 4, length: 5)),
+            .init(.spoiler, range: NSRange(location: 8, length: 5))
         ]
         expectedOutput = [
-            (NSRange(location: 0, length: 4), .bold),
-            (NSRange(location: 4, length: 1), .bold.union(.italic)),
-            (NSRange(location: 5, length: 3), .italic),
-            (NSRange(location: 8, length: 1), .italic.union(.spoiler)),
-            (NSRange(location: 9, length: 4), .spoiler)
+            .init(.bold, range: NSRange(location: 0, length: 4)),
+            .init(.bold.union(.italic), range: NSRange(location: 4, length: 1)),
+            .init(.italic, range: NSRange(location: 5, length: 3)),
+            .init(.italic.union(.spoiler), range: NSRange(location: 8, length: 1)),
+            .init(.spoiler, range: NSRange(location: 9, length: 4))
         ]
         output = MessageBodyRanges(mentions: [:], styles: styles).styles
         assertStylesEqual(expectedOutput, output)
 
         styles = [
-            (NSRange(location: 0, length: 6), .bold),
-            (NSRange(location: 1, length: 6), .italic),
-            (NSRange(location: 2, length: 6), .spoiler),
-            (NSRange(location: 3, length: 6), .strikethrough),
-            (NSRange(location: 4, length: 6), .monospace)
+            .init(.bold, range: NSRange(location: 0, length: 6)),
+            .init(.italic, range: NSRange(location: 1, length: 6)),
+            .init(.spoiler, range: NSRange(location: 2, length: 6)),
+            .init(.strikethrough, range: NSRange(location: 3, length: 6)),
+            .init(.monospace, range: NSRange(location: 4, length: 6))
         ]
         expectedOutput = [
-            (NSRange(location: 0, length: 1), .bold),
-            (NSRange(location: 1, length: 1), .bold.union(.italic)),
-            (NSRange(location: 2, length: 1), .bold.union(.italic).union(.spoiler)),
-            (NSRange(location: 3, length: 1), .bold.union(.italic).union(.spoiler).union(.strikethrough)),
-            (NSRange(location: 4, length: 2), .bold.union(.italic).union(.spoiler).union(.strikethrough).union(.monospace)),
-            (NSRange(location: 6, length: 1), .italic.union(.spoiler).union(.strikethrough).union(.monospace)),
-            (NSRange(location: 7, length: 1), .spoiler.union(.strikethrough).union(.monospace)),
-            (NSRange(location: 8, length: 1), .strikethrough.union(.monospace)),
-            (NSRange(location: 9, length: 1), .monospace)
+            .init(.bold, range: NSRange(location: 0, length: 1)),
+            .init(.bold.union(.italic), range: NSRange(location: 1, length: 1)),
+            .init(.bold.union(.italic).union(.spoiler), range: NSRange(location: 2, length: 1)),
+            .init(.bold.union(.italic).union(.spoiler).union(.strikethrough), range: NSRange(location: 3, length: 1)),
+            .init(.bold.union(.italic).union(.spoiler).union(.strikethrough).union(.monospace), range: NSRange(location: 4, length: 2)),
+            .init(.italic.union(.spoiler).union(.strikethrough).union(.monospace), range: NSRange(location: 6, length: 1)),
+            .init(.spoiler.union(.strikethrough).union(.monospace), range: NSRange(location: 7, length: 1)),
+            .init(.strikethrough.union(.monospace), range: NSRange(location: 8, length: 1)),
+            .init(.monospace, range: NSRange(location: 9, length: 1))
         ]
         output = MessageBodyRanges(mentions: [:], styles: styles).styles
         assertStylesEqual(expectedOutput, output)
@@ -125,12 +125,12 @@ final class MessageBodyRangesTests: XCTestCase {
                 NSRange(location: 5, length: 7): UUID(uuidString: "AE9EFF5A-706F-46BE-BEA1-A4E86256B8C7")!
             ],
             styles: [
-                (NSRange(location: 0, length: 1), .bold),
-                (NSRange(location: 2, length: 1), .italic),
-                (NSRange(location: 3, length: 1), .italic.union(.monospace).union(.strikethrough)),
-                (NSRange(location: 4, length: 1), .italic.union(.monospace)),
-                (NSRange(location: 5, length: 2), .monospace),
-                (NSRange(location: 8, length: 10), .spoiler)
+                .init(.bold, range: NSRange(location: 0, length: 1)),
+                .init(.italic, range: NSRange(location: 2, length: 1)),
+                .init(.italic.union(.monospace).union(.strikethrough), range: NSRange(location: 3, length: 1)),
+                .init(.italic.union(.monospace), range: NSRange(location: 4, length: 1)),
+                .init(.monospace, range: NSRange(location: 5, length: 2)),
+                .init(.spoiler, range: NSRange(location: 8, length: 10))
             ]
         )
 
@@ -145,15 +145,15 @@ final class MessageBodyRangesTests: XCTestCase {
     // MARK: - Helpers
 
     private func assertStylesEqual(
-        _ lhs: [(NSRange, Style)],
-        _ rhs: [(NSRange, Style)],
+        _ lhs: [NSRangedValue<Style>],
+        _ rhs: [NSRangedValue<Style>],
         file: StaticString = #file,
         line: UInt = #line
     ) {
         XCTAssertEqual(lhs.count, rhs.count, file: file, line: line)
         for i in 0..<lhs.count {
-            XCTAssertEqual(lhs[i].0, rhs[i].0)
-            XCTAssertEqual(lhs[i].1, rhs[i].1)
+            XCTAssertEqual(lhs[i].value, rhs[i].value)
+            XCTAssertEqual(lhs[i].range, rhs[i].range)
         }
     }
 
diff --git a/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyTests.swift b/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyTests.swift
index b31633fa8c5..8dcad270789 100644
--- a/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyTests.swift
+++ b/SignalServiceKit/tests/Messages/BodyRanges/MessageBodyTests.swift
@@ -211,9 +211,9 @@ final class MessageBodyTests: XCTestCase {
                 ranges: .init(
                     mentions: [:],
                     styles: [
-                        (NSRange(location: 8, length: 4), .bold),
-                        (NSRange(location: 14, length: 6), .italic),
-                        (NSRange(location: 26, length: 4), .monospace)
+                        .init(.bold, range: NSRange(location: 8, length: 4)),
+                        .init(.italic, range: NSRange(location: 14, length: 6)),
+                        .init(.monospace, range: NSRange(location: 26, length: 4))
                     ]
                 )
             ),
@@ -257,9 +257,9 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 32, length: 1): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 8, length: 4), .bold),
-                        (NSRange(location: 14, length: 6), .italic),
-                        (NSRange(location: 26, length: 4), .monospace)
+                        .init(.bold, range: NSRange(location: 8, length: 4)),
+                        .init(.italic, range: NSRange(location: 14, length: 6)),
+                        .init(.monospace, range: NSRange(location: 26, length: 4))
                     ]
                 )
             ),
@@ -311,9 +311,9 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 0, length: 1): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 11, length: 4), .bold),
-                        (NSRange(location: 17, length: 6), .italic),
-                        (NSRange(location: 29, length: 4), .monospace)
+                        .init(.bold, range: NSRange(location: 11, length: 4)),
+                        .init(.italic, range: NSRange(location: 17, length: 6)),
+                        .init(.monospace, range: NSRange(location: 29, length: 4))
                     ]
                 )
             ),
@@ -365,7 +365,7 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 15, length: 1): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 0, length: 16), .italic)
+                        .init(.italic, range: NSRange(location: 0, length: 16))
                     ]
                 )
             ),
@@ -396,13 +396,13 @@ final class MessageBodyTests: XCTestCase {
 
     func testHydration_overlappingStylesAndMentions() {
         // The styles are flattened out into this before hydration applies:
-        // (NSRange(location: 0, length: 3), .bold),
-        // (NSRange(location: 3, length: 3), .bold.union(.italic)),
-        // (NSRange(location: 6, length: 2), .bold),
-        // (NSRange(location: 8, length: 16), .bold.union(.monospace)),
-        // (NSRange(location: 24, length: 3), .bold.union(.monospace).union(.spoiler)),
-        // (NSRange(location: 27, length: 4), .bold.union(.spoiler)),
-        // (NSRange(location: 31, length: 20), .bold),
+        // .init(.bold, range: NSRange(location: 0, length: 3)),
+        // .init(.bold.union(.italic), range: NSRange(location: 3, length: 3)),
+        // .init(.bold, range: NSRange(location: 6, length: 2)),
+        // .init(.bold.union(.monospace), range: NSRange(location: 8, length: 16)),
+        // .init(.bold.union(.monospace).union(.spoiler), range: NSRange(location: 24, length: 3)),
+        // .init(.bold.union(.spoiler), range: NSRange(location: 27, length: 4)),
+        // .init(.bold, range: NSRange(location: 31, length: 20)),
         runHydrationTest(
             input: .init(
                 text: "@, @@@, @@@@@@@@@@@@@@@ and @@@ are stylish people.",
@@ -414,10 +414,10 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 28, length: 3): uuids[3]
                     ],
                     styles: [
-                        (NSRange(location: 0, length: 51), .bold),
-                        (NSRange(location: 4, length: 1), .italic),
-                        (NSRange(location: 12, length: 15), .monospace),
-                        (NSRange(location: 24, length: 5), .spoiler)
+                        .init(.bold, range: NSRange(location: 0, length: 51)),
+                        .init(.italic, range: NSRange(location: 4, length: 1)),
+                        .init(.monospace, range: NSRange(location: 12, length: 15)),
+                        .init(.spoiler, range: NSRange(location: 24, length: 5))
                     ]
                 )
             ),
@@ -516,13 +516,13 @@ final class MessageBodyTests: XCTestCase {
 
     func testHydration_overlappingStylesAndSomeUnhydratedMentions() {
         // The styles are flattened out into this before hydration applies:
-        // (NSRange(location: 0, length: 3), .bold),
-        // (NSRange(location: 3, length: 3), .bold.union(.italic)),
-        // (NSRange(location: 6, length: 2), .bold),
-        // (NSRange(location: 8, length: 16), .bold.union(.monospace)),
-        // (NSRange(location: 24, length: 3), .bold.union(.monospace).union(.spoiler)),
-        // (NSRange(location: 27, length: 4), .bold.union(.spoiler)),
-        // (NSRange(location: 31, length: 20), .bold),
+        // .init(, range: NSRange(location: 0, length: 3), .bold),
+        // .init(, range: NSRange(location: 3, length: 3), .bold.union(.italic)),
+        // .init(, range: NSRange(location: 6, length: 2), .bold),
+        // .init(, range: NSRange(location: 8, length: 16), .bold.union(.monospace)),
+        // .init(, range: NSRange(location: 24, length: 3), .bold.union(.monospace).union(.spoiler)),
+        // .init(, range: NSRange(location: 27, length: 4), .bold.union(.spoiler)),
+        // .init(, range: NSRange(location: 31, length: 20), .bold),
         runHydrationTest(
             input: .init(
                 text: "@, @@@, @@@@@@@@@@@@@@@ and @@@ are stylish people.",
@@ -534,10 +534,10 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 28, length: 3): uuids[3]
                     ],
                     styles: [
-                        (NSRange(location: 0, length: 51), .bold),
-                        (NSRange(location: 4, length: 1), .italic),
-                        (NSRange(location: 12, length: 15), .monospace),
-                        (NSRange(location: 24, length: 5), .spoiler)
+                        .init(.bold, range: NSRange(location: 0, length: 51)),
+                        .init(.italic, range: NSRange(location: 4, length: 1)),
+                        .init(.monospace, range: NSRange(location: 12, length: 15)),
+                        .init(.spoiler, range: NSRange(location: 24, length: 5))
                     ]
                 )
             ),
@@ -671,7 +671,7 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 12, length: 1): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 5, length: 3), .italic)
+                        .init(.italic, range: NSRange(location: 5, length: 3))
                     ]
                 )
             ),
@@ -708,7 +708,7 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 0, length: 1): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 5, length: 3), .italic)
+                        .init(.italic, range: NSRange(location: 5, length: 3))
                     ]
                 )
             ),
@@ -747,7 +747,7 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 12, length: 1): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 0, length: 13), .italic)
+                        .init(.italic, range: NSRange(location: 0, length: 13))
                     ]
                 )
             ),
@@ -784,7 +784,7 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 0, length: 1): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 0, length: 13), .italic)
+                        .init(.italic, range: NSRange(location: 0, length: 13))
                     ]
                 )
             ),
@@ -823,7 +823,7 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 12, length: 3): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 5, length: 8), .italic)
+                        .init(.italic, range: NSRange(location: 5, length: 8))
                     ]
                 )
             ),
@@ -859,7 +859,7 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 0, length: 3): uuids[0]
                     ],
                     styles: [
-                        (NSRange(location: 1, length: 8), .italic)
+                        .init(.italic, range: NSRange(location: 1, length: 8))
                     ]
                 )
             ),
@@ -899,9 +899,9 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: 13, length: 3): uuids[1]
                     ],
                     styles: [
-                        (NSRange(location: 1, length: 9), .bold),
-                        (NSRange(location: 4, length: 6), .italic),
-                        (NSRange(location: 11, length: 3), .monospace)
+                        .init(.bold, range: NSRange(location: 1, length: 9)),
+                        .init(.italic, range: NSRange(location: 4, length: 6)),
+                        .init(.monospace, range: NSRange(location: 11, length: 3))
                     ]
                 )
             ),
@@ -985,9 +985,9 @@ final class MessageBodyTests: XCTestCase {
                         NSRange(location: secondMentionLocation + 1, length: 3): uuids[1]
                     ],
                     styles: [
-                        (NSRange(location: 1, length: 3 + firstEmojiLength + 5), .bold),
-                        (NSRange(location: firstEmojiLocation, length: firstEmojiLength + 5 + secondEmojiLength), .italic),
-                        (NSRange(location: middleWordLocation, length: 5 + secondEmojiLength + 2), .monospace)
+                        .init(.bold, range: NSRange(location: 1, length: 3 + firstEmojiLength + 5)),
+                        .init(.italic, range: NSRange(location: firstEmojiLocation, length: firstEmojiLength + 5 + secondEmojiLength)),
+                        .init(.monospace, range: NSRange(location: middleWordLocation, length: 5 + secondEmojiLength + 2))
                     ]
                 )
             ),
diff --git a/SignalUI/Appearance/Theme.swift b/SignalUI/Appearance/Theme.swift
index 161f56037ee..9663eae5c08 100644
--- a/SignalUI/Appearance/Theme.swift
+++ b/SignalUI/Appearance/Theme.swift
@@ -274,7 +274,7 @@ final public class Theme: NSObject {
 
     @objc
     public class var secondaryTextAndIconColor: UIColor {
-        isDarkThemeEnabled ? darkThemeSecondaryTextAndIconColor : .ows_gray60
+        isDarkThemeEnabled ? darkThemeSecondaryTextAndIconColor : lightThemeSecondaryTextAndIconColor
     }
 
     public class var ternaryTextColor: UIColor { .ows_gray45 }
@@ -381,6 +381,9 @@ final public class Theme: NSObject {
     @objc
     public class var lightThemePrimaryColor: UIColor { .ows_gray90 }
 
+    @objc
+    public class var lightThemeSecondaryTextAndIconColor: UIColor { .ows_gray60 }
+
     // MARK: - Dark Theme Colors
 
     public class var darkThemeBackgroundColor: UIColor { .black }
diff --git a/SignalUI/Utils/FullTextSearcher.swift b/SignalUI/Utils/FullTextSearcher.swift
index dcc34ba0404..49845279b6a 100644
--- a/SignalUI/Utils/FullTextSearcher.swift
+++ b/SignalUI/Utils/FullTextSearcher.swift
@@ -3,6 +3,7 @@
 // SPDX-License-Identifier: AGPL-3.0-only
 //
 
+import BonMot
 import Foundation
 import SignalServiceKit
 import SignalMessaging
@@ -41,11 +42,11 @@ public class ConversationSearchResult<SortKey>: Comparable where SortKey: Compar
     public let messageId: String?
     public let messageDate: Date?
 
-    public let snippet: String?
+    public let snippet: NSAttributedString?
 
     private let sortKey: SortKey
 
-    init(thread: ThreadViewModel, sortKey: SortKey, messageId: String? = nil, messageDate: Date? = nil, snippet: String? = nil) {
+    init(thread: ThreadViewModel, sortKey: SortKey, messageId: String? = nil, messageDate: Date? = nil, snippet: NSAttributedString? = nil) {
         self.thread = thread
         self.sortKey = sortKey
         self.messageId = messageId
@@ -722,7 +723,7 @@ public class FullTextSearcher: NSObject {
             return mentionedMessages
         }
 
-        func appendMessage(_ message: TSMessage, snippet: String?) {
+        func appendMessage(_ message: TSMessage, snippet: NSAttributedString?) {
             guard let thread = getThread(message.uniqueThreadId) else {
                 owsFailDebug("Missing thread: \(type(of: message))")
                 return
@@ -748,7 +749,15 @@ public class FullTextSearcher: NSObject {
                 .forEach { message in
                     appendMessage(
                         message,
-                        snippet: message.plaintextBody(with: transaction.unwrapGrdbRead)
+                        snippet: message.conversationListPreviewText(transaction)
+                            .asAttributedStringForDisplay(
+                                config: HydratedMessageBody.DisplayConfiguration(
+                                    mention: .conversationListSearchResultSnippet,
+                                    style: .conversationListSearchResultSnippet,
+                                    searchRanges: nil
+                                ),
+                                isDarkThemeEnabled: Theme.isDarkThemeEnabled
+                            )
                     )
             }
         }
@@ -907,7 +916,42 @@ public class FullTextSearcher: NSObject {
                 stop = true
                 return
             }
-            appendMessage(message, snippet: snippet)
+            let styledSnippet: NSAttributedString? = { () -> NSAttributedString? in
+                guard let snippet else {
+                    return nil
+                }
+                let attributeKey = NSAttributedString.Key("OWSSearchMatch")
+                let matchStyle = BonMot.StringStyle(
+                    .xmlRules([
+                        .style(FullTextSearchFinder.matchTag, StringStyle(.extraAttributes([attributeKey: 0])))
+                    ])
+                )
+                let matchStyleApplied = snippet.styled(with: matchStyle)
+                var styles = [NSRangedValue<MessageBodyRanges.Style>]()
+                matchStyleApplied.enumerateAttributes(in: matchStyleApplied.entireRange, using: { attrs, range, _ in
+                    guard attrs[attributeKey] != nil else {
+                        return
+                    }
+                    styles.append(NSRangedValue(.bold, range: range))
+                })
+                let mergedMessageBody: MessageBody
+                if let messageBody = message.conversationListSearchResultsBody(transaction) {
+                    mergedMessageBody = messageBody.mergeIntoFirstMatchOfStyledSubstring(matchStyleApplied.string, styles: styles)
+                } else {
+                    mergedMessageBody = MessageBody(text: matchStyleApplied.string, ranges: .init(mentions: [:], styles: styles))
+                }
+                return mergedMessageBody
+                    .hydrating(mentionHydrator: ContactsMentionHydrator.mentionHydrator(transaction: transaction.asV2Read))
+                    .asAttributedStringForDisplay(
+                        config: HydratedMessageBody.DisplayConfiguration(
+                            mention: .conversationListSearchResultSnippet,
+                            style: .conversationListSearchResultSnippet,
+                            searchRanges: nil
+                        ),
+                        isDarkThemeEnabled: Theme.isDarkThemeEnabled
+                    )
+            }()
+            appendMessage(message, snippet: styledSnippet)
         }
 
         guard !isCanceled() else {
diff --git a/SignalUI/ViewModels/ThreadViewModel.swift b/SignalUI/ViewModels/ThreadViewModel.swift
index 8a626df833f..b9110ead982 100644
--- a/SignalUI/ViewModels/ThreadViewModel.swift
+++ b/SignalUI/ViewModels/ThreadViewModel.swift
@@ -140,27 +140,29 @@ public class ChatListInfo: Dependencies {
 
         let isBlocked = blockingManager.isThreadBlocked(thread, transaction: transaction)
 
-        func loadDraftText() -> String? {
+        func loadDraftText() -> HydratedMessageBody? {
             guard let draftMessageBody = thread.currentDraft(shouldFetchLatest: false,
                                                              transaction: transaction) else {
                 return nil
             }
-            // TODO[TextFormatting]: apply styles to snippet
             return draftMessageBody
                 .hydrating(
                     mentionHydrator: ContactsMentionHydrator.mentionHydrator(transaction: transaction.asV2Read)
                 )
-                .asPlaintext()
         }
         func hasVoiceMemoDraft() -> Bool {
             VoiceMessageInterruptedDraftStore.hasDraft(for: thread, transaction: transaction)
         }
-        func loadLastMessageText() -> String? {
-            guard let previewable = lastMessageForInbox as? OWSPreviewText else {
+        func loadLastMessageText() -> HydratedMessageBody? {
+            if let previewable = lastMessageForInbox as? OWSPreviewText {
+                return HydratedMessageBody.fromPlaintextWithoutRanges(
+                    previewable.previewText(transaction: transaction).filterStringForDisplay()
+                )
+            } else if let tsMessage = lastMessageForInbox as? TSMessage {
+                return tsMessage.conversationListPreviewText(transaction)
+            } else {
                 return nil
             }
-            // TODO[TextFormatting]: apply styles to snippet
-            return previewable.previewText(transaction: transaction).filterStringForDisplay()
         }
         func loadLastMessageSenderName() -> String? {
             guard let groupThread = thread as? TSGroupThread else {
@@ -211,9 +213,9 @@ public class ChatListInfo: Dependencies {
 public enum CLVSnippet {
     case blocked
     case pendingMessageRequest(addedToGroupByName: String?)
-    case draft(draftText: String)
+    case draft(draftText: HydratedMessageBody)
     case voiceMemoDraft
-    case contactSnippet(lastMessageText: String)
-    case groupSnippet(lastMessageText: String, senderName: String)
+    case contactSnippet(lastMessageText: HydratedMessageBody)
+    case groupSnippet(lastMessageText: HydratedMessageBody, senderName: String)
     case none
 }
diff --git a/SignalUI/Views/ConversationView/CVText.swift b/SignalUI/Views/ConversationView/CVText.swift
index 5503ccd2efa..897640bae45 100644
--- a/SignalUI/Views/ConversationView/CVText.swift
+++ b/SignalUI/Views/ConversationView/CVText.swift
@@ -61,7 +61,7 @@ public enum CVTextValue: Equatable, Hashable {
         case .text(let text):
             return "t\(text)"
         case .attributedText(let attributedText):
-            return "a\(attributedText.string.description)"
+            return "a\(attributedText.description)"
         }
     }
 }
diff --git a/SignalUI/Views/ConversationView/CVUtils.swift b/SignalUI/Views/ConversationView/CVUtils.swift
index ca91159da02..50f2d5e3ab7 100644
--- a/SignalUI/Views/ConversationView/CVUtils.swift
+++ b/SignalUI/Views/ConversationView/CVUtils.swift
@@ -51,6 +51,11 @@ open class CVLabel: UILabel, CVView {
     }
 
     public func reset() {
+        // NOTE: we have to reset the attributed text and then the text;
+        // this is the magic incantation that prevents properties from
+        // a previously-set attributed string from applying to subsequent
+        // attributed strings.
+        self.attributedText = nil
         self.text = nil
     }
 }
diff --git a/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift b/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift
index b3c83da3e12..3c88d6e5d68 100644
--- a/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift
+++ b/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift
@@ -52,9 +52,21 @@ extension MentionDisplayConfiguration {
         )
     }
 
-    public static var conversationListSnippet: Self {
-        return config(
-            foregroundColor: primaryTextColor,
+    public static func conversationListSnippet(
+        font: UIFont,
+        textColor: ThemedColor
+    ) -> Self {
+        return MentionDisplayConfiguration(
+            font: font,
+            foregroundColor: textColor,
+            backgroundColor: nil
+        )
+    }
+
+    public static var conversationListSearchResultSnippet: MentionDisplayConfiguration {
+        return MentionDisplayConfiguration(
+            font: .dynamicTypeBody2,
+            foregroundColor: ThemedColor(light: Theme.lightThemeSecondaryTextAndIconColor, dark: Theme.darkThemeSecondaryTextAndIconColor),
             backgroundColor: nil
         )
     }
diff --git a/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift b/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift
index 960c44cc3be..2786bc4dcc1 100644
--- a/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift
+++ b/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift
@@ -41,6 +41,27 @@ extension StyleDisplayConfiguration {
         )
     }
 
+    public static func forConversationListSnippet(
+        baseFont: UIFont,
+        textColor: ThemedColor
+    ) -> StyleDisplayConfiguration {
+        return StyleDisplayConfiguration(
+            baseFont: baseFont,
+            textColor: textColor,
+            revealAllIds: false,
+            revealedIds: Set()
+        )
+    }
+
+    public static var conversationListSearchResultSnippet: StyleDisplayConfiguration {
+        return StyleDisplayConfiguration(
+            baseFont: UIFont.dynamicTypeBody2,
+            textColor: ThemedColor(light: Theme.lightThemeSecondaryTextAndIconColor, dark: Theme.darkThemeSecondaryTextAndIconColor),
+            revealAllIds: false,
+            revealedIds: Set()
+        )
+    }
+
     private static let primaryTextColor = ThemedColor(
         light: Theme.lightThemePrimaryColor,
         dark: Theme.darkThemePrimaryColor
