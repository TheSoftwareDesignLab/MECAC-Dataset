diff --git a/Signal.xcodeproj/project.pbxproj b/Signal.xcodeproj/project.pbxproj
index 7878d6dbc6d..02648f7fdde 100644
--- a/Signal.xcodeproj/project.pbxproj
+++ b/Signal.xcodeproj/project.pbxproj
@@ -420,7 +420,6 @@
 		454A84042059C787008B8C75 /* MediaTileViewController.swift in Sources */ = {isa = PBXBuildFile; fileRef = 454A84032059C787008B8C75 /* MediaTileViewController.swift */; };
 		454A965A1FD6017E008D2A0E /* SignalAttachment.swift in Sources */ = {isa = PBXBuildFile; fileRef = 34D913491F62D4A500722898 /* SignalAttachment.swift */; };
 		454EBAB41F2BE14C00ACE0BB /* OWSAnalytics.swift in Sources */ = {isa = PBXBuildFile; fileRef = 34D99C911F2937CC00D284D6 /* OWSAnalytics.swift */; };
-		4551DB5A205C562300C8AE75 /* Collection+OWS.swift in Sources */ = {isa = PBXBuildFile; fileRef = 4551DB59205C562300C8AE75 /* Collection+OWS.swift */; };
 		4556FA681F54AA9500AF40DD /* DebugUIProfile.swift in Sources */ = {isa = PBXBuildFile; fileRef = 4556FA671F54AA9500AF40DD /* DebugUIProfile.swift */; };
 		455A16DD1F1FEA0000F86704 /* Metal.framework in Frameworks */ = {isa = PBXBuildFile; fileRef = 455A16DB1F1FEA0000F86704 /* Metal.framework */; settings = {ATTRIBUTES = (Weak, ); }; };
 		455A16DE1F1FEA0000F86704 /* MetalKit.framework in Frameworks */ = {isa = PBXBuildFile; fileRef = 455A16DC1F1FEA0000F86704 /* MetalKit.framework */; settings = {ATTRIBUTES = (Weak, ); }; };
@@ -1360,7 +1359,6 @@
 		4542DF53208D40AC007B4E76 /* LoadingViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = LoadingViewController.swift; sourceTree = "<group>"; };
 		454A84032059C787008B8C75 /* MediaTileViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = MediaTileViewController.swift; sourceTree = "<group>"; };
 		454B35071D08EED80026D658 /* mk */ = {isa = PBXFileReference; lastKnownFileType = text.plist.strings; name = mk; path = translations/mk.lproj/Localizable.strings; sourceTree = "<group>"; };
-		4551DB59205C562300C8AE75 /* Collection+OWS.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = "Collection+OWS.swift"; sourceTree = "<group>"; };
 		4556FA671F54AA9500AF40DD /* DebugUIProfile.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = DebugUIProfile.swift; sourceTree = "<group>"; };
 		455A16DB1F1FEA0000F86704 /* Metal.framework */ = {isa = PBXFileReference; lastKnownFileType = wrapper.framework; name = Metal.framework; path = System/Library/Frameworks/Metal.framework; sourceTree = SDKROOT; };
 		455A16DC1F1FEA0000F86704 /* MetalKit.framework */ = {isa = PBXFileReference; lastKnownFileType = wrapper.framework; name = MetalKit.framework; path = System/Library/Frameworks/MetalKit.framework; sourceTree = SDKROOT; };
@@ -2185,7 +2183,6 @@
 		34480B5C1FD0A98800BC14EF /* categories */ = {
 			isa = PBXGroup;
 			children = (
-				4551DB59205C562300C8AE75 /* Collection+OWS.swift */,
 				45BB93371E688E14001E3939 /* UIDevice+featureSupport.swift */,
 				34480B661FD0AA9400BC14EF /* UIFont+OWS.h */,
 				34480B651FD0AA9400BC14EF /* UIFont+OWS.m */,
@@ -4649,7 +4646,6 @@
 				34ABB2C42090C59700C727A6 /* OWSResaveCollectionDBMigration.m in Sources */,
 				4C38E501230374D700E464B9 /* UIViewController+Permissions.m in Sources */,
 				4C948FF72146EB4800349F0D /* BlockListCache.swift in Sources */,
-				4551DB5A205C562300C8AE75 /* Collection+OWS.swift in Sources */,
 				34BBC84F220B8A0100857249 /* ImageEditorCropViewController.swift in Sources */,
 				88BAE55D2487595B001F00F9 /* ImageEditorBlurViewController.swift in Sources */,
 				34AC09ED211B39B100997B47 /* ContactFieldView.swift in Sources */,
diff --git a/SignalServiceKit/src/Contacts/ContactsUpdater.m b/SignalServiceKit/src/Contacts/ContactsUpdater.m
index bef0af4eefe..047049e8bd3 100644
--- a/SignalServiceKit/src/Contacts/ContactsUpdater.m
+++ b/SignalServiceKit/src/Contacts/ContactsUpdater.m
@@ -89,14 +89,14 @@ - (void)contactIntersectionWithSet:(NSSet<NSString *> *)phoneNumbersToLookup
                            failure:(void (^)(NSError *error))failure
 {
     dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
-        NSMutableSet<SignalRecipient *> *registeredRecipients = [NSMutableSet new];
+        OWSOperation<OWSContactDiscovering> *operation = nil;
+
         if (SSKFeatureFlags.useOnlyModernContactDiscovery) {
-            OWSFailDebug(@"failure: TODO");
+            operation = [[OWSContactDiscoveryOperation alloc] initWithPhoneNumbersToLookup:phoneNumbersToLookup.allObjects];
+        } else {
+            operation = [[OWSLegacyContactDiscoveryOperation alloc] initWithPhoneNumbersToLookup:phoneNumbersToLookup.allObjects];
         }
 
-        OWSLegacyContactDiscoveryOperation *operation =
-            [[OWSLegacyContactDiscoveryOperation alloc] initWithPhoneNumbersToLookup:phoneNumbersToLookup.allObjects];
-
         NSArray<NSOperation *> *operationAndDependencies = [operation.dependencies arrayByAddingObject:operation];
         [self.contactIntersectionQueue addOperations:operationAndDependencies waitUntilFinished:YES];
 
@@ -104,20 +104,29 @@ - (void)contactIntersectionWithSet:(NSSet<NSString *> *)phoneNumbersToLookup
             failure(operation.failingError);
             return;
         }
+        if (operation.isCancelled) {
+            // This should never happen, but if it does we'll end up unregistering everyting. Force a failure
+            failure(OWSErrorMakeAssertionError(@"Unexpected operation cancellation"));
+            return;
+        }
 
-        NSSet<NSString *> *registeredPhoneNumbers = operation.registeredPhoneNumbers;
+        NSMutableSet<SignalRecipient *> *registeredRecipients = [[NSMutableSet alloc] init];
         DatabaseStorageWrite(self.databaseStorage, ^(SDSAnyWriteTransaction *transaction) {
-            for (NSString *phoneNumber in phoneNumbersToLookup) {
+            NSMutableSet<NSString *> *toUnregister = [phoneNumbersToLookup mutableCopy];
+            for (OWSDiscoveredContactInfo *contactInfo in operation.discoveredContactInfo) {
+                SignalServiceAddress *address = [[SignalServiceAddress alloc] initWithUuid:contactInfo.uuid
+                                                                               phoneNumber:contactInfo.e164];
+                SignalRecipient *recipient = [SignalRecipient markRecipientAsRegisteredAndGet:address
+                                                                                   trustLevel:SignalRecipientTrustLevelHigh
+                                                                                  transaction:transaction];
+
+                [registeredRecipients addObject:recipient];
+                [toUnregister removeObject:contactInfo.e164];
+            }
+
+            for (NSString *phoneNumber in toUnregister) {
                 SignalServiceAddress *address = [[SignalServiceAddress alloc] initWithPhoneNumber:phoneNumber];
-                if ([registeredPhoneNumbers containsObject:phoneNumber]) {
-                    SignalRecipient *recipient =
-                        [SignalRecipient markRecipientAsRegisteredAndGet:address
-                                                              trustLevel:SignalRecipientTrustLevelHigh
-                                                             transaction:transaction];
-                    [registeredRecipients addObject:recipient];
-                } else {
-                    [SignalRecipient markRecipientAsUnregistered:address transaction:transaction];
-                }
+                [SignalRecipient markRecipientAsUnregistered:address transaction:transaction];
             }
         });
 
diff --git a/SignalServiceKit/src/Contacts/OWSContactDiscoveryOperation.swift b/SignalServiceKit/src/Contacts/OWSContactDiscoveryOperation.swift
index 6525b6e4bb3..de61f1f8c2c 100644
--- a/SignalServiceKit/src/Contacts/OWSContactDiscoveryOperation.swift
+++ b/SignalServiceKit/src/Contacts/OWSContactDiscoveryOperation.swift
@@ -5,16 +5,47 @@
 import Foundation
 import PromiseKit
 
-@objc(OWSLegacyContactDiscoveryOperation)
-public class LegacyContactDiscoveryOperation: OWSOperation {
+/// This would be a struct if it didn't need to be bridged to objc.
+/// A plain-old tuple of contact info. This is not cached or updated like SignalServiceAddress
+@objc (OWSDiscoveredContactInfo) @objcMembers
+public class DiscoveredContactInfo: NSObject {
+    public let e164: String?
+    public let uuid: UUID?
+
+    public init(e164: String?, uuid: UUID?) {
+        self.e164 = e164
+        self.uuid = uuid
+    }
 
-    @objc
-    public var registeredPhoneNumbers: Set<String>?
+    public override func isEqual(_ object: Any?) -> Bool {
+        guard let otherInfo = object as? DiscoveredContactInfo else { return false }
+        return e164 == otherInfo.e164 && uuid == otherInfo.uuid
+    }
 
-    @objc
-    public var registeredAddresses: Set<SignalServiceAddress>?
+    public override var hash: Int {
+        return e164.hashValue ^ uuid.hashValue
+    }
+}
+
+@objc (OWSContactDiscovering)
+public protocol ContactDiscovering {
+    /// Constructs a ContactDiscovering object from an array of e164 phone numbers
+    @objc init(phoneNumbersToLookup: [String])
+
+    /// On successful completion, this property will be populated with the resulting contact info
+    @objc var discoveredContactInfo: Set<DiscoveredContactInfo>? { get }
+}
+
+@objc(OWSLegacyContactDiscoveryOperation)
+public class LegacyContactDiscoveryOperation: OWSOperation, ContactDiscovering {
 
     private let phoneNumbersToLookup: [String]
+    @objc public var registeredPhoneNumbers: Set<String>?
+    @objc public var discoveredContactInfo: Set<DiscoveredContactInfo>? {
+        return registeredPhoneNumbers?.reduce(into: Set()) {
+            $0.insert(DiscoveredContactInfo(e164: $1, uuid: nil))
+        }
+    }
 
     // MARK: - Dependencies
 
@@ -158,8 +189,8 @@ enum ContactDiscoveryError: Error {
     case serverError(underlyingError: Error)
 }
 
-@objc(SSKContactDiscoveryOperation)
-public class ContactDiscoveryOperation: OWSOperation {
+@objc(OWSContactDiscoveryOperation)
+public class ContactDiscoveryOperation: OWSOperation, ContactDiscovering {
 
     let batchSize = 2048
     static let operationQueue: OperationQueue = {
@@ -170,12 +201,17 @@ public class ContactDiscoveryOperation: OWSOperation {
     }()
 
     let phoneNumbersToLookup: [String]
-    var registeredContacts: Set<CDSRegisteredContact>
+    var registeredContacts: Set<CDSRegisteredContact>?
+
+    @objc public var discoveredContactInfo: Set<DiscoveredContactInfo>? {
+        return registeredContacts?.reduce(into: Set()) {
+            $0.insert(DiscoveredContactInfo(e164: $1.e164PhoneNumber, uuid: $1.signalUuid))
+        }
+    }
 
-    required init(phoneNumbersToLookup: [String]) {
+    @objc required public init(phoneNumbersToLookup: [String]) {
         assert(phoneNumbersToLookup.count == Set(phoneNumbersToLookup).count)
         self.phoneNumbersToLookup = phoneNumbersToLookup
-        self.registeredContacts = Set()
 
         super.init()
 
@@ -198,6 +234,7 @@ public class ContactDiscoveryOperation: OWSOperation {
     override public func run() {
         Logger.debug("")
 
+        var accumulatedResultSet = Set<CDSRegisteredContact>()
         for dependency in self.dependencies {
             guard let batchOperation = dependency as? CDSBatchOperation else {
                 owsFailDebug("unexpected dependency: \(dependency)")
@@ -209,9 +246,9 @@ public class ContactDiscoveryOperation: OWSOperation {
                 continue
             }
 
-            self.registeredContacts.formUnion(registeredContactsBatch)
+            accumulatedResultSet.formUnion(registeredContactsBatch)
         }
-
+        self.registeredContacts = accumulatedResultSet
         self.reportSuccess()
     }
 
@@ -484,7 +521,9 @@ class CDSFeedbackOperation: OWSOperation {
             return
         }
 
-        let registeredPhoneNumbers = Set(cdsOperation.registeredContacts.map { $0.e164PhoneNumber })
+        let modernResults = cdsOperation.registeredContacts ?? Set()
+
+        let registeredPhoneNumbers = Set(modernResults.map { $0.e164PhoneNumber })
 
         if registeredPhoneNumbers == legacyRegisteredPhoneNumbers {
             self.makeRequest(result: .ok)
@@ -514,14 +553,6 @@ class CDSFeedbackOperation: OWSOperation {
     }
 }
 
-extension Array {
-    func chunked(by chunkSize: Int) -> [[Element]] {
-        return stride(from: 0, to: self.count, by: chunkSize).map {
-            Array(self[$0..<Swift.min($0 + chunkSize, self.count)])
-        }
-    }
-}
-
 extension CDSFeedbackOperation.FeedbackResult {
     var statusPath: String {
         switch self {
diff --git a/SignalServiceKit/src/Contacts/UUIDBackfillTask.swift b/SignalServiceKit/src/Contacts/UUIDBackfillTask.swift
index 65c7baf528d..8f84c4bbda9 100644
--- a/SignalServiceKit/src/Contacts/UUIDBackfillTask.swift
+++ b/SignalServiceKit/src/Contacts/UUIDBackfillTask.swift
@@ -208,7 +208,13 @@ extension UUIDBackfillTask {
                                  completion: @escaping (Set<CDSRegisteredContact>, Error?) -> Void) {
             let operation = ContactDiscoveryOperation(phoneNumbersToLookup: phoneNumbers)
             operation.completionBlock = {
-                completion(operation.registeredContacts, operation.failingError)
+                guard let results = operation.registeredContacts else {
+                    // This is only hit if the operation is cancelled. Force an error so we don't try and unregister everyone
+                    let error = operation.failingError ?? OWSAssertionError("Operation unexpectedly cancelled")
+                    completion(Set(), error)
+                    return
+                }
+                completion(results, nil)
             }
             operation.perform()
         }
diff --git a/SignalServiceKit/src/Messages/OWSMessageSender.swift b/SignalServiceKit/src/Messages/OWSMessageSender.swift
index d96641a80b8..1ab58ca5d85 100644
--- a/SignalServiceKit/src/Messages/OWSMessageSender.swift
+++ b/SignalServiceKit/src/Messages/OWSMessageSender.swift
@@ -496,8 +496,17 @@ extension MessageSender {
                 completion(error)
                 return
             }
+            guard let results = operation.registeredContacts else {
+                // This works around a tiny discrepancy between the two contact discovery operations
+                // It should only happen if an operation is cancelled, and even then it really shouldn't happen
+                // Force an error for now but this will probably be removed in the next week
+                let error = OWSAssertionError("Unexpectedly received nil from discovery operation") as NSError
+                error.isRetryable = true
+                completion(error)
+                return
+            }
 
-            let discoveredContactMap = operation.registeredContacts.reduce(into: [:], { (builder, contact) in
+            let discoveredContactMap = results.reduce(into: [:], { (builder, contact) in
                 builder[contact.e164PhoneNumber] = contact.signalUuid
             })
 
diff --git a/SignalServiceKit/src/TSConstants.swift b/SignalServiceKit/src/TSConstants.swift
index 48d50ad8fc0..c34e04bcf9c 100644
--- a/SignalServiceKit/src/TSConstants.swift
+++ b/SignalServiceKit/src/TSConstants.swift
@@ -209,7 +209,7 @@ private class TSConstantsStaging: TSConstantsProtocol {
     public let storageServiceCensorshipPrefix = "storage-staging"
 
     // CDS uses the same EnclaveName and MrEnclave
-    public let contactDiscoveryEnclaveName = "e49d9043c4ed121114064a2636b575de1edb78956caf82b8e18de7186d35949d"
+    public let contactDiscoveryEnclaveName = "bd123560b01c8fa92935bc5ae15cd2064e5c45215f23f0bd40364d521329d2ad"
     public var contactDiscoveryMrEnclave: String {
         return contactDiscoveryEnclaveName
     }
diff --git a/SignalMessaging/categories/Collection+OWS.swift b/SignalServiceKit/src/Util/Collection+OWS.swift
similarity index 100%
rename from SignalMessaging/categories/Collection+OWS.swift
rename to SignalServiceKit/src/Util/Collection+OWS.swift
