diff --git a/Signal.xcodeproj/project.pbxproj b/Signal.xcodeproj/project.pbxproj
index fde5ad77f8a..9604087d347 100644
--- a/Signal.xcodeproj/project.pbxproj
+++ b/Signal.xcodeproj/project.pbxproj
@@ -904,6 +904,10 @@
 		888017902741E5DB00346E9A /* boost_fire.json in Resources */ = {isa = PBXBuildFile; fileRef = 8880178A2741E5DB00346E9A /* boost_fire.json */; };
 		888017922741F33B00346E9A /* BoostViewController.swift in Sources */ = {isa = PBXBuildFile; fileRef = 888017912741F33B00346E9A /* BoostViewController.swift */; };
 		8880179427430DDB00346E9A /* BadgeThanksSheet.swift in Sources */ = {isa = PBXBuildFile; fileRef = 8880179327430DDB00346E9A /* BadgeThanksSheet.swift */; };
+		88863A4E280CAE0800977F69 /* StorySlideAnimator.swift in Sources */ = {isa = PBXBuildFile; fileRef = 88863A4D280CAE0800977F69 /* StorySlideAnimator.swift */; };
+		88863A50280CAE4400977F69 /* StoryZoomAnimator.swift in Sources */ = {isa = PBXBuildFile; fileRef = 88863A4F280CAE4400977F69 /* StoryZoomAnimator.swift */; };
+		88863A52280CAE6A00977F69 /* StoryInteractiveTransitionCoordinator.swift in Sources */ = {isa = PBXBuildFile; fileRef = 88863A51280CAE6A00977F69 /* StoryInteractiveTransitionCoordinator.swift */; };
+		88863A54280CAEAA00977F69 /* StoryReplySheetAnimator.swift in Sources */ = {isa = PBXBuildFile; fileRef = 88863A53280CAEAA00977F69 /* StoryReplySheetAnimator.swift */; };
 		888B6D4D25B2523800E2A662 /* ConversationViewController+Wallpaper.swift in Sources */ = {isa = PBXBuildFile; fileRef = 888B6D4C25B2523700E2A662 /* ConversationViewController+Wallpaper.swift */; };
 		888C828223D795FA0059464B /* pinCreationFail.json in Resources */ = {isa = PBXBuildFile; fileRef = 888C827F23D795F90059464B /* pinCreationFail.json */; };
 		888C828323D795FA0059464B /* pinCreationInProgress.json in Resources */ = {isa = PBXBuildFile; fileRef = 888C828023D795FA0059464B /* pinCreationInProgress.json */; };
@@ -2153,6 +2157,10 @@
 		8880178A2741E5DB00346E9A /* boost_fire.json */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = text.json; path = boost_fire.json; sourceTree = "<group>"; };
 		888017912741F33B00346E9A /* BoostViewController.swift */ = {isa = PBXFileReference; fileEncoding = 4; lastKnownFileType = sourcecode.swift; path = BoostViewController.swift; sourceTree = "<group>"; };
 		8880179327430DDB00346E9A /* BadgeThanksSheet.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = BadgeThanksSheet.swift; sourceTree = "<group>"; };
+		88863A4D280CAE0800977F69 /* StorySlideAnimator.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = StorySlideAnimator.swift; sourceTree = "<group>"; };
+		88863A4F280CAE4400977F69 /* StoryZoomAnimator.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = StoryZoomAnimator.swift; sourceTree = "<group>"; };
+		88863A51280CAE6A00977F69 /* StoryInteractiveTransitionCoordinator.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = StoryInteractiveTransitionCoordinator.swift; sourceTree = "<group>"; };
+		88863A53280CAEAA00977F69 /* StoryReplySheetAnimator.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = StoryReplySheetAnimator.swift; sourceTree = "<group>"; };
 		888A27E324B3E97E0045D639 /* pt_BR */ = {isa = PBXFileReference; lastKnownFileType = text.plist.strings; name = pt_BR; path = translations/pt_BR.lproj/InfoPlist.strings; sourceTree = "<group>"; };
 		888A27E424B3E97E0045D639 /* ko */ = {isa = PBXFileReference; lastKnownFileType = text.plist.strings; name = ko; path = translations/ko.lproj/InfoPlist.strings; sourceTree = "<group>"; };
 		888A27E524B3E97E0045D639 /* ca */ = {isa = PBXFileReference; lastKnownFileType = text.plist.strings; name = ca; path = translations/ca.lproj/InfoPlist.strings; sourceTree = "<group>"; };
@@ -4093,8 +4101,9 @@
 				8852572827DD366D0032073C /* StoriesViewController.swift */,
 				884DB94427DD70F700C6A309 /* IncomingStoryViewModel.swift */,
 				884DB94627DD754700C6A309 /* StoryCell.swift */,
-				88423A50280A1703007D2918 /* Reply Sheets */,
 				884DB94A27DE66E000C6A309 /* Context View */,
+				88423A50280A1703007D2918 /* Reply Sheets */,
+				88863A4C280CADDC00977F69 /* Transitions */,
 			);
 			path = Stories;
 			sourceTree = "<group>";
@@ -4286,6 +4295,17 @@
 			path = Boost;
 			sourceTree = "<group>";
 		};
+		88863A4C280CADDC00977F69 /* Transitions */ = {
+			isa = PBXGroup;
+			children = (
+				88863A51280CAE6A00977F69 /* StoryInteractiveTransitionCoordinator.swift */,
+				88863A4D280CAE0800977F69 /* StorySlideAnimator.swift */,
+				88863A4F280CAE4400977F69 /* StoryZoomAnimator.swift */,
+				88863A53280CAEAA00977F69 /* StoryReplySheetAnimator.swift */,
+			);
+			path = Transitions;
+			sourceTree = "<group>";
+		};
 		88A4CC13246CE41E0082211F /* Device Transfer */ = {
 			isa = PBXGroup;
 			children = (
@@ -6090,6 +6110,7 @@
 				32E03522273901710081EE11 /* BadgeConfigurationViewController.swift in Sources */,
 				34A95501271B503E00B05242 /* DisplayableText.swift in Sources */,
 				34ACA7F32733161000E47AD4 /* RegistrationCaptchaViewController.swift in Sources */,
+				88863A54280CAEAA00977F69 /* StoryReplySheetAnimator.swift in Sources */,
 				347B83FD24378DDF0019A52C /* GroupMemberRequestsAndInvitesViewController.swift in Sources */,
 				3426A366255C854B0036407F /* CVItemViewModelImpl.swift in Sources */,
 				348815CC2554216A00D4F4C4 /* CVAudioPlayback.swift in Sources */,
@@ -6104,6 +6125,7 @@
 				3406D32625DD5EAF00885B14 /* ChatListViewController.swift in Sources */,
 				34DC9BD921543E0C00FDDCEC /* DebugContactsUtils.m in Sources */,
 				4C25768A23AD510800E0398D /* LoadMoreMessagesView.swift in Sources */,
+				88863A4E280CAE0800977F69 /* StorySlideAnimator.swift in Sources */,
 				88F58A1725EEE5B9008CDA24 /* AppSettingsViewController.swift in Sources */,
 				4C04392A220A9EC800BAEA63 /* VoiceNoteLock.swift in Sources */,
 				8806EF1B248DBFC100E764C7 /* ContactPermissionReminderMegaphone.swift in Sources */,
@@ -6193,6 +6215,7 @@
 				4C2F454F214C00E1004871FF /* AvatarTableViewCell.swift in Sources */,
 				887CD4772472FEA500FDD265 /* DeviceTransferOperation.swift in Sources */,
 				88D23D2023CEC0C700B0E74B /* IndividualCallService.swift in Sources */,
+				88863A52280CAE6A00977F69 /* StoryInteractiveTransitionCoordinator.swift in Sources */,
 				8845B0C9264F12F800FA694C /* GroupDescriptionPreviewView.swift in Sources */,
 				4CD675BE22E7BE35008010D2 /* MediaDismissAnimationController.swift in Sources */,
 				88EFF4F825AD1F0D000FAFBA /* ForwardMessageViewController.swift in Sources */,
@@ -6567,6 +6590,7 @@
 				88ABB8B925349F6C00229EAA /* GroupCallVideoGridLayout.swift in Sources */,
 				88D23D2423CEC0C700B0E74B /* CallKitCallManager.swift in Sources */,
 				459311FC1D75C948008DD4F0 /* OWSDeviceTableViewCell.m in Sources */,
+				88863A50280CAE4400977F69 /* StoryZoomAnimator.swift in Sources */,
 				34EB0CEB26289D8800B62DC3 /* MessageTimerView.swift in Sources */,
 				AC12B86D0DA4943DF1DE9CE6 /* OWSAddToContactViewController.swift in Sources */,
 			);
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryContextViewController.swift b/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryContextViewController.swift
index c9e0d102b42..044ab4c1af8 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryContextViewController.swift	
+++ b/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryContextViewController.swift	
@@ -36,6 +36,13 @@ class StoryContextViewController: OWSViewController {
     }
     var currentItemMediaView: StoryItemMediaView?
 
+    var allowsReplies: Bool {
+        guard let currentItem = currentItem else {
+            return false
+        }
+        return currentItem.message.localUserAllowedToReply
+    }
+
     enum LoadPosition {
         case `default`
         case newest
@@ -131,23 +138,7 @@ class StoryContextViewController: OWSViewController {
 
         view.addSubview(mediaViewContainer)
 
-        replyButton.setPressedBlock { [weak self] in
-            guard let self = self, let currentItem = self.currentItem else { return }
-            switch self.context {
-            case .groupId:
-                let groupReplyVC = StoryGroupReplySheet(storyMessage: currentItem.message)
-                groupReplyVC.dismissHandler = { [weak self] in self?.play() }
-                self.pause()
-                self.present(groupReplyVC, animated: true)
-            case .authorUuid:
-                let directReplyVC = StoryDirectReplySheet(storyMessage: currentItem.message)
-                directReplyVC.dismissHandler = { [weak self] in self?.play() }
-                self.pause()
-                self.present(directReplyVC, animated: true)
-            case .none:
-                owsFailDebug("Unexpected context")
-            }
-        }
+        replyButton.setPressedBlock { [weak self] in self?.presentReplySheet() }
         replyButton.setBackgroundColors(upColor: .clear)
         replyButton.autoSetDimension(.height, toSize: 64)
         replyButton.setTitleColor(Theme.darkThemePrimaryColor)
@@ -473,6 +464,30 @@ extension StoryContextViewController: UIGestureRecognizerDelegate {
         delegate?.storyContextViewControllerDidResume(self)
     }
 
+    func presentReplySheet(interactiveTransitionCoordinator: StoryInteractiveTransitionCoordinator? = nil) {
+        guard let currentItem = currentItem, currentItem.message.localUserAllowedToReply else {
+            owsFailDebug("Unexpectedly attempting to present reply sheet")
+            return
+        }
+
+        switch self.context {
+        case .groupId:
+            let groupReplyVC = StoryGroupReplySheet(storyMessage: currentItem.message)
+            groupReplyVC.interactiveTransitionCoordinator = interactiveTransitionCoordinator
+            groupReplyVC.dismissHandler = { [weak self] in self?.play() }
+            self.pause()
+            self.present(groupReplyVC, animated: true)
+        case .authorUuid:
+            let directReplyVC = StoryDirectReplySheet(storyMessage: currentItem.message)
+            directReplyVC.interactiveTransitionCoordinator = interactiveTransitionCoordinator
+            directReplyVC.dismissHandler = { [weak self] in self?.play() }
+            self.pause()
+            self.present(directReplyVC, animated: true)
+        case .none:
+            owsFailDebug("Unexpected context")
+        }
+    }
+
     func gestureRecognizerShouldBegin(_ gestureRecognizer: UIGestureRecognizer) -> Bool {
         let nextFrameWidth = mediaViewContainer.width * 0.8
         let previousFrameWidth = mediaViewContainer.width * 0.2
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryPageViewController.swift b/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryPageViewController.swift
index e5e8989f35f..6583ab07e8d 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryPageViewController.swift	
+++ b/Signal/src/ViewControllers/HomeView/Stories/Context View/StoryPageViewController.swift	
@@ -24,7 +24,7 @@ class StoryPageViewController: UIPageViewController {
         didSet { initiallyAvailableContexts = contextDataSource?.storyPageViewControllerAvailableContexts(self) ?? [currentContext] }
     }
     lazy var initiallyAvailableContexts: [StoryContext] = [currentContext]
-    private var interactiveDismissCoordinator: InteractiveDismissCoordinator?
+    private var interactiveDismissCoordinator: StoryInteractiveTransitionCoordinator?
 
     required init(context: StoryContext) {
         super.init(transitionStyle: .scroll, navigationOrientation: .vertical, options: nil)
@@ -49,7 +49,7 @@ class StoryPageViewController: UIPageViewController {
         delegate = self
         view.backgroundColor = .black
 
-        interactiveDismissCoordinator = InteractiveDismissCoordinator(pageViewController: self)
+        interactiveDismissCoordinator = StoryInteractiveTransitionCoordinator(pageViewController: self)
     }
 
     public override func viewDidAppear(_ animated: Bool) {
@@ -169,15 +169,12 @@ extension StoryPageViewController: StoryContextViewControllerDelegate {
         )
     }
 
-    func pause() { displayLink?.isPaused = true }
-    func resume() { displayLink?.isPaused = false }
-
     func storyContextViewControllerDidPause(_ storyContextViewController: StoryContextViewController) {
-        pause()
+        displayLink?.isPaused = true
     }
 
     func storyContextViewControllerDidResume(_ storyContextViewController: StoryContextViewController) {
-        resume()
+        displayLink?.isPaused = false
     }
 }
 
@@ -193,7 +190,7 @@ extension StoryPageViewController: UIViewControllerTransitioningDelegate {
         ) else {
             return nil
         }
-        return ZoomAnimator(storyTransitionContext: storyTransitionContext)
+        return StoryZoomAnimator(storyTransitionContext: storyTransitionContext)
     }
 
     public func animationController(forDismissed dismissed: UIViewController) -> UIViewControllerAnimatedTransitioning? {
@@ -202,14 +199,14 @@ extension StoryPageViewController: UIViewControllerTransitioningDelegate {
             presentingViewController: presentingViewController,
             isPresenting: false
         ) else {
-            return SlideAnimator(interactiveEdge: interactiveDismissCoordinator?.interactiveEdge ?? .none)
+            return StorySlideAnimator(interactiveEdge: interactiveDismissCoordinator?.interactiveEdge ?? .none)
         }
-        return ZoomAnimator(storyTransitionContext: storyTransitionContext)
+        return StoryZoomAnimator(storyTransitionContext: storyTransitionContext)
     }
 
     public func interactionControllerForDismissal(using animator: UIViewControllerAnimatedTransitioning) -> UIViewControllerInteractiveTransitioning? {
         guard let interactiveDismissCoordinator = interactiveDismissCoordinator, interactiveDismissCoordinator.interactionInProgress else { return nil }
-        interactiveDismissCoordinator.mode = animator is ZoomAnimator ? .zoom : .slide
+        interactiveDismissCoordinator.mode = animator is StoryZoomAnimator ? .zoom : .slide
         return interactiveDismissCoordinator
     }
 
@@ -287,353 +284,3 @@ extension StoryPageViewController: UIViewControllerTransitioningDelegate {
         return storyView
     }
 }
-
-private class InteractiveDismissCoordinator: UIPercentDrivenInteractiveTransition, UIGestureRecognizerDelegate {
-    weak var pageViewController: StoryPageViewController!
-    lazy var panGestureRecognizer = UIPanGestureRecognizer(
-        target: self,
-        action: #selector(handlePan(_:))
-    )
-    init(pageViewController: StoryPageViewController) {
-        self.pageViewController = pageViewController
-        super.init()
-        pageViewController.view.addGestureRecognizer(panGestureRecognizer)
-        panGestureRecognizer.delegate = self
-
-        for subview in pageViewController.view.subviews {
-            guard let scrollView = subview as? UIScrollView else { continue }
-            scrollView.panGestureRecognizer.require(toFail: panGestureRecognizer)
-            break
-        }
-    }
-
-    var interactionInProgress: Bool { interactiveEdge != .none }
-
-    enum Edge {
-        case leading
-        case top
-        case bottom
-        case none
-    }
-    var interactiveEdge: Edge = .none
-
-    enum Mode {
-        case zoom
-        case slide
-    }
-    var mode: Mode = .zoom
-
-    @objc
-    func handlePan(_ gestureRecognizer: UIPanGestureRecognizer) {
-        switch gestureRecognizer.state {
-        case .began:
-            gestureRecognizer.setTranslation(.zero, in: pageViewController.view)
-            pageViewController.pause()
-            pageViewController.dismiss(animated: true)
-        case .changed:
-            update(calculateProgress(gestureRecognizer))
-        case .cancelled:
-            pageViewController.resume()
-            cancel()
-            interactiveEdge = .none
-        case .ended:
-            let progress = calculateProgress(gestureRecognizer)
-
-            if progress >= 0.5 || hasExceededVelocityThreshold(gestureRecognizer) {
-                finish()
-            } else {
-                pageViewController.resume()
-                cancel()
-            }
-
-            interactiveEdge = .none
-        default:
-            cancel()
-            interactiveEdge = .none
-        }
-    }
-
-    func calculateProgress(_ gestureRecognizer: UIPanGestureRecognizer) -> CGFloat {
-        let offset = gestureRecognizer.translation(in: pageViewController.view)
-        let totalDistance: CGFloat
-
-        switch mode {
-        case .zoom: totalDistance = 150
-        case .slide:
-            switch interactiveEdge {
-            case .top, .bottom: totalDistance = pageViewController.view.height
-            case .leading, .none: totalDistance = pageViewController.view.width
-            }
-        }
-
-        switch interactiveEdge {
-        case .top:
-            return offset.y / totalDistance
-        case .leading:
-            return ((CurrentAppContext().isRTL ? -1 : 1) * offset.x) / totalDistance
-        case .bottom:
-            return -offset.y / totalDistance
-        case .none:
-            return 0
-        }
-    }
-
-    func hasExceededVelocityThreshold(_ gestureRecognizer: UIPanGestureRecognizer) -> Bool {
-        let velocity = gestureRecognizer.velocity(in: pageViewController.view)
-        let velocityThreshold: CGFloat = 500
-
-        switch interactiveEdge {
-        case .top:
-            return velocity.y > velocityThreshold
-        case .leading:
-            return ((CurrentAppContext().isRTL ? -1 : 1) * velocity.x) > velocityThreshold
-        case .bottom:
-            return -velocity.y > velocityThreshold
-        case .none:
-            return false
-        }
-    }
-
-    func gestureRecognizerShouldBegin(_ gestureRecognizer: UIGestureRecognizer) -> Bool {
-        guard gestureRecognizer == panGestureRecognizer else { return false }
-        let translation = panGestureRecognizer.translation(in: pageViewController.view)
-
-        if !CurrentAppContext().isRTL, translation.x > 0 {
-            interactiveEdge = .leading
-            return true
-        } else if CurrentAppContext().isRTL, translation.x < 0 {
-            interactiveEdge = .leading
-            return true
-        } else if pageViewController.previousStoryContext == nil, translation.y > 0 {
-            interactiveEdge = .top
-            return true
-        } else if pageViewController.nextStoryContext == nil, translation.y < 0 {
-            interactiveEdge = .bottom
-            return true
-        } else {
-            interactiveEdge = .none
-            return false
-        }
-    }
-
-    func gestureRecognizer(
-        _ gestureRecognizer: UIGestureRecognizer,
-        shouldRecognizeSimultaneouslyWith otherGestureRecognizer: UIGestureRecognizer
-    ) -> Bool {
-        gestureRecognizer == panGestureRecognizer
-    }
-}
-
-private struct StoryTransitionContext {
-    let isPresenting: Bool
-    let thumbnailView: UIView
-    let storyView: UIView
-    let thumbnailRepresentsStoryView: Bool
-    weak var pageViewController: StoryPageViewController!
-}
-
-private class ZoomAnimator: NSObject, UIViewControllerAnimatedTransitioning {
-    private let context: StoryTransitionContext
-    private let backgroundView = UIView()
-
-    init(storyTransitionContext: StoryTransitionContext) {
-        self.context = storyTransitionContext
-        super.init()
-    }
-
-    func transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -> TimeInterval { totalDuration }
-    var totalDuration: TimeInterval { presentationDelay + presentationDuration + crossFadeDuration }
-    var crossFadeDuration: TimeInterval { 0.1 }
-    var presentationDelay: TimeInterval {
-        if context.isPresenting {
-            return context.thumbnailRepresentsStoryView ? 0 : crossFadeDuration
-        } else {
-            return crossFadeDuration
-        }
-    }
-    var presentationDuration: TimeInterval { 0.2 }
-
-    func animateTransition(using transitionContext: UIViewControllerContextTransitioning) {
-        let containerView = transitionContext.containerView
-
-        guard let toVC = transitionContext.viewController(forKey: .to) else {
-            owsFailDebug("Missing toVC")
-            transitionContext.completeTransition(false)
-            return
-        }
-
-        let dismissedFrame = containerView.convert(
-            context.thumbnailView.frame,
-            from: context.thumbnailView.superview
-        )
-        var presentedFrame = transitionContext.finalFrame(for: toVC)
-
-        let heightScalar = UIDevice.current.isIPad
-            ? UIDevice.current.orientation.isLandscape ? 0.75 : 0.65
-            : 1
-
-        let maxHeight = presentedFrame.height * heightScalar
-        presentedFrame.size.height = min(maxHeight, presentedFrame.width * (16 / 9))
-        presentedFrame.size.width = presentedFrame.height * (9 / 16)
-
-        if UIDevice.current.isIPad {
-            // Center in view
-            presentedFrame.origin = CGPoint(
-                x: containerView.safeAreaLayoutGuide.layoutFrame.midX - (presentedFrame.width / 2),
-                y: containerView.safeAreaLayoutGuide.layoutFrame.midY - (presentedFrame.height / 2)
-            )
-        } else {
-            // Pin to top of view
-            presentedFrame.origin.y = containerView.safeAreaInsets.top
-        }
-
-        backgroundView.backgroundColor = .ows_black
-        backgroundView.frame = transitionContext.finalFrame(for: toVC)
-
-        toVC.view.frame = transitionContext.finalFrame(for: toVC)
-
-        if context.isPresenting {
-            containerView.addSubview(backgroundView)
-            containerView.addSubview(context.storyView)
-            containerView.addSubview(toVC.view)
-
-            context.storyView.frame = dismissedFrame
-            context.storyView.layoutIfNeeded()
-
-            backgroundView.alpha = 0
-            toVC.view.alpha = 0
-
-            context.storyView.layer.cornerRadius = 12
-            context.storyView.alpha = 0
-
-            UIView.animateKeyframes(withDuration: totalDuration, delay: 0) {
-                self.animateThumbnailFade()
-                self.animatePresentation(delay: self.presentationDelay, endFrame: presentedFrame)
-                self.animateChromeFade(delay: self.presentationDelay + self.presentationDuration)
-            } completion: { _ in
-                self.context.storyView.removeFromSuperview()
-                self.context.thumbnailView.alpha = 1
-                self.backgroundView.removeFromSuperview()
-                transitionContext.completeTransition(true)
-            }
-        } else {
-            containerView.addSubview(toVC.view)
-            containerView.addSubview(backgroundView)
-            containerView.addSubview(context.storyView)
-            containerView.addSubview(context.pageViewController.view)
-
-            context.storyView.layer.cornerRadius = UIDevice.current.hasIPhoneXNotch || UIDevice.current.isIPad ? 18 : 0
-            context.storyView.frame = presentedFrame
-            if let storyView = context.storyView as? TextAttachmentThumbnailView {
-                storyView.renderSize = presentedFrame.size
-            }
-            context.storyView.layoutIfNeeded()
-
-            context.thumbnailView.alpha = 0
-
-            UIView.animateKeyframes(withDuration: totalDuration, delay: 0) {
-                self.animateChromeFade()
-                self.animatePresentation(delay: self.presentationDelay, endFrame: dismissedFrame)
-                self.animateThumbnailFade(delay: self.presentationDuration + self.crossFadeDuration)
-            } completion: { _ in
-                self.context.storyView.removeFromSuperview()
-                self.backgroundView.removeFromSuperview()
-
-                if transitionContext.transitionWasCancelled {
-                    toVC.view.removeFromSuperview()
-                    self.context.pageViewController.view.alpha = 1
-                    self.context.thumbnailView.alpha = 1
-                } else {
-                    self.context.pageViewController.view.removeFromSuperview()
-                }
-
-                transitionContext.completeTransition(!transitionContext.transitionWasCancelled)
-            }
-        }
-    }
-
-    /// Cross-fade the thumbnail on the stories list if it doesn't match the presented story
-    private func animateThumbnailFade(delay: TimeInterval = 0) {
-        let duration = context.thumbnailRepresentsStoryView ? 0 : crossFadeDuration
-        UIView.addKeyframe(withRelativeStartTime: delay / totalDuration, relativeDuration: duration / totalDuration) {
-            self.context.storyView.alpha = self.context.isPresenting ? 1 : 0
-            self.context.thumbnailView.alpha = self.context.isPresenting ? 0 : 1
-        }
-    }
-
-    /// Move the story to its final location
-    private func animatePresentation(delay: TimeInterval = 0, endFrame: CGRect) {
-        UIView.addKeyframe(withRelativeStartTime: delay / totalDuration, relativeDuration: presentationDuration / totalDuration) {
-            if let storyView = self.context.storyView as? TextAttachmentThumbnailView {
-                storyView.renderSize = self.context.isPresenting
-                    ? endFrame.size : TextAttachmentThumbnailView.defaultRenderSize
-            }
-            self.context.storyView.layer.cornerRadius = self.context.isPresenting
-                ? UIDevice.current.hasIPhoneXNotch || UIDevice.current.isIPad ? 18 : 0
-                : 12
-            self.context.storyView.frame = endFrame
-            self.context.storyView.layoutIfNeeded()
-            self.backgroundView.alpha = self.context.isPresenting ? 1 : 0
-        }
-    }
-
-    /// Fade the UI chrome
-    private func animateChromeFade(delay: TimeInterval = 0) {
-        UIView.addKeyframe(withRelativeStartTime: delay / totalDuration, relativeDuration: crossFadeDuration / totalDuration) {
-            self.context.pageViewController.view.alpha = self.context.isPresenting ? 1 : 0
-        }
-    }
-}
-
-private class SlideAnimator: NSObject, UIViewControllerAnimatedTransitioning {
-    let interactiveEdge: InteractiveDismissCoordinator.Edge
-    init(interactiveEdge: InteractiveDismissCoordinator.Edge) {
-        self.interactiveEdge = interactiveEdge
-    }
-
-    func transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -> TimeInterval {
-        0.2
-    }
-
-    func animateTransition(using transitionContext: UIViewControllerContextTransitioning) {
-        let containerView = transitionContext.containerView
-
-        guard let fromVC = transitionContext.viewController(forKey: .from),
-              let toVC = transitionContext.viewController(forKey: .to) else {
-            owsFailDebug("Missing vcs")
-            transitionContext.completeTransition(false)
-            return
-        }
-
-        containerView.addSubview(toVC.view)
-
-        containerView.addSubview(fromVC.view)
-        fromVC.view.frame = transitionContext.initialFrame(for: fromVC)
-
-        let endFrame: CGRect
-        switch interactiveEdge {
-        case .leading:
-            endFrame = fromVC.view.frame.offsetBy(dx: (CurrentAppContext().isRTL ? -1 : 1) * fromVC.view.width, dy: 0)
-        case .top, .none:
-            endFrame = fromVC.view.frame.offsetBy(dx: 0, dy: fromVC.view.height)
-        case .bottom:
-            endFrame = fromVC.view.frame.offsetBy(dx: 0, dy: -fromVC.view.height)
-        }
-
-        UIView.animate(
-            withDuration: transitionDuration(using: transitionContext),
-            delay: 0,
-            options: interactiveEdge != .none ? .curveLinear : .curveEaseInOut
-        ) {
-            fromVC.view.frame = endFrame
-        } completion: { _ in
-            if transitionContext.transitionWasCancelled {
-                toVC.view.removeFromSuperview()
-            } else {
-                fromVC.view.removeFromSuperview()
-            }
-
-            transitionContext.completeTransition(!transitionContext.transitionWasCancelled)
-        }
-    }
-}
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/Group Reply Sheet/StoryGroupReplySheet.swift b/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/Group Reply Sheet/StoryGroupReplySheet.swift
index af01cbf0afc..3a8b1c331e2 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/Group Reply Sheet/StoryGroupReplySheet.swift	
+++ b/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/Group Reply Sheet/StoryGroupReplySheet.swift	
@@ -25,6 +25,7 @@ class StoryGroupReplySheet: InteractiveSheetViewController, StoryReplySheet {
 
     let storyMessage: StoryMessage
     lazy var thread: TSThread? = databaseStorage.read { storyMessage.context.thread(transaction: $0) }
+    weak var interactiveTransitionCoordinator: StoryInteractiveTransitionCoordinator?
 
     var reactionPickerBackdrop: UIView?
     var reactionPicker: MessageReactionPicker?
@@ -93,8 +94,6 @@ class StoryGroupReplySheet: InteractiveSheetViewController, StoryReplySheet {
         replyLoader = StoryGroupReplyLoader(storyMessage: storyMessage, threadUniqueId: thread?.uniqueId, tableView: tableView)
     }
 
-    public override var canBecomeFirstResponder: Bool { true }
-
     public override var inputAccessoryView: UIView? { inputAccessoryPlaceholder }
 
     override func dismiss(animated flag: Bool, completion: (() -> Void)? = nil) {
@@ -282,3 +281,42 @@ extension StoryGroupReplySheet: ContextMenuInteractionDelegate {
 
     func contextMenuInteraction(_ interaction: ContextMenuInteraction, didEndForConfiguration configuration: ContextMenuConfiguration) {}
 }
+
+extension StoryGroupReplySheet {
+    override func presentationController(
+        forPresented presented: UIViewController,
+        presenting: UIViewController?,
+        source: UIViewController
+    ) -> UIPresentationController? {
+        return nil
+    }
+
+    public func animationController(
+        forPresented presented: UIViewController,
+        presenting: UIViewController,
+        source: UIViewController
+    ) -> UIViewControllerAnimatedTransitioning? {
+        return StoryReplySheetAnimator(
+            isPresenting: true,
+            isInteractive: interactiveTransitionCoordinator != nil,
+            backdropView: backdropView
+        )
+    }
+
+    public func animationController(
+        forDismissed dismissed: UIViewController
+    ) -> UIViewControllerAnimatedTransitioning? {
+        return StoryReplySheetAnimator(
+            isPresenting: false,
+            isInteractive: false,
+            backdropView: backdropView
+        )
+    }
+
+    public func interactionControllerForPresentation(
+        using animator: UIViewControllerAnimatedTransitioning
+    ) -> UIViewControllerInteractiveTransitioning? {
+        interactiveTransitionCoordinator?.mode = .reply
+        return interactiveTransitionCoordinator
+    }
+}
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryDirectReplySheet.swift b/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryDirectReplySheet.swift
index 9680b5d8559..555f87b0ab0 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryDirectReplySheet.swift	
+++ b/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryDirectReplySheet.swift	
@@ -19,10 +19,13 @@ public class StoryDirectReplySheet: OWSViewController, StoryReplySheet {
     }()
     let storyMessage: StoryMessage
     lazy var thread: TSThread? = databaseStorage.read { storyMessage.context.thread(transaction: $0) }
+    weak var interactiveTransitionCoordinator: StoryInteractiveTransitionCoordinator?
 
     var reactionPickerBackdrop: UIView?
     var reactionPicker: MessageReactionPicker?
 
+    let backdropView: UIView? = UIView()
+
     @objc
     init(storyMessage: StoryMessage) {
         self.storyMessage = storyMessage
@@ -71,51 +74,33 @@ public class StoryDirectReplySheet: OWSViewController, StoryReplySheet {
     }
 }
 
-// MARK: -
-
-private class StoryDirectReplySheetPresentationController: UIPresentationController {
-    let backdropView = UIView()
-
-    override init(presentedViewController: UIViewController, presenting presentingViewController: UIViewController?) {
-        super.init(presentedViewController: presentedViewController, presenting: presentingViewController)
-
-        let alpha: CGFloat = Theme.isDarkThemeEnabled ? 0.7 : 0.6
-        backdropView.backgroundColor = UIColor.black.withAlphaComponent(alpha)
-    }
-
-    override func presentationTransitionWillBegin() {
-        guard let containerView = containerView else { return }
-
-        backdropView.alpha = 0
-        containerView.addSubview(backdropView)
-        backdropView.autoPinEdgesToSuperviewEdges()
-        containerView.layoutIfNeeded()
-
-        presentedViewController.transitionCoordinator?.animate(alongsideTransition: { _ in
-            self.backdropView.alpha = 1
-        }, completion: nil)
-    }
-
-    override func dismissalTransitionWillBegin() {
-        presentedViewController.transitionCoordinator?.animate(alongsideTransition: { _ in
-            self.backdropView.alpha = 0
-        }, completion: { _ in
-            self.backdropView.removeFromSuperview()
-        })
+extension StoryDirectReplySheet: UIViewControllerTransitioningDelegate {
+    public func animationController(
+        forPresented presented: UIViewController,
+        presenting: UIViewController,
+        source: UIViewController
+    ) -> UIViewControllerAnimatedTransitioning? {
+        return StoryReplySheetAnimator(
+            isPresenting: true,
+            isInteractive: interactiveTransitionCoordinator != nil,
+            backdropView: backdropView
+        )
     }
 
-    override func viewWillTransition(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator) {
-        super.viewWillTransition(to: size, with: coordinator)
-        guard let presentedView = presentedView else { return }
-        coordinator.animate(alongsideTransition: { _ in
-            presentedView.frame = self.frameOfPresentedViewInContainerView
-            presentedView.layoutIfNeeded()
-        }, completion: nil)
+    public func animationController(
+        forDismissed dismissed: UIViewController
+    ) -> UIViewControllerAnimatedTransitioning? {
+        return StoryReplySheetAnimator(
+            isPresenting: false,
+            isInteractive: false,
+            backdropView: backdropView
+        )
     }
-}
 
-extension StoryDirectReplySheet: UIViewControllerTransitioningDelegate {
-    public func presentationController(forPresented presented: UIViewController, presenting: UIViewController?, source: UIViewController) -> UIPresentationController? {
-        return StoryDirectReplySheetPresentationController(presentedViewController: presented, presenting: presenting)
+    public func interactionControllerForPresentation(
+        using animator: UIViewControllerAnimatedTransitioning
+    ) -> UIViewControllerInteractiveTransitioning? {
+        interactiveTransitionCoordinator?.mode = .reply
+        return interactiveTransitionCoordinator
     }
 }
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryReplySheet.swift b/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryReplySheet.swift
index 839b089e922..6970da573ba 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryReplySheet.swift	
+++ b/Signal/src/ViewControllers/HomeView/Stories/Reply Sheets/StoryReplySheet.swift	
@@ -10,6 +10,8 @@ protocol StoryReplySheet: OWSViewController, StoryReplyInputToolbarDelegate, Mes
     var inputToolbar: StoryReplyInputToolbar { get }
     var storyMessage: StoryMessage { get }
     var thread: TSThread? { get }
+    var interactiveTransitionCoordinator: StoryInteractiveTransitionCoordinator? { get set }
+    var backdropView: UIView? { get }
 
     var dismissHandler: (() -> Void)? { get set }
 
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryInteractiveTransitionCoordinator.swift b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryInteractiveTransitionCoordinator.swift
new file mode 100644
index 00000000000..983b6b6b721
--- /dev/null
+++ b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryInteractiveTransitionCoordinator.swift
@@ -0,0 +1,157 @@
+//
+//  Copyright (c) 2022 Open Whisper Systems. All rights reserved.
+//
+
+import Foundation
+
+class StoryInteractiveTransitionCoordinator: UIPercentDrivenInteractiveTransition, UIGestureRecognizerDelegate {
+    weak var pageViewController: StoryPageViewController!
+    lazy var panGestureRecognizer = UIPanGestureRecognizer(
+        target: self,
+        action: #selector(handlePan(_:))
+    )
+    init(pageViewController: StoryPageViewController) {
+        self.pageViewController = pageViewController
+        super.init()
+        pageViewController.view.addGestureRecognizer(panGestureRecognizer)
+        panGestureRecognizer.delegate = self
+
+        for subview in pageViewController.view.subviews {
+            guard let scrollView = subview as? UIScrollView else { continue }
+            scrollView.panGestureRecognizer.require(toFail: panGestureRecognizer)
+            break
+        }
+    }
+
+    var interactionInProgress: Bool { interactiveEdge != .none }
+
+    enum Edge {
+        case leading
+        case trailing
+        case top
+        case bottom
+        case none
+    }
+    var interactiveEdge: Edge = .none
+
+    enum Mode {
+        case zoom
+        case slide
+        case reply
+    }
+    var mode: Mode = .zoom
+
+    @objc
+    func handlePan(_ gestureRecognizer: UIPanGestureRecognizer) {
+        switch gestureRecognizer.state {
+        case .began:
+            gestureRecognizer.setTranslation(.zero, in: pageViewController.view)
+
+            pageViewController.currentContextViewController.pause()
+
+            switch interactiveEdge {
+            case .none:
+                owsFailDebug("began gesture from unexpected state")
+            case .leading, .top, .bottom:
+                pageViewController.dismiss(animated: true)
+            case .trailing:
+                pageViewController.currentContextViewController.presentReplySheet(interactiveTransitionCoordinator: self)
+            }
+        case .changed:
+            update(calculateProgress(gestureRecognizer))
+        case .cancelled:
+            pageViewController.currentContextViewController.play()
+            cancel()
+            interactiveEdge = .none
+        case .ended:
+            let progress = calculateProgress(gestureRecognizer)
+
+            if progress >= 0.5 || hasExceededVelocityThreshold(gestureRecognizer) {
+                finish()
+            } else {
+                pageViewController.currentContextViewController.play()
+                cancel()
+            }
+
+            interactiveEdge = .none
+        default:
+            cancel()
+            interactiveEdge = .none
+        }
+    }
+
+    func calculateProgress(_ gestureRecognizer: UIPanGestureRecognizer) -> CGFloat {
+        let offset = gestureRecognizer.translation(in: pageViewController.view)
+        let totalDistance: CGFloat
+
+        switch mode {
+        case .zoom, .reply: totalDistance = 150
+        case .slide:
+            switch interactiveEdge {
+            case .top, .bottom: totalDistance = pageViewController.view.height
+            case .leading, .trailing, .none: totalDistance = pageViewController.view.width
+            }
+        }
+
+        switch interactiveEdge {
+        case .top:
+            return offset.y / totalDistance
+        case .leading:
+            return ((CurrentAppContext().isRTL ? -1 : 1) * offset.x) / totalDistance
+        case .trailing:
+            return ((CurrentAppContext().isRTL ? 1 : -1) * offset.x) / totalDistance
+        case .bottom:
+            return -offset.y / totalDistance
+        case .none:
+            return 0
+        }
+    }
+
+    func hasExceededVelocityThreshold(_ gestureRecognizer: UIPanGestureRecognizer) -> Bool {
+        let velocity = gestureRecognizer.velocity(in: pageViewController.view)
+        let velocityThreshold: CGFloat = 500
+
+        switch interactiveEdge {
+        case .top:
+            return velocity.y > velocityThreshold
+        case .leading:
+            return ((CurrentAppContext().isRTL ? -1 : 1) * velocity.x) > velocityThreshold
+        case .trailing:
+            return -((CurrentAppContext().isRTL ? 1 : -1) * velocity.x) > velocityThreshold
+        case .bottom:
+            return -velocity.y > velocityThreshold
+        case .none:
+            return false
+        }
+    }
+
+    func gestureRecognizerShouldBegin(_ gestureRecognizer: UIGestureRecognizer) -> Bool {
+        guard gestureRecognizer == panGestureRecognizer else { return false }
+        let translation = panGestureRecognizer.translation(in: pageViewController.view)
+        let normalizedTranslationX = (CurrentAppContext().isRTL ? -1 : 1) * translation.x
+
+        if normalizedTranslationX > 0 {
+            interactiveEdge = .leading
+            return true
+        } else if normalizedTranslationX < 0, pageViewController.currentContextViewController.allowsReplies {
+            interactiveEdge = .trailing
+            return true
+        } else if pageViewController.previousStoryContext == nil, translation.y > 0 {
+            interactiveEdge = .top
+            return true
+        } else if pageViewController.nextStoryContext == nil, translation.y < 0 {
+            interactiveEdge = .bottom
+            return true
+        } else {
+            interactiveEdge = .none
+            return false
+        }
+    }
+
+    func gestureRecognizer(
+        _ gestureRecognizer: UIGestureRecognizer,
+        shouldRecognizeSimultaneouslyWith otherGestureRecognizer: UIGestureRecognizer
+    ) -> Bool {
+        gestureRecognizer == panGestureRecognizer
+    }
+}
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryReplySheetAnimator.swift b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryReplySheetAnimator.swift
new file mode 100644
index 00000000000..f9249728279
--- /dev/null
+++ b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryReplySheetAnimator.swift
@@ -0,0 +1,77 @@
+//
+//  Copyright (c) 2022 Open Whisper Systems. All rights reserved.
+//
+
+import Foundation
+
+class StoryReplySheetAnimator: NSObject, UIViewControllerAnimatedTransitioning {
+    let isPresenting: Bool
+    let isInteractive: Bool
+    let backdropView: UIView?
+
+    init(isPresenting: Bool, isInteractive: Bool, backdropView: UIView?) {
+        self.isPresenting = isPresenting
+        self.isInteractive = isInteractive
+        self.backdropView = backdropView
+    }
+
+    func transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -> TimeInterval {
+        0.25
+    }
+
+    func animateTransition(using transitionContext: UIViewControllerContextTransitioning) {
+        let containerView = transitionContext.containerView
+
+        guard let toVC = transitionContext.viewController(forKey: .to),
+                let fromVC = transitionContext.viewController(forKey: .from) else {
+            transitionContext.completeTransition(false)
+            return
+        }
+
+        let startFrame: CGRect
+        let endFrame: CGRect
+        let animatingView: UIView
+
+        if let backdropView = backdropView {
+            backdropView.frame = transitionContext.initialFrame(for: fromVC)
+            backdropView.backgroundColor = Theme.backdropColor
+            containerView.addSubview(backdropView)
+        }
+
+        if isPresenting {
+            containerView.addSubview(toVC.view)
+
+            backdropView?.alpha = 0
+
+            endFrame = transitionContext.finalFrame(for: toVC)
+            startFrame = endFrame.offsetBy(dx: 0, dy: endFrame.height)
+            animatingView = toVC.view
+        } else {
+            containerView.addSubview(fromVC.view)
+
+            backdropView?.alpha = 1
+
+            startFrame = transitionContext.initialFrame(for: fromVC)
+            endFrame = startFrame.offsetBy(dx: 0, dy: startFrame.height)
+            animatingView = fromVC.view
+        }
+
+        animatingView.frame = startFrame
+
+        UIView.animate(
+            withDuration: transitionDuration(using: transitionContext),
+            delay: 0,
+            options: isInteractive ? .curveLinear : .curveEaseInOut
+        ) {
+            self.backdropView?.alpha = self.isPresenting ? 1 : 0
+            animatingView.frame = endFrame
+        } completion: { _ in
+            if transitionContext.transitionWasCancelled || !self.isPresenting {
+                animatingView.removeFromSuperview()
+                self.backdropView?.removeFromSuperview()
+            }
+
+            transitionContext.completeTransition(!transitionContext.transitionWasCancelled)
+        }
+    }
+}
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Transitions/StorySlideAnimator.swift b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StorySlideAnimator.swift
new file mode 100644
index 00000000000..eb90e43c838
--- /dev/null
+++ b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StorySlideAnimator.swift
@@ -0,0 +1,60 @@
+//
+//  Copyright (c) 2022 Open Whisper Systems. All rights reserved.
+//
+
+import Foundation
+
+class StorySlideAnimator: NSObject, UIViewControllerAnimatedTransitioning {
+    let interactiveEdge: StoryInteractiveTransitionCoordinator.Edge
+    init(interactiveEdge: StoryInteractiveTransitionCoordinator.Edge) {
+        self.interactiveEdge = interactiveEdge
+    }
+
+    func transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -> TimeInterval {
+        0.2
+    }
+
+    func animateTransition(using transitionContext: UIViewControllerContextTransitioning) {
+        let containerView = transitionContext.containerView
+
+        guard let fromVC = transitionContext.viewController(forKey: .from),
+              let toVC = transitionContext.viewController(forKey: .to) else {
+            owsFailDebug("Missing vcs")
+            transitionContext.completeTransition(false)
+            return
+        }
+
+        containerView.addSubview(toVC.view)
+
+        containerView.addSubview(fromVC.view)
+        fromVC.view.frame = transitionContext.initialFrame(for: fromVC)
+
+        let endFrame: CGRect
+        switch interactiveEdge {
+        case .leading:
+            endFrame = fromVC.view.frame.offsetBy(dx: (CurrentAppContext().isRTL ? -1 : 1) * fromVC.view.width, dy: 0)
+        case .trailing:
+            endFrame = fromVC.view.frame.offsetBy(dx: (CurrentAppContext().isRTL ? 1 : -1) * fromVC.view.width, dy: 0)
+        case .top, .none:
+            endFrame = fromVC.view.frame.offsetBy(dx: 0, dy: fromVC.view.height)
+        case .bottom:
+            endFrame = fromVC.view.frame.offsetBy(dx: 0, dy: -fromVC.view.height)
+        }
+
+        UIView.animate(
+            withDuration: transitionDuration(using: transitionContext),
+            delay: 0,
+            options: interactiveEdge != .none ? .curveLinear : .curveEaseInOut
+        ) {
+            fromVC.view.frame = endFrame
+        } completion: { _ in
+            if transitionContext.transitionWasCancelled {
+                toVC.view.removeFromSuperview()
+            } else {
+                fromVC.view.removeFromSuperview()
+            }
+
+            transitionContext.completeTransition(!transitionContext.transitionWasCancelled)
+        }
+    }
+}
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryZoomAnimator.swift b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryZoomAnimator.swift
new file mode 100644
index 00000000000..e79bb72d68d
--- /dev/null
+++ b/Signal/src/ViewControllers/HomeView/Stories/Transitions/StoryZoomAnimator.swift
@@ -0,0 +1,166 @@
+//
+//  Copyright (c) 2022 Open Whisper Systems. All rights reserved.
+//
+
+import Foundation
+
+struct StoryTransitionContext {
+    let isPresenting: Bool
+    let thumbnailView: UIView
+    let storyView: UIView
+    let thumbnailRepresentsStoryView: Bool
+    weak var pageViewController: StoryPageViewController!
+}
+
+class StoryZoomAnimator: NSObject, UIViewControllerAnimatedTransitioning {
+    private let context: StoryTransitionContext
+    private let backgroundView = UIView()
+
+    init(storyTransitionContext: StoryTransitionContext) {
+        self.context = storyTransitionContext
+        super.init()
+    }
+
+    func transitionDuration(using transitionContext: UIViewControllerContextTransitioning?) -> TimeInterval { totalDuration }
+    var totalDuration: TimeInterval { presentationDelay + presentationDuration + crossFadeDuration }
+    var crossFadeDuration: TimeInterval { 0.1 }
+    var presentationDelay: TimeInterval {
+        if context.isPresenting {
+            return context.thumbnailRepresentsStoryView ? 0 : crossFadeDuration
+        } else {
+            return crossFadeDuration
+        }
+    }
+    var presentationDuration: TimeInterval { 0.2 }
+
+    func animateTransition(using transitionContext: UIViewControllerContextTransitioning) {
+        let containerView = transitionContext.containerView
+
+        guard let toVC = transitionContext.viewController(forKey: .to) else {
+            owsFailDebug("Missing toVC")
+            transitionContext.completeTransition(false)
+            return
+        }
+
+        let dismissedFrame = containerView.convert(
+            context.thumbnailView.frame,
+            from: context.thumbnailView.superview
+        )
+        var presentedFrame = transitionContext.finalFrame(for: toVC)
+
+        let heightScalar = UIDevice.current.isIPad
+            ? UIDevice.current.orientation.isLandscape ? 0.75 : 0.65
+            : 1
+
+        let maxHeight = presentedFrame.height * heightScalar
+        presentedFrame.size.height = min(maxHeight, presentedFrame.width * (16 / 9))
+        presentedFrame.size.width = presentedFrame.height * (9 / 16)
+
+        if UIDevice.current.isIPad {
+            // Center in view
+            presentedFrame.origin = CGPoint(
+                x: containerView.safeAreaLayoutGuide.layoutFrame.midX - (presentedFrame.width / 2),
+                y: containerView.safeAreaLayoutGuide.layoutFrame.midY - (presentedFrame.height / 2)
+            )
+        } else {
+            // Pin to top of view
+            presentedFrame.origin.y = containerView.safeAreaInsets.top
+        }
+
+        backgroundView.backgroundColor = .ows_black
+        backgroundView.frame = transitionContext.finalFrame(for: toVC)
+
+        toVC.view.frame = transitionContext.finalFrame(for: toVC)
+
+        if context.isPresenting {
+            containerView.addSubview(backgroundView)
+            containerView.addSubview(context.storyView)
+            containerView.addSubview(toVC.view)
+
+            context.storyView.frame = dismissedFrame
+            context.storyView.layoutIfNeeded()
+
+            backgroundView.alpha = 0
+            toVC.view.alpha = 0
+
+            context.storyView.layer.cornerRadius = 12
+            context.storyView.alpha = 0
+
+            UIView.animateKeyframes(withDuration: totalDuration, delay: 0) {
+                self.animateThumbnailFade()
+                self.animatePresentation(delay: self.presentationDelay, endFrame: presentedFrame)
+                self.animateChromeFade(delay: self.presentationDelay + self.presentationDuration)
+            } completion: { _ in
+                self.context.storyView.removeFromSuperview()
+                self.context.thumbnailView.alpha = 1
+                self.backgroundView.removeFromSuperview()
+                transitionContext.completeTransition(true)
+            }
+        } else {
+            containerView.addSubview(toVC.view)
+            containerView.addSubview(backgroundView)
+            containerView.addSubview(context.storyView)
+            containerView.addSubview(context.pageViewController.view)
+
+            context.storyView.layer.cornerRadius = UIDevice.current.hasIPhoneXNotch || UIDevice.current.isIPad ? 18 : 0
+            context.storyView.frame = presentedFrame
+            if let storyView = context.storyView as? TextAttachmentThumbnailView {
+                storyView.renderSize = presentedFrame.size
+            }
+            context.storyView.layoutIfNeeded()
+
+            context.thumbnailView.alpha = 0
+
+            UIView.animateKeyframes(withDuration: totalDuration, delay: 0) {
+                self.animateChromeFade()
+                self.animatePresentation(delay: self.presentationDelay, endFrame: dismissedFrame)
+                self.animateThumbnailFade(delay: self.presentationDuration + self.crossFadeDuration)
+            } completion: { _ in
+                self.context.storyView.removeFromSuperview()
+                self.backgroundView.removeFromSuperview()
+
+                if transitionContext.transitionWasCancelled {
+                    toVC.view.removeFromSuperview()
+                    self.context.pageViewController.view.alpha = 1
+                    self.context.thumbnailView.alpha = 1
+                } else {
+                    self.context.pageViewController.view.removeFromSuperview()
+                }
+
+                transitionContext.completeTransition(!transitionContext.transitionWasCancelled)
+            }
+        }
+    }
+
+    /// Cross-fade the thumbnail on the stories list if it doesn't match the presented story
+    private func animateThumbnailFade(delay: TimeInterval = 0) {
+        let duration = context.thumbnailRepresentsStoryView ? 0 : crossFadeDuration
+        UIView.addKeyframe(withRelativeStartTime: delay / totalDuration, relativeDuration: duration / totalDuration) {
+            self.context.storyView.alpha = self.context.isPresenting ? 1 : 0
+            self.context.thumbnailView.alpha = self.context.isPresenting ? 0 : 1
+        }
+    }
+
+    /// Move the story to its final location
+    private func animatePresentation(delay: TimeInterval = 0, endFrame: CGRect) {
+        UIView.addKeyframe(withRelativeStartTime: delay / totalDuration, relativeDuration: presentationDuration / totalDuration) {
+            if let storyView = self.context.storyView as? TextAttachmentThumbnailView {
+                storyView.renderSize = self.context.isPresenting
+                    ? endFrame.size : TextAttachmentThumbnailView.defaultRenderSize
+            }
+            self.context.storyView.layer.cornerRadius = self.context.isPresenting
+                ? UIDevice.current.hasIPhoneXNotch || UIDevice.current.isIPad ? 18 : 0
+                : 12
+            self.context.storyView.frame = endFrame
+            self.context.storyView.layoutIfNeeded()
+            self.backgroundView.alpha = self.context.isPresenting ? 1 : 0
+        }
+    }
+
+    /// Fade the UI chrome
+    private func animateChromeFade(delay: TimeInterval = 0) {
+        UIView.addKeyframe(withRelativeStartTime: delay / totalDuration, relativeDuration: crossFadeDuration / totalDuration) {
+            self.context.pageViewController.view.alpha = self.context.isPresenting ? 1 : 0
+        }
+    }
+}
