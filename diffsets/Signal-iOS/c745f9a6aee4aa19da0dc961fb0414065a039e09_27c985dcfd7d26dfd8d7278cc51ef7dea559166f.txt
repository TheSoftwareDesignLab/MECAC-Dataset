diff --git a/Signal/src/Calls/UserInterface/Individual/IndividualCallViewController.swift b/Signal/src/Calls/UserInterface/Individual/IndividualCallViewController.swift
index 74aaef6201e..3b63e7abb32 100644
--- a/Signal/src/Calls/UserInterface/Individual/IndividualCallViewController.swift
+++ b/Signal/src/Calls/UserInterface/Individual/IndividualCallViewController.swift
@@ -218,8 +218,6 @@ class IndividualCallViewController: OWSViewController, CallObserver, CallAudioSe
 
         allAudioSources = Set(callService.audioService.availableInputs)
 
-        self.shouldUseTheme = false
-
         NotificationCenter.default.addObserver(self,
                                                selector: #selector(updateOrientationForPhone),
                                                name: CallService.phoneOrientationDidChange,
diff --git a/Signal/src/ViewControllers/AppSettings/ContactSupportViewController.swift b/Signal/src/ViewControllers/AppSettings/ContactSupportViewController.swift
index 62871b08ef7..5fd91d73cf2 100644
--- a/Signal/src/ViewControllers/AppSettings/ContactSupportViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/ContactSupportViewController.swift
@@ -168,9 +168,12 @@ final class ContactSupportViewController: OWSTableViewController2 {
         navigationItem.rightBarButtonItem?.isEnabled = ((descriptionField.text?.count ?? 0) > 10) && selectedFilter != nil
     }
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
+        applyTheme()
+    }
 
+    private func applyTheme() {
         navigationItem.rightBarButtonItem?.tintColor = Theme.accentBlueColor
 
         // Rebuild the contents to force them to update their theme
diff --git a/Signal/src/ViewControllers/AppSettings/CurrencyPickerViewController.swift b/Signal/src/ViewControllers/AppSettings/CurrencyPickerViewController.swift
index 4fa82f05b95..0afb685404f 100644
--- a/Signal/src/ViewControllers/AppSettings/CurrencyPickerViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/CurrencyPickerViewController.swift
@@ -49,8 +49,8 @@ class CurrencyPickerViewController<DataSourceType: CurrencyPickerDataSource>: OW
         updateTableContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDeactivateViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDeactivateViewController.swift
index e50c08a88d8..96cc5dec8a6 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDeactivateViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDeactivateViewController.swift
@@ -45,8 +45,8 @@ public class PaymentsDeactivateViewController: OWSViewController {
         updateContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDetailViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDetailViewController.swift
index dabf9be69f6..975354b6540 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDetailViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsDetailViewController.swift
@@ -59,8 +59,8 @@ class PaymentsDetailViewController: OWSTableViewController2 {
         }
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsHistoryViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsHistoryViewController.swift
index 8de2477b421..37d342eb0d9 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsHistoryViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsHistoryViewController.swift
@@ -46,8 +46,8 @@ class PaymentsHistoryViewController: OWSTableViewController2 {
         )
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletCompleteViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletCompleteViewController.swift
index 5020d522cb8..e61f2755f12 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletCompleteViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletCompleteViewController.swift
@@ -45,8 +45,8 @@ public class PaymentsRestoreWalletCompleteViewController: OWSTableViewController
         updateTableContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletPasteboardViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletPasteboardViewController.swift
index 00b7aa4ea55..f5ddbf29a59 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletPasteboardViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletPasteboardViewController.swift
@@ -50,8 +50,8 @@ public class PaymentsRestoreWalletPasteboardViewController: OWSViewController {
         textField.becomeFirstResponder()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletSplashViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletSplashViewController.swift
index 5cac0d435e5..e3c3c3f2da2 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletSplashViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletSplashViewController.swift
@@ -37,8 +37,8 @@ public class PaymentsRestoreWalletSplashViewController: OWSViewController {
         createContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletWordViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletWordViewController.swift
index 48fa294f078..801e5db70f5 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletWordViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsRestoreWalletWordViewController.swift
@@ -73,8 +73,8 @@ public class PaymentsRestoreWalletWordViewController: OWSViewController {
         textfield.becomeFirstResponder()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
@@ -86,7 +86,7 @@ public class PaymentsRestoreWalletWordViewController: OWSViewController {
         rootView.alignment = .fill
         view.addSubview(rootView)
         rootView.autoPin(toTopLayoutGuideOf: self, withInset: 0)
-        autoPinView(toBottomOfViewControllerOrKeyboard: rootView, avoidNotch: true)
+        rootView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
         rootView.autoPinWidthToSuperviewMargins()
 
         updateContents()
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsSettingsViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsSettingsViewController.swift
index 0982bd3c5ce..7993c983328 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsSettingsViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsSettingsViewController.swift
@@ -252,8 +252,8 @@ public class PaymentsSettingsViewController: OWSTableViewController2 {
         stopUpdateBalanceTimer()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferInViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferInViewController.swift
index b44a115951e..52a09f6507e 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferInViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferInViewController.swift
@@ -40,8 +40,8 @@ class PaymentsTransferInViewController: OWSTableViewController2 {
         paymentsSwift.updateCurrentPaymentBalance()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferOutViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferOutViewController.swift
index 07c1045da28..721ceea8b54 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferOutViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsTransferOutViewController.swift
@@ -85,8 +85,8 @@ public class PaymentsTransferOutViewController: OWSTableViewController2 {
         addressTextfield.addTarget(self, action: #selector(addressDidChange), for: .editingChanged)
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseConfirmViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseConfirmViewController.swift
index eb44d77d795..06b10d9bba8 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseConfirmViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseConfirmViewController.swift
@@ -109,8 +109,8 @@ public class PaymentsViewPassphraseConfirmViewController: OWSTableViewController
         updateFirstResponder()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         wordTextfield0.textColor = Theme.primaryTextColor
         wordTextfield1.textColor = Theme.primaryTextColor
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseGridViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseGridViewController.swift
index f36f8f432d6..7678d5d9eb4 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseGridViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseGridViewController.swift
@@ -45,8 +45,8 @@ public class PaymentsViewPassphraseGridViewController: OWSTableViewController2 {
         updateTableContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseSplashViewController.swift b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseSplashViewController.swift
index 8a8cfa74e5b..e8054c3df7e 100644
--- a/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseSplashViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Payments/PaymentsViewPassphraseSplashViewController.swift
@@ -52,8 +52,8 @@ public class PaymentsViewPassphraseSplashViewController: OWSViewController {
         updateNavbar()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
diff --git a/Signal/src/ViewControllers/AppSettings/Privacy/ProxySettingsViewController.swift b/Signal/src/ViewControllers/AppSettings/Privacy/ProxySettingsViewController.swift
index 82f98ecd0df..0527fbf3762 100644
--- a/Signal/src/ViewControllers/AppSettings/Privacy/ProxySettingsViewController.swift
+++ b/Signal/src/ViewControllers/AppSettings/Privacy/ProxySettingsViewController.swift
@@ -66,8 +66,8 @@ class ProxySettingsViewController: OWSTableViewController2, OWSNavigationView {
         return textField
     }()
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/Context Menus/ContextMenuController.swift b/Signal/src/ViewControllers/Context Menus/ContextMenuController.swift
index 7a8d558bea6..55c00d72fce 100644
--- a/Signal/src/ViewControllers/Context Menus/ContextMenuController.swift	
+++ b/Signal/src/ViewControllers/Context Menus/ContextMenuController.swift	
@@ -466,8 +466,8 @@ class ContextMenuController: OWSViewController, ContextMenuViewDelegate, UIGestu
         // We can't use `viewWillTransition(to:with:)` here because we're added directly to the window
     }
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
         delegate?.contextMenuControllerRequestsDismissal(self)
 
         // TODO: Support theme changes
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationViewController.swift b/Signal/src/ViewControllers/ConversationView/ConversationViewController.swift
index 5fd247918bc..d5ce6fb5430 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationViewController.swift
+++ b/Signal/src/ViewControllers/ConversationView/ConversationViewController.swift
@@ -486,6 +486,7 @@ public class ConversationViewController: OWSViewController {
     public override func themeDidChange() {
         super.themeDidChange()
 
+        applyTheme()
         self.updateThemeIfNecessary()
     }
 
@@ -502,11 +503,7 @@ public class ConversationViewController: OWSViewController {
         self.applyTheme()
     }
 
-    public override func applyTheme() {
-        AssertIsOnMainThread()
-
-        super.applyTheme()
-
+    private func applyTheme() {
         guard hasViewWillAppearEverBegun else {
             owsFailDebug("Not yet ready.")
             return
diff --git a/Signal/src/ViewControllers/ConversationView/Emoji Picker/EmojiPickerSheet.swift b/Signal/src/ViewControllers/ConversationView/Emoji Picker/EmojiPickerSheet.swift
index e0b11a403dd..172df4dc67a 100644
--- a/Signal/src/ViewControllers/ConversationView/Emoji Picker/EmojiPickerSheet.swift	
+++ b/Signal/src/ViewControllers/ConversationView/Emoji Picker/EmojiPickerSheet.swift	
@@ -90,10 +90,13 @@ class EmojiPickerSheet: InteractiveSheetViewController {
         collectionView.pickerDelegate = self
         collectionView.alwaysBounceVertical = true
 
-        contentView.addSubview(sectionToolbar)
-        sectionToolbar.autoPinWidthToSuperview()
-        let offset: CGFloat = UIDevice.current.hasIPhoneXNotch ? 32 : 0
-        autoPinView(toBottomOfViewControllerOrKeyboard: sectionToolbar, avoidNotch: false, adjustmentWithKeyboardPresented: offset)
+        // NOTE: the toolbar is a subview of the keyboard layout view so it
+        // properly animates as the keyboard rises. making it part of the content view
+        // cancels those animations and makes it pop into place which looks bad.
+        // might be worth ripping apart at some point.
+        keyboardLayoutGuideView.addSubview(sectionToolbar)
+        sectionToolbar.autoPinWidth(toWidthOf: contentView)
+        sectionToolbar.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideView)
     }
 
     override func viewWillTransition(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator) {
diff --git a/Signal/src/ViewControllers/ForwardMessageViewController.swift b/Signal/src/ViewControllers/ForwardMessageViewController.swift
index 13fef39f112..af914d2cb1f 100644
--- a/Signal/src/ViewControllers/ForwardMessageViewController.swift
+++ b/Signal/src/ViewControllers/ForwardMessageViewController.swift
@@ -153,7 +153,6 @@ class ForwardMessageViewController: InteractiveSheetViewController {
     override func viewWillAppear(_ animated: Bool) {
         super.viewWillAppear(animated)
 
-        applyTheme()
         ensureBottomFooterVisibility()
     }
 
@@ -171,8 +170,6 @@ class ForwardMessageViewController: InteractiveSheetViewController {
         let navView = forwardNavigationViewController.view!
         self.contentView.addSubview(navView)
         navView.autoPinEdgesToSuperviewEdges()
-
-        applyTheme()
     }
 
     fileprivate func selectSearchBar() {
diff --git a/Signal/src/ViewControllers/GifPicker/GifPickerViewController.swift b/Signal/src/ViewControllers/GifPicker/GifPickerViewController.swift
index a1fa1c687c7..f068797266a 100644
--- a/Signal/src/ViewControllers/GifPicker/GifPickerViewController.swift
+++ b/Signal/src/ViewControllers/GifPicker/GifPickerViewController.swift
@@ -316,7 +316,7 @@ class GifPickerViewController: OWSViewController, UISearchBarDelegate, UICollect
 
         bottomBanner.autoPinEdge(toSuperviewEdge: .top)
         bottomBanner.autoPinWidthToSuperview()
-        self.autoPinView(toBottomOfViewControllerOrKeyboard: bottomBanner, avoidNotch: true)
+        bottomBanner.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         // The Giphy API requires us to "show their trademark prominently" in our GIF experience.
         let logoImage = UIImage(named: "giphy_logo")
diff --git a/Signal/src/ViewControllers/HomeView/ConversationSplitViewController.swift b/Signal/src/ViewControllers/HomeView/ConversationSplitViewController.swift
index 6a225381d3e..bc0aa628ab8 100644
--- a/Signal/src/ViewControllers/HomeView/ConversationSplitViewController.swift
+++ b/Signal/src/ViewControllers/HomeView/ConversationSplitViewController.swift
@@ -640,13 +640,16 @@ private class NoSelectedConversationViewController: OWSViewController {
     override func viewDidLoad() {
         super.viewDidLoad()
 
-        NotificationCenter.default.addObserver(self, selector: #selector(self.applyTheme), name: .ThemeDidChange, object: nil)
-
         applyTheme()
     }
 
     @objc
-    override func applyTheme() {
+    override func themeDidChange() {
+        super.themeDidChange()
+        applyTheme()
+    }
+
+    private func applyTheme() {
         view.backgroundColor = Theme.backgroundColor
         logoImageView.tintColor = Theme.isDarkThemeEnabled ? UIColor.white.withAlphaComponent(0.12) : UIColor.black.withAlphaComponent(0.12)
     }
diff --git a/Signal/src/ViewControllers/HomeView/Stories/MyStoriesViewController.swift b/Signal/src/ViewControllers/HomeView/Stories/MyStoriesViewController.swift
index 519ce5ddc5f..54c5dba411b 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/MyStoriesViewController.swift
+++ b/Signal/src/ViewControllers/HomeView/Stories/MyStoriesViewController.swift
@@ -64,9 +64,12 @@ class MyStoriesViewController: OWSViewController {
         applyTheme()
     }
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
+        applyTheme()
+    }
 
+    private func applyTheme() {
         emptyStateLabel.textColor = Theme.secondaryTextAndIconColor
 
         tableView.reloadData()
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Replies & Views Sheets/StoryDirectReplySheet.swift b/Signal/src/ViewControllers/HomeView/Stories/Replies & Views Sheets/StoryDirectReplySheet.swift
index c5ff2014210..1c4fc309aa8 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Replies & Views Sheets/StoryDirectReplySheet.swift	
+++ b/Signal/src/ViewControllers/HomeView/Stories/Replies & Views Sheets/StoryDirectReplySheet.swift	
@@ -53,7 +53,7 @@ public class StoryDirectReplySheet: OWSViewController, StoryReplySheet {
         view.addSubview(inputToolbar)
         inputToolbar.autoPinWidthToSuperview()
         inputToolbar.autoPin(toTopLayoutGuideOf: self, withInset: 0, relation: .greaterThanOrEqual)
-        autoPinView(toBottomOfViewControllerOrKeyboard: inputToolbar, avoidNotch: true)
+        inputToolbar.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
     }
 
     @objc
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Settings/GroupStorySettingsViewController.swift b/Signal/src/ViewControllers/HomeView/Stories/Settings/GroupStorySettingsViewController.swift
index 9642b8a98d4..1401b6ab76c 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Settings/GroupStorySettingsViewController.swift
+++ b/Signal/src/ViewControllers/HomeView/Stories/Settings/GroupStorySettingsViewController.swift
@@ -24,8 +24,8 @@ class GroupStorySettingsViewController: OWSTableViewController2 {
         updateTableContents()
     }
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
 
         contextButton.tintColor = Theme.primaryIconColor
     }
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Settings/PrivateStoryNameSettingsViewController.swift b/Signal/src/ViewControllers/HomeView/Stories/Settings/PrivateStoryNameSettingsViewController.swift
index 2a5deb4f5a9..87ce560dc2f 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Settings/PrivateStoryNameSettingsViewController.swift
+++ b/Signal/src/ViewControllers/HomeView/Stories/Settings/PrivateStoryNameSettingsViewController.swift
@@ -60,8 +60,8 @@ public class PrivateStoryNameSettingsViewController: OWSTableViewController2 {
         return textField
     }()
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         nameTextField.textColor = Theme.primaryTextColor
     }
diff --git a/Signal/src/ViewControllers/HomeView/Stories/Settings/StoryPrivacySettingsViewController.swift b/Signal/src/ViewControllers/HomeView/Stories/Settings/StoryPrivacySettingsViewController.swift
index 987affa4822..e86358ecb28 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/Settings/StoryPrivacySettingsViewController.swift
+++ b/Signal/src/ViewControllers/HomeView/Stories/Settings/StoryPrivacySettingsViewController.swift
@@ -145,8 +145,8 @@ class StoryPrivacySettingsViewController: OWSTableViewController2 {
             }))
     }
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
         updateTableContents()
     }
 
diff --git a/Signal/src/ViewControllers/HomeView/Stories/StoriesViewController.swift b/Signal/src/ViewControllers/HomeView/Stories/StoriesViewController.swift
index f43f94ebb51..46e3325f211 100644
--- a/Signal/src/ViewControllers/HomeView/Stories/StoriesViewController.swift
+++ b/Signal/src/ViewControllers/HomeView/Stories/StoriesViewController.swift
@@ -65,7 +65,7 @@ class StoriesViewController: OWSViewController, StoryListDataSourceDelegate {
 
         view.addSubview(tableView)
         tableView.autoPinEdgesToSuperviewEdges(with: .zero, excludingEdge: .bottom)
-        autoPinView(toBottomOfViewControllerOrKeyboard: tableView, avoidNotch: true)
+        tableView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
         tableView.delegate = self
         tableView.dataSource = self
 
@@ -195,9 +195,12 @@ class StoriesViewController: OWSViewController, StoryListDataSourceDelegate {
         }
     }
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
+        applyTheme()
+    }
 
+    private func applyTheme() {
         emptyStateLabel.textColor = Theme.secondaryTextAndIconColor
 
         for indexPath in self.tableView.indexPathsForVisibleRows ?? [] {
diff --git a/Signal/src/ViewControllers/OWSPinConfirmationViewController.swift b/Signal/src/ViewControllers/OWSPinConfirmationViewController.swift
index ee87e3684e6..8f585bcbf7b 100644
--- a/Signal/src/ViewControllers/OWSPinConfirmationViewController.swift
+++ b/Signal/src/ViewControllers/OWSPinConfirmationViewController.swift
@@ -87,7 +87,7 @@ public class PinConfirmationViewController: OWSViewController {
 
         view.addSubview(containerView)
         containerView.autoPinWidthToSuperview()
-        autoPinView(toBottomOfViewControllerOrKeyboard: containerView, avoidNotch: true)
+        containerView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         // We want the background to extend to the bottom of the screen
         // behind the safe area, so we add that inset to our bottom inset
diff --git a/Signal/src/ViewControllers/OWSPinReminderViewController.swift b/Signal/src/ViewControllers/OWSPinReminderViewController.swift
index 04f7550c9c9..47e138ecc75 100644
--- a/Signal/src/ViewControllers/OWSPinReminderViewController.swift
+++ b/Signal/src/ViewControllers/OWSPinReminderViewController.swift
@@ -81,7 +81,7 @@ public class PinReminderViewController: OWSViewController {
         view.addSubview(containerView)
         containerView.autoPinWidthToSuperview()
         containerView.autoPin(toTopLayoutGuideOf: self, withInset: 0, relation: .greaterThanOrEqual)
-        autoPinView(toBottomOfViewControllerOrKeyboard: containerView, avoidNotch: true)
+        containerView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         // We want the background to extend to the bottom of the screen
         // behind the safe area, so we add that inset to our bottom inset
diff --git a/Signal/src/ViewControllers/OWSPinSetupViewController.swift b/Signal/src/ViewControllers/OWSPinSetupViewController.swift
index 5edfbfd7da9..77fa2e014a3 100644
--- a/Signal/src/ViewControllers/OWSPinSetupViewController.swift
+++ b/Signal/src/ViewControllers/OWSPinSetupViewController.swift
@@ -223,6 +223,8 @@ public class PinSetupViewController: OWSViewController {
         if case .confirming = self.initialMode {
             owsFailDebug("pin setup flow should never start in the confirming state")
         }
+
+        super.keyboardObservationBehavior = .whileLifecycleVisible
     }
 
     @objc
@@ -247,7 +249,6 @@ public class PinSetupViewController: OWSViewController {
 
     override public func viewWillAppear(_ animated: Bool) {
         super.viewWillAppear(animated)
-        shouldIgnoreKeyboardChanges = false
 
         if let navigationBar = navigationController?.navigationBar as? OWSNavigationBar {
             navigationBar.navbarBackgroundColorOverride = backgroundColor
@@ -289,7 +290,6 @@ public class PinSetupViewController: OWSViewController {
 
     override public func viewWillDisappear(_ animated: Bool) {
         super.viewWillDisappear(animated)
-        shouldIgnoreKeyboardChanges = true
 
         if let navigationBar = navigationController?.navigationBar as? OWSNavigationBar {
             navigationBar.switchToStyle(.default, animated: true)
@@ -341,7 +341,7 @@ public class PinSetupViewController: OWSViewController {
         view.addSubview(stackView)
 
         stackView.autoPinEdges(toSuperviewMarginsExcludingEdge: .bottom)
-        autoPinView(toBottomOfViewControllerOrKeyboard: stackView, avoidNotch: true)
+        stackView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         [pinTextField, validationWarningLabel, recommendationLabel].forEach {
             $0.autoSetDimension(.width, toSize: 227)
diff --git a/Signal/src/ViewControllers/Payments/SendPaymentCompletionActionSheet.swift b/Signal/src/ViewControllers/Payments/SendPaymentCompletionActionSheet.swift
index 06e0c8d0b91..69184a2e201 100644
--- a/Signal/src/ViewControllers/Payments/SendPaymentCompletionActionSheet.swift
+++ b/Signal/src/ViewControllers/Payments/SendPaymentCompletionActionSheet.swift
@@ -128,8 +128,8 @@ public class SendPaymentCompletionActionSheet: ActionSheetController {
         helper?.refreshObservedValues()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContentsForMode()
     }
diff --git a/Signal/src/ViewControllers/Payments/SendPaymentMemoViewController.swift b/Signal/src/ViewControllers/Payments/SendPaymentMemoViewController.swift
index d6400117274..5a3eeee11cc 100644
--- a/Signal/src/ViewControllers/Payments/SendPaymentMemoViewController.swift
+++ b/Signal/src/ViewControllers/Payments/SendPaymentMemoViewController.swift
@@ -72,7 +72,7 @@ public class SendPaymentMemoViewController: OWSViewController {
         rootStack.autoPinEdge(toSuperviewMargin: .leading)
         rootStack.autoPinEdge(toSuperviewMargin: .trailing)
         rootStack.autoPin(toTopLayoutGuideOf: self, withInset: 0)
-        autoPinView(toBottomOfViewControllerOrKeyboard: rootStack, avoidNotch: true)
+        rootStack.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         updateContents()
     }
@@ -124,8 +124,8 @@ public class SendPaymentMemoViewController: OWSViewController {
         ])
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
diff --git a/Signal/src/ViewControllers/Payments/SendPaymentViewController.swift b/Signal/src/ViewControllers/Payments/SendPaymentViewController.swift
index 714534ce5c4..2ecd1102254 100644
--- a/Signal/src/ViewControllers/Payments/SendPaymentViewController.swift
+++ b/Signal/src/ViewControllers/Payments/SendPaymentViewController.swift
@@ -343,8 +343,8 @@ public class SendPaymentViewController: OWSViewController {
         helper?.refreshObservedValues()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
@@ -659,7 +659,7 @@ public class SendPaymentViewController: OWSViewController {
         rootStack.autoPinEdge(toSuperviewMargin: .leading)
         rootStack.autoPinEdge(toSuperviewMargin: .trailing)
         rootStack.autoPin(toTopLayoutGuideOf: self, withInset: 0)
-        autoPinView(toBottomOfViewControllerOrKeyboard: rootStack, avoidNotch: true)
+        rootStack.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         bigAmountLabel.font = UIFont.ows_dynamicTypeLargeTitle1Clamped.withSize(60)
         bigAmountLabel.textAlignment = .center
diff --git a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumber2FAViewController.swift b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumber2FAViewController.swift
index 5035bab9f2e..bd9b051d7d1 100644
--- a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumber2FAViewController.swift
+++ b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumber2FAViewController.swift
@@ -160,7 +160,7 @@ public class ChangePhoneNumber2FAViewController: RegistrationBaseViewController
         // Because of the keyboard, vertical spacing can get pretty cramped,
         // so we have custom spacer logic.
         stackView.autoPinEdges(toSuperviewMarginsExcludingEdge: .bottom)
-        autoPinView(toBottomOfViewControllerOrKeyboard: stackView, avoidNotch: true)
+        stackView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         // Ensure whitespace is balanced, so inputs are vertically centered.
         topSpacer.autoMatch(.height, to: .height, of: bottomSpacer)
@@ -169,12 +169,6 @@ public class ChangePhoneNumber2FAViewController: RegistrationBaseViewController
         updatePinType()
     }
 
-    public override func viewDidLoad() {
-        super.viewDidLoad()
-
-        shouldBottomViewReserveSpaceForKeyboard = false
-    }
-
     public override func viewDidAppear(_ animated: Bool) {
         super.viewDidAppear(animated)
 
diff --git a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberConfirmViewController.swift b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberConfirmViewController.swift
index 3c8d1129af7..77752e42c64 100644
--- a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberConfirmViewController.swift
+++ b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberConfirmViewController.swift
@@ -44,13 +44,13 @@ class ChangePhoneNumberConfirmViewController: OWSViewController {
         rootView.autoPinEdge(toSuperviewSafeArea: .leading)
         rootView.autoPinEdge(toSuperviewSafeArea: .trailing)
         rootView.autoPin(toTopLayoutGuideOf: self, withInset: 0)
-        self.autoPinView(toBottomOfViewControllerOrKeyboard: rootView, avoidNotch: true)
+        rootView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         updateContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
diff --git a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberInputViewController.swift b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberInputViewController.swift
index 58dfeed8548..577f493c156 100644
--- a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberInputViewController.swift
+++ b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberInputViewController.swift
@@ -56,8 +56,8 @@ class ChangePhoneNumberInputViewController: OWSTableViewController2 {
         updateTableContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateTableContents()
     }
diff --git a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberSplashViewController.swift b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberSplashViewController.swift
index b8173db02fb..1a7414e97eb 100644
--- a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberSplashViewController.swift
+++ b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberSplashViewController.swift
@@ -49,13 +49,13 @@ class ChangePhoneNumberSplashViewController: OWSViewController {
         bottomContainer.autoPinEdge(toSuperviewSafeArea: .leading)
         bottomContainer.autoPinEdge(toSuperviewSafeArea: .trailing)
         bottomContainer.autoPinEdge(.top, to: .bottom, of: scrollView)
-        autoPinView(toBottomOfViewControllerOrKeyboard: bottomContainer, avoidNotch: true)
+        bottomContainer.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         updateContents()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         updateContents()
     }
diff --git a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberVerificationViewController.swift b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberVerificationViewController.swift
index 51f2e15ae06..7c2b8ed388f 100644
--- a/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberVerificationViewController.swift
+++ b/Signal/src/ViewControllers/Registration/ChangePhoneNumber/ChangePhoneNumberVerificationViewController.swift
@@ -26,6 +26,7 @@ public class ChangePhoneNumberVerificationViewController: RegistrationBaseViewCo
         super.init()
 
         viewModel.viewController = self
+        keyboardObservationBehavior = .whileLifecycleVisible
     }
 
     override public func loadView() {
@@ -39,38 +40,21 @@ public class ChangePhoneNumberVerificationViewController: RegistrationBaseViewCo
 
     // MARK: - View Lifecycle
 
-    public override func viewWillAppear(_ animated: Bool) {
-        super.viewWillAppear(animated)
-        shouldIgnoreKeyboardChanges = false
-    }
-
     public override func viewDidAppear(_ animated: Bool) {
         super.viewDidAppear(animated)
         verificationCodeView.becomeFirstResponder()
     }
 
-    public override func viewWillDisappear(_ animated: Bool) {
-        super.viewWillDisappear(animated)
-        shouldIgnoreKeyboardChanges = true
-    }
+    public override func keyboardFrameDidChange(_ newFrame: CGRect, animationDuration: TimeInterval, animationOptions: UIView.AnimationOptions) {
+        super.keyboardFrameDidChange(newFrame, animationDuration: animationDuration, animationOptions: animationOptions)
+        let isDismissing = newFrame.height == 0
 
-    public override func updateBottomLayoutConstraint(fromInset before: CGFloat, toInset after: CGFloat) {
-        let isDismissing = (after == 0)
         if isDismissing, equalSpacerHeightConstraint?.isActive == true {
             pinnedSpacerHeightConstraint?.constant = backButtonSpacer?.height ?? 0
             equalSpacerHeightConstraint?.isActive = false
             pinnedSpacerHeightConstraint?.isActive = true
         }
 
-        // Ignore any minor decreases in height. We want to grow to accommodate the
-        // QuickType bar, but shrinking in response to its dismissal is a bit much.
-        let isKeyboardGrowing = after > (keyboardBottomConstraint?.constant ?? before)
-        let isSignificantlyShrinking = ((before - after) / UIScreen.main.bounds.height) > 0.1
-        if isKeyboardGrowing || isSignificantlyShrinking || isDismissing {
-            super.updateBottomLayoutConstraint(fromInset: before, toInset: after)
-            self.view.layoutIfNeeded()
-        }
-
         if !isDismissing {
             pinnedSpacerHeightConstraint?.isActive = false
             equalSpacerHeightConstraint?.isActive = true
diff --git a/Signal/src/ViewControllers/Registration/Onboarding/Onboarding2FAViewController.swift b/Signal/src/ViewControllers/Registration/Onboarding/Onboarding2FAViewController.swift
index 56f521a597b..0eda3a3bc38 100644
--- a/Signal/src/ViewControllers/Registration/Onboarding/Onboarding2FAViewController.swift
+++ b/Signal/src/ViewControllers/Registration/Onboarding/Onboarding2FAViewController.swift
@@ -152,7 +152,7 @@ public class Onboarding2FAViewController: OnboardingBaseViewController {
         // Because of the keyboard, vertical spacing can get pretty cramped,
         // so we have custom spacer logic.
         stackView.autoPinEdges(toSuperviewMarginsExcludingEdge: .bottom)
-        autoPinView(toBottomOfViewControllerOrKeyboard: stackView, avoidNotch: true)
+        stackView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         // Ensure whitespace is balanced, so inputs are vertically centered.
         topSpacer.autoMatch(.height, to: .height, of: bottomSpacer)
@@ -161,12 +161,6 @@ public class Onboarding2FAViewController: OnboardingBaseViewController {
         updatePinType()
     }
 
-    public override func viewDidLoad() {
-        super.viewDidLoad()
-
-        shouldBottomViewReserveSpaceForKeyboard = false
-    }
-
     public override func viewDidAppear(_ animated: Bool) {
         super.viewDidAppear(animated)
 
diff --git a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingBaseViewController.swift b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingBaseViewController.swift
index 70cdc6432c0..cb3c0e998db 100644
--- a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingBaseViewController.swift
+++ b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingBaseViewController.swift
@@ -16,8 +16,6 @@ public class OnboardingBaseViewController: RegistrationBaseViewController {
         self.onboardingController = onboardingController
 
         super.init()
-
-        self.shouldUseTheme = false
     }
 
     func shouldShowBackButton() -> Bool {
diff --git a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingPhoneNumberViewController.swift b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingPhoneNumberViewController.swift
index 5badcca91ba..f60dd313414 100644
--- a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingPhoneNumberViewController.swift
+++ b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingPhoneNumberViewController.swift
@@ -235,7 +235,7 @@ public class RegistrationPhoneNumberViewController: OnboardingBaseViewController
         stackView.autoPinEdge(toSuperviewSafeArea: .top, withInset: 0, relation: .greaterThanOrEqual)
         stackView.autoPinEdge(toSuperviewMargin: .top).priority = .defaultHigh
         stackView.autoPinWidthToSuperviewMargins()
-        keyboardBottomConstraint = autoPinView(toBottomOfViewControllerOrKeyboard: stackView, avoidNotch: true)
+        keyboardBottomConstraint = stackView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
         progressSpinner.autoCenterInSuperview()
 
         // For when things get *really* cramped, here's what's required:
@@ -277,6 +277,8 @@ public class RegistrationPhoneNumberViewController: OnboardingBaseViewController
     public override func viewDidLoad() {
         super.viewDidLoad()
 
+        super.keyboardObservationBehavior = .whileLifecycleVisible
+
         phoneNumberTextField.delegate = self
         phoneNumberTextField.addTarget(self, action: #selector(textFieldDidChange(_:)), for: .editingChanged)
         populateDefaults()
@@ -285,7 +287,6 @@ public class RegistrationPhoneNumberViewController: OnboardingBaseViewController
     var isAppearing = false
     public override func viewWillAppear(_ animated: Bool) {
         super.viewWillAppear(animated)
-        shouldIgnoreKeyboardChanges = false
         isAppearing = true
 
         updateViewState(animated: false)
@@ -296,21 +297,17 @@ public class RegistrationPhoneNumberViewController: OnboardingBaseViewController
         phoneNumberTextField.becomeFirstResponder()
     }
 
-    public override func viewWillDisappear(_ animated: Bool) {
-        super.viewWillDisappear(animated)
-        shouldIgnoreKeyboardChanges = true
-    }
-
     public override func viewWillLayoutSubviews() {
         super.viewWillLayoutSubviews()
         updateViewState(animated: !isAppearing)
         isAppearing = false
     }
 
-    public override func updateBottomLayoutConstraint(fromInset before: CGFloat, toInset after: CGFloat) {
+    public override func keyboardFrameDidChange(_ newFrame: CGRect, animationDuration: TimeInterval, animationOptions: UIView.AnimationOptions) {
+        super.keyboardFrameDidChange(newFrame, animationDuration: animationDuration, animationOptions: animationOptions)
         var needsLayout = false
 
-        let isDismissing = (after == 0)
+        let isDismissing = (newFrame.height == 0)
         if isDismissing, equalSpacerHeightConstraint?.isActive == true {
             pinnedSpacerHeightConstraint?.constant = titleSpacer?.height ?? 0
             equalSpacerHeightConstraint?.isActive = false
@@ -318,15 +315,6 @@ public class RegistrationPhoneNumberViewController: OnboardingBaseViewController
             needsLayout = true
         }
 
-        // Ignore any minor decreases in height. We want to grow to accommodate the
-        // QuickType bar, but shrinking in response to its dismissal is a bit much.
-        let isKeyboardGrowing = after > -(keyboardBottomConstraint?.constant ?? 0.0)
-        let isSignificantlyShrinking = ((before - after) / UIScreen.main.bounds.height) > 0.1
-        if isKeyboardGrowing || isSignificantlyShrinking || isDismissing {
-            super.updateBottomLayoutConstraint(fromInset: before, toInset: after)
-            needsLayout = true
-        }
-
         if !isDismissing, equalSpacerHeightConstraint?.isActive == false {
             pinnedSpacerHeightConstraint?.isActive = false
             equalSpacerHeightConstraint?.isActive = true
diff --git a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingProfileCreationViewController.swift b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingProfileCreationViewController.swift
index b4c607355b4..8b7dbaef732 100644
--- a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingProfileCreationViewController.swift
+++ b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingProfileCreationViewController.swift
@@ -177,7 +177,7 @@ public class OnboardingProfileCreationViewController: OnboardingBaseViewControll
 
         primaryView.addSubview(contentScrollView)
         contentScrollView.autoPinEdgesToSuperviewEdges(with: .zero, excludingEdge: .bottom)
-        autoPinView(toBottomOfViewControllerOrKeyboard: contentScrollView, avoidNotch: true)
+        contentScrollView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
         contentScrollView.preservesSuperviewLayoutMargins = true
 
         // Build stacks
@@ -231,11 +231,6 @@ public class OnboardingProfileCreationViewController: OnboardingBaseViewControll
         saveButtonBackdrop.autoPinEdge(.bottom, to: .bottom, of: contentScrollView)
     }
 
-    public override func viewDidLoad() {
-        super.viewDidLoad()
-        shouldBottomViewReserveSpaceForKeyboard = false
-    }
-
     public override func viewWillAppear(_ animated: Bool) {
         super.viewWillAppear(animated)
         updateAvatarView()
@@ -261,22 +256,13 @@ public class OnboardingProfileCreationViewController: OnboardingBaseViewControll
         }
     }
 
-    public override func updateBottomLayoutConstraint(fromInset before: CGFloat, toInset after: CGFloat) {
-        // Ignore any minor decreases in height. We want to grow to accommodate the
-        // QuickType bar, but shrinking in response to its dismissal is a bit much.
-        let isKeyboardDismissing = (after == 0)
-        let isKeyboardGrowing = after > before
-        let isKeyboardSignificantlyShrinking = ((before - after) / UIScreen.main.bounds.height) > 0.1
-
-        if isKeyboardGrowing || isKeyboardSignificantlyShrinking || isKeyboardDismissing {
-            super.updateBottomLayoutConstraint(fromInset: before, toInset: after)
-        }
-    }
-
     @objc
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
+        applyTheme()
+    }
 
+    private func applyTheme() {
         UIView.transition(with: view, duration: 0.25, options: .transitionCrossDissolve) {
             self.view.backgroundColor = Theme.backgroundColor
 
diff --git a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingVerificationViewController.swift b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingVerificationViewController.swift
index a8f0a4c83c4..b724529fc21 100644
--- a/Signal/src/ViewControllers/Registration/Onboarding/OnboardingVerificationViewController.swift
+++ b/Signal/src/ViewControllers/Registration/Onboarding/OnboardingVerificationViewController.swift
@@ -25,9 +25,10 @@ public class OnboardingVerificationViewController: OnboardingBaseViewController
 
     // MARK: - View Lifecycle
 
-    public override func viewWillAppear(_ animated: Bool) {
-        super.viewWillAppear(animated)
-        shouldIgnoreKeyboardChanges = false
+    public override init(onboardingController: OnboardingController) {
+        super.init(onboardingController: onboardingController)
+
+        keyboardObservationBehavior = .whileLifecycleVisible
     }
 
     public override func viewDidAppear(_ animated: Bool) {
@@ -35,28 +36,16 @@ public class OnboardingVerificationViewController: OnboardingBaseViewController
         verificationCodeView.becomeFirstResponder()
     }
 
-    public override func viewWillDisappear(_ animated: Bool) {
-        super.viewWillDisappear(animated)
-        shouldIgnoreKeyboardChanges = true
-    }
+    public override func keyboardFrameDidChange(_ newFrame: CGRect, animationDuration: TimeInterval, animationOptions: UIView.AnimationOptions) {
+        super.keyboardFrameDidChange(newFrame, animationDuration: animationDuration, animationOptions: animationOptions)
+        let isDismissing = newFrame.height == 0
 
-    public override func updateBottomLayoutConstraint(fromInset before: CGFloat, toInset after: CGFloat) {
-        let isDismissing = (after == 0)
         if isDismissing, equalSpacerHeightConstraint?.isActive == true {
             pinnedSpacerHeightConstraint?.constant = backButtonSpacer?.height ?? 0
             equalSpacerHeightConstraint?.isActive = false
             pinnedSpacerHeightConstraint?.isActive = true
         }
 
-        // Ignore any minor decreases in height. We want to grow to accommodate the
-        // QuickType bar, but shrinking in response to its dismissal is a bit much.
-        let isKeyboardGrowing = after > (keyboardBottomConstraint?.constant ?? before)
-        let isSignificantlyShrinking = ((before - after) / UIScreen.main.bounds.height) > 0.1
-        if isKeyboardGrowing || isSignificantlyShrinking || isDismissing {
-            super.updateBottomLayoutConstraint(fromInset: before, toInset: after)
-            self.view.layoutIfNeeded()
-        }
-
         if !isDismissing {
             pinnedSpacerHeightConstraint?.isActive = false
             equalSpacerHeightConstraint?.isActive = true
diff --git a/Signal/src/ViewControllers/Registration/RegistrationVerificationViewController.swift b/Signal/src/ViewControllers/Registration/RegistrationVerificationViewController.swift
index abe5be55f42..248d59995ea 100644
--- a/Signal/src/ViewControllers/Registration/RegistrationVerificationViewController.swift
+++ b/Signal/src/ViewControllers/Registration/RegistrationVerificationViewController.swift
@@ -44,7 +44,6 @@ class RegistrationVerificationViewModel: NSObject {
 
     var equalSpacerHeightConstraint: NSLayoutConstraint?
     var pinnedSpacerHeightConstraint: NSLayoutConstraint?
-    var keyboardBottomConstraint: NSLayoutConstraint?
     var buttonHeightConstraints: [NSLayoutConstraint] = []
 
     // MARK: - Methods
@@ -157,7 +156,7 @@ class RegistrationVerificationViewModel: NSObject {
         stackView.autoPinEdge(toSuperviewSafeArea: .top, withInset: 0, relation: .greaterThanOrEqual)
         stackView.autoPinEdge(toSuperviewMargin: .top).priority = .defaultHigh
         stackView.autoPinWidthToSuperviewMargins()
-        self.keyboardBottomConstraint = vc.autoPinView(toBottomOfViewControllerOrKeyboard: stackView, avoidNotch: true)
+        stackView.autoPinEdge(.bottom, to: .bottom, of: vc.keyboardLayoutGuideViewSafeArea)
         progressView.autoCenterInSuperview()
 
         // For when things get *really* cramped, here's what's required:
@@ -421,7 +420,6 @@ extension RegistrationVerificationViewController {
     var progressView: AnimatedProgressView { viewModel.progressView }
     var equalSpacerHeightConstraint: NSLayoutConstraint? { viewModel.equalSpacerHeightConstraint }
     var pinnedSpacerHeightConstraint: NSLayoutConstraint? { viewModel.pinnedSpacerHeightConstraint }
-    var keyboardBottomConstraint: NSLayoutConstraint? { viewModel.keyboardBottomConstraint }
     var buttonHeightConstraints: [NSLayoutConstraint] { viewModel.buttonHeightConstraints }
 }
 
diff --git a/Signal/src/ViewControllers/Registration/SecondaryLinking/SecondaryLinkingSetDeviceNameViewController.swift b/Signal/src/ViewControllers/Registration/SecondaryLinking/SecondaryLinkingSetDeviceNameViewController.swift
index 1fda1b84430..52d8f16bd33 100644
--- a/Signal/src/ViewControllers/Registration/SecondaryLinking/SecondaryLinkingSetDeviceNameViewController.swift
+++ b/Signal/src/ViewControllers/Registration/SecondaryLinking/SecondaryLinkingSetDeviceNameViewController.swift
@@ -84,7 +84,7 @@ class SecondaryLinkingSetDeviceNameViewController: OnboardingBaseViewController
         // Because of the keyboard, vertical spacing can get pretty cramped,
         // so we have custom spacer logic.
         stackView.autoPinEdges(toSuperviewMarginsExcludingEdge: .bottom)
-        autoPinView(toBottomOfViewControllerOrKeyboard: stackView, avoidNotch: true)
+        stackView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
     }
 
     // MARK: -
diff --git a/Signal/src/ViewControllers/ThreadSettings/AddToGroupViewController.swift b/Signal/src/ViewControllers/ThreadSettings/AddToGroupViewController.swift
index f4601b8652b..dac63e49655 100644
--- a/Signal/src/ViewControllers/ThreadSettings/AddToGroupViewController.swift
+++ b/Signal/src/ViewControllers/ThreadSettings/AddToGroupViewController.swift
@@ -87,13 +87,9 @@ public class AddToGroupViewController: OWSTableViewController2 {
 
     // MARK: Helpers
 
-    public override func applyTheme() {
-        super.applyTheme()
-        self.tableView.sectionIndexColor = Theme.primaryTextColor
-    }
-
     public override func themeDidChange() {
         super.themeDidChange()
+        self.tableView.sectionIndexColor = Theme.primaryTextColor
         updateTableContents()
     }
 
diff --git a/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController+Contents.swift b/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController+Contents.swift
index 83b205e3c28..4a95253cda6 100644
--- a/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController+Contents.swift
+++ b/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController+Contents.swift
@@ -36,11 +36,6 @@ extension ConversationSettingsViewController {
 
     // MARK: - Table
 
-    override func themeDidChange() {
-        super.themeDidChange()
-        updateTableContents()
-    }
-
     @objc
     func updateTableContents(shouldReload: Bool = true) {
 
diff --git a/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift b/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift
index e4735e47ca3..6a53aa5cac9 100644
--- a/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift
+++ b/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift
@@ -181,6 +181,11 @@ class ConversationSettingsViewController: OWSTableViewController2, BadgeCollecti
         updateNavigationBar()
     }
 
+    override func themeDidChange() {
+        super.themeDidChange()
+        updateTableContents()
+    }
+
     func updateNavigationBar() {
         guard canEditConversationAttributes else {
             navigationItem.rightBarButtonItem = nil
diff --git a/Signal/src/ViewControllers/ThreadSettings/GroupDescriptionViewController.swift b/Signal/src/ViewControllers/ThreadSettings/GroupDescriptionViewController.swift
index 37daffa10f7..5c12dc34631 100644
--- a/Signal/src/ViewControllers/ThreadSettings/GroupDescriptionViewController.swift
+++ b/Signal/src/ViewControllers/ThreadSettings/GroupDescriptionViewController.swift
@@ -72,8 +72,8 @@ class GroupDescriptionViewController: OWSTableViewController2 {
         updateTableContents()
     }
 
-    override func applyTheme() {
-        super.applyTheme()
+    override func themeDidChange() {
+        super.themeDidChange()
 
         helper.descriptionTextView.linkTextAttributes = [
             .foregroundColor: Theme.primaryTextColor,
diff --git a/SignalUI/ViewControllers/ContactShareApprovalViewController.swift b/SignalUI/ViewControllers/ContactShareApprovalViewController.swift
index 2dd457985e4..79e93cc76c3 100644
--- a/SignalUI/ViewControllers/ContactShareApprovalViewController.swift
+++ b/SignalUI/ViewControllers/ContactShareApprovalViewController.swift
@@ -410,7 +410,7 @@ public class ContactShareApprovalViewController: OWSViewController, EditContactS
         scrollView.autoPinEdge(toSuperviewSafeArea: .leading)
         scrollView.autoPinEdge(toSuperviewSafeArea: .trailing)
         scrollView.autoPin(toTopLayoutGuideOf: self, withInset: 0)
-        autoPinView(toBottomOfViewControllerOrKeyboard: scrollView, avoidNotch: true)
+        scrollView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
 
         let fieldsView = createFieldsView()
 
diff --git a/SignalUI/ViewControllers/ConversationPicker/ConversationPicker.swift b/SignalUI/ViewControllers/ConversationPicker/ConversationPicker.swift
index f0154770ff3..e08e38e8ab5 100644
--- a/SignalUI/ViewControllers/ConversationPicker/ConversationPicker.swift
+++ b/SignalUI/ViewControllers/ConversationPicker/ConversationPicker.swift
@@ -225,8 +225,8 @@ open class ConversationPickerViewController: OWSTableViewController2 {
         presentationTime = presentationTime ?? Date()
     }
 
-    open override func applyTheme() {
-        super.applyTheme()
+    open override func themeDidChange() {
+        super.themeDidChange()
 
         searchBar.searchFieldBackgroundColorOverride = Theme.searchFieldElevatedBackgroundColor
         updateTableContents(shouldReload: false)
diff --git a/SignalUI/ViewControllers/FindByPhoneNumberViewController.swift b/SignalUI/ViewControllers/FindByPhoneNumberViewController.swift
index 4d51ff86106..5b662bd2991 100644
--- a/SignalUI/ViewControllers/FindByPhoneNumberViewController.swift
+++ b/SignalUI/ViewControllers/FindByPhoneNumberViewController.swift
@@ -165,9 +165,12 @@ public class FindByPhoneNumberViewController: OWSViewController {
         applyTheme()
     }
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
+        applyTheme()
+    }
 
+    private func applyTheme() {
         view.backgroundColor = backgroundColor
         countryRowTitleLabel.textColor = Theme.primaryTextColor
         phoneNumberRowTitleLabel.textColor = Theme.primaryTextColor
diff --git a/SignalUI/ViewControllers/Member Picker/BaseMemberViewController.swift b/SignalUI/ViewControllers/Member Picker/BaseMemberViewController.swift
index e1f17bf5248..07a1f676c49 100644
--- a/SignalUI/ViewControllers/Member Picker/BaseMemberViewController.swift	
+++ b/SignalUI/ViewControllers/Member Picker/BaseMemberViewController.swift	
@@ -95,7 +95,7 @@ open class BaseMemberViewController: RecipientPickerContainerViewController {
         recipientPicker.view.autoPin(toTopLayoutGuideOf: self, withInset: 0)
         recipientPicker.view.autoPinEdge(toSuperviewSafeArea: .leading)
         recipientPicker.view.autoPinEdge(toSuperviewSafeArea: .trailing)
-        autoPinView(toBottomOfViewControllerOrKeyboard: recipientPicker.view, avoidNotch: false)
+        recipientPicker.view.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideView)
 
         updateMemberCount()
     }
diff --git a/SignalUI/ViewControllers/OWSTableViewController2.swift b/SignalUI/ViewControllers/OWSTableViewController2.swift
index 9241ed00a00..656f663cb39 100644
--- a/SignalUI/ViewControllers/OWSTableViewController2.swift
+++ b/SignalUI/ViewControllers/OWSTableViewController2.swift
@@ -169,6 +169,30 @@ open class OWSTableViewController2: OWSViewController {
                                                object: nil)
     }
 
+    open override func themeDidChange() {
+        super.themeDidChange()
+
+        applyTheme()
+        applyContents()
+    }
+
+    private func applyTheme() {
+        applyTheme(to: self)
+
+        tableView.backgroundColor = self.tableBackgroundColor
+        tableView.sectionIndexColor = forceDarkMode ? Theme.darkThemePrimaryColor : Theme.primaryTextColor
+
+        updateNavbarStyling()
+
+        if useNewStyle {
+            tableView.separatorColor = .clear
+            tableView.separatorInset = .zero
+            tableView.separatorStyle = .none
+        } else {
+            tableView.separatorColor = Theme.cellSeparatorColor
+        }
+    }
+
     public var shouldHideBottomFooter = false {
         didSet {
             let didChange = oldValue != shouldHideBottomFooter
@@ -183,18 +207,17 @@ open class OWSTableViewController2: OWSViewController {
     private func updateBottomConstraint() {
         bottomFooterConstraint?.autoRemove()
         bottomFooterConstraint = nil
-        self.removeBottomLayout()
 
         // Pin bottom edge of tableView.
         if !shouldHideBottomFooter,
            let bottomFooter = bottomFooter {
             if shouldAvoidKeyboard {
-                bottomFooterConstraint = autoPinView(toBottomOfViewControllerOrKeyboard: bottomFooter, avoidNotch: true)
+                bottomFooterConstraint = bottomFooter.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
             } else {
                 bottomFooterConstraint = bottomFooter.autoPinEdge(toSuperviewEdge: .bottom)
             }
         } else if shouldAvoidKeyboard {
-            bottomFooterConstraint = autoPinView(toBottomOfViewControllerOrKeyboard: tableView, avoidNotch: true)
+            bottomFooterConstraint = tableView.autoPinEdge(.bottom, to: .bottom, of: keyboardLayoutGuideViewSafeArea)
         } else {
             bottomFooterConstraint = tableView.autoPinEdge(toSuperviewEdge: .bottom)
         }
@@ -968,15 +991,6 @@ extension OWSTableViewController2: UITableViewDataSource, UITableViewDelegate {
 
     // MARK: - Theme
 
-    @objc
-    open override func themeDidChange() {
-        AssertIsOnMainThread()
-
-        super.themeDidChange()
-
-        applyContents()
-    }
-
     @objc
     open var tableBackgroundColor: UIColor {
         AssertIsOnMainThread()
@@ -1052,26 +1066,6 @@ extension OWSTableViewController2: UITableViewDataSource, UITableViewDelegate {
         }
     }
 
-    @objc
-    open override func applyTheme() {
-        AssertIsOnMainThread()
-
-        applyTheme(to: self)
-
-        tableView.backgroundColor = self.tableBackgroundColor
-        tableView.sectionIndexColor = forceDarkMode ? Theme.darkThemePrimaryColor : Theme.primaryTextColor
-
-        updateNavbarStyling()
-
-        if useNewStyle {
-            tableView.separatorColor = .clear
-            tableView.separatorInset = .zero
-            tableView.separatorStyle = .none
-        } else {
-            tableView.separatorColor = Theme.cellSeparatorColor
-        }
-    }
-
     @objc(applyThemeToViewController:)
     public func applyTheme(to viewController: UIViewController) {
         AssertIsOnMainThread()
diff --git a/SignalUI/ViewControllers/OWSViewController.swift b/SignalUI/ViewControllers/OWSViewController.swift
index bfd83e76987..d7f7de5d821 100644
--- a/SignalUI/ViewControllers/OWSViewController.swift
+++ b/SignalUI/ViewControllers/OWSViewController.swift
@@ -5,68 +5,101 @@
 
 import Foundation
 
+public enum ViewControllerLifecycle: Equatable {
+    /// `viewDidLoad` hasn't happened yet.
+    case notLoaded
+    /// Prior to `viewWillAppear` and after `viewDidDisappear`.
+    case notAppeared
+    /// After `viewWillAppear` and before `viewDidAppear`.
+    case willAppear
+    /// After `viewDidAppear` and before `viewWillDisappear`.
+    case appeared
+    /// After `viewWillDisappear` and before `viewDidDisappear`.
+    case willDisappear
+
+    var isLoaded: Bool {
+        return self != .notLoaded
+    }
+
+    var isVisible: Bool {
+        switch self {
+        case .willAppear, .appeared, .willDisappear:
+            return true
+        default:
+            return false
+        }
+    }
+}
+
 @objc
 open class OWSViewController: UIViewController {
 
-    /// If observing keyboard events is unecessary, override this to true to just drop them for a slight performance gain.
-    public var shouldIgnoreKeyboardChanges = false
-
-    // If true, the bottom view never "reclaims" layout space if the keyboard is dismissed.
-    // Defaults to false.
-    public var shouldBottomViewReserveSpaceForKeyboard = false
+    /// Current state of the view lifecycle.
+    /// Note changes are triggered by the lifecycle methods `viewDidLoad` `viewWillAppear` `viewDidAppear`
+    /// `viewWillDisappear` `viewDidDisappear`; those can be overriden to get state change hooks as per normal.
+    public private(set) final var lifecycle = ViewControllerLifecycle.notLoaded {
+        didSet {
+            achievedLifecycleStates.insert(lifecycle)
+        }
+    }
 
-    /// If true, sets the root view's background color to `Theme.background` on load.
-    public var shouldUseTheme: Bool = false
+    /// All lifecycle states achieved so far in the lifetime of this view controller.
+    public private(set) final var achievedLifecycleStates = Set<ViewControllerLifecycle>()
 
-    @discardableResult
-    public final func autoPinView(
-        toBottomOfViewControllerOrKeyboard view: UIView,
-        avoidNotch: Bool,
-        adjustmentWithKeyboardPresented adjustment: CGFloat = 0
-    ) -> NSLayoutConstraint {
-        owsAssertDebug(self.bottomLayoutConstraint == nil)
+    // MARK: - Keyboard handling
 
-        self.observeNotificationsForBottomView()
+    public enum KeyboardObservationBehavior {
+        /// Don't observe keyboard frame changes.
+        /// WARNING: makes `keyboardFrameDidChange` non-functional.
+        case never
+        /// Only observe keyboard frame changes while the view is between `willAppear` and `didDisappear`.
+        case whileLifecycleVisible
+        /// Always observe keyboard frame changes.
+        case always
+    }
 
-        self.bottomLayoutView = view
-        self.keyboardAdjustmentOffsetForAutoPinnedToBottomView = adjustment
-        if avoidNotch {
-            self.bottomLayoutConstraint = view.autoPin(toBottomLayoutGuideOf: self, withInset: self.lastBottomLayoutInset)
-        } else {
-            self.bottomLayoutConstraint = view.autoPinEdge(
-                .bottom,
-                to: .bottom,
-                of: self.view,
-                withOffset: self.lastBottomLayoutInset
-            )
+    public final var keyboardObservationBehavior: KeyboardObservationBehavior = .always {
+        didSet {
+            observeKeyboardNotificationsIfNeeded()
         }
-        return self.bottomLayoutConstraint!
     }
 
-    public final func removeBottomLayout() {
-        bottomLayoutConstraint?.autoRemove()
-        bottomLayoutView = nil
-        bottomLayoutConstraint = nil
+    /// Subclasses can override this method for a hook on keyboard frame changes.
+    /// NOTE: overrides _must_ call the superclass version of this method, similarly to other view lifecycle methods.
+    /// - Parameter newFrame: The frame of the keyboard _after_ any animations, in the view controller's view's coordinates.
+    open func keyboardFrameDidChange(
+        _ newFrame: CGRect,
+        animationDuration: TimeInterval,
+        animationOptions: UIView.AnimationOptions
+    ) {
+        self.handleKeyboardFrameChange(newFrame, animationDuration, animationOptions)
     }
 
-    @objc
-    open dynamic func themeDidChange() {
-        AssertIsOnMainThread()
+    /// A non-rendering spacer view that tracks the space _not_ covered by the keyboard.
+    /// When the keyboard is collapsed, the bottom of this view is the bottom of the root view _not_ respecting safe area.
+    public final var keyboardLayoutGuideView: SpacerView { getOrCreateKeyboardLayoutView(safeArea: false) }
 
-        applyTheme()
-    }
+    /// A non-rendering spacer view that tracks the space _not_ covered by the keyboard.
+    /// When the keyboard is collapsed, the bottom of this view is the bottom of the root view respecting safe area.
+    public final var keyboardLayoutGuideViewSafeArea: SpacerView { getOrCreateKeyboardLayoutView(safeArea: true) }
+
+    // MARK: - Themeing
 
+    /// Subclasses can override to respond to theme changes.
+    /// NOTE: overrides _must_ call the superclass version of this method, similarly to other view lifecycle methods.
     @objc
-    open dynamic func applyTheme() {
+    open func themeDidChange() {
         AssertIsOnMainThread()
 
-        // Do nothing; this is a convenience hook for subclasses.
+        // Do nothing; just serves as a hook for subclasses.
     }
 
+    // MARK: - Init
+
     public init() {
         super.init(nibName: nil, bundle: nil)
 
-        self.observeActivation()
+        self.observeAppState()
     }
 
     deinit {
@@ -79,12 +112,40 @@ open class OWSViewController: UIViewController {
         fatalError("init(coder:) has not been implemented")
     }
 
+    // MARK: - Lifecycle
+
+    /// Subclasses can override to respond to application state changes.
+    /// NOTE: overrides _must_ call the superclass version of this method, similarly to other view lifecycle methods.
+    @objc
+    open func appWillEnterForeground() {
+        // Do nothing; just a hook for subclasses
+    }
+
+    /// Subclasses can override to respond to application state changes.
+    /// NOTE: overrides _must_ call the superclass version of this method, similarly to other view lifecycle methods.
+    @objc
+    open func appDidBecomeActive() {
+        setNeedsStatusBarAppearanceUpdate()
+    }
+
+    /// Subclasses can override to respond to application state changes.
+    /// NOTE: overrides _must_ call the superclass version of this method, similarly to other view lifecycle methods.
+    @objc
+    open func appWillResignActive() {
+        // Do nothing; just a hook for subclasses
+    }
+
+    /// Subclasses can override to respond to application state changes.
+    /// NOTE: overrides _must_ call the superclass version of this method, similarly to other view lifecycle methods.
+    @objc
+    open func appDidEnterBackground() {
+        // Do nothing; just a hook for subclasses
+    }
+
     open override func viewDidLoad() {
         super.viewDidLoad()
 
-        if shouldUseTheme {
-            view.backgroundColor = Theme.backgroundColor
-        }
+        self.lifecycle = .notAppeared
 
         NotificationCenter.default.addObserver(
             self,
@@ -94,20 +155,42 @@ open class OWSViewController: UIViewController {
         )
     }
 
+    open override func viewWillAppear(_ animated: Bool) {
+        super.viewWillAppear(animated)
+
+        self.lifecycle = .willAppear
+
+        observeKeyboardNotificationsIfNeeded()
+    }
+
     open override func viewDidAppear(_ animated: Bool) {
         super.viewDidAppear(animated)
 
-        shouldAnimateBottomLayout = true
+        self.lifecycle = .appeared
 
         #if DEBUG
         ensureNavbarAccessibilityIds()
         #endif
     }
 
+    open override func viewWillDisappear(_ animated: Bool) {
+        super.viewWillDisappear(animated)
+
+        self.lifecycle = .willDisappear
+    }
+
     open override func viewDidDisappear(_ animated: Bool) {
         super.viewDidDisappear(animated)
 
-        shouldAnimateBottomLayout = false
+        self.lifecycle = .notAppeared
+
+        observeKeyboardNotificationsIfNeeded()
+    }
+
+    open override func viewSafeAreaInsetsDidChange() {
+        super.viewSafeAreaInsetsDidChange()
+
+        updateKeyboardLayoutOffsets()
     }
 
     #if DEBUG
@@ -138,85 +221,97 @@ open class OWSViewController: UIViewController {
 
     // MARK: - Activation
 
-    private func observeActivation() {
-        NotificationCenter.default.addObserver(
-            self,
-            selector: #selector(owsViewControllerApplicationDidBecomeActive),
-            name: UIApplication.didBecomeActiveNotification,
-            object: nil
-        )
-    }
-
-    @objc
-    private func owsViewControllerApplicationDidBecomeActive() {
-        setNeedsStatusBarAppearanceUpdate()
-    }
-
-    // MARK: - Keyboard Layout
-
-    private var lastBottomLayoutInset: CGFloat = 0
-    private var bottomLayoutView: UIView?
-    private var bottomLayoutConstraint: NSLayoutConstraint?
-    private var shouldAnimateBottomLayout = false
-    private var keyboardAdjustmentOffsetForAutoPinnedToBottomView: CGFloat = 0
-
-    private var hasObservedNotifications = false
-
-    private func observeNotificationsForBottomView() {
-        AssertIsOnMainThread()
-
-        guard !hasObservedNotifications else {
-            return
-        }
-        self.hasObservedNotifications = true
-
-        NotificationCenter.default.addObserver(
-            self,
-            selector: #selector(handleKeyboardNotificationBase),
-            name: UIResponder.keyboardWillShowNotification,
-            object: nil
-        )
-        NotificationCenter.default.addObserver(
-            self,
-            selector: #selector(handleKeyboardNotificationBase),
-            name: UIResponder.keyboardDidShowNotification,
-            object: nil
-        )
+    private func observeAppState() {
         NotificationCenter.default.addObserver(
             self,
-            selector: #selector(handleKeyboardNotificationBase),
-            name: UIResponder.keyboardWillHideNotification,
+            selector: #selector(appWillEnterForeground),
+            name: UIApplication.willEnterForegroundNotification,
             object: nil
         )
         NotificationCenter.default.addObserver(
             self,
-            selector: #selector(handleKeyboardNotificationBase),
-            name: UIResponder.keyboardDidHideNotification,
+            selector: #selector(appDidBecomeActive),
+            name: UIApplication.didBecomeActiveNotification,
             object: nil
         )
         NotificationCenter.default.addObserver(
             self,
-            selector: #selector(handleKeyboardNotificationBase),
-            name: UIResponder.keyboardWillChangeFrameNotification,
+            selector: #selector(appWillResignActive),
+            name: UIApplication.willResignActiveNotification,
             object: nil
         )
         NotificationCenter.default.addObserver(
             self,
-            selector: #selector(handleKeyboardNotificationBase),
-            name: UIResponder.keyboardDidChangeFrameNotification,
+            selector: #selector(appDidEnterBackground),
+            name: UIApplication.didEnterBackgroundNotification,
             object: nil
         )
-
     }
 
     @objc
-    private func handleKeyboardNotificationBase(_ notification: NSNotification) {
-        AssertIsOnMainThread()
+    private func owsViewControllerApplicationDidBecomeActive() {
+        setNeedsStatusBarAppearanceUpdate()
+    }
+
+    // MARK: - Keyboard Layout
 
-        guard !shouldIgnoreKeyboardChanges else {
+    private var isObservingKeyboardNotifications = false
+
+    static var keyboardNotificationNames: [Notification.Name] = [
+        UIResponder.keyboardWillShowNotification,
+        UIResponder.keyboardDidShowNotification,
+        UIResponder.keyboardWillHideNotification,
+        UIResponder.keyboardDidHideNotification,
+        UIResponder.keyboardWillChangeFrameNotification,
+        UIResponder.keyboardDidChangeFrameNotification
+    ]
+
+    private func observeKeyboardNotificationsIfNeeded() {
+        switch keyboardObservationBehavior {
+        case .always:
+            break
+        case .never:
+            stopObservingKeyboardNotifications()
             return
+        case .whileLifecycleVisible:
+            if !lifecycle.isVisible {
+                stopObservingKeyboardNotifications()
+                return
+            }
         }
 
+        if isObservingKeyboardNotifications { return }
+        isObservingKeyboardNotifications = true
+
+        Self.keyboardNotificationNames.forEach {
+            NotificationCenter.default.addObserver(
+                self,
+                selector: #selector(handleKeyboardNotificationBase(_:)),
+                name: $0,
+                object: nil
+            )
+        }
+    }
+
+    private func stopObservingKeyboardNotifications() {
+        Self.keyboardNotificationNames.forEach {
+            NotificationCenter.default.removeObserver(self, name: $0, object: nil)
+        }
+        isObservingKeyboardNotifications = false
+    }
+
+    private lazy var lastKnownKeyboardFrame: CGRect = {
+        let deviceBounds = CurrentAppContext().frame
+        return CGRect(
+            x: deviceBounds.minX,
+            y: deviceBounds.maxY,
+            width: deviceBounds.width,
+            height: 0
+        )
+    }()
+
+    @objc
+    private func handleKeyboardNotificationBase(_ notification: NSNotification) {
         let userInfo = notification.userInfo
 
         guard var keyboardEndFrame = (userInfo?[UIResponder.keyboardFrameEndUserInfoKey] as? NSValue)?.cgRectValue else {
@@ -229,68 +324,94 @@ open class OWSViewController: UIViewController {
             // of CGRect zero. This breaks the math below.
             //
             // If our keyboard end frame is CGRectZero, build a fake rect that's translated off the bottom edge.
-            let deviceBounds = UIScreen.main.bounds
-            keyboardEndFrame = deviceBounds.offsetBy(dx: 0, dy: deviceBounds.height)
+            let deviceBounds = CurrentAppContext().frame
+            keyboardEndFrame = CGRect(
+                x: deviceBounds.minX,
+                y: deviceBounds.maxY,
+                width: deviceBounds.width,
+                height: 0
+            )
         }
 
         let keyboardEndFrameConverted = self.view.convert(keyboardEndFrame, from: nil)
-        // Adjust the position of the bottom view to account for the keyboard's
-        // intrusion into the view.
-        //
-        // On iPhones with no physical home button, when no keyboard is present,
-        // we include a buffer at the bottom of the screen so the bottom view
-        // clears the floating "home button". But because the keyboard includes it's own buffer,
-        // we subtract the size of bottom "safe area",
-        // else we'd have an unnecessary buffer between the popped keyboard and the input bar.
-        let newInset = max(
-            0,
-            self.view.height
-            + self.keyboardAdjustmentOffsetForAutoPinnedToBottomView
-            - self.view.safeAreaInsets.bottom
-            - keyboardEndFrameConverted.origin.y
-        )
-        self.lastBottomLayoutInset = newInset
 
-        let rawCurve = userInfo?[UIResponder.keyboardAnimationCurveUserInfoKey] as? Int
-        let curve = UIView.AnimationCurve(rawValue: rawCurve ?? 0) ?? .easeInOut
+        guard keyboardEndFrameConverted != lastKnownKeyboardFrame else {
+            // No change.
+            return
+        }
+        lastKnownKeyboardFrame = keyboardEndFrameConverted
+
+        let animationOptions: UIView.AnimationOptions
+        if let rawCurve = userInfo?[UIResponder.keyboardAnimationCurveUserInfoKey] as? UInt {
+            animationOptions = .init(rawValue: rawCurve << 16)
+        } else {
+            animationOptions = .curveEaseInOut
+        }
         let duration = userInfo?[UIResponder.keyboardAnimationDurationUserInfoKey] as? TimeInterval ?? 0
         // Should we ignore keyboard changes if they're coming from somewhere out-of-process?
         // BOOL isOurKeyboard = [notification.userInfo[UIKeyboardIsLocalUserInfoKey] boolValue];
 
-        let updateLayout = {
-            if self.shouldBottomViewReserveSpaceForKeyboard, newInset == 0 {
-                // To avoid unnecessary animations / layout jitter,
-                // some views never reclaim layout space when the keyboard is dismissed.
-                //
-                // They _do_ need to relayout if the user switches keyboards.
-                return
-            }
-            self.updateBottomLayoutConstraint(
-                fromInset: -1 * (self.bottomLayoutConstraint?.constant ?? 0),
-                toInset: newInset
-            )
+        keyboardFrameDidChange(keyboardEndFrameConverted, animationDuration: duration, animationOptions: animationOptions)
+    }
+
+    // This should be able to be a UILayoutGuide instead, but alas, PureLayout doesn't support those.
+    private var _keyboardLayoutView: SpacerView?
+    private var keyboardLayoutViewBottomConstraint: NSLayoutConstraint?
+    private var _keyboardLayoutViewSafeArea: SpacerView?
+    private var keyboardLayoutViewSafeAreaBottomConstraint: NSLayoutConstraint?
+
+    private func getOrCreateKeyboardLayoutView(safeArea: Bool) -> SpacerView {
+        if let keyboardLayoutView = safeArea ? _keyboardLayoutViewSafeArea : _keyboardLayoutView {
+            return keyboardLayoutView
         }
-        if self.shouldAnimateBottomLayout, duration > 0, !UIAccessibility.isReduceMotionEnabled {
-            UIView.beginAnimations("keyboardStateChange", context: nil)
-            UIView.setAnimationBeginsFromCurrentState(true)
-            UIView.setAnimationCurve(curve)
-            UIView.setAnimationDuration(duration)
-            updateLayout()
-            UIView.commitAnimations()
+        let view = PassthroughTouchSpacerView()
+        self.view.addSubview(view)
+        if safeArea {
+            view.autoPinEdgesToSuperviewSafeArea(with: .zero, excludingEdge: .bottom)
+            keyboardLayoutViewSafeAreaBottomConstraint = view.autoPinEdge(toSuperviewSafeArea: .bottom)
+            _keyboardLayoutViewSafeArea = view
         } else {
+            view.autoPinEdgesToSuperviewEdges(with: .zero, excludingEdge: .bottom)
+            keyboardLayoutViewBottomConstraint = view.autoPinEdge(.bottom, to: .bottom, of: self.view)
+            _keyboardLayoutView = view
+        }
+        updateKeyboardLayoutOffsets()
+        return view
+    }
+
+    private func handleKeyboardFrameChange(_ keyboardEndFrame: CGRect, _ duration: TimeInterval, _ animationOptions: UIView.AnimationOptions) {
+        guard lifecycle.isVisible, duration > 0, !UIAccessibility.isReduceMotionEnabled else {
             // UIKit by default (sometimes? never?) animates all changes in response to keyboard events.
             // We want to suppress those animations if the view isn't visible,
             // otherwise presentation animations don't work properly.
             UIView.performWithoutAnimation {
-                updateLayout()
+                self.updateKeyboardLayoutOffsets()
             }
+            return
         }
+        updateKeyboardLayoutOffsets()
+        UIView.animate(
+            withDuration: duration,
+            delay: 0,
+            options: animationOptions,
+            animations: {
+                self.view.layoutIfNeeded()
+            }
+        )
     }
 
-    @objc
-    open dynamic func updateBottomLayoutConstraint(fromInset before: CGFloat, toInset after: CGFloat) {
-        self.bottomLayoutConstraint?.constant = -after
-        self.bottomLayoutView?.superview?.layoutIfNeeded()
+    private func updateKeyboardLayoutOffsets() {
+        if let keyboardLayoutViewBottomConstraint = self.keyboardLayoutViewBottomConstraint {
+            keyboardLayoutViewBottomConstraint.constant = lastKnownKeyboardFrame.minY - view.bounds.height
+        }
+        if let keyboardLayoutViewSafeAreaBottomConstraint = self.keyboardLayoutViewSafeAreaBottomConstraint {
+            if lastKnownKeyboardFrame.minY < view.height - view.safeAreaInsets.bottom {
+                keyboardLayoutViewSafeAreaBottomConstraint.constant =
+                    lastKnownKeyboardFrame.minY - (view.bounds.height - view.safeAreaInsets.bottom)
+            } else {
+                keyboardLayoutViewSafeAreaBottomConstraint.constant = 0
+            }
+        }
     }
 
     // MARK: - Orientation
@@ -299,3 +420,14 @@ open class OWSViewController: UIViewController {
         return UIDevice.current.defaultSupportedOrientations
     }
 }
+
+private class PassthroughTouchSpacerView: SpacerView {
+
+    override func hitTest(_ point: CGPoint, with event: UIEvent?) -> UIView? {
+        let view = super.hitTest(point, with: event)
+        if view == self {
+            return nil
+        }
+        return view
+    }
+}
diff --git a/SignalUI/ViewControllers/Recipient Picker/RecipientPickerContainerViewController.swift b/SignalUI/ViewControllers/Recipient Picker/RecipientPickerContainerViewController.swift
index 97bde66504d..51d0c4926c5 100644
--- a/SignalUI/ViewControllers/Recipient Picker/RecipientPickerContainerViewController.swift	
+++ b/SignalUI/ViewControllers/Recipient Picker/RecipientPickerContainerViewController.swift	
@@ -10,8 +10,8 @@ open class RecipientPickerContainerViewController: OWSViewController {
 
     private var didApplyTheme = false
 
-    public override func applyTheme() {
-        super.applyTheme()
+    open override func themeDidChange() {
+        super.themeDidChange()
         if didApplyTheme {
             recipientPicker.applyTheme(to: self)
         }
diff --git a/SignalUI/ViewControllers/Stories/NewPrivateStoryConfirmViewController.swift b/SignalUI/ViewControllers/Stories/NewPrivateStoryConfirmViewController.swift
index 4e3a00870c2..e25b0cf470b 100644
--- a/SignalUI/ViewControllers/Stories/NewPrivateStoryConfirmViewController.swift
+++ b/SignalUI/ViewControllers/Stories/NewPrivateStoryConfirmViewController.swift
@@ -80,8 +80,8 @@ public class NewPrivateStoryConfirmViewController: OWSTableViewController2 {
         return textField
     }()
 
-    public override func applyTheme() {
-        super.applyTheme()
+    public override func themeDidChange() {
+        super.themeDidChange()
 
         nameTextField.textColor = Theme.primaryTextColor
     }
diff --git a/SignalUI/Views/ImageEditor/ImageEditorViewController+Text.swift b/SignalUI/Views/ImageEditor/ImageEditorViewController+Text.swift
index 74a8367d609..5877a28afc0 100644
--- a/SignalUI/Views/ImageEditor/ImageEditorViewController+Text.swift
+++ b/SignalUI/Views/ImageEditor/ImageEditorViewController+Text.swift
@@ -72,7 +72,12 @@ extension ImageEditorViewController {
         textViewContainer.autoPinEdge(toSuperviewEdge: .top)
         textViewContainer.autoPinWidthToSuperview()
         NSLayoutConstraint.autoSetPriority(.defaultHigh) {
-            autoPinView(toBottomOfViewControllerOrKeyboard: textViewContainer, avoidNotch: false)
+            textViewContainer.autoPinEdge(
+                .bottom,
+                to: .bottom,
+                of: keyboardLayoutGuideView,
+                withOffset: textViewAccessoryToolbar.height
+            )
         }
         textViewContainer.autoPinEdge(.bottom, to: .top, of: textToolbar, withOffset: 0, relation: .lessThanOrEqual)
 
@@ -113,16 +118,12 @@ extension ImageEditorViewController {
         textViewBackgroundView.backgroundColor = textToolbar.textBackgroundColor
     }
 
-    override func updateBottomLayoutConstraint(fromInset before: CGFloat, toInset after: CGFloat) {
+    func updateBottomLayoutConstraint(forKeyboardFrame keyboardFrame: CGRect) {
         guard mode == .text, textUIInitialized else {
-            super.updateBottomLayoutConstraint(fromInset: before, toInset: after)
             return
         }
 
-        let accessoryViewHeight = textViewAccessoryToolbar.height
-        super.updateBottomLayoutConstraint(fromInset: before, toInset: after - accessoryViewHeight)
-
-        let onScreenKeyboardVisible = after > 150
+        let onScreenKeyboardVisible = keyboardFrame.height > 150
         textViewAccessoryToolbar.alpha = onScreenKeyboardVisible ? 1 : 0
     }
 
diff --git a/SignalUI/Views/ImageEditor/ImageEditorViewController.swift b/SignalUI/Views/ImageEditor/ImageEditorViewController.swift
index 396508d19cd..74e69a5bf3d 100644
--- a/SignalUI/Views/ImageEditor/ImageEditorViewController.swift
+++ b/SignalUI/Views/ImageEditor/ImageEditorViewController.swift
@@ -289,6 +289,12 @@ class ImageEditorViewController: OWSViewController {
         updateContentLayoutMargins()
     }
 
+    override func keyboardFrameDidChange(_ newFrame: CGRect, animationDuration: TimeInterval, animationOptions: UIView.AnimationOptions) {
+        super.keyboardFrameDidChange(newFrame, animationDuration: animationDuration, animationOptions: animationOptions)
+
+        updateBottomLayoutConstraint(forKeyboardFrame: newFrame)
+    }
+
     override var prefersStatusBarHidden: Bool {
         !UIDevice.current.hasIPhoneXNotch && !UIDevice.current.isIPad && !CurrentAppContext().hasActiveCall
     }
