diff --git a/Signal.xcodeproj/project.pbxproj b/Signal.xcodeproj/project.pbxproj
index 87268217572..3eb08216987 100644
--- a/Signal.xcodeproj/project.pbxproj
+++ b/Signal.xcodeproj/project.pbxproj
@@ -849,6 +849,7 @@
 		66586D4129009C0000DDA9B9 /* TextAttachment.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66586D4029009C0000DDA9B9 /* TextAttachment.swift */; };
 		6659CCB129CD4650000C24C0 /* RegistrationConfirmModeSwitchViewController.swift in Sources */ = {isa = PBXBuildFile; fileRef = 6659CCB029CD4650000C24C0 /* RegistrationConfirmModeSwitchViewController.swift */; };
 		665EF86D290C385B00F490D2 /* OWSNavigationController.swift in Sources */ = {isa = PBXBuildFile; fileRef = 665EF86C290C385B00F490D2 /* OWSNavigationController.swift */; };
+		665FAE8C2A02C0D400FA298D /* SpoilerRevealState.swift in Sources */ = {isa = PBXBuildFile; fileRef = 665FAE8B2A02C0D400FA298D /* SpoilerRevealState.swift */; };
 		6673FF702978C40300F96CFD /* KBSAuthCredentialStorage.swift in Sources */ = {isa = PBXBuildFile; fileRef = 6673FF6F2978C40300F96CFD /* KBSAuthCredentialStorage.swift */; };
 		6673FF722979B33800F96CFD /* KBSAuthCredentialStorageImpl.swift in Sources */ = {isa = PBXBuildFile; fileRef = 6673FF712979B33800F96CFD /* KBSAuthCredentialStorageImpl.swift */; };
 		6673FF752979F87500F96CFD /* KBSAuthCredentialStorageTests.swift in Sources */ = {isa = PBXBuildFile; fileRef = 6673FF742979F87500F96CFD /* KBSAuthCredentialStorageTests.swift */; };
@@ -889,7 +890,6 @@
 		66A1DF73298C635E00C4E4A7 /* RegistrationRequestFactory.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66A1DF72298C635E00C4E4A7 /* RegistrationRequestFactory.swift */; };
 		66A1DF75298C73D900C4E4A7 /* RegistrationServiceResponses.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66A1DF74298C73D900C4E4A7 /* RegistrationServiceResponses.swift */; };
 		66A22C0928A18D49007CD4F5 /* RingerSwitch.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66A22C0828A18D49007CD4F5 /* RingerSwitch.swift */; };
-		66A5F2A72A016C5E0039AAC1 /* CVInteractionIdentifier.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66A5F2A62A016C5E0039AAC1 /* CVInteractionIdentifier.swift */; };
 		66A93A8029940A8200FA0291 /* RegistrationCoordinatorImpl+Service.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66A93A7F29940A8200FA0291 /* RegistrationCoordinatorImpl+Service.swift */; };
 		66AAC2C429CB6F1100566AD6 /* RegistrationChangeNumberSplashViewController.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66AAC2C329CB6F1100566AD6 /* RegistrationChangeNumberSplashViewController.swift */; };
 		66AAC2C629CB942F00566AD6 /* RegistrationChangePhoneNumberViewController.swift in Sources */ = {isa = PBXBuildFile; fileRef = 66AAC2C529CB942F00566AD6 /* RegistrationChangePhoneNumberViewController.swift */; };
@@ -3345,6 +3345,7 @@
 		66586D4029009C0000DDA9B9 /* TextAttachment.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = TextAttachment.swift; sourceTree = "<group>"; };
 		6659CCB029CD4650000C24C0 /* RegistrationConfirmModeSwitchViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = RegistrationConfirmModeSwitchViewController.swift; sourceTree = "<group>"; };
 		665EF86C290C385B00F490D2 /* OWSNavigationController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = OWSNavigationController.swift; sourceTree = "<group>"; };
+		665FAE8B2A02C0D400FA298D /* SpoilerRevealState.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = SpoilerRevealState.swift; sourceTree = "<group>"; };
 		6673FF6F2978C40300F96CFD /* KBSAuthCredentialStorage.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = KBSAuthCredentialStorage.swift; sourceTree = "<group>"; };
 		6673FF712979B33800F96CFD /* KBSAuthCredentialStorageImpl.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = KBSAuthCredentialStorageImpl.swift; sourceTree = "<group>"; };
 		6673FF742979F87500F96CFD /* KBSAuthCredentialStorageTests.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = KBSAuthCredentialStorageTests.swift; sourceTree = "<group>"; };
@@ -3388,7 +3389,6 @@
 		66A1DF72298C635E00C4E4A7 /* RegistrationRequestFactory.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = RegistrationRequestFactory.swift; sourceTree = "<group>"; };
 		66A1DF74298C73D900C4E4A7 /* RegistrationServiceResponses.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = RegistrationServiceResponses.swift; sourceTree = "<group>"; };
 		66A22C0828A18D49007CD4F5 /* RingerSwitch.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = RingerSwitch.swift; sourceTree = "<group>"; };
-		66A5F2A62A016C5E0039AAC1 /* CVInteractionIdentifier.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = CVInteractionIdentifier.swift; sourceTree = "<group>"; };
 		66A93A7F29940A8200FA0291 /* RegistrationCoordinatorImpl+Service.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = "RegistrationCoordinatorImpl+Service.swift"; sourceTree = "<group>"; };
 		66AAC2C329CB6F1100566AD6 /* RegistrationChangeNumberSplashViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = RegistrationChangeNumberSplashViewController.swift; sourceTree = "<group>"; };
 		66AAC2C529CB942F00566AD6 /* RegistrationChangePhoneNumberViewController.swift */ = {isa = PBXFileReference; lastKnownFileType = sourcecode.swift; path = RegistrationChangePhoneNumberViewController.swift; sourceTree = "<group>"; };
@@ -5778,7 +5778,6 @@
 			isa = PBXGroup;
 			children = (
 				34A95523271B510400B05242 /* CVCellMeasurement.swift */,
-				66A5F2A62A016C5E0039AAC1 /* CVInteractionIdentifier.swift */,
 				34A95525271B510400B05242 /* CVText.swift */,
 				34A95522271B510400B05242 /* CVTextLabel.swift */,
 				34A95524271B510400B05242 /* CVUtils.swift */,
@@ -6755,6 +6754,7 @@
 				F9C5C8D4289453B100548EEE /* MessageBody.swift */,
 				66FC636E29DF797700F00DAC /* MessageBodyRanges.swift */,
 				66FC638529E4B9AF00F00DAC /* RecoveredHydratedMessageBody.swift */,
+				665FAE8B2A02C0D400FA298D /* SpoilerRevealState.swift */,
 				66FC637729DF8BEF00F00DAC /* StyleAttribute.swift */,
 				66FC638B29E9E9D200F00DAC /* TextCheckingDataItem.swift */,
 			);
@@ -10756,7 +10756,6 @@
 				508F0346296F72F4001D88D0 /* CustomCellBackgroundColor.swift in Sources */,
 				3402AA7B271D9E180084CBAE /* CustomKeyboard.swift in Sources */,
 				3402AA87271D9E180084CBAE /* CVCellMeasurement.swift in Sources */,
-				66A5F2A72A016C5E0039AAC1 /* CVInteractionIdentifier.swift in Sources */,
 				3402AA92271D9E180084CBAE /* CVText.swift in Sources */,
 				3402AAB3271D9E180084CBAE /* CVTextLabel.swift in Sources */,
 				3402AA7A271D9E180084CBAE /* CVUtils.swift in Sources */,
@@ -12292,6 +12291,7 @@
 				F9C5CD8E289453B300548EEE /* SpamChallengeResolver.swift in Sources */,
 				F9427EAB297F1E88008EF0AC /* SpamReportingToken.swift in Sources */,
 				F9427EB0297F24AB008EF0AC /* SpamReportingTokenRecord.swift in Sources */,
+				665FAE8C2A02C0D400FA298D /* SpoilerRevealState.swift in Sources */,
 				F9613CDC2981F11400894B55 /* SqliteUtil.swift in Sources */,
 				50E642C929E4E9CD00566D5D /* SSKEnvironment.swift in Sources */,
 				D9668B2F291AF63500665298 /* SSKJobQueues.swift in Sources */,
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVComponentState.swift b/Signal/src/ViewControllers/ConversationView/CV/CVComponentState.swift
index c0378c62f14..0def267c928 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVComponentState.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVComponentState.swift
@@ -772,7 +772,7 @@ fileprivate extension CVComponentState.Builder {
 
     mutating func populateAndBuild(
         message: TSMessage,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) throws -> CVComponentState {
 
         if message.wasRemotelyDeleted {
@@ -1018,7 +1018,7 @@ fileprivate extension CVComponentState.Builder {
     // TODO: Should we validate and throw errors?
     mutating func buildQuotedReply(
         message: TSMessage,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) {
         guard let quotedReplyModel = OWSQuotedReplyModel.quotedReply(from: message, transaction: transaction) else {
             return
@@ -1274,7 +1274,7 @@ fileprivate extension CVComponentState {
         text: String,
         ranges: MessageBodyRanges?,
         interaction: TSInteraction,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         transaction: SDSAnyReadTransaction
     ) -> DisplayableText {
         return DisplayableText.displayableText(
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyText.swift b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyText.swift
index 15581a3bb38..c9099794c5f 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyText.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVComponents/CVComponentBodyText.swift
@@ -129,7 +129,7 @@ public class CVComponentBodyText: CVComponentBase, CVComponent {
         textWasTruncated: Bool,
         revealedSpoilerIds: Set<StyleIdType>,
         interactionUniqueId: String,
-        interactionIdentifier: CVInteractionIdentifier
+        interactionIdentifier: InteractionSnapshotIdentifier
     ) -> [CVTextLabel.Item] {
 
         // Use a lock to ensure that measurement on and off the main thread
@@ -524,7 +524,7 @@ public class CVComponentBodyText: CVComponentBase, CVComponent {
         textWasTruncated: Bool,
         revealedSpoilerIds: Set<StyleIdType>,
         interactionUniqueId: String,
-        interactionIdentifier: CVInteractionIdentifier
+        interactionIdentifier: InteractionSnapshotIdentifier
     ) {
 
         let items = detectItems(
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVLoadContext.swift b/Signal/src/ViewControllers/ConversationView/CV/CVLoadContext.swift
index 42ae45b38ac..e1bc94526c3 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVLoadContext.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVLoadContext.swift
@@ -15,7 +15,7 @@ struct CVLoadContext: CVItemBuildingContext {
     let loadRequest: CVLoadRequest
     let threadViewModel: ThreadViewModel
     let viewStateSnapshot: CVViewStateSnapshot
-    let spoilerReveal: CVSpoilerReveal
+    let spoilerReveal: SpoilerRevealState
     let messageMapping: CVMessageMapping
     let prevRenderState: CVRenderState
     let transaction: SDSAnyReadTransaction
@@ -25,7 +25,7 @@ struct CVLoadContext: CVItemBuildingContext {
         loadRequest: CVLoadRequest,
         threadViewModel: ThreadViewModel,
         viewStateSnapshot: CVViewStateSnapshot,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         messageMapping: CVMessageMapping,
         prevRenderState: CVRenderState,
         transaction: SDSAnyReadTransaction
@@ -57,7 +57,7 @@ protocol CVItemBuildingContext {
     var viewStateSnapshot: CVViewStateSnapshot { get }
     var transaction: SDSAnyReadTransaction { get }
     var avatarBuilder: CVAvatarBuilder { get }
-    var spoilerReveal: CVSpoilerReveal { get }
+    var spoilerReveal: SpoilerRevealState { get }
 }
 
 // MARK: -
@@ -77,7 +77,7 @@ struct CVItemBuildingContextImpl: CVItemBuildingContext {
     let viewStateSnapshot: CVViewStateSnapshot
     let transaction: SDSAnyReadTransaction
     let avatarBuilder: CVAvatarBuilder
-    let spoilerReveal: CVSpoilerReveal
+    let spoilerReveal: SpoilerRevealState
 }
 
 // MARK: -
@@ -95,7 +95,7 @@ extension CVItemBuilding {
     var threadAssociatedData: ThreadAssociatedData { threadViewModel.associatedData }
     var viewStateSnapshot: CVViewStateSnapshot { itemBuildingContext.viewStateSnapshot }
     var conversationStyle: ConversationStyle { itemBuildingContext.conversationStyle }
-    var spoilerReveal: CVSpoilerReveal { itemBuildingContext.spoilerReveal }
+    var spoilerReveal: SpoilerRevealState { itemBuildingContext.spoilerReveal }
     var mediaCache: CVMediaCache { itemBuildingContext.mediaCache }
     var transaction: SDSAnyReadTransaction { itemBuildingContext.transaction }
     var avatarBuilder: CVAvatarBuilder { itemBuildingContext.avatarBuilder }
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVLoadCoordinator.swift b/Signal/src/ViewControllers/ConversationView/CV/CVLoadCoordinator.swift
index 6c9cd9e601d..4688b0966ce 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVLoadCoordinator.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVLoadCoordinator.swift
@@ -57,7 +57,7 @@ public class CVLoadCoordinator: NSObject {
     private let threadUniqueId: String
 
     private var conversationStyle: ConversationStyle
-    private let spoilerReveal: CVSpoilerReveal
+    private let spoilerReveal: SpoilerRevealState
 
     var renderState: CVRenderState
 
@@ -548,7 +548,7 @@ public class CVLoadCoordinator: NSObject {
     private func load(
         loadRequest: CVLoadRequest,
         conversationStyle: ConversationStyle,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) {
         AssertIsOnMainThread()
         // We should do an "initial" load IFF this is our first load.
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVLoader.swift b/Signal/src/ViewControllers/ConversationView/CV/CVLoader.swift
index 88d2525a37e..44ad67ae59f 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVLoader.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVLoader.swift
@@ -15,7 +15,7 @@ public class CVLoader: NSObject {
     private let threadUniqueId: String
     private let loadRequest: CVLoadRequest
     private let viewStateSnapshot: CVViewStateSnapshot
-    private let spoilerReveal: CVSpoilerReveal
+    private let spoilerReveal: SpoilerRevealState
     private let prevRenderState: CVRenderState
     private let messageMapping: CVMessageMapping
 
@@ -25,7 +25,7 @@ public class CVLoader: NSObject {
         threadUniqueId: String,
         loadRequest: CVLoadRequest,
         viewStateSnapshot: CVViewStateSnapshot,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         prevRenderState: CVRenderState,
         messageMapping: CVMessageMapping
     ) {
@@ -283,7 +283,7 @@ public class CVLoader: NSObject {
             thread: thread,
             threadAssociatedData: threadAssociatedData,
             containerView: containerView,
-            spoilerReveal: CVSpoilerReveal(),
+            spoilerReveal: SpoilerRevealState(),
             transaction: transaction
         )
     }
@@ -295,7 +295,7 @@ public class CVLoader: NSObject {
         thread: TSThread,
         threadAssociatedData: ThreadAssociatedData,
         containerView: UIView,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         transaction: SDSAnyReadTransaction
     ) -> CVRenderItem? {
         let chatColor = ChatColors.chatColorForRendering(thread: thread, transaction: transaction)
@@ -322,7 +322,7 @@ public class CVLoader: NSObject {
         thread: TSThread,
         threadAssociatedData: ThreadAssociatedData,
         conversationStyle: ConversationStyle,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         transaction: SDSAnyReadTransaction
     ) -> CVRenderItem? {
         let coreState = CVCoreState(
@@ -344,7 +344,7 @@ public class CVLoader: NSObject {
         thread: TSThread,
         threadAssociatedData: ThreadAssociatedData,
         coreState: CVCoreState,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         transaction: SDSAnyReadTransaction
     ) -> CVRenderItem? {
         AssertIsOnMainThread()
@@ -379,7 +379,7 @@ public class CVLoader: NSObject {
 
     public static func buildStandaloneComponentState(
         interaction: TSInteraction,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         transaction: SDSAnyReadTransaction
     ) -> CVComponentState? {
         AssertIsOnMainThread()
diff --git a/Signal/src/ViewControllers/ConversationView/CV/CVViewStateSnapshot.swift b/Signal/src/ViewControllers/ConversationView/CV/CVViewStateSnapshot.swift
index 9eec11afa1e..fdc4867c068 100644
--- a/Signal/src/ViewControllers/ConversationView/CV/CVViewStateSnapshot.swift
+++ b/Signal/src/ViewControllers/ConversationView/CV/CVViewStateSnapshot.swift
@@ -10,7 +10,7 @@ import Foundation
 struct CVViewStateSnapshot: Dependencies {
 
     let textExpansion: CVTextExpansion
-    let spoilerReveal: CVSpoilerReveal
+    let spoilerReveal: SpoilerRevealState
     let messageSwipeActionState: CVMessageSwipeActionState
 
     // We can only measure (configure) with a given ConversationStyle.
@@ -57,7 +57,7 @@ struct CVViewStateSnapshot: Dependencies {
 
     static func mockSnapshotForStandaloneItems(
         coreState: CVCoreState,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) -> CVViewStateSnapshot {
         CVViewStateSnapshot(
             textExpansion: CVTextExpansion(),
diff --git a/Signal/src/ViewControllers/ConversationView/CVViewState.swift b/Signal/src/ViewControllers/ConversationView/CVViewState.swift
index 09aec77f7cc..3cfaf5a1f5a 100644
--- a/Signal/src/ViewControllers/ConversationView/CVViewState.swift
+++ b/Signal/src/ViewControllers/ConversationView/CVViewState.swift
@@ -80,7 +80,7 @@ public class CVViewState: NSObject {
 
     public let selectionState = CVSelectionState()
     public let textExpansion = CVTextExpansion()
-    public let spoilerReveal = CVSpoilerReveal()
+    public let spoilerReveal = SpoilerRevealState()
     public let messageSwipeActionState = CVMessageSwipeActionState()
 
     public var isDarkThemeEnabled: Bool = Theme.isDarkThemeEnabled
@@ -409,97 +409,6 @@ public class CVTextExpansion {
 
 // MARK: -
 
-public protocol CVSpoilerObserver: NSObjectProtocol {
-    func didUpdateRevealedSpoilers()
-}
-
-@objc
-public class CVSpoilerReveal: NSObject {
-    private var revealedSpoilerIdsByMessage = [CVInteractionIdentifier: Set<StyleIdType>]()
-
-    /// Returns the set of IDs in the ordered list of spoiler ranges for a given message that
-    /// should be revealed.
-    public func revealedSpoilerIds(
-        interactionIdentifier: CVInteractionIdentifier
-    ) -> Set<StyleIdType> {
-        return revealedSpoilerIdsByMessage[interactionIdentifier] ?? []
-    }
-
-    public func setSpoilerRevealed(
-        withID id: StyleIdType,
-        interactionIdentifier: CVInteractionIdentifier
-    ) {
-        var revealedIds = revealedSpoilerIdsByMessage[interactionIdentifier] ?? Set()
-        revealedIds.insert(id)
-        revealedSpoilerIdsByMessage[interactionIdentifier] = revealedIds
-        observers[interactionIdentifier]?.forEach {
-            $0.value?.didUpdateRevealedSpoilers()
-        }
-    }
-
-    private var observers = [CVInteractionIdentifier: [Weak<CVSpoilerObserver>]]()
-
-    public func observeChanges(
-        for interactionIdentifier: CVInteractionIdentifier,
-        observer: CVSpoilerObserver
-    ) {
-        var observers = observers[interactionIdentifier] ?? []
-        guard !observers.contains(where: {
-            $0.value === observer
-        }) else {
-            return
-        }
-        observers.append(Weak(value: observer))
-        self.observers[interactionIdentifier] = observers
-    }
-
-    public func removeObserver(
-        for interactionIdentifier: CVInteractionIdentifier,
-        observer: CVSpoilerObserver
-    ) {
-        var observers = observers[interactionIdentifier] ?? []
-        observers.removeAll(where: {
-            $0.value === observer
-        })
-        self.observers[interactionIdentifier] = observers
-    }
-
-    func copy() -> CVSpoilerReveal {
-        let returnValue = CVSpoilerReveal()
-        returnValue.revealedSpoilerIdsByMessage = revealedSpoilerIdsByMessage
-        return returnValue
-    }
-
-    public override func isEqual(_ object: Any?) -> Bool {
-        let lhs = self
-        guard let rhs = object as? CVSpoilerReveal else {
-            return false
-        }
-        guard lhs.revealedSpoilerIdsByMessage == rhs.revealedSpoilerIdsByMessage else {
-            return false
-        }
-        guard lhs.observers.count == rhs.observers.count else {
-            return false
-        }
-        for key in lhs.observers.keys {
-            guard let lhsObs = lhs.observers[key], let rhsObs = rhs.observers[key] else {
-                return false
-            }
-            guard lhsObs.count == rhsObs.count else {
-                return false
-            }
-            for i in 0..<lhsObs.count {
-                guard lhsObs[i].value === rhsObs[i].value else {
-                    return false
-                }
-            }
-        }
-        return true
-    }
-}
-
-// MARK: -
-
 public class CVMessageSwipeActionState {
     public struct Progress {
         let xOffset: CGFloat
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.h b/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.h
index 634beb5167f..fdb54f64b50 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.h
+++ b/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.h
@@ -5,10 +5,10 @@
 
 NS_ASSUME_NONNULL_BEGIN
 
-@class CVSpoilerReveal;
 @class ConversationStyle;
 @class DisplayableText;
 @class OWSQuotedReplyModel;
+@class SpoilerRevealState;
 @class TSAttachmentPointer;
 @class TSQuotedMessage;
 
@@ -39,7 +39,7 @@ NS_ASSUME_NONNULL_BEGIN
 - (instancetype)initWithQuotedMessage:(OWSQuotedReplyModel *)quotedMessage
                 displayableQuotedText:(nullable DisplayableText *)displayableQuotedText
                     conversationStyle:(ConversationStyle *)conversationStyle
-                        spoilerReveal:(CVSpoilerReveal *)spoilerReveal;
+                        spoilerReveal:(SpoilerRevealState *)spoilerReveal;
 
 @end
 
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.m b/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.m
index 4c898a8087c..e91d0e55ad7 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.m
+++ b/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.m
@@ -24,7 +24,7 @@ @interface OWSQuotedMessageView ()
 @property (nonatomic, readonly) OWSQuotedReplyModel *quotedMessage;
 @property (nonatomic, nullable, readonly) DisplayableText *displayableQuotedText;
 @property (nonatomic, readonly) ConversationStyle *conversationStyle;
-@property (nonatomic, readonly) CVSpoilerReveal *spoilerReveal;
+@property (nonatomic, readonly) SpoilerRevealState *spoilerReveal;
 
 @property (nonatomic, readonly) UILabel *quotedAuthorLabel;
 @property (nonatomic, readonly) UILabel *quotedTextLabel;
@@ -39,7 +39,7 @@ @implementation OWSQuotedMessageView
 - (instancetype)initWithQuotedMessage:(OWSQuotedReplyModel *)quotedMessage
                 displayableQuotedText:(nullable DisplayableText *)displayableQuotedText
                     conversationStyle:(ConversationStyle *)conversationStyle
-                        spoilerReveal:(CVSpoilerReveal *)spoilerReveal
+                        spoilerReveal:(SpoilerRevealState *)spoilerReveal
 {
     self = [super init];
 
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.swift b/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.swift
index 6fbba2e3500..27dfc74b54b 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.swift
+++ b/Signal/src/ViewControllers/ConversationView/Cells/OWSQuotedMessageView.swift
@@ -10,7 +10,7 @@ extension OWSQuotedMessageView {
     static func forPreview(
         _ quotedMessage: OWSQuotedReplyModel,
         conversationStyle: ConversationStyle,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) -> OWSQuotedMessageView {
 
         let displayableQuotedText: DisplayableText?
@@ -34,7 +34,7 @@ extension OWSQuotedMessageView {
 
     static func displayableTextWithSneakyTransaction(
         forPreview quotedMessage: OWSQuotedReplyModel,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) -> DisplayableText? {
         guard let text = quotedMessage.body else {
             return nil
@@ -46,7 +46,7 @@ extension OWSQuotedMessageView {
                 displayConfig: HydratedMessageBody.DisplayConfiguration(
                     mention: .quotedReply,
                     style: .quotedReply(revealedSpoilerIds: spoilerReveal.revealedSpoilerIds(
-                        interactionIdentifier: CVInteractionIdentifier(
+                        interactionIdentifier: InteractionSnapshotIdentifier(
                             timestamp: quotedMessage.timestamp,
                             authorUuid: quotedMessage.authorAddress.uuidString
                         )
@@ -64,7 +64,7 @@ extension OWSQuotedMessageView {
         font: UIFont,
         textColor: UIColor,
         quotedReplyModel: OWSQuotedReplyModel,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) -> NSAttributedString {
         let mutableCopy = NSMutableAttributedString(attributedString: displayableQuotedText.displayAttributedText)
         mutableCopy.addAttributesToEntireString([
@@ -85,7 +85,7 @@ extension OWSQuotedMessageView {
                         textColor: .fixed(textColor),
                         revealAllIds: false,
                         revealedIds: spoilerReveal.revealedSpoilerIds(
-                            interactionIdentifier: CVInteractionIdentifier(
+                            interactionIdentifier: InteractionSnapshotIdentifier(
                                 timestamp: quotedReplyModel.timestamp,
                                 authorUuid: quotedReplyModel.authorAddress.uuidString
                             )
diff --git a/Signal/src/ViewControllers/ConversationView/Cells/QuotedMessageView.swift b/Signal/src/ViewControllers/ConversationView/Cells/QuotedMessageView.swift
index 3b93ba235ff..8dd64eaba77 100644
--- a/Signal/src/ViewControllers/ConversationView/Cells/QuotedMessageView.swift
+++ b/Signal/src/ViewControllers/ConversationView/Cells/QuotedMessageView.swift
@@ -25,13 +25,13 @@ public class QuotedMessageView: ManualStackViewWithLayer {
         let quotedReplyModel: OWSQuotedReplyModel
         let displayableQuotedText: DisplayableText?
         let conversationStyle: ConversationStyle
-        let spoilerReveal: CVSpoilerReveal
+        let spoilerReveal: SpoilerRevealState
         let isOutgoing: Bool
         let isForPreview: Bool
         let quotedAuthorName: String
 
-        var quotedInteractionIdentifier: CVInteractionIdentifier {
-            return CVInteractionIdentifier(
+        var quotedInteractionIdentifier: InteractionSnapshotIdentifier {
+            return InteractionSnapshotIdentifier(
                 timestamp: quotedReplyModel.timestamp,
                 authorUuid: quotedReplyModel.authorAddress.uuidString
             )
@@ -65,7 +65,7 @@ public class QuotedMessageView: ManualStackViewWithLayer {
         quotedReplyModel: OWSQuotedReplyModel,
         displayableQuotedText: DisplayableText?,
         conversationStyle: ConversationStyle,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         isOutgoing: Bool,
         transaction: SDSAnyReadTransaction
     ) -> State {
@@ -85,7 +85,7 @@ public class QuotedMessageView: ManualStackViewWithLayer {
     static func stateForPreview(
         quotedReplyModel: OWSQuotedReplyModel,
         conversationStyle: ConversationStyle,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         transaction: SDSAnyReadTransaction
     ) -> State {
 
@@ -100,7 +100,7 @@ public class QuotedMessageView: ManualStackViewWithLayer {
                 displayConfig: HydratedMessageBody.DisplayConfiguration(
                     mention: .quotedReply,
                     style: .quotedReply(revealedSpoilerIds: spoilerReveal.revealedSpoilerIds(
-                        interactionIdentifier: CVInteractionIdentifier(
+                        interactionIdentifier: InteractionSnapshotIdentifier(
                             timestamp: quotedReplyModel.timestamp,
                             authorUuid: quotedReplyModel.authorAddress.uuidString
                         )
@@ -917,7 +917,7 @@ public class QuotedMessageView: ManualStackViewWithLayer {
     }
 }
 
-extension QuotedMessageView: CVSpoilerObserver {
+extension QuotedMessageView: SpoilerRevealStateObserver {
     public func didUpdateRevealedSpoilers() {
         guard let state else {
             return
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.swift b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.swift
index ea4b43d495e..1b61c6d8cfc 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.swift
+++ b/Signal/src/ViewControllers/ConversationView/ConversationInputToolbar.swift
@@ -60,7 +60,7 @@ protocol ConversationInputToolbarDelegate: AnyObject {
 public class ConversationInputToolbar: UIView, LinkPreviewViewDraftDelegate, QuotedReplyPreviewDelegate {
 
     private var conversationStyle: ConversationStyle
-    private let spoilerReveal: CVSpoilerReveal
+    private let spoilerReveal: SpoilerRevealState
 
     private let mediaCache: CVMediaCache
 
@@ -68,7 +68,7 @@ public class ConversationInputToolbar: UIView, LinkPreviewViewDraftDelegate, Quo
 
     init(
         conversationStyle: ConversationStyle,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         mediaCache: CVMediaCache,
         messageDraft: MessageBody?,
         quotedReply: OWSQuotedReplyModel?,
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationViewController+CVComponentDelegate.swift b/Signal/src/ViewControllers/ConversationView/ConversationViewController+CVComponentDelegate.swift
index 30a8df9c0aa..54394d0cdeb 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationViewController+CVComponentDelegate.swift
+++ b/Signal/src/ViewControllers/ConversationView/ConversationViewController+CVComponentDelegate.swift
@@ -205,8 +205,11 @@ extension ConversationViewController: CVComponentDelegate {
 
         dismissKeyBoard()
 
-        let pageVC = MediaPageViewController(initialMediaAttachment: attachmentStream,
-                                             thread: self.thread)
+        let pageVC = MediaPageViewController(
+            initialMediaAttachment: attachmentStream,
+            thread: self.thread,
+            spoilerReveal: self.viewState.spoilerReveal
+        )
         self.present(pageVC, animated: true, completion: nil)
     }
 
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationViewController+Misc.swift b/Signal/src/ViewControllers/ConversationView/ConversationViewController+Misc.swift
index 6e14a16f1a3..038c692450d 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationViewController+Misc.swift
+++ b/Signal/src/ViewControllers/ConversationView/ConversationViewController+Misc.swift
@@ -235,7 +235,10 @@ public extension ConversationViewController {
         }
         var viewControllers = viewControllersUpToSelf
 
-        let settingsView = ConversationSettingsViewController(threadViewModel: threadViewModel)
+        let settingsView = ConversationSettingsViewController(
+            threadViewModel: threadViewModel,
+            spoilerReveal: viewState.spoilerReveal
+        )
         settingsView.conversationSettingsViewDelegate = self
         viewControllers.append(settingsView)
 
@@ -249,7 +252,11 @@ public extension ConversationViewController {
                 viewControllers.append(view)
             }
         case .showAllMedia:
-            viewControllers.append(AllMediaViewController(thread: thread, name: title))
+            viewControllers.append(AllMediaViewController(
+                thread: thread,
+                spoilerReveal: viewState.spoilerReveal,
+                name: title
+            ))
         }
 
         navigationController?.setViewControllers(viewControllers, animated: true)
diff --git a/Signal/src/ViewControllers/ConversationView/ConversationViewController+Selection.swift b/Signal/src/ViewControllers/ConversationView/ConversationViewController+Selection.swift
index 6d41bad13f1..73c0ce64b61 100644
--- a/Signal/src/ViewControllers/ConversationView/ConversationViewController+Selection.swift
+++ b/Signal/src/ViewControllers/ConversationView/ConversationViewController+Selection.swift
@@ -328,7 +328,7 @@ extension ConversationViewController {
             }
             guard let componentState = CVLoader.buildStandaloneComponentState(
                 interaction: interaction,
-                spoilerReveal: CVSpoilerReveal(),
+                spoilerReveal: SpoilerRevealState(),
                 transaction: transaction
             ) else {
                 owsFailDebug("Could not load componentState.")
diff --git a/Signal/src/ViewControllers/ForwardMessageViewController.swift b/Signal/src/ViewControllers/ForwardMessageViewController.swift
index fb3c550ecdc..8dbe3982d42 100644
--- a/Signal/src/ViewControllers/ForwardMessageViewController.swift
+++ b/Signal/src/ViewControllers/ForwardMessageViewController.swift
@@ -909,7 +909,7 @@ private enum ForwardMessageContent {
                                             transaction: SDSAnyReadTransaction) throws -> CVComponentState {
         guard let componentState = CVLoader.buildStandaloneComponentState(
             interaction: interaction,
-            spoilerReveal: CVSpoilerReveal(), // Nothing revealed, doesn't matter.
+            spoilerReveal: SpoilerRevealState(), // Nothing revealed, doesn't matter.
             transaction: transaction
         ) else {
             throw ForwardError.invalidInteraction
diff --git a/Signal/src/ViewControllers/LongTextViewController.swift b/Signal/src/ViewControllers/LongTextViewController.swift
index 6fb856abf5f..2ba1f4f14ba 100644
--- a/Signal/src/ViewControllers/LongTextViewController.swift
+++ b/Signal/src/ViewControllers/LongTextViewController.swift
@@ -21,7 +21,7 @@ public class LongTextViewController: OWSViewController {
 
     let itemViewModel: CVItemViewModelImpl
     let threadViewModel: ThreadViewModel
-    let spoilerReveal: CVSpoilerReveal
+    let spoilerReveal: SpoilerRevealState
 
     var messageTextView: UITextView!
     let footer = UIToolbar.clear()
@@ -36,7 +36,7 @@ public class LongTextViewController: OWSViewController {
     public required init(
         itemViewModel: CVItemViewModelImpl,
         threadViewModel: ThreadViewModel,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) {
         self.itemViewModel = itemViewModel
         self.threadViewModel = threadViewModel
@@ -247,31 +247,10 @@ public class LongTextViewController: OWSViewController {
         }
         let location = sender.location(in: messageTextView)
 
-        let layoutManager = messageTextView.layoutManager
-        let textContainer = messageTextView.textContainer
-        let glyphRange = layoutManager.glyphRange(for: textContainer)
-        let boundingRect = layoutManager.boundingRect(forGlyphRange: glyphRange, in: textContainer)
-        guard boundingRect.contains(location) else {
+        guard let characterIndex = messageTextView.characterIndex(of: location) else {
             return
         }
 
-        let glyphIndex = layoutManager.glyphIndex(for: location, in: textContainer)
-
-        // We have the _closest_ index, but that doesn't mean we tapped in a glyph.
-        // Check that directly.
-        // This will catch the below case, where "*" is the tap location:
-        //
-        // This is the first line that is long.
-        // Tap on the second line.    *
-        //
-        // The bounding rect includes the empty space below the first line,
-        // but the tap doesn't actually lie on any glyph.
-        let glyphRect = layoutManager.boundingRect(forGlyphRange: NSRange(location: glyphIndex, length: 1), in: textContainer)
-        guard glyphRect.contains(location) else {
-            return
-        }
-        let characterIndex = layoutManager.characterIndexForGlyph(at: glyphIndex)
-
         for item in linkItems {
             if item.range.contains(characterIndex) {
                 switch item {
diff --git a/Signal/src/ViewControllers/MediaGallery/AllMediaViewController.swift b/Signal/src/ViewControllers/MediaGallery/AllMediaViewController.swift
index 5ffc31e64e9..a01d4b0a7fd 100644
--- a/Signal/src/ViewControllers/MediaGallery/AllMediaViewController.swift
+++ b/Signal/src/ViewControllers/MediaGallery/AllMediaViewController.swift
@@ -16,9 +16,17 @@ class AllMediaViewController: OWSViewController {
         return tileViewController.navigationItem
     }
 
-    init(thread: TSThread, name: String?) {
+    init(
+        thread: TSThread,
+        spoilerReveal: SpoilerRevealState,
+        name: String?
+    ) {
         self.name = name
-        tileViewController = MediaTileViewController(thread: thread, accessoriesHelper: accessoriesHelper)
+        tileViewController = MediaTileViewController(
+            thread: thread,
+            accessoriesHelper: accessoriesHelper,
+            spoilerReveal: spoilerReveal
+        )
         super.init()
         accessoriesHelper.viewController = tileViewController
     }
diff --git a/Signal/src/ViewControllers/MediaGallery/MediaCaptionView.swift b/Signal/src/ViewControllers/MediaGallery/MediaCaptionView.swift
index 98bb73965c0..936337eba6b 100644
--- a/Signal/src/ViewControllers/MediaGallery/MediaCaptionView.swift
+++ b/Signal/src/ViewControllers/MediaGallery/MediaCaptionView.swift
@@ -5,11 +5,73 @@
 
 import SignalUI
 
-class MediaCaptionView: UIView {
+class MediaCaptionView: UIView, SpoilerRevealStateObserver {
+
+    private let spoilerReveal: SpoilerRevealState
+
+    public enum Content: Equatable {
+        case attachmentStreamCaption(String)
+        case messageBody(HydratedMessageBody, InteractionSnapshotIdentifier)
+
+        func attributedString(spoilerReveal: SpoilerRevealState) -> NSAttributedString {
+            switch self {
+            case .attachmentStreamCaption(let string):
+                return NSAttributedString(string: string)
+            case .messageBody(let messageBody, let interactionIdentifier):
+                return messageBody.asAttributedStringForDisplay(
+                    config: HydratedMessageBody.DisplayConfiguration(
+                        mention: .mediaCaption,
+                        style: .mediaCaption(revealedSpoilerIds: spoilerReveal.revealedSpoilerIds(interactionIdentifier: interactionIdentifier)),
+                        searchRanges: nil
+                    ),
+                    baseAttributes: [
+                        .font: MentionDisplayConfiguration.mediaCaption.font,
+                        .foregroundColor: MentionDisplayConfiguration.mediaCaption.foregroundColor.forCurrentTheme
+                    ],
+                    isDarkThemeEnabled: Theme.isDarkThemeEnabled
+                )
+            }
+        }
 
-    var text: String? {
-        get { captionTextView.text }
-        set { captionTextView.text = newValue }
+        var nilIfEmpty: Content? {
+            switch self {
+            case .attachmentStreamCaption(let string):
+                return string.isEmpty ? nil : self
+            case .messageBody(let messageBody, let identifier):
+                return messageBody.nilIfEmpty.map { .messageBody($0, identifier) }
+            }
+        }
+
+        var interactionIdentifier: InteractionSnapshotIdentifier? {
+            switch self {
+            case .attachmentStreamCaption:
+                return nil
+            case .messageBody(_, let id):
+                return id
+            }
+        }
+    }
+
+    var content: Content? {
+        didSet {
+            guard content != oldValue else {
+                return
+            }
+            captionTextView.attributedText = content?.attributedString(spoilerReveal: spoilerReveal)
+
+            if oldValue?.interactionIdentifier != content?.interactionIdentifier {
+                oldValue?.interactionIdentifier.map {
+                    spoilerReveal.removeObserver(for: $0, observer: self)
+                }
+                content?.interactionIdentifier.map {
+                    spoilerReveal.observeChanges(for: $0, observer: self)
+                }
+            }
+        }
+    }
+
+    var hasNilOrEmptyContent: Bool {
+        return content?.nilIfEmpty == nil
     }
 
     var canBeExpanded: Bool {
@@ -25,9 +87,9 @@ class MediaCaptionView: UIView {
 
     private(set) var isTransitionInProgress: Bool = false
 
-    func beginInteractiveTransition(text: String?) {
+    func beginInteractiveTransition(content: Content?) {
         // Do not start the transition if next item's caption is the same as current one's.
-        guard self.text != text else {
+        guard self.content != content else {
             owsAssertDebug(!isTransitionInProgress)
             isTransitionInProgress = false
             return
@@ -35,7 +97,7 @@ class MediaCaptionView: UIView {
 
         isTransitionInProgress = true
         heightConstraint.isActive = true
-        pendingCaptionTextView.text = text
+        pendingCaptionTextView.attributedText = content?.attributedString(spoilerReveal: spoilerReveal)
         updateTransitionProgress(0)
     }
 
@@ -79,7 +141,11 @@ class MediaCaptionView: UIView {
 
     // MARK: Initializers
 
-    override init(frame: CGRect) {
+    init(
+        frame: CGRect = .zero,
+        spoilerReveal: SpoilerRevealState
+    ) {
+        self.spoilerReveal = spoilerReveal
         super.init(frame: frame)
 
         preservesSuperviewLayoutMargins = true
@@ -109,20 +175,67 @@ class MediaCaptionView: UIView {
         fatalError("init(coder:) has not been implemented")
     }
 
+    func handleTap(_ gestureRecognizer: UITapGestureRecognizer) -> Bool {
+        guard !isTransitionInProgress else { return false }
+
+        let messageBody: HydratedMessageBody
+        let interactionIdentifier: InteractionSnapshotIdentifier
+        switch content {
+        case .none, .attachmentStreamCaption:
+            return false
+        case .messageBody(let body, let id):
+            messageBody = body
+            interactionIdentifier = id
+        }
+
+        let location = gestureRecognizer.location(in: captionTextView).offsetBy(
+            dx: -Self.captionTextContainerInsets.left,
+            dy: -Self.captionTextContainerInsets.top
+        )
+        guard let characterIndex = captionTextView.characterIndex(of: location) else {
+            return false
+        }
+
+        for item in messageBody.tappableItems(
+            revealedSpoilerIds: spoilerReveal.revealedSpoilerIds(interactionIdentifier: interactionIdentifier),
+            dataDetector: nil /* Maybe in the future we should detect links here. We never have, before. */
+        ) {
+            switch item {
+            case .data, .mention:
+                continue
+            case .unrevealedSpoiler(let unrevealedSpoiler):
+                if unrevealedSpoiler.range.contains(characterIndex) {
+                    spoilerReveal.setSpoilerRevealed(
+                        withID: unrevealedSpoiler.id,
+                        interactionIdentifier: interactionIdentifier
+                    )
+                    return true
+                }
+            }
+        }
+        return false
+    }
+
+    func didUpdateRevealedSpoilers() {
+        captionTextView.attributedText = content?.attributedString(spoilerReveal: spoilerReveal)
+    }
+
     // MARK: Subviews
 
+    private static let captionTextContainerInsets = UIEdgeInsets(top: 16, leading: 0, bottom: 16, trailing: 0)
+
     private class func buildCaptionTextView() -> CaptionTextView {
         let textView = CaptionTextView()
-        textView.font = UIFont.dynamicTypeBodyClamped
-        textView.textColor = .white
+        textView.font = MentionDisplayConfiguration.mediaCaption.font
+        textView.textColor = MentionDisplayConfiguration.mediaCaption.foregroundColor.forCurrentTheme
         textView.backgroundColor = .clear
-        textView.textContainerInset = UIEdgeInsets(top: 16, leading: 0, bottom: 16, trailing: 0)
+        textView.textContainerInset = Self.captionTextContainerInsets
         return textView
     }
     private var captionTextView = MediaCaptionView.buildCaptionTextView()
     private var pendingCaptionTextView = MediaCaptionView.buildCaptionTextView()
 
-    private class CaptionTextView: UITextView {
+    private class CaptionTextView: UITextView, NSLayoutManagerDelegate {
 
         override init(frame: CGRect, textContainer: NSTextContainer?) {
             super.init(frame: frame, textContainer: textContainer)
@@ -130,6 +243,7 @@ class MediaCaptionView: UIView {
             isEditable = false
             isSelectable = false
             self.textContainer.lineBreakMode = .byTruncatingTail
+            self.layoutManager.delegate = self
             updateIsScrollEnabled()
         }
 
@@ -137,6 +251,19 @@ class MediaCaptionView: UIView {
             fatalError("init(coder:) has not been implemented")
         }
 
+        private var originalAttributedText: NSAttributedString?
+
+        override var attributedText: NSAttributedString! {
+            get {
+                return super.attributedText
+            }
+            set {
+                self.originalAttributedText = newValue
+                super.attributedText = newValue
+                invalidateCachedSizes()
+            }
+        }
+
         override var text: String! {
             didSet {
                 invalidateCachedSizes()
@@ -181,6 +308,7 @@ class MediaCaptionView: UIView {
                 guard _isExpanded != newValue else { return }
                 _isExpanded = canBeExpanded ? newValue : false
                 invalidateIntrinsicContentSize()
+                needsTruncationComputation = true
                 updateIsScrollEnabled()
             }
         }
@@ -216,6 +344,7 @@ class MediaCaptionView: UIView {
             collapsedSize = .zero
             expandedSize = .zero
             fullSize = .zero
+            needsTruncationComputation = true
 
             invalidateIntrinsicContentSize()
         }
@@ -271,5 +400,67 @@ class MediaCaptionView: UIView {
             )
             fullSize = CVTextLabel.measureSize(config: fullTextConfig, maxWidth: maxWidth).size
         }
+
+        func layoutManager(
+            _ layoutManager: NSLayoutManager,
+            didCompleteLayoutFor textContainer: NSTextContainer?,
+            atEnd layoutFinishedFlag: Bool
+        ) {
+            reapplyTruncationIndexIfNecessary()
+        }
+
+        private var needsTruncationComputation = true
+
+        /// This madness is necessary because of a bug in UITextView; any .backgroundColor attributes
+        /// on a UITextView's attributedText property misbehave when truncated. They get applied to
+        /// the truncation character (an ellipses) when the range containing them is cut off.
+        /// To remedy this, we find the truncation point, and reset our attributed string past that
+        /// point, removing all its attributes except font size (for sizing) and foreground color
+        /// (so the ellipses is the right color).
+        /// We have to then watch for when we do this computation again, basically whenever
+        /// the bounds or contents change.
+        private func reapplyTruncationIndexIfNecessary() {
+            guard
+                needsTruncationComputation,
+                let attributedText = originalAttributedText
+            else {
+                return
+            }
+            let entireGlyphRange = layoutManager.glyphRange(for: textContainer)
+            var lastLineLocation = -1
+            layoutManager.enumerateLineFragments(
+                forGlyphRange: entireGlyphRange,
+                using: { _, _, _, range, _ in
+                    lastLineLocation = range.location
+                }
+            )
+            guard lastLineLocation != -1 else {
+                return
+            }
+            let truncationGlyphIndex = layoutManager.truncatedGlyphRange(inLineFragmentForGlyphAt: lastLineLocation).location
+            guard truncationGlyphIndex > 0, truncationGlyphIndex < entireGlyphRange.upperBound - 1 else {
+                super.attributedText = attributedText
+                return
+            }
+            let truncationIndex = layoutManager.characterIndexForGlyph(at: truncationGlyphIndex)
+            guard truncationIndex > 0, truncationIndex < attributedText.length - 1 else {
+                super.attributedText = attributedText
+                return
+            }
+            needsTruncationComputation = false
+            super.attributedText = attributedText.attributedSubstring(
+                from: NSRange(
+                    location: 0,
+                    length: truncationIndex
+                )
+            ) + NSAttributedString(
+                string: attributedText.string.substring(from: truncationIndex),
+                attributes: [
+                    .font: MentionDisplayConfiguration.mediaCaption.font,
+                    .foregroundColor: MentionDisplayConfiguration.mediaCaption.foregroundColor.forCurrentTheme
+                ]
+            )
+            calculateSizesIfNecessary()
+        }
     }
 }
diff --git a/Signal/src/ViewControllers/MediaGallery/MediaGallery.swift b/Signal/src/ViewControllers/MediaGallery/MediaGallery.swift
index f19d27200e6..a88876e270f 100644
--- a/Signal/src/ViewControllers/MediaGallery/MediaGallery.swift
+++ b/Signal/src/ViewControllers/MediaGallery/MediaGallery.swift
@@ -41,14 +41,16 @@ public class MediaGalleryItem: Equatable, Hashable, MediaGallerySectionItem {
     let attachmentStream: TSAttachmentStream
 
     let galleryDate: GalleryDate
-    let captionForDisplay: String?
+    let captionForDisplay: MediaCaptionView.Content?
     let albumIndex: Int
     let orderingKey: MediaGalleryItemOrderingKey
 
     init(
         message: TSMessage,
         sender: Sender?,
-        attachmentStream: TSAttachmentStream
+        attachmentStream: TSAttachmentStream,
+        spoilerReveal: SpoilerRevealState,
+        transaction: SDSAnyReadTransaction
     ) {
         self.message = message
         self.sender = sender
@@ -57,9 +59,17 @@ public class MediaGalleryItem: Equatable, Hashable, MediaGallerySectionItem {
         self.albumIndex = message.attachmentIds.firstIndex(of: attachmentStream.uniqueId) ?? 0
         self.orderingKey = MediaGalleryItemOrderingKey(messageSortKey: message.sortId, attachmentSortKey: albumIndex)
         if let captionText = attachmentStream.caption?.filterForDisplay {
-            self.captionForDisplay = captionText
+            self.captionForDisplay = .attachmentStreamCaption(captionText)
+        } else if let body = message.body {
+            let hydratedMessageBody = MessageBody(
+                text: body,
+                ranges: message.bodyRanges ?? .empty
+            ).hydrating(
+                mentionHydrator: ContactsMentionHydrator.mentionHydrator(transaction: transaction.asV2Read)
+            )
+            self.captionForDisplay = .messageBody(hydratedMessageBody, .fromInteraction(message))
         } else {
-            self.captionForDisplay = message.body?.filterForDisplay
+            self.captionForDisplay = nil
         }
     }
 
@@ -252,15 +262,17 @@ class MediaGallery: Dependencies {
 
     private var mediaGalleryFinder: MediaGalleryFinder
     private var sections: Sections!
+    private let spoilerReveal: SpoilerRevealState
 
     deinit {
         Logger.debug("")
     }
 
     @objc
-    init(thread: TSThread) {
+    init(thread: TSThread, spoilerReveal: SpoilerRevealState) {
         let finder = MediaGalleryFinder(thread: thread, allowedMediaType: nil)
         self.mediaGalleryFinder = finder
+        self.spoilerReveal = spoilerReveal
         self.sections = MediaGallerySections(loader: Loader(mediaGallery: self, finder: finder))
         NotificationCenter.default.addObserver(self,
                                                selector: #selector(Self.newAttachmentsAvailable(_:)),
@@ -388,7 +400,11 @@ class MediaGallery: Dependencies {
     internal var hasFetchedMostRecent: Bool { sections.hasFetchedMostRecent }
     internal var galleryDates: [GalleryDate] { sections.sectionDates }
 
-    private func buildGalleryItem(attachment: TSAttachment, transaction: SDSAnyReadTransaction) -> MediaGalleryItem? {
+    private func buildGalleryItem(
+        attachment: TSAttachment,
+        spoilerReveal: SpoilerRevealState,
+        transaction: SDSAnyReadTransaction
+    ) -> MediaGalleryItem? {
         guard let attachmentStream = attachment as? TSAttachmentStream else {
             owsFailDebug("gallery doesn't yet support showing undownloaded attachments")
             return nil
@@ -436,7 +452,9 @@ class MediaGallery: Dependencies {
         return MediaGalleryItem(
             message: message,
             sender: sender,
-            attachmentStream: attachmentStream
+            attachmentStream: attachmentStream,
+            spoilerReveal: spoilerReveal,
+            transaction: transaction
         )
     }
 
@@ -550,7 +568,11 @@ class MediaGallery: Dependencies {
     internal func ensureLoadedForDetailView(focusedAttachment: TSAttachment) -> MediaGalleryItem? {
         Logger.info("")
         let newItem: MediaGalleryItem? = databaseStorage.read { transaction -> MediaGalleryItem? in
-            guard let focusedItem = buildGalleryItem(attachment: focusedAttachment, transaction: transaction) else {
+            guard let focusedItem = buildGalleryItem(
+                attachment: focusedAttachment,
+                spoilerReveal: spoilerReveal,
+                transaction: transaction
+            ) else {
                 return nil
             }
 
@@ -897,8 +919,11 @@ extension MediaGallery {
                 transaction: transaction.unwrapGrdbRead
             ) { offset, attachment in
                 block(offset, attachment.uniqueId) {
-                    guard let item: MediaGalleryItem = mediaGallery.buildGalleryItem(attachment: attachment,
-                                                                                     transaction: transaction) else {
+                    guard let item: MediaGalleryItem = mediaGallery.buildGalleryItem(
+                        attachment: attachment,
+                        spoilerReveal: mediaGallery.spoilerReveal,
+                        transaction: transaction
+                    ) else {
                         owsFail("unexpectedly failed to buildGalleryItem for attachment #\(offset) \(attachment)")
                     }
                     return item
diff --git a/Signal/src/ViewControllers/MediaGallery/MediaPageViewController.swift b/Signal/src/ViewControllers/MediaGallery/MediaPageViewController.swift
index 8193742df33..20d6f46b55f 100644
--- a/Signal/src/ViewControllers/MediaGallery/MediaPageViewController.swift
+++ b/Signal/src/ViewControllers/MediaGallery/MediaPageViewController.swift
@@ -13,17 +13,30 @@ class MediaPageViewController: UIPageViewController {
 
     private let isShowingSingleMessage: Bool
     let mediaGallery: MediaGallery
+    let spoilerReveal: SpoilerRevealState
 
-    convenience init(initialMediaAttachment: TSAttachment, thread: TSThread, showingSingleMessage: Bool = false) {
+    convenience init(
+        initialMediaAttachment: TSAttachment,
+        thread: TSThread,
+        spoilerReveal: SpoilerRevealState,
+        showingSingleMessage: Bool = false
+    ) {
         self.init(
             initialMediaAttachment: initialMediaAttachment,
-            mediaGallery: MediaGallery(thread: thread),
+            mediaGallery: MediaGallery(thread: thread, spoilerReveal: spoilerReveal),
+            spoilerReveal: spoilerReveal,
             showingSingleMessage: showingSingleMessage
         )
     }
 
-    init(initialMediaAttachment: TSAttachment, mediaGallery: MediaGallery, showingSingleMessage: Bool = false) {
+    init(
+        initialMediaAttachment: TSAttachment,
+        mediaGallery: MediaGallery,
+        spoilerReveal: SpoilerRevealState,
+        showingSingleMessage: Bool = false
+    ) {
         self.mediaGallery = mediaGallery
+        self.spoilerReveal = spoilerReveal
         self.isShowingSingleMessage = showingSingleMessage
 
         super.init(
@@ -91,7 +104,7 @@ class MediaPageViewController: UIPageViewController {
     private var footerBarHeight: CGFloat { topBarHeight }
     private var footerBarHeightConstraint: NSLayoutConstraint?
 
-    private lazy var captionView = MediaCaptionView()
+    private lazy var captionView = MediaCaptionView(spoilerReveal: spoilerReveal)
     private lazy var galleryRailView: GalleryRailView = {
         let view = GalleryRailView()
         view.delegate = self
@@ -212,7 +225,7 @@ class MediaPageViewController: UIPageViewController {
         verticalSwipe.direction = [.up, .down]
         view.addGestureRecognizer(verticalSwipe)
 
-        captionView.addGestureRecognizer(UITapGestureRecognizer(target: self, action: #selector(toggleCaptionBoxIsExpanded)))
+        captionView.addGestureRecognizer(UITapGestureRecognizer(target: self, action: #selector(didTapCaption)))
     }
 
     override func viewWillTransition(to size: CGSize, with coordinator: UIViewControllerTransitionCoordinator) {
@@ -526,7 +539,7 @@ class MediaPageViewController: UIPageViewController {
 
         let animateChanges = view.window != nil
         if traitCollection.verticalSizeClass == .compact {
-            let noCaption = captionView.text.isEmptyOrNil
+            let noCaption = captionView.hasNilOrEmptyContent
             let mediaRailHidden = galleryRailView.isHiddenInStackView
             let videoPlaybackControlsHidden = videoPlaybackControlView?.isHiddenInStackView ?? true
             bottomPanel.setIsHidden(noCaption && mediaRailHidden && videoPlaybackControlsHidden, animated: animateChanges)
@@ -552,7 +565,7 @@ class MediaPageViewController: UIPageViewController {
         }
 
         let isLandscapeLayout = traitCollection.verticalSizeClass == .compact
-        galleryRailView.layoutMargins.top = captionView.text.isEmptyOrNil ? 20 : 4
+        galleryRailView.layoutMargins.top = captionView.hasNilOrEmptyContent ? 20 : 4
         galleryRailView.hidesAutomatically = !isLandscapeLayout
         galleryRailView.configureCellViews(
             itemProvider: mostRecentAlbum!,
@@ -787,12 +800,19 @@ class MediaPageViewController: UIPageViewController {
     // MARK: Caption Box
 
     private func updateCaption() {
-        captionView.text = currentItem.captionForDisplay
+        captionView.content = currentItem.captionForDisplay
     }
 
     @objc
-    private func toggleCaptionBoxIsExpanded(_ gestureRecognizer: UITapGestureRecognizer) {
-        guard !captionView.isTransitionInProgress, captionView.canBeExpanded else { return }
+    private func didTapCaption(_ gestureRecognizer: UITapGestureRecognizer) {
+        guard !captionView.isTransitionInProgress else { return }
+
+        // Let the view handle first; if it does, exit.
+        if captionView.handleTap(gestureRecognizer) {
+            return
+        }
+
+        guard captionView.canBeExpanded else { return }
 
         let animator = UIViewPropertyAnimator(duration: 0.25, springDamping: 0.645, springResponse: 0.25)
         animator.addAnimations {
@@ -816,7 +836,7 @@ extension MediaPageViewController: UIPageViewControllerDelegate {
             return
         }
 
-        captionView.beginInteractiveTransition(text: pendingViewController.galleryItem.captionForDisplay?.nilIfEmpty)
+        captionView.beginInteractiveTransition(content: pendingViewController.galleryItem.captionForDisplay?.nilIfEmpty)
     }
 
     func pageViewController(
diff --git a/Signal/src/ViewControllers/MediaGallery/MediaTileViewController.swift b/Signal/src/ViewControllers/MediaGallery/MediaTileViewController.swift
index 93127866bb0..04b0a69af09 100644
--- a/Signal/src/ViewControllers/MediaGallery/MediaTileViewController.swift
+++ b/Signal/src/ViewControllers/MediaGallery/MediaTileViewController.swift
@@ -69,10 +69,13 @@ extension MediaTileViewController: MediaGalleryCollectionViewUpdaterDelegate {
 public class MediaTileViewController: UICollectionViewController, MediaGalleryDelegate, UICollectionViewDelegateFlowLayout {
     private typealias Cell = (UICollectionViewCell & MediaTileCell)
     typealias Layout = UICollectionViewFlowLayout & ScrollPositionPreserving
+
     private let thread: TSThread
     private let accessoriesHelper: MediaGalleryAccessoriesHelper
+    private let spoilerReveal: SpoilerRevealState
+
     private lazy var mediaGallery: MediaGallery = {
-        let mediaGallery = MediaGallery(thread: thread)
+        let mediaGallery = MediaGallery(thread: thread, spoilerReveal: spoilerReveal)
         mediaGallery.addDelegate(self)
         return mediaGallery
     }()
@@ -109,9 +112,14 @@ public class MediaTileViewController: UICollectionViewController, MediaGalleryDe
     }
     private var toolbarHeight = CGFloat(0)
 
-    public init(thread: TSThread, accessoriesHelper: MediaGalleryAccessoriesHelper) {
+    public init(
+        thread: TSThread,
+        accessoriesHelper: MediaGalleryAccessoriesHelper,
+        spoilerReveal: SpoilerRevealState
+    ) {
         self.thread = thread
         self.accessoriesHelper = accessoriesHelper
+        self.spoilerReveal = spoilerReveal
         let layout: Layout = Self.buildLayout(mode: mode)
         self.mediaTileViewLayout = layout
 
@@ -536,7 +544,8 @@ public class MediaTileViewController: UICollectionViewController, MediaGalleryDe
 
             let pageVC = MediaPageViewController(
                 initialMediaAttachment: galleryItem.attachmentStream,
-                mediaGallery: mediaGallery
+                mediaGallery: mediaGallery,
+                spoilerReveal: spoilerReveal
             )
             present(pageVC, animated: true)
         }
diff --git a/Signal/src/ViewControllers/MessageDetailViewController.swift b/Signal/src/ViewControllers/MessageDetailViewController.swift
index 829e3b34ba2..0c0d58b6912 100644
--- a/Signal/src/ViewControllers/MessageDetailViewController.swift
+++ b/Signal/src/ViewControllers/MessageDetailViewController.swift
@@ -25,7 +25,7 @@ class MessageDetailViewController: OWSTableViewController2 {
     private var thread: TSThread? { renderItem?.itemModel.thread }
 
     private(set) var message: TSMessage
-    private let spoilerReveal: CVSpoilerReveal
+    private let spoilerReveal: SpoilerRevealState
     private var wasDeleted: Bool = false
     private var isIncoming: Bool { message as? TSIncomingMessage != nil }
     private var expires: Bool { message.expiresInSeconds > 0 }
@@ -117,7 +117,7 @@ class MessageDetailViewController: OWSTableViewController2 {
 
     required init(
         message: TSMessage,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         thread: TSThread
     ) {
         self.message = message
@@ -203,7 +203,7 @@ class MessageDetailViewController: OWSTableViewController2 {
 
     private func buildRenderItem(
         message interaction: TSMessage,
-        spoilerReveal: CVSpoilerReveal,
+        spoilerReveal: SpoilerRevealState,
         transaction: SDSAnyReadTransaction
     ) -> CVRenderItem? {
         guard let thread = TSThread.anyFetch(
@@ -1013,6 +1013,7 @@ extension MessageDetailViewController: CVComponentDelegate {
         let mediaPageVC = MediaPageViewController(
             initialMediaAttachment: attachmentStream,
             thread: thread,
+            spoilerReveal: self.spoilerReveal,
             showingSingleMessage: true
         )
         mediaPageVC.mediaGallery.addDelegate(self)
diff --git a/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift b/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift
index 993ef90b754..eb3cbbb3ca8 100644
--- a/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift
+++ b/Signal/src/ViewControllers/ThreadSettings/ConversationSettingsViewController.swift
@@ -40,6 +40,7 @@ class ConversationSettingsViewController: OWSTableViewController2, BadgeCollecti
     public weak var conversationSettingsViewDelegate: ConversationSettingsViewDelegate?
 
     private(set) var threadViewModel: ThreadViewModel
+    private let spoilerReveal: SpoilerRevealState
 
     var thread: TSThread {
         threadViewModel.threadRecord
@@ -68,8 +69,12 @@ class ConversationSettingsViewController: OWSTableViewController2, BadgeCollecti
     var shouldRefreshAttachmentsOnReappear = false
 
     @objc
-    public required init(threadViewModel: ThreadViewModel) {
+    public required init(
+        threadViewModel: ThreadViewModel,
+        spoilerReveal: SpoilerRevealState
+    ) {
         self.threadViewModel = threadViewModel
+        self.spoilerReveal = spoilerReveal
         groupViewHelper = GroupViewHelper(threadViewModel: threadViewModel)
 
         disappearingMessagesConfiguration = Self.databaseStorage.read { transaction in
@@ -852,12 +857,20 @@ class ConversationSettingsViewController: OWSTableViewController2, BadgeCollecti
     func showMediaGallery() {
         Logger.debug("")
 
-        let tileVC = AllMediaViewController(thread: thread, name: threadViewModel.name)
+        let tileVC = AllMediaViewController(
+            thread: thread,
+            spoilerReveal: spoilerReveal,
+            name: threadViewModel.name
+        )
         navigationController?.pushViewController(tileVC, animated: true)
     }
 
     func showMediaPageView(for attachmentStream: TSAttachmentStream) {
-        let vc = MediaPageViewController(initialMediaAttachment: attachmentStream, thread: thread)
+        let vc = MediaPageViewController(
+            initialMediaAttachment: attachmentStream,
+            thread: thread,
+            spoilerReveal: spoilerReveal
+        )
         if vc.viewControllers?.isEmpty ?? true {
             // Failed to load the item. Could be because it was deleted just as we tried to show it.
             return
diff --git a/Signal/src/views/MockConversationView.swift b/Signal/src/views/MockConversationView.swift
index ba171a64ca8..733cf2eab32 100644
--- a/Signal/src/views/MockConversationView.swift
+++ b/Signal/src/views/MockConversationView.swift
@@ -146,7 +146,7 @@ class MockConversationView: UIView {
                     thread: self.thread,
                     threadAssociatedData: threadAssociatedData,
                     conversationStyle: conversationStyle,
-                    spoilerReveal: CVSpoilerReveal(),
+                    spoilerReveal: SpoilerRevealState(),
                     transaction: transaction
                 ) else {
                     owsFailDebug("Could not build renderItem.")
diff --git a/Signal/src/views/QuotedReplyPreview.swift b/Signal/src/views/QuotedReplyPreview.swift
index fd3fab97380..2517fca4596 100644
--- a/Signal/src/views/QuotedReplyPreview.swift
+++ b/Signal/src/views/QuotedReplyPreview.swift
@@ -9,13 +9,13 @@ protocol QuotedReplyPreviewDelegate: AnyObject {
     func quotedReplyPreviewDidPressCancel(_ preview: QuotedReplyPreview)
 }
 
-class QuotedReplyPreview: UIView, OWSQuotedMessageViewDelegate, CVSpoilerObserver {
+class QuotedReplyPreview: UIView, OWSQuotedMessageViewDelegate, SpoilerRevealStateObserver {
 
     public weak var delegate: QuotedReplyPreviewDelegate?
 
     private let quotedReply: OWSQuotedReplyModel
     private let conversationStyle: ConversationStyle
-    private let spoilerReveal: CVSpoilerReveal
+    private let spoilerReveal: SpoilerRevealState
     private var quotedMessageView: OWSQuotedMessageView?
     private var heightConstraint: NSLayoutConstraint!
 
@@ -32,7 +32,7 @@ class QuotedReplyPreview: UIView, OWSQuotedMessageViewDelegate, CVSpoilerObserve
     init(
         quotedReply: OWSQuotedReplyModel,
         conversationStyle: ConversationStyle,
-        spoilerReveal: CVSpoilerReveal
+        spoilerReveal: SpoilerRevealState
     ) {
         self.quotedReply = quotedReply
         self.conversationStyle = conversationStyle
@@ -45,7 +45,7 @@ class QuotedReplyPreview: UIView, OWSQuotedMessageViewDelegate, CVSpoilerObserve
         updateContents()
 
         spoilerReveal.observeChanges(
-            for: CVInteractionIdentifier(
+            for: InteractionSnapshotIdentifier(
                 timestamp: quotedReply.timestamp,
                 authorUuid: quotedReply.authorAddress.uuidString
             ),
diff --git a/Signal/test/ViewControllers/CVTextTest.swift b/Signal/test/ViewControllers/CVTextTest.swift
index 8544c0b0b29..9e5f2a6fedf 100644
--- a/Signal/test/ViewControllers/CVTextTest.swift
+++ b/Signal/test/ViewControllers/CVTextTest.swift
@@ -291,7 +291,7 @@ class CVTextTest: XCTestCase {
             textWasTruncated: true,
             revealedSpoilerIds: Set(),
             interactionUniqueId: UUID().uuidString,
-            interactionIdentifier: CVInteractionIdentifier(timestamp: 0, authorUuid: nil)
+            interactionIdentifier: InteractionSnapshotIdentifier(timestamp: 0, authorUuid: nil)
         )
         var values: [String] = []
         var ranges: [NSRange] = []
@@ -313,7 +313,7 @@ class CVTextTest: XCTestCase {
             textWasTruncated: false,
             revealedSpoilerIds: Set(),
             interactionUniqueId: UUID().uuidString,
-            interactionIdentifier: CVInteractionIdentifier(timestamp: 0, authorUuid: nil)
+            interactionIdentifier: InteractionSnapshotIdentifier(timestamp: 0, authorUuid: nil)
         )
         values.removeAll()
         ranges.removeAll()
@@ -336,7 +336,7 @@ class CVTextTest: XCTestCase {
             textWasTruncated: true,
             revealedSpoilerIds: Set(),
             interactionUniqueId: UUID().uuidString,
-            interactionIdentifier: CVInteractionIdentifier(timestamp: 0, authorUuid: nil)
+            interactionIdentifier: InteractionSnapshotIdentifier(timestamp: 0, authorUuid: nil)
         )
         values.removeAll()
         truncatedEmail.enumerateAttribute(.link, in: truncatedEmail.entireRange, options: []) { value, _, _ in
@@ -355,7 +355,7 @@ class CVTextTest: XCTestCase {
             textWasTruncated: true,
             revealedSpoilerIds: Set(),
             interactionUniqueId: UUID().uuidString,
-            interactionIdentifier: CVInteractionIdentifier(timestamp: 0, authorUuid: nil)
+            interactionIdentifier: InteractionSnapshotIdentifier(timestamp: 0, authorUuid: nil)
         )
         values.removeAll()
         truncatedPhone.enumerateAttribute(.link, in: truncatedPhone.entireRange, options: []) { value, _, _ in
diff --git a/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift b/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift
index 0a84bb95e17..e48dfe3bd8c 100644
--- a/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift
+++ b/SignalServiceKit/src/Messages/BodyRanges/HydratedMessageBody.swift
@@ -427,6 +427,114 @@ public class HydratedMessageBody: Equatable, Hashable {
         }
         return self
     }
+
+    // MARK: - Tappable items
+
+    public enum TappableItem {
+        public struct Mention {
+            public let range: NSRange
+            public let mentionUuid: UUID
+        }
+
+        public struct UnrevealedSpoiler {
+            public let range: NSRange
+            public let id: StyleIdType
+        }
+
+        case mention(Mention)
+        case unrevealedSpoiler(UnrevealedSpoiler)
+        case data(TextCheckingDataItem)
+    }
+
+    public func tappableItems(
+        revealedSpoilerIds: Set<Int>,
+        dataDetector: NSDataDetector?
+    ) -> [TappableItem] {
+        return Self.tappableItems(
+            text: hydratedText,
+            mentionAttributes: mentionAttributes,
+            styleAttributes: styleAttributes,
+            revealedSpoilerIds: revealedSpoilerIds,
+            dataDetector: dataDetector
+        )
+    }
+
+    internal static func tappableItems(
+        text: String,
+        mentionAttributes: [NSRangedValue<MentionAttribute>],
+        styleAttributes: [NSRangedValue<StyleAttribute>],
+        revealedSpoilerIds: Set<Int>,
+        dataDetector: NSDataDetector?
+    ) -> [TappableItem] {
+        // We "cheat" by using NSAttributedString to deal with overlapping
+        // ranges for us. We add our items and their ranges as attributes,
+        // then enumerate attributes to deal with overlaps.
+        let attrString = NSMutableAttributedString(string: "")
+
+        func setRange(
+            value: Any,
+            key: NSAttributedString.Key,
+            range: NSRange
+        ) {
+            if range.upperBound > attrString.length {
+                attrString.append(String(repeating: " ", count: range.upperBound - attrString.length))
+            }
+            attrString.addAttribute(key, value: value, range: range)
+        }
+
+        // These are used in a string tied to the scope of this
+        // function; no need to be too careful about them.
+        let unrevealedSpoilerKey = NSAttributedString.Key("ows.spoiler")
+        let mentionKey = NSAttributedString.Key("ows.mention")
+        let dataKey = NSAttributedString.Key("ows.data")
+
+        if FeatureFlags.textFormattingReceiveSupport {
+            styleAttributes.forEach {
+                if
+                    $0.value.style.contains(.spoiler),
+                    revealedSpoilerIds.contains($0.value.id).negated
+                {
+                    setRange(
+                        value: TappableItem.UnrevealedSpoiler(range: $0.range, id: $0.value.id),
+                        key: unrevealedSpoilerKey,
+                        range: $0.range
+                    )
+                }
+            }
+        }
+        mentionAttributes.forEach {
+            setRange(
+                value: TappableItem.Mention(range: $0.range, mentionUuid: $0.value.mentionUuid),
+                key: mentionKey,
+                range: $0.range
+            )
+        }
+
+        let dataItems = TextCheckingDataItem.detectedItems(in: text, using: dataDetector)
+        dataItems.forEach {
+            setRange(
+                value: $0,
+                key: dataKey,
+                range: $0.range
+            )
+        }
+
+        var items = [TappableItem]()
+        attrString.enumerateAttributes(in: attrString.entireRange) { attrs, range, _ in
+            // Spoilers are highest priority; if we have those, stick with them.
+            // Then comes mentions and last data items.
+            // The attributed string will have split out overlapping subranges for us.
+            if let unrevealedSpoiler = attrs[unrevealedSpoilerKey] as? TappableItem.UnrevealedSpoiler {
+                items.append(.unrevealedSpoiler(.init(range: range, id: unrevealedSpoiler.id)))
+            } else if let mention = attrs[mentionKey] as? TappableItem.Mention {
+                items.append(.mention(.init(range: range, mentionUuid: mention.mentionUuid)))
+            } else if let dataItem = attrs[dataKey] as? TextCheckingDataItem {
+                items.append(.data(dataItem.copyInNewRange(range)))
+            }
+        }
+
+        return items
+    }
 }
 
 fileprivate extension NSRangedValue {
diff --git a/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift b/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift
index b5336fab0cd..020adefbe6e 100644
--- a/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift
+++ b/SignalServiceKit/src/Messages/BodyRanges/RecoveredHydratedMessageBody.swift
@@ -157,95 +157,17 @@ public class RecoveredHydratedMessageBody {
         )
     }
 
-    public enum TappableItem {
-        public struct Mention {
-            public let range: NSRange
-            public let mentionUuid: UUID
-        }
-
-        public struct UnrevealedSpoiler {
-            public let range: NSRange
-            public let id: StyleIdType
-        }
-
-        case mention(Mention)
-        case unrevealedSpoiler(UnrevealedSpoiler)
-        case data(TextCheckingDataItem)
-    }
-
     public func tappableItems(
         revealedSpoilerIds: Set<Int>,
         dataDetector: NSDataDetector?
-    ) -> [TappableItem] {
-
-        // We "cheat" by using NSAttributedString to deal with overlapping
-        // ranges for us. We add our items and their ranges as attributes,
-        // then enumerate attributes to deal with overlaps.
-        let attrString = NSMutableAttributedString(string: "")
-
-        func setRange(
-            value: Any,
-            key: NSAttributedString.Key,
-            range: NSRange
-        ) {
-            if range.upperBound > attrString.length {
-                attrString.append(String(repeating: " ", count: range.upperBound - attrString.length))
-            }
-            attrString.addAttribute(key, value: value, range: range)
-        }
-
-        // These are used in a string tied to the scope of this
-        // function; no need to be too careful about them.
-        let unrevealedSpoilerKey = NSAttributedString.Key("ows.spoiler")
-        let mentionKey = NSAttributedString.Key("ows.mention")
-        let dataKey = NSAttributedString.Key("ows.data")
-
-        if FeatureFlags.textFormattingReceiveSupport {
-            styleAttributes.forEach {
-                if
-                    $0.value.style.contains(.spoiler),
-                    revealedSpoilerIds.contains($0.value.id).negated
-                {
-                    setRange(
-                        value: TappableItem.UnrevealedSpoiler(range: $0.range, id: $0.value.id),
-                        key: unrevealedSpoilerKey,
-                        range: $0.range
-                    )
-                }
-            }
-        }
-        mentionAttributes.forEach {
-            setRange(
-                value: TappableItem.Mention(range: $0.range, mentionUuid: $0.value.mentionUuid),
-                key: mentionKey,
-                range: $0.range
-            )
-        }
-
-        let dataItems = TextCheckingDataItem.detectedItems(in: string.string, using: dataDetector)
-        dataItems.forEach {
-            setRange(
-                value: $0,
-                key: dataKey,
-                range: $0.range
-            )
-        }
-
-        var items = [TappableItem]()
-        attrString.enumerateAttributes(in: attrString.entireRange) { attrs, range, _ in
-            // Spoilers are highest priority; if we have those, stick with them.
-            // Then comes mentions and last data items.
-            // The attributed string will have split out overlapping subranges for us.
-            if let unrevealedSpoiler = attrs[unrevealedSpoilerKey] as? TappableItem.UnrevealedSpoiler {
-                items.append(.unrevealedSpoiler(.init(range: range, id: unrevealedSpoiler.id)))
-            } else if let mention = attrs[mentionKey] as? TappableItem.Mention {
-                items.append(.mention(.init(range: range, mentionUuid: mention.mentionUuid)))
-            } else if let dataItem = attrs[dataKey] as? TextCheckingDataItem {
-                items.append(.data(dataItem.copyInNewRange(range)))
-            }
-        }
-
-        return items
+    ) -> [HydratedMessageBody.TappableItem] {
+        return HydratedMessageBody.tappableItems(
+            text: string.string,
+            mentionAttributes: mentionAttributes,
+            styleAttributes: styleAttributes,
+            revealedSpoilerIds: revealedSpoilerIds,
+            dataDetector: dataDetector
+        )
     }
 
     /// Ordered by location from start of the string, non overlapping.
diff --git a/SignalServiceKit/src/Messages/BodyRanges/SpoilerRevealState.swift b/SignalServiceKit/src/Messages/BodyRanges/SpoilerRevealState.swift
new file mode 100644
index 00000000000..431671ab3a7
--- /dev/null
+++ b/SignalServiceKit/src/Messages/BodyRanges/SpoilerRevealState.swift
@@ -0,0 +1,123 @@
+//
+// Copyright 2023 Signal Messenger, LLC
+// SPDX-License-Identifier: AGPL-3.0-only
+//
+
+import Foundation
+
+/// Used to uniquely identify one iteration of an interaction even if edits are applied.
+/// Note that the interaction's uniqueId, rowId, and sortId always point to the latest edit,
+/// so when an edit is applied they point to the new version not the old version.
+/// This is used instead to continue to point to the old version.
+///
+/// authorUuid is allowed to be null for outgoing or system messages because timestamp can
+/// be considered unique on its own for messages generated by oneself.
+/// Incoming messages should always have non-null authorUuid.
+/// NOTE: be careful using this for messages from before the introduction of uuids.
+/// Currently used for text formatting spoilers which were introduced after uuids.
+public struct InteractionSnapshotIdentifier: Equatable, Hashable {
+    let timestamp: UInt64
+    // Note: this will always be the aci for incoming messages
+    // and nil for local/outgoing messages.
+    let authorUuid: String?
+
+    public init(timestamp: UInt64, authorUuid: String?) {
+        self.timestamp = timestamp
+        self.authorUuid = authorUuid
+    }
+
+    public static func fromInteraction(_ interaction: TSInteraction) -> Self {
+        return .init(timestamp: interaction.timestamp, authorUuid: (interaction as? TSIncomingMessage)?.authorUUID)
+    }
+}
+
+// MARK: -
+
+public protocol SpoilerRevealStateObserver: NSObjectProtocol {
+    func didUpdateRevealedSpoilers()
+}
+
+@objc
+public class SpoilerRevealState: NSObject {
+    private var revealedSpoilerIdsByMessage = [InteractionSnapshotIdentifier: Set<StyleIdType>]()
+
+    /// Returns the set of IDs in the ordered list of spoiler ranges for a given message that
+    /// should be revealed.
+    public func revealedSpoilerIds(
+        interactionIdentifier: InteractionSnapshotIdentifier
+    ) -> Set<StyleIdType> {
+        return revealedSpoilerIdsByMessage[interactionIdentifier] ?? []
+    }
+
+    public func setSpoilerRevealed(
+        withID id: StyleIdType,
+        interactionIdentifier: InteractionSnapshotIdentifier
+    ) {
+        var revealedIds = revealedSpoilerIdsByMessage[interactionIdentifier] ?? Set()
+        revealedIds.insert(id)
+        revealedSpoilerIdsByMessage[interactionIdentifier] = revealedIds
+        observers[interactionIdentifier]?.forEach {
+            $0.value?.didUpdateRevealedSpoilers()
+        }
+    }
+
+    private var observers = [InteractionSnapshotIdentifier: [Weak<SpoilerRevealStateObserver>]]()
+
+    public func observeChanges(
+        for interactionIdentifier: InteractionSnapshotIdentifier,
+        observer: SpoilerRevealStateObserver
+    ) {
+        var observers = observers[interactionIdentifier] ?? []
+        guard !observers.contains(where: {
+            $0.value === observer
+        }) else {
+            return
+        }
+        observers.append(Weak(value: observer))
+        self.observers[interactionIdentifier] = observers
+    }
+
+    public func removeObserver(
+        for interactionIdentifier: InteractionSnapshotIdentifier,
+        observer: SpoilerRevealStateObserver
+    ) {
+        var observers = observers[interactionIdentifier] ?? []
+        observers.removeAll(where: {
+            $0.value === observer
+        })
+        self.observers[interactionIdentifier] = observers
+    }
+
+    public func copy() -> SpoilerRevealState {
+        let returnValue = SpoilerRevealState()
+        returnValue.revealedSpoilerIdsByMessage = revealedSpoilerIdsByMessage
+        return returnValue
+    }
+
+    public override func isEqual(_ object: Any?) -> Bool {
+        let lhs = self
+        guard let rhs = object as? SpoilerRevealState else {
+            return false
+        }
+        guard lhs.revealedSpoilerIdsByMessage == rhs.revealedSpoilerIdsByMessage else {
+            return false
+        }
+        guard lhs.observers.count == rhs.observers.count else {
+            return false
+        }
+        for key in lhs.observers.keys {
+            guard let lhsObs = lhs.observers[key], let rhsObs = rhs.observers[key] else {
+                return false
+            }
+            guard lhsObs.count == rhsObs.count else {
+                return false
+            }
+            for i in 0..<lhsObs.count {
+                guard lhsObs[i].value === rhsObs[i].value else {
+                    return false
+                }
+            }
+        }
+        return true
+    }
+}
diff --git a/SignalUI/Categories/UIView+SignalUI.swift b/SignalUI/Categories/UIView+SignalUI.swift
index 50d1ced03c4..fe5d243db0c 100644
--- a/SignalUI/Categories/UIView+SignalUI.swift
+++ b/SignalUI/Categories/UIView+SignalUI.swift
@@ -648,6 +648,48 @@ public extension UITextView {
     }
 }
 
+extension UITextView {
+    public func characterIndex(of location: CGPoint) -> Int? {
+        return textContainer.characterIndex(of: location, textStorage: textStorage, layoutManager: layoutManager)
+    }
+}
+
+extension NSTextContainer {
+    public func characterIndex(
+        of location: CGPoint,
+        textStorage: NSTextStorage,
+        layoutManager: NSLayoutManager
+    ) -> Int? {
+        guard textStorage.length > 0 else {
+            return nil
+        }
+
+        let glyphRange = layoutManager.glyphRange(for: self)
+        let boundingRect = layoutManager.boundingRect(forGlyphRange: glyphRange, in: self)
+        guard boundingRect.contains(location) else {
+            return nil
+        }
+
+        let glyphIndex = layoutManager.glyphIndex(for: location, in: self)
+
+        // We have the _closest_ index, but that doesn't mean we tapped in a glyph.
+        // Check that directly.
+        // This will catch the below case, where "*" is the tap location:
+        //
+        // This is the first line that is long.
+        // Tap on the second line.    *
+        //
+        // The bounding rect includes the empty space below the first line,
+        // but the tap doesn't actually lie on any glyph.
+        let glyphRect = layoutManager.boundingRect(forGlyphRange: NSRange(location: glyphIndex, length: 1), in: self)
+        guard glyphRect.contains(location) else {
+            return nil
+        }
+        let characterIndex = layoutManager.characterIndexForGlyph(at: glyphIndex)
+        return characterIndex
+    }
+}
+
 // MARK: -
 
 @objc
diff --git a/SignalUI/Views/ConversationView/CVInteractionIdentifier.swift b/SignalUI/Views/ConversationView/CVInteractionIdentifier.swift
deleted file mode 100644
index 01a0cecfce5..00000000000
--- a/SignalUI/Views/ConversationView/CVInteractionIdentifier.swift
+++ /dev/null
@@ -1,32 +0,0 @@
-//
-// Copyright 2023 Signal Messenger, LLC
-// SPDX-License-Identifier: AGPL-3.0-only
-//
-
-import Foundation
-
-/// Used to uniquely identify one iteration of an interaction even if edits are applied.
-/// Note that the interaction's uniqueId, rowId, and sortId always point to the latest edit,
-/// so when an edit is applied they point to the new version not the old version.
-/// This is used instead to continue to point to the old version.
-///
-/// authorUuid is allowed to be null for outgoing or system messages because timestamp can
-/// be considered unique on its own for messages generated by oneself.
-/// Incoming messages should always have non-null authorUuid.
-/// NOTE: be careful using this for messages from before the introduction of uuids.
-/// Currently used for text formatting spoilers which were introduced after uuids.
-public struct CVInteractionIdentifier: Equatable, Hashable {
-    let timestamp: UInt64
-    // Note: this will always be the aci for incoming messages
-    // and nil for local/outgoing messages.
-    let authorUuid: String?
-
-    public init(timestamp: UInt64, authorUuid: String?) {
-        self.timestamp = timestamp
-        self.authorUuid = authorUuid
-    }
-
-    public static func fromInteraction(_ interaction: TSInteraction) -> Self {
-        return .init(timestamp: interaction.timestamp, authorUuid: (interaction as? TSIncomingMessage)?.authorUUID)
-    }
-}
diff --git a/SignalUI/Views/ConversationView/CVTextLabel.swift b/SignalUI/Views/ConversationView/CVTextLabel.swift
index c078f6c360c..01b786c7db2 100644
--- a/SignalUI/Views/ConversationView/CVTextLabel.swift
+++ b/SignalUI/Views/ConversationView/CVTextLabel.swift
@@ -38,13 +38,13 @@ public class CVTextLabel: NSObject {
     public struct UnrevealedSpoilerItem: Equatable {
         public let spoilerId: Int
         public let interactionUniqueId: String
-        public let interactionIdentifier: CVInteractionIdentifier
+        public let interactionIdentifier: InteractionSnapshotIdentifier
         public let range: NSRange
 
         public init(
             spoilerId: Int,
             interactionUniqueId: String,
-            interactionIdentifier: CVInteractionIdentifier,
+            interactionIdentifier: InteractionSnapshotIdentifier,
             range: NSRange
         ) {
             self.spoilerId = spoilerId
@@ -358,28 +358,13 @@ public class CVTextLabel: NSObject {
                 return nil
             }
 
-            let glyphRange = layoutManager.glyphRange(for: textContainer)
-            let boundingRect = layoutManager.boundingRect(forGlyphRange: glyphRange, in: textContainer)
-            guard boundingRect.contains(location) else {
-                return nil
-            }
-
-            let glyphIndex = layoutManager.glyphIndex(for: location, in: textContainer)
-
-            // We have the _closest_ index, but that doesn't mean we tapped in a glyph.
-            // Check that directly.
-            // This will catch the below case, where "*" is the tap location:
-            //
-            // This is the first line that is long.
-            // Tap on the second line.    *
-            //
-            // The bounding rect includes the empty space below the first line,
-            // but the tap doesn't actually lie on any glyph.
-            let glyphRect = layoutManager.boundingRect(forGlyphRange: NSRange(location: glyphIndex, length: 1), in: textContainer)
-            guard glyphRect.contains(location) else {
+            guard let characterIndex = textContainer.characterIndex(
+                of: location,
+                textStorage: textStorage,
+                layoutManager: layoutManager
+            ) else {
                 return nil
             }
-            let characterIndex = layoutManager.characterIndexForGlyph(at: glyphIndex)
 
             for item in config.items {
                 if item.range.contains(characterIndex) {
diff --git a/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift b/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift
index 3c88d6e5d68..e06cf6db2b5 100644
--- a/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift
+++ b/SignalUI/Views/Mentions/MentionDisplayConfigurations.swift
@@ -73,6 +73,14 @@ extension MentionDisplayConfiguration {
 
     public static var composing: Self { .incomingMessageBubble }
 
+    public static var mediaCaption: MentionDisplayConfiguration {
+        return MentionDisplayConfiguration(
+            font: .dynamicTypeBodyClamped,
+            foregroundColor: .fixed(.white),
+            backgroundColor: nil
+        )
+    }
+
     private static let primaryTextColor = ThemedColor(
         light: Theme.lightThemePrimaryColor,
         dark: Theme.darkThemePrimaryColor
diff --git a/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift b/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift
index 0e1ed92e5b5..7cc510f2b06 100644
--- a/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift
+++ b/SignalUI/Views/Mentions/SpoilerDisplayConfigurations.swift
@@ -70,6 +70,15 @@ extension StyleDisplayConfiguration {
         )
     }
 
+    public static func mediaCaption(revealedSpoilerIds: Set<StyleIdType>) -> StyleDisplayConfiguration {
+        return StyleDisplayConfiguration(
+            baseFont: .dynamicTypeBodyClamped,
+            textColor: .fixed(.white),
+            revealAllIds: false,
+            revealedIds: revealedSpoilerIds
+        )
+    }
+
     private static let primaryTextColor = ThemedColor(
         light: Theme.lightThemePrimaryColor,
         dark: Theme.darkThemePrimaryColor
